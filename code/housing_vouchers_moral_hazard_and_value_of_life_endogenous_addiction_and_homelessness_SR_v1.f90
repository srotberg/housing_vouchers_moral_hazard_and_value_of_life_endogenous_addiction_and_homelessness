    module Global_Vars

		implicit none
        
        integer, parameter :: is_counterfactual=1
        integer, parameter :: partial_equilibrium=1
        real(8), parameter :: probability_of_voucher_benchmark_used=1
        real(8), parameter :: increased_prob_of_voucher_if_homeless_and_addicted=0
        integer, parameter :: how_many_iterations_to_do_on_distribution=100
        integer, parameter :: compare_to_original_benchmark=1
        
        integer, parameter :: compute_welfare_every_loop=0
        
        integer, parameter :: fixed_labor_supply_at_benchmark=partial_equilibrium
        integer, parameter :: adjust_house_prices=1-partial_equilibrium
        integer, parameter :: adjust_rents=1-partial_equilibrium
        integer, parameter :: adjust_taxes=1-partial_equilibrium
        integer, parameter :: adjust_labor_supply=(1-fixed_labor_supply_at_benchmark)
        integer, parameter :: adjust_inheritance=1-partial_equilibrium
        integer, parameter :: use_revenues_to_increase_voucher_probability=0
        
        real(8), parameter :: increased_prob_of_voucher_if_homeless=1
        real(8), parameter :: probability_of_voucher_used_in_benchmark=0.054
        real(8), parameter :: relative_price_change=0
        integer, parameter :: raise_b=0
        integer, parameter :: change_utility_for_addicts=1
        real(8), parameter :: size_of_penalty=0
        integer, parameter :: use_income_or_income_plus_assets=4
        integer, parameter :: have_increased_death_from_addiction=1
        integer, parameter :: have_increased_unemployment_from_addiction=1
        
        integer, parameter :: inheritance_function_of_productivity=1
        
        integer, parameter :: remove_increased_death=0
        integer, parameter :: reduce_ss_by_half=0
        
        integer, parameter :: start_assets_of_newborns_at_zero=0
        real(8), parameter :: increase_in_newborns_bequests=0
        integer, parameter :: increase_vouchers_for_homeless_only=0
        
        real(8) :: probability_of_voucher_benchmark_used_1=probability_of_voucher_benchmark_used
        real(8) :: increased_prob_of_voucher_if_homeless_1=increased_prob_of_voucher_if_homeless    
        integer, parameter :: double_voucher_program=0
        real(8), parameter :: cost_of_addict_scaling=1    
        integer, parameter :: voucher_conditional_on_clean_just_addicts=0
        integer, parameter :: clear_only_vouchers_govt_budget=0
                
        integer :: tax_system_type=1
        integer, parameter :: perceived_probability_lower=0
        real(8), parameter :: difference_in_perceived_of_becoming_addicted_if_experiment=&
            (1-perceived_probability_lower)*1+perceived_probability_lower*0.5
        integer, parameter :: voucher_conditional_on_clean=0
            
        integer, parameter :: life_span=60
        integer, parameter :: retirement_span=20
        integer, parameter :: include_addiction=1                           
        integer, parameter :: include_vouchers=1
        integer, parameter :: use_cobb_douglas=0
        integer, parameter :: use_cobb_douglas_2=0
        integer, parameter :: include_probability_of_becoming_addicted=1
        integer, parameter :: max_age_to_choose_addiction=55
        integer, parameter :: max_age_to_choose_homelessness=59
        
        integer, parameter :: include_varying_household_size=0
        integer, parameter :: only_LTV=1
        integer, parameter :: newborns_inherit_addiction=0                    
        integer, parameter :: ss_decrease_for_retired_addicted=0
        integer, parameter :: threshold_addiction_index=3
        integer, parameter :: have_two_rental_markets=0
        integer, parameter :: include_bequest_motive=0
        integer, parameter :: include_bequests=1
        
        integer, parameter :: infinite_elasticity_of_rental_supply=0
        integer, parameter :: other_rental_supply_elasticity=1
        integer, parameter :: zero_elasticity=0       
        real(8), parameter :: mortgage_deductibility=0
        integer, parameter :: track_renters_housing=0
        integer, parameter :: compute_income_cdf=0
        integer, parameter :: include_retirees_in_income_cdf=1
        integer, parameter :: include_rental_income=1
        integer, parameter :: allow_retirees_borrow=only_LTV*0+(1-only_LTV)*1
        integer, parameter :: increase_homeless_size=0
        integer, parameter :: coarse_grid=0
        
        integer, parameter :: provide_vouchers=is_counterfactual*0+(1-is_counterfactual)*0
        real(8), parameter :: max_fraction_of_income_spent_on_housing=include_addiction*0.44+(1-include_addiction)*0.8
        real(8), parameter :: max_rent_relative_to_ave=include_addiction*1.56+(1-include_addiction)*1.4
        
        character*400 :: file_number
        character*400 :: old_results
        character*400 :: benchmark_simulation
        character*400 :: vf_simulation
        character*400 :: long_run_simulation
        character*400 :: old_transition_resuls
        
        integer, parameter :: load_test_distribution=0
        
        integer, parameter :: use_GKKOC_deterministic_process=1
        
        integer, parameter :: include_exogenous_endowment=1
        
        integer, parameter :: lowest_housing_grid_point=-1
        integer, parameter :: second_lowest_housing_grid_point=0
                
        integer, parameter :: include_property_taxes_in_govt_constraint=1
        integer, parameter :: include_bequests_in_govt_constraint=0
                
        integer, parameter :: num_percentiles=1
    
        integer, parameter :: re_calibrate_management_costs=1
        integer, parameter :: use_old_results=(is_counterfactual*1+(1-is_counterfactual)*0)
        integer, parameter :: use_old_distribution=0
        integer, parameter :: hold_distribution_fixed=0
                
        integer, parameter :: raise_min_down=0
        integer, parameter :: check_tax_incidence=0
        integer, parameter :: fixed_to_benchmark_dis=0
        integer, parameter :: check_elascitity=0
            
        real(8), parameter :: max_labor_supply=1.d0
                        
        integer, parameter :: have_probablistic_death=1
                    
        real(8) :: average_owner_occupied_house_size_calibrated=0.27287156849028160
                    
        integer, parameter :: target_30_perc=0
        integer, parameter :: remove_tax_and_depreciation=1
                                                        
        integer, parameter :: do_internal_computations=1
        integer :: fin_num_of_internal=50
        integer, parameter :: re_do_simulation_with_fixed_parameters=1                                                               
        integer, parameter :: calibrate_only_rental_management_costs=1
                                                                                                                                                                                                                                                                                                                                    
        real(8), parameter :: property_tax_deductibility=0
        
        integer, parameter :: solve_transition_dynamics=is_counterfactual*0+(1-is_counterfactual)*0                                                                                                             
        integer, parameter :: use_old_transition_results=0
        integer, parameter :: transition_length=(1-solve_transition_dynamics)*1+solve_transition_dynamics*75
                                                                                                                                                    
        integer :: negative_consumption
        
        real(8), parameter :: minimum_downpayment=0.2
        real(8), parameter :: minimum_downpayment_calibrated=0.2
        real(8), parameter :: min_down_of_smallest=(1-raise_min_down)*0
        real(8), parameter :: min_down_of_second_smallest=(1-raise_min_down)*0
                                                  
        real(8), parameter :: average_labor_income_tax_data=0.224
        real(8) :: standard_deduction
        real(8) :: personal_exemption
        real(8), parameter :: standard_deduction_data=0 !9350
        real(8), parameter :: personal_exemption_data=0 !4050
        
        integer, parameter :: include_housing_depreciation_in_housing_costs=0 
        real(8), parameter :: fraction_of_property_taxes_in_GDS=1        
        real(8), parameter :: fraction_of_average_house_price_data=100000 ! real(500000)/real(767336) 
        real(8), parameter :: FRED_housing_services_to_GDP=0.312
        real(8), parameter :: target_renters_rent_to_income=0
        real(8), parameter :: avg_labor_supply_data=0.4
        real(8), parameter :: perc_higher_rent_in_free_market=0.137
        real(8), parameter :: himmelberg_etal_rent_to_price=0.083
        real(8), parameter :: free_market_rent_to_house_price=0.083
        integer, parameter :: calibrate_size_of_smallest_house_hhld_can_buy=1
        integer, parameter :: calibrate_smallest_house_size=1
        real(8), parameter :: SCF_homeownership_rate=0.659  
        real(8), parameter :: SW_renters_spend_over_X_on_hous=target_30_perc*0.45+(1-target_30_perc)*0.151    
        real(8), parameter :: SW_renters_spend_over_X_on_hous_2=0.416
        real(8), parameter :: SCF_mortgage_to_gross_housing_wealth=0.345
        real(8), parameter :: fraction_itemizing_MIDs_data=0.07467241172     
        real(8), parameter :: MID_to_GDP_data=0.41
        real(8), parameter :: bequests_to_net_wealth_data=0.012
        real(8), parameter :: fraction_homeless_data=0.0045
        
        integer, parameter :: target_HO_of_old=1
        real(8), parameter :: homeownership_rate_of_old_data=0.804
        real(8), parameter :: median_nw_to_income_old_to_mid_age_data=2.3
        real(8), parameter :: fraction_leaving_bequests_data=0.57
        real(8), parameter :: free_market_unit_to_controlled_market_unit=0.24
        integer, parameter :: aftr_how_mny_lps_start_update=partial_equilibrium*0+(1-partial_equilibrium)*0
       
        real(8) :: stopping_rule_housing_market=2*10.d0**(-2)                                                           
        real(8) :: stopping_rule_rental_market=is_counterfactual*(1*10.d0**(-2))+(1-is_counterfactual)*2*10.d0**(-2)
        real(8) :: stopping_rule_govt_budget=1*10.d0**(-2)        
        real(8) :: stopping_rule_inheritance_amount=(1-is_counterfactual)*2*10.d0**(-4)+is_counterfactual*2*10.d0**(-3)
                                                           
        real(8), parameter :: stopping_rule_value_function=5*10.d0**(-8)
        real(8) :: stopping_rule_stationary_distribution=10.d0**(-8)
                                                                  
        real(8) :: weight_on_housing_price=0.5
                                        
        real(8), parameter :: risk_aversion_consumption=2
        real(8), parameter :: rho_1=real(1.25)
        real(8), parameter :: eta_1=1.07
        real(8), parameter :: relative_share_of_addiction_1=(1-perceived_probability_lower)*0.08+perceived_probability_lower*0.16
        real(8), parameter :: relative_share_of_addiction_2=&
            change_utility_for_addicts*((1-perceived_probability_lower)*0.45+perceived_probability_lower*0.44)+&
            (1-change_utility_for_addicts)*(size_of_penalty*((0.39-relative_share_of_addiction_1))+relative_share_of_addiction_1)
        real(8), parameter :: power_1=1-(1/rho_1)
        real(8), parameter :: power_2=(1-risk_aversion_consumption)/power_1
        real(8), parameter :: power_3=1-(eta_1/rho_1)
        real(8), parameter :: proportion_addicted=0.3634
        
        integer, parameter :: number_of_inheritance_ages=life_span
        integer, parameter :: number_of_inheritance_groups=life_span
        real(8), parameter :: amount_youngest=&
            (1-inheritance_function_of_productivity)*0.0142+inheritance_function_of_productivity*0.01522 !1.2253772467557614E-002
        real(8), parameter :: amount_middle_age=&
            (1-inheritance_function_of_productivity)*0.0142+inheritance_function_of_productivity*0.01522 !1.2253772467557614E-002
        real(8), parameter :: inhertiance_proportion_for_group_1=(real(1)/real(life_span))
        real(8), dimension(number_of_inheritance_groups) :: &
            proportion_of_inheritance_per_group=inhertiance_proportion_for_group_1
        integer, dimension(number_of_inheritance_ages), parameter :: inheritance_age_grid=&
            (/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,&
            31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60/)
        real(8), dimension(number_of_inheritance_ages) :: inheritance_amount=include_bequests*amount_youngest
        real(8) :: inheritance_amount_adjuster=include_bequests*0.01
        real(8) :: inheritance_amount_weight=is_counterfactual*0.5+(1-is_counterfactual)*0.5
        real(8) :: distance_inheritance_amount
        real(8), dimension(number_of_inheritance_ages) :: previous_inheritance_amount
        integer, parameter :: youngest_ages_for_wealth_computation=9
        
        real(8), parameter :: Frisch_elasticity=3
        real(8), parameter :: risk_aversion_housing=2
        real(8), parameter :: relative_share_of_housing_0=&
            (1-perceived_probability_lower)*0.293+perceived_probability_lower*0.31
        real(8) :: relative_share_of_housing=0.16
        real(8) :: distance_relative_share_of_housing
        real(8) :: relative_share_of_housing_adjuster=5*10.d0**(-2)
        real(8) :: stopping_rule_relative_share_of_housing=10.d0**(-3)
        
        real(8) :: sd_fixed_employment_newborn=0.309 !0.309
        real(8) :: persistence_employment_surviving=0.9
        real(8) :: sd_employment_surviving=0.2
            
        real(8) :: relative_share_of_leisure=(1-perceived_probability_lower)*3.25+perceived_probability_lower*3.1
        
        real(8) :: distance_relative_share_of_leisure
        real(8) :: relative_share_of_leisure_adjuster=5*10.d0**(-1)
        real(8) :: stopping_rule_relative_share_of_leisure=10.d0**(-3)
        
        real(8) :: relative_share_of_addiction=relative_share_of_addiction_1
        real(8) :: distance_relative_share_of_addiction
        real(8) :: relative_share_of_addiction_adjuster=5*10.d0**(-1)
        real(8) :: stopping_rule_relative_share_of_addiction=10.d0**(-3)
        
        real(8) :: probability_of_becoming_addicted_if_experiment=&
            (1-perceived_probability_lower)*0.05+perceived_probability_lower*0.062
        
        real(8), parameter :: price_of_addictive_good_benchmark=1
        
        real(8) :: price_of_addictive_good=include_addiction*&
            (partial_equilibrium*price_of_addictive_good_benchmark*(1+relative_price_change)+&
            (1-partial_equilibrium)*(is_counterfactual*price_of_addictive_good_benchmark*(1+relative_price_change)+&
            (1-is_counterfactual)*price_of_addictive_good_benchmark))
            
        real(8), parameter :: addiction_scalar_1=&
            raise_b*0.01+(1-raise_b)*&
            ((1-perceived_probability_lower)*1.9*10.d0**(-6)+perceived_probability_lower*2.2*10.d0**(-3))
            
        real(8), parameter :: addiction_scalar_2=addiction_scalar_1
        
        real(8) :: relative_share_of_housing_1=relative_share_of_housing_0*(1-relative_share_of_addiction_1)
        real(8) :: relative_share_of_housing_2=relative_share_of_housing_0*(1-relative_share_of_addiction_2)
    
        real(8) :: relative_share_of_consumption_1=(1-relative_share_of_housing_0)*(1-relative_share_of_addiction_1)
        real(8) :: relative_share_of_consumption_2=(1-relative_share_of_housing_0)*(1-relative_share_of_addiction_2)
                
        real(8) :: advantage_to_owning=0
        real(8) :: advantage_to_owning_adjuster=(1-calibrate_size_of_smallest_house_hhld_can_buy)*1*10.d0**(-1)
        real(8) :: distance_advantage_to_owning
        real(8) :: stopping_rule_advantage_to_owning=10.d0**(-3)
               
        real(8) :: discount_factor=(1-perceived_probability_lower)*0.939+perceived_probability_lower*0.951
        real(8) :: discount_factor_adjuster=5*10.d0**(-3)
        real(8) :: distance_discount_factor
        real(8) :: stopping_rule_discount_factor=10.d0**(-4)
        
        real(8) :: standard_deduction_as_percent_of_average_labor_income=0 !&
            !(1-perceived_probability_lower)*0.117+perceived_probability_lower*0.11
            
        real(8) :: standard_deduction_adjuster=0 !10.d0**(-2)
        real(8) :: distance_standard_deduction
        real(8) :: stopping_rule_standard_deduction=10.d0**(-3)
        real(8) :: max_MID_debt=real(1000000)/real(71764)
        
        real(8) :: discount_factor_on_child=(1-perceived_probability_lower)*700+perceived_probability_lower*700
        real(8) :: discount_factor_on_child_adjuster=0 ! (1-smaller_smallest_rental)*1
        real(8) :: distance_discount_factor_on_child
        real(8) :: stopping_rule_discount_factor_on_child=10.d0**(-3)
        
        real(8) :: minimum_inheritance=0
        real(8) :: minimum_inheritance_adjuster=0
        real(8) :: distance_minimum_inheritance
        real(8) :: stopping_rule_minimum_inheritance=10.d0**(-3)
        
        real(8) :: value_of_life=(1-perceived_probability_lower)*165+perceived_probability_lower*120
        
        real(8) :: max_initial_endowment=7
        real(8) :: max_initial_endowment_adjuster=0
        real(8) :: distance_max_initial_endowment
        real(8) :: stopping_rule_max_initial_endowment=10.d0**(-3)
        
        real(8) :: size_homelessness=(1-perceived_probability_lower)*0.01+perceived_probability_lower*0.3
        
        real(8) :: size_homelessness_adjuster=0
        real(8) :: distance_size_homelessness
        real(8) :: stopping_rule_size_homelessness=10.d0**(-3)
        
        integer, parameter :: employment_grid_size=9
        integer, parameter :: productivity_below_which_to_reduce_ss=9
        real(8) :: scaling_of_ss=(1-reduce_ss_by_half)*1+reduce_ss_by_half*0.5
        real(8) :: scaling_of_ss_adjuster=0
        real(8) :: distance_scaling_of_ss
        real(8) :: stopping_rule_scaling_of_ss=10.d0**(-3)
        
        real(8), parameter :: increased_risk_of_death_homeless=0.6 
        real(8), parameter :: increased_risk_of_death_addicted=&
            have_increased_death_from_addiction*5+(1-have_increased_death_from_addiction)*size_of_penalty*5
        real(8), parameter :: increased_risk_of_death_homeless_addicted=&
            increased_risk_of_death_homeless+increased_risk_of_death_addicted
                            
        real(8), parameter :: probability_of_ui=0.3
                
        real(8) :: utility_improvement=include_addiction*0
        real(8) :: utility_improvement_adjuster=0
        real(8) :: distance_utility_improvement
        real(8) :: stopping_rule_utility_improvement=10.d0**(-3)
        
        real(8), dimension(2) :: ss_decrease_addicted=ss_decrease_for_retired_addicted*&
            include_addiction*(/0,0/)
        
        real(8), parameter :: consumption_tax=0
        real(8), parameter :: max_food_cost=&
            ((1-perceived_probability_lower)*0.126+perceived_probability_lower*0.132)/(1+consumption_tax)
                                                                        
        real(8), dimension(0:have_two_rental_markets) :: convexity_of_rental_company=&
            (1-perceived_probability_lower)*2.35+perceived_probability_lower*2.35
        real(8) :: distance_convexity_of_rental_company
        real(8) :: convexity_of_rental_company_adjuster=0
        real(8) :: stopping_rule_convexity_of_rental_company=10.d0**(-3)
                                                                   
        real(8), dimension(0:have_two_rental_markets) :: rental_management_costs=5.8601218979210445E-002
                 
        real(8) :: labor_income_tax_rate=(1-perceived_probability_lower)*0.75+perceived_probability_lower*0.69
        real(8) :: labor_income_tax_rate_adjuster=5*10.d0**(-1)
        real(8) :: stopping_rule_labor_income_tax_rate=10.d0**(-3)
                
        real(8) :: curvature_of_labor_income_taxes=0.85
        
        real(8) :: housing_status_grid_expander=1.5
        real(8) :: housing_status_grid_expander_adjuster=1*10.d0**(-1)
        real(8) :: distance_housing_status_grid_expander
        real(8) :: stopping_rule_housing_status_grid_expander=10.d0**(-3)
        
        real(8) :: smallest_rental_relative_to_lowest_income=(1-perceived_probability_lower)*0.08+perceived_probability_lower*0.19
        real(8) :: smallest_house_size_adjuster=0
        real(8) :: distance_smallest_house_size
        real(8) :: stopping_rule_smallest_house_size=10.d0**(-3) 
        
        integer, parameter :: smallest_index_for_purchase=5
        
        real(8) :: largest_house_size=(1-perceived_probability_lower)*0.315+perceived_probability_lower*0.285
        
        real(8), dimension(employment_grid_size) :: adjusted_probability
        real(8) :: average_labor_income_calibrated=&
            (1-perceived_probability_lower)*0.63724801720916613+perceived_probability_lower*0.63724801720916613
        real(8) :: median_income_calibrated=&
            (1-perceived_probability_lower)*0.46120010564103076+perceived_probability_lower*0.46120010564103076
        real(8), dimension(employment_grid_size) :: average_labor_income_by_employment_calibrated=&
            include_addiction*&
            (/0.20183596147399999,0.25387659584000000,0.32573341962899999,0.43099784501299998,&
            0.57869126790199998,0.76842039107000004,1.0258526731700000,1.3911730433400000,1.9293284858660000/)+&
            (1-include_addiction)*(/0.188012404278,0.252153720361,0.327663079872,0.433664983268,0.572493125585,&
            0.765393288547,0.973910709767,1.291599624892,1.816341129330/)
                        
        real(8) :: average_financial_calibrated=0.46422622482515985
        real(8) :: average_net_wealth_calibrated=include_addiction*1.6578927058902298417+(1-include_addiction)*1.8927058902298417
        real(8) :: total_hours_calibrated=0.4
        real(8) :: labor_supply_calibrated=1
        
        real(8) :: previous_average_labor_income
        real(8) :: distance_average_labor_income
        real(8) :: stopping_rule_average_labor_income=10.d0**(-4)
        
        real(8) :: previous_median_income
        real(8) :: distance_median_income
        real(8) :: stopping_rule_median_income=1*10.d0**(-2)
        
        real(8) :: previous_average_net_wealth
        real(8) :: distance_average_net_wealth
        real(8) :: stopping_rule_average_net_wealth=10.d0**(-3)
        
        real(8) :: fixed_cost_to_moving=0
        real(8) :: fixed_cost_to_moving_adjuster=0 !10.d0**(-1)
        real(8) :: distance_fixed_cost_to_moving
        real(8) :: stopping_rule_fixed_cost_to_moving=5*10.d0**(-6)
                
        real(8), parameter :: max_debt_to_income_ratio=only_LTV*10000+(1-only_LTV)*0.39
        real(8), parameter :: max_debt_to_income_ratio_below_80=only_LTV*10000+(1-only_LTV)*0.39
        integer, parameter :: mortgage_amortization=30
        real(8) :: fraction_to_repay=only_LTV*0+(1-only_LTV)*0.033
        real(8), parameter :: average_fraction_of_mortgage_repaid=0.017
        real(8), parameter :: mortgage_origination_cost=only_LTV*0+(1-only_LTV)*0.01
        real(8), parameter :: mortgage_interest_gap=only_LTV*0+(1-only_LTV)*0.01
        real(8), parameter :: penalty_months_of_interest=0 !real(1)/real(4)
                                               
        integer, parameter :: positive_financial_grid_size=90
        integer, parameter :: negative_financial_grid_size=61
        
        integer, parameter :: grid_gaps=coarse_grid*10+(1-coarse_grid)
           
        integer, parameter :: financial_grid_size=positive_financial_grid_size+negative_financial_grid_size
                                          
        real(8), dimension(financial_grid_size) :: financial_grid
        real(8), dimension(negative_financial_grid_size) :: financial_grid_distance_negative
        real(8), dimension(financial_grid_size) :: financial_grid_distance_positive
                
        integer, parameter :: max_amortization_years=2  
                            
        real(8), parameter :: max_times_labour_income_saved=3.2
                                              
        real(8) :: increase_in_labour_income_tax=is_counterfactual*0
        
        real(8), dimension(1-solve_transition_dynamics:transition_length) :: housing_price
        
        real(8), dimension(transition_length) :: distance_housing_market=1,distance_rental_market=1
        
        real(8) :: rental_market_adjuster
        
        real(8), parameter :: investment_income_tax=0.15             
        
        real(8), dimension(1-solve_transition_dynamics:transition_length) :: property_tax=0
        real(8) :: property_tax_on_rental_housing=is_counterfactual*check_tax_incidence*0
        
        integer :: pay_mortgage_insurance
        real(8) :: mortgage_insurance_premium=0
                
        real(8), parameter :: housing_depreciation_rate=0.006
        real(8), parameter :: cost_of_selling=0.06
        real(8), parameter :: cost_of_buying=0
        
        real(8), parameter :: threshold_income_vouchers=0.5
        real(8), parameter :: rent_to_income_ratio_vouchers=0.3
                                                               
        real(8), parameter :: life_cycle_component_a=real(0.38)/((real(life_span)-real(retirement_span)-11))
        real(8), parameter :: life_cycle_component_b=(real(0.38)-real(0.38))/(10)
        
        integer, parameter :: unemployment_grid_size=include_addiction*6+(1-include_addiction)*3
                                               
        real(8), dimension(unemployment_grid_size) :: unemployment_grid
        real(8), dimension(life_span,employment_grid_size) :: employment_grid
        integer, dimension(employment_grid_size) :: initial_endowment
        real(8), dimension(employment_grid_size) :: relative_endowments
        real(8), dimension(employment_grid_size) :: fraction_with_positive_wealth
        real(8) :: value_of_initial_assets,value_of_bequests
        real(8), dimension(life_span) :: value_of_bequests_by_age,bequests_mass_by_age
        
        real(8), dimension(employment_grid_size) :: unconditional_employment_probability
        real(8), dimension(threshold_addiction_index) :: unconditional_unemployment_probability
        real(8), dimension(life_span,employment_grid_size,employment_grid_size) :: employment_process
        real(8), allocatable, dimension(:,:,:,:,:,:) :: unemployment_process
        
        real(8), parameter :: replacement_rate_ui=0.5
        real(8), parameter :: max_ui_as_perc_of_avg_inc=1
        real(8), parameter :: probability_becoming_employed=0.297404631
        real(8), parameter :: probability_becoming_unemployed=&
            (1-perceived_probability_lower)*0.0155+perceived_probability_lower*0.0143
        
        real(8), parameter :: multiple_of_probabilities_of_employment_if_addicted=&
            have_increased_unemployment_from_addiction*2.7+(1-have_increased_unemployment_from_addiction)*size_of_penalty*1.7
        real(8), dimension(0:include_addiction,0:include_addiction,0:include_addiction,1:2) :: &
            addiction_probabilities,addiction_probabilities_percieved
        real(8), parameter :: probability_of_stopping_addiction=0.025
        real(8), parameter :: probability_of_stopping_addiction_if_homeless=(real(1)/real(6))*probability_of_stopping_addiction
        real(8), parameter :: probability_becoming_unemployed_if_addicted=&
            max(min(probability_becoming_unemployed*multiple_of_probabilities_of_employment_if_addicted,1.d0),0.d0)
        real(8), parameter :: probability_becoming_employed_if_addicted=&
            max(min(probability_becoming_employed/multiple_of_probabilities_of_employment_if_addicted,1.d0),0.d0)
        
        real(8), dimension(0:include_vouchers,0:include_vouchers,0:include_vouchers,1:3) :: &
            voucher_probabilities,voucher_probabilities_benchmark
                    
        real(8), parameter, dimension(0:2) :: probability_of_voucher_benchmark=&
            (1-perceived_probability_lower)*&
            (/real(probability_of_voucher_benchmark_used),&
            min(real(probability_of_voucher_benchmark_used*increased_prob_of_voucher_if_homeless),1.0),&
            min(real(probability_of_voucher_benchmark_used*increased_prob_of_voucher_if_homeless_and_addicted),1.0)/)+&
            perceived_probability_lower*probability_of_voucher_benchmark_used*&
            (/real(probability_of_voucher_benchmark_used),&
            min(real(probability_of_voucher_benchmark_used*increased_prob_of_voucher_if_homeless),1.0),&
            min(real(probability_of_voucher_benchmark_used*increased_prob_of_voucher_if_homeless_and_addicted),1.0)/)
            
        real(8), dimension(0:2) :: probability_of_voucher=probability_of_voucher_benchmark
            
        real(8), parameter :: homeless_cost_govt_as_perc_of_avg_inc=0.252
        real(8), parameter :: addict_cost_govt_as_perc_of_avg_inc=cost_of_addict_scaling*0.212  ! 38393
        real(8), parameter :: threshold_for_food_stamps_as_perc_of_average_net_wealth=100000 !0.015
        real(8), parameter :: fraction_of_income_spent_on_food=0.4
                                                                                              
        real(8), dimension(life_span,2,0:include_addiction) :: survival_probability,survival_probability_for_dist_iteration

        real(8), dimension(life_span) :: actual_survival_probability=(/&
            0.999057437351439000,0.999047139252070000,0.999028513848316000,0.999002128606662000,&
            0.998970763757824000,0.998937236843630000,0.998900839709677000,0.998862511711195000,&
            0.998819889500737000,0.998765300260856000,0.998697769246064000,0.998622532351874000,&
            0.998539241380058000,0.998442850308492000,0.998336586169898000,0.998207374825142000,&
            0.998037528945133000,0.997822653735056000,0.997576926602050000,0.997324218973517000,&
            0.997068772325292000,0.996794620528817000,0.996494883671402000,0.996169835096225000,&
            0.995823254343122000,0.995465271640568000,0.995096642058342000,0.994716361630707000,&
            0.994315713178366000,0.993882585782557000,0.993410578928887000,0.992905301041901000,&
            0.992374176625162000,0.991819550283253000,0.991233213804662000,0.990602982230484000,&
            0.989915066398680000,0.989137337543070000,0.988242183811962000,0.987190308049321000,&
            0.985988594591617000,0.984710191376507000,0.983398867771029000,0.981995487585663000,&
            0.980451723560690000,0.978705510497093000,0.976724572479724000,0.974471978843212000,&
            0.971939291805028000,0.969180349260568000,0.966224979609251000,0.962747562676668000,&
            0.958864040672779000,0.954589251428842000,0.949853785336017000,0.944555081427097000,&
            0.938727524131536000,0.932235985994338000,0.924182154238224000,0.000000000000000000/)
                    
        real(8), dimension(life_span) :: actual_household_size=include_varying_household_size*&
            (/2.3787293,2.3831589,2.5131222,2.6573369,&
            2.7439302,2.8492878,2.939628,2.9549821,3.0925854,2.9528197,3.2866955,3.1913625,3.3052627,&
            3.2847357,3.1969402,3.2621908,3.2081295,3.3683722,3.2301562,3.0603161,2.9865213,2.9223446,&
            3.0224219,2.954807,2.7902247,2.6784589,2.6505436,2.4317628,2.4304172,2.4165407,2.2693952,&
            2.3565881,2.1626853,2.1362974,2.0396215,2.0327433,1.971406,1.9693229,1.9238235,1.8855543,&
            1.8520651,1.8431792,1.8775815,1.822047,1.7928155,1.7562793,1.8370098,1.7640014,1.7846039,&
            1.7548529,1.715324,1.705349,1.7067496,1.6960866,1.6380913,1.5753125,1.5810592,1.5874657,&
            1.5940832,1.6004317/)+(1-include_varying_household_size)*1
                    
        real(8), dimension(life_span) :: scaled_household_size,sqrt_household_size
                                                
        real(8), dimension(life_span) :: labour_deterministic_efficiency
        
        real(8), parameter :: risk_free_rate_data=0.03
    
        real(8), dimension(transition_length) :: risk_free_rate=risk_free_rate_data
        
        real(8) :: prepayment_penalty_starts_from
    
        real(8), parameter :: financial_grid_expander_positive=1.5
                                
        integer :: largest_possible_financial_index,largest_possible_mortgage_index
        real(8) :: value_of_house_without_min_down_payment
        
        integer, parameter :: housing_status_grid_size=7
                         
        integer :: space_lived_in_num_of_internal=2  
                                                        
        real(8), dimension(lowest_housing_grid_point:housing_status_grid_size-1,life_span,0:1,0:1) :: &
            housing_status_utility_function
        real(8), dimension(lowest_housing_grid_point:housing_status_grid_size-1) :: housing_size
        
        real(8), dimension(lowest_housing_grid_point:housing_status_grid_size-1):: housing_status_grid_distance
        integer, parameter :: largest_house_size_hhld_can_rent=(housing_status_grid_size-1)
        integer :: index_of_smallest_house_hhld_can_buy=smallest_index_for_purchase
        real(8) :: size_of_smallest_house_hhld_can_buy=0.23
        real(8) :: smallest_house_size=0.121
                                            
        integer :: largest_housing_size_consumed_in_equilibrium,largest_financial_chosen_in_equilibrium,&
            smallest_financial_chosen_in_equilibrium
        real(8) :: fraction_with_largest_housing_size_consumed_in_eqilibrium,&
            fraction_with_smallest_financial_in_eqilibrium,largest_financial_chosen_in_equilibrium_calibrated,&
            smallest_financial_chosen_in_equilibrium_calibrated
                        
        real(8), dimension(1-solve_transition_dynamics:transition_length) :: total_housing_demand
        real(8), dimension(transition_length) :: total_rent_paid
            
        real(8), dimension(1-solve_transition_dynamics:transition_length,0:have_two_rental_markets) :: &
            total_rental_demand,total_rental_supply
        real(8), dimension(1-solve_transition_dynamics:transition_length,0:1) :: total_rental_demand_segmented
        
        real(8), dimension(transition_length,lowest_housing_grid_point:housing_status_grid_size-1) :: renters_by_rental
        real(8), dimension(transition_length) :: total_renters
                    
        real(8) :: consumption_choice,total_consumption_choice
        real(8), dimension(financial_grid_size) :: flow_utility_vector
        real(8), dimension(financial_grid_size) :: future_utility_vector,future_bequest_vector,future_leisure_vector
        
        real(8) :: flow_utility_internal,future_utility_internal,future_bequest_internal,future_leisure_internal
                            
        real(8) :: rent_to_housing_price=himmelberg_etal_rent_to_price
        
        real(8) :: rent_to_price_adjuster=0.5
        real(8) :: distance_rent_to_price
        real(8) :: stopping_rule_rent_to_price=10.d0**(-3)
                                                                                                                                   
        real(8), dimension(1-solve_transition_dynamics:transition_length,0:have_two_rental_markets) :: rent
        real(8), dimension(life_span) :: average_rent_by_age,mass_of_renters_by_age

        real(8), dimension(transition_length) :: total_imputed_rents
        real(8), dimension(transition_length) :: total_renters_income
                                                   
        real(8), dimension(0:have_two_rental_markets) :: rental_management_costs_calibrated=2.9157271938684660E-002
                                                               
        real(8), dimension(0:have_two_rental_markets) :: rent_calibrated=1.079
    
        real(8) :: average_rent_calibrated=1.079
                                   
        real(8), dimension(0:have_two_rental_markets) :: long_run_rent=1.079
                                 
        real(8) :: calibrated_stationary_housing_price=13
                                
        real(8) :: long_run_stationary_housing_price=13
                                        
        real(8) :: calibrated_housing_stock=5
                                
        real(8) :: long_run_housing_stock=5
                                                                            
        real(8) :: c_min_calibrated=6.2
        
        real(8) :: c_1_calibrated=41
        
        real(8) :: cutoff_housing_investment_calibrated=0.11
                                                                          
        real(8) :: net_govt_revenue_constraint=5
                                                                                              
        real(8) :: distance_govt_budget
                                          
        real(8), dimension(0:have_two_rental_markets) :: total_rental_supply_calibrated=5.5844219551867003
        real(8) :: total_rental_supply_upload=5.5844219551867003
                                                                                                                                                                                                   
        real(8) :: calibrated_risk_free_rate=0.03
        real(8), dimension(transition_length) :: mortgage_interest_rate
                                                                                                                                              
        real(8) :: slope_of_housing_stock_guess,slope_of_housing_price_guess,slope_of_rent_guess
                                                                              
        real(8), dimension(1-solve_transition_dynamics:transition_length) :: housing_stock
                
        real(8), parameter :: empirical_housing_supplpy_elasticity=0.9
    
        real(8), parameter :: empirical_land_to_housing_stock=0.314395015 
        real(8) :: land_to_housing_stock
        real(8) :: c_min,c_1,c_1_2  
        real(8) :: cutoff_housing_investment
        real(8), dimension(2) :: cutoff_housing_investment_bisection                 
        real(8), parameter :: stopping_rule_cutoff_housing_investment=10.d0**(-5) 
        real(8) :: distance_cutoff_housing_investment 
        real(8), dimension(transition_length) :: housing_investment,housing_investment_value 
        
        real(8) :: land_value
        
        real(8) :: gross_wage_income,wage_income_tax_paid,investment_income,&
            investment_income_tax_paid,total_household_working_wealth,gross_housing_wealth,&
            housing_depreciation_expenditures,rent_spending,total_household_wealth,&
            property_taxes_paid,gross_housing_value,spending_on_housing,after_tax_wealth_net_of_expenses,&
            mortgage_deductions_tax_rebates,originate_new_mortgage,cutoff_taxable_income,food_stamps_recieved,&
            housing_voucher_recieved,housing_voucher_recieved_2,frac_spent_on_addiction
            
        integer :: is_homeless_2,future_housing_status_index_to_use_2,went_in_1,addiction_used
            
        real(8), dimension(1-solve_transition_dynamics:transition_length) :: lump_sum_transfer
            
        real(8) :: optimal_after_tax_wealth_net_of_expenses
                            
        real(8) :: optimal_gross_wage_income_owner,optimal_wage_income_tax_paid_owner,&
            optimal_mortgage_deductions_owner,optimal_after_tax_wealth_net_of_expenses_owner,&
            optimal_consumption_owner,optimal_labor_supply_owner,optimal_cutoff_taxable_income_owner,&
            optimal_frac_spent_on_addiction_owner,optimal_total_consumption_owner

        real(8) :: optimal_gross_wage_income_renter,optimal_wage_income_tax_paid_renter,&
            optimal_mortgage_deductions_renter,optimal_after_tax_wealth_net_of_expenses_renter,&
            optimal_consumption_renter,optimal_labor_supply_renter,optimal_cutoff_taxable_income_renter,&
            optimal_frac_spent_on_addiction_renter,optimal_total_consumption_renter
                
        real(8) :: optimal_gross_wage_income_renter_renter,optimal_wage_income_tax_paid_renter_renter,&
            optimal_mortgage_deductions_renter_renter,optimal_after_tax_wealth_net_of_expenses_renter_renter,&
            optimal_consumption_renter_renter,optimal_labor_supply_renter_renter,&
            optimal_cutoff_taxable_income_renter_renter,optimal_frac_spent_on_addiction_renter_renter,&
            optimal_total_consumption_renter_renter
                    
        real(8) :: optimal_gross_wage_income_renter_owner,optimal_wage_income_tax_paid_renter_owner,&
            optimal_mortgage_deductions_renter_owner,optimal_after_tax_wealth_net_of_expenses_renter_owner,&
            optimal_consumption_renter_owner,optimal_labor_supply_renter_owner,optimal_cutoff_taxable_income_renter_owner,&
            optimal_frac_spent_on_addiction_renter_owner,optimal_total_consumption_renter_owner
                    
        real(8) :: optimal_gross_wage_income_owner_owner_stay,optimal_wage_income_tax_paid_owner_owner_stay,&
            optimal_after_tax_wealth_net_of_expenses_owner_owner_stay,&
            optimal_consumption_owner_owner_stay,optimal_mortgage_deductions_owner_owner_stay,&
            optimal_labor_supply_owner_owner_stay,optimal_cutoff_taxable_income_owner_owner_stay,&
            optimal_frac_spent_on_addiction_owner_owner_stay,optimal_total_consumption_owner_owner_stay
                    
        real(8) :: optimal_gross_wage_income_owner_owner_move,optimal_wage_income_tax_paid_owner_owner_move,&
            optimal_after_tax_wealth_net_of_expenses_owner_owner_move,optimal_consumption_owner_owner_move,&
            optimal_mortgage_deductions_owner_owner_move,optimal_labor_supply_owner_owner_move,&
            optimal_cutoff_taxable_income_owner_owner_move,optimal_frac_spent_on_addiction_owner_owner_move,&
            optimal_total_consumption_owner_owner_move
                    
        real(8) :: optimal_gross_wage_income_owner_renter,optimal_wage_income_tax_paid_owner_renter,&
            optimal_after_tax_wealth_net_of_expenses_owner_renter,optimal_after_tax_wealth_owner_renter,&
            optimal_consumption_owner_renter,optimal_mortgage_deductions_owner_renter,optimal_labor_supply_owner_renter,&
            optimal_cutoff_taxable_income_owner_renter,optimal_frac_spent_on_addiction_owner_renter,&
            optimal_total_consumption_owner_renter
                    
        integer :: optimal_space_lived_in_owner,optimal_space_lived_in_renter,&
            optimal_space_lived_in_renter_renter,optimal_space_lived_in_renter_owner,&
            optimal_space_lived_in_owner_renter,optimal_space_lived_in_owner_owner_move,&
            optimal_space_lived_in_owner_owner_stay,optimal_household_can_consume_owner,&
            optimal_addiction_status_renter,optimal_addiction_status_owner,optimal_addiction_status_renter_renter,&
            optimal_addiction_status_renter_owner,optimal_addiction_status_owner_owner_stay,&
            optimal_addiction_status_owner_owner_move,optimal_addiction_status_owner_renter,&
            optimal_household_can_consume_renter,&
            optimal_household_can_consume_renter_renter,optimal_household_can_consume_renter_owner,&
            optimal_household_can_consume_owner_owner_stay,optimal_household_can_consume_owner_owner_move,&
            optimal_household_can_consume_owner_renter                    
                                                            
        integer, dimension(3) :: optimal_owner_indeces,optimal_renter_indeces,&
             optimal_owner_owner_move_indeces,optimal_owner_owner_stay_indeces,&
             optimal_owner_renter_indeces,optimal_renter_renter_indeces,optimal_renter_owner_indeces
                                    
        integer :: time_index,age_index,unemployment_index,employment_index,years_left_on_mortgage_index,&
           housing_status_index,space_lived_in_index,space_lived_in_index_feasible,frac_spent_on_addiction_index,&
           voucher_index
                                                                   
        integer :: future_financial_index,future_mortgage_index,future_housing_status_index,&
           future_years_of_amortization_index,future_unemployment_index,future_employment_index,&
           future_addiction_index,future_addiction_index_2,future_voucher_index
                    
        integer :: past_employment_index_1,past_employment_index_2,past_employment_index_3,past_employment_index_4
        
        type :: jagged_matrix_transition_real 
            real(8), dimension(:,:,:,:,:,:,:), allocatable  :: vector_transition_real
        end type jagged_matrix_transition_real
                
        type :: jagged_matrix_transition_integer
            integer, dimension(:,:,:,:,:,:,:), allocatable  :: vector_transition_integer
        end type jagged_matrix_transition_integer
        
        type :: jagged_matrix_youngest
            real(8), dimension(:,:,:,:,:), allocatable  :: vector_youngest_real
        end type jagged_matrix_youngest
        
        type :: jagged_matrix_cpu_real
            real(8), dimension(:,:,:,:,:,:,:), allocatable  :: vector_cpu_real
        end type jagged_matrix_cpu_real
        
        type :: jagged_matrix_real 
            real(8), dimension(:,:,:,:,:,:), allocatable  :: vector_real
        end type jagged_matrix_real
        
        type :: jagged_matrix_integer
            integer, dimension(:,:,:,:,:,:), allocatable  :: vector_integer
        end type jagged_matrix_integer
        
        type :: jagged_matrix_real_income
            real(8), dimension(:,:,:,:,:,:), allocatable  :: vector_real_income
        end type jagged_matrix_real_income
        
        type(jagged_matrix_transition_real), dimension(1:2) :: value_function,policy_function_wage_income_tax_paid,&
            policy_function_mortgage_interest_deductions,policy_function_consumption,policy_function_space_lived_in_size,&
            policy_function_labor_supply,policy_function_cutoff_taxable_income,policy_function_frac_spent_on_addiction,&
            frac_mov_optimal_1,distribution_guess,distribution_implied,distribution_stationary,distribution_forward,&
            policy_function_total_consumption
                    
        type(jagged_matrix_transition_integer), dimension(1:2) :: &
            policy_function_financial_index,policy_function_housing_status_index,policy_function_space_lived_in_index,&
            policy_function_years_of_amortization_index,fin_index_frac_mov_to_optimal,policy_function_addiction
            
        type(jagged_matrix_real_income), dimension(1:2) :: income_matrix,income_matrix_saved
           
        integer, parameter :: max_CPUs=40
           
        type(jagged_matrix_cpu_real), dimension(1:2) :: distribution_implied_private
           
        type(jagged_matrix_real), dimension(1:2) ::  value_function_benchmark,distribution_stationary_benchmark,&
            policy_function_labor_supply_benchmark,policy_function_total_consumption_benchmark,&
            policy_function_consumption_benchmark,policy_function_frac_spent_on_addiction_benchmark,&
            value_function_comparison,frac_mov_optimal_1_benchmark
         
        type(jagged_matrix_integer), dimension(1:2) :: policy_function_housing_status_index_benchmark,&
            policy_function_years_of_amortization_index_benchmark,policy_function_financial_index_benchmark,&
            fin_index_frac_mov_to_optimal_benchmark,policy_function_addiction_benchmark
            
        integer :: already_uploaded_benchmark
            
        type(jagged_matrix_youngest), dimension(1:2) :: value_function_guess
        
        type(jagged_matrix_real), dimension(1:2) :: distribution_to_fetch,policy_function_space_lived_in_size_to_fetch
            
        real(8) :: value_function_renter,value_function_renter_renter,value_function_renter_owner,&
            value_function_owner,value_function_owner_owner_stay,value_function_owner_owner_move,&
            value_function_owner_renter
                       
        integer, parameter :: max_rent_to_income=19
        integer, parameter :: number_of_grids_rent_to_income_cdf=1901
        integer, parameter :: number_of_wide_grids_income_to_avg_income_cdf=20
                
        real(8), dimension(transition_length,number_of_grids_rent_to_income_cdf) :: &
            rent_to_income_cdf,rent_to_income_ratios,rent_to_income_homeless_cdf,&
            median_income_cdf
                        
        real(8), dimension(transition_length,number_of_wide_grids_income_to_avg_income_cdf) :: &
            income_to_avg_income_wide_ratios,income_to_avg_income_wide_pdf_1

        integer, parameter :: number_of_profiles_for_income=16
            
        real(8), dimension(transition_length,0:2,&
            number_of_wide_grids_income_to_avg_income_cdf,number_of_profiles_for_income) :: &
            profile_by_income_to_avg_income_wide_1

        real(8), dimension(transition_length,0:2,number_of_wide_grids_income_to_avg_income_cdf) :: &
            mass_at_profile_income_to_avg_income_wide_1
                        
        real(8), dimension(transition_length) :: median_income
        real(8), dimension(transition_length,2) :: percentiles_homeless_income
            
        real(8), dimension(transition_length,101) :: LTV_cdf,LTV_ratios
                
        real(8) :: distance_value_function
                            
        real(8) :: val_fun_internal
                                                                   
        real(8) :: slope_of_financial_internal,slope_of_space_lived_in_internal
        
        real(8) :: dis_prev_index_fin,dis_next_index_fin,dis_prev_index_space_lived_in,dis_next_index_space_lived_in
        
        real(8) :: dis_internal_from_optimal_fin
                
        real(8) :: financial_internal,space_lived_in_internal
                                                                                           
        real(8) :: frac_mov_to_another_cell_1
                                                                            
        integer :: fin_index_frac_mov_to
                                        
        real(8) :: largest_value
        
        integer :: choose_to_own
                                                                             
        real(8) :: distance_distribution=1
        
        real(8), dimension(life_span) :: cohort_population
        real(8) :: total_population
        
        integer :: i,j,k,m,loop_index,age_group
        
        real(8) :: distance_calibration=1     
        
        real(8), dimension(transition_length) :: &
            model_homeownership_rate,model_financial,model_financial_renters,model_gross_housing_wealth,&
            model_net_housing_wealth,model_mortgages,model_total_net_wealth,model_GDP_incl_imput_rent,&
            model_fraction_of_homeowners_with_mortgage,model_total_investment_income,model_output,model_GDP,&
            model_average_labour_income,model_homeownership_rate_young,model_mortgages_young,&
            model_total_workers,model_average_labour_income_tax,model_average_rental_unit_size,&
            model_average_owner_occupied_unit_size,mass_of_owners,mass_of_owners_with_mortgage,model_total_efficiency_units,&
            mass_of_renters,model_bequests,model_youngest_assets,model_fraction_of_homeowners_with_mortgage_over_80_perc,&
            model_average_net_wealth,model_housing_value_per_capita,model_average_ss_benefits,&
            model_fraction_of_property_tax_paid_by_renters,model_wealth_of_owners,model_wealth_of_renters,&
            model_average_financial,model_mass_with_positive_financial,model_mass_switchers,&
            model_age_switchers_to_renting,model_prod_switchers_to_renting,model_financial_switchers_to_renting,&
            model_house_size_switchers_to_renting,model_mass_non_switcher_renters,model_age_non_switcher_renters,&
            model_prod_non_switcher_renters,model_financial_non_switcher_renters,model_house_size_non_switcher_renters,&
            model_mass_switchers_mortgages,model_age_switchers_mortgages_to_renting,model_prod_switchers_mortgages_to_renting,&
            model_financial_switchers_mortgages_to_renting,model_house_size_switchers_mortgages_to_renting,&
            model_labor_supply,model_total_hours,model_avg_rent_to_income_ratio,model_fraction_leaving_bequests,mass_dying,&
            model_fraction_leaving_housing_bequests,model_financial_bequests,model_fraction_homeless,&
            model_average_income,mass_of_legit_renters,model_avg_mortgage_spending,model_avg_housing_spending_owners,&
            model_avg_housing_spending_all,model_avg_housing_spending_renters,model_sum_of_lowest_productivities,&
            model_fraction_of_homeowners_with_mortgage_over_90_perc,model_average_owner_occupied_unit_size_to_income,&
            model_average_owners_income,model_average_owner_occupied_unit_size_to_income_work_age,working_age_mass,&
            model_average_LTV_at_orgination,model_average_LTV_at_orgination_2,model_mass_origination,model_mass_origination_2,&
            model_fraction_of_homeowners_with_mortgage_over_20_perc,model_fraction_unemployed,&
            model_fraction_unemployed_on_ui,model_fraction_of_homeless_unemployed,model_fraction_of_unemployed_homeless,&
            model_fraction_recieving_food_stamps,model_fraction_recieving_housing_vouchers,&
            model_fraction_homeless_recieving_food_stamps,model_fraction_homeless_by_choice,&
            model_avg_homeless_income,model_avg_homeless_assets,model_avg_homeless_after_tax_income,&
            model_avg_homeless_tax_to_income,model_food_stamps_share_to_homeless,&
            model_fraction_addicted,model_fraction_homeless_and_addicted,model_homelessness_old,&
            model_fraction_spent_on_addiction,model_fraction_spent_on_addiction_experimenters,&
            model_fraction_addicted_homeless_no_vouchers,model_average_spent_on_addiction_by_addicted,&
            model_fraction_of_homeless_and_addicted_unemployed,model_fraction_addicted_and_unemployed,&
            model_fraction_homeless_owners,model_addicted_and_homeless_by_choice,&
            model_average_income_of_homeless_addicted,model_average_assets_addicted_and_homeless,model_average_rent,&
            model_average_income_addicted,model_average_assets_addicted,model_fraction_choose_zero_work,&
            model_mass_can_work,model_fraction_choose_addiction_when_unemployed,&
            model_fraction_choose_addiction,model_fraction_choose_little_work,&
            model_fraction_choose_addiction_when_homeless,model_mass_choose_addiction,model_value_of_life,&
            model_fraction_with_negative_value_of_life,model_choose_addiction_when_retired,&
            model_fraction_homeless_with_negative_value_of_life,model_fraction_addicted_with_negative_value_of_life,&
            model_largest_negative_value_of_life,model_total_income,model_eligibles_getting_voucher,model_addicts_getting_voucher,&
            model_eligibles,model_addicted,model_exprimenters,model_total_drug_users,&
            model_addicted_total_income,model_addicted_total_addiction_spending_to_total_income,&
            model_experimenters_total_drug_spending_to_total_income,model_experimenters_total_income,&
            model_drugs_used_by_users_on_average,model_drugs_used_by_experimenters_on_average,model_mass_total_users,&
            model_mass_experimenters,model_mass_addicts,model_drugs_used_by_addicts_on_average,&
            model_drugs_consumed_by_users,model_experimenters_getting_voucher,model_avg_income_experimenters,&
            model_avg_assets_experimenters,model_total_net_wealth_1,model_mass_renters_to_consider,&
            model_fraction_addicted_who_are_homeless,model_net_wealth_owners,model_net_wealth_renters,&
            model_total_owners,model_total_renters,model_homeless_2_years_or_more,model_youngest_net_wealth_share,&
            model_total_inheritance,model_homeowners_experimenting,model_average_income_plus_assets,&
            model_average_income_plus_all_assets,model_addicts_consuming_no_drugs,model_avg_income_drug_users,&
            model_average_assets_drug_users,model_drug_users_getting_voucher,model_eligibles_getting_voucher_relative_to_pop,&
            model_choose_addiction_when_income_is_low
            
        real(8), dimension(transition_length,5) :: profile_of_chronic_homeless,mass_profile_of_chornic_homeless
                        
        real(8), dimension(transition_length,0:include_addiction) :: &
            model_average_assets_homeless_by_addiction,model_average_income_homeless_by_addiction,&
            model_mass_by_homeless_and_addiction,model_age_by_addiction,model_mass_age_by_addiction
            
        real(8), dimension(number_of_inheritance_groups) :: total_population_group_1
            
        real(8), dimension(3) :: model_profile_of_homeless_old
            
        real(8), dimension(transition_length,life_span,0:2) :: homelessness_duration
        real(8), dimension(transition_length,life_span) :: homelessness_mass_by_age
        real(8), dimension(transition_length,0:2) :: homelessness_duration_everyone
        
        integer, parameter :: number_of_quintiles=5
            
        real(8), dimension(transition_length,life_span) :: model_addiction_rate_by_age,model_experimentation_choice_by_age
        real(8), dimension(transition_length,9) :: model_drug_use_by_age_group,model_drug_use_percent_by_age_group
        real(8), dimension(transition_length,number_of_quintiles) :: model_drug_use_by_income_quintile,mass_by_income_quintile_1
        real(8), dimension(transition_length,0:1,number_of_quintiles,number_of_profiles_for_income) :: profile_by_income_quintile
        real(8), dimension(transition_length,0:1,number_of_quintiles) :: mass_by_income_quintile_2
            
        real(8), dimension(num_percentiles) :: model_median_assets_to_income
        real(8), dimension(2) :: var_log
            
        real(8), parameter :: weight_on_labor_income=0.5,weight_on_median_income=0.5
            
        real(8), dimension(transition_length,5) :: model_LTV_by_age_group,mass_LTV_by_age_group,model_homeownership_by_age_group,&
            mass_by_age_group
                                                        
        real(8), dimension(transition_length,life_span,employment_grid_size) :: mass_by_age_and_employment
        
        real(8), dimension(transition_length,life_span) :: mass_renters_by_age,addiction_rate_by_age,mass_by_age,&
            homeless_and_addiction_rate_by_age
                                                                                                        
        real(8), dimension(transition_length,0:have_two_rental_markets) :: total_rental_company_profits
            
        real(8), dimension(transition_length) :: construction_company_profits,total_constrcution_profits,total_profits
                                                                
        real(8), dimension(transition_length) :: frac_in_support,frac_in_support_youngest,&
            frac_in_support_addicted,frac_in_support_addicted_youngest
        
        real(8), dimension(transition_length,employment_grid_size,1:3) :: &
            frac_in_support_by_tenure_and_employment,mass_by_tenure_and_employment
                                
        real(8), dimension(employment_grid_size) :: &
            model_ss_benefits,model_lifetime_income_conditional_on_last_period_shock,model_addiction_by_employment
            
        real(8) :: model_average_lifetime_income_conditional_on_last_period_shock
            
        real(8), dimension(unemployment_grid_size,employment_grid_size) :: probability_came_from_past_employment_index_1,&
            probability_came_from_past_employment_index_2
            
        real(8), dimension(transition_length,employment_grid_size) :: model_unemployment_by_employment,mass_by_employment_1
                                                
        integer :: in_retirement,newborn_household
        
        integer :: at_least_one_period_before_retirement,has_mortgage,can_get_mortgage,&
            one_period_before_death
        
        real(8) :: max_mortgage_payments_as_fraction_of_income  
        
        real(8), dimension(transition_length,employment_grid_size) :: &
            welfare_by_employment,welfare_by_employment_youngest,welfare_by_employment_youngest_old_dist,&
            mass_by_employment,mass_by_employment_youngest,MID_share_by_employment,wealth_by_employment,&
            fraction_with_mortgage,fraction_renters_by_employment,mass_of_renters_by_employment,&
            average_age_of_homeowner,average_income,average_housing_costs,mass_inheritance,&
            average_consumption,average_house_inheritance,average_house_non_inheritance,&
            mass_non_inheritance,addiction_share_of_income_by_employment,employment_mass,&
            percent_addicted_by_employment,model_average_labour_income_by_employment,&
            average_age_of_homeowner_by_employment,mass_homeowners_by_employment
            
        real(8), dimension(transition_length,2) :: welfare_by_addiction,mass_by_addiction,&
            welfare_by_addiction_youngest,mass_by_addiction_youngest,welfare_by_homelessness,mass_by_homelessness
            
        real(8), dimension(transition_length,11) :: lowest_welfare_of_addicted
            
        real(8), dimension(2) :: welfare_by_addiction_youngest_calibrated
            
        real(8), dimension(3) :: welfare_of_gains_by_addiction
            
        real(8), dimension(transition_length,unemployment_grid_size) :: &
            welfare_by_unemployment,mass_by_unemployment
            
        real(8), dimension(transition_length,employment_grid_size,3) :: &
            welfare_by_employment_and_tenure,mass_by_employment_and_tenure,&
            mortgage_by_employment_and_tenure,wealth_by_employment_and_tenure,&
            consumption_by_employment_and_tenure,housing_by_employment_and_tenure
            
        real(8), dimension(transition_length,life_span) :: mortgage_to_house_value_ratio_of_owners_by_age,&
            mass_mortgage_to_house_value_ratio_of_owners_by_age
                                 
        real(8), dimension(transition_length,employment_grid_size,3,life_span/3) :: &
            welfare_by_employment_tenure_and_age,mass_by_employment_tenure_and_age,mortgage_by_employment_tenure_and_age
            
        real(8), dimension(transition_length,employment_grid_size) :: &
            mortgage_by_employment,mass_by_mortgage_and_employment
                        
        real(8), dimension(transition_length,0:1,employment_grid_size) :: welfare_by_ownership_status,mass_by_ownership_status
            
        real(8), dimension(transition_length,life_span) :: welfare_by_age,homelessness_by_age
        real(8), dimension(transition_length,5) :: homelessness_by_age_group
        
        real(8), dimension(transition_length,life_span,0:include_addiction) :: &
            welfare_by_age_and_addiction,mass_by_age_and_addiciton
        
        real(8), dimension(transition_length,employment_grid_size,life_span) :: &
            welfare_by_employment_and_age,mass_by_employment_and_age
                        
        real(8), dimension(transition_length,life_span) :: homeownership_by_age,housing_size_by_age,&
            model_assets_by_age
            
        real(8), dimension(transition_length,employment_grid_size) :: &
            homeownership_by_employment,housing_size_by_employment
                        
        real(8), dimension(transition_length,employment_grid_size,1:3) :: &
            tenure_by_employment,housing_size_by_employment_and_tenure
            
        real(8), dimension(transition_length,life_span,employment_grid_size) :: &
            mass_by_age_and_employment_benchmark,mass_by_age_and_employment_counterfactual,&
            labor_supply_by_age_and_employment_benchmark,labor_supply_by_age_and_employment_counterfactual
                    
        real(8), dimension(transition_length,number_of_quintiles,1:3) :: tenure_by_income_quintile
        real(8), dimension(transition_length,number_of_quintiles) :: rent_burden_by_income_quintile,mass_renters_by_income_quintile
            
        real(8), dimension(transition_length,number_of_quintiles) :: MID_share_by_income_quintile,MID_itemizers_by_income_quintile,&
            mass_by_income_quintile
            
        real(8), dimension(transition_length,employment_grid_size,life_span) :: &
            housing_size_by_employment_and_age,consumption_by_employment_and_age,wealth_by_employment_and_age
            
        real(8), dimension(transition_length,life_span) :: wealth_by_age_renter,mass_by_age_and_renter,income_by_age_renter,&
            consumption_by_age_renter,housing_consumption_by_age_renter,consumption_by_age
                
        real(8), dimension(transition_length,financial_grid_size,&
            lowest_housing_grid_point:housing_status_grid_size-1,1:max_amortization_years) :: &
            wealth_matrix,wealth_matrix_saved,wealth_matrix_gini
                                            
        integer :: wealth_counter,income_counter
        
        integer, parameter :: wealth_brackets=8
        integer, parameter :: income_brackets=6
        
        real(8), dimension(wealth_brackets) :: model_wealth_of_top_x_perc,pop_of_top_wealth_x_perc,&
            distance_pop_of_top_wealth_x_perc,stopping_rule_wealth_dist
            
        real(8), dimension(income_brackets) :: model_income_of_top_x_perc,pop_of_top_income_x_perc,&
            distance_pop_of_top_income_x_perc,stopping_rule_income_dist
            
        real(8), dimension(1) :: pop_of_x_perc,distance_pop_of_x_perc
                        
        real(8), dimension(3) :: model_wealth_of_x_perc_of_old,stopping_rule_wealth_dist_of_old
        integer, parameter :: lower_age_for_old=50
        integer, parameter :: upper_age_for_old=75
                            
        integer, parameter :: number_of_thresholds=4
        real(8) :: max_wealth,min_wealth,min_wealth_gini
        integer, dimension(3) :: max_wealth_index,min_wealth_index,min_wealth_index_gini
        
        real(8) :: max_income,min_income,min_income_gini
        integer, dimension(6) :: max_income_index,min_income_index,min_income_index_gini
        
        real(8), dimension(transition_length) :: gini_coefficient_numerator,gini_coefficient
        
        real(8), dimension(transition_length,2) :: gini_coefficient_cumulative_wealth
        
        real(8), dimension(transition_length,number_of_thresholds) :: &
            mass_of_renters_at_housing_spending,mass_of_homeowners_at_housing_spending,&
            frac_of_inc_spent_on_hous_threshold
            
        real(8), dimension(transition_length,life_span,number_of_thresholds) :: model_rent_burden_by_age
                                        
        real(8) :: fraction_of_income_spent_on_housing
        
        integer :: thread_num,thread_index,total_number_of_threads
        
        real(8) :: labor_supply_to_use,income_to_use_4
        integer :: has_opportunity_2,first_voucher_index_1,second_voucher_index_1
                        
        real(8), dimension(transition_length) :: total_govt_revenues,govt_revenues_from_labour_income,&
            govt_revenues_from_consumption,govt_revenues_from_investment_income,govt_revenues_from_property_tax,&
            govt_spending_on_ss,net_govt_revenues,govt_spending_on_mortgage_interest_deductions,fraction_using_MID,&
            govt_lump_sum_transfers,govt_spending_on_ui,govt_spending_on_homeless,govt_spending_on_addicts,&
            govt_spending_on_food_stamps,govt_spending_on_housing_vouchers,govt_ss_wasted,govt_spending_on_housing_vouchers_2,&
            govt_revenues_to_use_in_tests
        
        real(8), dimension(transition_length) :: average_welfare_of_youngest_cohort,average_welfare_of_all_cohorts,&
            average_welfare_of_winners,average_welfare_of_winners_benchmark
            
        real(8) :: average_welfare_of_youngest_cohort_calibrated
            
        real(8), dimension(transition_length,number_of_quintiles) :: average_welfare_of_youngest_by_quintile,population_by_quintile
        
        real(8), dimension(transition_length) :: aggregate_consumption,aggregate_housing_consumption,&
            aggregate_mortgage_consumption,aggregate_housing_transaction_costs,&
            aggregate_rent_spending,aggregate_origination_costs,aggregate_prepayment_costs,&
            aggregate_moving_costs,aggregate_spending_on_addiction,homeowners_refinancing_own_home,&
            homeowners_originating_mortgage,refinanced_mortgages,aggregate_total_consumption
            
        real(8), dimension(transition_length,life_span*financial_grid_size*unemployment_grid_size*&
            employment_grid_size*max_amortization_years) :: model_incomes_earned,model_incomes_earned_saved,&
            model_mass_of_households_by_income_earned,model_cdf_of_income_earned
                        
        real(8), dimension(number_of_quintiles-1) :: income_cutoffs_of_quintiles
        real(8), dimension(number_of_quintiles) :: mass_of_quintile
                        
        real(8) :: largest_housing_market_distance,largest_rental_market_distance
                                        
        real(8) :: x
        real(8) :: large_negative_num
        real(8) :: large_num=10.d0**(4)
        
        real(8) :: cut_off_1,cut_off_2
        
        real(8) ::  value_function_iteration_start_time,value_function_iteration_stop_time
        
        real(8) :: simulation_start_time,simulation_stop_time
        
        integer :: loop_count,loop_count_gini,loop_count_dist,counter,loop_over_addiction_2,check_2
        integer :: simulation_ended
        
        integer :: financial_index_copy,financial_index_copy_1,addiction_choice_1
        integer :: amortization_used_dist
        integer :: financial_index_used_3,space_lived_in_index_used_3
        real(8) :: labor_supply_used_3,frac_spent_on_addiction_3
        real(8) :: fraction_copy
        real(8) :: sum_of_distribution,sum_of_distribution_not_be_homeless,sum_of_distribution_youngest,&
            sum_of_retirees
        
        real(8) :: expected_age_non_addicted,expected_age_homeless,expected_age_addicted,expected_age_homeless_and_addicted
        real(8), dimension(4) :: mass_2
        
        real(8) :: max_mortgage_value_allowed_1
        integer :: max_future_mortgage_index_1,track_housing_2
                                                
        !$omp threadprivate(gross_wage_income)  
        !$omo threadprivate(cutoff_taxable_income)
        !$omp threadprivate(spending_on_housing)
        !$omp threadprivate(wage_income_tax_paid)
        !$omp threadprivate(total_household_working_wealth)
        !$omp threadprivate(investment_income)
        !$omp threadprivate(investment_income_tax_paid)
        !$omp threadprivate(rent_spending)
        !$omp threadprivate(mortgage_deductions_tax_rebates)
        !$omp threadprivate(total_household_wealth)
        !$omp threadprivate(property_taxes_paid)
        !$omp threadprivate(gross_housing_wealth)
        !$omp threadprivate(housing_depreciation_expenditures)
        !$omp threadprivate(gross_housing_value)
        !$omp threadprivate(after_tax_wealth_net_of_expenses)
        !$omp threadprivate(originate_new_mortgage)
        !$omp threadprivate(food_stamps_recieved)
        !$omp threadprivate(housing_voucher_recieved)
        !$omp threadprivate(housing_voucher_recieved_2)
        !$omp threadprivate(frac_spent_on_addiction)
        !$omp threadprivate(is_homeless_2)
        !$omp threadprivate(future_housing_status_index_to_use_2)
        !$omp threadprivate(went_in_1)
        !$omp threadprivate(addiction_used)
        !$omp threadprivate(loop_over_addiction_2)
        !$omp threadprivate(check_2)
        
        !$omp threadprivate(consumption_choice)
        !$omp threadprivate(total_consumption_choice)
        !$omp threadprivate(largest_possible_financial_index)
        !$omp threadprivate(flow_utility_vector)
        !$omp threadprivate(future_utility_vector)
        !$omp threadprivate(future_bequest_vector)
        !$omp threadprivate(future_leisure_vector)
        
        !$omp threadprivate(future_unemployment_index)
        !$omp threadprivate(future_employment_index)
        !$omp threadprivate(space_lived_in_index)
        !$omp threadprivate(space_lived_in_index_feasible)
        !$omp threadprivate(future_housing_status_index)
        !$omp threadprivate(future_mortgage_index)
        !$omp threadprivate(future_financial_index)
        !$omp threadprivate(future_years_of_amortization_index)
        !$omp threadprivate(frac_spent_on_addiction_index)
        !$omp threadprivate(future_addiction_index)
        !$omp threadprivate(future_addiction_index_2)
        !$omp threadprivate(future_voucher_index)
        
        !$omp threadprivate(loop_count)
        !$omp threadprivate(thread_num)
        !$omp threadprivate(thread_index)
        !$omp threadprivate(largest_value)
        !$omp threadprivate(i)
        
        !$omp threadprivate(labor_supply_to_use)
        !$omp threadprivate(income_to_use_4)
        !$omp threadprivate(has_opportunity_2)
        !$omp threadprivate(first_voucher_index_1)
        !$omp threadprivate(second_voucher_index_1)
        
        !$omp threadprivate(financial_index_copy)
        !$omp threadprivate(financial_index_copy_1)
        !$omp threadprivate(addiction_choice_1)
        !$omp threadprivate(amortization_used_dist)
        !$omp threadprivate(financial_index_used_3)
        !$omp threadprivate(frac_spent_on_addiction_3)
        !$omp threadprivate(space_lived_in_index_used_3)
        !$omp threadprivate(labor_supply_used_3)
        !$omp threadprivate(fraction_copy)
        !$omp threadprivate(max_mortgage_value_allowed_1)
        !$omp threadprivate(max_future_mortgage_index_1)
        
        !$omp threadprivate(dis_prev_index_space_lived_in)
        !$omp threadprivate(dis_next_index_space_lived_in)
        !$omp threadprivate(dis_prev_index_fin)
        !$omp threadprivate(dis_next_index_fin)
        !$omp threadprivate(dis_internal_from_optimal_fin)
        !$omp threadprivate(slope_of_space_lived_in_internal)
        !$omp threadprivate(slope_of_financial_internal)

        !$omp threadprivate(flow_utility_internal)
        !$omp threadprivate(future_utility_internal)
        !$omp threadprivate(future_bequest_internal)
        !$omp threadprivate(future_leisure_internal)
        !$omp threadprivate(val_fun_internal)
        !$omp threadprivate(space_lived_in_internal)
        !$omp threadprivate(financial_internal)
        !$omp threadprivate(fin_index_frac_mov_to)
        !$omp threadprivate(frac_mov_to_another_cell_1)
        
        !$omp threadprivate(max_mortgage_payments_as_fraction_of_income)
        !$omp threadprivate(pay_mortgage_insurance)
        
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses)
        
        !$omp threadprivate(value_function_owner)
        !$omp threadprivate(optimal_owner_indeces)
        !$omp threadprivate(optimal_consumption_owner)
        !$omp threadprivate(optimal_space_lived_in_owner)
        !$omp threadprivate(optimal_gross_wage_income_owner)
        !$omp threadprivate(optimal_cutoff_taxable_income_owner)
        !$omp threadprivate(optimal_wage_income_tax_paid_owner)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_owner)
        !$omp threadprivate(optimal_mortgage_deductions_owner)
        !$omp threadprivate(optimal_household_can_consume_owner)
        !$omp threadprivate(optimal_labor_supply_owner)
        !$omp threadprivate(optimal_frac_spent_on_addiction_owner)
        !$omp threadprivate(optimal_total_consumption_owner)
        !$omp threadprivate(optimal_addiction_status_owner)
                            
        !$omp threadprivate(value_function_renter)
        !$omp threadprivate(optimal_renter_indeces)
        !$omp threadprivate(optimal_consumption_renter)
        !$omp threadprivate(optimal_space_lived_in_renter)
        !$omp threadprivate(optimal_gross_wage_income_renter)
        !$omp threadprivate(optimal_cutoff_taxable_income_renter)
        !$omp threadprivate(optimal_wage_income_tax_paid_renter)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_renter)
        !$omp threadprivate(optimal_mortgage_deductions_renter)
        !$omp threadprivate(optimal_household_can_consume_renter)
        !$omp threadprivate(optimal_labor_supply_renter)
        !$omp threadprivate(optimal_frac_spent_on_addiction_renter)
        !$omp threadprivate(optimal_total_consumption_renter)        
        !$omp threadprivate(optimal_addiction_status_renter)
                        
        !$omp threadprivate(value_function_renter_renter)
        !$omp threadprivate(optimal_renter_renter_indeces)
        !$omp threadprivate(optimal_gross_wage_income_renter_renter)
        !$omp threadprivate(optimal_cutoff_taxable_income_renter_renter)
        !$omp threadprivate(optimal_wage_income_tax_paid_renter_renter)
        !$omp threadprivate(optimal_mortgage_deductions_renter_renter)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_renter_renter)
        !$omp threadprivate(optimal_consumption_renter_renter)
        !$omp threadprivate(optimal_space_lived_in_renter_renter)
        !$omp threadprivate(optimal_household_can_consume_renter_renter)
        !$omp threadprivate(optimal_labor_supply_renter_renter)
        !$omp threadprivate(optimal_frac_spent_on_addiction_renter_renter)
        !$omp threadprivate(optimal_total_consumption_renter_renter)
        !$omp threadprivate(optimal_addiction_status_renter_renter)

        !$omp threadprivate(value_function_renter_owner)
        !$omp threadprivate(optimal_renter_owner_indeces)
        !$omp threadprivate(optimal_gross_wage_income_renter_owner)
        !$omp threadprivate(optimal_cutoff_taxable_income_renter_owner)
        !$omp threadprivate(optimal_wage_income_tax_paid_renter_owner)
        !$omp threadprivate(optimal_mortgage_deductions_renter_owner)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_renter_owner)
        !$omp threadprivate(optimal_consumption_renter_owner)
        !$omp threadprivate(optimal_space_lived_in_renter_owner)
        !$omp threadprivate(optimal_household_can_consume_renter_owner)
        !$omp threadprivate(optimal_labor_supply_renter_owner)
        !$omp threadprivate(optimal_frac_spent_on_addiction_renter_owner)
        !$omp threadprivate(optimal_total_consumption_renter_owner)
        !$omp threadprivate(optimal_addiction_status_renter_owner)
        
        !$omp threadprivate(value_function_owner_renter)
        !$omp threadprivate(optimal_owner_renter_indeces)
        !$omp threadprivate(optimal_gross_wage_income_owner_renter)
        !$omp threadprivate(optimal_cutoff_taxable_income_owner_renter)
        !$omp threadprivate(optimal_wage_income_tax_paid_owner_renter)
        !$omp threadprivate(optimal_mortgage_deductions_owner_renter)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_owner_renter)
        !$omp threadprivate(optimal_after_tax_wealth_owner_renter)
        !$omp threadprivate(optimal_consumption_owner_renter)
        !$omp threadprivate(optimal_space_lived_in_owner_renter)
        !$omp threadprivate(optimal_household_can_consume_owner_renter)
        !$omp threadprivate(optimal_labor_supply_owner_renter)
        !$omp threadprivate(optimal_frac_spent_on_addiction_owner_renter)
        !$omp threadprivate(optimal_total_consumption_owner_renter)
        !$omp threadprivate(optimal_addiction_status_owner_renter)
                    
        !$omp threadprivate(value_function_owner_owner_move)
        !$omp threadprivate(optimal_owner_owner_move_indeces)
        !$omp threadprivate(optimal_gross_wage_income_owner_owner_move)
        !$omp threadprivate(optimal_cutoff_taxable_income_owner_owner_move)
        !$omp threadprivate(optimal_wage_income_tax_paid_owner_owner_move)
        !$omp threadprivate(optimal_mortgage_deductions_owner_owner_move)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_owner_owner_move)
        !$omp threadprivate(optimal_consumption_owner_owner_move)
        !$omp threadprivate(optimal_space_lived_in_owner_owner_move)
        !$omp threadprivate(optimal_household_can_consume_owner_owner_move)
        !$omp threadprivate(optimal_labor_supply_owner_owner_move)
        !$omp threadprivate(optimal_frac_spent_on_addiction_owner_owner_move)
        !$omp threadprivate(optimal_total_consumption_owner_owner_move)
        !$omp threadprivate(optimal_addiction_status_owner_owner_move)
        
        !$omp threadprivate(value_function_owner_owner_stay)
        !$omp threadprivate(optimal_owner_owner_stay_indeces)
        !$omp threadprivate(optimal_gross_wage_income_owner_owner_stay)
        !$omp threadprivate(optimal_cutoff_taxable_income_owner_owner_stay)
        !$omp threadprivate(optimal_wage_income_tax_paid_owner_owner_stay)
        !$omp threadprivate(optimal_mortgage_deductions_owner_owner_stay)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_owner_owner_stay)
        !$omp threadprivate(optimal_consumption_owner_owner_stay)
        !$omp threadprivate(optimal_space_lived_in_owner_owner_stay)
        !$omp threadprivate(optimal_household_can_consume_owner_owner_stay)
        !$omp threadprivate(optimal_labor_supply_owner_owner_stay)
        !$omp threadprivate(optimal_frac_spent_on_addiction_owner_owner_stay)
        !$omp threadprivate(optimal_total_consumption_owner_owner_stay)
        !$omp threadprivate(optimal_addiction_status_owner_owner_stay)
        
        !$omp threadprivate(choose_to_own)
        !$omp threadprivate(track_housing_2)

	end module Global_Vars
    
    program main_program

        use Global_Vars
        
        use omp_lib
        
        implicit none
        
        fraction_to_repay=0
        
        do i=1,mortgage_amortization
        
            fraction_to_repay=fraction_to_repay+(1/(1+risk_free_rate_data+mortgage_interest_gap)**(i))
        
        end do
        
        fraction_to_repay=(1/fraction_to_repay)-(risk_free_rate_data+mortgage_interest_gap)
        
        prepayment_penalty_starts_from=0.15*(1+fraction_to_repay+risk_free_rate_data+mortgage_interest_gap)+fraction_to_repay
                                                
        if (is_counterfactual==1) then
            
            large_negative_num=-1.7976931348623157E+10 !-HUGE(a_real_number)
            
        else
        
            large_negative_num=-1.7976931348623157E+10
            
        end if
                        
        write(*,*) "large_negative_num=", large_negative_num
        
        simulation_ended=1
        already_uploaded_benchmark=0
        
        call set_files_names()
                                     
        if (is_counterfactual==0) then
                                    
            call calibrating_model()
                
            call write_outputs(1)
                
        elseif ((is_counterfactual==1) .AND. (solve_transition_dynamics==0)) then
        
            call long_run_counter_factual()
            
            call write_outputs(transition_length)
                        
        elseif ((is_counterfactual==1) .AND. (solve_transition_dynamics==1)) then
        
            call transition_simulation()
            
            call write_outputs(1)
                        
        end if
        
        call cleanup_matrix()
                                
    end program main_program
    
    subroutine set_files_names()
    
        use Global_Vars
        
        implicit none
                                                                    
        if (is_counterfactual==0) then
                
            file_number='baseline_benchmark'
            old_results=file_number
            benchmark_simulation=file_number
            long_run_simulation=file_number
            old_transition_resuls=file_number
            
        else
                                    
            ! universal plus treatment first
            if ((probability_of_voucher_benchmark_used==1) .AND. &
               (increased_prob_of_voucher_if_homeless_and_addicted==0)) then
               
                file_number='counter_VTE_TF'
               
                if (compare_to_original_benchmark==1) then
                
                    old_results='baseline_benchmark'
               
                else
               
                    old_results='counter_VTE_HF'
                    
                end if
                                               
            ! universal plus HF
            elseif ((probability_of_voucher_benchmark_used==1) .AND. &
                    (increased_prob_of_voucher_if_homeless_and_addicted==1)) then
                    
                file_number='counter_VTE_HF'
                old_results='baseline_benchmark'  
                
            elseif ((probability_of_voucher_benchmark_used<1) .AND. &
                    (increased_prob_of_voucher_if_homeless_and_addicted==0)) then
                    
                file_number='counter_TF'
                old_results='baseline_benchmark'  
            
            end if
            
            if (partial_equilibrium==1) then
                        
                file_number=trim(file_number)//'_PE'
                
                if (how_many_iterations_to_do_on_distribution==1) then
                
                    file_number=trim(file_number)//'_1_period'
                
                elseif (how_many_iterations_to_do_on_distribution==5) then
                
                    file_number=trim(file_number)//'_5_periods'
                
                elseif (how_many_iterations_to_do_on_distribution==100) then
                
                    file_number=trim(file_number)//'_100_periods'
                
                end if
            
            end if
                
            benchmark_simulation=old_results
            long_run_simulation=old_results
            old_transition_resuls=old_results
                        
        end if
            
    end subroutine
    
    subroutine calculate_income(unemployment_index_1,employment_index_1,&
        income_1,avg_income_to_use_1,avg_income_to_use_2,labor_supply_1,in_retirement_1)
    
        use global_vars
        
        implicit none
        
        real(8), intent(inout) :: income_1
        real(8), intent(in) :: avg_income_to_use_1,avg_income_to_use_2,labor_supply_1
        integer, intent(in) :: employment_index_1,in_retirement_1,unemployment_index_1
        
        income_1=0
        
        if (in_retirement_1==1) then
        
            if (unemployment_index_1<=threshold_addiction_index) then
            
                income_1=model_ss_benefits(employment_index_1)
        
            elseif (unemployment_index_1==threshold_addiction_index+1) then
                            
                income_1=model_ss_benefits(employment_index_1)
                
            elseif (unemployment_index_1==threshold_addiction_index+2) then
            
                income_1=(1-ss_decrease_for_retired_addicted)*model_ss_benefits(employment_index_1)+&
                    ss_decrease_for_retired_addicted*model_ss_benefits(employment_index_1)*(1-ss_decrease_addicted(1))
                
            elseif ((unemployment_index_1==unemployment_grid_size) .AND. (include_addiction==1)) then
            
                income_1=(1-ss_decrease_for_retired_addicted)*model_ss_benefits(employment_index_1)+&
                    ss_decrease_for_retired_addicted*model_ss_benefits(employment_index_1)*(1-ss_decrease_addicted(2))
                
            end if
            
        else
        
            if ((unemployment_index_1==1) .OR. (unemployment_index_1==threshold_addiction_index+1)) then
                        
                income_1=labor_supply_1*&
                    employment_grid(age_index,employment_index_1)*&
                    labour_deterministic_efficiency(age_index)
                    
            elseif ((unemployment_index_1==threshold_addiction_index) .OR. &
                (unemployment_index_1==unemployment_grid_size)) then
            
                income_1=min(replacement_rate_ui*avg_income_to_use_2,&
                    max_ui_as_perc_of_avg_inc*avg_income_to_use_1)
            
            end if                             
                                    
        end if
        
    end subroutine
    
    subroutine calculate_cdf_of_incomes_earned(time_period,age_index_1)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period,age_index_1
        integer :: time_period_used,financial_index,location,previous_index,has_house
        integer, dimension(1) :: min_income_earned_index,quintile
        real(8) :: total_income,sum_of_distribution_1,sum_of_distribution_2,size_of_quintile=real(1)/real(number_of_quintiles)
        real(8) :: labor_supply_used,avg_income_to_use_1,avg_income_to_use_2,bequest_2,income_taxes_paid_1,&
            financial_income_1,home_equity_1
        
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                   
        sum_of_distribution_2=0
        
        do i=1,2
        
            sum_of_distribution_2=sum_of_distribution_2+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,1:age_index_1,:,:,:,:,:))
                
        end do
        
        sum_of_distribution_1=0
        
        time_period_used=time_period-solve_transition_dynamics
        
        model_mass_of_households_by_income_earned(time_period,:)=0
        model_incomes_earned(time_period,:)=-1
        
        i=1
        
!        write(*,*) "size_of_quintile=", size_of_quintile
        write(*,*) "computing incomes for cdf"
                              
        ages_loop_1: do age_index=1,(1-include_retirees_in_income_cdf)*&
            (life_span-retirement_span)+include_retirees_in_income_cdf*age_index_1
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                        
            do years_left_on_mortgage_index=1,max_amortization_years
            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                                                                
                do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                
                    do unemployment_index=1,unemployment_grid_size
                                                                       
                        do employment_index=1,employment_grid_size
                        
                            if (inheritance_function_of_productivity==1) then
                        
                                bequest_2=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
                                
                            else
                        
                                call calculate_bequest_amount(age_index,bequest_2,employment_index)
                                
                            end if
                        
                            avg_income_to_use_2=&
                                is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                                (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                
                            do voucher_index=0,(1-has_house)*include_vouchers
                            
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_index-1
                            
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    income_taxes_paid_1=policy_function_wage_income_tax_paid(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    home_equity_1=max(years_left_on_mortgage_index-1,0)*housing_price(time_period)*&
                                        housing_size(housing_status_index)*(1+min(financial_grid(financial_index),0.d0))
                                    
                                    call calculate_income(unemployment_index,employment_index,total_income,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                                                                        
                                    financial_income_1=risk_free_rate(time_period)*&
                                        max(financial_grid(financial_index),0.d0)
                                                                                        
                                    total_income=total_income+bequest_2
                                                                            
                                    if (use_income_or_income_plus_assets==2) then
                                    
                                        total_income=total_income+financial_income_1+max(financial_grid(financial_index),0.d0)
                                        
                                    elseif (use_income_or_income_plus_assets<=4) then
                                    
                                        total_income=total_income+financial_income_1
!                                            +&
!                                            max(financial_grid(financial_index),0.d0)
!                                            -income_taxes_paid_1-financial_income_1*investment_income_tax
                                                                                
                                    end if
                                    
                                    if (use_income_or_income_plus_assets==4) then
                                    
                                        total_income=total_income+home_equity_1
                                        
                                    end if
                                                                             
                                    if (i==1) then
                                        
                                        location=i
                                        
                                    else
                                    
                                        location=-1    
                                            
                                    end if
                                                
                                    do j=1,i
                                        
                                        if (abs(model_incomes_earned(time_period,j)-total_income)<10.d0**(-6)) then
                                                
                                            location=j
                                                
                                        end if
                                            
                                    end do
                                    
                                    sum_of_distribution_1=sum_of_distribution_1+&
                                        distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                            
                                    sum_of_distribution=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    if (sum_of_distribution>0) then
                                                                            
                                        if (i==1) then
                                                                                                                        
                                            model_mass_of_households_by_income_earned(time_period,location)=&
                                                model_mass_of_households_by_income_earned(time_period,location)+&
                                                sum_of_distribution
                                                    
                                            model_incomes_earned(time_period,location)=total_income
                                                
                                            i=i+1
                                            
                                        elseif ((i>1) .AND. (location==-1)) then
                                                
                                            model_mass_of_households_by_income_earned(time_period,i+1)=&
                                                model_mass_of_households_by_income_earned(time_period,i+1)+&
                                                sum_of_distribution
                                                    
                                            model_incomes_earned(time_period,i+1)=total_income
                                                
                                            i=i+1
                                            
                                        elseif ((i>1) .AND. (location>-1)) then
                                        
                                            model_mass_of_households_by_income_earned(time_period,location)=&
                                                model_mass_of_households_by_income_earned(time_period,location)+&
                                                sum_of_distribution
                                            
                                        end if
                                        
                                        if (sum_of_distribution_1==sum_of_distribution_2) then
                                        
                                            exit ages_loop_1
                                            
                                        end if
                                        
                                    end if
                                    
                                end do
                                    
                            end do
                            
                        end do
                                                                                         
                    end do
                    
                end do
                
            end do
            
        end do ages_loop_1
        
        model_incomes_earned_saved(time_period,:)=model_incomes_earned(time_period,:)
        
        model_cdf_of_income_earned(time_period,:)=0
        
        i=1
        previous_index=1
        
        quintile=1
        mass_of_quintile(:)=0
        
        sum_of_distribution_1=0
                        
        do k=1,2
        
            sum_of_distribution_1=sum_of_distribution_1+&
                sum(distribution_stationary(k)%vector_transition_real(time_period_used,1:&
                (include_retirees_in_income_cdf*age_index_1+&
                (1-include_retirees_in_income_cdf)*(life_span-retirement_span)),:,:,:,:,:))
                
        end do
        
        write(*,*) "computing incomes at each quintile"
        
        do while (i<=(age_index_1*financial_grid_size*unemployment_grid_size*employment_grid_size*years_left_on_mortgage_index))
                        
            min_income_earned_index=minloc(model_incomes_earned(time_period,:),mask=model_incomes_earned(time_period,:)>=0)
                
            if (min_income_earned_index(1)>0) then
            
                if (model_mass_of_households_by_income_earned(time_period,min_income_earned_index(1))>0)  then
                                                                                                    
                    model_cdf_of_income_earned(time_period,min_income_earned_index(1))=&
                        model_cdf_of_income_earned(time_period,previous_index)+&
                        model_mass_of_households_by_income_earned(time_period,min_income_earned_index(1))/sum_of_distribution_1
                                                            
                    if (sum(model_cdf_of_income_earned(time_period,:))>0) then
                    
                        mass_of_quintile(quintile)=mass_of_quintile(quintile)+&
                            model_mass_of_households_by_income_earned(time_period,min_income_earned_index(1))
                    
                        if (floor(model_cdf_of_income_earned(time_period,min_income_earned_index(1))/size_of_quintile)>&
                            floor(model_cdf_of_income_earned(time_period,previous_index)/size_of_quintile) .AND. &
                            (model_cdf_of_income_earned(time_period,previous_index)<0.999)) then
                                            
                            income_cutoffs_of_quintiles(quintile)=model_incomes_earned(time_period,min_income_earned_index(1))
                            
                            quintile=quintile+1
                                                    
                        end if
                                                
                    end if
                                    
                    previous_index=min_income_earned_index(1)
                    
                end if
                
                if (model_cdf_of_income_earned(time_period,min_income_earned_index(1))>=0.9999) then
            
                    i=age_index_1*financial_grid_size*unemployment_grid_size*&
                        employment_grid_size*years_left_on_mortgage_index+1
                
                end if
                
                model_incomes_earned(time_period,min_income_earned_index(1))=-1
                                    
            end if
                    
            i=i+1
                                                        
        end do
                 
        model_incomes_earned(time_period,:)=model_incomes_earned_saved(time_period,:)
                
!        write(*,*) "sum(model_mass_of_households_by_income_earned(time_period,:)=", &
!            sum(model_mass_of_households_by_income_earned(time_period,:))
                
        do i=1,number_of_quintiles
            
            write(*,*) "mass_of_quintile(i)=", mass_of_quintile(i)
            
        end do
        
!        write(*,*) "sum(mass_of_quintile)=", sum(mass_of_quintile(:))
                    
    end subroutine
               
    subroutine stationary_equilibrium_statistics(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period,pay_mortgage_insurance_1,has_house,low_quality_market,is_homeless_1,&
            is_addicted_1,time_period_used,housing_status_index_used,financial_index_used,amortization_used,fin_frac_used,&
            is_using_drugs
        real(8) :: total_income,lived_in_size_used,labor_supply_used,value_function_used,&
            distribution_mass_used,frac_used,rent_to_income,income_to_avg_income,total_renters_to_consider,&
            bequest_1,bequest_2,housing_to_income_owners,housing_to_income_all,mortgage_to_income_owners,&
            housing_to_income_renters,total_owners_to_consider,LTV_1,avg_income_to_use_1,avg_income_to_use_2,&
            total_homeless_1,assets_1,food_stamps_1,avg_net_wealth_to_use_1,MU_1,consumption_used,addiction_consumption_1,&
            total_consumption_used,net_wealth_1,model_average_income_previous,model_average_income_plus_assets_previous,&
            model_average_income_plus_all_assets_previous
            
        integer, dimension(1) :: rent_to_income_index,LTV_index,median_index,income_to_avg_income_wide_index
                
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
            
        avg_net_wealth_to_use_1=is_counterfactual*average_net_wealth_calibrated+&
            (1-is_counterfactual)*model_average_net_wealth(time_period)
                                    
        time_period_used=time_period-solve_transition_dynamics
        
        rent_to_income_cdf(time_period,:)=0
                        
        income_to_avg_income_wide_pdf_1(time_period,:)=0
        
        median_income_cdf(time_period,:)=0
        rent_to_income_homeless_cdf(time_period,:)=0
        total_homeless_1=0
        LTV_cdf(time_period,:)=0
        total_renters_to_consider=0    
        total_owners_to_consider=0
        
        model_total_net_wealth(time_period)=0
        model_youngest_net_wealth_share(time_period)=0
        model_net_wealth_owners(time_period)=0
        model_net_wealth_renters(time_period)=0
        model_total_owners(time_period)=0
        model_total_renters(time_period)=0
        model_financial(time_period)=0
        model_mass_with_positive_financial(time_period)=0
        model_average_financial(time_period)=0
        model_financial_renters(time_period)=0
        model_output(time_period)=0
        model_total_income(time_period)=0
        model_total_efficiency_units(time_period)=0
        model_labor_supply(time_period)=0
        model_fraction_choose_zero_work(time_period)=0
        model_fraction_choose_little_work(time_period)=0
        model_mass_can_work(time_period)=0
        model_total_hours(time_period)=0
        model_net_housing_wealth(time_period)=0
        model_gross_housing_wealth(time_period)=0
        model_mortgages(time_period)=0
        model_bequests(time_period)=0
        model_total_inheritance(time_period)=0
        value_of_bequests_by_age(:)=0
        bequests_mass_by_age(:)=0
        model_youngest_assets(time_period)=0
        model_financial_bequests(time_period)=0
        model_fraction_leaving_bequests(time_period)=0
        model_fraction_leaving_housing_bequests(time_period)=0
        mass_dying(time_period)=0
        total_renters_income(time_period)=0
        mass_of_owners(time_period)=0
        mass_of_legit_renters(time_period)=0
        model_avg_rent_to_income_ratio(time_period)=0
        model_avg_mortgage_spending(time_period)=0
        model_avg_housing_spending_owners(time_period)=0
        model_avg_housing_spending_all(time_period)=0
        model_avg_housing_spending_renters(time_period)=0
        model_mass_renters_to_consider(time_period)=0
        model_fraction_homeless(time_period)=0
        model_homeless_2_years_or_more(time_period)=0
        profile_of_chronic_homeless(time_period,:)=0
        mass_profile_of_chornic_homeless(time_period,:)=0        
        model_homelessness_old(time_period)=0
        model_profile_of_homeless_old(:)=0
        model_addiction_by_employment(:)=0
        model_fraction_homeless_owners(time_period)=0
        model_fraction_of_homeless_unemployed(time_period)=0
        model_fraction_addicted_who_are_homeless(time_period)=0
        model_fraction_of_unemployed_homeless(time_period)=0
        model_fraction_of_homeless_and_addicted_unemployed(time_period)=0
        model_fraction_unemployed(time_period)=0
        model_fraction_unemployed_on_ui(time_period)=0
        model_sum_of_lowest_productivities(time_period)=0
        model_median_assets_to_income(:)=0
        
        model_fraction_addicted(time_period)=0
        model_fraction_addicted_and_unemployed(time_period)=0
        model_fraction_homeless_and_addicted(time_period)=0
        
        model_value_of_life(time_period)=0
        model_fraction_with_negative_value_of_life(time_period)=0
        model_fraction_homeless_with_negative_value_of_life(time_period)=0
        model_fraction_addicted_with_negative_value_of_life(time_period)=0
        model_largest_negative_value_of_life(time_period)=10000000
        
        profile_by_income_to_avg_income_wide_1(time_period,:,:,:)=0
        mass_at_profile_income_to_avg_income_wide_1(time_period,:,:)=0
                
        do i=1,number_of_grids_rent_to_income_cdf
        
            rent_to_income_ratios(time_period,i)=(real(i)-real(1))/real(100)
                    
        end do
                
        do i=1,number_of_wide_grids_income_to_avg_income_cdf
        
            income_to_avg_income_wide_ratios(time_period,i)=(real(i)*40)/real(100)
                    
        end do
        
        do i=1,101
        
            LTV_ratios(time_period,i)=(real(i)-real(1))/real(100)
            
        end do
        
        model_total_workers(time_period)=0
        
        model_average_income_previous=model_average_income(time_period)
        model_average_income_plus_assets_previous=model_average_income_plus_assets(time_period)
        model_average_income_plus_all_assets_previous=model_average_income_plus_all_assets(time_period)
                
        model_average_labour_income(time_period)=0
        model_average_income(time_period)=0
        model_average_income_plus_assets(time_period)=0
        model_average_income_plus_all_assets(time_period)=0
        model_average_ss_benefits(time_period)=0
        
        model_average_labour_income_by_employment(time_period,:)=0
        mass_by_employment(time_period,:)=0
        
        total_rent_paid(time_period)=0
        total_imputed_rents(time_period)=0        
          
        average_rent_by_age=0
        mass_of_renters_by_age=0
        
        sum_of_distribution_not_be_homeless=0
                             
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                                    
            if (age_index==1) then
            
                newborn_household=1
                
            else
            
                newborn_household=0
            
            end if
                    
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                                                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        if (inheritance_function_of_productivity==1) then
                        
                            bequest_2=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
                            
                        else
                    
                            call calculate_bequest_amount(age_index,bequest_2,employment_index)
                            
                        end if
                    
                        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                        
                        do voucher_index=0,(1-has_house)*include_vouchers
                            
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                                                            
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                    
                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    financial_index_used=policy_function_financial_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                            
                                    amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    frac_used=frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    fin_frac_used=fin_index_frac_mov_to_optimal(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    if ((labor_supply_used>1) .OR. (labor_supply_used<0)) then
                                    
                                        write(*,*) "weird"
                                        
                                    end if
                                        
                                    consumption_used=policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    total_consumption_used=policy_function_total_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    addiction_used=policy_function_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    addiction_consumption_1=addiction_used*&
                                        max(total_consumption_used-consumption_used,0.d0)
                                        
                                    value_function_used=value_function(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    assets_1=2*threshold_for_food_stamps_as_perc_of_average_net_wealth*&
                                        avg_net_wealth_to_use_1
                                        
                                    if (unemployment_index>threshold_addiction_index) then
                                        
                                        model_addiction_by_employment(employment_index)=&
                                            model_addiction_by_employment(employment_index)+distribution_mass_used
                                            
                                    end if
                                    
                                    ! This one is a homeowner who chooses to rent
                                    if ((years_left_on_mortgage_index>1) .AND. (amortization_used==1)) then

                                        assets_1=max(housing_price(time_period)*housing_size(housing_status_index)*&
                                            (1-cost_of_selling-property_tax(time_period)-&
                                            housing_depreciation_rate+min(financial_grid(financial_index),0.d0)*&
                                            (1+mortgage_interest_rate(time_period)))+&
                                            max(financial_grid(financial_index),0.d0),0.d0)
                                
                                    ! This one is a renter who stays renting
                                    elseif ((years_left_on_mortgage_index==1) .AND. (amortization_used==1)) then
                                    
                                        assets_1=max(financial_grid(financial_index),0.d0)

                                    end if
                                    
                                    food_stamps_1=0
                                    
                                    ! If they have no assets, they get can qualift for food stamps
                                    if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*&
                                        avg_net_wealth_to_use_1) then
                                        
                                        call calculate_income(unemployment_index,employment_index,total_income,&
                                            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                        
                                        food_stamps_1=max((max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                                            (total_income+max(financial_grid(financial_index),0.d0)*&
                                            risk_free_rate(time_period))),0.d0)
                                                                    
                                    end if
                                    
                                    if (in_retirement==1) then
                                    
                                        model_average_ss_benefits(time_period)=&
                                            model_average_ss_benefits(time_period)+&
                                            total_income*distribution_mass_used
                                    
                                    end if
                                    
                                    if (age_index==1) then
                                    
                                        call calculate_marginal_non_housing_utility&
                                            (consumption_used,lived_in_size_used,addiction_used,addiction_consumption_1,MU_1)
                                            
                                        if (distribution_mass_used>0) then
                                                                    
                                            model_value_of_life(time_period)=model_value_of_life(time_period)+&
                                                (value_function_used/MU_1)*distribution_mass_used
                                                
                                        end if
                                    
                                    end if
                                    
                                    if ((value_function_used<model_largest_negative_value_of_life(time_period)) .AND. &
                                        (distribution_mass_used>0)) then
                                            
                                        model_largest_negative_value_of_life(time_period)=value_function_used
                                        
                                    end if
                                    
                                    if (value_function_used<0) then
                                                                    
                                        model_fraction_with_negative_value_of_life(time_period)=&
                                            model_fraction_with_negative_value_of_life(time_period)+distribution_mass_used
                                            
                                        if (housing_status_index_used==lowest_housing_grid_point) then
                                        
                                            model_fraction_homeless_with_negative_value_of_life(time_period)=&
                                                model_fraction_homeless_with_negative_value_of_life(time_period)+&
                                                distribution_mass_used
                                                
                                        end if
                                        
                                        if (unemployment_index>threshold_addiction_index) then
                                        
                                            model_fraction_addicted_with_negative_value_of_life(time_period)=&
                                                model_fraction_addicted_with_negative_value_of_life(time_period)+&
                                                distribution_mass_used
                                        
                                        end if
                                            
                                    end if
                                                                                                   
                                    if ((in_retirement==0) .AND.&
                                        ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1))) then
                                                            
                                        model_output(time_period)=model_output(time_period)+&
                                            (labor_supply_used*employment_grid(age_index,employment_index)*&
                                            labour_deterministic_efficiency(age_index))*distribution_mass_used
                                            
                                        model_total_efficiency_units(time_period)=model_total_efficiency_units(time_period)+&
                                            (labor_supply_used*employment_grid(age_index,employment_index)*&
                                            labour_deterministic_efficiency(age_index))*distribution_mass_used
                                                                                        
                                        model_labor_supply(time_period)=model_labor_supply(time_period)+&
                                            labor_supply_used*distribution_mass_used
                                            
                                        model_total_hours(time_period)=model_total_hours(time_period)+&
                                            max_labor_supply*distribution_mass_used
                                            
                                        model_mass_can_work(time_period)=model_mass_can_work(time_period)+distribution_mass_used
                                        
                                        if (labor_supply_used<=10.d0**(-7)) then
                                        
                                            model_fraction_choose_zero_work(time_period)=&
                                                model_fraction_choose_zero_work(time_period)+distribution_mass_used
                                                
                                        elseif (labor_supply_used<=0.5*0.4) then
                                        
                                            model_fraction_choose_little_work(time_period)=&
                                                model_fraction_choose_little_work(time_period)+distribution_mass_used
                                                
                                        end if
                                                                                                                    
                                    end if
                                    
                                    if ((unemployment_index==2) .OR. (unemployment_index==threshold_addiction_index) .OR. &
                                       (unemployment_index==threshold_addiction_index+2) .OR. &
                                       (unemployment_index==unemployment_grid_size)) then
                                    
                                        model_fraction_unemployed(time_period)=&
                                            model_fraction_unemployed(time_period)+distribution_mass_used
                                            
                                        if ((unemployment_index==threshold_addiction_index) .OR. &
                                            (unemployment_index==unemployment_grid_size)) then
                                        
                                            model_fraction_unemployed_on_ui(time_period)=&
                                                model_fraction_unemployed_on_ui(time_period)+distribution_mass_used
                                                
                                        end if
                                        
                                        if (housing_status_index_used==lowest_housing_grid_point) then
                                        
                                            model_fraction_of_homeless_unemployed(time_period)=&
                                                model_fraction_of_homeless_unemployed(time_period)+&
                                                distribution_mass_used
                                                                                            
                                            model_fraction_of_unemployed_homeless(time_period)=&
                                                model_fraction_of_unemployed_homeless(time_period)+&
                                                distribution_mass_used
                                                
                                        end if
                                    
                                    end if
                                    
                                    if (unemployment_index>threshold_addiction_index) then
                                    
                                        model_fraction_addicted(time_period)=&
                                            model_fraction_addicted(time_period)+distribution_mass_used
                                                                                        
                                        if (unemployment_index>threshold_addiction_index+1) then
                                        
                                            model_fraction_addicted_and_unemployed(time_period)=&
                                                model_fraction_addicted_and_unemployed(time_period)+distribution_mass_used
                                                
                                        end if
                                            
                                        if (housing_status_index_used==lowest_housing_grid_point) then
                                        
                                            model_fraction_addicted_who_are_homeless(time_period)=&
                                                model_fraction_addicted_who_are_homeless(time_period)+distribution_mass_used
                                        
                                            model_fraction_homeless_and_addicted(time_period)=&
                                                model_fraction_homeless_and_addicted(time_period)+distribution_mass_used
                                        
                                            if (unemployment_index>threshold_addiction_index+1) then
                                        
                                                model_fraction_of_homeless_and_addicted_unemployed(time_period)=&
                                                    model_fraction_of_homeless_and_addicted_unemployed(time_period)+&
                                                    distribution_mass_used
                                                    
                                            end if
                                        
                                        end if
                                            
                                    end if
                                    
                                    if ((housing_status_index==lowest_housing_grid_point) .AND. &
                                        (housing_status_index_used==lowest_housing_grid_point)) then
                                        
                                        model_homeless_2_years_or_more(time_period)=&
                                            model_homeless_2_years_or_more(time_period)+distribution_mass_used
                                            
                                        profile_of_chronic_homeless(time_period,1)=&
                                            profile_of_chronic_homeless(time_period,1)+&
                                            age_index*distribution_mass_used
                                            
                                        if ((unemployment_index==1) .OR. &
                                            (unemployment_index==threshold_addiction_index+1)) then
                                            
                                        else
                                            
                                            profile_of_chronic_homeless(time_period,2)=&
                                                profile_of_chronic_homeless(time_period,2)+&
                                                distribution_mass_used
                                                
                                        end if
                                        
                                        if ((unemployment_index==1) .OR. (unemployment_index==3) .OR. &
                                            (unemployment_index==threshold_addiction_index+1) .OR. &
                                            (unemployment_index==threshold_addiction_index+3)) then
                                            
                                        else
                                            
                                            profile_of_chronic_homeless(time_period,3)=&
                                                profile_of_chronic_homeless(time_period,3)+&
                                                distribution_mass_used
                                                
                                        end if
                                            
                                        if (unemployment_index>threshold_addiction_index) then
                                            
                                            profile_of_chronic_homeless(time_period,4)=&
                                                profile_of_chronic_homeless(time_period,4)+&
                                                distribution_mass_used
                                            
                                        end if
                                                                                
                                        mass_profile_of_chornic_homeless(time_period,:)=&
                                            mass_profile_of_chornic_homeless(time_period,:)+distribution_mass_used
                                        
                                    end if
                                    
                                    if (housing_status_index_used==lowest_housing_grid_point) then
                                    
                                        model_fraction_homeless(time_period)=&
                                            model_fraction_homeless(time_period)+distribution_mass_used
                                            
                                        if (age_index>life_span-retirement_span) then
                                        
                                            call calculate_income(unemployment_index,employment_index,total_income,&
                                                avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                                
                                            total_income=total_income+risk_free_rate(time_period)*&
                                               max(financial_grid(financial_index),0.d0)
                                        
                                            model_homelessness_old(time_period)=&
                                                model_homelessness_old(time_period)+distribution_mass_used
                                                
                                            model_profile_of_homeless_old(1)=model_profile_of_homeless_old(1)+&
                                                age_index*distribution_mass_used
                                                
                                            if (total_income<0.1) then
                                            
!                                                write(*,*) "total_income=", total_income
                                                
                                            end if
                                                
                                            model_profile_of_homeless_old(2)=model_profile_of_homeless_old(2)+&
                                                total_income*distribution_mass_used
                                                
                                            model_profile_of_homeless_old(3)=model_profile_of_homeless_old(3)+&
                                                max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                        
                                        end if
                                            
                                    end if
                                    
                                    sum_of_distribution_not_be_homeless=sum_of_distribution_not_be_homeless+&
                                        distribution_mass_used
                                                                        
                                    model_sum_of_lowest_productivities(time_period)=&
                                        model_sum_of_lowest_productivities(time_period)+distribution_mass_used
                                                                    
                                    mortgage_to_income_owners=0
                                    housing_to_income_owners=0
                                    housing_to_income_all=0
                                    housing_to_income_renters=0
                                    pay_mortgage_insurance_1=0
                                    
                                    call calculate_income(unemployment_index,employment_index,total_income,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                        
                                    total_income=total_income+risk_free_rate(time_period)*&
                                        max(financial_grid(financial_index),0.d0) !+food_stamps_1
                                                                            
                                    rent_to_income=(model_average_rent(time_period)*&
                                        model_average_rental_unit_size(time_period))/total_income
                                    
                                     if (rent_to_income<=max_rent_to_income) then
                                        
                                        rent_to_income_index=minloc(rent_to_income_ratios(time_period,:),1,&
                                            mask=rent_to_income_ratios(time_period,:)-rent_to_income>=0)
                                                                                                                                                               
                                    else
                                    
                                        rent_to_income_index(1)=number_of_grids_rent_to_income_cdf
                                                                                
                                    end if
                                    
                                    if (use_income_or_income_plus_assets==1) then
                                    
                                        income_to_avg_income=(total_income+bequest_2)/model_average_income_previous
                                        
                                    elseif (use_income_or_income_plus_assets==2) then
                                    
                                        income_to_avg_income=(total_income+bequest_2+&
                                            max(financial_grid(financial_index),0.d0))/&
                                            model_average_income_plus_assets_previous
                                            
                                    elseif (use_income_or_income_plus_assets==3) then
                                    
                                        if ((amortization_used==1) .AND. (years_left_on_mortgage_index==2)) then
                                        
                                            income_to_avg_income=(total_income+bequest_2+&
                                                max(financial_grid(financial_index),0.d0)+&
                                                housing_price(time_period)*housing_size(housing_status_index)*&
                                                (1+min(financial_grid(financial_index),0.d0)))/&
                                                model_average_income_plus_all_assets_previous
                                    
                                        else
                                    
                                            income_to_avg_income=(total_income+max(financial_grid(financial_index),0.d0))/&
                                                model_average_income_plus_all_assets_previous
                                                
                                        end if
                                    
                                    end if
                                    
                                    if (income_to_avg_income<=number_of_wide_grids_income_to_avg_income_cdf) then
                                                                                    
                                        income_to_avg_income_wide_index(1)=&
                                            max(minloc(income_to_avg_income_wide_ratios(time_period,:),1,&
                                            mask=income_to_avg_income_wide_ratios(time_period,:)-income_to_avg_income>=0),1)
                                                                                                                                                               
                                    else
                                    
                                        income_to_avg_income_wide_index(1)=number_of_wide_grids_income_to_avg_income_cdf
                                                                                
                                    end if
                                    
                                    if  (unemployment_index<=threshold_addiction_index) then
                                                                                                                   
                                        mass_at_profile_income_to_avg_income_wide_1&
                                            (time_period,2,income_to_avg_income_wide_index(1))=&
                                            mass_at_profile_income_to_avg_income_wide_1&
                                            (time_period,2,income_to_avg_income_wide_index(1))+&
                                            distribution_mass_used 

                                        is_using_drugs=0
                                    
                                        if (addiction_consumption_1>0) then
                                                                                                                         
                                            income_to_avg_income_wide_pdf_1(time_period,income_to_avg_income_wide_index(1))=&
                                                income_to_avg_income_wide_pdf_1(time_period,income_to_avg_income_wide_index(1))+&
                                                distribution_mass_used

                                            is_using_drugs=1
                                                
                                        end if

                                        mass_at_profile_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1))=&
                                            mass_at_profile_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1))+&
                                            distribution_mass_used                                        
                                        
                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),1)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),1)+&
                                            age_index*distribution_mass_used

                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),2)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),2)+&
                                            consumption_used*distribution_mass_used

                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),3)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),3)+&
                                            labor_supply_used*distribution_mass_used
                                            
                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),4)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),4)+&
                                            (total_income+bequest_2)*distribution_mass_used

                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),5)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),5)+&
                                            max(years_left_on_mortgage_index-1,0)*distribution_mass_used

                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),6)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),6)+&
                                            (max(financial_grid(financial_index),0.d0)+&
                                            max(years_left_on_mortgage_index-1,0)*housing_price(time_period)*&
                                            housing_size(housing_status_index)*&
                                            (1+min(financial_grid(financial_index),0.d0)))*&
                                            distribution_mass_used
                                            
                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),7)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),7)+&
                                            housing_size(housing_status_index)*&
                                            distribution_mass_used
                                            
                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),8)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),8)+&
                                            max(amortization_used-1,0)*distribution_mass_used
                                            
                                        profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),9)=&
                                            profile_by_income_to_avg_income_wide_1&
                                            (time_period,is_using_drugs,income_to_avg_income_wide_index(1),9)+&
                                            employment_index*distribution_mass_used
                                                                                               
                                    end if                                   
                                        
                                    median_income_cdf(time_period,rent_to_income_index(1))=&
                                        median_income_cdf(time_period,rent_to_income_index(1))+distribution_mass_used
                                        
                                    if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                       (have_two_rental_markets==0)) then
                                    
                                        low_quality_market=0
                                        
                                    else
                                    
                                        low_quality_market=1
                                    
                                    end if
                                                                                                                                            
                                    if ((amortization_used==1) .AND. &
                                        (housing_status_index_used>=second_lowest_housing_grid_point)) then 
                                                                                                            
                                        rent_to_income=(rent(time_period,low_quality_market)*lived_in_size_used)/total_income
                                        housing_to_income_all=rent_to_income
                                        housing_to_income_renters=rent_to_income
                                                                              
                                        if (rent_to_income<1) then
                                            
                                            mass_of_legit_renters(time_period)=&
                                                mass_of_legit_renters(time_period)+distribution_mass_used
                                                
                                            model_avg_rent_to_income_ratio(time_period)=&
                                                model_avg_rent_to_income_ratio(time_period)+rent_to_income*distribution_mass_used

                                        end if
                                        
                                        if (rent_to_income<=max_rent_to_income) then
                                        
                                            rent_to_income_index=minloc(rent_to_income_ratios(time_period,:),&
                                                mask=rent_to_income_ratios(time_period,:)-rent_to_income>=0)
                                                                                                                                                                   
                                        else
                                        
                                            rent_to_income_index(1)=number_of_grids_rent_to_income_cdf
                                                                                    
                                        end if
                                                                            
                                        if ((in_retirement==1) .AND. (include_retirees_in_income_cdf==1)) then
                                            
                                            rent_to_income_cdf(time_period,rent_to_income_index(1))=&
                                                rent_to_income_cdf(time_period,rent_to_income_index(1))+&
                                                distribution_mass_used
                                                
                                            total_renters_to_consider=total_renters_to_consider+distribution_mass_used
                                                                                    
                                        end if
                                        
                                        if (in_retirement==0) then
                                            
                                            rent_to_income_cdf(time_period,rent_to_income_index(1))=&
                                                rent_to_income_cdf(time_period,rent_to_income_index(1))+&
                                                distribution_mass_used
                                                
                                            total_renters_to_consider=total_renters_to_consider+distribution_mass_used
                                                
                                        end if
                                            
                                        total_renters_income(time_period)=&
                                            total_renters_income(time_period)+&
                                            total_income*distribution_mass_used
                                            
                                    elseif (housing_status_index_used==lowest_housing_grid_point) then
                                                                                                            
                                        rent_to_income=(model_average_rent(time_period)*&
                                            model_average_rental_unit_size(time_period))/total_income
                                                                    
                                        if (rent_to_income<=max_rent_to_income) then
                                        
                                            rent_to_income_index=minloc(rent_to_income_ratios(time_period,:),&
                                                mask=rent_to_income_ratios(time_period,:)-rent_to_income>=0)
                                                
                                        else
                                        
                                            rent_to_income_index(1)=number_of_grids_rent_to_income_cdf
                                                                                    
                                        end if
                                                                            
                                        total_homeless_1=total_homeless_1+distribution_mass_used
                                            
                                        rent_to_income_homeless_cdf(time_period,rent_to_income_index(1))=&
                                            rent_to_income_homeless_cdf(time_period,rent_to_income_index(1))+&
                                            distribution_mass_used
                                              
                                    end if
                                    
                                    is_homeless_1=1
                                    
                                    if (housing_status_index_used==lowest_housing_grid_point) then
                                    
                                        is_homeless_1=2
                                    
                                    end if
                                    
                                    is_addicted_1=0
                                    
                                    if (unemployment_index>threshold_addiction_index) then
                                    
                                        is_addicted_1=1
                                        
                                    end if
                                    
                                    if (amortization_used>1) then
                                    
                                        LTV_1=-min(financial_grid(financial_index),0.d0)
                                    
                                        if (LTV_1<=1) then
                                        
                                            LTV_index=minloc(LTV_ratios(time_period,:),mask=LTV_ratios(time_period,:)-LTV_1>=0)
                                                
                                        else
                                        
                                            LTV_index(1)=101
                                            
                                        end if
                                    
                                        LTV_cdf(time_period,LTV_Index(1))=LTV_cdf(time_period,LTV_Index(1))+distribution_mass_used
                                        total_owners_to_consider=total_owners_to_consider+distribution_mass_used
                                    
                                    end if
                                                                    
                                    if (housing_status_index_used>=second_lowest_housing_grid_point) then
                                    
                                        call calculate_income(unemployment_index,employment_index,total_income,&
                                            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                                                                          
                                        total_income=total_income+risk_free_rate(time_period)*&
                                            max(financial_grid(financial_index),0.d0)

                                        if (amortization_used>1) then
                                        
                                            housing_to_income_all=&
                                                housing_price(time_period)*housing_size(housing_status_index_used)*&
                                                ((-min(financial_grid(financial_index_used),0.d0))*&
                                                (pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                                mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid)+&
                                                (property_tax(time_period)+housing_depreciation_rate*&
                                                include_housing_depreciation_in_housing_costs))/total_income
                                                
                                            housing_to_income_owners=&
                                                housing_price(time_period)*housing_size(housing_status_index_used)*&
                                                (-financial_grid(min(financial_index_used,negative_financial_grid_size))*&
                                                (pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                                mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid)+&
                                                (property_tax(time_period)+housing_depreciation_rate*&
                                                include_housing_depreciation_in_housing_costs))/total_income
                                                
                                            mortgage_to_income_owners=&
                                                (-financial_grid(min(financial_index_used,negative_financial_grid_size))*&
                                                housing_price(time_period)*housing_size(housing_status_index_used)*&
                                                (pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                                mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))/&
                                                total_income
                                        
                                        end if
                                                                        
                                    else
                                    
                                        call calculate_income(unemployment_index,employment_index,total_income,&
                                            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                                                               
                                        total_income=total_income+&
                                            risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)
                                                                                                                                    
                                        if (-min(financial_grid(financial_index_used),0.d0)>(1-minimum_downpayment)) then
                                                                                    
                                            pay_mortgage_insurance_1=1
                                            max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio
                                    
                                        else
                                
                                            pay_mortgage_insurance_1=0
                                            max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio_below_80
                                    
                                        end if
                                            
                                        spending_on_housing=&
                                            (-financial_grid(min(financial_index_used,negative_financial_grid_size))*&
                                            housing_price(time_period)*housing_size(housing_status_index_used)*&
                                            (pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                            mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))+&
                                            housing_price(time_period-solve_transition_dynamics)*&
                                            housing_size(housing_status_index_used)*&
                                            (property_tax(time_period)+housing_depreciation_rate*&
                                            include_housing_depreciation_in_housing_costs)
                                                         
                                    end if
                                    
                                    model_financial(time_period)=model_financial(time_period)+&
                                        max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                        
                                    if (financial_grid(financial_index)>=0) then
                                    
                                        model_mass_with_positive_financial(time_period)=&
                                            model_mass_with_positive_financial(time_period)+distribution_mass_used
                                    
                                    end if
                                    
                                    net_wealth_1=(max(min(amortization_used-1,1),0)*&
                                        (housing_price(time_period)*housing_size(housing_status_index_used))+&
                                        min(financial_grid(financial_index_used),0.d0)*&
                                        housing_price(time_period)*housing_size(housing_status_index_used)+&
                                        max(financial_grid(financial_index),0.d0))
                                                                         
                                    model_total_net_wealth(time_period)=model_total_net_wealth(time_period)+&
                                        net_wealth_1*distribution_mass_used
                                        
                                    if (age_index<=youngest_ages_for_wealth_computation) then
                                    
                                        model_youngest_net_wealth_share(time_period)=&
                                            model_youngest_net_wealth_share(time_period)+&
                                            net_wealth_1*distribution_mass_used
                                            
                                    end if
                                        
                                    if (amortization_used>1) then
                                    
                                        model_net_wealth_owners(time_period)=model_net_wealth_owners(time_period)+&
                                            net_wealth_1*distribution_mass_used
                                        
                                        model_total_owners(time_period)=&
                                            model_total_owners(time_period)+distribution_mass_used
                                    
                                    else
                                    
                                        if (housing_status_index_used>lowest_housing_grid_point) then
                                    
                                            model_net_wealth_renters(time_period)=&
                                                model_net_wealth_renters(time_period)+&
                                                max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                
                                            model_total_renters(time_period)=&
                                                model_total_renters(time_period)+distribution_mass_used
                                                
                                        end if
                                    
                                    end if
                                                                        
                                    if (amortization_used>1) then
                                                                                                                                                                                                
                                        model_gross_housing_wealth(time_period)=model_gross_housing_wealth(time_period)+&
                                            (housing_price(time_period)*housing_size(housing_status_index_used))*&
                                            distribution_mass_used
                                            
                                        model_net_housing_wealth(time_period)=model_net_housing_wealth(time_period)+&
                                            (housing_price(time_period)*housing_size(housing_status_index_used)+&
                                            min(financial_grid(financial_index_used),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index_used))*&
                                            distribution_mass_used
                                                                                                        
                                        model_mortgages(time_period)=model_mortgages(time_period)-&
                                            min(financial_grid(financial_index_used),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index_used)*&
                                            distribution_mass_used
                                        
                                    end if
                                    
                                    if (total_income>0) then
                                    
                                        model_avg_mortgage_spending(time_period)=model_avg_mortgage_spending(time_period)+&
                                            mortgage_to_income_owners*distribution_mass_used

                                        model_avg_housing_spending_owners(time_period)=&
                                            model_avg_housing_spending_owners(time_period)+&
                                            housing_to_income_owners*distribution_mass_used

                                        model_avg_housing_spending_all(time_period)=model_avg_housing_spending_all(time_period)+&
                                            housing_to_income_all*distribution_mass_used

                                        model_avg_housing_spending_renters(time_period)=&
                                            model_avg_housing_spending_renters(time_period)+&
                                            housing_to_income_renters*distribution_mass_used
                                            
                                        model_mass_renters_to_consider(time_period)=&
                                            model_mass_renters_to_consider(time_period)+distribution_mass_used
                                                                    
                                    end if
                                                                    
                                    if (age_index==1) then
                                    
                                        if (years_left_on_mortgage_index==1) then
                                    
                                            model_youngest_assets(time_period)=model_youngest_assets(time_period)+&
                                                financial_grid(financial_index)*distribution_mass_used
                                                
                                        else
                                                                                
                                            model_youngest_assets(time_period)=model_youngest_assets(time_period)+&
                                                (housing_price(time_period)*housing_size(housing_status_index)+&
                                                min(financial_grid(financial_index),0.d0)*&
                                                housing_price(time_period)*housing_size(housing_status_index)+&
                                                max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                        
                                        end if
                                            
                                    end if
                                    
                                    mass_dying(time_period)=mass_dying(time_period)+distribution_mass_used*&
                                        (1-survival_probability(age_index,is_homeless_1,is_addicted_1))
                                                                
                                    if (amortization_used>1) then

                                        bequest_1=housing_price(time_period)*&
                                            housing_size(housing_status_index_used)*(1-remove_tax_and_depreciation*&
                                            (property_tax(time_period)+housing_depreciation_rate))
                                                                                
                                        bequest_1=bequest_1+&
                                            (1-frac_used)*(min(financial_grid(financial_index_used),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index_used)+&
                                            max(financial_grid(financial_index_used),0.d0))
                                                                                    
                                        bequest_1=bequest_1+frac_used*(min(financial_grid(fin_frac_used),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index_used)+&
                                            max(financial_grid(fin_frac_used),0.d0))
                                                                                        
                                    else
                                
                                        bequest_1=(1-frac_used)*max(financial_grid(financial_index_used),0.d0)+&
                                            frac_used*max(financial_grid(fin_frac_used),0.d0)
                                
                                    end if
                                                                        
                                    value_of_bequests_by_age(age_index)=value_of_bequests_by_age(age_index)+&
                                        bequest_2*distribution_mass_used
                                                                            
                                    bequests_mass_by_age(age_index)=bequests_mass_by_age(age_index)+distribution_mass_used
                                    
                                    model_bequests(time_period)=model_bequests(time_period)+bequest_1*distribution_mass_used*&
                                        (1-survival_probability(age_index,is_homeless_1,is_addicted_1))
                                        
                                    model_total_inheritance(time_period)=model_total_inheritance(time_period)+&
                                        ((1-inheritance_function_of_productivity)+&
                                        inheritance_function_of_productivity*&
                                        employment_grid(age_index,employment_index))*&
                                        inheritance_amount(age_index)*distribution_mass_used
                                        
                                    model_financial_bequests(time_period)=model_financial_bequests(time_period)+&
                                        ((1-frac_used)*max(financial_grid(financial_index_used),0.d0)+&
                                        frac_used*max(financial_grid(fin_frac_used),0.d0))*distribution_mass_used*&
                                        (1-survival_probability(age_index,is_homeless_1,is_addicted_1))
                                    
                                    if (years_left_on_mortgage_index>1) then
                                    
                                        model_fraction_leaving_housing_bequests(time_period)=&
                                            model_fraction_leaving_housing_bequests(time_period)+distribution_mass_used*&
                                            (1-survival_probability(age_index,is_homeless_1,is_addicted_1))
                                            
                                    end if

                                    if (bequest_1>0) then
                                    
                                        model_fraction_leaving_bequests(time_period)=&
                                            model_fraction_leaving_bequests(time_period)+distribution_mass_used*&
                                            (1-survival_probability(age_index,is_homeless_1,is_addicted_1))
                                            
                                    end if
                                              
                                    if (amortization_used>=2) then
                                    
                                        mass_of_owners(time_period)=mass_of_owners(time_period)+distribution_mass_used
                                        
                                        model_wealth_of_owners(time_period)=model_wealth_of_owners(time_period)+&
                                            (max(years_left_on_mortgage_index-1,0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)+&
                                            min(financial_grid(financial_index),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                    
                                    end if
                                    
                                    if ((in_retirement==0) .AND. ((unemployment_index==1) .OR. &
                                       (unemployment_index==threshold_addiction_index+1))) then
                                    
                                        model_total_workers(time_period)=model_total_workers(time_period)+distribution_mass_used
                                        
                                        model_average_labour_income(time_period)=model_average_labour_income(time_period)+&
                                            labor_supply_used*employment_grid(age_index,employment_index)*&
                                            labour_deterministic_efficiency(age_index)*distribution_mass_used
                                            
                                        model_average_labour_income_by_employment(time_period,employment_index)=&
                                            model_average_labour_income_by_employment(time_period,employment_index)+&
                                            labor_supply_used*employment_grid(age_index,employment_index)*&
                                            labour_deterministic_efficiency(age_index)*distribution_mass_used
                                            
                                        mass_by_employment(time_period,employment_index)=&
                                            mass_by_employment(time_period,employment_index)+&
                                            distribution_mass_used
                                                                                 
                                    end if
                                                                    
                                    if (in_retirement==1) then
                                    
                                        model_average_income(time_period)=model_average_income(time_period)+&
                                            model_ss_benefits(employment_index)*distribution_mass_used
                                    
                                    else
                                    
                                        if ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1)) then
                                        
                                            model_average_income(time_period)=model_average_income(time_period)+&
                                                labor_supply_used*employment_grid(age_index,employment_index)*&
                                                labour_deterministic_efficiency(age_index)*distribution_mass_used
                                                
                                        elseif ((unemployment_index==threshold_addiction_index) .OR. &
                                            (unemployment_index==unemployment_grid_size)) then
                                    
                                            model_average_income(time_period)=model_average_income(time_period)+&
                                                min(replacement_rate_ui*avg_income_to_use_2,&
                                                max_ui_as_perc_of_avg_inc*avg_income_to_use_1)*distribution_mass_used
                                        
                                        end if
                                        
                                    end if
                                    
                                    model_average_income(time_period)=model_average_income(time_period)+&
                                        risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)*&
                                        distribution_mass_used
                                        
                                    model_average_income_plus_assets(time_period)=model_average_income(time_period)+&
                                        (bequest_2+max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                        
                                    if ((amortization_used==1) .AND. (years_left_on_mortgage_index==2)) then
                                        
                                        model_average_income_plus_all_assets(time_period)=&
                                            model_average_income_plus_assets(time_period)+&
                                            (bequest_2+housing_price(time_period)*housing_size(housing_status_index)*&
                                            (1+min(financial_grid(financial_index),0.d0)))*distribution_mass_used
                                            
                                    else
                                    
                                        model_average_income_plus_all_assets(time_period)=&
                                            model_average_income_plus_assets(time_period)
                                            
                                    end if
                                    
                                    if ((amortization_used==1) .AND. &
                                        (housing_status_index_used>=second_lowest_housing_grid_point)) then
                                        
                                        if (amortization_used==0) then

                                            total_rent_paid(time_period)=total_rent_paid(time_period)+&
                                                rent(time_period,low_quality_market)*lived_in_size_used*distribution_mass_used

                                            average_rent_by_age(age_index)=average_rent_by_age(age_index)+&
                                                rent(time_period,low_quality_market)*distribution_mass_used

                                        else

                                            total_rent_paid(time_period)=total_rent_paid(time_period)+&
                                                rent(time_period,low_quality_market)*lived_in_size_used*distribution_mass_used
        
                                            average_rent_by_age(age_index)=average_rent_by_age(age_index)+&
                                                rent(time_period,low_quality_market)*distribution_mass_used

                                        end if
                                                                                        
                                        mass_of_renters_by_age(age_index)=mass_of_renters_by_age(age_index)+&
                                            distribution_mass_used
                                                                                        
                                    elseif (amortization_used>1) then
                                    
                                        total_imputed_rents(time_period)=&
                                            total_imputed_rents(time_period)+rent(time_period,0)*&
                                            lived_in_size_used*distribution_mass_used
                                    
                                    end if
                                    
                                end do
                                    
                            end do
                            
                        end do
                        
                    end do
                                                                        
                end do
                
            end do
            
        end do
        
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        sum_of_retirees=0
        
        do i=1,2
        
            sum_of_retirees=sum_of_retirees+&
                sum(distribution_stationary(i)%&
                vector_transition_real(time_period,life_span-retirement_span+1:life_span,:,:,:,:,:))
        
        end do
        
        do i=1,number_of_wide_grids_income_to_avg_income_cdf
        
            income_to_avg_income_wide_pdf_1(time_period,i)=&
                income_to_avg_income_wide_pdf_1(time_period,i)/&
                mass_at_profile_income_to_avg_income_wide_1(time_period,2,i)
        
        end do
        
        profile_of_chronic_homeless(time_period,:)=profile_of_chronic_homeless(time_period,:)/&
            mass_profile_of_chornic_homeless(time_period,:)

        do j=1,number_of_wide_grids_income_to_avg_income_cdf

            do i=1,number_of_profiles_for_income

                profile_by_income_to_avg_income_wide_1(time_period,2,j,i)=&
                    sum(profile_by_income_to_avg_income_wide_1(time_period,0:1,j,i))/&
                    mass_at_profile_income_to_avg_income_wide_1(time_period,2,j)

            end do

        end do 

        do k=0,1

            do j=1,number_of_wide_grids_income_to_avg_income_cdf

                do i=1,number_of_profiles_for_income

                    profile_by_income_to_avg_income_wide_1(time_period,k,j,i)=&
                        profile_by_income_to_avg_income_wide_1(time_period,k,j,i)/&
                        mass_at_profile_income_to_avg_income_wide_1(time_period,k,j)

                end do

            end do

        end do        
                
        model_average_ss_benefits(time_period)=model_average_ss_benefits(time_period)/sum_of_retirees
        
        model_net_wealth_owners(time_period)=model_net_wealth_owners(time_period)/model_total_owners(time_period)

        model_net_wealth_renters(time_period)=model_net_wealth_renters(time_period)/model_total_renters(time_period)
        
        model_fraction_homeless_with_negative_value_of_life(time_period)=&
            model_fraction_homeless_with_negative_value_of_life(time_period)/model_fraction_with_negative_value_of_life(time_period)
        
        model_fraction_addicted_with_negative_value_of_life(time_period)=&
            model_fraction_addicted_with_negative_value_of_life(time_period)/model_fraction_with_negative_value_of_life(time_period)
        
        model_fraction_with_negative_value_of_life(time_period)=&
            model_fraction_with_negative_value_of_life(time_period)/sum_of_distribution
        
        median_income_cdf(time_period,:)=median_income_cdf(time_period,:)/sum_of_distribution
        
        do i=2,number_of_grids_rent_to_income_cdf
        
            median_income_cdf(time_period,i)=median_income_cdf(time_period,i-1)+median_income_cdf(time_period,i)
            
        end do
        
        model_fraction_addicted_who_are_homeless(time_period)=&
            model_fraction_addicted_who_are_homeless(time_period)/model_fraction_addicted(time_period)
        
        model_addiction_by_employment(:)=model_addiction_by_employment(:)/model_fraction_addicted(time_period)
          
        model_fraction_choose_zero_work(time_period)=&
            model_fraction_choose_zero_work(time_period)/model_mass_can_work(time_period)
            
        model_fraction_choose_little_work(time_period)=&
            model_fraction_choose_little_work(time_period)/model_mass_can_work(time_period)
          
        median_index=minloc(median_income_cdf(time_period,:),1,&
            mask=median_income_cdf(time_period,:)-0.5>=0)
                        
        median_income(time_period)=(model_average_rent(time_period)*model_average_rental_unit_size(time_period))/&
            rent_to_income_ratios(time_period,max(median_index(1),1))
        
        model_fraction_of_homeless_and_addicted_unemployed(time_period)=&
            model_fraction_of_homeless_and_addicted_unemployed(time_period)/model_fraction_homeless_and_addicted(time_period)
            
        model_profile_of_homeless_old(:)=model_profile_of_homeless_old(:)/model_homelessness_old(time_period)
            
        model_homelessness_old(time_period)=model_homelessness_old(time_period)/model_fraction_homeless(time_period)
    
        model_fraction_leaving_bequests(time_period)=model_fraction_leaving_bequests(time_period)/mass_dying(time_period)
        
        model_fraction_leaving_housing_bequests(time_period)=&
            model_fraction_leaving_housing_bequests(time_period)/mass_dying(time_period)
                
        model_total_investment_income(time_period)=model_financial(time_period)*risk_free_rate(time_period)
        
        model_average_financial(time_period)=model_financial(time_period)/model_mass_with_positive_financial(time_period)
        
        model_GDP(time_period)=model_output(time_period)
        
        model_total_income(time_period)=model_output(time_period)+&
            model_total_investment_income(time_period)+include_bequests*model_bequests(time_period)
            
        model_youngest_net_wealth_share(time_period)=&
            model_youngest_net_wealth_share(time_period)/model_total_net_wealth(time_period)
                            
        model_average_net_wealth(time_period)=model_total_net_wealth(time_period)/sum_of_distribution
            
        model_avg_mortgage_spending(time_period)=model_avg_mortgage_spending(time_period)/mass_of_owners(time_period)

        model_avg_housing_spending_owners(time_period)=model_avg_housing_spending_owners(time_period)/mass_of_owners(time_period)

        model_avg_housing_spending_all(time_period)=model_avg_housing_spending_all(time_period)/sum_of_distribution_not_be_homeless

        model_avg_housing_spending_renters(time_period)=model_avg_housing_spending_renters(time_period)/&
            model_mass_renters_to_consider(time_period)
            
        model_wealth_of_owners(time_period)=model_wealth_of_owners(time_period)/mass_of_owners(time_period)
                    
        model_fraction_unemployed_on_ui(time_period)=model_fraction_unemployed_on_ui(time_period)/&
            model_fraction_unemployed(time_period)
            
        model_fraction_of_unemployed_homeless(time_period)=model_fraction_of_unemployed_homeless(time_period)/&
            model_fraction_unemployed(time_period)
            
        model_fraction_unemployed(time_period)=model_fraction_unemployed(time_period)/sum_of_distribution
        
        model_fraction_addicted_and_unemployed(time_period)=model_fraction_addicted_and_unemployed(time_period)/&
            model_fraction_addicted(time_period)
        
        model_fraction_addicted(time_period)=model_fraction_addicted(time_period)/sum_of_distribution
        model_fraction_homeless_and_addicted(time_period)=model_fraction_homeless_and_addicted(time_period)/&
            model_fraction_homeless(time_period)
        
        model_fraction_of_homeless_unemployed(time_period)=model_fraction_of_homeless_unemployed(time_period)/&
            model_fraction_homeless(time_period)
            
        model_fraction_homeless_owners(time_period)=model_fraction_homeless_owners(time_period)/&
            model_fraction_homeless(time_period)
            
        model_homeless_2_years_or_more(time_period)=&
            model_homeless_2_years_or_more(time_period)/model_fraction_homeless(time_period)
                    
        model_fraction_homeless(time_period)=model_fraction_homeless(time_period)/&
            model_sum_of_lowest_productivities(time_period)
        
        model_avg_rent_to_income_ratio(time_period)=model_avg_rent_to_income_ratio(time_period)/mass_of_legit_renters(time_period)
        
        do i=2,number_of_grids_rent_to_income_cdf
        
            rent_to_income_cdf(time_period,i)=rent_to_income_cdf(time_period,i-1)+rent_to_income_cdf(time_period,i)
            
            rent_to_income_homeless_cdf(time_period,i)=rent_to_income_homeless_cdf(time_period,i-1)+&
                rent_to_income_homeless_cdf(time_period,i)
                    
        end do
                
        rent_to_income_cdf(time_period,:)=rent_to_income_cdf(time_period,:)/total_renters_to_consider
        rent_to_income_homeless_cdf(time_period,:)=rent_to_income_homeless_cdf(time_period,:)/total_homeless_1
        
        median_index=minloc(rent_to_income_homeless_cdf(time_period,:),1,&
            mask=rent_to_income_homeless_cdf(time_period,:)-0.5>=0)
                        
        percentiles_homeless_income(time_period,1)=&
            (model_average_rent(time_period)*model_average_rental_unit_size(time_period))/&
            rent_to_income_ratios(time_period,max(median_index(1),1))
            
        median_index=minloc(rent_to_income_homeless_cdf(time_period,:),1,&
            mask=rent_to_income_homeless_cdf(time_period,:)-0.25>=0)
                        
        percentiles_homeless_income(time_period,2)=&
            (model_average_rent(time_period)*model_average_rental_unit_size(time_period))/&
            rent_to_income_ratios(time_period,max(median_index(1),1))
        
        do i=2,101
        
            LTV_cdf(time_period,i)=LTV_cdf(time_period,i-1)+LTV_cdf(time_period,i)
            
        end do
                
        LTV_cdf(time_period,:)=LTV_cdf(time_period,:)/total_owners_to_consider
        
        write(*,*) "rent_to_income_cdf(time_period,101)=", rent_to_income_cdf(time_period,101)
        write(*,*) "total_renters_to_consider=", total_renters_to_consider
                                             
        if (solve_transition_dynamics==0) then
                              
            write(*,*) "model_financial(",time_period,")=", model_financial(time_period)
            write(*,*) "model_mortgages(",time_period,")=", model_mortgages(time_period)
            write(*,*) "model_net_housing_wealth(",time_period,")=", model_net_housing_wealth(time_period)
            write(*,*) "model_gross_housing_wealth(",time_period,")=", model_gross_housing_wealth(time_period)
            write(*,*) "model_total_net_wealth(",time_period,")=", model_total_net_wealth(time_period)
            write(*,*) "model_bequests(",time_period,")=", model_bequests(time_period)
            write(*,*) "model_average_net_wealth(time_period)=", model_average_net_wealth(time_period)
            
        end if
        
        mortgage_interest_rate(time_period)=risk_free_rate(time_period)+mortgage_interest_gap
                                                        
        model_average_labour_income(time_period)=model_average_labour_income(time_period)/model_total_workers(time_period)
        model_average_income(time_period)=model_average_income(time_period)/sum_of_distribution
        model_average_income_plus_assets(time_period)=model_average_income_plus_assets(time_period)/sum_of_distribution
        model_average_income_plus_all_assets(time_period)=&
            model_average_income_plus_all_assets(time_period)/sum_of_distribution
                
        do age_index=1,life_span
        
            average_rent_by_age(age_index)=average_rent_by_age(age_index)/mass_of_renters_by_age(age_index)
            value_of_bequests_by_age(age_index)=value_of_bequests_by_age(age_index)/bequests_mass_by_age(age_index)
        
        end do
                
        do employment_index=1,employment_grid_size
        
            model_average_labour_income_by_employment(time_period,employment_index)=&
                model_average_labour_income_by_employment(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
        
        end do
        
        model_GDP_incl_imput_rent(time_period)=model_GDP(time_period)+total_imputed_rents(time_period)
                                                                    
    end subroutine
        
    subroutine stationary_equilibirum_homeownership_rate(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        integer :: time_period_used,financial_index_used,financial_index,has_house,&
            housing_status_index_used,amortization_used,low_quality_market
        real(8) :: lived_in_size_used,labor_supply_used,distribution_mass_used,income_1,LTV_1,&
            avg_income_to_use_1,avg_income_to_use_2
            
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                            
        time_period_used=time_period-solve_transition_dynamics
                        
        model_fraction_of_homeowners_with_mortgage(time_period)=0
        model_fraction_of_homeowners_with_mortgage_over_20_perc(time_period)=0
        model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)=0
        model_fraction_of_homeowners_with_mortgage_over_90_perc(time_period)=0
        
        model_average_owner_occupied_unit_size(time_period)=0
        model_average_owner_occupied_unit_size_to_income(time_period)=0
        model_average_owner_occupied_unit_size_to_income_work_age(time_period)=0
        working_age_mass(time_period)=0
        model_average_owners_income(time_period)=0
        model_average_rental_unit_size(time_period)=0
        model_average_rent(time_period)=0
        mass_of_renters(time_period)=0
        model_wealth_of_renters(time_period)=0
        mass_of_owners(time_period)=0    
        mass_of_owners_with_mortgage(time_period)=0
                
        largest_housing_size_consumed_in_equilibrium=0
        fraction_with_largest_housing_size_consumed_in_eqilibrium=0
        fraction_with_smallest_financial_in_eqilibrium=0
        largest_financial_chosen_in_equilibrium=0
        smallest_financial_chosen_in_equilibrium=financial_grid_size
        
        total_housing_demand(time_period)=0
        total_rental_demand(time_period,:)=0
        total_rental_demand_segmented(time_period,:)=0
        renters_by_rental(time_period,:)=0
        total_renters(time_period)=0
                
        average_age_of_homeowner_by_employment(time_period,:)=0
        mass_homeowners_by_employment(time_period,:)=0
        mass_renters_by_age(time_period,:)=0
            
        model_mass_switchers(time_period)=0
        model_age_switchers_to_renting(time_period)=0
        model_prod_switchers_to_renting(time_period)=0
        model_financial_switchers_to_renting(time_period)=0
        model_house_size_switchers_to_renting(time_period)=0 
        
        model_mass_non_switcher_renters(time_period)=0
        model_age_non_switcher_renters(time_period)=0
        model_prod_non_switcher_renters(time_period)=0
        model_financial_non_switcher_renters(time_period)=0
        model_house_size_non_switcher_renters(time_period)=0
        
        model_mass_switchers_mortgages(time_period)=0
        model_age_switchers_mortgages_to_renting(time_period)=0
        model_prod_switchers_mortgages_to_renting(time_period)=0
        model_financial_switchers_mortgages_to_renting(time_period)=0
        model_house_size_switchers_mortgages_to_renting(time_period)=0
        
        mass_by_age_and_employment(time_period,:,:)=0
        
        do age_index=1,life_span
                    
            if (age_index>life_span-retirement_span) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
            
            end if
                            
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size

                        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                                    
                        do voucher_index=0,(1-has_house)*include_vouchers
                        
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                              
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                    
                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    financial_index_used=policy_function_financial_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                       unemployment_index,employment_index,housing_status_index,voucher_index)
                                            
                                    amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                       (have_two_rental_markets==0)) then
                                    
                                        low_quality_market=0
                                    
                                    else
                                    
                                        low_quality_market=1
                                    
                                    end if

                                    call calculate_income(unemployment_index,employment_index,income_1,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)

                                    income_1=income_1+max(financial_grid(financial_index),0.d0)*risk_free_rate(time_period)            
                                                                
                                    if ((housing_status_index_used>largest_housing_size_consumed_in_equilibrium) .AND. &
                                        (distribution_mass_used>0)) then
                                       
                                        largest_housing_size_consumed_in_equilibrium=housing_status_index_used
                                       
                                    end if
                                    
                                    if ((financial_index_used>largest_financial_chosen_in_equilibrium) .AND. &
                                        (distribution_mass_used>0)) then
                                    
                                        largest_financial_chosen_in_equilibrium=financial_index_used
                                       
                                    end if
                                    
                                    if ((financial_index_used<smallest_financial_chosen_in_equilibrium) .AND. &
                                        (distribution_mass_used>0)) then
                                    
                                        smallest_financial_chosen_in_equilibrium=financial_index_used
                                       
                                    end if
                                                                    
                                    if (years_left_on_mortgage_index>1) then
                                    
                                        if (amortization_used<=1) then
                                        
                                            model_mass_switchers(time_period)=model_mass_switchers(time_period)+&
                                                distribution_mass_used
                                        
                                            model_age_switchers_to_renting(time_period)=&
                                                model_age_switchers_to_renting(time_period)+age_index*distribution_mass_used
                                                
                                            model_prod_switchers_to_renting(time_period)=&
                                                model_prod_switchers_to_renting(time_period)+distribution_mass_used
                                                
                                            model_financial_switchers_to_renting(time_period)=&
                                                model_financial_switchers_to_renting(time_period)+&
                                                max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                
                                            model_house_size_switchers_to_renting(time_period)=&
                                                model_house_size_switchers_to_renting(time_period)+&
                                                housing_status_index*distribution_mass_used
                                                
                                            if (financial_index<negative_financial_grid_size) then
                                            
                                                model_mass_switchers_mortgages(time_period)=&
                                                    model_mass_switchers_mortgages(time_period)+distribution_mass_used
                                        
                                                model_age_switchers_mortgages_to_renting(time_period)=&
                                                    model_age_switchers_mortgages_to_renting(time_period)+&
                                                    age_index*distribution_mass_used
                                                    
                                                model_prod_switchers_mortgages_to_renting(time_period)=&
                                                    model_prod_switchers_mortgages_to_renting(time_period)+&
                                                    distribution_mass_used
                                                    
                                                model_financial_switchers_mortgages_to_renting(time_period)=&
                                                    model_financial_switchers_mortgages_to_renting(time_period)+&
                                                    max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                    
                                                model_house_size_switchers_mortgages_to_renting(time_period)=&
                                                    model_house_size_switchers_mortgages_to_renting(time_period)+&
                                                    housing_status_index*distribution_mass_used
                                            
                                            end if                                            
                                                                                    
                                        end if
                                    
                                    end if
                                    
                                    if (years_left_on_mortgage_index<=1) then
                                    
                                        if (amortization_used<=1) then
                                        
                                            model_mass_non_switcher_renters(time_period)=&
                                                model_mass_non_switcher_renters(time_period)+distribution_mass_used
                                        
                                            model_age_non_switcher_renters(time_period)=&
                                                model_age_non_switcher_renters(time_period)+age_index*distribution_mass_used
                                                
                                            model_prod_non_switcher_renters(time_period)=&
                                                model_prod_non_switcher_renters(time_period)+distribution_mass_used
                                                
                                            model_financial_non_switcher_renters(time_period)=&
                                                model_financial_non_switcher_renters(time_period)+&
                                                max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                
                                            model_house_size_non_switcher_renters(time_period)=&
                                                model_house_size_non_switcher_renters(time_period)+&
                                                housing_status_index*distribution_mass_used
                                        
                                        end if    
                                    
                                    end if
                            
                                    if ((amortization_used==1) .AND. &
                                        (housing_status_index_used>=second_lowest_housing_grid_point)) then
                        
                                        model_average_rental_unit_size(time_period)=model_average_rental_unit_size(time_period)+&
                                            lived_in_size_used*distribution_mass_used
                                            
                                        model_average_rent(time_period)=model_average_rent(time_period)+&
                                            rent(time_period,low_quality_market)*lived_in_size_used*distribution_mass_used
                                                                    
                                        mass_of_renters(time_period)=mass_of_renters(time_period)+distribution_mass_used
                                        
                                        model_wealth_of_renters(time_period)=model_wealth_of_renters(time_period)+&
                                            (max(amortization_used-1,0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)+&
                                            min(financial_grid(financial_index),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                                                                                                            
                                    elseif (amortization_used>1) then
                        
                                        model_average_owner_occupied_unit_size(time_period)=&
                                            model_average_owner_occupied_unit_size(time_period)+&
                                            lived_in_size_used*distribution_mass_used
                                            
                                        if (income_1>0) then
                                            
                                            model_average_owner_occupied_unit_size_to_income(time_period)=&
                                                model_average_owner_occupied_unit_size_to_income(time_period)+&
                                                ((lived_in_size_used*housing_price(time_period))/(income_1))*&
                                                distribution_mass_used
                                                
                                            if (in_retirement==0) then
                                            
                                                model_average_owner_occupied_unit_size_to_income_work_age(time_period)=&
                                                    model_average_owner_occupied_unit_size_to_income_work_age(time_period)+&
                                                    ((lived_in_size_used*housing_price(time_period))/(income_1))*&
                                                    distribution_mass_used
                                                    
                                                working_age_mass(time_period)=working_age_mass(time_period)+distribution_mass_used
                                                    
                                            end if
                                            
                                        end if
                                            
                                        model_average_owners_income(time_period)=model_average_owners_income(time_period)+&
                                            income_1*distribution_mass_used
                                            
                                        mass_of_owners(time_period)=mass_of_owners(time_period)+distribution_mass_used
                                        
                                        if (min(financial_grid(financial_index_used),0.d0)<0) then
                                        
                                            mass_of_owners_with_mortgage(time_period)=&
                                                mass_of_owners_with_mortgage(time_period)+distribution_mass_used
                                    
                                            model_fraction_of_homeowners_with_mortgage(time_period)=&
                                                model_fraction_of_homeowners_with_mortgage(time_period)+distribution_mass_used
                                                
                                            LTV_1=-min(financial_grid(financial_index_used),0.d0)
                                                
                                            if (LTV_1>minimum_downpayment) then
                                                
                                                model_fraction_of_homeowners_with_mortgage_over_20_perc(time_period)=&
                                                    model_fraction_of_homeowners_with_mortgage_over_20_perc(time_period)+&
                                                    distribution_mass_used

                                            end if
                                                
                                            if (LTV_1>(1-minimum_downpayment)) then
                                                
                                                model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)=&
                                                    model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)+&
                                                    distribution_mass_used

                                            end if
                                            
                                            if (LTV_1>(1-minimum_downpayment+min_down_of_second_smallest)) then
                                                
                                                model_fraction_of_homeowners_with_mortgage_over_90_perc(time_period)=&
                                                    model_fraction_of_homeowners_with_mortgage_over_90_perc(time_period)+&
                                                    distribution_mass_used

                                            end if
                                                                        
                                        end if
                                                            
                                    end if
                                    
                                    if ((housing_status_index_used==(housing_status_grid_size-1)) .AND. &
                                        (distribution_mass_used>0)) then
                                        
                                        fraction_with_largest_housing_size_consumed_in_eqilibrium=&
                                            fraction_with_largest_housing_size_consumed_in_eqilibrium+&
                                            distribution_mass_used
                                        
                                    end if
                                                                
                                    if ((financial_index_used==smallest_financial_chosen_in_equilibrium) .AND. &
                                        (distribution_mass_used>0)) then
                                        
                                        fraction_with_smallest_financial_in_eqilibrium=&
                                            fraction_with_smallest_financial_in_eqilibrium+&
                                            distribution_mass_used
                                        
                                    end if
                                    
                                    if (housing_status_index_used>=second_lowest_housing_grid_point) then
                                    
                                        total_housing_demand(time_period)=total_housing_demand(time_period)+&
                                            lived_in_size_used*distribution_mass_used
                                            
                                    end if
                                                                                                                
                                    mass_by_age_and_employment(time_period,age_index,employment_index)=&
                                        mass_by_age_and_employment(time_period,age_index,employment_index)+&
                                        distribution_mass_used
                                                                                                  
                                    if (amortization_used<=1) then
                                    
                                        if (housing_status_index_used>=second_lowest_housing_grid_point) then
                                                                                
                                            total_rental_demand(time_period,low_quality_market)=&
                                                total_rental_demand(time_period,low_quality_market)+&
                                                lived_in_size_used*distribution_mass_used
                                                
                                            if (housing_status_index_used>second_lowest_housing_grid_point) then
                                            
                                                low_quality_market=0
                                            
                                            else
                                            
                                                low_quality_market=1
                                            
                                            end if
                                            
                                            total_rental_demand_segmented(time_period,low_quality_market)=&
                                                total_rental_demand_segmented(time_period,low_quality_market)+&
                                                lived_in_size_used*distribution_mass_used
                                                
                                            renters_by_rental(time_period,housing_status_index_used)=&
                                                renters_by_rental(time_period,housing_status_index_used)+&
                                                distribution_mass_used
                                                
                                            total_renters(time_period)=total_renters(time_period)+distribution_mass_used
                                                
                                        end if
                                                                                                                                 
                                        mass_renters_by_age(time_period,age_index)=mass_renters_by_age(time_period,age_index)+&
                                            distribution_mass_used
                                                                                                                                                           
                                    else
                                    
                                        average_age_of_homeowner_by_employment(time_period,employment_index)=&
                                            average_age_of_homeowner_by_employment(time_period,employment_index)+&
                                            age_index*distribution_mass_used
                                            
                                        mass_homeowners_by_employment(time_period,employment_index)=&
                                            mass_homeowners_by_employment(time_period,employment_index)+&
                                            distribution_mass_used
                                                                        
                                    end if 
                                    
                                end do
                                    
                            end do
                            
                        end do
                        
                    end do
                    
                end do
                                            
            end do
            
        end do
        
        renters_by_rental(time_period,:)=&
            renters_by_rental(time_period,:)/total_renters(time_period)
        
        total_rental_demand_segmented(time_period,:)=total_rental_demand_segmented(time_period,:)/&
            sum(total_rental_demand_segmented(time_period,:))
        
        model_age_switchers_to_renting(time_period)=&
            model_age_switchers_to_renting(time_period)/model_mass_switchers(time_period)
            
        model_prod_switchers_to_renting(time_period)=&
            model_prod_switchers_to_renting(time_period)/model_mass_switchers(time_period)
            
        model_financial_switchers_to_renting(time_period)=&
            model_financial_switchers_to_renting(time_period)/model_mass_switchers(time_period)
            
        model_house_size_switchers_to_renting(time_period)=&
            model_house_size_switchers_to_renting(time_period)/model_mass_switchers(time_period)
                
        model_age_non_switcher_renters(time_period)=model_age_non_switcher_renters(time_period)/&
            model_mass_non_switcher_renters(time_period)
            
        model_prod_non_switcher_renters(time_period)=model_prod_non_switcher_renters(time_period)/&
            model_mass_non_switcher_renters(time_period)
            
        model_financial_non_switcher_renters(time_period)=&
            model_financial_non_switcher_renters(time_period)/model_mass_non_switcher_renters(time_period)
            
        model_house_size_non_switcher_renters(time_period)=&
            model_house_size_non_switcher_renters(time_period)/model_mass_non_switcher_renters(time_period)
            
        model_age_switchers_mortgages_to_renting(time_period)=&
            model_age_switchers_mortgages_to_renting(time_period)/model_mass_switchers_mortgages(time_period)
            
        model_prod_switchers_mortgages_to_renting(time_period)=&
            model_prod_switchers_mortgages_to_renting(time_period)/model_mass_switchers_mortgages(time_period)
            
        model_financial_switchers_mortgages_to_renting(time_period)=&
            model_financial_switchers_mortgages_to_renting(time_period)/model_mass_switchers_mortgages(time_period)
            
        model_house_size_switchers_mortgages_to_renting(time_period)=&
            model_house_size_switchers_mortgages_to_renting(time_period)/model_mass_switchers_mortgages(time_period)
        
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        if (solve_transition_dynamics==0) then
        
            write(*,*) "sum_of_distribution=", sum_of_distribution
            
        end if
                          
        model_average_rental_unit_size(time_period)=&
            model_average_rental_unit_size(time_period)/mass_of_renters(time_period)
            
        model_average_rent(time_period)=model_average_rent(time_period)/sum(total_rental_demand(time_period,:))
                        
        model_average_owner_occupied_unit_size(time_period)=&
            model_average_owner_occupied_unit_size(time_period)/mass_of_owners(time_period)
            
        model_average_owner_occupied_unit_size_to_income(time_period)=&
            model_average_owner_occupied_unit_size_to_income(time_period)/mass_of_owners(time_period)
            
        model_average_owner_occupied_unit_size_to_income_work_age(time_period)=&
            model_average_owner_occupied_unit_size_to_income_work_age(time_period)/working_age_mass(time_period)
            
        model_average_owners_income(time_period)=model_average_owners_income(time_period)/mass_of_owners(time_period)
             
        model_homeownership_rate(time_period)=mass_of_owners(time_period)/sum_of_distribution_not_be_homeless
            
        model_fraction_of_homeowners_with_mortgage(time_period)=&
            model_fraction_of_homeowners_with_mortgage(time_period)/mass_of_owners(time_period)
            
        model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)=&
            model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)/&
            (model_fraction_of_homeowners_with_mortgage(time_period)*mass_of_owners(time_period))
            
        model_fraction_of_homeowners_with_mortgage_over_90_perc(time_period)=&
            model_fraction_of_homeowners_with_mortgage_over_90_perc(time_period)/&
            (model_fraction_of_homeowners_with_mortgage(time_period)*mass_of_owners(time_period))
            
        model_fraction_of_homeowners_with_mortgage_over_20_perc(time_period)=&
            model_fraction_of_homeowners_with_mortgage_over_20_perc(time_period)/&
            (model_fraction_of_homeowners_with_mortgage(time_period)*mass_of_owners(time_period))
                        
        model_wealth_of_renters(time_period)=model_wealth_of_renters(time_period)/mass_of_renters(time_period)
            
        if (solve_transition_dynamics==0) then
            
            write(*,*) "model_homeownership_rate(time_period)", model_homeownership_rate(time_period)
        
            write(*,*) "model_average_rental_unit_size(time_period)=", model_average_rental_unit_size(time_period)
            
            write(*,*) "model_average_rent(time_period)=", model_average_rent(time_period)
            
            write(*,*) "model_average_owner_occupied_unit_size(time_period)=", model_average_owner_occupied_unit_size(time_period)
            
            write(*,*) "model_average_rental_unit_size(time_period)/model_average_owner_occupied_unit_size(time_period)=", &
                model_average_rental_unit_size(time_period)/model_average_owner_occupied_unit_size(time_period)
            
            write(*,*) "model_fraction_of_homeowners_with_mortgage(time_period)=", &
                model_fraction_of_homeowners_with_mortgage(time_period)
                                
        end if
                
        fraction_with_largest_housing_size_consumed_in_eqilibrium=&
            fraction_with_largest_housing_size_consumed_in_eqilibrium/sum_of_distribution
            
        fraction_with_smallest_financial_in_eqilibrium=fraction_with_smallest_financial_in_eqilibrium/sum_of_distribution
                      
        do employment_index=1,employment_grid_size
                        
            average_age_of_homeowner_by_employment(time_period,employment_index)=&
                average_age_of_homeowner_by_employment(time_period,employment_index)/&
                mass_homeowners_by_employment(time_period,employment_index)
                    
        end do
                  
        total_rental_supply(time_period,:)=0
    
        if (is_counterfactual==1) then
        
            if (infinite_elasticity_of_rental_supply==1) then
            
                total_rental_supply(time_period,:)=total_rental_demand(time_period,:)
                    
            else
            
                if (zero_elasticity==0) then
                
                    do i=0,have_two_rental_markets
                                                    
                        total_rental_supply(time_period,i)=max(((rent(time_period,i)-&
                            housing_price(time_period)+(1/(1+risk_free_rate(time_period)))*&
                            (housing_price(time_period-solve_transition_dynamics)*&
                            (1-housing_depreciation_rate-property_tax(time_period-solve_transition_dynamics)-&
                            property_tax_on_rental_housing)))/(rental_management_costs_calibrated(i)*&
                            convexity_of_rental_company(i))),0.d0)**(1/(convexity_of_rental_company(i)-1))
                            
                    end do
                                            
                end if
                    
            end if
                         
        else

             if (infinite_elasticity_of_rental_supply==1) then
            
                total_rental_supply(time_period,:)=total_rental_demand(time_period,:)
                    
            else
            
                if (zero_elasticity==0) then
                
                    do j=0,have_two_rental_markets

                        total_rental_supply(time_period,j)=max(((rent(time_period,j)-&
                            housing_price(time_period)+(1/(1+risk_free_rate(time_period)))*&
                            (housing_price(time_period-solve_transition_dynamics)*(1-housing_depreciation_rate-&
                            property_tax(time_period-solve_transition_dynamics)-property_tax_on_rental_housing)))/&
                            (rental_management_costs(j)*convexity_of_rental_company(j))),0.d0)**&
                            (1/(convexity_of_rental_company(j)-1))
                            
                    end do
                        
                else
                
                    total_rental_supply(time_period,:)=total_rental_demand(time_period,:)
                
                end if

            end if
            
        end if
                                      
    end subroutine
    
    subroutine stationary_equilibrium_wealth_distribution(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,loop_over_complete_distribution,wealth_counter_2,time_period,wealth_of_top_x_perc_index,has_house
        real(8) :: frac_of_household_mas_to_add,sum_distribution_used,net_wealth_used
                
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        wealth_counter=0
        
        wealth_matrix(time_period,:,:,:)=-housing_price(time_period)*housing_size(housing_status_grid_size-1)
        
        model_total_net_wealth_1(time_period)=0
        
        do years_left_on_mortgage_index=1,max_amortization_years
        
            if (years_left_on_mortgage_index==2) then
            
                has_house=1
                
            else
            
                has_house=0
                
            end if
        
            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
            
                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                    has_house*index_of_smallest_house_hhld_can_buy,(housing_status_grid_size-1)
                    
                    sum_distribution_used=&
                        sum(distribution_stationary(years_left_on_mortgage_index)%&
                        vector_transition_real(time_period,:,financial_index,:,:,housing_status_index,:))
                                                    
                    if (sum_distribution_used>0) then
                    
                        net_wealth_used=max(min(years_left_on_mortgage_index-1,1),0)*&
                            housing_price(time_period)*housing_size(housing_status_index)+&
                            min(financial_grid(financial_index),0.d0)*&
                            housing_price(time_period)*housing_size(housing_status_index)+&
                            max(financial_grid(financial_index),0.d0)
                        
                        wealth_matrix(time_period,financial_index,housing_status_index,years_left_on_mortgage_index)=&
                            net_wealth_used
                            
                        model_total_net_wealth_1(time_period)=model_total_net_wealth_1(time_period)+&
                            net_wealth_used*sum_distribution_used
                        
                        wealth_counter=wealth_counter+1    
                                                               
                    end if
                                            
                end do
                                                                
            end do
                            
        end do
                                    
        wealth_matrix_saved(time_period,:,:,:)=wealth_matrix(time_period,:,:,:)
        
        write(*,*) "begining wealth distribution" 
        
        do wealth_of_top_x_perc_index=1,(wealth_brackets)
        
            write(*,*) "compute for top ", 100*stopping_rule_wealth_dist(wealth_of_top_x_perc_index)
                
            wealth_matrix(time_period,:,:,:)=wealth_matrix_saved(time_period,:,:,:)
        
            pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=0
            
            model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)=0
                            
            distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=0
            
            if (wealth_of_top_x_perc_index==wealth_brackets) then
            
                loop_over_complete_distribution=1
            
            else
            
                loop_over_complete_distribution=0
            
            end if
            
            wealth_counter_2=1
                        
            do while (((loop_over_complete_distribution*wealth_counter_2)+(1-loop_over_complete_distribution)*&
                     (distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+10.d0**(-6)))&
                     <=(loop_over_complete_distribution*wealth_counter+&
                     (1-loop_over_complete_distribution)*stopping_rule_wealth_dist(wealth_of_top_x_perc_index)))
                                          
                wealth_counter_2=wealth_counter_2+1
                                
                max_wealth=maxval(wealth_matrix(time_period,:,:,:),mask=wealth_matrix(time_period,:,:,:)>&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                                    
                max_wealth_index=maxloc(wealth_matrix(time_period,:,:,:),mask=wealth_matrix(time_period,:,:,:)>&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                    
                sum_distribution_used=sum(distribution_stationary(max_wealth_index(3))%&
                    vector_transition_real(time_period,:,max_wealth_index(1),:,:,&
                    max_wealth_index(2)-2,:))
                                               
                if (((pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+sum_distribution_used)/&
                    sum_of_distribution)>stopping_rule_wealth_dist(wealth_of_top_x_perc_index)) then
                                                                        
                    frac_of_household_mas_to_add=(sum_of_distribution*stopping_rule_wealth_dist(wealth_of_top_x_perc_index)-&
                        pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index))/sum_distribution_used
                        
                    distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                        stopping_rule_wealth_dist(wealth_of_top_x_perc_index)+0.000001
                        
                else
                
                    frac_of_household_mas_to_add=1
                    
                    distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                        pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/sum_of_distribution
                
                end if
                
                pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*sum_distribution_used
                     
                model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)=model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*max_wealth*sum_distribution_used
                    
                wealth_matrix(time_period,max_wealth_index(1),&
                    max_wealth_index(2)-2,max_wealth_index(3))=&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1)
                    
            end do
                                        
            if (solve_transition_dynamics==0) then
                
                write(*,*) "model_wealth_of_top_x_perc(",wealth_of_top_x_perc_index,")/model_net_wealth=",&
                    model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)/model_total_net_wealth_1(time_period)
                write(*,*) "stopping_rule_wealth_dist(",wealth_of_top_x_perc_index,")=",&
                    stopping_rule_wealth_dist(wealth_of_top_x_perc_index)
                                                        
            end if
                                      
        end do
        
        if (solve_transition_dynamics==0) then
        
            write(*,*) "file number=", file_number
            
        end if
        
    end subroutine
    
    subroutine stationary_equilibrium_income_distribution(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,loop_over_complete_distribution,income_counter_2,&
            time_period,income_of_top_x_perc_index,has_house,years_2
        real(8) :: frac_of_household_mas_to_add,avg_income_to_use_1,sum_distribution_used,&
            avg_income_to_use_2,labor_supply_used,distribution_mass_used,income_1,max_value,bequest_1
                
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
        
        income_counter=0
        
        do i=1,2
        
            income_matrix(i)%vector_real_income(:,:,:,:,:,:)=&
                -housing_price(time_period)*housing_size(housing_status_grid_size-1)
            
        end do
        
        do age_index=1,life_span
        
            if (age_index>life_span-retirement_span) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                            
            do years_left_on_mortgage_index=1,max_amortization_years
            
                if (years_left_on_mortgage_index==2) then
                
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        if (inheritance_function_of_productivity==1) then
                        
                            bequest_1=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
                    
                        else
                        
                            call calculate_bequest_amount(age_index,bequest_1,employment_index)
                            
                        end if
                    
                        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                           
                        do voucher_index=0,(1-has_house)*include_vouchers
                
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                            
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,(housing_status_grid_size-1)
                                    
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                    
                                    if (distribution_mass_used>0) then
                                    
                                        call calculate_income(unemployment_index,employment_index,income_1,&
                                            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                                                                                                                                                   
                                        income_matrix(years_left_on_mortgage_index)%vector_real_income&
                                            (age_index,financial_index,unemployment_index,&
                                            employment_index,housing_status_index,voucher_index)=&
                                            income_1+max(financial_grid(financial_index),0.d0)*&
                                            risk_free_rate(time_period)+bequest_1
                                        
                                        income_counter=income_counter+1    
                                                                               
                                    end if
                                                            
                                end do
                                
                            end do
                            
                        end do
                        
                    end do
                                                                            
                end do
                
            end do
                            
        end do
        
        do i=1,2
                                    
            income_matrix_saved(i)%vector_real_income(:,:,:,:,:,:)=income_matrix(i)%vector_real_income(:,:,:,:,:,:)
            
        end do
        
        write(*,*) "begining income distribution" 
        
        do income_of_top_x_perc_index=1,3 ! (1-simulation_ended)*1+simulation_ended*(income_brackets)
        
            write(*,*) "compute for top ", 100*stopping_rule_income_dist(income_of_top_x_perc_index)
                
            do i=1,2
                
                income_matrix(i)%vector_real_income(:,:,:,:,:,:)=income_matrix_saved(i)%vector_real_income(:,:,:,:,:,:)
                
            end do
        
            pop_of_top_income_x_perc(income_of_top_x_perc_index)=0
            
            model_income_of_top_x_perc(income_of_top_x_perc_index)=0
                            
            distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)=0
            
            if (income_of_top_x_perc_index==income_brackets) then
            
                loop_over_complete_distribution=1
            
            else
            
                loop_over_complete_distribution=0
            
            end if
            
            income_counter_2=1
                        
            do while (((loop_over_complete_distribution*income_counter_2)+(1-loop_over_complete_distribution)*&
                (distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)+10.d0**(-6)))&
                <=(loop_over_complete_distribution*income_counter+&
                (1-loop_over_complete_distribution)*stopping_rule_income_dist(income_of_top_x_perc_index)))
                                          
                income_counter_2=income_counter_2+1
                
                max_value=-housing_price(time_period)*housing_size(housing_status_grid_size-1)
                years_2=1
                
                do i=1,2
                                
                    max_income=maxval(income_matrix(i)%vector_real_income(:,:,:,:,:,:),&
                        mask=income_matrix(i)%vector_real_income(:,:,:,:,:,:)>&
                        -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                        
                    if (max_income>max_value) then
                    
                        max_value=max_income
                        years_2=i
                        
                    end if
                        
                end do
                                    
                max_income_index=maxloc(income_matrix(years_2)%vector_real_income(:,:,:,:,:,:),&
                    mask=income_matrix(years_2)%vector_real_income(:,:,:,:,:,:)>&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                                                            
                sum_distribution_used=distribution_stationary(years_2)%&
                    vector_transition_real(time_period,max_income_index(1),max_income_index(2),&
                    max_income_index(3),max_income_index(4),max_income_index(5)-2,max_income_index(6)-1)
                                               
                if (((pop_of_top_income_x_perc(income_of_top_x_perc_index)+sum_distribution_used)/&
                    sum_of_distribution)>stopping_rule_income_dist(income_of_top_x_perc_index)) then
                                                                        
                    frac_of_household_mas_to_add=(sum_of_distribution*stopping_rule_income_dist(income_of_top_x_perc_index)-&
                        pop_of_top_income_x_perc(income_of_top_x_perc_index))/sum_distribution_used
                        
                    distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)=&
                        stopping_rule_income_dist(income_of_top_x_perc_index)+0.000001
                        
                else
                
                    frac_of_household_mas_to_add=1
                    
                    distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)=&
                        pop_of_top_income_x_perc(income_of_top_x_perc_index)/sum_of_distribution
                
                end if
                
                pop_of_top_income_x_perc(income_of_top_x_perc_index)=pop_of_top_income_x_perc(income_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*sum_distribution_used
                     
                model_income_of_top_x_perc(income_of_top_x_perc_index)=model_income_of_top_x_perc(income_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*max_income*sum_distribution_used
                    
                income_matrix(years_2)%vector_real_income(max_income_index(1),&
                    max_income_index(2),max_income_index(3),max_income_index(4),max_income_index(5)-2,max_income_index(6)-1)=&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1)
                    
            end do
                                        
            if (solve_transition_dynamics==0) then
                
                write(*,*) "model_income_of_top_x_perc(",income_of_top_x_perc_index,")/model_net_income=",&
                    model_income_of_top_x_perc(income_of_top_x_perc_index)/model_total_income(time_period)
                write(*,*) "stopping_rule_income_dist(",income_of_top_x_perc_index,")=",&
                    stopping_rule_income_dist(income_of_top_x_perc_index)
                                                        
            end if
                                      
        end do
        
        if (solve_transition_dynamics==0) then
        
            write(*,*) "file number=", file_number
            
        end if
        
    end subroutine
    
    subroutine calculate_bequest_amount(age_index_1,bequest_1,employment_index_1)
    
        use global_vars
        
        implicit none
        
        real(8), intent(out) :: bequest_1
        integer, intent(in) :: age_index_1,employment_index_1
        
        bequest_1=0
                                    
        do i=1,number_of_inheritance_ages
        
            if (age_index_1==inheritance_age_grid(i)) then
                                                                        
                bequest_1=((1-inheritance_function_of_productivity)+&
                    inheritance_function_of_productivity*&
                    employment_grid(age_index_1,employment_index_1))*&
                    inheritance_amount(i)
                                                            
            end if
            
        end do

    end subroutine
    
    subroutine stationary_equilibrium_income_bottom_distribution(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,loop_over_complete_distribution,income_counter_2,&
            time_period,income_of_top_x_perc_index,has_house,years_2
        real(8) :: frac_of_household_mas_to_add,avg_income_to_use_1,sum_distribution_used,&
            avg_income_to_use_2,labor_supply_used,distribution_mass_used,income_1,max_value,bequest_1
            
        write(*,*) "enter bottom income subroutine"
                
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
        
        income_counter=0
        
        do i=1,2
        
            income_matrix(i)%vector_real_income(:,:,:,:,:,:)=&
                -housing_price(time_period)*housing_size(housing_status_grid_size-1)
            
        end do

        write(*,*) "create income matrix"
        
        do age_index=1,life_span
        
            if (age_index>life_span-retirement_span) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                                
            do years_left_on_mortgage_index=1,max_amortization_years
            
                if (years_left_on_mortgage_index==2) then
                
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        if (inheritance_function_of_productivity==1) then
                        
                            bequest_1=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
                            
                        else
                    
                            call calculate_bequest_amount(age_index,bequest_1,employment_index)
                    
                        end if
                    
                        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                    
                        do voucher_index=0,(1-has_house)*include_vouchers
                                           
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                            
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,(housing_status_grid_size-1)
                                    
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                    
                                    if (distribution_mass_used>0) then
                                    
                                        call calculate_income(unemployment_index,employment_index,income_1,&
                                            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                                                                                                                                       
                                        income_matrix(years_left_on_mortgage_index)%vector_real_income&
                                            (age_index,financial_index,unemployment_index,&
                                            employment_index,housing_status_index,voucher_index)=&
                                            income_1+max(financial_grid(financial_index),0.d0)*&
                                            risk_free_rate(time_period)+bequest_1
                                        
                                        income_counter=income_counter+1    
                                                                               
                                    end if
                                    
                                end do
                                                            
                            end do
                            
                        end do
                        
                    end do
                                                                            
                end do
                
            end do
                            
        end do
        
        do i=1,2
                                    
            income_matrix_saved(i)%vector_real_income(:,:,:,:,:,:)=income_matrix(i)%vector_real_income(:,:,:,:,:,:)
            
        end do
        
        write(*,*) "begining bottom income distribution" 
        
        do income_of_top_x_perc_index=4,income_brackets ! (1-simulation_ended)*1+simulation_ended*(income_brackets)
        
            write(*,*) "compute for bottom ", 100*stopping_rule_income_dist(income_of_top_x_perc_index)
            
            do i=1,2
                
                income_matrix(i)%vector_real_income(:,:,:,:,:,:)=income_matrix_saved(i)%vector_real_income(:,:,:,:,:,:)
            
            end do
        
            pop_of_top_income_x_perc(income_of_top_x_perc_index)=0
            
            model_income_of_top_x_perc(income_of_top_x_perc_index)=0
                            
            distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)=0
            
            if (income_of_top_x_perc_index==income_brackets) then
            
                loop_over_complete_distribution=0
            
            else
            
                loop_over_complete_distribution=0
            
            end if
            
            income_counter_2=1
                        
            do while (((loop_over_complete_distribution*income_counter_2)+(1-loop_over_complete_distribution)*&
                (distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)+10.d0**(-6)))&
                <=(loop_over_complete_distribution*income_counter+&
                (1-loop_over_complete_distribution)*stopping_rule_income_dist(income_of_top_x_perc_index)))
                                          
                income_counter_2=income_counter_2+1
                
                max_value=1000000
                years_2=1
                
                do i=1,2
                                
                    max_income=minval(income_matrix(i)%vector_real_income(:,:,:,:,:,:),&
                        mask=income_matrix(i)%vector_real_income(:,:,:,:,:,:)>&
                        -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                        
                    if (max_income<max_value) then
                    
                        max_value=max_income
                        years_2=i
                   
                    end if
                        
                end do
                                    
                max_income_index=minloc(income_matrix(years_2)%vector_real_income(:,:,:,:,:,:),&
                    mask=income_matrix(years_2)%vector_real_income(:,:,:,:,:,:)>&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                                                                        
                sum_distribution_used=distribution_stationary(years_2)%&
                    vector_transition_real(time_period,max_income_index(1),max_income_index(2),&
                    max_income_index(3),max_income_index(4),max_income_index(5)-2,max_income_index(6)-1)
                                               
                if (((pop_of_top_income_x_perc(income_of_top_x_perc_index)+sum_distribution_used)/&
                    sum_of_distribution)>stopping_rule_income_dist(income_of_top_x_perc_index)) then
                                                                        
                    frac_of_household_mas_to_add=(sum_of_distribution*stopping_rule_income_dist(income_of_top_x_perc_index)-&
                        pop_of_top_income_x_perc(income_of_top_x_perc_index))/sum_distribution_used
                        
                    distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)=&
                        stopping_rule_income_dist(income_of_top_x_perc_index)+0.000001
                        
                else
                
                    frac_of_household_mas_to_add=1
                    
                    distance_pop_of_top_income_x_perc(income_of_top_x_perc_index)=&
                        pop_of_top_income_x_perc(income_of_top_x_perc_index)/sum_of_distribution
                
                end if
                
                pop_of_top_income_x_perc(income_of_top_x_perc_index)=pop_of_top_income_x_perc(income_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*sum_distribution_used
                     
                model_income_of_top_x_perc(income_of_top_x_perc_index)=model_income_of_top_x_perc(income_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*max_income*sum_distribution_used
                    
                income_matrix(years_2)%vector_real_income(max_income_index(1),&
                    max_income_index(2),max_income_index(3),max_income_index(4),max_income_index(5)-2,max_income_index(6)-1)=&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1)
                    
            end do
                                        
            if (solve_transition_dynamics==0) then
                
                write(*,*) "model_income_of_top_x_perc(",income_of_top_x_perc_index,")/model_net_income=",&
                    model_income_of_top_x_perc(income_of_top_x_perc_index)/model_total_income(time_period)
                write(*,*) "stopping_rule_income_dist(",income_of_top_x_perc_index,")=",&
                    stopping_rule_income_dist(income_of_top_x_perc_index)
                                                        
            end if
                                      
        end do
        
        if (solve_transition_dynamics==0) then
        
            write(*,*) "file number=", file_number
            
        end if
        
    end subroutine
    
    subroutine stationary_equilibrium_wealth_distribution_of_old(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,wealth_counter_2,time_period,wealth_of_top_x_perc_index,has_house
        real(8) :: frac_of_household_mas_to_add,sum_distribution_used,sum_of_distribution_of_old
                
        sum_of_distribution_of_old=0
        
        do i=1,2
                
            sum_of_distribution_of_old=sum_of_distribution_of_old+&
                sum(distribution_stationary(i)%vector_transition_real&
                (time_period,life_span-retirement_span+1:life_span,:,:,:,:,:))
            
        end do
        
        wealth_counter=0
        
        wealth_matrix(time_period,:,:,:)=-housing_price(time_period)*housing_size(housing_status_grid_size-1)
                
        do years_left_on_mortgage_index=1,max_amortization_years
        
            if (years_left_on_mortgage_index==2) then
            
                has_house=1
                
            else
            
                has_house=0
                
            end if
        
            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
            
                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                    has_house*index_of_smallest_house_hhld_can_buy,(housing_status_grid_size-1)
                                                    
                    if (sum(distribution_stationary(years_left_on_mortgage_index)%&
                        vector_transition_real(time_period,life_span-retirement_span+1:life_span,&
                        financial_index,:,:,housing_status_index,:))>0) then
                        
                        wealth_matrix(time_period,financial_index,housing_status_index,years_left_on_mortgage_index)=&
                            max(min(years_left_on_mortgage_index-1,1),0)*&
                            housing_price(time_period)*housing_size(housing_status_index)+&
                            min(financial_grid(financial_index),0.d0)*&
                            housing_price(time_period)*housing_size(housing_status_index)+&
                            max(financial_grid(financial_index),0.d0)
                                                    
                        wealth_counter=wealth_counter+1    
                                                               
                    end if
                                            
                end do
                                                                
            end do
                            
        end do
                                                
        wealth_matrix_saved(time_period,:,:,:)=wealth_matrix(time_period,:,:,:)
        
        write(*,*) "begining wealth distribution for old" 
        
        do wealth_of_top_x_perc_index=1,3
                
            wealth_matrix(time_period,:,:,:)=wealth_matrix_saved(time_period,:,:,:)
        
            pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=0
            
            model_wealth_of_x_perc_of_old(wealth_of_top_x_perc_index)=0
                            
            distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=0
            
            wealth_counter_2=1
                        
            do while ((distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+10.d0**(-6))<=&
                stopping_rule_wealth_dist_of_old(wealth_of_top_x_perc_index))
                                          
                wealth_counter_2=wealth_counter_2+1
                                
                min_wealth=minval(wealth_matrix(time_period,:,:,:),mask=wealth_matrix(time_period,:,:,:)>&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                                    
                min_wealth_index=minloc(wealth_matrix(time_period,:,:,:),mask=wealth_matrix(time_period,:,:,:)>&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1))
                                                                                
                sum_distribution_used=sum(distribution_stationary(min_wealth_index(3))%&
                    vector_transition_real(time_period,life_span-retirement_span+1:life_span,min_wealth_index(1),:,:,&
                    min_wealth_index(2)-2,:))
                                               
                if (((pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+sum_distribution_used)/&
                    sum_of_distribution_of_old)>stopping_rule_wealth_dist_of_old(wealth_of_top_x_perc_index)) then
                                                                        
                    frac_of_household_mas_to_add=(sum_of_distribution_of_old*&
                        stopping_rule_wealth_dist_of_old(wealth_of_top_x_perc_index)-&
                        pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index))/sum_distribution_used
                        
                    distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                        stopping_rule_wealth_dist_of_old(wealth_of_top_x_perc_index)+0.000001
                        
                else
                
                    frac_of_household_mas_to_add=1
                    
                    distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                        pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/sum_of_distribution_of_old
                
                end if
                
                pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                    pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*sum_distribution_used
                     
                model_wealth_of_x_perc_of_old(wealth_of_top_x_perc_index)=min_wealth
                    
                wealth_matrix(time_period,min_wealth_index(1),&
                    min_wealth_index(2)-2,min_wealth_index(3))=&
                    -housing_price(time_period)*housing_size(housing_status_grid_size-1)
                    
            end do
                                        
            if (solve_transition_dynamics==0) then
                
!                write(*,*) "model_wealth_of_x_perc_of_old(",wealth_of_top_x_perc_index,")=",&
!                    model_wealth_of_x_perc_of_old(wealth_of_top_x_perc_index)
!                write(*,*) "stopping_rule_wealth_dist_of_old(",wealth_of_top_x_perc_index,")=",&
!                    stopping_rule_wealth_dist_of_old(wealth_of_top_x_perc_index)
                                                        
            end if
                                      
        end do
        
        if (solve_transition_dynamics==0) then
        
            write(*,*) "file number=", file_number
            
        end if
        
    end subroutine
        
    subroutine calculate_gini_coefficient(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period,has_house
        real(8) :: scalar_1=10,sum_distribution_used
        
        loop_count_gini=0
        
        wealth_matrix_gini(time_period,:,:,:)=-scalar_1*housing_price(time_period)*housing_size(housing_status_grid_size-1)
        
        do years_left_on_mortgage_index=1,max_amortization_years
        
            if (years_left_on_mortgage_index==2) then
            
                has_house=1
                
            else
            
                has_house=0
                
            end if
        
            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
            
                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                    has_house*index_of_smallest_house_hhld_can_buy,(housing_status_grid_size-1)
                                        
                    if (sum(distribution_stationary(years_left_on_mortgage_index)%&
                        vector_transition_real(time_period,:,financial_index,:,:,housing_status_index,:))>0) then
                        
                        wealth_matrix_gini(time_period,financial_index,housing_status_index,years_left_on_mortgage_index)=&
                            housing_price(time_period)*housing_size(housing_status_index)*&
                            (max(min(years_left_on_mortgage_index-1,1),0)+min(financial_grid(financial_index),0.d0))+&
                            max(financial_grid(financial_index),0.d0)                            
                           
                        loop_count_gini=loop_count_gini+1
                                                               
                    end if
                                            
                end do
                                                                
            end do
                            
        end do
                                            
        gini_coefficient_numerator(time_period)=0
        gini_coefficient_cumulative_wealth(time_period,:)=0
            
        counter=1
                        
        do while (counter<=loop_count_gini)
            
            min_wealth_gini=minval(wealth_matrix_gini(time_period,:,:,:),mask=wealth_matrix_gini(time_period,:,:,:)>&
                -scalar_1*housing_price(time_period)*housing_size(housing_status_grid_size-1))
                
            min_wealth_index_gini=minloc(wealth_matrix_gini(time_period,:,:,:),mask=wealth_matrix_gini(time_period,:,:,:)>&
                -scalar_1*housing_price(time_period)*housing_size(housing_status_grid_size-1))
                
            sum_distribution_used=sum(distribution_stationary(min_wealth_index_gini(3))%&
                vector_transition_real(time_period,:,min_wealth_index_gini(1),:,:,min_wealth_index_gini(2)-2,:))
                                           
            gini_coefficient_cumulative_wealth(time_period,2)=gini_coefficient_cumulative_wealth(time_period,1)+&
                sum_distribution_used*min_wealth_gini
                                                
            wealth_matrix_gini(time_period,min_wealth_index_gini(1),min_wealth_index_gini(2)-2,&
                min_wealth_index_gini(3))=-2*scalar_1*housing_price(time_period)*housing_size(housing_status_grid_size-1)
                                        
            gini_coefficient_numerator(time_period)=gini_coefficient_numerator(time_period)+&
                (sum_distribution_used/sum_of_distribution)*(gini_coefficient_cumulative_wealth(time_period,2)+&
                gini_coefficient_cumulative_wealth(time_period,1))
                
            gini_coefficient_cumulative_wealth(time_period,1)=gini_coefficient_cumulative_wealth(time_period,2)
            
            counter=counter+1
                             
        end do
        
        gini_coefficient(time_period)=1-(gini_coefficient_numerator(time_period)/&
            gini_coefficient_cumulative_wealth(time_period,2))
        
        write(*,*) "gini_coefficient(", time_period,")=", gini_coefficient(time_period)
        
    end subroutine
    
    subroutine calculate_housing_voucher(housing_voucher_1,income_1,rent_spending_1,&
        homeowner_spending_1,is_current_homeowner_1,is_choosing_to_rent_1,time_period)
    
        use Global_Vars
     
        implicit none
        
        real(8), intent(in) :: income_1,rent_spending_1,homeowner_spending_1
        real(8), intent(inout) :: housing_voucher_1
        real(8) :: voucher_required
        integer, intent(in) :: time_period,is_current_homeowner_1,is_choosing_to_rent_1
                
        voucher_required=max(max_rent_relative_to_ave*&
            is_choosing_to_rent_1*model_average_rent(time_period)*model_average_rental_unit_size(time_period)+&
            is_current_homeowner_1*model_average_rent(time_period)*model_average_rental_unit_size(time_period)-&
            max_fraction_of_income_spent_on_housing*income_1,0.d0)
                                    
        housing_voucher_1=max(min(voucher_required,&
            is_choosing_to_rent_1*rent_spending_1+&
            is_current_homeowner_1*homeowner_spending_1),0.d0)
                    
    end subroutine
    
    subroutine calculate_housing_voucher_2(housing_voucher_1,future_addiction_index_1,income_1,rent_spending_1,time_period)
    
        use Global_Vars
     
        implicit none
        
        real(8), intent(in) :: income_1,rent_spending_1
        real(8), intent(inout) :: housing_voucher_1
        integer, intent(in) :: time_period,future_addiction_index_1
        
        housing_voucher_1=0
        
        if (((unemployment_index>threshold_addiction_index) .OR. &
            ((future_addiction_index_1==1) .AND. (unemployment_index<=threshold_addiction_index))) .AND. &
            (voucher_conditional_on_clean==1)) then
            
            if (voucher_conditional_on_clean_just_addicts==1) then
            
                write(*,*) "wrong"
                
            end if
            
            housing_voucher_1=0
            
        elseif ((unemployment_index>threshold_addiction_index) .AND. &
            (voucher_conditional_on_clean_just_addicts==1)) then
            
            if (voucher_conditional_on_clean==1) then
            
                write(*,*) "wrong"
                
            end if
                        
            housing_voucher_1=0
            
        else
                        
            housing_voucher_1=min(max(model_average_rent(time_period)*model_average_rental_unit_size(time_period)-&
                rent_to_income_ratio_vouchers*income_1,0.d0),max(rent_spending_1-rent_to_income_ratio_vouchers*income_1,0.d0))
                
        end if
                                         
    end subroutine
        
    subroutine govt_revenues_calc(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period,has_house,amortization_used,time_period_used,housing_status_index_used,&
            is_current_owner,choose_to_rent,low_quality_market,is_addicted,addiction_choice_2,choose_addiction_1,age_group_1
        real(8) :: is_renter_to_owner,lived_in_size_used,distribution_mass_used,MID_used,income_tax_used,&
            consumption_used,labor_supply_used,avg_income_to_use_1,avg_income_to_use_2,&
            income_1,food_stamps_1,assets_1,assets_2,total_consumption_used,avg_net_wealth_to_use_1,housing_voucher_1,&
            total_homeless_1,after_tax_income_1,after_tax_income_2,frac_spent_on_addiction_used,housing_voucher_2,&
            total_addited_1,income_2,frac_getting_vouchers,homeowner_spending,total_addicted_and_homeless_1,bequest_1,&
            addiction_consumption_1

        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
            
        avg_net_wealth_to_use_1=is_counterfactual*average_net_wealth_calibrated+&
            (1-is_counterfactual)*model_average_net_wealth(time_period)
                                    
        time_period_used=time_period-solve_transition_dynamics
        
        govt_revenues_from_labour_income(time_period)=0
        govt_spending_on_mortgage_interest_deductions(time_period)=0
        fraction_using_MID(time_period)=0
        govt_revenues_from_consumption(time_period)=0
        govt_revenues_from_investment_income(time_period)=0
        govt_revenues_from_property_tax(time_period)=0
        govt_lump_sum_transfers(time_period)=0
        govt_spending_on_ss(time_period)=0
        govt_ss_wasted(time_period)=0
        govt_spending_on_ui(time_period)=0
        govt_spending_on_homeless(time_period)=0
        govt_spending_on_addicts(time_period)=0
        govt_spending_on_food_stamps(time_period)=0
        model_fraction_spent_on_addiction(time_period)=0
        model_fraction_spent_on_addiction_experimenters(time_period)=0
        model_addicted_total_addiction_spending_to_total_income(time_period)=0
        model_addicted_total_income(time_period)=0
        model_experimenters_total_drug_spending_to_total_income(time_period)=0
        model_experimenters_total_income(time_period)=0
        total_addited_1=0
        model_addicted(time_period)=0
        model_exprimenters(time_period)=0
        model_total_drug_users(time_period)=0        
        addiction_share_of_income_by_employment(time_period,:)=0
        percent_addicted_by_employment(time_period,:)=0
        mass_by_employment(time_period,:)=0
        model_average_spent_on_addiction_by_addicted(time_period)=0
        model_drugs_used_by_users_on_average(time_period)=0
        model_drugs_consumed_by_users(time_period)=0
        model_drugs_used_by_experimenters_on_average(time_period)=0
        model_mass_addicts(time_period)=0
        model_drugs_used_by_addicts_on_average(time_period)=0
        model_mass_experimenters(time_period)=0
        model_mass_total_users(time_period)=0
        employment_mass(time_period,:)=0
        govt_spending_on_housing_vouchers(time_period)=0
        govt_spending_on_housing_vouchers_2(time_period)=0
        model_eligibles_getting_voucher(time_period)=0
        model_eligibles_getting_voucher_relative_to_pop(time_period)=0
        model_addicts_getting_voucher(time_period)=0
        model_homeowners_experimenting(time_period)=0
        model_experimenters_getting_voucher(time_period)=0
        model_drug_users_getting_voucher(time_period)=0
        model_avg_income_experimenters(time_period)=0
        model_avg_income_drug_users(time_period)=0
        model_avg_assets_experimenters(time_period)=0
        model_eligibles(time_period)=0
        model_fraction_recieving_food_stamps(time_period)=0
        model_fraction_homeless_recieving_food_stamps(time_period)=0
        model_food_stamps_share_to_homeless(time_period)=0
        model_fraction_homeless(time_period)=0
        model_fraction_recieving_housing_vouchers(time_period)=0
        net_govt_revenues(time_period)=0
        
        model_fraction_addicted_homeless_no_vouchers(time_period)=0
        frac_getting_vouchers=0
        
        total_homeless_1=0
        total_addicted_and_homeless_1=0
        model_fraction_homeless_by_choice(time_period)=0
        model_addicted_and_homeless_by_choice(time_period)=0         
        
        model_avg_homeless_income(time_period)=0
        model_avg_homeless_after_tax_income(time_period)=0
        model_avg_homeless_tax_to_income(time_period)=0
        model_avg_homeless_assets(time_period)=0
        model_average_income_of_homeless_addicted(time_period)=0
        model_average_assets_addicted_and_homeless(time_period)=0
        
        model_average_assets_homeless_by_addiction(time_period,:)=0
        model_average_income_homeless_by_addiction(time_period,:)=0
        model_average_income_addicted(time_period)=0
        model_average_assets_addicted(time_period)=0
        model_average_assets_drug_users(time_period)=0
        model_mass_by_homeless_and_addiction(time_period,:)=0
        
        model_age_by_addiction(time_period,:)=0
        model_mass_age_by_addiction(time_period,:)=0
        
        model_addiction_rate_by_age(time_period,:)=0
        model_experimentation_choice_by_age(time_period,:)=0
        model_drug_use_by_age_group(time_period,:)=0
        model_drug_use_percent_by_age_group(time_period,:)=0
        
        addiction_rate_by_age(time_period,:)=0
        homeless_and_addiction_rate_by_age(time_period,:)=0
        mass_by_age(time_period,:)=0
        
        model_fraction_choose_addiction_when_unemployed(time_period)=0
        model_choose_addiction_when_income_is_low(time_period)=0
        model_fraction_choose_addiction_when_homeless(time_period)=0
        model_choose_addiction_when_retired(time_period)=0
        model_fraction_choose_addiction(time_period)=0
        model_mass_choose_addiction(time_period)=0
        
        model_unemployment_by_employment(time_period,:)=0
        mass_by_employment_1(time_period,:)=0
                
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                                                
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                                
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                                
                do unemployment_index=1,unemployment_grid_size
                                    
                    do employment_index=1,employment_grid_size
                    
                        if (inheritance_function_of_productivity==1) then
                        
                            bequest_1=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
                    
                        else
                            
                            call calculate_bequest_amount(age_index,bequest_1,employment_index)
                            
                        end if
                    
                        do voucher_index=0,(1-has_house)*include_vouchers

                            avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                                (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                                                
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                                                                    
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    amortization_used=&
                                        policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                    
                                    MID_used=policy_function_mortgage_interest_deductions(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    income_tax_used=policy_function_wage_income_tax_paid(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    consumption_used=&
                                        policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    total_consumption_used=&
                                        policy_function_total_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    frac_spent_on_addiction_used=&
                                        policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    addiction_choice_2=&
                                        policy_function_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    addiction_consumption_1=&
                                        addiction_choice_2*max(total_consumption_used-consumption_used,0.d0)
                                                                
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                                                                     
                                    if (years_left_on_mortgage_index>1) then
                                        
                                        is_current_owner=1
                                        homeowner_spending=&
                                            housing_price(time_period)*housing_size(housing_status_index)*&
                                            (property_tax(time_period)+housing_depreciation_rate-&
                                            mortgage_interest_rate(time_period)*min(financial_grid(financial_index),0.d0))
                                            
                                    else
                                    
                                        is_current_owner=0
                                        homeowner_spending=0
                                        
                                    end if
                                    
                                    if (amortization_used>1) then
                                        
                                        choose_to_rent=0
                                        
                                    else
                                    
                                        choose_to_rent=1
                                        
                                    end if
                                    
                                    if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                       (have_two_rental_markets==0)) then
                                    
                                        low_quality_market=0
                                    
                                    else
                                    
                                        low_quality_market=1
                                    
                                    end if
                                                                       
                                    call calculate_income(unemployment_index,employment_index,income_1,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)

                                    income_2=income_1+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)  
                                    
                                    if ((addiction_consumption_1>0) .AND. &
                                        (unemployment_index<=threshold_addiction_index) .AND. &
                                        (is_current_owner==1)) then
                                    
                                        model_homeowners_experimenting(time_period)=&
                                            model_homeowners_experimenting(time_period)+distribution_mass_used
                                            
                                    end if
                                    
                                    if ((income_2<threshold_income_vouchers*((1-is_counterfactual)*median_income(time_period)+&
                                        is_counterfactual*median_income_calibrated)) .AND. (include_vouchers==1)) then

                                        if ((amortization_used==1) .AND. (years_left_on_mortgage_index==1)) then

                                            model_eligibles(time_period)=model_eligibles(time_period)+distribution_mass_used

                                        end if

                                        if ((years_left_on_mortgage_index==1) .AND. (amortization_used==1) .AND. &
                                            (voucher_index==1)) then
                                                                                                            
                                            call calculate_housing_voucher_2(housing_voucher_2,addiction_choice_2,income_2,&
                                                rent(time_period,low_quality_market)*housing_size(housing_status_index_used),&
                                                time_period)
                                                                                        
                                            govt_spending_on_housing_vouchers_2(time_period)=&
                                                govt_spending_on_housing_vouchers_2(time_period)+&
                                                housing_voucher_2*distribution_mass_used
                                                
                                            if (housing_voucher_2>0) then
                                            
                                                model_fraction_recieving_housing_vouchers(time_period)=&   
                                                    model_fraction_recieving_housing_vouchers(time_period)+&
                                                    distribution_mass_used

                                                model_eligibles_getting_voucher(time_period)=&  
                                                    model_eligibles_getting_voucher(time_period)+distribution_mass_used
                                                    
                                                if (unemployment_index>threshold_addiction_index) then
                                                    
                                                    model_addicts_getting_voucher(time_period)=&
                                                        model_addicts_getting_voucher(time_period)+distribution_mass_used
                                                    
                                                end if
                                                
                                                if (addiction_consumption_1>0) then
                                                
                                                    model_drug_users_getting_voucher(time_period)=&
                                                        model_drug_users_getting_voucher(time_period)+distribution_mass_used

                                                end if
                                                
                                                if ((addiction_consumption_1>0) .AND. &
                                                    (unemployment_index<=threshold_addiction_index)) then
                                                    
                                                    model_experimenters_getting_voucher(time_period)=&
                                                        model_experimenters_getting_voucher(time_period)+distribution_mass_used
                                                    
                                                end if
                                                
                                            end if
                                        
                                        end if
                                        
                                    end if
                                    
                                    assets_1=2*threshold_for_food_stamps_as_perc_of_average_net_wealth*&
                                        avg_net_wealth_to_use_1
                                    
                                    ! This one is a homeowner who chooses to rent
                                    if ((years_left_on_mortgage_index>1) .AND. (amortization_used==1)) then

                                        assets_1=max(housing_price(time_period)*housing_size(housing_status_index)*&
                                            ((1-cost_of_selling-property_tax(time_period)-housing_depreciation_rate)+&
                                            min(financial_grid(financial_index),0.d0)*(1+mortgage_interest_rate(time_period)))+&
                                            max(financial_grid(financial_index),0.d0),0.d0)
                                
                                    ! This one is a renter who stays renting
                                    elseif ((years_left_on_mortgage_index==1) .AND. (amortization_used==1)) then
                                    
                                        assets_1=max(financial_grid(financial_index),0.d0)

                                    end if
                                    
                                    if (addiction_consumption_1>0) then
                                    
                                        model_avg_income_drug_users(time_period)=&
                                            model_avg_income_drug_users(time_period)+income_1*distribution_mass_used
                                            
                                    end if
                                    
                                    if ((addiction_consumption_1>0) .AND. &
                                        (unemployment_index<=threshold_addiction_index) .AND. &
                                        (include_probability_of_becoming_addicted==1)) then
                                        
                                        model_avg_income_experimenters(time_period)=&
                                            model_avg_income_experimenters(time_period)+income_1*distribution_mass_used
                                            
                                        ! This one is a homeowner who chooses to rent
                                        if (years_left_on_mortgage_index>1) then

                                            assets_2=max(housing_price(time_period)*housing_size(housing_status_index)*&
                                                ((1-cost_of_selling-property_tax(time_period)-housing_depreciation_rate)+&
                                                min(financial_grid(financial_index),0.d0)*(1+mortgage_interest_rate(time_period)))+&
                                                max(financial_grid(financial_index),0.d0),0.d0)
                                    
                                        ! This one is a renter who stays renting
                                        elseif (years_left_on_mortgage_index==1) then
                                        
                                            assets_2=max(financial_grid(financial_index),0.d0)

                                        end if 
                                            
                                        model_avg_assets_experimenters(time_period)=&
                                            model_avg_assets_experimenters(time_period)+assets_2*distribution_mass_used
                                            
                                        model_exprimenters(time_period)=model_exprimenters(time_period)+&
                                            distribution_mass_used
                                        
                                    end if
                                    
                                    food_stamps_1=0
                                    
                                    ! If they have no assets, they get can qualift for food stamps
                                    if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*&
                                        avg_net_wealth_to_use_1) then
                                                            
                                        food_stamps_1=max((max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                                            (income_1+max(financial_grid(financial_index),0.d0)*risk_free_rate(time_period))),0.d0)
                                                                    
                                    end if
                                    
                                    if ((addiction_consumption_1>0) .AND. &
                                        (unemployment_index<=threshold_addiction_index)) then
                                                                                
                                        income_2=income_1+risk_free_rate(time_period)*&
                                            max(financial_grid(financial_index),0.d0)+bequest_1
                                            
                                        model_experimenters_total_drug_spending_to_total_income(time_period)=&
                                            model_experimenters_total_drug_spending_to_total_income(time_period)+&
                                            (frac_spent_on_addiction_used*total_consumption_used)*distribution_mass_used
                                            
                                        model_experimenters_total_income(time_period)=&
                                            model_experimenters_total_income(time_period)+income_2*distribution_mass_used
                                                                                        
                                        if (income_2>0) then
                                    
                                            model_fraction_spent_on_addiction_experimenters(time_period)=&
                                                model_fraction_spent_on_addiction_experimenters(time_period)+&
                                                (frac_spent_on_addiction_used*total_consumption_used/income_2)*&
                                                distribution_mass_used
                                              
                                        else
                                        
                                            model_fraction_spent_on_addiction_experimenters(time_period)=&
                                                model_fraction_spent_on_addiction_experimenters(time_period)+&
                                                1*distribution_mass_used
                                            
                                        end if
                                        
                                    end if
                                    
                                    if (((addiction_consumption_1>0) .AND. (unemployment_index<=threshold_addiction_index)) .OR. &
                                        (unemployment_index>threshold_addiction_index)) then
                                        
                                        model_drugs_used_by_users_on_average(time_period)=&
                                            model_drugs_used_by_users_on_average(time_period)+&
                                            (frac_spent_on_addiction_used*total_consumption_used/price_of_addictive_good)*&
                                            distribution_mass_used
                                            
                                        model_drugs_consumed_by_users(time_period)=&
                                            model_drugs_consumed_by_users(time_period)+&
                                            (frac_spent_on_addiction_used*total_consumption_used/price_of_addictive_good)*&
                                            distribution_mass_used
                                            
                                        model_mass_total_users(time_period)=&
                                            model_mass_total_users(time_period)+distribution_mass_used
                                            
                                        if (age_index<=4) then
                                        
                                            age_group_1=1
                                            
                                        elseif (age_index<=9) then
                                            
                                            age_group_1=2
                                                
                                        elseif (age_index<=14) then
                                            
                                            age_group_1=3
                                            
                                        elseif (age_index<=19) then
                                            
                                            age_group_1=4
                                            
                                        elseif (age_index<=24) then
                                            
                                            age_group_1=5
                                            
                                        elseif (age_index<=29) then
                                            
                                            age_group_1=6
                                            
                                        elseif (age_index<=34) then
                                            
                                            age_group_1=7
                                            
                                        elseif (age_index<=39) then
                                            
                                            age_group_1=8
                                            
                                        else
                                        
                                            age_group_1=9
                                            
                                        end if
                                                
                                        model_drug_use_by_age_group(time_period,age_group_1)=&
                                            model_drug_use_by_age_group(time_period,age_group_1)+distribution_mass_used
                                            
                                        model_drug_use_percent_by_age_group(time_period,age_group_1)=&
                                            model_drug_use_percent_by_age_group(time_period,age_group_1)+&
                                            distribution_mass_used
                                            
                                        if (unemployment_index>threshold_addiction_index) then
                                        
                                            model_drugs_used_by_addicts_on_average(time_period)=&
                                                model_drugs_used_by_addicts_on_average(time_period)+&
                                                (frac_spent_on_addiction_used*total_consumption_used/price_of_addictive_good)*&
                                                distribution_mass_used
                                        
                                            model_mass_addicts(time_period)=&
                                                model_mass_addicts(time_period)+distribution_mass_used
                                                
                                            model_addiction_rate_by_age(time_period,age_index)=&
                                                model_addiction_rate_by_age(time_period,age_index)+&
                                                distribution_mass_used
                                                                                            
                                        end if
                                            
                                        if ((addiction_consumption_1>0) .AND. (unemployment_index<=threshold_addiction_index)) then
                                        
                                            model_drugs_used_by_experimenters_on_average(time_period)=&
                                                model_drugs_used_by_experimenters_on_average(time_period)+&
                                                (frac_spent_on_addiction_used*total_consumption_used/price_of_addictive_good)*&
                                                distribution_mass_used
                                            
                                            model_mass_experimenters(time_period)=&
                                                model_mass_experimenters(time_period)+distribution_mass_used
                                                
                                            model_experimentation_choice_by_age(time_period,age_index)=&
                                                model_experimentation_choice_by_age(time_period,age_index)+&
                                                distribution_mass_used
                                        
                                        end if
                                            
                                    end if
                                                                        
                                    if (unemployment_index>threshold_addiction_index) then
                                    
                                        model_average_spent_on_addiction_by_addicted(time_period)=&
                                            model_average_spent_on_addiction_by_addicted(time_period)+&
                                            frac_spent_on_addiction_used*distribution_mass_used
                                            
                                        model_addicted(time_period)=model_addicted(time_period)+&
                                            distribution_mass_used
                                    
                                        total_addited_1=total_addited_1+distribution_mass_used
                                                                            
                                        income_2=income_1+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)+&
                                            bequest_1
                                            
                                        model_addicted_total_income(time_period)=&
                                            model_addicted_total_income(time_period)+&
                                            income_2*distribution_mass_used
                                            
                                        model_addicted_total_addiction_spending_to_total_income(time_period)=&
                                            model_addicted_total_addiction_spending_to_total_income(time_period)+&
                                            (frac_spent_on_addiction_used*total_consumption_used)*distribution_mass_used
                                        
                                        if (income_2>0) then
                                    
                                            model_fraction_spent_on_addiction(time_period)=&
                                                model_fraction_spent_on_addiction(time_period)+&
                                                (frac_spent_on_addiction_used*total_consumption_used/income_2)*&
                                                distribution_mass_used
                                              
                                        else
                                        
                                            model_fraction_spent_on_addiction(time_period)=&
                                                model_fraction_spent_on_addiction(time_period)+1*distribution_mass_used
                                            
                                        end if
                                        
                                        mass_by_employment(time_period,employment_index)=&
                                            mass_by_employment(time_period,employment_index)+distribution_mass_used
                                            
                                        if (unemployment_index==threshold_addiction_index+1) then
                                            
                                            addiction_share_of_income_by_employment(time_period,employment_index)=&
                                                addiction_share_of_income_by_employment(time_period,employment_index)+&
                                                (frac_spent_on_addiction_used*total_consumption_used/&
                                                (income_1+risk_free_rate(time_period)*&
                                                max(financial_grid(financial_index),0.d0)))*distribution_mass_used
                                                
                                            percent_addicted_by_employment(time_period,employment_index)=&
                                                percent_addicted_by_employment(time_period,employment_index)+&
                                                distribution_mass_used
                                                                                
                                            employment_mass(time_period,employment_index)=&
                                                employment_mass(time_period,employment_index)+distribution_mass_used
                                                
                                        end if
                                                                                
                                    end if
                                    
                                    if ((has_house==1) .AND. (in_retirement==0)) then
                                                                           
                                        if ((property_tax_deductibility>0) .OR. (mortgage_deductibility>0)) then 
                                                                                                             
                                            govt_spending_on_mortgage_interest_deductions(time_period)=&
                                                govt_spending_on_mortgage_interest_deductions(time_period)+&
                                                MID_used*distribution_mass_used
                                                                                        
                                            is_renter_to_owner=0
                                                                                        
                                        end if
                                                                                    
                                        if (MID_used>0) then
                                            
                                            fraction_using_MID(time_period)=fraction_using_MID(time_period)+distribution_mass_used
                                            
                                        end if
                                        
                                        if ((in_retirement==1) .AND. (MID_used>0)) then
                                        
                                            write(*,*) "error mortgage deduction"
                                            write(*,*) "MID_used=", MID_used
                                            
                                        end if
                                        
                                        if ((MID_used>0) .AND. (years_left_on_mortgage_index<=1)) then
                                        
                                            write(*,*) "renter with mortgage deductions"
                                            write(*,*) "MID_used=", MID_used
                                        
                                        end if
                                        
                                    end if
                                                                                                                      
                                    govt_revenues_from_labour_income(time_period)=&
                                        govt_revenues_from_labour_income(time_period)+income_tax_used*distribution_mass_used
                                                                                                                        
                                    if (in_retirement==1) then

                                        govt_spending_on_ss(time_period)=govt_spending_on_ss(time_period)+&
                                            model_ss_benefits(employment_index)*distribution_mass_used

                                        govt_ss_wasted(time_period)=govt_ss_wasted(time_period)+&
                                            (model_ss_benefits(employment_index)-income_1)*distribution_mass_used
                                                                                 
                                    else
                                    
                                        if ((unemployment_index==threshold_addiction_index) .OR. &
                                            (unemployment_index==unemployment_grid_size)) then
                                        
                                            govt_spending_on_ui(time_period)=govt_spending_on_ui(time_period)+&
                                                income_1*distribution_mass_used
                                                      
                                        end if
                                             
                                    end if
                                    
                                    if (housing_status_index_used==lowest_housing_grid_point) then
                                    
                                        model_fraction_homeless(time_period)=model_fraction_homeless(time_period)+&
                                            distribution_mass_used
                                    
                                        govt_spending_on_homeless(time_period)=govt_spending_on_homeless(time_period)+&
                                            homeless_cost_govt_as_perc_of_avg_inc*avg_income_to_use_1*distribution_mass_used
                                    
                                    end if
                                                                        
                                    if (food_stamps_1>0) then
                                    
                                        model_fraction_recieving_food_stamps(time_period)=&
                                            model_fraction_recieving_food_stamps(time_period)+&
                                            distribution_mass_used
                                    
                                    end if
                                    
                                    if ((food_stamps_1>0) .AND. &
                                        (housing_status_index_used==lowest_housing_grid_point)) then
                                    
                                        model_fraction_homeless_recieving_food_stamps(time_period)=&
                                            model_fraction_homeless_recieving_food_stamps(time_period)+&
                                            distribution_mass_used
                                            
                                        model_food_stamps_share_to_homeless(time_period)=&
                                            model_food_stamps_share_to_homeless(time_period)+&
                                            food_stamps_1*distribution_mass_used
                                            
                                    end if

                                    govt_spending_on_food_stamps(time_period)=govt_spending_on_food_stamps(time_period)+&
                                        food_stamps_1*distribution_mass_used
                                        
                                    is_addicted=0
                                    
                                    if (addiction_consumption_1>0) then
                                    
                                        is_addicted=1
                                    
                                    end if
                                    
                                    if (in_retirement>=0) then
                                    
                                        if (unemployment_index<=threshold_addiction_index) then
                                        
                                            if (addiction_consumption_1>0) then
                                        
                                                model_fraction_choose_addiction(time_period)=&
                                                    model_fraction_choose_addiction(time_period)+distribution_mass_used
                                                    
                                            end if
                                        
                                        end if     
                                        
                                    end if
                                    
                                    if ((unemployment_index<=threshold_addiction_index) .AND. (addiction_consumption_1>0)) then
                                    
                                        model_mass_choose_addiction(time_period)=model_mass_choose_addiction(time_period)+&
                                            distribution_mass_used
                                    
                                    end if
                                    
                                    if ((in_retirement==1) .AND. (unemployment_index<=threshold_addiction_index) .AND. &
                                        (addiction_consumption_1>0)) then
                                    
                                        model_choose_addiction_when_retired(time_period)=&
                                            model_choose_addiction_when_retired(time_period)+distribution_mass_used
                                    
                                    end if
                                    
                                    if ((housing_status_index_used==lowest_housing_grid_point) .AND. &
                                        (unemployment_index<=threshold_addiction_index) .AND. (addiction_consumption_1>0)) then
                                        
                                        model_fraction_choose_addiction_when_homeless(time_period)=&
                                            model_fraction_choose_addiction_when_homeless(time_period)+distribution_mass_used
                                        
                                    end if  
                                                                                        
                                    if (in_retirement==0) then
                                    
                                        mass_by_employment_1(time_period,employment_index)=&
                                            mass_by_employment_1(time_period,employment_index)+distribution_mass_used
                                                                                                        
                                        if ((unemployment_index==threshold_addiction_index-1) .OR. &
                                            (unemployment_index==threshold_addiction_index) .OR. &
                                            (unemployment_index==unemployment_grid_size-1) .OR. &
                                            (unemployment_index==unemployment_grid_size)) then
                                            
                                            model_unemployment_by_employment(time_period,employment_index)=&
                                                model_unemployment_by_employment(time_period,employment_index)+&
                                                distribution_mass_used  
                                                                                        
                                            choose_addiction_1=0
                                        
                                            if (addiction_consumption_1>0) then
                                            
                                                choose_addiction_1=1
                                            
                                            end if
                                            
                                            if (unemployment_index==threshold_addiction_index-1) then
                                            
                                                model_fraction_choose_addiction_when_unemployed(time_period)=&
                                                    model_fraction_choose_addiction_when_unemployed(time_period)+&
                                                    choose_addiction_1*distribution_mass_used
                                                    
                                            end if
                                        
                                        end if
                                        
                                    end if
                                    
                                    if ((addiction_consumption_1>0) .AND. &
                                        (unemployment_index<=threshold_addiction_index)) then  
                                                                            
                                        if (income_1<threshold_income_vouchers*&
                                            ((1-is_counterfactual)*median_income(time_period)+&
                                            is_counterfactual*median_income_calibrated)) then
                                    
                                            model_choose_addiction_when_income_is_low(time_period)=&
                                                model_choose_addiction_when_income_is_low(time_period)+&
                                                distribution_mass_used
                                                
                                        end if
                                                                            
                                    end if
                                    
                                    if (is_addicted==1) then
                                                                        
                                        model_average_assets_drug_users(time_period)=&
                                            model_average_assets_drug_users(time_period)+&
                                            (has_house*housing_price(time_period)*housing_size(housing_status_index)+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                            
                                    end if
                                    
                                    if ((is_addicted==1) .AND. (unemployment_index>threshold_addiction_index)) then
                                    
                                        model_average_income_addicted(time_period)=&
                                            model_average_income_addicted(time_period)+&
                                            income_1*distribution_mass_used
                                            
                                        model_average_assets_addicted(time_period)=&
                                            model_average_assets_addicted(time_period)+&
                                            (has_house*housing_price(time_period)*housing_size(housing_status_index)+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                        
                                    end if
                                    
                                    if ((unemployment_index>threshold_addiction_index) .OR. (is_addicted==1)) then
                                                                                                        
                                        model_age_by_addiction(time_period,1)=&
                                            model_age_by_addiction(time_period,1)+&
                                            age_index*distribution_mass_used
                                            
                                    else
                                    
                                        model_age_by_addiction(time_period,0)=&
                                            model_age_by_addiction(time_period,0)+&
                                            age_index*distribution_mass_used
                                            
                                    end if
                                        
                                    addiction_rate_by_age(time_period,age_index)=&
                                        addiction_rate_by_age(time_period,age_index)+&
                                        is_addicted*distribution_mass_used
                                        
                                    if (housing_status_index_used==lowest_housing_grid_point) then
                                    
                                        homeless_and_addiction_rate_by_age(time_period,age_index)=&
                                            homeless_and_addiction_rate_by_age(time_period,age_index)+&
                                            is_addicted*distribution_mass_used
                                    
                                    end if
                                        
                                    mass_by_age(time_period,age_index)=mass_by_age(time_period,age_index)+distribution_mass_used
                                    
                                    model_mass_age_by_addiction(time_period,is_addicted)=&
                                        model_mass_age_by_addiction(time_period,is_addicted)+distribution_mass_used
                                        
                                    if (housing_status_index_used==lowest_housing_grid_point) then
                                    
                                        total_homeless_1=total_homeless_1+distribution_mass_used
                                        
                                        model_avg_homeless_income(time_period)=&
                                            model_avg_homeless_income(time_period)+&
                                            income_1*distribution_mass_used
                                            
                                        after_tax_income_1=&
                                            (income_1-income_tax_used+(1-investment_income_tax)*&
                                            risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)+&
                                            food_stamps_1)
                                            
                                        after_tax_income_2=after_tax_income_1-food_stamps_1
                                            
                                        model_average_assets_homeless_by_addiction(time_period,is_addicted)=&
                                            model_average_assets_homeless_by_addiction(time_period,is_addicted)+&
                                            (has_house*housing_price(time_period)*housing_size(housing_status_index)+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                            
                                        model_average_income_homeless_by_addiction(time_period,is_addicted)=&
                                            model_average_income_homeless_by_addiction(time_period,is_addicted)+&
                                            income_1*distribution_mass_used
                                            
                                        model_mass_by_homeless_and_addiction(time_period,is_addicted)=&
                                            model_mass_by_homeless_and_addiction(time_period,is_addicted)+&
                                            distribution_mass_used
                                                                                
                                        model_avg_homeless_after_tax_income(time_period)=&
                                            model_avg_homeless_after_tax_income(time_period)+&
                                            after_tax_income_1*distribution_mass_used
                                            
                                        if (income_1>0) then
                                        
                                            model_avg_homeless_tax_to_income(time_period)=&
                                                model_avg_homeless_tax_to_income(time_period)+&
                                                (income_tax_used/income_1)*distribution_mass_used
                                                                                    
                                        end if
                                            
                                        if (years_left_on_mortgage_index==1) then
                                        
                                            model_avg_homeless_assets(time_period)=&
                                                model_avg_homeless_assets(time_period)+&
                                                max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                
                                            if (unemployment_index>threshold_addiction_index) then
                                            
                                                model_average_assets_addicted_and_homeless(time_period)=&
                                                    model_average_assets_addicted_and_homeless(time_period)+&
                                                    max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                    
                                            end if
                                        
                                        else
                                            
                                            model_avg_homeless_assets(time_period)=&
                                                model_avg_homeless_assets(time_period)+&
                                                (housing_price(time_period)*housing_size(housing_status_index)+&
                                                (1+min(financial_grid(financial_index),0.d0))+&
                                                max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                                
                                            if (unemployment_index>threshold_addiction_index) then
                                            
                                                model_average_assets_addicted_and_homeless(time_period)=&
                                                    model_average_assets_addicted_and_homeless(time_period)+&
                                                    (housing_price(time_period)*housing_size(housing_status_index)+&
                                                    (1+min(financial_grid(financial_index),0.d0))+&
                                                    max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                                    
                                            end if
                                                
                                        end if
                                        
                                        if (unemployment_index>threshold_addiction_index) then
                                        
                                            total_addicted_and_homeless_1=total_addicted_and_homeless_1+distribution_mass_used
                                            
                                            model_average_income_of_homeless_addicted(time_period)=&
                                                model_average_income_of_homeless_addicted(time_period)+&
                                                after_tax_income_1*distribution_mass_used
                                            
                                        end if
                                        
                                        if ((after_tax_income_2+financial_grid(financial_index))>&
                                            rent(time_period,0)*housing_size(second_lowest_housing_grid_point)) then
                                            
                                            model_fraction_homeless_by_choice(time_period)=&
                                                model_fraction_homeless_by_choice(time_period)+&
                                                distribution_mass_used
                                                
                                            if (unemployment_index>threshold_addiction_index) then
                                            
                                                model_addicted_and_homeless_by_choice(time_period)=&
                                                    model_addicted_and_homeless_by_choice(time_period)+distribution_mass_used
                                                    
                                            end if                                        
                                                                                        
                                        end if
                                        
                                    end if
                                    
                                    if (unemployment_index>threshold_addiction_index) then
                                    
                                        govt_spending_on_addicts(time_period)=govt_spending_on_addicts(time_period)+&
                                            addict_cost_govt_as_perc_of_avg_inc*avg_income_to_use_1*distribution_mass_used
                                    
                                    end if
                                    
!                                    if ((unemployment_index<=threshold_addiction_index) .AND. (addiction_choice_2==1)) then
!                                    
!                                        govt_spending_on_addicts(time_period)=govt_spending_on_addicts(time_period)+&
!                                            addict_cost_govt_as_perc_of_avg_inc*avg_income_to_use_1*distribution_mass_used
!                                            
!                                    end if
                                                                        
                                    housing_voucher_1=0
                                    
                                    if (provide_vouchers==1) then
                                                                                                            
                                        call calculate_housing_voucher(housing_voucher_1,income_1+food_stamps_1+&
                                            risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)+&
                                            bequest_1,rent(time_period,low_quality_market)*housing_size(housing_status_index_used),&
                                            homeowner_spending,is_current_owner,choose_to_rent,time_period)
                                              
                                    end if
                                                                    
                                    if (housing_voucher_1>0) then
                                    
                                        frac_getting_vouchers=frac_getting_vouchers+distribution_mass_used
                                        
                                    end if
                                        
                                    govt_spending_on_housing_vouchers(time_period)=govt_spending_on_housing_vouchers(time_period)+&
                                        housing_voucher_1*distribution_mass_used
                                    
                                    if (consumption_tax>0) then
                                                    
                                        govt_revenues_from_consumption(time_period)=&
                                            govt_revenues_from_consumption(time_period)+&
                                            consumption_tax*total_consumption_used*distribution_mass_used
                                            
                                    end if
                                        
                                    govt_revenues_from_investment_income(time_period)=&
                                        govt_revenues_from_investment_income(time_period)+investment_income_tax*&
                                        (risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0))*&
                                        distribution_mass_used
                                                                         
                                    if (housing_status_index_used>=second_lowest_housing_grid_point) then
                                        
                                        if ((time_period>1) .OR. (solve_transition_dynamics==0)) then
                                                                                                                       
                                            govt_revenues_from_property_tax(time_period)=&
                                                govt_revenues_from_property_tax(time_period)+&
                                                property_tax(time_period)*housing_price(time_period)*&
                                                lived_in_size_used*distribution_mass_used
                                                                                      
                                        end if
                                        
                                    end if
                                    
                                end do
                                                                       
                            end do
                            
                        end do
                        
                    end do
                                                                   
                end do
        
            end do
            
        end do
        
        model_drugs_used_by_users_on_average(time_period)=&
            model_drugs_used_by_users_on_average(time_period)/model_mass_total_users(time_period)
            
        model_drugs_used_by_experimenters_on_average(time_period)=&
            model_drugs_used_by_experimenters_on_average(time_period)/model_mass_experimenters(time_period)
            
        model_drugs_used_by_addicts_on_average(time_period)=&
            model_drugs_used_by_addicts_on_average(time_period)/model_mass_addicts(time_period)
            
        model_addiction_rate_by_age(time_period,:)=&
            model_addiction_rate_by_age(time_period,:)/model_mass_addicts(time_period)
            
        model_drug_use_by_age_group(time_period,:)=&
            model_drug_use_by_age_group(time_period,:)/model_mass_total_users(time_period)
                                                                                       
        model_experimentation_choice_by_age(time_period,:)=&
            model_experimentation_choice_by_age(time_period,:)/model_mass_experimenters(time_period)
        
        model_addicted_total_addiction_spending_to_total_income(time_period)=&
            model_addicted_total_addiction_spending_to_total_income(time_period)/&
            model_addicted_total_income(time_period)
            
         model_experimenters_total_drug_spending_to_total_income(time_period)=&
            model_experimenters_total_drug_spending_to_total_income(time_period)/&
            model_experimenters_total_income(time_period)
        
        model_total_drug_users(time_period)=model_addicted(time_period)+model_exprimenters(time_period)
        
        model_addicts_getting_voucher(time_period)=&
            model_addicts_getting_voucher(time_period)/model_eligibles_getting_voucher(time_period)
            
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
            
        model_eligibles_getting_voucher_relative_to_pop(time_period)=&
            model_eligibles_getting_voucher(time_period)/sum_of_distribution
            
        model_homeowners_experimenting(time_period)=&
            model_homeowners_experimenting(time_period)/model_homeownership_rate(time_period)
            
        model_experimenters_getting_voucher(time_period)=&
            model_experimenters_getting_voucher(time_period)/model_eligibles_getting_voucher(time_period)

        model_drug_users_getting_voucher(time_period)=&
            model_drug_users_getting_voucher(time_period)/model_eligibles_getting_voucher(time_period)
            
        model_avg_income_experimenters(time_period)=&
            model_avg_income_experimenters(time_period)/model_exprimenters(time_period)
            
        model_avg_income_drug_users(time_period)=&
            model_avg_income_drug_users(time_period)/model_mass_total_users(time_period)
            
        model_avg_assets_experimenters(time_period)=&
            model_avg_assets_experimenters(time_period)/model_exprimenters(time_period)
                
        model_eligibles_getting_voucher(time_period)=&  
            model_eligibles_getting_voucher(time_period)/model_eligibles(time_period)
        
        model_unemployment_by_employment(time_period,:)=&
            model_unemployment_by_employment(time_period,:)/mass_by_employment_1(time_period,:)
        
        addiction_rate_by_age(time_period,:)=&
            addiction_rate_by_age(time_period,:)/mass_by_age(time_period,:)
            
        homeless_and_addiction_rate_by_age(time_period,:)=&
            homeless_and_addiction_rate_by_age(time_period,:)/mass_by_age(time_period,:)
            
        model_fraction_choose_addiction_when_unemployed(time_period)=&
            model_fraction_choose_addiction_when_unemployed(time_period)/model_mass_choose_addiction(time_period)
            
        model_choose_addiction_when_income_is_low(time_period)=&
            model_choose_addiction_when_income_is_low(time_period)/model_mass_choose_addiction(time_period)
            
        model_fraction_choose_addiction_when_homeless(time_period)=&
            model_fraction_choose_addiction_when_homeless(time_period)/model_mass_choose_addiction(time_period)
            
        model_choose_addiction_when_retired(time_period)=&
            model_choose_addiction_when_retired(time_period)/model_mass_choose_addiction(time_period)
            
        model_fraction_choose_addiction(time_period)=&
            model_fraction_choose_addiction(time_period)/model_mass_choose_addiction(time_period)
        
        model_average_spent_on_addiction_by_addicted(time_period)=&
            model_average_spent_on_addiction_by_addicted(time_period)/total_addited_1
        
        do employment_index=1,employment_grid_size
        
            addiction_share_of_income_by_employment(time_period,employment_index)=&
                addiction_share_of_income_by_employment(time_period,employment_index)/&
                employment_mass(time_period,employment_index)
                
            percent_addicted_by_employment(time_period,employment_index)=&
                percent_addicted_by_employment(time_period,employment_index)/mass_by_employment(time_period,employment_index)
            
        end do
        
        model_average_assets_homeless_by_addiction(time_period,:)=model_average_assets_homeless_by_addiction(time_period,:)/&
            model_mass_by_homeless_and_addiction(time_period,:)
            
        model_average_income_homeless_by_addiction(time_period,:)=model_average_income_homeless_by_addiction(time_period,:)/&
            model_mass_by_homeless_and_addiction(time_period,:)
            
        model_average_income_addicted(time_period)=&
            model_average_income_addicted(time_period)/total_addited_1
                                        
        model_average_assets_addicted(time_period)=&
            model_average_assets_addicted(time_period)/total_addited_1
            
        model_average_assets_drug_users(time_period)=&
            model_average_assets_drug_users(time_period)/model_mass_total_users(time_period)
            
        model_age_by_addiction(time_period,:)=&
            model_age_by_addiction(time_period,:)/model_mass_age_by_addiction(time_period,:)
                
        model_fraction_addicted_homeless_no_vouchers(time_period)=&
            model_fraction_addicted_homeless_no_vouchers(time_period)/total_homeless_1
        
        model_fraction_spent_on_addiction(time_period)=&
            model_fraction_spent_on_addiction(time_period)/total_addited_1
            
        model_fraction_spent_on_addiction_experimenters(time_period)=&
            model_fraction_spent_on_addiction_experimenters(time_period)/model_exprimenters(time_period)
                        
        model_fraction_homeless_by_choice(time_period)=&
            model_fraction_homeless_by_choice(time_period)/total_homeless_1
            
        model_addicted_and_homeless_by_choice(time_period)=&
            model_addicted_and_homeless_by_choice(time_period)/total_addicted_and_homeless_1
            
        model_average_income_of_homeless_addicted(time_period)=&
            model_average_income_of_homeless_addicted(time_period)/total_addicted_and_homeless_1
            
        model_avg_homeless_income(time_period)=&
            model_avg_homeless_income(time_period)/total_homeless_1
            
        model_avg_homeless_after_tax_income(time_period)=&
            model_avg_homeless_after_tax_income(time_period)/total_homeless_1
            
        model_avg_homeless_tax_to_income(time_period)=&
            model_avg_homeless_tax_to_income(time_period)/total_homeless_1
            
        model_avg_homeless_assets(time_period)=&
            model_avg_homeless_assets(time_period)/total_homeless_1
            
        model_average_assets_addicted_and_homeless(time_period)=&
            model_average_assets_addicted_and_homeless(time_period)/total_addicted_and_homeless_1
                    
        if ((time_period==1) .AND. (solve_transition_dynamics==1)) then
        
            do age_index=1,life_span
            
                if (age_index>(life_span-retirement_span)) then
                
                    in_retirement=1
                    
                else
                
                    in_retirement=0
                    
                end if
                                            
                do years_left_on_mortgage_index=1,max_amortization_years
                                
                    if (years_left_on_mortgage_index>1) then
                                    
                        has_house=1
                        
                    else
                    
                        has_house=0
                        
                    end if
                    
                    do unemployment_index=1,unemployment_grid_size
                    
                        do employment_index=1,employment_grid_size
                        
                            do voucher_index=0,(1-has_house)*include_vouchers
                           
                                do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                                   
                                    do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                        has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                                                                                                        
                                        lived_in_size_used=&
                                            policy_function_space_lived_in_size_to_fetch(years_left_on_mortgage_index)%&
                                            vector_real(age_index,financial_index,unemployment_index,&
                                            employment_index,housing_status_index,voucher_index)
                                                                              
                                        distribution_mass_used=distribution_to_fetch(years_left_on_mortgage_index)%&
                                            vector_real(age_index,financial_index,unemployment_index,&
                                            employment_index,housing_status_index,voucher_index)
                                            
                                        if (housing_status_index>=second_lowest_housing_grid_point) then
                                                                                                                                                                    
                                            govt_revenues_from_property_tax(time_period)=&
                                                govt_revenues_from_property_tax(time_period)+&
                                                property_tax(time_period)*housing_price(time_period)*&
                                                lived_in_size_used*distribution_mass_used
                                                                                              
                                        end if
                                                                               
                                    end do
                                    
                                end do
                                    
                            end do
                            
                        end do
                                                                       
                    end do
            
                end do
                
            end do

        end if
        
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        model_drug_use_percent_by_age_group(time_period,:)=&
            model_drug_use_percent_by_age_group(time_period,:)/sum_of_distribution
        
        model_total_drug_users(time_period)=model_total_drug_users(time_period)/sum_of_distribution
        
        model_addicted(time_period)=model_addicted(time_period)/sum_of_distribution
        
        model_exprimenters(time_period)=model_exprimenters(time_period)/sum_of_distribution
        
        fraction_using_MID(time_period)=fraction_using_MID(time_period)/sum_of_distribution
                   
        model_average_labour_income_tax(time_period)=&
            govt_revenues_from_labour_income(time_period)/(model_total_efficiency_units(time_period)+&
            model_financial(time_period)*risk_free_rate(time_period))
                     
        model_fraction_homeless_recieving_food_stamps(time_period)=&
            model_fraction_homeless_recieving_food_stamps(time_period)/model_fraction_homeless(time_period)
            
        model_food_stamps_share_to_homeless(time_period)=&
            model_food_stamps_share_to_homeless(time_period)/model_fraction_homeless(time_period)
        
        model_fraction_homeless(time_period)=model_fraction_homeless(time_period)/sum_of_distribution
                    
        total_govt_revenues(time_period)=&
            govt_revenues_from_labour_income(time_period)+&
            govt_revenues_from_consumption(time_period)+govt_revenues_from_investment_income(time_period)+&
            include_property_taxes_in_govt_constraint*govt_revenues_from_property_tax(time_period)-&
            govt_lump_sum_transfers(time_period)
            
        govt_revenues_to_use_in_tests(time_period)=&
            total_govt_revenues(time_period)-govt_spending_on_ss(time_period)-&
            govt_spending_on_ui(time_period)-govt_spending_on_homeless(time_period)-govt_spending_on_addicts(time_period)-&
            govt_spending_on_food_stamps(time_period)-govt_spending_on_housing_vouchers(time_period)-&
            govt_spending_on_housing_vouchers_2(time_period)+(1-include_bequests)*&
            (model_bequests(time_period)-value_of_initial_assets)
                    
        net_govt_revenues(time_period)=clear_only_vouchers_govt_budget*(-govt_spending_on_housing_vouchers_2(time_period))+&
            (1-clear_only_vouchers_govt_budget)*govt_revenues_to_use_in_tests(time_period)
        
        net_govt_revenues(time_period)=net_govt_revenues(time_period)+&
            include_bequests_in_govt_constraint*model_bequests(time_period)
                            
        if (solve_transition_dynamics==0) then
                
            write(*,*) "net_govt_revenues=", net_govt_revenues(time_period)
            
        end if
    
    end subroutine
            
    subroutine calculate_household_housing_spending(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,pay_mortgage_insurance_1,low_quality_market
        integer, intent(in) :: time_period
        integer :: has_house,time_period_used,amortization_used,financial_index_used,&
            housing_status_index_used,addiction_used_1
        real(8) :: total_income,mass_of_renters_1,labor_supply_used,distribution_mass_used,lived_in_size_used,&
            avg_income_to_use_1,avg_income_to_use_2,housing_voucher_2
                
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)

        time_period_used=time_period-solve_transition_dynamics
                
        mass_of_renters_at_housing_spending(time_period,:)=0
        mass_of_homeowners_at_housing_spending(time_period,:)=0
        
        model_rent_burden_by_age(time_period,:,:)=0
        mass_renters_by_age(time_period,:)=0
        
        mass_of_renters_1=0
        
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                
            if (age_index==1) then
            
                newborn_household=1
                
            else
            
                newborn_household=0
            
            end if
        
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                                                                                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        do voucher_index=0,(1-has_house)*include_vouchers

                            avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                                (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                                            
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                    
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                            
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                
                                    financial_index_used=policy_function_financial_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    addiction_used_1=policy_function_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)  
                                        
                                    if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                       (have_two_rental_markets==0)) then
                                    
                                        low_quality_market=0
                                    
                                    else
                                    
                                        low_quality_market=1
                                    
                                    end if
                                                                                                        
                                    if (amortization_used<=1) then
                                    
                                        mass_of_renters_1=mass_of_renters_1+distribution_mass_used
                                    
                                    end if
                                    
                                    call calculate_income(unemployment_index,employment_index,total_income,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                             
                                    total_income=total_income+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)
                                    
                                    housing_voucher_2=0
                                    
                                    if ((total_income<threshold_income_vouchers*((1-is_counterfactual)*median_income(time_period)+&
                                        is_counterfactual*median_income_calibrated)) .AND. (include_vouchers==1)) then

                                        if ((years_left_on_mortgage_index==1) .AND. (amortization_used==1) .AND. &
                                            (voucher_index==1)) then
                                                                                                            
                                            call calculate_housing_voucher_2(housing_voucher_2,addiction_used_1,total_income,&
                                                rent(time_period,low_quality_market)*lived_in_size_used,time_period)
                                        
                                        end if
                                        
                                    end if
                                        
                                    if ((amortization_used<=1) .AND. &
                                        (housing_status_index_used>=second_lowest_housing_grid_point)) then
                                        
                                        fraction_of_income_spent_on_housing=&
                                            (rent(time_period,low_quality_market)*lived_in_size_used-housing_voucher_2)
                                                                
                                    elseif (amortization_used>1) then
                                              
                                        if ((-min(financial_grid(financial_index_used),0.d0)>(1-minimum_downpayment)) .AND. &
                                            (financial_grid(financial_index_used)<0)) then
                                                                        
                                            pay_mortgage_insurance_1=1
                                        
                                        else
                                    
                                            pay_mortgage_insurance_1=0
                                        
                                        end if
                                                                         
                                        fraction_of_income_spent_on_housing=&
                                            housing_price(time_period)*lived_in_size_used*&
                                            ((-financial_grid(min(financial_index_used,negative_financial_grid_size))*&
                                            (pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                            mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))+&
                                            (property_tax(time_period-solve_transition_dynamics)+&
                                            include_housing_depreciation_in_housing_costs*housing_depreciation_rate))
                                                                                                                                                                                                                                                                                    
                                    end if
                                    
                                    if (total_income==0) then
                                    
                                        fraction_of_income_spent_on_housing=1
                                    
                                    else
                                        
                                        fraction_of_income_spent_on_housing=fraction_of_income_spent_on_housing/total_income
                                        
                                    end if
                                                
                                    frac_of_inc_spent_on_hous_threshold(time_period,1)=0.3
                                    frac_of_inc_spent_on_hous_threshold(time_period,2)=0.5
                                    frac_of_inc_spent_on_hous_threshold(time_period,3)=0.75
                                    frac_of_inc_spent_on_hous_threshold(time_period,4)=1 
                                            
                                    if ((amortization_used<=1) .AND. &
                                       (housing_status_index_used>=second_lowest_housing_grid_point)) then
                                                                                    
                                        do i=1,number_of_thresholds
                                                
                                            if (fraction_of_income_spent_on_housing>&
                                                frac_of_inc_spent_on_hous_threshold(time_period,i)) then
                                                            
                                                mass_of_renters_at_housing_spending(time_period,i)=&
                                                    mass_of_renters_at_housing_spending(time_period,i)+distribution_mass_used
                                                    
                                                model_rent_burden_by_age(time_period,age_index,i)=&
                                                    model_rent_burden_by_age(time_period,age_index,i)+distribution_mass_used
                                                                                                    
                                            end if
                                                            
                                        end do
                                                                                                                
                                        mass_renters_by_age(time_period,age_index)=mass_renters_by_age(time_period,age_index)+&
                                            distribution_mass_used
                                                 
                                    elseif (amortization_used>1) then
                                                                                                                                    
                                        do i=1,number_of_thresholds    
                                                    
                                            if (fraction_of_income_spent_on_housing>&
                                                frac_of_inc_spent_on_hous_threshold(time_period,i)) then
                                                            
                                                mass_of_homeowners_at_housing_spending(time_period,i)=&
                                                    mass_of_homeowners_at_housing_spending(time_period,i)+distribution_mass_used
                                                            
                                            end if
                                            
                                        end do
                                                                                          
                                    end if
                                    
                                end do
                            
                            end do
                            
                        end do
                        
                    end do
                                                            
                end do
        
            end do
            
        end do
        
        do age_index=1,life_span
        
            do i=1,number_of_thresholds
        
                model_rent_burden_by_age(time_period,age_index,i)=&
                    model_rent_burden_by_age(time_period,age_index,i)/mass_renters_by_age(time_period,age_index)
                    
            end do
        
        end do
        
        if (solve_transition_dynamics==1) then
        
            open(unit=1,file="percentage_spending_on_housing"//trim(file_number)//".txt",action="write",status="replace")
                
        else
        
            open(unit=1,file="percentage_spending_on_housing"//trim(file_number)//".txt",action="write",status="replace")
        
        end if
        
        do i=1,number_of_thresholds
        
            mass_of_renters_at_housing_spending(time_period,i)=&
                mass_of_renters_at_housing_spending(time_period,i)/mass_of_renters_1
                
            mass_of_homeowners_at_housing_spending(time_period,i)=&
                mass_of_homeowners_at_housing_spending(time_period,i)/mass_of_owners_with_mortgage(time_period)
                
            if (solve_transition_dynamics==0) then
            
                if (i<=number_of_thresholds) then
                
                    if (i<=2) then
                
                        write(*,*) "percentage of renters spending more than ", &
                            frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                            mass_of_renters_at_housing_spending(time_period,i)
                            
                        write(*,*) "percentage of homeowners with a mortgage spending more than ", &
                            frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                            mass_of_homeowners_at_housing_spending(time_period,i)
                            
                    end if
                        
                end if
                    
            end if
                                            
            write(1,*) "percentage of renters spending more than ", &
                frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                mass_of_renters_at_housing_spending(time_period,i)
            write(1,*) "percentage of homeowners with a mortgage spending more than ", &
                frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                mass_of_homeowners_at_housing_spending(time_period,i)
                                
        end do
        
        close(1)
                
    end subroutine
           
    subroutine calculate_welfare(time_period)
    
        use Global_Vars
    
        implicit none
        
        integer :: financial_index,age_index_1
        integer, intent(in) :: time_period
        integer :: has_house,time_period_used
        real(8) :: distribution_mass_used,value_function_used,labor_supply_used,income_1,&
            avg_income_to_use_1,avg_income_to_use_2
                
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
        
        age_index_1=1
                
        time_period_used=time_period-solve_transition_dynamics
        
        average_welfare_of_all_cohorts(time_period)=0
        average_welfare_of_youngest_cohort(time_period)=0
        average_welfare_of_youngest_by_quintile(time_period,:)=0
        population_by_quintile(time_period,:)=0
        
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                                    
            do years_left_on_mortgage_index=1,max_amortization_years
            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        do voucher_index=0,(1-has_house)*include_vouchers
                    
                            avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                                (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                                            
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                                    
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                    
                                    value_function_used=value_function(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                                                      
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    call calculate_income(unemployment_index,employment_index,income_1,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                    
                                    income_1=income_1+max(financial_grid(financial_index),0.d0)*risk_free_rate(time_period)
                                                                    
                                    average_welfare_of_all_cohorts(time_period)=average_welfare_of_all_cohorts(time_period)+&
                                        value_function_used*distribution_mass_used
                                                                                        
                                    if (age_index==1) then
                                    
                                        if ((time_period==2) .AND. (value_function_used==large_negative_num)) then
                                            
                                            if (distribution_mass_used>0) then
                                                
                                                write(*,*) "odd"
                                                
                                            end if
                                            
                                        end if
                                        
                                        if (distribution_mass_used>0) then
                                        
                                            if (value_function_used==large_negative_num) then
                                        
                                                write(*,*) "stuck"
                                                write(*,*) "years_left_on_mortgage_index=",years_left_on_mortgage_index
                                                write(*,*) "age_index=", age_index
                                                write(*,*) "financial_index=", financial_index
                                                write(*,*) "unemployment_index=", unemployment_index
                                                write(*,*) "employment_index=", employment_index
                                                write(*,*) "housing_status_index=", housing_status_index
                                                
                                            end if
                                    
                                            average_welfare_of_youngest_cohort(time_period)=&
                                                average_welfare_of_youngest_cohort(time_period)+&
                                                value_function_used*distribution_mass_used
                                                
                                            i=number_of_quintiles
                                            
                                            quintile_loop: do k=1,number_of_quintiles-1
                                            
                                                if (income_1<=income_cutoffs_of_quintiles(k)) then
                                            
                                                    i=k
                                                    
                                                    exit quintile_loop
                                                
                                                end if
                                            
                                            end do quintile_loop
                                                                                            
                                            population_by_quintile(time_period,i)=population_by_quintile(time_period,i)+&
                                                distribution_mass_used
                                            
                                            average_welfare_of_youngest_by_quintile(time_period,i)=&
                                                average_welfare_of_youngest_by_quintile(time_period,i)+&
                                                value_function_used*distribution_mass_used
                                                                                                                                          
                                        end if
                                                                                
                                    end if
                                    
                                end do
                                
                            end do
                            
                        end do
                        
                    end do
                        
                end do
            
            end do
            
        end do     
        
        do i=1,number_of_quintiles
        
            average_welfare_of_youngest_by_quintile(time_period,i)=&
                average_welfare_of_youngest_by_quintile(time_period,i)/population_by_quintile(time_period,i)
                
        end do
        
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        sum_of_distribution_youngest=0
                
        do i=1,2
                
            sum_of_distribution_youngest=sum_of_distribution_youngest+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,1,:,:,:,:,:))
            
        end do
        
        average_welfare_of_all_cohorts(time_period)=average_welfare_of_all_cohorts(time_period)/sum_of_distribution
        
        average_welfare_of_youngest_cohort(time_period)=average_welfare_of_youngest_cohort(time_period)/sum_of_distribution_youngest
            
        if (solve_transition_dynamics==0) then
        
            write(*,*) "average_welfare_of_youngest_cohort=", average_welfare_of_youngest_cohort(time_period)
            write(*,*) "average_welfare_of_all_cohorts=", average_welfare_of_all_cohorts(time_period)
            
        end if
        
    end subroutine
    
    subroutine calculate_welfare_by_characteristics(time_period)
    
        use Global_Vars
    
        implicit none
        
        integer :: financial_index,l,time_period_used,employment_index_to_use,index_addiction_1,low_quality_market
        integer, intent(in) :: time_period
        integer :: has_house,amortization_used,financial_index_used,housing_status_index_used,is_homeless_1
        real(8) :: distribution_mass_used,value_function_used,MID_used,consumption_used,lived_in_size_used,labor_supply_used,&
            avg_income_to_use_1,avg_income_to_use_2,frac_spent_on_addiction_used
                
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)

        time_period_used=time_period-solve_transition_dynamics
                
        welfare_by_age(time_period,:)=0
        mass_by_age(time_period,:)=0
        
        welfare_by_age_and_addiction(time_period,:,:)=0
        mass_by_age_and_addiciton(time_period,:,:)=0
        
        welfare_by_employment_and_age(time_period,:,:)=0
        mass_by_employment_and_age(time_period,:,:)=0
        
        welfare_by_employment(time_period,:)=0
        welfare_by_employment_youngest(time_period,:)=0
        welfare_by_employment_youngest_old_dist(time_period,:)=0        
        mass_by_employment(time_period,:)=0
        mass_by_employment_youngest(time_period,:)=0
        wealth_by_employment(time_period,:)=0
        
        welfare_by_addiction(time_period,:)=0
        welfare_by_addiction_youngest(time_period,:)=0
        lowest_welfare_of_addicted(time_period,:)=0
        mass_by_addiction(time_period,:)=0
        mass_by_addiction_youngest(time_period,:)=0
        
        welfare_by_homelessness(time_period,:)=0
        mass_by_homelessness(time_period,:)=0
        
        fraction_with_mortgage(time_period,:)=0
        fraction_renters_by_employment(time_period,:)=0
        average_age_of_homeowner(time_period,:)=0
        MID_share_by_employment(time_period,:)=0
        
        welfare_by_unemployment(time_period,:)=0
        mass_by_unemployment(time_period,:)=0
                
        mass_of_renters_by_employment(time_period,:)=0
                
        average_income(time_period,:)=0
        average_housing_costs(time_period,:)=0
        average_consumption(time_period,:)=0
        
        average_house_inheritance(time_period,:)=0
        average_house_non_inheritance(time_period,:)=0
        
        mass_inheritance(time_period,:)=0
        mass_non_inheritance(time_period,:)=0
        
        welfare_by_employment_and_tenure(time_period,:,:)=0
        wealth_by_employment_and_tenure(time_period,:,:)=0
        consumption_by_employment_and_tenure(time_period,:,:)=0
        housing_by_employment_and_tenure(time_period,:,:)=0
        mortgage_by_employment_and_tenure(time_period,:,:)=0
        mortgage_by_employment(time_period,:)=0
        mass_by_mortgage_and_employment(time_period,:)=0
        mass_by_employment_and_tenure(time_period,:,:)=0
        
        welfare_by_employment_tenure_and_age(time_period,:,:,:)=0
        mortgage_by_employment_tenure_and_age(time_period,:,:,:)=0
        mass_by_employment_tenure_and_age(time_period,:,:,:)=0
        
        welfare_by_ownership_status(time_period,:,:)=0
        mass_by_ownership_status(time_period,:,:)=0
        
        mortgage_to_house_value_ratio_of_owners_by_age(time_period,:)=0
        mass_mortgage_to_house_value_ratio_of_owners_by_age(time_period,:)=0
        
        model_LTV_by_age_group(time_period,:)=0
        mass_LTV_by_age_group(time_period,:)=0
        model_homeownership_by_age_group(time_period,:)=0
        mass_by_age_group(time_period,:)=0
        
        do age_index=1,life_span
                    
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
            
            end if
                            
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                                                            
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        do voucher_index=0,(1-has_house)*include_vouchers
                    
                            avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                                (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                                            
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                                
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                             
                                    amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                
                                    financial_index_used=policy_function_financial_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    MID_used=policy_function_mortgage_interest_deductions(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                                                                
                                    consumption_used=policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    frac_spent_on_addiction_used=policy_function_frac_spent_on_addiction&
                                        (years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    value_function_used=value_function(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)  
                                                                                    
                                    welfare_by_age(time_period,age_index)=&
                                        welfare_by_age(time_period,age_index)+value_function_used*distribution_mass_used
                                        
                                    welfare_by_employment_and_age(time_period,employment_index,age_index)=&
                                        welfare_by_employment_and_age(time_period,employment_index,age_index)+&
                                        value_function_used*distribution_mass_used
                                        
                                    if (unemployment_index<=threshold_addiction_index) then
                                    
                                        index_addiction_1=1
                                    
                                    else
                                    
                                        index_addiction_1=2
                                        
                                    end if
                                    
                                    welfare_by_age_and_addiction(time_period,age_index,index_addiction_1-1)=&
                                        welfare_by_age_and_addiction(time_period,age_index,index_addiction_1-1)+&
                                        value_function_used*distribution_mass_used
                                        
                                    mass_by_age_and_addiciton(time_period,age_index,index_addiction_1-1)=&
                                        mass_by_age_and_addiciton(time_period,age_index,index_addiction_1-1)+&
                                        distribution_mass_used
                                    
                                    welfare_by_addiction(time_period,index_addiction_1)=&
                                        welfare_by_addiction(time_period,index_addiction_1)+&
                                        value_function_used*distribution_mass_used
                                            
                                    mass_by_addiction(time_period,index_addiction_1)=&
                                        mass_by_addiction(time_period,index_addiction_1)+distribution_mass_used
                                        
                                    is_homeless_1=1
                                        
                                    if (housing_status_index==lowest_housing_grid_point) then
                                    
                                        is_homeless_1=2
                                        
                                    end if
                                    
                                    welfare_by_homelessness(time_period,is_homeless_1)=&
                                        welfare_by_homelessness(time_period,is_homeless_1)+&
                                        value_function_used*distribution_mass_used
                                    
                                    mass_by_homelessness(time_period,is_homeless_1)=&
                                        mass_by_homelessness(time_period,is_homeless_1)+distribution_mass_used
                                    
                                        
                                    if (age_index==1) then
                                    
                                        welfare_by_addiction_youngest(time_period,index_addiction_1)=&
                                            welfare_by_addiction_youngest(time_period,index_addiction_1)+&
                                            value_function_used*distribution_mass_used
                                            
                                        if ((value_function_used<lowest_welfare_of_addicted(time_period,1)) .AND. &
                                           (distribution_mass_used>0)) then
                                        
                                            lowest_welfare_of_addicted(time_period,1)=value_function_used
                                            lowest_welfare_of_addicted(time_period,2)=distribution_mass_used
                                            lowest_welfare_of_addicted(time_period,3)=unemployment_index
                                            lowest_welfare_of_addicted(time_period,4)=employment_index
                                            lowest_welfare_of_addicted(time_period,5)=financial_index
                                            lowest_welfare_of_addicted(time_period,6)=amortization_used
                                            lowest_welfare_of_addicted(time_period,7)=housing_status_index_used
                                            lowest_welfare_of_addicted(time_period,8)=financial_index_used
                                            lowest_welfare_of_addicted(time_period,9)=labor_supply_used
                                            lowest_welfare_of_addicted(time_period,10)=frac_spent_on_addiction_used
                                            lowest_welfare_of_addicted(time_period,11)=consumption_used                                        
                                            
                                        end if
                                            
                                        mass_by_addiction_youngest(time_period,index_addiction_1)=&
                                            mass_by_addiction_youngest(time_period,index_addiction_1)+distribution_mass_used
                                            
                                    end if
                                                                                
                                    mass_by_age(time_period,age_index)=mass_by_age(time_period,age_index)+&
                                        distribution_mass_used
                                                                            
                                    mass_by_employment_and_age(time_period,employment_index,age_index)=&
                                        mass_by_employment_and_age(time_period,employment_index,age_index)+&
                                        distribution_mass_used
                                                                        
                                    employment_index_to_use=employment_index

                                    if (age_index<=9) then
                                        
                                        l=1
                                        
                                    elseif (age_index<=19) then
                                    
                                        l=2
                                    
                                    elseif (age_index<=29) then
                                    
                                        l=3
                                    
                                    elseif (age_index<=39) then
                                    
                                        l=4
                                    
                                    elseif (age_index>39) then
                                    
                                        l=5
                                    
                                    end if

                                    mass_by_age_group(time_period,l)=mass_by_age_group(time_period,l)+&
                                        distribution_mass_used
                                                                                                                                                            
                                    if (amortization_used>=2) then
                                
                                        mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)=&
                                            mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)-&
                                            min(financial_grid(financial_index_used),0.d0)*&
                                            distribution_mass_used
                                                                                
                                        model_LTV_by_age_group(time_period,l)=model_LTV_by_age_group(time_period,l)-&
                                            min(financial_grid(financial_index_used),0.d0)*&
                                            distribution_mass_used
                                        
                                        mass_LTV_by_age_group(time_period,l)=mass_LTV_by_age_group(time_period,l)+&
                                            distribution_mass_used
                                                                                    
                                        mass_mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)=&
                                            mass_mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)+&
                                            distribution_mass_used
                                            
                                        model_homeownership_by_age_group(time_period,l)=&
                                            model_homeownership_by_age_group(time_period,l)+&
                                            distribution_mass_used
                                                                                    
                                    end if                                      
                                        
                                    welfare_by_employment(time_period,employment_index_to_use)=&
                                        welfare_by_employment(time_period,employment_index_to_use)+&
                                        value_function_used*distribution_mass_used
                                        
                                    welfare_by_unemployment(time_period,unemployment_index)=&
                                        welfare_by_unemployment(time_period,unemployment_index)+&
                                        value_function_used*distribution_mass_used
                                        
                                    mass_by_unemployment(time_period,unemployment_index)=&
                                        mass_by_unemployment(time_period,unemployment_index)+distribution_mass_used
                                        
                                    if (years_left_on_mortgage_index<=1) then
                                    
                                        mass_of_renters_by_employment(time_period,employment_index_to_use)=&
                                            mass_of_renters_by_employment(time_period,employment_index_to_use)+&
                                            distribution_mass_used
                                                                            
                                    end if
                                        
                                    if (age_index==1) then
                                    
                                        welfare_by_employment_youngest(time_period,employment_index_to_use)=&
                                            welfare_by_employment_youngest(time_period,employment_index_to_use)+&
                                            value_function_used*distribution_mass_used
                                            
                                        mass_by_employment_youngest(time_period,employment_index_to_use)=&
                                            mass_by_employment_youngest(time_period,employment_index_to_use)+&
                                            distribution_mass_used
                                    
                                    end if
                                        
                                    MID_share_by_employment(time_period,employment_index_to_use)=&
                                        MID_share_by_employment(time_period,employment_index_to_use)+&
                                        MID_used*distribution_mass_used
                                        
                                    wealth_by_employment(time_period,employment_index_to_use)=&
                                        wealth_by_employment(time_period,employment_index_to_use)+&
                                        (housing_price(time_period)*housing_size(housing_status_index)*&
                                        (max(min(years_left_on_mortgage_index-1,1),0)+&
                                        min(financial_grid(financial_index),0.d0))+&
                                        max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                        
                                    if (in_retirement==1) then
                                    
                                        average_income(time_period,employment_index_to_use)=&
                                            average_income(time_period,employment_index_to_use)+&
                                            model_ss_benefits(employment_index)*distribution_mass_used
                                    
                                    else
                                    
                                        if ((unemployment_index==1) .OR. &
                                            (unemployment_index==threshold_addiction_index+1)) then
                                        
                                            average_income(time_period,employment_index_to_use)=&
                                                average_income(time_period,employment_index_to_use)+&
                                                (labor_supply_used*employment_grid(age_index,employment_index)*&
                                                labour_deterministic_efficiency(age_index))*distribution_mass_used
                                                
                                        elseif ((unemployment_index==threshold_addiction_index) .OR. &
                                            (unemployment_index==unemployment_grid_size)) then
                                                                                
                                            average_income(time_period,employment_index_to_use)=&
                                                average_income(time_period,employment_index_to_use)+&
                                                min(replacement_rate_ui*avg_income_to_use_2,&
                                                max_ui_as_perc_of_avg_inc*avg_income_to_use_1)*distribution_mass_used
                                                                  
                                        end if
                                    
                                    end if
                                    
                                    average_income(time_period,employment_index_to_use)=&
                                        average_income(time_period,employment_index_to_use)+&
                                        (max(financial_grid(financial_index),0.d0)*&
                                        risk_free_rate(time_period)+lump_sum_transfer(time_period))*&
                                        distribution_mass_used
                                        
                                    if (age_index==1) then
                                    
                                        if (years_left_on_mortgage_index>1) then
                                        
                                            average_house_inheritance(time_period,employment_index_to_use)=&
                                                average_house_inheritance(time_period,employment_index_to_use)+&
                                                housing_size(housing_status_index)*distribution_mass_used
                                                
                                            mass_inheritance(time_period,employment_index_to_use)=&
                                                mass_inheritance(time_period,employment_index_to_use)+distribution_mass_used
                                        
                                        end if
                                        
                                        average_house_non_inheritance(time_period,employment_index_to_use)=&
                                            average_house_non_inheritance(time_period,employment_index_to_use)+&
                                            max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                            
                                        mass_non_inheritance(time_period,employment_index_to_use)=&
                                            mass_non_inheritance(time_period,employment_index_to_use)+distribution_mass_used
                                                                        
                                    end if
                                        
                                    if (financial_grid(financial_index)<0) then
                                        
                                        fraction_with_mortgage(time_period,employment_index_to_use)=&
                                            fraction_with_mortgage(time_period,employment_index_to_use)+distribution_mass_used
                                            
                                    end if
                                    
                                    average_consumption(time_period,employment_index_to_use)=&
                                        average_consumption(time_period,employment_index_to_use)+&
                                        consumption_used*distribution_mass_used
                                        
                                    if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                       (have_two_rental_markets==0)) then
                                    
                                        low_quality_market=0
                                    
                                    else
                                    
                                        low_quality_market=1
                                    
                                    end if
                                    
                                    if (amortization_used<=1) then
                                    
                                        fraction_renters_by_employment(time_period,employment_index_to_use)=&
                                            fraction_renters_by_employment(time_period,employment_index_to_use)+&
                                            distribution_mass_used

                                        average_housing_costs(time_period,employment_index_to_use)=&
                                            average_housing_costs(time_period,employment_index_to_use)+&
                                            rent(time_period,low_quality_market)*lived_in_size_used*&
                                            distribution_mass_used
                                                                                
                                    else
                                    
                                        average_age_of_homeowner(time_period,employment_index_to_use)=&
                                            average_age_of_homeowner(time_period,employment_index_to_use)+age_index*&
                                            distribution_mass_used
                                            
                                        average_housing_costs(time_period,employment_index_to_use)=&
                                            average_housing_costs(time_period,employment_index_to_use)+&
                                            (housing_price(time_period)*housing_size(housing_status_index)*&
                                            (property_tax(time_period)+housing_depreciation_rate)-&
                                            min(financial_grid(financial_index),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)*&
                                            mortgage_interest_rate(time_period)-MID_used)*distribution_mass_used
                                            
                                    end if
                                    
                                    mass_by_employment(time_period,employment_index_to_use)=&
                                        mass_by_employment(time_period,employment_index_to_use)+distribution_mass_used
                                                                         
                                    if (years_left_on_mortgage_index<=1) then
                                    
                                        i=1
                                        
                                    elseif (years_left_on_mortgage_index==3) then
                                    
                                        i=2
                                        
                                    else
                                    
                                        i=3
                                    
                                    end if
                                    
                                    if (age_index==1) then
                                    
                                        welfare_by_employment_youngest_old_dist(time_period,employment_index_to_use)=&
                                            welfare_by_employment_youngest_old_dist(time_period,employment_index_to_use)+&
                                            value_function_used*distribution_mass_used
                                            
                                    end if
                                                                                
                                    mass_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                        mass_by_employment_and_tenure(time_period,employment_index_to_use,i)+distribution_mass_used
                                    
                                    if (value_function_used>-200000) then
                                    
                                        welfare_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                            welfare_by_employment_and_tenure(time_period,employment_index_to_use,i)+&
                                            value_function_used*distribution_mass_used
                                            
                                        wealth_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                            wealth_by_employment_and_tenure(time_period,employment_index_to_use,i)+&
                                            housing_price(time_period)*housing_size(housing_status_index)*&
                                            (max(min(years_left_on_mortgage_index-1,1),0)+&
                                            min(financial_grid(financial_index),0.d0)+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                            
                                        consumption_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                            consumption_by_employment_and_tenure(time_period,employment_index_to_use,i)+&
                                            consumption_used*distribution_mass_used
                                            
                                        housing_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                            housing_by_employment_and_tenure(time_period,employment_index_to_use,i)+&
                                            lived_in_size_used*distribution_mass_used
                                            
                                        mortgage_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                            mortgage_by_employment_and_tenure(time_period,employment_index_to_use,i)-&
                                            min(financial_grid(financial_index),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)*&
                                            distribution_mass_used
                                            
                                        if (financial_grid(financial_index)<0) then
                                        
                                            mortgage_by_employment(time_period,employment_index_to_use)=&
                                                mortgage_by_employment(time_period,employment_index_to_use)-&
                                                min(financial_grid(financial_index),0.d0)*&
                                                housing_price(time_period)*housing_size(housing_status_index)*&
                                                distribution_mass_used
                                                
                                            mass_by_mortgage_and_employment(time_period,employment_index_to_use)=&
                                                mass_by_mortgage_and_employment(time_period,employment_index_to_use)+&
                                                distribution_mass_used
                                        
                                        end if
                                                                                    
                                        age_group=int(floor(real(age_index)/real(10))+1)
                                            
                                        welfare_by_employment_tenure_and_age(time_period,employment_index_to_use,i,age_group)=&
                                            welfare_by_employment_tenure_and_age(time_period,employment_index_to_use,i,age_group)+&
                                            value_function_used*distribution_mass_used
                                                                                
                                        mortgage_by_employment_tenure_and_age(time_period,employment_index_to_use,i,age_group)=&
                                            mortgage_by_employment_tenure_and_age(time_period,employment_index_to_use,i,age_group)-&
                                            min(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                
                                        mass_by_employment_tenure_and_age(time_period,employment_index_to_use,i,age_group)=&
                                            mass_by_employment_tenure_and_age(time_period,employment_index_to_use,i,age_group)+&
                                            distribution_mass_used
                                            
                                    end if
                                    
                                    if (age_index==1) then
                                                                                                                                                                            
                                        welfare_by_ownership_status(time_period,max(min(amortization_used-1,1),0),&
                                            employment_index_to_use)=welfare_by_ownership_status(time_period,max(min(&
                                            amortization_used-1,1),0),employment_index_to_use)+value_function_used*&
                                            distribution_mass_used
                                                                            
                                        mass_by_ownership_status(time_period,max(min(amortization_used-1,1),0),&
                                            employment_index_to_use)=mass_by_ownership_status(time_period,max(min(&
                                            amortization_used-1,1),0),employment_index_to_use)+distribution_mass_used
                                                                                     
                                    end if
                                
                                end do
                                
                            end do
                            
                        end do
                        
                    end do
                                                    
                end do
                                    
            end do
            
        end do
        
        welfare_by_homelessness(time_period,:)=&
            welfare_by_homelessness(time_period,:)/mass_by_homelessness(time_period,:)
        
        do age_index=1,life_span
                
            welfare_by_age(time_period,age_index)=welfare_by_age(time_period,age_index)/&
                mass_by_age(time_period,age_index)
                
            welfare_by_age_and_addiction(time_period,age_index,:)=&
                welfare_by_age_and_addiction(time_period,age_index,:)/mass_by_age_and_addiciton(time_period,age_index,:)
                                    
        end do
        
        do age_index=1,life_span
        
            do employment_index=1,employment_grid_size
                
                welfare_by_employment_and_age(time_period,employment_index,age_index)=&
                    welfare_by_employment_and_age(time_period,employment_index,age_index)/&
                    mass_by_employment_and_age(time_period,employment_index,age_index)
                    
            end do
                                    
        end do    
        
        do i=1,2
        
            welfare_by_addiction(time_period,i)=welfare_by_addiction(time_period,i)/mass_by_addiction(time_period,i)
            welfare_by_addiction_youngest(time_period,i)=welfare_by_addiction_youngest(time_period,i)/&
                mass_by_addiction_youngest(time_period,i)
            
        end do
                            
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        do age_index=1,life_span
        
            mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)=&
                mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)/&
                mass_mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)
        
        end do
        
        do age_index=1,life_span
        
            mass_mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)=&
                mass_mortgage_to_house_value_ratio_of_owners_by_age(time_period,age_index)/&
                sum_of_distribution
        
        end do
        
        do i=1,5 
        
            model_LTV_by_age_group(time_period,i)=model_LTV_by_age_group(time_period,i)/&
                mass_LTV_by_age_group(time_period,i)
                
            model_homeownership_by_age_group(time_period,i)=&
                model_homeownership_by_age_group(time_period,i)/mass_by_age_group(time_period,i)
        
        end do
                
        do employment_index=1,employment_grid_size
                
            welfare_by_employment(time_period,employment_index)=welfare_by_employment(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            welfare_by_employment_youngest_old_dist(time_period,employment_index)=&
                welfare_by_employment_youngest_old_dist(time_period,employment_index)/&
                mass_by_employment_and_age(time_period,employment_index,1)
                                
            welfare_by_employment_youngest(time_period,employment_index)=&
                welfare_by_employment_youngest(time_period,employment_index)/&
                mass_by_employment_youngest(time_period,employment_index)
                
            MID_share_by_employment(time_period,employment_index)=MID_share_by_employment(time_period,employment_index)/&
                govt_spending_on_mortgage_interest_deductions(time_period)
                
            wealth_by_employment(time_period,employment_index)=wealth_by_employment(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            fraction_with_mortgage(time_period,employment_index)=fraction_with_mortgage(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            fraction_renters_by_employment(time_period,employment_index)=&
                fraction_renters_by_employment(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            average_age_of_homeowner(time_period,employment_index)=average_age_of_homeowner(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            average_income(time_period,employment_index)=average_income(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            average_housing_costs(time_period,employment_index)=average_housing_costs(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            average_consumption(time_period,employment_index)=average_consumption(time_period,employment_index)/&
                mass_by_employment(time_period,employment_index)
                
            average_house_inheritance(time_period,employment_index)=average_house_inheritance(time_period,employment_index)/&
                mass_inheritance(time_period,employment_index)
                
            average_house_non_inheritance(time_period,employment_index)=&
                average_house_non_inheritance(time_period,employment_index)/&
                mass_non_inheritance(time_period,employment_index)
                                                
        end do
                   
        do employment_index=1,employment_grid_size
        
            mortgage_by_employment(time_period,employment_index)=mortgage_by_employment(time_period,employment_index)/&
                mass_by_mortgage_and_employment(time_period,employment_index)
        
            do years_left_on_mortgage_index=1,3
            
                welfare_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)=&
                    welfare_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)/&
                    mass_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)
                    
                wealth_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)=&
                    wealth_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)/&
                    mass_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)
                    
                consumption_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)=&
                    consumption_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)/&
                    mass_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)
                    
                housing_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)=&
                    housing_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)/&
                    mass_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)
                    
                mortgage_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)=&
                    mortgage_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)/&
                    mass_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)
            
            end do
            
        end do
        
        do age_index=1,int((real(life_span)/real(10)))
        
            do employment_index=1,employment_grid_size
            
                do years_left_on_mortgage_index=1,3
                                
                    welfare_by_employment_tenure_and_age(time_period,employment_index,years_left_on_mortgage_index,age_index)=&
                        welfare_by_employment_tenure_and_age(time_period,employment_index,years_left_on_mortgage_index,age_index)/&
                        mass_by_employment_tenure_and_age(time_period,employment_index,years_left_on_mortgage_index,age_index)
                        
                    mortgage_by_employment_tenure_and_age(time_period,employment_index,years_left_on_mortgage_index,age_index)=&
                        mortgage_by_employment_tenure_and_age(time_period,employment_index,years_left_on_mortgage_index,age_index)/&
                        mass_by_employment_tenure_and_age(time_period,employment_index,years_left_on_mortgage_index,age_index)
                                        
                end do
                
            end do
            
        end do
        
        do k=0,1
        
            do employment_index=1,employment_grid_size
                    
                welfare_by_ownership_status(time_period,k,employment_index)=&
                    welfare_by_ownership_status(time_period,k,employment_index)/&
                    mass_by_ownership_status(time_period,k,employment_index)
                                                                        
            end do
        
        end do
        
        do unemployment_index=1,unemployment_grid_size
        
            welfare_by_unemployment(time_period,unemployment_index)=&
                welfare_by_unemployment(time_period,unemployment_index)/&
                mass_by_unemployment(time_period,unemployment_index)    
        
        end do
        
    end subroutine
    
    subroutine calculate_welfare_gains(time_period,welfare_to_compare_1,type_1,x_1)

        use Global_Vars
        use, intrinsic :: ieee_arithmetic
        implicit none

        integer, intent(in) :: time_period
        integer, intent(in) :: type_1
        real(8), intent(in) :: welfare_to_compare_1
        real(8), intent(inout) :: x_1

        real(8) :: stopping_rule_1, x_0, x_2, distance_1
        real(8) :: welfare_adjusted_1, w0, w2
        character*1 :: string_used
               
        vf_simulation='baseline_benchmark'
                   
        write(*,*) "vf_simulation=", vf_simulation

        stopping_rule_1 = 10.d0**(-4)

        if (already_uploaded_benchmark==0) then
            do i=1,2
                write(string_used,'(i1)') i

                open(unit=10,file="distribution_stationary"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(F30.28)') distribution_stationary_benchmark(i)%vector_real(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="value_function"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(F35.13)') value_function_benchmark(i)%vector_real(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_frac_spent_on_addiction"//&
                    trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(F25.20)') policy_function_frac_spent_on_addiction_benchmark(i)%vector_real(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_total_consumption"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(F26.20)') policy_function_total_consumption_benchmark(i)%vector_real(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_labor_supply"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(F22.20)') policy_function_labor_supply_benchmark(i)%vector_real(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_housing_status_index"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(I2)') policy_function_housing_status_index_benchmark(i)%vector_integer(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_years_of_amortization_index"//&
                    trim(string_used)//trim(vf_simulation)//".dat", action='read')
                    read(10,'(I2)') policy_function_years_of_amortization_index_benchmark(i)%vector_integer(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_addiction"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(I1)') policy_function_addiction_benchmark(i)%vector_integer(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="policy_function_financial_index"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(I3)') policy_function_financial_index_benchmark(i)%vector_integer(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="fin_index_frac_mov_to_optimal"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(I3)') fin_index_frac_mov_to_optimal_benchmark(i)%vector_integer(:,:,:,:,:,:)
                close(10)

                open(unit=10,file="frac_mov_optimal_1"//trim(string_used)//trim(vf_simulation)//".dat", &
                     action='read')
                    read(10,'(F22.20)') frac_mov_optimal_1_benchmark(i)%vector_real(:,:,:,:,:,:)
                close(10)

            end do
            already_uploaded_benchmark=1
        end if

        x_0 = -0.5d0
        x_2 =  0.5d0

        call compute_value_function_comparison(time_period, x_0)
        call compute_value_of_comparison(w0, type_1)

        call compute_value_function_comparison(time_period, x_2)
        call compute_value_of_comparison(w2, type_1)

        if (ieee_is_nan(w0) .or. ieee_is_nan(w2)) then
            write(*,*) "NaN welfare at bracket endpoints."
            stop
        end if

        if ( (welfare_to_compare_1 < min(w0,w2)) .or. (welfare_to_compare_1 > max(w0,w2)) ) then
            write(*,*) "target welfare not bracketed by x in [-1,1]."
            write(*,*) "w0=", w0, " w2=", w2, " target=", welfare_to_compare_1
            stop
        end if

        x_1 = 0.5d0*(x_0 + x_2)
        distance_1 = abs(x_2 - x_0)
        
        do while (distance_1 > stopping_rule_1)

            call compute_value_function_comparison(time_period, x_1)
            call compute_value_of_comparison(welfare_adjusted_1, type_1)

            if (ieee_is_nan(welfare_adjusted_1)) then
                write(*,*) "NaN welfare at x=", x_1
                stop
            end if

            if (welfare_adjusted_1 < welfare_to_compare_1) then
                x_0 = x_1
            else
                x_2 = x_1
            end if

            x_1 = 0.5d0*(x_0 + x_2)
            distance_1 = abs(x_2 - x_0)

            write(*,*) "x_1=", x_1, " distance_1=", distance_1, " welfare_adjusted_1=", welfare_adjusted_1

        end do

    end subroutine

    subroutine compute_value_function_comparison(time_period,x_1)

        use global_vars
        use, intrinsic :: ieee_arithmetic

        implicit none

        integer, intent(in) :: time_period
        integer :: financial_index,has_house,track_housing_1,is_homeless_1,&
            addiction_index_1,financial_index_1,years_1,housing_1,financial_index_2,loop_over_addiction_1,&
            addiction_used_1,check_1,is_addicted_1,first_voucher_index,second_voucher_index,&
            has_opportunity_1,voucher_index_1

        real(8) :: total_consumption_1,consumption_1,fraction_spent_on_addiction_1,distribution_1,income_1,&
            flow_utility_1,labor_supply_1,frac_move_1,avg_income_to_use_1,avg_income_to_use_2
        real(8), intent(in) :: x_1

        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)

        do i=1,2
            value_function_comparison(i)%vector_real(:,:,:,:,:,:)=0.d0
        end do

        do age_index=life_span,1,-1

            if (age_index>life_span-retirement_span) then
                in_retirement=1
            else
                in_retirement=0
            end if

            if (age_index>=(life_span-retirement_span)) then
                at_least_one_period_before_retirement=1
            else
                at_least_one_period_before_retirement=0
            end if

            if (age_index==1) then
                newborn_household=1
            else
                newborn_household=0
            end if

            do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years

                if (years_left_on_mortgage_index>1) then
                    has_house=1
                else
                    has_house=0
                end if

                track_housing_1=1
                if (has_house==0) then
                    if (track_renters_housing==0) then
                        track_housing_1=0
                    end if
                end if

                do unemployment_index=1,unemployment_grid_size
                    do employment_index=1,employment_grid_size

                        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)

                        do voucher_index=0,(1-has_house)*include_vouchers

                            do financial_index=newborn_household*negative_financial_grid_size+&
                                 (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                 include_exogenous_endowment*financial_grid_size+(1-include_exogenous_endowment)*&
                                 (newborn_household*negative_financial_grid_size+(1-newborn_household)*financial_grid_size)

                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,&
                                    track_housing_1*(1-newborn_household)*(housing_status_grid_size-1)

                                    years_1=policy_function_years_of_amortization_index_benchmark&
                                        (years_left_on_mortgage_index)%vector_integer(age_index,&
                                        financial_index,unemployment_index,employment_index,&
                                        housing_status_index,voucher_index)

                                    if (years_1>1) then
                                        choose_to_own=1
                                    else
                                        choose_to_own=0
                                    end if

                                    track_housing_2=1
                                    if (choose_to_own==0) then
                                        if (track_renters_housing==0) then
                                            track_housing_2=0
                                        end if
                                    end if

                                    labor_supply_1=policy_function_labor_supply_benchmark&
                                        (years_left_on_mortgage_index)%vector_real&
                                        (age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    total_consumption_1=policy_function_total_consumption_benchmark&
                                        (years_left_on_mortgage_index)%vector_real&
                                        (age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    housing_1=policy_function_housing_status_index_benchmark&
                                        (years_left_on_mortgage_index)%&
                                        vector_integer(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    addiction_used_1=policy_function_addiction_benchmark&
                                        (years_left_on_mortgage_index)%&
                                        vector_integer(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    addiction_index_1=0
                                    loop_over_addiction_1=0

                                    if (unemployment_index>threshold_addiction_index) then
                                        addiction_index_1=1
                                        loop_over_addiction_1=1
                                    elseif ((addiction_used_1==1) .AND. &
                                        (unemployment_index<=threshold_addiction_index) .AND. &
                                        (include_probability_of_becoming_addicted==1)) then
                                        loop_over_addiction_1=1
                                    end if

                                    call calculate_income(unemployment_index,employment_index,income_1,&
                                        avg_income_to_use_1,avg_income_to_use_2,labor_supply_1,in_retirement)

                                    income_1=income_1+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)

                                    future_housing_status_index_to_use_2=housing_1

                                    if (track_housing_2==0) then
                                        if (future_housing_status_index_to_use_2>second_lowest_housing_grid_point) then
                                            future_housing_status_index_to_use_2=0
                                        end if
                                    end if

                                    is_homeless_1=1
                                    if (future_housing_status_index_to_use_2==lowest_housing_grid_point) then
                                        is_homeless_1=2
                                    end if

                                    is_addicted_1=0
                                    if (unemployment_index>threshold_addiction_index) then
                                        is_addicted_1=1
                                    end if

                                    call compute_voucher_index_1(is_homeless_1,voucher_index_1)
                                    call calculate_future_voucher_index_and_opportunity&
                                        (has_opportunity_1,first_voucher_index,second_voucher_index,&
                                        time_period,has_house,choose_to_own,voucher_index_1,income_1)

                                    fraction_spent_on_addiction_1=&
                                        policy_function_frac_spent_on_addiction_benchmark&
                                        (years_left_on_mortgage_index)%&
                                        vector_real(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    financial_index_1=policy_function_financial_index_benchmark&
                                        (years_left_on_mortgage_index)%&
                                        vector_integer(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    financial_index_2=fin_index_frac_mov_to_optimal_benchmark&
                                        (years_left_on_mortgage_index)%&
                                        vector_integer(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    frac_move_1=frac_mov_optimal_1_benchmark(years_left_on_mortgage_index)%&
                                        vector_real(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    distribution_1=distribution_stationary_benchmark(years_left_on_mortgage_index)%&
                                        vector_real(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    consumption_1=(1-fraction_spent_on_addiction_1)*total_consumption_1*(1+x_1)

                                    if (consumption_1>0.d0) then

                                        call calculate_flow_utility(0,housing_1,housing_size(housing_1),&
                                            fraction_spent_on_addiction_1,total_consumption_1,consumption_1,&
                                            choose_to_own,addiction_used_1,flow_utility_1,1)

                                        flow_utility_1=flow_utility_1+relative_share_of_leisure*&
                                            ((max_labor_supply-labor_supply_1)**&
                                            (1-Frisch_elasticity))/(1-Frisch_elasticity)

                                        value_function_comparison(years_left_on_mortgage_index)%&
                                            vector_real(age_index,financial_index,unemployment_index,&
                                            employment_index,housing_status_index,voucher_index)=flow_utility_1

                                        if (age_index<life_span) then

                                            do future_addiction_index_2=&
                                                (1-loop_over_addiction_1)*addiction_used_1+loop_over_addiction_1*0,&
                                                (1-loop_over_addiction_1)*addiction_used_1+loop_over_addiction_1*include_addiction

                                                check_1=0
                                                if (future_addiction_index_2==1) then
                                                    check_1=1
                                                end if

                                                do future_unemployment_index=include_addiction*&
                                                    ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                                                    (1-include_addiction)*&
                                                    (at_least_one_period_before_retirement*unemployment_index+&
                                                    (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                                    ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                                                    (1-include_addiction)*&
                                                    (at_least_one_period_before_retirement*unemployment_index+&
                                                    (1-at_least_one_period_before_retirement)*unemployment_grid_size)

                                                    do future_employment_index=&
                                                        at_least_one_period_before_retirement*employment_index+&
                                                        (1-at_least_one_period_before_retirement)*1,&
                                                        at_least_one_period_before_retirement*employment_index+&
                                                        (1-at_least_one_period_before_retirement)*employment_grid_size

                                                        do future_voucher_index=first_voucher_index,second_voucher_index

                                                            value_function_comparison(years_left_on_mortgage_index)%&
                                                                vector_real(age_index,financial_index,unemployment_index,&
                                                                employment_index,housing_status_index,voucher_index)=&
                                                                value_function_comparison(years_left_on_mortgage_index)%&
                                                                vector_real(age_index,financial_index,unemployment_index,&
                                                                employment_index,housing_status_index,voucher_index)+&
                                                                discount_factor*&
                                                                survival_probability(age_index,is_homeless_1,is_addicted_1)*&
                                                                voucher_probabilities_benchmark(voucher_index,future_voucher_index,&
                                                                has_opportunity_1,voucher_index_1)*employment_process&
                                                                (age_index,employment_index,future_employment_index)*&
                                                                unemployment_process(age_index,unemployment_index,&
                                                                future_unemployment_index,is_homeless_1,&
                                                                future_addiction_index_2,employment_index)*&
                                                                addiction_probabilities_percieved&
                                                                (addiction_index_1,future_addiction_index_2,addiction_used_1,&
                                                                is_homeless_1)*((1-frac_move_1)*&
                                                                value_function_comparison(years_1)%&
                                                                vector_real(age_index+1,financial_index_1,&
                                                                future_unemployment_index,future_employment_index,&
                                                                future_housing_status_index_to_use_2,future_voucher_index)+&
                                                                frac_move_1*value_function_comparison(years_1)%&
                                                                vector_real(age_index+1,financial_index_2,&
                                                                future_unemployment_index,future_employment_index,&
                                                                future_housing_status_index_to_use_2,future_voucher_index))

                                                        end do
                                                    end do
                                                end do
                                            end do

                                        end if

                                    else
                                    
                                        value_function_comparison(years_left_on_mortgage_index)%&
                                            vector_real(age_index,financial_index,unemployment_index,&
                                            employment_index,housing_status_index,voucher_index) = -1.d300
                                    end if

                                end do
                            end do
                        end do
                    end do
                end do

            end do
        end do

    end subroutine

    subroutine compute_value_of_comparison(welfare_adjusted_1,type_1)

        use global_vars
        use, intrinsic :: ieee_arithmetic

        implicit none

        integer :: financial_index,has_house,track_housing_1
        integer, intent(in) :: type_1
        real(8) :: distribution_1,value_function_1,mass_1
        real(8), intent(inout) :: welfare_adjusted_1

        write(*,*) "type_1 loop=", type_1

        welfare_adjusted_1=0.d0
        mass_1=0.d0

        do age_index=1,1

            if (age_index==1) then
                newborn_household=1
            else
                newborn_household=0
            end if

            do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years

                if (years_left_on_mortgage_index>1) then
                    has_house=1
                else
                    has_house=0
                end if

                track_housing_1=1
                if (has_house==0) then
                    if (track_renters_housing==0) then
                        track_housing_1=0
                    end if
                end if

                do unemployment_index=1,unemployment_grid_size
                    do employment_index=1,employment_grid_size
                        do voucher_index=0,(1-has_house)*include_vouchers

                            do financial_index=newborn_household*negative_financial_grid_size+&
                                (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                include_exogenous_endowment*financial_grid_size+(1-include_exogenous_endowment)*&
                                (newborn_household*negative_financial_grid_size+(1-newborn_household)*financial_grid_size)

                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,&
                                    track_housing_1*(1-newborn_household)*(housing_status_grid_size-1)

                                    value_function_1=value_function_comparison(years_left_on_mortgage_index)%&
                                        vector_real(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    distribution_1=distribution_stationary_benchmark&
                                        (years_left_on_mortgage_index)%vector_real&
                                        (age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)

                                    if (distribution_1>0.d0) then
                                        select case (type_1)
                                        case (1)
                                            welfare_adjusted_1=welfare_adjusted_1+value_function_1*distribution_1
                                            mass_1=mass_1+distribution_1
                                        case (2)
                                            if (unemployment_index>threshold_addiction_index) then
                                                welfare_adjusted_1=welfare_adjusted_1+value_function_1*distribution_1
                                                mass_1=mass_1+distribution_1
                                            end if
                                        case (3)
                                            if (unemployment_index<=threshold_addiction_index) then
                                                welfare_adjusted_1=welfare_adjusted_1+value_function_1*distribution_1
                                                mass_1=mass_1+distribution_1
                                            end if
                                        end select
                                    end if

                                end do
                            end do
                        end do
                    end do
                end do

            end do
        end do

        if (mass_1 > 0.d0) then
            welfare_adjusted_1 = welfare_adjusted_1 / mass_1
        else
            welfare_adjusted_1 = ieee_value(welfare_adjusted_1, ieee_quiet_nan)
        end if

        write(*,*) "welfare_adjusted_1=", welfare_adjusted_1
        write(*,*) "mass_1=", mass_1

    end subroutine

    subroutine calculate_homeownership_by_characteristics(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        integer :: has_house,financial_index,time_period_used,amortization_used,housing_status_index_used,&
            employment_index_to_use,low_quality_market,age_group_1,addiction_choice_2,is_using_drugs,financial_index_used_1,&
            fin_financial_index_move_to_used_1
        real(8) :: distribution_mass_used,lived_in_size_used,consumption_used,total_income,MID_used,&
            total_MID_value,labor_supply_used,avg_income_to_use_1,avg_income_to_use_2,rent_to_income_to_use,&
            addiction_consumption_1,total_consumption_used,bequest_2,income_taxes_paid_used,food_stamps_1,assets_1,&
            avg_net_wealth_to_use_1,frac_next_1,savings_1,total_income_1,mass_of_addicts,financial_income_1,home_equity_1

        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                        
        time_period_used=time_period-solve_transition_dynamics
        
        homeownership_by_employment(time_period,:)=0
        tenure_by_employment(time_period,:,:)=0
        tenure_by_income_quintile(time_period,:,:)=0
        rent_burden_by_income_quintile(time_period,:)=0
        MID_share_by_income_quintile(time_period,:)=0
        mass_by_income_quintile(time_period,:)=0
        MID_itemizers_by_income_quintile(time_period,:)=0
        housing_size_by_employment(time_period,:)=0
        housing_size_by_employment_and_tenure(time_period,:,:)=0
        mass_by_tenure_and_employment(time_period,:,:)=0
        housing_size_by_employment_and_age(time_period,:,:)=0
        consumption_by_employment_and_age(time_period,:,:)=0
        wealth_by_employment_and_age(time_period,:,:)=0
        mass_by_employment(time_period,:)=0
        mass_by_employment_and_age(time_period,:,:)=0
        homeownership_by_age(time_period,:)=0
        model_assets_by_age(time_period,:)=0
        housing_size_by_age(time_period,:)=0
        mass_by_age(time_period,:)=0
        homelessness_by_age(time_period,:)=0
        homelessness_by_age_group(time_period,:)=0
        
        wealth_by_age_renter(time_period,:)=0
        income_by_age_renter(time_period,:)=0
        consumption_by_age_renter(time_period,:)=0
        consumption_by_age(time_period,:)=0
        housing_consumption_by_age_renter(time_period,:)=0
        mass_by_age_and_renter(time_period,:)=0
        
        model_drug_use_by_income_quintile(time_period,:)=0
        mass_by_income_quintile_1(time_period,:)=0

        profile_by_income_quintile(time_period,:,:,:)=0
        mass_by_income_quintile_2(time_period,:,:)=0
        
        model_addicts_consuming_no_drugs(time_period)=0
        mass_of_addicts=0
        
        total_MID_value=0
        
        if (simulation_ended==(compute_income_cdf+(1-compute_income_cdf)*1)) then
        
            if (is_counterfactual==0) then
        
                call calculate_cdf_of_incomes_earned(time_period,life_span)
                
            end if
        
        end if
        
        do age_index=1,life_span
                    
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                                
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
                                (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                                    
                        if (inheritance_function_of_productivity==1) then
                        
                            bequest_2=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
                        
                        else
                                                    
                            call calculate_bequest_amount(age_index,bequest_2,employment_index)
                            
                        end if

                        do voucher_index=0,(1-has_house)*include_vouchers
                                                    
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                    
                                    financial_index_used_1=policy_function_financial_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)  
                                        
                                    fin_financial_index_move_to_used_1=&
                                        fin_index_frac_mov_to_optimal(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)  
                                        
                                    frac_next_1=frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                        
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                            
                                    amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                
                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    total_consumption_used=policy_function_total_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                            
                                    consumption_used=policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                                
                                    income_taxes_paid_used=policy_function_wage_income_tax_paid(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    MID_used=policy_function_mortgage_interest_deductions(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                                
                                    addiction_choice_2=&
                                        policy_function_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    addiction_consumption_1=addiction_choice_2*&
                                        max(total_consumption_used-consumption_used,0.d0)
                                                                            
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index) 
                                        
                                    employment_index_to_use=employment_index
                                
                                    if (years_left_on_mortgage_index==1) then
                                    
                                        i=1
                                        
                                    elseif (years_left_on_mortgage_index==2) then
                                    
                                        if (financial_grid(financial_index)<0) then
                                    
                                            i=2
                                            
                                        else
                                        
                                            i=3
                                            
                                        end if
                                        
                                    end if
                                    
                                    if (unemployment_index>threshold_addiction_index) then
                                    
                                        mass_of_addicts=mass_of_addicts+distribution_mass_used
                                            
                                        if (addiction_consumption_1==0) then
                                        
                                            model_addicts_consuming_no_drugs(time_period)=&
                                                model_addicts_consuming_no_drugs(time_period)+&
                                                distribution_mass_used
                                        
                                        end if
                                    
                                    end if
                                    
                                    if (simulation_ended==(compute_income_cdf+(1-compute_income_cdf)*1)) then
                                                    
                                        call calculate_income(unemployment_index,employment_index,total_income,&
                                            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)
                                            
                                        total_income_1=total_income
                                            
                                        food_stamps_1=0
                                        assets_1=0
                                        avg_net_wealth_to_use_1=1
                                    
                                        ! If they have no assets, they get can qualift for food stamps
                                        if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*&
                                            avg_net_wealth_to_use_1) then
                                                                                        
                                            food_stamps_1=max((max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                                                (total_income+max(financial_grid(financial_index),0.d0)*&
                                                risk_free_rate(time_period))),0.d0)
                                                                        
                                        end if
                                        
                                        home_equity_1=max(years_left_on_mortgage_index-1,0)*housing_price(time_period)*&
                                            housing_size(housing_status_index)*(1+min(financial_grid(financial_index),0.d0))
                                        
                                        financial_income_1=risk_free_rate(time_period)*&
                                            max(financial_grid(financial_index),0.d0)
                                                          
                                        total_income=total_income+bequest_2
                                            
                                        if (use_income_or_income_plus_assets==2) then
                                        
                                            total_income=total_income+financial_income_1+max(financial_grid(financial_index),0.d0)
                                            
                                        elseif (use_income_or_income_plus_assets<=4) then
                                        
                                            total_income=total_income+financial_income_1
!                                                +&
!                                                max(financial_grid(financial_index),0.d0)-&
!                                                income_taxes_paid_used-financial_income_1*investment_income_tax
                                            
                                        end if
                                        
                                        if (use_income_or_income_plus_assets==4) then
                                        
                                            total_income=total_income+home_equity_1
                                        
                                        end if
                                        
                                        if (((in_retirement==1) .AND. (include_retirees_in_income_cdf==1)) .OR. &
                                            (in_retirement==0)) then
                                            
                                            j=number_of_quintiles
                                            
                                            quintile_loop: do k=1,number_of_quintiles-1
                                            
                                                if (total_income<=income_cutoffs_of_quintiles(k)) then
                                            
                                                    j=k
                                                    
                                                    exit quintile_loop
                                                
                                                end if
                                            
                                            end do quintile_loop
                                                                                                                                
                                            if (unemployment_index<=threshold_addiction_index) then
                                            
!                                                x=after_tax_wealth_net_of_expenses_1-&
!                                                    ((frac_used*min(financial_grid(fin_index_frac_used),0.d0)+&
!                                                    (1-frac_used)*min(financial_grid(financial_index_used),0.d0))*&
!                                                    max(amortization_used-1,0)*housing_price(time_period)*housing_size(housing_status_index_used)+&
!                                                    frac_used*max(financial_grid(fin_index_frac_used),0.d0)+&
!                                                    (1-frac_used)*max(financial_grid(financial_index_used),0.d0)+&            
!                                                    (1+consumption_tax)*(consumption_used+frac_spent_on_addiction_used*total_consumption_used))
                                            
                                                mass_by_income_quintile_1(time_period,j)=&
                                                    mass_by_income_quintile_1(time_period,j)+distribution_mass_used
                                                
                                                is_using_drugs=0

                                                if (addiction_consumption_1>0) then
                                                
                                                    is_using_drugs=1

                                                    model_drug_use_by_income_quintile(time_period,j)=&
                                                        model_drug_use_by_income_quintile(time_period,j)+&
                                                        distribution_mass_used
                                                        
                                                end if

                                                mass_by_income_quintile_2(time_period,is_using_drugs,j)=&
                                                    mass_by_income_quintile_2(time_period,is_using_drugs,j)+&
                                                    distribution_mass_used                                        
                                                
                                                profile_by_income_quintile(time_period,is_using_drugs,j,1)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,1)+&
                                                    age_index*distribution_mass_used

                                                profile_by_income_quintile(time_period,is_using_drugs,j,2)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,2)+&
                                                    (consumption_used-food_stamps_1)*distribution_mass_used

                                                profile_by_income_quintile(time_period,is_using_drugs,j,3)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,3)+&
                                                    labor_supply_used*distribution_mass_used

                                                profile_by_income_quintile(time_period,is_using_drugs,j,4)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,4)+&
                                                    total_income*distribution_mass_used

                                                profile_by_income_quintile(time_period,is_using_drugs,j,5)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,5)+&
                                                    max(years_left_on_mortgage_index-1,0)*distribution_mass_used

                                                profile_by_income_quintile(time_period,is_using_drugs,j,6)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,6)+&
                                                    (max(financial_grid(financial_index),0.d0)+&
                                                    max(years_left_on_mortgage_index-1,0)*housing_price(time_period)*&
                                                    housing_size(housing_status_index)*&
                                                    (1+min(financial_grid(financial_index),0.d0)))*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,7)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,7)+&
                                                    housing_size(housing_status_index)*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,8)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,8)+&
                                                    max(amortization_used-1,0)*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,9)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,9)+&
                                                    employment_index*distribution_mass_used
                                                    
                                                savings_1=(1-frac_next_1)*max(financial_grid(financial_index_used_1),0.d0)+&
                                                    frac_next_1*max(financial_grid(fin_financial_index_move_to_used_1),0.d0)+&
                                                    max(amortization_used-1,0)*((1-frac_next_1)*&
                                                    housing_price(time_period)*housing_size(housing_status_index_used)*&
                                                    min(financial_grid(financial_index_used_1),0.d0)+&
                                                    frac_next_1*housing_price(time_period)*housing_size(housing_status_index_used)*&
                                                    min(financial_grid(fin_financial_index_move_to_used_1),0.d0))
                                                                                                        
                                                profile_by_income_quintile(time_period,is_using_drugs,j,10)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,10)+&
                                                    (savings_1-(max(financial_grid(financial_index),0.d0)+&
                                                    max(years_left_on_mortgage_index-1,0)*&
                                                    housing_price(time_period)*housing_size(housing_status_index)*&
                                                    min(financial_grid(financial_index),0.d0)))*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,11)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,11)+&
                                                    (addiction_consumption_1/price_of_addictive_good)*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,12)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,12)+&
                                                    min(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,13)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,13)+&
                                                    max(financial_grid(financial_index),0.d0)*distribution_mass_used
                                                    
                                                if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                                   (have_two_rental_markets==0)) then
                                                
                                                    low_quality_market=0
                                                
                                                else
                                                
                                                    low_quality_market=1
                                                
                                                end if                                    
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,14)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,14)+&
                                                    (max(years_left_on_mortgage_index-1,0)*&
                                                    housing_price(time_period)*housing_size(housing_status_index)*&
                                                    (-min(financial_grid(financial_index),0.d0)*&
                                                    risk_free_rate(time_period)+housing_depreciation_rate+&
                                                    property_tax(time_period))+rent(time_period,low_quality_market)*&
                                                    (1-max(years_left_on_mortgage_index-1,0))*&
                                                    housing_size(housing_status_index))*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,15)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,15)+&
                                                    income_taxes_paid_used*distribution_mass_used
                                                    
                                                profile_by_income_quintile(time_period,is_using_drugs,j,16)=&
                                                    profile_by_income_quintile(time_period,is_using_drugs,j,16)+&
                                                    total_income_1*distribution_mass_used
                                                                                                      
                                            end if
                                                                                                                                                                                                                            
                                            tenure_by_income_quintile(time_period,j,i)=&
                                                tenure_by_income_quintile(time_period,j,i)+distribution_mass_used
                                                
                                            if ((amortization_used<=1) .AND. &
                                                (housing_status_index_used>lowest_housing_grid_point)) then
                                                
                                                if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                                    (have_two_rental_markets==0))  then
                                                
                                                    low_quality_market=0
                                                
                                                else
                                                
                                                    low_quality_market=1
                                                
                                                end if
                                                
                                                rent_to_income_to_use=&
                                                    rent(time_period,low_quality_market)*housing_size(housing_status_index_used)/&
                                                    total_income
                                                    
                                                mass_renters_by_income_quintile(time_period,j)=&
                                                    mass_renters_by_income_quintile(time_period,j)+distribution_mass_used
                                                    
                                                if ((rent_to_income_to_use>=0.3) .OR. (total_income==0)) then
                                                
                                                    rent_burden_by_income_quintile(time_period,j)=&
                                                        rent_burden_by_income_quintile(time_period,j)+distribution_mass_used
                                                        
                                                end if
                                                
                                            end if                                     
                                                
                                            MID_share_by_income_quintile(time_period,j)=&
                                                MID_share_by_income_quintile(time_period,j)+&
                                                MID_used*distribution_mass_used
                                                
                                            mass_by_income_quintile(time_period,j)=&
                                                mass_by_income_quintile(time_period,j)+distribution_mass_used
                                                
                                            if (MID_used>0) then
                                            
                                                MID_itemizers_by_income_quintile(time_period,j)=&
                                                    MID_itemizers_by_income_quintile(time_period,j)+&
                                                    distribution_mass_used
                                                    
                                            end if
                                                
                                        end if
                                        
                                    end if
                                    
                                    total_MID_value=total_MID_value+MID_used*distribution_mass_used
                                                                    
                                    tenure_by_employment(time_period,employment_index_to_use,i)=&
                                        tenure_by_employment(time_period,employment_index_to_use,i)+distribution_mass_used
                                        
                                    housing_size_by_employment_and_tenure(time_period,employment_index_to_use,i)=&
                                        housing_size_by_employment_and_tenure(time_period,employment_index_to_use,i)+&
                                        lived_in_size_used*distribution_mass_used
                                        
                                    mass_by_tenure_and_employment(time_period,employment_index_to_use,i)=&
                                        mass_by_tenure_and_employment(time_period,employment_index_to_use,i)+&
                                        distribution_mass_used
                        
                                    homeownership_by_employment(time_period,employment_index_to_use)=&
                                        homeownership_by_employment(time_period,employment_index_to_use)+&
                                        max(min(amortization_used-1,1),0)*distribution_mass_used
                                        
                                    housing_size_by_employment(time_period,employment_index_to_use)=& 
                                        housing_size_by_employment(time_period,employment_index_to_use)+&
                                        lived_in_size_used*distribution_mass_used
                                        
                                    housing_size_by_employment_and_age(time_period,employment_index_to_use,age_index)=& 
                                        housing_size_by_employment_and_age(time_period,employment_index_to_use,age_index)+&
                                        lived_in_size_used*distribution_mass_used
                                        
                                    consumption_by_employment_and_age(time_period,employment_index_to_use,age_index)=& 
                                        consumption_by_employment_and_age(time_period,employment_index_to_use,age_index)+&
                                        consumption_used*distribution_mass_used
                                        
                                    wealth_by_employment_and_age(time_period,employment_index_to_use,age_index)=&
                                        wealth_by_employment_and_age(time_period,employment_index_to_use,age_index)+&
                                        (housing_price(time_period)*housing_size(housing_status_index)*&
                                        (max(min(years_left_on_mortgage_index-1,1),0)+&
                                        min(financial_grid(financial_index),0.d0))+&
                                        max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                                                
                                    mass_by_employment(time_period,employment_index_to_use)=&
                                        mass_by_employment(time_period,employment_index_to_use)+distribution_mass_used
                                        
                                    mass_by_employment_and_age(time_period,employment_index_to_use,age_index)=&
                                        mass_by_employment_and_age(time_period,employment_index_to_use,age_index)+&
                                        distribution_mass_used
                                        
                                    consumption_by_age(time_period,age_index)=consumption_by_age(time_period,age_index)+&
                                        consumption_used*distribution_mass_used
                                                                
                                    homeownership_by_age(time_period,age_index)=homeownership_by_age(time_period,age_index)+&
                                        max(min(amortization_used-1,1),0)*distribution_mass_used
                                        
                                    model_assets_by_age(time_period,age_index)=model_assets_by_age(time_period,age_index)+&
                                        (housing_price(time_period)*housing_size(housing_status_index)*&
                                        (max(min(years_left_on_mortgage_index-1,1),0)+&
                                        min(financial_grid(financial_index),0.d0))+&
                                        max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                    
                                    housing_size_by_age(time_period,age_index)=housing_size_by_age(time_period,age_index)+&
                                        lived_in_size_used*distribution_mass_used
                                    
                                    mass_by_age(time_period,age_index)=mass_by_age(time_period,age_index)+&
                                        distribution_mass_used
                                        
                                    if (housing_status_index_used==lowest_housing_grid_point) then
                                    
                                        homelessness_by_age(time_period,age_index)=homelessness_by_age(time_period,age_index)+&
                                            distribution_mass_used                                            
                                            
                                        if (age_index<=9) then
                                        
                                            age_group_1=1
                                            
                                        elseif (age_index<=19) then
                                        
                                            age_group_1=2
                                            
                                        elseif (age_index<=29) then
                                        
                                            age_group_1=3
                                            
                                        elseif (age_index<=39) then
                                        
                                            age_group_1=4
                                            
                                        else
                                        
                                            age_group_1=5
                                            
                                        end if
                                        
                                        homelessness_by_age_group(time_period,age_group_1)=&
                                            homelessness_by_age_group(time_period,age_group_1)+distribution_mass_used
                                            
                                    end if
                                        
                                    if (amortization_used<=1) then
                                        
                                        wealth_by_age_renter(time_period,age_index)=wealth_by_age_renter(time_period,age_index)+&
                                            (housing_price(time_period)*housing_size(housing_status_index)*&
                                            (max(min(years_left_on_mortgage_index-1,1),0)+&
                                            min(financial_grid(financial_index),0.d0))+&
                                            max(financial_grid(financial_index),0.d0))*distribution_mass_used
                                                                                    
                                        if (in_retirement==1) then
                                        
                                            income_by_age_renter(time_period,age_index)=&
                                                income_by_age_renter(time_period,age_index)+&
                                                (((1-is_counterfactual)*model_average_labour_income(time_period)+&
                                                is_counterfactual))*distribution_mass_used
                                        
                                        else
                                        
                                            if ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1)) then
                                            
                                                income_by_age_renter(time_period,age_index)=&
                                                    income_by_age_renter(time_period,age_index)+&
                                                    ((labor_supply_used*employment_grid(age_index,employment_index)*&
                                                    labour_deterministic_efficiency(age_index))-&
                                                    max((labor_supply_used*employment_grid(age_index,employment_index)*&
                                                    labour_deterministic_efficiency(age_index)-&
                                                    personal_exemption),0.d0)**curvature_of_labor_income_taxes)*&
                                                    distribution_mass_used
                                                    
                                            elseif ((unemployment_index==threshold_addiction_index) .OR. &
                                                (unemployment_index==unemployment_grid_size)) then
                                            
                                                income_by_age_renter(time_period,age_index)=&
                                                    income_by_age_renter(time_period,age_index)+&
                                                    (min(replacement_rate_ui*avg_income_to_use_2,&
                                                    max_ui_as_perc_of_avg_inc*avg_income_to_use_1))+&
                                                    distribution_mass_used
                                            
                                            end if
                                                
                                        end if
                                        
                                        income_by_age_renter(time_period,age_index)=&
                                            income_by_age_renter(time_period,age_index)+&
                                            risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)*&
                                            distribution_mass_used
                                        
                                        consumption_by_age_renter(time_period,age_index)=&
                                            consumption_by_age_renter(time_period,age_index)+consumption_used*distribution_mass_used
                                            
                                        housing_consumption_by_age_renter(time_period,age_index)=&
                                            housing_consumption_by_age_renter(time_period,age_index)+&
                                            lived_in_size_used*distribution_mass_used
                                            
                                        mass_by_age_and_renter(time_period,age_index)=&
                                            mass_by_age_and_renter(time_period,age_index)+distribution_mass_used
                                                                    
                                    end if
                                    
                                end do
                                
                            end do
                                
                        end do
                        
                    end do
                        
                end do
                                                    
            end do
                
        end do

        do k=0,1

            do j=1,number_of_quintiles

                do i=1,number_of_profiles_for_income

                    profile_by_income_quintile(time_period,k,j,i)=&
                        profile_by_income_quintile(time_period,k,j,i)/&
                        mass_by_income_quintile_2(time_period,k,j)

                end do

            end do

        end do
                                                
        model_drug_use_by_income_quintile(time_period,:)=&
            model_drug_use_by_income_quintile(time_period,:)/&
            mass_by_income_quintile_1(time_period,:)
        
        homelessness_by_age_group(time_period,:)=&
            homelessness_by_age_group(time_period,:)/sum(homelessness_by_age_group(time_period,:))
        
        do age_index=1,life_span
        
            wealth_by_age_renter(time_period,age_index)=&
                wealth_by_age_renter(time_period,age_index)/mass_by_age_and_renter(time_period,age_index)
                
            income_by_age_renter(time_period,age_index)=&
                income_by_age_renter(time_period,age_index)/mass_by_age_and_renter(time_period,age_index)
                
            consumption_by_age_renter(time_period,age_index)=&
                consumption_by_age_renter(time_period,age_index)/mass_by_age_and_renter(time_period,age_index)
            
            housing_consumption_by_age_renter(time_period,age_index)=&
                housing_consumption_by_age_renter(time_period,age_index)/mass_by_age_and_renter(time_period,age_index)
            
        end do
        
        do years_left_on_mortgage_index=1,3
        
            do employment_index=1,employment_grid_size
            
                housing_size_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)=&
                    housing_size_by_employment_and_tenure(time_period,employment_index,years_left_on_mortgage_index)/&
                    mass_by_tenure_and_employment(time_period,employment_index,years_left_on_mortgage_index)
            
            end do
            
        end do
                         
        do employment_index=1,employment_grid_size
        
            homeownership_by_employment(time_period,employment_index)=&
                homeownership_by_employment(time_period,employment_index)/mass_by_employment(time_period,employment_index)
            
            housing_size_by_employment(time_period,employment_index)=&
                housing_size_by_employment(time_period,employment_index)/mass_by_employment(time_period,employment_index)
                                
        end do
        
        do age_index=1,life_span
        
            do employment_index=1,1,employment_grid_size
        
                housing_size_by_employment_and_age(time_period,employment_index,age_index)=&
                    housing_size_by_employment_and_age(time_period,employment_index,age_index)/&
                    mass_by_employment_and_age(time_period,employment_index,age_index)
            
                consumption_by_employment_and_age(time_period,employment_index,age_index)=&
                    consumption_by_employment_and_age(time_period,employment_index,age_index)/&
                    mass_by_employment_and_age(time_period,employment_index,age_index)
                    
                wealth_by_employment_and_age(time_period,employment_index,age_index)=&
                    wealth_by_employment_and_age(time_period,employment_index,age_index)/&
                    mass_by_employment_and_age(time_period,employment_index,age_index)
                    
                consumption_by_age(time_period,age_index)=consumption_by_age(time_period,age_index)/&
                    mass_by_age(time_period,age_index)
                                        
            end do
                                
        end do
        
        do age_index=1,life_span
                
            homeownership_by_age(time_period,age_index)=homeownership_by_age(time_period,age_index)/&
                mass_by_age(time_period,age_index)
                
            model_assets_by_age(time_period,age_index)=model_assets_by_age(time_period,age_index)/&
                mass_by_age(time_period,age_index)
          
            housing_size_by_age(time_period,age_index)=housing_size_by_age(time_period,age_index)/&
                mass_by_age(time_period,age_index)
                
            homelessness_by_age(time_period,age_index)=homelessness_by_age(time_period,age_index)/&
                mass_by_age(time_period,age_index)
                                        
        end do
        
        MID_share_by_income_quintile(time_period,:)=&
            MID_share_by_income_quintile(time_period,:)/total_MID_value
            
        MID_itemizers_by_income_quintile(time_period,:)=&
            MID_itemizers_by_income_quintile(time_period,:)/mass_by_income_quintile(time_period,:)
        
        if (simulation_ended==(compute_income_cdf+(1-compute_income_cdf)*1))  then
                
            do k=1,number_of_quintiles
            
!                write(*,*) "income_cutoffs_of_quintiles(k)", income_cutoffs_of_quintiles(min(k,number_of_quintiles-1))
!                write(*,*) "tenure_by_income_quintile=", sum(tenure_by_income_quintile(time_period,k,:))
!                write(*,*) "mass_of_quintile=", mass_of_quintile(k)
            
            end do
            
        end if
        
        rent_burden_by_income_quintile(time_period,:)=&
            rent_burden_by_income_quintile(time_period,:)/mass_renters_by_income_quintile(time_period,:)
                                                    
        model_addicts_consuming_no_drugs(time_period)=&
            model_addicts_consuming_no_drugs(time_period)/mass_of_addicts
            
    end subroutine
    
    subroutine frac_of_households_in_support_of_policy(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period,has_house,employment_index_to_use
        character*1 :: string_used
        real(8) :: distribution_mass_used,value_function_used,value_function_benchamrk_used,&
            total_addicted_1,total_addicted_youngest_1
                        
        frac_in_support(time_period)=0
        frac_in_support_youngest(time_period)=0
        
        frac_in_support_addicted(time_period)=0
        frac_in_support_addicted_youngest(time_period)=0
        total_addicted_1=0
        total_addicted_youngest_1=0
        
        frac_in_support_by_tenure_and_employment(time_period,:,:)=0
        mass_by_tenure_and_employment(time_period,:,:)=0
        
        average_welfare_of_winners(time_period)=0
        average_welfare_of_winners_benchmark(time_period)=0
                
        do i=1,2
        
            write(string_used,'(i1)') i
    
            open(unit=9,file="value_function"//trim(string_used)//trim(benchmark_simulation)//".dat",action='read')
                read(9,'(F35.13)') value_function_benchmark(i)%vector_real(:,:,:,:,:,:)
            close(9)
            open(unit=10,file="distribution_stationary"//trim(string_used)//trim(benchmark_simulation)//".dat",action='read')
                read(10,'(F30.28)') distribution_stationary_benchmark(i)%vector_real(:,:,:,:,:,:)
            close(10)
            
        end do
                            
        do age_index=1,life_span
                            
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                    
                    has_house=1
                    
                else
                
                    has_house=0
                    
                end if
                                    
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        do voucher_index=0,(1-has_house)*include_vouchers
                                    
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                               
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                
                                    if (years_left_on_mortgage_index==0) then
                                    
                                        i=0
                                    
                                    elseif (years_left_on_mortgage_index==1) then
                                    
                                        i=1
                                        
                                    elseif (years_left_on_mortgage_index==2) then
                                    
                                        if (financial_grid(financial_index)<0) then
                                    
                                            i=3
                                            
                                        else
                                        
                                            i=2
                                            
                                        end if
                                        
                                    end if
                                    
                                    distribution_mass_used=distribution_stationary_benchmark(years_left_on_mortgage_index)%&
                                        vector_real(age_index,financial_index,unemployment_index,&
                                        employment_index,housing_status_index,voucher_index)
                                                                        
                                    value_function_used=value_function(max(years_left_on_mortgage_index,1))%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    value_function_benchamrk_used=value_function_benchmark(years_left_on_mortgage_index)%&
                                        vector_real(age_index,financial_index,unemployment_index,employment_index,&
                                        housing_status_index,voucher_index)
                                        
                                    employment_index_to_use=employment_index
                                
                                    mass_by_tenure_and_employment(time_period,employment_index_to_use,max(i,1))=&
                                        mass_by_tenure_and_employment(time_period,employment_index_to_use,max(i,1))+&
                                        distribution_mass_used
                                        
                                    if (unemployment_index>threshold_addiction_index) then
                                    
                                        total_addicted_1=total_addicted_1+distribution_mass_used
                                        
                                        if (age_index==1) then
                                        
                                            total_addicted_youngest_1=total_addicted_youngest_1+distribution_mass_used
                                            
                                        end if
                                        
                                    end if
                                                                           
                                    if (value_function_used>value_function_benchamrk_used) then
                                                
                                        if (age_index==1) then
                                                
                                            frac_in_support_youngest(time_period)=&
                                                frac_in_support_youngest(time_period)+distribution_mass_used
                                                
                                            if (unemployment_index>threshold_addiction_index) then
                                            
                                                frac_in_support_addicted_youngest(time_period)=&
                                                    frac_in_support_addicted_youngest(time_period)+distribution_mass_used
                                                                                            
                                            end if
                                                                                                
                                        end if
                                                        
                                        frac_in_support(time_period)=frac_in_support(time_period)+distribution_mass_used
                                        
                                        if (unemployment_index>threshold_addiction_index) then
                                            
                                            frac_in_support_addicted(time_period)=&
                                                frac_in_support_addicted(time_period)+distribution_mass_used
                                                                                        
                                        end if
                                                                                    
                                        frac_in_support_by_tenure_and_employment(time_period,employment_index_to_use,max(i,1))=&
                                            frac_in_support_by_tenure_and_employment(time_period,employment_index_to_use,max(i,1))+&
                                            distribution_mass_used
                                            
                                        average_welfare_of_winners(time_period)=average_welfare_of_winners(time_period)+&
                                            distribution_mass_used*value_function_used
                                            
                                        average_welfare_of_winners_benchmark(time_period)=&
                                            average_welfare_of_winners_benchmark(time_period)+&
                                            distribution_mass_used*value_function_benchamrk_used
                                            
                                    end if
                                                                    
                                end do
                                
                            end do
                         
                         end do
                         
                    end do
                    
                end do
                    
            end do
            
        end do
        
        frac_in_support_addicted_youngest(time_period)=&
            frac_in_support_addicted_youngest(time_period)/total_addicted_youngest_1
            
        frac_in_support_addicted(time_period)=&
            frac_in_support_addicted(time_period)/total_addicted_1
        
        average_welfare_of_winners(time_period)=average_welfare_of_winners(time_period)/frac_in_support(time_period)
            
        average_welfare_of_winners_benchmark(time_period)=&
            average_welfare_of_winners_benchmark(time_period)/frac_in_support(time_period)

        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
        end do
        
        sum_of_distribution_youngest=0
        
        do i=1,2
                
            sum_of_distribution_youngest=sum_of_distribution_youngest+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,1,:,:,:,:,:))
            
        end do
                
        do i=1,3
        
            do j=1,employment_grid_size
                            
                frac_in_support_by_tenure_and_employment(time_period,j,i)=&
                    frac_in_support_by_tenure_and_employment(time_period,j,i)/&
                    mass_by_tenure_and_employment(time_period,j,i)
                                    
            end do
            
        end do
                                
        frac_in_support(time_period)=frac_in_support(time_period)/sum_of_distribution
        
        frac_in_support_youngest(time_period)=frac_in_support_youngest(time_period)/sum_of_distribution_youngest
                            
        if (solve_transition_dynamics==0) then
        
            write(*,*) "frac_in_support(",time_period,")=", frac_in_support(time_period)
            write(*,*) "frac_in_support_youngest(",time_period,")=", frac_in_support_youngest(time_period)
            
        end if
            
    end subroutine
        
    subroutine solve_value_function_and_policy_functions(time_period)
    
        use Global_Vars
        !$ use omp_lib
        
        implicit none
        
        integer :: financial_index,time_period,run_internal_grid,number_of_threads_used,has_house,track_housing_1
        real(8) :: labor_supply_2
        character*1 :: string_used
                        
        max_future_mortgage_index_1=negative_financial_grid_size
        
        do i=1,2
                        
            value_function(i)%vector_transition_real(time_period,:,:,:,:,:,:)=large_negative_num            
            value_function(i)%vector_transition_real(time_period,life_span+1,:,:,:,:,:)=0
            
        end do
                
        do i=1,2
        
            policy_function_financial_index(i)%vector_transition_integer(time_period,:,:,:,:,:,:)=negative_financial_grid_size
            policy_function_housing_status_index(i)%vector_transition_integer(time_period,:,:,:,:,:,:)=0        
            policy_function_consumption(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
            policy_function_space_lived_in_index(i)%vector_transition_integer(time_period,:,:,:,:,:,:)=0
            policy_function_space_lived_in_size(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
            policy_function_wage_income_tax_paid(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
            policy_function_years_of_amortization_index(i)%vector_transition_integer(time_period,:,:,:,:,:,:)=1
            policy_function_mortgage_interest_deductions(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0    
            policy_function_labor_supply(i)%vector_transition_real(time_period,:,:,:,:,:,:)=1
            frac_mov_optimal_1(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
            fin_index_frac_mov_to_optimal(i)%vector_transition_integer(time_period,:,:,:,:,:,:)=negative_financial_grid_size
            policy_function_total_consumption(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
            policy_function_frac_spent_on_addiction(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
            policy_function_addiction(i)%vector_transition_integer(time_period,:,:,:,:,:,:)=0
                
        end do
        
        if ((loop_count<2) .AND. (partial_equilibrium==1)) then
        
            do i=1,2
            
                write(string_used,'(i1)') i
                            
                open(unit=10,file="policy_function_labor_supply"//&
                    trim(string_used)//trim(benchmark_simulation)//".dat",action='read')
                    read(10,'(F22.20)') policy_function_labor_supply(i)%vector_transition_real(time_period,:,:,:,:,:,:)
                close(10)
                
            end do
                
        end if
        
        negative_consumption=0
        
        call cpu_time(value_function_iteration_start_time)
        
        if (solve_transition_dynamics>=0) then
        
            number_of_threads_used=max_CPUs

            CALL OMP_SET_NUM_THREADS(number_of_threads_used)
        
            !$omp parallel
            !$omp master
            !$ write(*,*) "number of threads = ", omp_get_num_threads()
            !$omp end master
            !$omp end parallel
            
        end if
                       
        do age_index=life_span,1,-1
                
            if (age_index>(life_span-retirement_span)) then
                
                in_retirement=1
            
            else
            
                in_retirement=0 
            
            end if
                                    
            if (age_index==1) then
            
                newborn_household=1
                
            else
            
                newborn_household=0
                
            end if
            
            if (age_index==life_span) then
            
                can_get_mortgage=allow_retirees_borrow
                                
            else
                            
                if (age_index<=life_span-retirement_span) then
                
                    can_get_mortgage=1
                    
                else
                
                    can_get_mortgage=allow_retirees_borrow
                
                end if
                
            end if
            
            if (age_index>=(life_span-retirement_span)) then
                
                at_least_one_period_before_retirement=1
            
            else
                
                at_least_one_period_before_retirement=0
            
            end if
            
            one_period_before_death=0
            
            if (age_index==life_span) then
            
                one_period_before_death=1
            
            end if
            
            do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years

                has_house=0

                if (years_left_on_mortgage_index>1) then

                    has_house=1

                end if
                
                track_housing_1=1
                        
                if (has_house==0) then
                
                    if (track_renters_housing==0) then
                    
                        track_housing_1=0
                        
                    end if
                    
                end if
                
                do employment_index=1,employment_grid_size
                
                    do voucher_index=0,(1-has_house)*include_vouchers
                                                    
                        do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                            has_house*index_of_smallest_house_hhld_can_buy,&
                            track_housing_1*(1-newborn_household)*(housing_status_grid_size-1)
                                                        
                            do unemployment_index=1,unemployment_grid_size
                                                                                                            
                                !$omp parallel do default(none) &
                                !$omp& shared(frac_mov_optimal_1,fin_index_frac_mov_to_optimal,&
                                !$omp& policy_function_consumption,policy_function_space_lived_in_size,&
                                !$omp& policy_function_space_lived_in_index,policy_function_addiction,&
                                !$omp& policy_function_financial_index,policy_function_wage_income_tax_paid,&
                                !$omp& policy_function_housing_status_index,policy_function_mortgage_interest_deductions,&
                                !$omp& policy_function_labor_supply,policy_function_cutoff_taxable_income,&
                                !$omp& policy_function_years_of_amortization_index,housing_status_index,&
                                !$omp& policy_function_frac_spent_on_addiction,policy_function_total_consumption,&
                                !$omp& model_average_rental_unit_size,rent,negative_consumption,has_mortgage,&
                                !$omp& model_average_labour_income,housing_status_utility_function,&
                                !$omp& net_govt_revenues,relative_share_of_housing,survival_probability,discount_factor,&
                                !$omp& value_function_guess,value_function,labor_supply_2,&
                                !$omp& employment_process,years_left_on_mortgage_index,unemployment_index,employment_index,&
                                !$omp& large_negative_num,labour_deterministic_efficiency,model_ss_benefits,housing_size,&
                                !$omp& housing_price,mortgage_insurance_premium,mortgage_interest_rate,property_tax,&
                                !$omp& curvature_of_labor_income_taxes,labor_income_tax_rate,voucher_index,&
                                !$omp& financial_grid,increase_in_labour_income_tax,&
                                !$omp& relative_share_of_housing_2,relative_share_of_consumption_2,relative_share_of_addiction,&
                                !$omp& age_index,discount_factor_on_child,unemployment_process,&
                                !$omp& risk_free_rate,time_period,rental_management_costs,can_get_mortgage,&
                                !$omp& unemployment_grid,employment_grid,run_internal_grid,at_least_one_period_before_retirement,&
                                !$omp& index_of_smallest_house_hhld_can_buy,convexity_of_rental_company,&
                                !$omp& size_of_smallest_house_hhld_can_buy,model_average_owner_occupied_unit_size,has_house,&
                                !$omp& in_retirement,newborn_household,lump_sum_transfer,&
                                !$omp& scaled_household_size,one_period_before_death,median_income)
                        
                                do financial_index=newborn_household*negative_financial_grid_size+&
                                    (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                    include_exogenous_endowment*financial_grid_size+(1-include_exogenous_endowment)*&
                                    (newborn_household*negative_financial_grid_size+&
                                    (1-newborn_household)*financial_grid_size)
                                                                                                                                                                 
                                    total_household_wealth=has_house*housing_price(time_period)*&
                                        housing_size(housing_status_index)+max(financial_grid(financial_index),0.d0)
                                                                 
                                    went_in_1=0
                                                                 
                                    if (years_left_on_mortgage_index<=1) then
                                    
                                        value_function_owner=large_negative_num
                                                                        
                                        call renters_problem(time_period,financial_index)
                                        
                                    else
                                    
                                        value_function_renter=large_negative_num
                                                    
                                        call owners_problem(time_period,financial_index)   
                                                                                                     
                                    end if
                                                                
                                    call which_is_better(time_period,financial_index)
                                                                                                                                                    
                                    if (do_internal_computations==1) then
                                    
                                        if (years_left_on_mortgage_index<=1) then
                                        
                                            if (optimal_household_can_consume_renter==1)  then
                                            
                                                run_internal_grid=1
                                                
                                            else
                                            
                                                run_internal_grid=0
                                                
                                            end if
                                            
                                        else
                                        
                                            if (optimal_household_can_consume_owner==1)  then
                                            
                                                run_internal_grid=1
                                                
                                            else
                                            
                                                run_internal_grid=0
                                                                                            
                                            end if
                                        
                                        end if
                                        
                                        if (run_internal_grid==1) then
                                        
                                            financial_index_used_3=&
                                                policy_function_financial_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            space_lived_in_index_used_3=&
                                                policy_function_space_lived_in_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            labor_supply_used_3=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                                vector_transition_real(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                            amortization_used_dist=&
                                                policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            frac_spent_on_addiction_3=&
                                                policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                                vector_transition_real(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            addiction_used=policy_function_addiction&
                                                (years_left_on_mortgage_index)%vector_transition_integer&
                                                (time_period,age_index,financial_index,unemployment_index,&
                                                employment_index,housing_status_index,voucher_index)
                                                
                                            max_future_mortgage_index_1=negative_financial_grid_size
                                            
                                            if (amortization_used_dist>1) then
                                                                               
                                                max_mortgage_value_allowed_1=&
                                                    -min(financial_grid(financial_index_used_3),0.d0)
                                                                                                        
                                                max_future_mortgage_index_1=min(max(minloc(max_mortgage_value_allowed_1+&
                                                    financial_grid(1:negative_financial_grid_size),1,mask=&
                                                    (max_mortgage_value_allowed_1+financial_grid&
                                                    (1:negative_financial_grid_size))>=0),1),negative_financial_grid_size)
                                                                                                       
                                            end if
                                    
                                            call internal_computations&
                                                (value_function(years_left_on_mortgage_index)%&
                                                vector_transition_real(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index),&
                                                labor_supply_used_3,labor_supply_used_3*&
                                                employment_grid(age_index,employment_index)*&
                                                labour_deterministic_efficiency(age_index),&
                                                financial_index_used_3,max(min(amortization_used_dist-1,1),0),&
                                                space_lived_in_index_used_3,policy_function_housing_status_index&
                                                (years_left_on_mortgage_index)%vector_transition_integer&
                                                (time_period,age_index,financial_index,unemployment_index,&
                                                employment_index,housing_status_index,voucher_index),amortization_used_dist,&
                                                policy_function_wage_income_tax_paid(years_left_on_mortgage_index)%&
                                                vector_transition_real(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index),&
                                                policy_function_mortgage_interest_deductions(years_left_on_mortgage_index)%&
                                                vector_transition_real(time_period,age_index,financial_index,unemployment_index,&
                                                employment_index,housing_status_index,voucher_index),financial_index,time_period,&
                                                optimal_after_tax_wealth_net_of_expenses,max_future_mortgage_index_1,&
                                                frac_spent_on_addiction_3,addiction_used)
                                                                                                
                                            value_function(years_left_on_mortgage_index)%&
                                                vector_transition_real(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)=&
                                                val_fun_internal
                                                
                                        end if
                                            
                                    end if
                                    
                                    if ((value_function(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)<0) .AND. &
                                        (optimal_after_tax_wealth_net_of_expenses>0)) then
                                    
    !                                    write(*,*) "age_index=", age_index
    !                                    write(*,*) "financial_index=", financial_index
    !                                    write(*,*) "financial_grid(financial_index)=", financial_grid(financial_index)
    !                                    write(*,*) "years_left_on_mortgage_index=", years_left_on_mortgage_index
    !                                    write(*,*) "unemployment_index=", unemployment_index
    !                                    write(*,*) "employment_index=", employment_index
    !                                    write(*,*) "housing_status_index=", housing_status_index
    !                                    write(*,*) "value=", value_function(years_left_on_mortgage_index)%&
    !                                        vector_transition_real(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    write(*,*) "policy_function_addiction=", &
    !                                        policy_function_addiction(years_left_on_mortgage_index)%&
    !                                        vector_transition_integer(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    write(*,*) "policy_function_housing_status_index=", &
    !                                        policy_function_housing_status_index(years_left_on_mortgage_index)%&
    !                                        vector_transition_integer(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    write(*,*) "policy_function_financial_index=", &
    !                                        policy_function_financial_index(years_left_on_mortgage_index)%&
    !                                        vector_transition_integer(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    write(*,*) "policy_function_consumption=", &
    !                                        policy_function_consumption(years_left_on_mortgage_index)%&
    !                                        vector_transition_real(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    write(*,*) "policy_function_total_consumption=", &
    !                                        policy_function_total_consumption(years_left_on_mortgage_index)%&
    !                                        vector_transition_real(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    write(*,*) "policy_function_labor_supply=", &
    !                                        policy_function_labor_supply(years_left_on_mortgage_index)%&
    !                                        vector_transition_real(time_period,age_index,financial_index,&
    !                                        unemployment_index,employment_index,housing_status_index)
    !                                    
                                    end if
                                    
                                    if ((policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)<=0) .AND. &
                                        (optimal_after_tax_wealth_net_of_expenses>0)) then
                                        
                                        write(*,*) "consumption negatuve"
                                                
                                    end if
                                    
                                    if ((policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)<0) .OR. &
                                        policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)>1) then
                                        
                                        write(*,*) "consumption negatuve 2"
                                        write(*,*) "policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                            vector_transition_real(time_period,age_index,financial_index,&
                                            unemployment_index,employment_index,housing_status_index)=", &
                                            policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                            vector_transition_real(time_period,age_index,financial_index,&
                                            unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                    end if
                                    
                                    if (policy_function_total_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)<&
                                        policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)) then
                                        
                                        write(*,*) "werird"
                                        
                                    end if
                                    
                                    if ((addiction_used==0) .AND. (unemployment_index>threshold_addiction_index) .AND. &
                                       (optimal_after_tax_wealth_net_of_expenses>0) .AND. (run_internal_grid==1)) then
                                    
                                        write(*,*) "error wrong addiction option"
                                    
                                    end if
                                                                    
                                    if (optimal_after_tax_wealth_net_of_expenses>0) then
                                                                                                            
                                        call check_budget_constraint_clears&
                                            (time_period,optimal_after_tax_wealth_net_of_expenses,financial_index)
                                                                                    
                                    end if
                                    
                                    labor_supply_2=policy_function_labor_supply(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    if ((labor_supply_2>1) .OR. (labor_supply_2<0)) then
        
                                        write(*,*) "labor_supply_2=", labor_supply_2
                                    
                                    end if
                                    
                                end do
                                                             
                                !$omp end parallel do
                                
                            end do
                            
                        end do
                                                                    
                    end do
                    
                end do
            
            end do
            
            if (loop_count<1) then
            
                write(*,*) "age_index=", age_index
                
            end if
            
        end do
        
        if (solve_transition_dynamics==0) then
                
            loop_count=loop_count+1
            
        end if
         
        call cpu_time(value_function_iteration_stop_time)
        
        write(*,*) "time=", value_function_iteration_stop_time-value_function_iteration_start_time
        
        if ((solve_transition_dynamics==1) .AND. (is_counterfactual==1)) then
        
            write(*,*) "time_period=", time_period
            
        end if
    
    end subroutine
    
    subroutine renters_problem(time_period,financial_index)

        use Global_Vars
        
        implicit none
    
        integer, intent(in) :: time_period,financial_index
                                                                                                                      
        call renter_to_renter_problem(time_period,financial_index)
                
        call renter_to_owner_problem(time_period,financial_index)
        
        if (value_function_renter_renter>=value_function_renter_owner) then
                        
            value_function_renter=value_function_renter_renter
            
            optimal_renter_indeces(1)=optimal_renter_renter_indeces(1)
            optimal_renter_indeces(2)=optimal_renter_renter_indeces(2)
            optimal_renter_indeces(3)=optimal_renter_renter_indeces(3)
                
            optimal_gross_wage_income_renter=optimal_gross_wage_income_renter_renter
            optimal_cutoff_taxable_income_renter=optimal_cutoff_taxable_income_renter_renter
            optimal_wage_income_tax_paid_renter=optimal_wage_income_tax_paid_renter_renter
            optimal_after_tax_wealth_net_of_expenses_renter=optimal_after_tax_wealth_net_of_expenses_renter_renter
            optimal_consumption_renter=optimal_consumption_renter_renter
            optimal_space_lived_in_renter=optimal_space_lived_in_renter_renter
            optimal_mortgage_deductions_renter=optimal_mortgage_deductions_renter_renter
            optimal_household_can_consume_renter=optimal_household_can_consume_renter_renter
            optimal_labor_supply_renter=optimal_labor_supply_renter_renter
            optimal_frac_spent_on_addiction_renter=optimal_frac_spent_on_addiction_renter_renter
            optimal_total_consumption_renter=optimal_total_consumption_renter_renter
            optimal_addiction_status_renter=optimal_addiction_status_renter_renter
            
            if ((unemployment_index>threshold_addiction_index) .AND. &
                (optimal_addiction_status_renter_renter==0) .AND. (optimal_after_tax_wealth_net_of_expenses_renter>0)) then
            
                write(*,*) "wrong renter renter"
            
            end if
                    
        else
        
            value_function_renter=value_function_renter_owner
            
            optimal_renter_indeces(1)=optimal_renter_owner_indeces(1)
            optimal_renter_indeces(2)=optimal_renter_owner_indeces(2)
            optimal_renter_indeces(3)=optimal_renter_owner_indeces(3)
                
            optimal_gross_wage_income_renter=optimal_gross_wage_income_renter_owner
            optimal_cutoff_taxable_income_renter=optimal_cutoff_taxable_income_renter_owner
            optimal_wage_income_tax_paid_renter=optimal_wage_income_tax_paid_renter_owner
            optimal_after_tax_wealth_net_of_expenses_renter=optimal_after_tax_wealth_net_of_expenses_renter_owner
            optimal_consumption_renter=optimal_consumption_renter_owner
            optimal_space_lived_in_renter=optimal_space_lived_in_renter_owner
            optimal_mortgage_deductions_renter=optimal_mortgage_deductions_renter_owner
            optimal_household_can_consume_renter=optimal_household_can_consume_renter_owner
            optimal_labor_supply_renter=optimal_labor_supply_renter_owner
            optimal_frac_spent_on_addiction_renter=optimal_frac_spent_on_addiction_renter_owner
            optimal_total_consumption_renter=optimal_total_consumption_renter_owner
            optimal_addiction_status_renter=optimal_addiction_status_renter_owner
            
            if ((unemployment_index>threshold_addiction_index) .AND. &
                (optimal_addiction_status_renter_owner==0)) then
            
                write(*,*) "wrong renter owner"
            
            end if
        
        end if
        
        if ((age_index==3) .AND. (financial_index==101) .AND. (employment_index==1) .AND. &
            (housing_status_index==2)) then
            
!            write(*,*) "value_function_renter=", value_function_renter
            
        end if
                                
    end subroutine
    
    subroutine renter_to_renter_problem(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period,financial_index
        integer :: changing_homes,tenure_1,tenure_2,proceed_2,&
            future_housing_status_index_to_use,is_working_1,is_homeless_1,x_1,addiction_index,&
            global_search_index,optimal_financial_1,loop_over_addiction_1,check_1,allow_to_choose_addiction,&
            first_voucher_index,second_voucher_index,has_opportunity_1,can_consume_drugs,voucher_index_1,&
            allow_to_choose_homelessness
        real(8) :: labor_supply_1,labor_supply_2
        
        allow_to_choose_homelessness=1
        
        if (age_index>max_age_to_choose_homelessness) then
        
            allow_to_choose_homelessness=0
            
        end if       
        
        allow_to_choose_addiction=1
            
        if (age_index>max_age_to_choose_addiction) then
        
            allow_to_choose_addiction=0
                         
        end if
                     
        addiction_index=0
        
        if (unemployment_index>threshold_addiction_index) then
        
            addiction_index=1
            
        end if
        
        is_working_1=1
        
        if ((in_retirement==1) .OR. &
            ((unemployment_index>1) .AND. (unemployment_index<threshold_addiction_index+1)) .OR. &
            (unemployment_index>threshold_addiction_index+1)) then
        
            is_working_1=0
            
        end if
        
        proceed_2=1
        tenure_1=1
        tenure_2=0
        
        labor_supply_2=1
            
        largest_value=large_negative_num
        
        optimal_renter_renter_indeces(1)=negative_financial_grid_size
        optimal_financial_1=negative_financial_grid_size
        optimal_renter_renter_indeces(2)=1
        optimal_renter_renter_indeces(3)=0
                 
        optimal_consumption_renter_renter=0
        optimal_after_tax_wealth_net_of_expenses_renter_renter=0
        optimal_gross_wage_income_renter_renter=0
        optimal_cutoff_taxable_income_renter_renter=0
        optimal_wage_income_tax_paid_renter_renter=0
        optimal_space_lived_in_renter_renter=0
        optimal_mortgage_deductions_renter_renter=0
        optimal_household_can_consume_renter_renter=0
        optimal_labor_supply_renter_renter=((1-is_working_1)*0+is_working_1*1)
        labor_supply_1=optimal_labor_supply_renter_renter
        optimal_frac_spent_on_addiction_renter_renter=0
        optimal_total_consumption_renter_renter=0
        optimal_addiction_status_renter_renter=0
        
        if (fixed_labor_supply_at_benchmark==1) then
                    
            labor_supply_2=&
                policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,unemployment_index,&
                employment_index,housing_status_index,voucher_index)
                
            labor_supply_1=labor_supply_2
                
        end if
                    
        do future_addiction_index=addiction_index,&
            (1-allow_to_choose_addiction)*addiction_index+allow_to_choose_addiction*include_addiction
        
            loop_over_addiction_1=0
                        
            if (addiction_index==1) then
            
                loop_over_addiction_1=1
                
            elseif ((future_addiction_index==1) .AND. &
                (include_probability_of_becoming_addicted==1)) then
            
                loop_over_addiction_1=1
                
            end if
                        
            changing_homes=0
                            
            do future_housing_status_index=&
                allow_to_choose_homelessness*lowest_housing_grid_point,largest_house_size_hhld_can_rent
                
                if (track_renters_housing==0) then
                
                    if (future_housing_status_index<=second_lowest_housing_grid_point) then
            
                        future_housing_status_index_to_use=future_housing_status_index
                        
                    else
                        
                        future_housing_status_index_to_use=0
                        
                    end if
                    
                else
                
                    future_housing_status_index_to_use=future_housing_status_index
                
                end if   
                
                is_homeless_1=1
                
                if (future_housing_status_index_to_use==lowest_housing_grid_point) then
                
                    is_homeless_1=2
                
                end if
                
                call compute_voucher_index_1(is_homeless_1,voucher_index_1)
                                
                do global_search_index=0,coarse_grid
            
                do future_financial_index=&
                    (1-global_search_index)*negative_financial_grid_size+&
                    global_search_index*max(optimal_financial_1-grid_gaps+1,negative_financial_grid_size),&
                    (1-global_search_index)*financial_grid_size+&
                    global_search_index*min(optimal_financial_1+grid_gaps-1,financial_grid_size),&
                    (1-global_search_index)*grid_gaps+global_search_index

                    if ((future_housing_status_index==housing_status_index) .AND. &
                       (years_left_on_mortgage_index==1)) then
                    
                        changing_homes=0
                        
                    else
                    
                        changing_homes=1
                        
                    end if
                    
                    if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0)) then
                    
                        labor_supply_2=1
                        
                    end if
                                        
                    call calculate_after_tax_wealth&
                        (financial_index,future_financial_index,years_left_on_mortgage_index,0,&
                        housing_status_index,future_housing_status_index,tenure_2,tenure_2,tenure_2,&
                        tenure_2,tenure_1,time_period,labor_supply_2,cutoff_taxable_income,future_addiction_index)
                        ! owner_to_owner_move_1,owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1
                     
                    if (labor_supply_2>0.4) then 
                     
                    if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0) .AND. &
                        ((unemployment_index==1) .OR. (unemployment_index==(threshold_addiction_index+1)))) then
                                        
                        x_1=1
                                        
                        call secant(time_period,financial_index,financial_grid(future_financial_index),&
                            housing_size(future_housing_status_index),future_housing_status_index,&
                            x_1,after_tax_wealth_net_of_expenses,labor_supply_1,gross_wage_income,&
                            wage_income_tax_paid,food_stamps_recieved,housing_voucher_recieved,&
                            housing_voucher_recieved_2,mortgage_deductions_tax_rebates,proceed_2,&
                            future_addiction_index)
                                                            
                    end if
                    
                    end if
                    
                    call calculate_future_voucher_index_and_opportunity&
                        (has_opportunity_1,first_voucher_index,second_voucher_index,&
                        time_period,0,0,voucher_index_1,gross_wage_income+investment_income)
                    
                    can_consume_drugs=1
                                                                                                                                                                                                                                                                                       
                    if ((consumption_choice>=(food_stamps_recieved/(1+consumption_tax))) .AND. &
                        (consumption_choice>0) .AND. (frac_spent_on_addiction>=0) .AND. &
                        (total_consumption_choice>=consumption_choice) .AND. (proceed_2==1) .AND. &
                        (can_consume_drugs==1)) then
                        
                        if (abs(consumption_choice-total_consumption_choice*(1-frac_spent_on_addiction))>10.d0**(-8)) then
            
                            write(*,*) "wrong_2"
                            write(*,*) "consumption_choice=", consumption_choice
                            write(*,*) "total_consumption_choice=", total_consumption_choice
                            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
                        
                        end if
                                                        
                        future_leisure_vector(future_financial_index)=relative_share_of_leisure*&
                            ((max_labor_supply-labor_supply_1)**(1-Frisch_elasticity))/(1-Frisch_elasticity)
                           
                        call calculate_flow_utility(0,future_housing_status_index,&
                            housing_size(future_housing_status_index),frac_spent_on_addiction,&
                            total_consumption_choice,consumption_choice,0,future_addiction_index,&
                            flow_utility_vector(future_financial_index),0)
                            
                        flow_utility_vector(future_financial_index)=&
                            flow_utility_vector(future_financial_index)+&
                            future_leisure_vector(future_financial_index)
                                                                                                                           
                        future_utility_vector=0
                        future_bequest_vector=0
                        
                        if (include_bequest_motive==1) then
                             
                            if ((age_index==life_span) .OR. (have_probablistic_death==1)) then
                            
                                call calculate_bequest_utility(financial_grid(future_financial_index),&
                                    future_bequest_vector(future_financial_index),is_homeless_1,addiction_index)
                                                                                    
                                 future_utility_vector(future_financial_index)=&
                                    future_utility_vector(future_financial_index)+&
                                    future_bequest_vector(future_financial_index)
                                                                           
                            end if
                            
                        end if
                        
                        do future_employment_index=&
                            at_least_one_period_before_retirement*employment_index+&
                            (1-at_least_one_period_before_retirement)*1,&
                            at_least_one_period_before_retirement*employment_index+&
                            (1-at_least_one_period_before_retirement)*employment_grid_size
                        
                            do future_addiction_index_2=&
                                (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*0,&
                                (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*include_addiction
                            
                                check_1=0
                                
                                if (future_addiction_index_2==1) then
                                
                                    check_1=1
                                    
                                end if
                            
                                do future_unemployment_index=include_addiction*&
                                    ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                                    (1-include_addiction)*(at_least_one_period_before_retirement*&
                                    (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                    (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                    ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                                    (1-include_addiction)*(at_least_one_period_before_retirement*&
                                    (one_period_before_death*unemployment_grid_size+&
                                    (1-one_period_before_death)*unemployment_index)+&
                                    (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                    
                                    do future_voucher_index=first_voucher_index,second_voucher_index
                                                                                                                      
                                        future_utility_vector(future_financial_index)=&
                                            future_utility_vector(future_financial_index)+discount_factor*&
                                            survival_probability(age_index,is_homeless_1,addiction_index)*&
                                            voucher_probabilities(voucher_index,future_voucher_index,&
                                            has_opportunity_1,voucher_index_1)*&
                                            employment_process(age_index,employment_index,future_employment_index)*&
                                            unemployment_process(age_index,unemployment_index,&
                                            future_unemployment_index,is_homeless_1,future_addiction_index_2,employment_index)*&
                                            addiction_probabilities_percieved(addiction_index,future_addiction_index_2,&
                                            future_addiction_index,is_homeless_1)*&
                                            value_function(1)%vector_transition_real&
                                            (min(time_period+solve_transition_dynamics,transition_length),age_index+1,&
                                            future_financial_index,future_unemployment_index,future_employment_index,&
                                            future_housing_status_index_to_use,future_voucher_index)
                                            
                                    end do
                                            
                                end do
                                                                                                                                                           
                            end do
                            
                        end do
                                                                       
                        value_function_renter_renter=flow_utility_vector(future_financial_index)+&
                            future_utility_vector(future_financial_index)
                                                                  
                        if (value_function_renter_renter>largest_value) then
                                                                    
                            largest_value=value_function_renter_renter
                                                        
                            optimal_renter_renter_indeces(1)=future_financial_index
                            
                            if (global_search_index==0) then
                            
                                optimal_financial_1=future_financial_index
                                
                            end if
                            
                            optimal_renter_renter_indeces(2)=1
                            optimal_renter_renter_indeces(3)=future_housing_status_index
                            
                            optimal_consumption_renter_renter=consumption_choice
                            
                            if (consumption_choice<=0) then
                            
                                write(*,*) "renter renter eror"
                                
                            end if
                                                                          
                            optimal_after_tax_wealth_net_of_expenses_renter_renter=after_tax_wealth_net_of_expenses
                            optimal_gross_wage_income_renter_renter=gross_wage_income
                            optimal_cutoff_taxable_income_renter_renter=cutoff_taxable_income
                            optimal_wage_income_tax_paid_renter_renter=wage_income_tax_paid
                            optimal_space_lived_in_renter_renter=future_housing_status_index
                            optimal_mortgage_deductions_renter_renter=mortgage_deductions_tax_rebates
                            optimal_household_can_consume_renter_renter=1
                            optimal_labor_supply_renter_renter=labor_supply_1
                            optimal_frac_spent_on_addiction_renter_renter=frac_spent_on_addiction
                            optimal_total_consumption_renter_renter=total_consumption_choice
                            optimal_addiction_status_renter_renter=future_addiction_index
                                                                                                                                                                                                                             
                        end if
                                                                                                                                                                                                                                                           
                    end if
                    
                end do
                
                end do
                
            end do
        
        end do
            
        value_function_renter_renter=largest_value  
            
    end subroutine
    
    subroutine renter_to_owner_problem(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period,financial_index
        integer :: smallest_house,second_smallest_house,is_working_1,x_1,global_search_index
        integer :: max_future_mortgage_index,chooses_positive_mortgage,tenure_1,tenure_2,proceed_2,addiction_index,&
            optimal_financial_1,loop_over_addiction_1,check_1,allow_to_choose_addiction,can_consume_drugs
        real(8) :: max_mortgage_value_allowed,labor_supply_1,labor_supply_2,wealth_1
                                
        allow_to_choose_addiction=1
            
        if (age_index>max_age_to_choose_addiction) then
        
            allow_to_choose_addiction=0
                         
        end if
        
        addiction_index=0
        
        if (unemployment_index>threshold_addiction_index) then
        
            addiction_index=1
            
        end if
        
        proceed_2=1
        tenure_1=1
        tenure_2=0
        
        labor_supply_2=1
                
        is_working_1=1
        
        if ((in_retirement==1) .OR. &
            ((unemployment_index>1) .AND. (unemployment_index<threshold_addiction_index+1)) .OR. &
            (unemployment_index>threshold_addiction_index+1)) then
        
            is_working_1=0
            
        end if
            
        largest_value=large_negative_num
        
        optimal_renter_owner_indeces(1)=1
        optimal_financial_1=1
        optimal_renter_owner_indeces(2)=max_amortization_years
        optimal_renter_owner_indeces(3)=index_of_smallest_house_hhld_can_buy
                 
        optimal_consumption_renter_owner=0
        optimal_after_tax_wealth_net_of_expenses_renter_owner=0
        optimal_gross_wage_income_renter_owner=0
        optimal_cutoff_taxable_income_renter_owner=0
        optimal_wage_income_tax_paid_renter_owner=0
        optimal_space_lived_in_renter_owner=index_of_smallest_house_hhld_can_buy
        optimal_mortgage_deductions_renter_owner=0
        optimal_household_can_consume_renter_owner=0
        optimal_labor_supply_renter_owner=((1-is_working_1)*0+is_working_1*1)
        labor_supply_1=optimal_labor_supply_renter_owner
        optimal_frac_spent_on_addiction_renter_owner=0
        optimal_total_consumption_renter_owner=0
        optimal_addiction_status_renter_owner=0
        
        if (fixed_labor_supply_at_benchmark==1) then
                    
            labor_supply_2=&
                policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,unemployment_index,&
                employment_index,housing_status_index,voucher_index)
                
            labor_supply_1=labor_supply_2
                
        end if
                
        do future_addiction_index=addiction_index,&
            (1-allow_to_choose_addiction)*addiction_index+allow_to_choose_addiction*include_addiction
        
            loop_over_addiction_1=0
                    
            if (addiction_index==1) then
            
                loop_over_addiction_1=1
                
            elseif ((future_addiction_index==1) .AND. &
                (include_probability_of_becoming_addicted==1)) then
            
                loop_over_addiction_1=1
                
            end if
                
            do future_housing_status_index=index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
            
                smallest_house=0
                second_smallest_house=0
                
                if (can_get_mortgage==1) then
                
                    if (housing_price(time_period)*housing_size(future_housing_status_index)<=&
                        fraction_of_average_house_price_data*((1-is_counterfactual)*&
                        model_average_owner_occupied_unit_size(time_period)*&
                        housing_price(time_period)+is_counterfactual*&
                        average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then
                                    
                        smallest_house=1
                        
                    elseif (housing_price(time_period)*housing_size(future_housing_status_index)<=&
                        2*fraction_of_average_house_price_data*((1-is_counterfactual)*&
                        model_average_owner_occupied_unit_size(time_period)*&
                        housing_price(time_period)+is_counterfactual*&
                        average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then 
                        
                        second_smallest_house=1
                        
                    end if
                                    
                    if (in_retirement==1) then
                                                    
                        max_future_mortgage_index=negative_financial_grid_size
                                                    
                    else
                    
                        max_mortgage_value_allowed=&
                            real(1)-real(minimum_downpayment)+smallest_house*min_down_of_smallest+&
                            second_smallest_house*min_down_of_second_smallest
                    
                        max_future_mortgage_index=min(max(minloc(max_mortgage_value_allowed+&
                            financial_grid(1:negative_financial_grid_size),1,mask=(max_mortgage_value_allowed+&
                            financial_grid(1:negative_financial_grid_size))>0),1),negative_financial_grid_size)
                        
                    end if
                        
                else
                
                    max_future_mortgage_index=negative_financial_grid_size
                
                end if
                
                do global_search_index=0,coarse_grid
                            
                do future_mortgage_index=& ! max_future_mortgage_index,financial_grid_size ! &
                    (1-global_search_index)*max_future_mortgage_index+&
                    global_search_index*max(optimal_financial_1-grid_gaps+1,max_future_mortgage_index),&
                    (1-global_search_index)*financial_grid_size+&
                    global_search_index*min(optimal_financial_1+grid_gaps-1,financial_grid_size),&
                    (1-global_search_index)*grid_gaps+global_search_index
                    
                    if (future_mortgage_index<negative_financial_grid_size) then
                    
                        chooses_positive_mortgage=1
                    
                    else
                    
                        chooses_positive_mortgage=0
                    
                    end if
                                    
                    do future_years_of_amortization_index=2,max_amortization_years
                                                                                                   
                        if (((total_household_wealth-housing_price(time_period)*&
                            housing_size(future_housing_status_index)*(1+cost_of_buying+&
                            min(financial_grid(future_mortgage_index),0.d0)))>0) .AND. &
                            (-financial_grid(future_mortgage_index)<=(1-minimum_downpayment+smallest_house*min_down_of_smallest+&
                            second_smallest_house*min_down_of_second_smallest))) then
                                
                            space_lived_in_index_feasible=future_housing_status_index
                                                              
                            if (-financial_grid(future_mortgage_index)>(1-minimum_downpayment)) then
                                                            
                                pay_mortgage_insurance=1
                                max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio
                                    
                            else
                                            
                                pay_mortgage_insurance=0
                                max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio_below_80
                                                
                            end if
                            
                            if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0)) then
                                        
                                labor_supply_2=1
                                                                    
                            end if
                                
                            call calculate_after_tax_wealth&
                                (financial_index,future_mortgage_index,years_left_on_mortgage_index,&
                                pay_mortgage_insurance,housing_status_index,future_housing_status_index,&
                                tenure_2,tenure_2,tenure_1,tenure_2,tenure_2,time_period,labor_supply_2,&
                                cutoff_taxable_income,future_addiction_index)
                                ! owner_to_owner_move_1,owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1
                            
                            if (labor_supply_2>0.4) then
                            if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0) .AND. &
                                ((unemployment_index==1) .OR. (unemployment_index==(threshold_addiction_index+1)))) then
            
                                x_1=2
                                                            
                                call secant(time_period,financial_index,max(financial_grid(future_mortgage_index),0.d0)+&
                                    min(financial_grid(future_mortgage_index),0.d0)*&
                                    housing_price(time_period)*housing_size(future_housing_status_index),&
                                    housing_size(space_lived_in_index_feasible),space_lived_in_index_feasible,&
                                    x_1,after_tax_wealth_net_of_expenses,labor_supply_1,gross_wage_income,&
                                    wage_income_tax_paid,food_stamps_recieved,housing_voucher_recieved,&
                                    housing_voucher_recieved_2,mortgage_deductions_tax_rebates,proceed_2,&
                                    future_addiction_index)
                                                                                 
                            end if
                            end if
                                
                            if (chooses_positive_mortgage==1) then
                                
                                spending_on_housing=housing_price(time_period)*housing_size(future_housing_status_index)*&
                                    ((-min(financial_grid(future_mortgage_index),0.d0)*&
                                    (pay_mortgage_insurance*mortgage_insurance_premium+&
                                    mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))+&
                                    (fraction_of_property_taxes_in_GDS*property_tax(time_period)+&
                                    include_housing_depreciation_in_housing_costs*housing_depreciation_rate))
                                
                            else
                            
                                spending_on_housing=0
                                
                            end if
                                                                           
                            if (((spending_on_housing/(gross_wage_income+investment_income))<=&
                                max_mortgage_payments_as_fraction_of_income) .OR. &
                                (future_mortgage_index>=negative_financial_grid_size)) then
                                                                                                
                                can_consume_drugs=1
                                                               
                                flow_utility_vector(future_mortgage_index)=0
                                                                                                                        
                                if ((consumption_choice>=(food_stamps_recieved/(1+consumption_tax))) .AND. &
                                    (consumption_choice>0) .AND. (frac_spent_on_addiction>=0) .AND. &
                                    (total_consumption_choice>=consumption_choice) .AND. (proceed_2==1) .AND.&
                                    (can_consume_drugs==1)) then
                                    
                                    if (abs(consumption_choice-total_consumption_choice*&
                                        (1-frac_spent_on_addiction))>10.d0**(-8)) then
        
                                        write(*,*) "wrong_2"
                                        write(*,*) "consumption_choice=", consumption_choice
                                        write(*,*) "total_consumption_choice=", total_consumption_choice
                                        write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
                                    
                                    end if
                                                                                                                                
                                    future_leisure_vector(future_mortgage_index)=&
                                        relative_share_of_leisure*((max_labor_supply-labor_supply_1)**&
                                        (1-Frisch_elasticity))/(1-Frisch_elasticity)
                                                                            
                                    call calculate_flow_utility(0,space_lived_in_index_feasible,&
                                        housing_size(space_lived_in_index_feasible),frac_spent_on_addiction,&
                                        total_consumption_choice,consumption_choice,1,future_addiction_index,&
                                        flow_utility_vector(future_mortgage_index),0)
                                        
                                    flow_utility_vector(future_mortgage_index)=&
                                        flow_utility_vector(future_mortgage_index)+&
                                        future_leisure_vector(future_mortgage_index)
                                                                                                                                                                                                                       
                                    future_utility_vector=0
                                    future_bequest_vector=0
                                    
                                    if (include_bequest_motive==1) then
                                                                              
                                        if ((age_index==life_span) .OR. (have_probablistic_death==1)) then
                                                                                
                                            wealth_1=housing_price(time_period)*&
                                                housing_size(future_housing_status_index)*(1-remove_tax_and_depreciation*&
                                                (property_tax(time_period)+housing_depreciation_rate)+&
                                                (1+mortgage_interest_rate(time_period))*&
                                                min(financial_grid(future_mortgage_index),0.d0))+&
                                                max(financial_grid(future_mortgage_index),0.d0)
                                                
                                            call calculate_bequest_utility(wealth_1,&
                                                future_bequest_vector(future_mortgage_index),1,addiction_index)
                                                                        
                                            future_utility_vector(future_mortgage_index)=&
                                                future_utility_vector(future_mortgage_index)+&
                                                future_bequest_vector(future_mortgage_index)
                                                                                                                                      
                                        end if
                                        
                                    end if
                                        
                                    do future_addiction_index_2=&
                                        (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*0,&
                                        (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*include_addiction
                                    
                                        check_1=0
                                        
                                        if (future_addiction_index_2==1) then
                                        
                                            check_1=1
                                            
                                        end if
                                                                        
                                        do future_unemployment_index=include_addiction*&
                                            ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                                            (1-include_addiction)*(at_least_one_period_before_retirement*&
                                            (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                            (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                            ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                                            (1-include_addiction)*(at_least_one_period_before_retirement*&
                                            (one_period_before_death*unemployment_grid_size+&
                                            (1-one_period_before_death)*unemployment_index)+&
                                            (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                                        
                                            do future_employment_index=&
                                                at_least_one_period_before_retirement*employment_index+&
                                                (1-at_least_one_period_before_retirement)*1,&
                                                at_least_one_period_before_retirement*employment_index+&
                                                (1-at_least_one_period_before_retirement)*employment_grid_size
                                                                     
                                                future_utility_vector(future_mortgage_index)=&
                                                    future_utility_vector(future_mortgage_index)+discount_factor*&
                                                    survival_probability(age_index,1,addiction_index)*&
                                                    employment_process(age_index,employment_index,future_employment_index)*&
                                                    unemployment_process(age_index,unemployment_index,&
                                                    future_unemployment_index,1,future_addiction_index_2,employment_index)*&
                                                    addiction_probabilities_percieved(addiction_index,future_addiction_index_2,&
                                                    future_addiction_index,1)*&
                                                    value_function(future_years_of_amortization_index)%&
                                                    vector_transition_real&
                                                    (min(time_period+solve_transition_dynamics,transition_length),&
                                                    age_index+1,future_mortgage_index,future_unemployment_index,&
                                                    future_employment_index,future_housing_status_index,0)
                                                    
                                            end do
                                                                                                                                                                                                                                                                                               
                                        end do
                                        
                                    end do
                                                                     
                                    value_function_renter_owner=flow_utility_vector(future_mortgage_index)+&
                                        future_utility_vector(future_mortgage_index)
                                                                                   
                                    if (value_function_renter_owner>largest_value) then
                                
                                        largest_value=value_function_renter_owner                               
                                                                          
                                        optimal_renter_owner_indeces(1)=future_mortgage_index
                                        
                                        if (global_search_index==0) then
                                        
                                            optimal_financial_1=future_mortgage_index
                                            
                                        end if
                                        
                                        optimal_renter_owner_indeces(2)=future_years_of_amortization_index
                                        optimal_renter_owner_indeces(3)=future_housing_status_index
                        
                                        optimal_consumption_renter_owner=consumption_choice
                                        
                                        if (consumption_choice<=0) then
                            
                                            write(*,*) "renter owner eror"
                                        
                                        end if
                                        
                                        optimal_after_tax_wealth_net_of_expenses_renter_owner=after_tax_wealth_net_of_expenses
                                            
                                        optimal_gross_wage_income_renter_owner=gross_wage_income
                                        optimal_cutoff_taxable_income_renter_owner=cutoff_taxable_income
                                        optimal_wage_income_tax_paid_renter_owner=wage_income_tax_paid
                                        optimal_space_lived_in_renter_owner=space_lived_in_index_feasible
                                        optimal_mortgage_deductions_renter_owner=mortgage_deductions_tax_rebates
                                        optimal_household_can_consume_renter_owner=1
                                        optimal_labor_supply_renter_owner=labor_supply_1
                                        optimal_frac_spent_on_addiction_renter_owner=frac_spent_on_addiction
                                        optimal_total_consumption_renter_owner=total_consumption_choice
                                        optimal_addiction_status_renter_owner=future_addiction_index
                                                                                                                                                                                                
                                    end if
                                                                                    
                                end if
                                
                            end if
                        
                        end if
                        
                    end do
                                   
                end do
                
                end do
                    
            end do
            
        end do
        
        value_function_renter_owner=largest_value
                
    end subroutine
    
    subroutine owners_problem(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
            
        integer, intent(in) :: time_period,financial_index
                                                                                
        call owner_owner_stay_problem(time_period,financial_index)
        
        if (smallest_index_for_purchase==(housing_status_grid_size-1)) then
        
            value_function_owner_owner_move=large_negative_num
            
        else
                
            call owner_owner_move_problem(time_period,financial_index)
            
        end if
                
        call owner_renter_problem(time_period,financial_index)
                                            
        if (value_function_owner_owner_stay>value_function_owner_owner_move) then
        
            if (value_function_owner_owner_stay>value_function_owner_renter) then
                    
                value_function_owner=value_function_owner_owner_stay
                                                                                     
                optimal_owner_indeces(1)=optimal_owner_owner_stay_indeces(1)
                optimal_owner_indeces(2)=optimal_owner_owner_stay_indeces(2)
                optimal_owner_indeces(3)=optimal_owner_owner_stay_indeces(3)

                optimal_consumption_owner=optimal_consumption_owner_owner_stay
                optimal_after_tax_wealth_net_of_expenses_owner=&
                    optimal_after_tax_wealth_net_of_expenses_owner_owner_stay
                optimal_gross_wage_income_owner=optimal_gross_wage_income_owner_owner_stay
                optimal_cutoff_taxable_income_owner=optimal_cutoff_taxable_income_owner_owner_stay
                optimal_wage_income_tax_paid_owner=optimal_wage_income_tax_paid_owner_owner_stay
                optimal_space_lived_in_owner=optimal_space_lived_in_owner_owner_stay
                optimal_mortgage_deductions_owner=optimal_mortgage_deductions_owner_owner_stay
                optimal_household_can_consume_owner=optimal_household_can_consume_owner_owner_stay
                optimal_labor_supply_owner=optimal_labor_supply_owner_owner_stay
                optimal_frac_spent_on_addiction_owner=optimal_frac_spent_on_addiction_owner_owner_stay
                optimal_total_consumption_owner=optimal_total_consumption_owner_owner_stay
                optimal_addiction_status_owner=optimal_addiction_status_owner_owner_stay
                
                if ((unemployment_index>threshold_addiction_index) .AND. &
                    (optimal_addiction_status_owner_owner_stay==0) .AND. &
                    (optimal_after_tax_wealth_net_of_expenses_owner>0)) then
                
                    write(*,*) "wrong stay"
                
                end if
                
            else
            
                value_function_owner=value_function_owner_renter
                                                                                     
                optimal_owner_indeces(1)=optimal_owner_renter_indeces(1)
                optimal_owner_indeces(2)=optimal_owner_renter_indeces(2)
                optimal_owner_indeces(3)=optimal_owner_renter_indeces(3)

                optimal_consumption_owner=optimal_consumption_owner_renter
                optimal_after_tax_wealth_net_of_expenses_owner=&
                    optimal_after_tax_wealth_net_of_expenses_owner_renter
                optimal_gross_wage_income_owner=optimal_gross_wage_income_owner_renter
                 optimal_cutoff_taxable_income_owner=optimal_cutoff_taxable_income_owner_renter
                optimal_wage_income_tax_paid_owner=optimal_wage_income_tax_paid_owner_renter
                optimal_space_lived_in_owner=optimal_space_lived_in_owner_renter
                optimal_mortgage_deductions_owner=optimal_mortgage_deductions_owner_renter
                optimal_household_can_consume_owner=optimal_household_can_consume_owner_renter
                optimal_labor_supply_owner=optimal_labor_supply_owner_renter
                optimal_frac_spent_on_addiction_owner=optimal_frac_spent_on_addiction_owner_renter
                optimal_total_consumption_owner=optimal_total_consumption_owner_renter
                optimal_addiction_status_owner=optimal_addiction_status_owner_renter
                
                if ((unemployment_index>threshold_addiction_index) .AND. &
                    (optimal_addiction_status_owner_renter==0) .AND. &
                    (optimal_after_tax_wealth_net_of_expenses_owner>0)) then
                
                    write(*,*) "wrong owner renter"
                
                end if
                
            end if
            
        else
        
            if (value_function_owner_owner_move>value_function_owner_renter) then
                    
                value_function_owner=value_function_owner_owner_move
                                                                                     
                optimal_owner_indeces(1)=optimal_owner_owner_move_indeces(1)
                optimal_owner_indeces(2)=optimal_owner_owner_move_indeces(2)
                optimal_owner_indeces(3)=optimal_owner_owner_move_indeces(3)

                optimal_consumption_owner=optimal_consumption_owner_owner_move
                optimal_after_tax_wealth_net_of_expenses_owner=&
                    optimal_after_tax_wealth_net_of_expenses_owner_owner_move
                optimal_gross_wage_income_owner=optimal_gross_wage_income_owner_owner_move
                optimal_cutoff_taxable_income_owner=optimal_cutoff_taxable_income_owner_owner_move
                optimal_wage_income_tax_paid_owner=optimal_wage_income_tax_paid_owner_owner_move
                optimal_space_lived_in_owner=optimal_space_lived_in_owner_owner_move
                optimal_mortgage_deductions_owner=optimal_mortgage_deductions_owner_owner_move
                optimal_household_can_consume_owner=optimal_household_can_consume_owner_owner_move
                optimal_labor_supply_owner=optimal_labor_supply_owner_owner_move
                optimal_frac_spent_on_addiction_owner=optimal_frac_spent_on_addiction_owner_owner_move
                optimal_total_consumption_owner=optimal_total_consumption_owner_owner_move
                optimal_addiction_status_owner=optimal_addiction_status_owner_owner_move
                
                if ((unemployment_index>threshold_addiction_index) .AND. &
                    (optimal_addiction_status_owner_owner_move==0) .AND. &
                    (optimal_after_tax_wealth_net_of_expenses_owner>0)) then
                
                    write(*,*) "wrong owner ower move"
                
                end if

            else
            
                value_function_owner=value_function_owner_renter
                                                                                     
                optimal_owner_indeces(1)=optimal_owner_renter_indeces(1)
                optimal_owner_indeces(2)=optimal_owner_renter_indeces(2)
                optimal_owner_indeces(3)=optimal_owner_renter_indeces(3)

                optimal_consumption_owner=optimal_consumption_owner_renter
                optimal_after_tax_wealth_net_of_expenses_owner=&
                    optimal_after_tax_wealth_net_of_expenses_owner_renter
                optimal_gross_wage_income_owner=optimal_gross_wage_income_owner_renter
                optimal_cutoff_taxable_income_owner=optimal_cutoff_taxable_income_owner_renter
                optimal_wage_income_tax_paid_owner=optimal_wage_income_tax_paid_owner_renter
                optimal_space_lived_in_owner=optimal_space_lived_in_owner_renter
                optimal_mortgage_deductions_owner=optimal_mortgage_deductions_owner_renter
                optimal_household_can_consume_owner=optimal_household_can_consume_owner_renter
                optimal_labor_supply_owner=optimal_labor_supply_owner_renter
                optimal_frac_spent_on_addiction_owner=optimal_frac_spent_on_addiction_owner_renter
                optimal_total_consumption_owner=optimal_total_consumption_owner_renter
                optimal_addiction_status_owner=optimal_addiction_status_owner_renter
                
                if ((unemployment_index>threshold_addiction_index) .AND. &
                    (optimal_addiction_status_owner_renter==0) .AND.&
                    (optimal_after_tax_wealth_net_of_expenses_owner>0)) then
                
                    write(*,*) "wrong owner renter"
                
                end if
                
            end if
            
        end if
                                
    end subroutine
    
    subroutine owner_owner_stay_problem(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period,financial_index
        integer :: max_future_mortgage_index,smallest_house,second_smallest_house,&
            tenure_1,tenure_2,proceed_2,is_working_1,x_1,addiction_index,global_search_index,optimal_financial_1,&
            first_iteration_1,loop_over_addiction_1,check_1,allow_to_choose_addiction,can_consume_drugs
        real(8) :: max_mortgage_value_allowed,labor_supply_1,labor_supply_2,wealth_1

        allow_to_choose_addiction=1
            
        if (age_index>max_age_to_choose_addiction) then
        
            allow_to_choose_addiction=0
                         
        end if
        
        addiction_index=0
        
        if (unemployment_index>threshold_addiction_index) then
        
            addiction_index=1
            
        end if

        proceed_2=1
        tenure_1=1
        tenure_2=0

        labor_supply_2=1
                
        is_working_1=1
        
        if ((in_retirement==1) .OR. &
            ((unemployment_index>1) .AND. (unemployment_index<threshold_addiction_index+1)) .OR. &
            (unemployment_index>threshold_addiction_index+1)) then
        
            is_working_1=0
            
        end if
                                
        largest_value=large_negative_num
                        
        optimal_owner_owner_stay_indeces(1)=1
        optimal_financial_1=1
        optimal_owner_owner_stay_indeces(2)=years_left_on_mortgage_index
        optimal_owner_owner_stay_indeces(3)=housing_status_index
                                    
        optimal_gross_wage_income_owner_owner_stay=0
        optimal_cutoff_taxable_income_owner_owner_stay=0
        optimal_wage_income_tax_paid_owner_owner_stay=0
        optimal_after_tax_wealth_net_of_expenses_owner_owner_stay=0
        optimal_consumption_owner_owner_stay=0
        optimal_space_lived_in_owner_owner_stay=index_of_smallest_house_hhld_can_buy
        optimal_mortgage_deductions_owner_owner_stay=0
        optimal_household_can_consume_owner_owner_stay=0
        optimal_labor_supply_owner_owner_stay=((1-is_working_1)*0+is_working_1*1)
        labor_supply_1=optimal_labor_supply_owner_owner_stay
        optimal_frac_spent_on_addiction_owner_owner_stay=0
        optimal_total_consumption_owner_owner_stay=0
        optimal_addiction_status_owner_owner_stay=0
        
        if (fixed_labor_supply_at_benchmark==1) then
                    
            labor_supply_2=&
                policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,unemployment_index,&
                employment_index,housing_status_index,voucher_index)
                
            labor_supply_1=labor_supply_2
                
        end if
                                
        space_lived_in_index_feasible=housing_status_index
                
        do future_addiction_index=addiction_index,&
            (1-allow_to_choose_addiction)*addiction_index+allow_to_choose_addiction*include_addiction
        
            loop_over_addiction_1=0
                    
            if (addiction_index==1) then
            
                loop_over_addiction_1=1
                
            elseif ((future_addiction_index==1) .AND. &
                (include_probability_of_becoming_addicted==1)) then
            
                loop_over_addiction_1=1
                
            end if
                                 
            smallest_house=0
            second_smallest_house=0 
                        
            if (can_get_mortgage==1) then
                                  
                if (housing_price(time_period)*housing_size(housing_status_index)<=&
                    fraction_of_average_house_price_data*((1-is_counterfactual)*&
                    model_average_owner_occupied_unit_size(time_period)*&
                    housing_price(time_period)+is_counterfactual*&
                    average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then
                                
                    smallest_house=1
                    
                elseif (housing_price(time_period)*housing_size(housing_status_index)<=&
                    2*fraction_of_average_house_price_data*((1-is_counterfactual)*&
                    model_average_owner_occupied_unit_size(time_period)*&
                    housing_price(time_period)+is_counterfactual*&
                    average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then 
                    
                    second_smallest_house=1
                    
                end if
                
                if (in_retirement==1) then
                   
                    max_mortgage_value_allowed=-min(financial_grid(financial_index),0.d0)*(1-fraction_to_repay)
                        
                    max_future_mortgage_index=min(max(minloc(max_mortgage_value_allowed+&
                        financial_grid(1:negative_financial_grid_size),1,mask=(max_mortgage_value_allowed+&
                        financial_grid(1:negative_financial_grid_size))>=0),1),negative_financial_grid_size)
                                                            
                else
                    
                    max_mortgage_value_allowed=real(1)-real(minimum_downpayment)+&
                        smallest_house*min_down_of_smallest+second_smallest_house*min_down_of_second_smallest
                
                    max_future_mortgage_index=min(max(minloc(max_mortgage_value_allowed+&
                        financial_grid(1:negative_financial_grid_size),1,&
                        mask=(max_mortgage_value_allowed+financial_grid(1:negative_financial_grid_size))>=0),1),&
                        negative_financial_grid_size)
                    
                end if
                    
            else
            
                max_future_mortgage_index=negative_financial_grid_size
            
            end if
            
            do global_search_index=coarse_grid*(-1),coarse_grid
            
            first_iteration_1=0
                
            if (global_search_index==-1) then
            
                first_iteration_1=1
                
            end if
                                                        
            do future_mortgage_index=& !max_future_mortgage_index,financial_grid_size
                first_iteration_1*financial_index+&
                (1-first_iteration_1)*((1-global_search_index)*max_future_mortgage_index+&
                global_search_index*max(optimal_financial_1-grid_gaps+1,max_future_mortgage_index)),&
                first_iteration_1*min(financial_index+2,financial_grid_size)+&
                (1-first_iteration_1)*((1-global_search_index)*financial_grid_size+&
                global_search_index*min(optimal_financial_1+grid_gaps-1,financial_grid_size)),&
                first_iteration_1*1+(1-first_iteration_1)*((1-global_search_index)*grid_gaps+global_search_index)
                                                    
                do future_years_of_amortization_index=2,max_amortization_years
                                
                    if (-financial_grid(future_mortgage_index)>(1-minimum_downpayment)) then
                                                    
                        pay_mortgage_insurance=1
                        max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio
                            
                    else
                                    
                        pay_mortgage_insurance=0
                        max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio_below_80
                                        
                    end if
                    
                    if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0)) then
                                             
                        labor_supply_2=1
                                               
                    end if
                                                     
                    call calculate_after_tax_wealth&
                        (financial_index,future_mortgage_index,years_left_on_mortgage_index,pay_mortgage_insurance,&
                        housing_status_index,housing_status_index,tenure_2,tenure_2,tenure_2,tenure_1,tenure_2,&
                        time_period,labor_supply_2,cutoff_taxable_income,future_addiction_index)
                        ! owner_to_owner_move_1,owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1
                     
                    if (labor_supply_2>0.4) then 
                    if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0) .AND. &
                        ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1))) then
                                            
                        x_1=2
                                            
                        call secant(time_period,financial_index,max(financial_grid(future_mortgage_index),0.d0)+&
                            min(financial_grid(future_mortgage_index),0.d0)*&
                            housing_price(time_period)*housing_size(housing_status_index),&
                            housing_size(space_lived_in_index_feasible),space_lived_in_index_feasible,&
                            x_1,after_tax_wealth_net_of_expenses,labor_supply_1,gross_wage_income,&
                            wage_income_tax_paid,food_stamps_recieved,housing_voucher_recieved,&
                            housing_voucher_recieved_2,mortgage_deductions_tax_rebates,proceed_2,future_addiction_index)
                                                                   
                    end if
                    end if
                    
                    if (future_mortgage_index<negative_financial_grid_size) then
                                                                   
                        if (financial_grid(future_mortgage_index)<(1-fraction_to_repay)*financial_grid(financial_index)) then
                            
                            spending_on_housing=housing_price(time_period)*housing_size(housing_status_index)*&
                                ((-min(financial_grid(future_mortgage_index),0.d0)*&
                                (pay_mortgage_insurance*mortgage_insurance_premium+&
                                mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))+&
                                (fraction_of_property_taxes_in_GDS*property_tax(time_period)+&
                                include_housing_depreciation_in_housing_costs*housing_depreciation_rate))
                            
                        else
                        
                            spending_on_housing=0
                        
                        end if
                                                                      
                    else
                    
                        spending_on_housing=0
                    
                    end if
                        
                    if (((spending_on_housing/(gross_wage_income+investment_income))<=&
                        max_mortgage_payments_as_fraction_of_income) .OR. &
                        (future_mortgage_index>=negative_financial_grid_size)) then
                        
                        can_consume_drugs=1
                                                                                      
                        if ((consumption_choice>=(food_stamps_recieved/(1+consumption_tax))) .AND. &
                            (consumption_choice>0) .AND. (frac_spent_on_addiction>=0) .AND. &
                            (total_consumption_choice>=consumption_choice) .AND. (proceed_2==1) .AND. &
                            (can_consume_drugs==1)) then
                            
                            if (abs(consumption_choice-total_consumption_choice*(1-frac_spent_on_addiction))>10.d0**(-8)) then
        
                                write(*,*) "wrong_2"
                                write(*,*) "consumption_choice=", consumption_choice
                                write(*,*) "total_consumption_choice=", total_consumption_choice
                                write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
                            
                            end if
                                                                            
                            future_leisure_vector(future_mortgage_index)=relative_share_of_leisure*&
                                ((max_labor_supply-labor_supply_1)**(1-Frisch_elasticity))/(1-Frisch_elasticity)
                                                            
                            call calculate_flow_utility(0,space_lived_in_index_feasible,&
                                housing_size(space_lived_in_index_feasible),frac_spent_on_addiction,&
                                total_consumption_choice,consumption_choice,1,future_addiction_index,&
                                flow_utility_vector(future_mortgage_index),0)
                                
                            flow_utility_vector(future_mortgage_index)=&
                                flow_utility_vector(future_mortgage_index)+&
                                future_leisure_vector(future_mortgage_index)
                                                                                                                                                                                                               
                            future_utility_vector=0
                            future_bequest_vector=0
                            
                            if (include_bequest_motive==1) then
                                                                      
                                if ((age_index==life_span) .OR. (have_probablistic_death==1)) then
                                
                                    wealth_1=housing_price(time_period)*housing_size(housing_status_index)*&
                                        (1-remove_tax_and_depreciation*&
                                        (property_tax(time_period)+housing_depreciation_rate)+&
                                        (1+mortgage_interest_rate(time_period))*&
                                        min(financial_grid(future_mortgage_index),0.d0))+&
                                        max(financial_grid(future_mortgage_index),0.d0)
                                        
                                    call calculate_bequest_utility(wealth_1,&
                                        future_bequest_vector(future_mortgage_index),1,addiction_index)
                                                                
                                    future_utility_vector(future_mortgage_index)=&
                                        future_utility_vector(future_mortgage_index)+&
                                        future_bequest_vector(future_mortgage_index)
                                                                                                                                                            
                                end if
                                
                            end if
                                
                            do future_addiction_index_2=&
                                (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*0,&
                                (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*include_addiction
                            
                                check_1=0
                                
                                if (future_addiction_index_2==1) then
                                
                                    check_1=1
                                    
                                end if
                                                        
                                do future_unemployment_index=include_addiction*&
                                    ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                                    (1-include_addiction)*(at_least_one_period_before_retirement*&
                                    (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                    (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                    ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                                    (1-include_addiction)*(at_least_one_period_before_retirement*&
                                    (one_period_before_death*unemployment_grid_size+&
                                    (1-one_period_before_death)*unemployment_index)+&
                                    (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                                
                                    do future_employment_index=&
                                        at_least_one_period_before_retirement*employment_index+&
                                        (1-at_least_one_period_before_retirement)*1,&
                                        at_least_one_period_before_retirement*employment_index+&
                                        (1-at_least_one_period_before_retirement)*employment_grid_size
                                                                                                                                                                                                                                           
                                        future_utility_vector(future_mortgage_index)=&
                                            future_utility_vector(future_mortgage_index)+&
                                            discount_factor*survival_probability(age_index,1,addiction_index)*&
                                            employment_process(age_index,employment_index,future_employment_index)*&
                                            unemployment_process(age_index,unemployment_index,&
                                            future_unemployment_index,1,future_addiction_index_2,employment_index)*&
                                            addiction_probabilities_percieved(addiction_index,future_addiction_index_2,&
                                            future_addiction_index,1)*&
                                            value_function(future_years_of_amortization_index)%&
                                            vector_transition_real(min(time_period+solve_transition_dynamics,transition_length),&
                                            age_index+1,future_mortgage_index,future_unemployment_index,&
                                            future_employment_index,housing_status_index,0)
                                                                                                                            
                                    end do
                                    
                                end do
                            
                            end do
                                                                                            
                            value_function_owner_owner_stay=&
                                flow_utility_vector(future_mortgage_index)+&
                                future_utility_vector(future_mortgage_index)
                                                                          
                            if (value_function_owner_owner_stay>largest_value) then
                        
                                largest_value=value_function_owner_owner_stay
                                                                                                  
                                optimal_owner_owner_stay_indeces(1)=future_mortgage_index
                                
                                if (global_search_index<=0) then
                                
                                    optimal_financial_1=optimal_owner_owner_stay_indeces(1)
                                    
                                end if
                                
                                optimal_owner_owner_stay_indeces(2)=future_years_of_amortization_index
                                optimal_owner_owner_stay_indeces(3)=housing_status_index
                                optimal_consumption_owner_owner_stay=consumption_choice
                                
                                if (consumption_choice<=0) then
                            
                                    write(*,*) "owner owner stay eror"
                                    
                                end if
                                
                                optimal_after_tax_wealth_net_of_expenses_owner_owner_stay=after_tax_wealth_net_of_expenses
                                optimal_gross_wage_income_owner_owner_stay=gross_wage_income
                                optimal_cutoff_taxable_income_owner_owner_stay=cutoff_taxable_income
                                optimal_wage_income_tax_paid_owner_owner_stay=wage_income_tax_paid
                                optimal_space_lived_in_owner_owner_stay=space_lived_in_index_feasible
                                optimal_mortgage_deductions_owner_owner_stay=mortgage_deductions_tax_rebates
                                optimal_household_can_consume_owner_owner_stay=1     
                                optimal_labor_supply_owner_owner_stay=labor_supply_1
                                optimal_frac_spent_on_addiction_owner_owner_stay=frac_spent_on_addiction
                                optimal_total_consumption_owner_owner_stay=total_consumption_choice
                                optimal_addiction_status_owner_owner_stay=future_addiction_index
                                
                                if ((unemployment_index>threshold_addiction_index) .AND. &
                                    (optimal_addiction_status_owner_owner_stay==0)) then
                                
                                    write(*,*) "wrong stay 1"
                                
                                end if
                                                                                                                                        
                            end if
                                                                            
                        end if
                        
                    end if
                                            
                end do
                
                end do
                                    
            end do
            
        end do
        
        value_function_owner_owner_stay=largest_value
        
    end subroutine
        
    subroutine owner_owner_move_problem(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
            
        integer, intent(in) :: time_period,financial_index
        integer :: smallest_house,second_smallest_house,is_working_1,x_1,&
            global_search_index,optimal_financial_1,loop_over_addiction_1,check_1
        integer :: max_future_mortgage_index,chooses_positive_mortgage,tenure_1,tenure_2,proceed_2,addiction_index,&
            allow_to_choose_addiction,can_consume_drugs
        real(8) :: max_mortgage_value_allowed,labor_supply_1,labor_supply_2,wealth_1
                                
        allow_to_choose_addiction=1
            
        if (age_index>max_age_to_choose_addiction) then
        
            allow_to_choose_addiction=0
                         
        end if
        
        addiction_index=0
        
        if (unemployment_index>threshold_addiction_index) then
        
            addiction_index=1
            
        end if
        
        proceed_2=1
        tenure_1=1
        tenure_2=0
                
        labor_supply_2=1
                
        is_working_1=1
        
        if ((in_retirement==1) .OR. &
            ((unemployment_index>1) .AND. (unemployment_index<threshold_addiction_index+1)) .OR. &
            (unemployment_index>threshold_addiction_index+1)) then
        
            is_working_1=0
            
        end if
        
        largest_value=large_negative_num
                        
        optimal_owner_owner_move_indeces(1)=1
        optimal_financial_1=1
        optimal_owner_owner_move_indeces(2)=max_amortization_years
        optimal_owner_owner_move_indeces(3)=index_of_smallest_house_hhld_can_buy
                                    
        optimal_consumption_owner_owner_move=0
        optimal_gross_wage_income_owner_owner_move=0
        optimal_cutoff_taxable_income_owner_owner_move=0
        optimal_wage_income_tax_paid_owner_owner_move=0
        optimal_after_tax_wealth_net_of_expenses_owner_owner_move=0
        optimal_space_lived_in_owner_owner_move=index_of_smallest_house_hhld_can_buy
        optimal_mortgage_deductions_owner_owner_move=0
        optimal_household_can_consume_owner_owner_move=0
        optimal_labor_supply_owner_owner_move=((1-is_working_1)*0+is_working_1*1)
        labor_supply_1=optimal_labor_supply_owner_owner_move
        optimal_frac_spent_on_addiction_owner_owner_move=0
        optimal_total_consumption_owner_owner_move=0
        optimal_addiction_status_owner_owner_move=0
        
        if (fixed_labor_supply_at_benchmark==1) then
                    
            labor_supply_2=&
                policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,unemployment_index,&
                employment_index,housing_status_index,voucher_index)
                
            labor_supply_1=labor_supply_2
                
        end if
                
        do future_addiction_index=addiction_index,&
            (1-allow_to_choose_addiction)*addiction_index+allow_to_choose_addiction*include_addiction
        
            loop_over_addiction_1=0
                
            if (addiction_index==1) then
            
                loop_over_addiction_1=1
                
            elseif ((future_addiction_index==1) .AND. &
                (include_probability_of_becoming_addicted==1)) then
            
                loop_over_addiction_1=1
                
            end if
                                        
            do future_housing_status_index=index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
            
                smallest_house=0
                second_smallest_house=0
                
                if (future_housing_status_index==-1) then
                
                else
                
                    if (can_get_mortgage==1) then
                    
                        if (housing_price(time_period)*housing_size(future_housing_status_index)<=&
                            fraction_of_average_house_price_data*((1-is_counterfactual)*&
                            model_average_owner_occupied_unit_size(time_period)*&
                            housing_price(time_period)+is_counterfactual*&
                            average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then
                                    
                            smallest_house=1
                            
                        elseif (housing_price(time_period)*housing_size(future_housing_status_index)<=&
                            2*fraction_of_average_house_price_data*((1-is_counterfactual)*&
                            model_average_owner_occupied_unit_size(time_period)*&
                            housing_price(time_period)+is_counterfactual*&
                            average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then 
                            
                            second_smallest_house=1
                            
                        end if
                        
                        if (in_retirement==1) then
                                                            
                            max_future_mortgage_index=negative_financial_grid_size
                                                            
                        else
                                                        
                            max_mortgage_value_allowed=real(1)-real(minimum_downpayment)+&
                                smallest_house*min_down_of_smallest+second_smallest_house*min_down_of_second_smallest
                        
                            max_future_mortgage_index=min(max(minloc(max_mortgage_value_allowed+&
                                financial_grid(1:negative_financial_grid_size),1,&
                                mask=(max_mortgage_value_allowed+financial_grid(1:negative_financial_grid_size))>=0),1),&
                                negative_financial_grid_size)
                            
                        end if
                            
                    else
                    
                        max_future_mortgage_index=negative_financial_grid_size
                    
                    end if
                    
                    do global_search_index=0,coarse_grid
                                                        
                    do future_mortgage_index=& !max_future_mortgage_index,financial_grid_size !&
                        (1-global_search_index)*max_future_mortgage_index+&
                        global_search_index*max(optimal_financial_1-grid_gaps+1,max_future_mortgage_index),&
                        (1-global_search_index)*financial_grid_size+&
                        global_search_index*min(optimal_financial_1+grid_gaps-1,financial_grid_size),&
                        (1-global_search_index)*grid_gaps+global_search_index
                        
                        if (future_mortgage_index<negative_financial_grid_size) then
                        
                            chooses_positive_mortgage=1
                        
                        else
                        
                            chooses_positive_mortgage=0
                        
                        end if
                                            
                        do future_years_of_amortization_index=2,max_amortization_years
                                                                                                      
                            if (((total_household_wealth+min(financial_grid(financial_index),0.d0)*&
                                housing_price(time_period)*housing_size(housing_status_index)*&
                                (1+mortgage_interest_rate(time_period))-housing_price(time_period)*&
                                (housing_size(housing_status_index)*cost_of_selling+&
                                housing_size(future_housing_status_index)*cost_of_buying)-&
                                housing_price(time_period)*housing_size(future_housing_status_index)*&
                                (1+min(financial_grid(future_mortgage_index),0.d0)))>0) .AND. &
                                (-financial_grid(future_mortgage_index)<&
                                (1-minimum_downpayment+smallest_house*min_down_of_smallest+&
                                second_smallest_house*min_down_of_second_smallest))) then
                                                                        
                                space_lived_in_index_feasible=future_housing_status_index
                                    
                                if (-financial_grid(future_mortgage_index)>(1-minimum_downpayment)) then
                                                                
                                    pay_mortgage_insurance=1
                                    max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio
                                        
                                else
                                                
                                    pay_mortgage_insurance=0
                                    max_mortgage_payments_as_fraction_of_income=max_debt_to_income_ratio_below_80
                                                    
                                end if
                                
                                if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0)) then
                                            
                                    labor_supply_2=1
                                                                        
                                end if
                                    
                                call calculate_after_tax_wealth&
                                    (financial_index,future_mortgage_index,years_left_on_mortgage_index,&
                                    pay_mortgage_insurance,housing_status_index,future_housing_status_index,&
                                    tenure_1,tenure_2,tenure_2,tenure_2,tenure_2,time_period,labor_supply_2,&
                                    cutoff_taxable_income,future_addiction_index)
                                    ! owner_to_owner_move_1,owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1
                                   
                                if (labor_supply_2>0.4) then
                                if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0).AND. &
                                    ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1))) then
                
                                    x_1=2
                                                                
                                    call secant(time_period,financial_index,max(financial_grid(future_mortgage_index),0.d0)+&
                                        min(financial_grid(future_mortgage_index),0.d0)*&
                                        housing_price(time_period)*housing_size(future_housing_status_index),&
                                        housing_size(space_lived_in_index_feasible),future_housing_status_index,&
                                        x_1,after_tax_wealth_net_of_expenses,labor_supply_1,gross_wage_income,&
                                        wage_income_tax_paid,food_stamps_recieved,housing_voucher_recieved,&
                                        housing_voucher_recieved_2,mortgage_deductions_tax_rebates,proceed_2,&
                                        future_addiction_index)
                                                                                        
                                end if
                                end if
                                                                
                                if (chooses_positive_mortgage==1) then
                                                                                                                                                                            
                                    spending_on_housing=&
                                        housing_price(time_period)*housing_size(future_housing_status_index)*&
                                        ((-min(financial_grid(future_mortgage_index),0.d0)*&
                                        (pay_mortgage_insurance*mortgage_insurance_premium+&
                                        mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))+&
                                        (fraction_of_property_taxes_in_GDS*property_tax(time_period)+&
                                        include_housing_depreciation_in_housing_costs*housing_depreciation_rate))
                                        
                                else
                                
                                    spending_on_housing=0
                                
                                end if
                                                                                
                                if (((spending_on_housing/(gross_wage_income+investment_income))<=&
                                    max_mortgage_payments_as_fraction_of_income) .OR. &
                                    (future_mortgage_index>=negative_financial_grid_size)) then
                                    
                                    can_consume_drugs=1
                                                                        
                                    if ((consumption_choice>=(food_stamps_recieved/(1+consumption_tax))) .AND. &
                                        (consumption_choice>0) .AND. (frac_spent_on_addiction>=0) .AND. &
                                        (total_consumption_choice>=consumption_choice) .AND. (proceed_2==1) .AND. &
                                        (can_consume_drugs==1)) then
                                        
                                        if (abs(consumption_choice-total_consumption_choice*&
                                            (1-frac_spent_on_addiction))>10.d0**(-8)) then
        
                                            write(*,*) "wrong_2"
                                            write(*,*) "consumption_choice=", consumption_choice
                                            write(*,*) "total_consumption_choice=", total_consumption_choice
                                            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
                                        
                                        end if
                                                                                                                
                                        future_leisure_vector(future_mortgage_index)=&
                                            relative_share_of_leisure*((max_labor_supply-labor_supply_1)**&
                                            (1-Frisch_elasticity))/(1-Frisch_elasticity)
                                                                                    
                                        call calculate_flow_utility(0,space_lived_in_index_feasible,&
                                            housing_size(space_lived_in_index_feasible),frac_spent_on_addiction,&
                                            total_consumption_choice,consumption_choice,1,future_addiction_index,&
                                            flow_utility_vector(future_mortgage_index),0)
                                            
                                        flow_utility_vector(future_mortgage_index)=&
                                            flow_utility_vector(future_mortgage_index)+&
                                            future_leisure_vector(future_mortgage_index)
                                                                                                                                                                                                                                                       
                                        future_utility_vector=0
                                        future_bequest_vector=0
                                        
                                        if (include_bequest_motive==1) then
                                        
                                            if ((age_index==life_span) .OR. (have_probablistic_death==1)) then
                                            
                                                wealth_1=housing_price(time_period)*&
                                                    housing_size(future_housing_status_index)*&
                                                    (1-remove_tax_and_depreciation*&
                                                    (property_tax(time_period)+housing_depreciation_rate)+&
                                                    (1+mortgage_interest_rate(time_period))*&
                                                    min(financial_grid(future_mortgage_index),0.d0))+&
                                                    max(financial_grid(future_mortgage_index),0.d0)
                                                    
                                                call calculate_bequest_utility(wealth_1,&
                                                    future_bequest_vector(future_mortgage_index),1,addiction_index)
                                                                            
                                                future_utility_vector(future_mortgage_index)=&
                                                    future_utility_vector(future_mortgage_index)+&
                                                    future_bequest_vector(future_mortgage_index)
                                                                                                                                                            
                                            end if
                                            
                                        end if
                                        
                                        do future_addiction_index_2=&
                                            (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*0,&
                                            (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*include_addiction
                                        
                                            check_1=0
                                            
                                            if (future_addiction_index_2==1) then
                                            
                                                check_1=1
                                                
                                            end if
                                        
                                            do future_unemployment_index=include_addiction*&
                                                ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                                                (1-include_addiction)*(at_least_one_period_before_retirement*&
                                                (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                                (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                                ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                                                (1-include_addiction)*(at_least_one_period_before_retirement*&
                                                (one_period_before_death*unemployment_grid_size+&
                                                (1-one_period_before_death)*unemployment_index)+&
                                                (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                                            
                                                do future_employment_index=&
                                                    at_least_one_period_before_retirement*employment_index+&
                                                    (1-at_least_one_period_before_retirement)*1,&
                                                    at_least_one_period_before_retirement*employment_index+&
                                                    (1-at_least_one_period_before_retirement)*employment_grid_size
                                                                                                                                                                                                                                                                                                 
                                                    future_utility_vector(future_mortgage_index)=&
                                                        future_utility_vector(future_mortgage_index)+&
                                                        discount_factor*survival_probability(age_index,1,addiction_index)*&
                                                        employment_process(age_index,employment_index,future_employment_index)*&
                                                        unemployment_process(age_index,unemployment_index,&
                                                        future_unemployment_index,1,future_addiction_index_2,employment_index)*&
                                                        addiction_probabilities_percieved(addiction_index,future_addiction_index_2,&
                                                        future_addiction_index,1)*&
                                                        value_function(future_years_of_amortization_index)%vector_transition_real&
                                                        (min(time_period+solve_transition_dynamics,transition_length),age_index+1,&
                                                        future_mortgage_index,future_unemployment_index,future_employment_index,&
                                                        future_housing_status_index,0)
                                                        
                                                end do
                                                
                                            end do
                                            
                                        end do
                                                                            
                                        value_function_owner_owner_move=flow_utility_vector(future_mortgage_index)+&
                                            future_utility_vector(future_mortgage_index)
                                                                                  
                                        if (value_function_owner_owner_move>largest_value) then
                                    
                                            largest_value=value_function_owner_owner_move
                                                                              
                                            optimal_owner_owner_move_indeces(1)=future_mortgage_index
                                            optimal_owner_owner_move_indeces(2)=future_years_of_amortization_index
                                            optimal_owner_owner_move_indeces(3)=future_housing_status_index
                                            
                                            if (global_search_index==0) then
                                            
                                                optimal_financial_1=future_mortgage_index
                                                
                                            end if
                            
                                            optimal_consumption_owner_owner_move=consumption_choice
                                            
                                            if (consumption_choice<=0) then
                            
                                                write(*,*) "owner owner move eror"
                                                
                                            end if
                                                                                        
                                            optimal_after_tax_wealth_net_of_expenses_owner_owner_move=&
                                                after_tax_wealth_net_of_expenses
                                                
                                            optimal_gross_wage_income_owner_owner_move=gross_wage_income
                                            optimal_cutoff_taxable_income_owner_owner_move=cutoff_taxable_income
                                            optimal_wage_income_tax_paid_owner_owner_move=wage_income_tax_paid
                                            optimal_space_lived_in_owner_owner_move=space_lived_in_index_feasible
                                            optimal_mortgage_deductions_owner_owner_move=mortgage_deductions_tax_rebates
                                            optimal_household_can_consume_owner_owner_move=1
                                            optimal_labor_supply_owner_owner_move=labor_supply_1
                                            optimal_frac_spent_on_addiction_owner_owner_move=frac_spent_on_addiction
                                            optimal_total_consumption_owner_owner_move=total_consumption_choice
                                            optimal_addiction_status_owner_owner_move=future_addiction_index
                                                                                                                                              
                                        end if
                                                                                    
                                    end if
                                    
                                end if
                                                                                                
                            end if
                            
                        end do
                               
                    end do
                    
                    end do
                    
                end if
                                            
            end do
            
        end do
            
        value_function_owner_owner_move=largest_value
                                                                
    end subroutine
    
    subroutine owner_renter_problem(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
            
        integer, intent(in) :: time_period,financial_index
        integer :: tenure_1,tenure_2,proceed_2,future_housing_status_index_to_use,voucher_index_1,&
            is_working_1,is_homeless_1,x_1,addiction_index,global_search_index,optimal_financial_1,can_consume_drugs,&
            loop_over_addiction_1,check_1,allow_to_choose_addiction,first_voucher_index,second_voucher_index,has_opportunity_1,&
            allow_to_choose_homelessness
        real(8) :: labor_supply_1,labor_supply_2 
                
        allow_to_choose_homelessness=1
        
        if (age_index>max_age_to_choose_homelessness) then
        
            allow_to_choose_homelessness=0
            
        end if
                        
        allow_to_choose_addiction=1
            
        if (age_index>max_age_to_choose_addiction) then
        
            allow_to_choose_addiction=0
                         
        end if
        
        addiction_index=0
        
        if (unemployment_index>threshold_addiction_index) then
        
            addiction_index=1
            
        end if
                
        tenure_1=1
        tenure_2=0
        proceed_2=1
        
        labor_supply_2=1
                
        is_working_1=1
        
        if ((in_retirement==1) .OR. &
            ((unemployment_index>1) .AND. (unemployment_index<threshold_addiction_index+1)) .OR. &
            (unemployment_index>threshold_addiction_index+1)) then
        
            is_working_1=0
            
        end if
        
        largest_value=large_negative_num
                        
        optimal_owner_renter_indeces(1)=negative_financial_grid_size
        optimal_financial_1=negative_financial_grid_size
        optimal_owner_renter_indeces(2)=1
        optimal_owner_renter_indeces(3)=0
                                    
        optimal_consumption_owner_renter=0
        optimal_gross_wage_income_owner_renter=0
        optimal_cutoff_taxable_income_owner_renter=0
        optimal_wage_income_tax_paid_owner_renter=0
        optimal_after_tax_wealth_net_of_expenses_owner_renter=0
        optimal_after_tax_wealth_owner_renter=0
        optimal_space_lived_in_owner_renter=0
        optimal_mortgage_deductions_owner_renter=0
        optimal_household_can_consume_owner_renter=0
        optimal_labor_supply_owner_renter=((1-is_working_1)*0+is_working_1*1)
        labor_supply_1=optimal_labor_supply_owner_renter
        optimal_frac_spent_on_addiction_owner_renter=0
        optimal_total_consumption_owner_renter=0
        optimal_addiction_status_owner_renter=0
        
        if (fixed_labor_supply_at_benchmark==1) then
                    
            labor_supply_2=&
                policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,unemployment_index,&
                employment_index,housing_status_index,voucher_index)
                
            labor_supply_1=labor_supply_2
                
        end if
                        
        do future_addiction_index=addiction_index,&
            (1-allow_to_choose_addiction)*addiction_index+allow_to_choose_addiction*include_addiction
        
            loop_over_addiction_1=0
            
            if (addiction_index==1) then
            
                loop_over_addiction_1=1
                
            elseif ((future_addiction_index==1) .AND. &
                (include_probability_of_becoming_addicted==1)) then
            
                loop_over_addiction_1=1
        
            end if
                
            do future_housing_status_index=&
                allow_to_choose_homelessness*lowest_housing_grid_point,largest_house_size_hhld_can_rent
                
                if (track_renters_housing==0) then
                
                    if (future_housing_status_index<=second_lowest_housing_grid_point) then
            
                        future_housing_status_index_to_use=future_housing_status_index
                        
                    else
                        
                        future_housing_status_index_to_use=0
                        
                    end if
                    
                else
                
                    future_housing_status_index_to_use=future_housing_status_index
                
                end if
                
                is_homeless_1=1
                
                if (future_housing_status_index_to_use==lowest_housing_grid_point) then
                
                    is_homeless_1=2
            
                end if
                
                call compute_voucher_index_1(is_homeless_1,voucher_index_1)
                
                do global_search_index=0,coarse_grid
                            
                do future_financial_index=&
                    (1-global_search_index)*negative_financial_grid_size+&
                    global_search_index*max(optimal_financial_1-grid_gaps+1,negative_financial_grid_size),&
                    (1-global_search_index)*financial_grid_size+&
                    global_search_index*min(optimal_financial_1+grid_gaps-1,financial_grid_size),&
                    (1-global_search_index)*grid_gaps+global_search_index
                
                    if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0)) then
                                    
                        labor_supply_2=1
                                          
                    end if
                            
                    call calculate_after_tax_wealth&
                        (financial_index,future_financial_index,years_left_on_mortgage_index,0,&
                        housing_status_index,future_housing_status_index,tenure_2,tenure_1,tenure_2,&
                        tenure_2,tenure_2,time_period,labor_supply_2,cutoff_taxable_income,future_addiction_index)
                        ! owner_to_owner_move_1,owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1
                      
                    if (labor_supply_2>0.4) then
                    if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0) .AND. &
                        ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1))) then
                    
                        x_1=1
                
                        call secant(time_period,financial_index,financial_grid(future_financial_index),&
                            housing_size(future_housing_status_index),future_housing_status_index,&
                            x_1,after_tax_wealth_net_of_expenses,labor_supply_1,gross_wage_income,&
                            wage_income_tax_paid,food_stamps_recieved,housing_voucher_recieved,&
                            housing_voucher_recieved_2,mortgage_deductions_tax_rebates,proceed_2,&
                            future_addiction_index)
                                                                                    
                    end if
                    end if
                    
                    call calculate_future_voucher_index_and_opportunity&
                        (has_opportunity_1,first_voucher_index,second_voucher_index,&
                        time_period,1,0,voucher_index_1,gross_wage_income+investment_income)
                    
                    if (-financial_grid(financial_index)>(1-minimum_downpayment)) then
                                                    
                        pay_mortgage_insurance=1
                            
                    else
                                    
                        pay_mortgage_insurance=0
                                        
                    end if
                    
                    can_consume_drugs=1
                                                                                    
                    if ((consumption_choice>=(food_stamps_recieved/(1+consumption_tax))) .AND. &
                        (consumption_choice>0) .AND. (frac_spent_on_addiction>=0) .AND. &
                        (total_consumption_choice>=consumption_choice) .AND. (proceed_2==1) .AND. &
                        (can_consume_drugs==1)) then
                        
                        if (abs(consumption_choice-total_consumption_choice*(1-frac_spent_on_addiction))>10.d0**(-8)) then
            
                            write(*,*) "wrong_2"
                            write(*,*) "consumption_choice=", consumption_choice
                            write(*,*) "total_consumption_choice=", total_consumption_choice
                            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
                        
                        end if
                                                                            
                        future_leisure_vector(future_financial_index)=relative_share_of_leisure*&
                            ((max_labor_supply-labor_supply_1)**(1-Frisch_elasticity))/(1-Frisch_elasticity)
                                                
                        call calculate_flow_utility(0,future_housing_status_index,&
                            housing_size(future_housing_status_index),frac_spent_on_addiction,&
                            total_consumption_choice,consumption_choice,0,future_addiction_index,&
                            flow_utility_vector(future_financial_index),0)
                            
                        flow_utility_vector(future_financial_index)=&
                            flow_utility_vector(future_financial_index)+&
                            future_leisure_vector(future_financial_index)
                                                                                                                                                                 
                        future_utility_vector=0
                        future_bequest_vector=0
                        
                        if (include_bequest_motive==1) then
                               
                            if ((age_index==life_span) .OR. (have_probablistic_death==1)) then
                                                        
                                call calculate_bequest_utility(financial_grid(future_financial_index),&
                                    future_bequest_vector(future_financial_index),is_homeless_1,addiction_index)
                                                        
                                future_utility_vector(future_financial_index)=&
                                    future_utility_vector(future_financial_index)+&
                                    future_bequest_vector(future_financial_index)
                                                                                                                        
                            end if
                            
                        end if
                        
                        do future_addiction_index_2=&
                            (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*0,&
                            (1-loop_over_addiction_1)*future_addiction_index+loop_over_addiction_1*include_addiction
                        
                            check_1=0
                            
                            if (future_addiction_index_2==1) then
                            
                                check_1=1
                                
                            end if
                                            
                            do future_unemployment_index=include_addiction*&
                                ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                                (1-include_addiction)*(at_least_one_period_before_retirement*&
                                (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                                (1-include_addiction)*(at_least_one_period_before_retirement*&
                                (one_period_before_death*unemployment_grid_size+(1-one_period_before_death)*unemployment_index)+&
                                (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                            
                                do future_employment_index=&
                                    at_least_one_period_before_retirement*employment_index+&
                                    (1-at_least_one_period_before_retirement)*1,&
                                    at_least_one_period_before_retirement*employment_index+&
                                    (1-at_least_one_period_before_retirement)*employment_grid_size
                                    
                                    do future_voucher_index=first_voucher_index,second_voucher_index
                                                                                                                                                                                                   
                                        future_utility_vector(future_financial_index)=&
                                            future_utility_vector(future_financial_index)+&
                                            discount_factor*survival_probability(age_index,is_homeless_1,addiction_index)*&
                                            voucher_probabilities(voucher_index,future_voucher_index,&
                                            has_opportunity_1,voucher_index_1)*&
                                            employment_process(age_index,employment_index,future_employment_index)*&
                                            unemployment_process(age_index,unemployment_index,&
                                            future_unemployment_index,is_homeless_1,future_addiction_index_2,employment_index)*&
                                            addiction_probabilities_percieved(addiction_index,future_addiction_index_2,&
                                            future_addiction_index,is_homeless_1)*&
                                            value_function(1)%vector_transition_real&
                                            (min(time_period+solve_transition_dynamics,transition_length),&
                                            age_index+1,future_financial_index,future_unemployment_index,&
                                            future_employment_index,future_housing_status_index_to_use,future_voucher_index)
                                            
                                    end do
                                                                                                                                                                                                                                                                                                                  
                                end do
                                
                            end do
                            
                        end do
                                                             
                        value_function_owner_renter=&
                            flow_utility_vector(future_financial_index)+&
                            future_utility_vector(future_financial_index)
                                                                                                                   
                        if (value_function_owner_renter>largest_value) then
                                                                
                            went_in_1=1
                            largest_value=value_function_owner_renter
                                                                 
                            optimal_owner_renter_indeces(1)=future_financial_index
                            optimal_owner_renter_indeces(2)=1
                            optimal_owner_renter_indeces(3)=future_housing_status_index
                            
                            if (global_search_index==0) then
                            
                                optimal_financial_1=future_financial_index
                                
                            end if
            
                            optimal_consumption_owner_renter=consumption_choice
                            
                            if (consumption_choice<food_stamps_recieved/(1+consumption_tax)) then
                            
                                write(*,*) "not good 7777"
                                write(*,*) "consumption_choice=", consumption_choice
                            
                            end if
                            
                            if (consumption_choice<=0) then
                            
                                write(*,*) "owner renter eror"
                                
                            end if
                            
                            optimal_after_tax_wealth_net_of_expenses_owner_renter=after_tax_wealth_net_of_expenses
                                
                            optimal_gross_wage_income_owner_renter=gross_wage_income
                            optimal_cutoff_taxable_income_owner_renter=cutoff_taxable_income
                            optimal_wage_income_tax_paid_owner_renter=wage_income_tax_paid
                            optimal_space_lived_in_owner_renter=future_housing_status_index
                            optimal_mortgage_deductions_owner_renter=mortgage_deductions_tax_rebates
                            optimal_household_can_consume_owner_renter=1
                            optimal_labor_supply_owner_renter=labor_supply_1
                            optimal_frac_spent_on_addiction_owner_renter=frac_spent_on_addiction
                            optimal_total_consumption_owner_renter=total_consumption_choice 
                            optimal_addiction_status_owner_renter=future_addiction_index
                            
                        end if
                                                                        
                    end if
                    
                end do
                                                                     
                end do
            
            end do 
            
        end do
                
        value_function_owner_renter=largest_value
                            
    end subroutine
    
    subroutine calculate_flow_utility(internal_computation_1,future_housing_status_index_1,&
        space_lived_in_internal_1,frac_spent_on_addiction_1,total_consumption_choice_1,&
        consumption_choice_1,ownership_status_index_1,addicted_status_1,flow_utility_1,is_benchmark)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: internal_computation_1,future_housing_status_index_1,&
            ownership_status_index_1,addicted_status_1,is_benchmark
        
        real(8), intent(in) :: space_lived_in_internal_1,frac_spent_on_addiction_1,&
            total_consumption_choice_1,consumption_choice_1
            
        real(8) :: price_of_addictive_good_to_use
            
        real(8), intent(inout) :: flow_utility_1
        
        if (is_benchmark==1) then
        
            price_of_addictive_good_to_use=price_of_addictive_good_benchmark
            
        else
        
            price_of_addictive_good_to_use=price_of_addictive_good
        
        end if
        
        if (internal_computation_1==0) then
        
            if (use_cobb_douglas==1) then
        
                if (addicted_status_1==1) then
                
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((1-relative_share_of_addiction)*&
                        (housing_status_utility_function(future_housing_status_index_1,&
                        age_index,ownership_status_index_1,addicted_status_1)*&
                        (consumption_choice_1**((1-risk_aversion_consumption)*&
                        (1-relative_share_of_housing))))/(1-risk_aversion_consumption)+&
                        relative_share_of_addiction*((frac_spent_on_addiction_1*total_consumption_choice_1/&
                        price_of_addictive_good_to_use)**(1-risk_aversion_consumption))/(1-risk_aversion_consumption))
                
                else
                    
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((housing_status_utility_function(future_housing_status_index_1,&
                        age_index,ownership_status_index_1,addicted_status_1)*&
                        (consumption_choice_1**((1-risk_aversion_consumption)*&
                        (1-relative_share_of_housing))))/(1-risk_aversion_consumption))
                        
                end if
                
            elseif (use_cobb_douglas_2==1) then
            
                flow_utility_1=scaled_household_size(age_index)*&
                    ((housing_status_utility_function(future_housing_status_index_1,&
                    age_index,ownership_status_index_1,addicted_status_1)*&
                    consumption_choice_1**((1-risk_aversion_consumption)*relative_share_of_consumption_2)*&
                    (addiction_scalar_1+(frac_spent_on_addiction_1*total_consumption_choice_1)/price_of_addictive_good_to_use)**&
                    ((1-risk_aversion_consumption)*relative_share_of_addiction)))/(1-risk_aversion_consumption)
            
            elseif (include_probability_of_becoming_addicted==1) then
            
                if (unemployment_index>threshold_addiction_index) then
                        
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((housing_status_utility_function(future_housing_status_index_1,age_index,ownership_status_index_1,1)*&
                        consumption_choice_1**((1-risk_aversion_consumption)*relative_share_of_consumption_2)*&
                        ((addiction_scalar_2+(frac_spent_on_addiction_1*total_consumption_choice_1)/&
                        price_of_addictive_good_to_use))**&
                        ((1-risk_aversion_consumption)*relative_share_of_addiction_2)))/(1-risk_aversion_consumption)
                        
                else
                
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((housing_status_utility_function(future_housing_status_index_1,age_index,ownership_status_index_1,0)*&
                        consumption_choice_1**((1-risk_aversion_consumption)*relative_share_of_consumption_1)*&
                        ((addiction_scalar_1+(frac_spent_on_addiction_1*total_consumption_choice_1)/&
                        price_of_addictive_good_to_use))**&
                        ((1-risk_aversion_consumption)*relative_share_of_addiction_1)))/(1-risk_aversion_consumption)
                
                end if
                
            else
            
                if (addicted_status_1==1) then
                
                    flow_utility_1=(1-utility_improvement)*sqrt_household_size(age_index)*&
                        ((housing_status_utility_function(future_housing_status_index_1,&
                        age_index,ownership_status_index_1,addicted_status_1)+&
                        relative_share_of_consumption_2*(consumption_choice_1/&
                        sqrt_household_size(age_index))**(power_1)+relative_share_of_addiction*&
                        (((frac_spent_on_addiction_1*total_consumption_choice_1)/price_of_addictive_good_to_use)/&
                        sqrt_household_size(age_index))**(power_3))**(power_2))/(1-risk_aversion_consumption)
                
                else
                    
                    flow_utility_1=sqrt_household_size(age_index)*&
                        ((housing_status_utility_function(future_housing_status_index_1,&
                        age_index,ownership_status_index_1,addicted_status_1)+(1-relative_share_of_housing)*&
                        (consumption_choice_1/sqrt_household_size(age_index))**(power_1))**&
                        (power_2))/(1-risk_aversion_consumption)
                        
                end if
            
            end if
                    
        else
        
            if (use_cobb_douglas==1) then
            
                if (addicted_status_1==1) then
                
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((1-relative_share_of_addiction)*&
                        ((space_lived_in_internal_1*(1+ownership_status_index_1*advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing)*&
                        (consumption_choice_1)**((1-risk_aversion_consumption)*&
                        ((1-relative_share_of_housing))))/(1-risk_aversion_consumption)+&
                        relative_share_of_addiction*((frac_spent_on_addiction_1*total_consumption_choice_1)**&
                        (1-risk_aversion_consumption))/(1-risk_aversion_consumption))
                    
                else
                
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((space_lived_in_internal_1*(1+ownership_status_index_1*advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing)*&
                        (total_consumption_choice_1)**((1-risk_aversion_consumption)*&
                        (1-relative_share_of_housing)))/(1-risk_aversion_consumption)
                        
                end if   
                
            elseif (use_cobb_douglas_2==1) then
                        
                flow_utility_1=scaled_household_size(age_index)*&
                    ((space_lived_in_internal_1*(1+ownership_status_index_1*advantage_to_owning))**&
                    ((1-risk_aversion_consumption)*relative_share_of_housing)*&
                    consumption_choice_1**((1-risk_aversion_consumption)*relative_share_of_consumption_2)*&
                    (addiction_scalar_1+(frac_spent_on_addiction_1*total_consumption_choice_1)/price_of_addictive_good_to_use)**&
                    ((1-risk_aversion_consumption)*relative_share_of_addiction))/(1-risk_aversion_consumption)
                    
            elseif (include_probability_of_becoming_addicted==1) then
            
                if (unemployment_index>threshold_addiction_index) then
                
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((space_lived_in_internal_1*(1+ownership_status_index_1*advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing_2)*&
                        consumption_choice_1**((1-risk_aversion_consumption)*relative_share_of_consumption_2)*&
                        ((addiction_scalar_2+(frac_spent_on_addiction_1*total_consumption_choice_1)/&
                        price_of_addictive_good_to_use))**&
                        ((1-risk_aversion_consumption)*relative_share_of_addiction_2))/(1-risk_aversion_consumption)
                
                else
                
                    flow_utility_1=scaled_household_size(age_index)*&
                        ((space_lived_in_internal_1*(1+ownership_status_index_1*advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing_1)*&
                        consumption_choice_1**((1-risk_aversion_consumption)*relative_share_of_consumption_1)*&
                        ((addiction_scalar_1+(frac_spent_on_addiction_1*total_consumption_choice_1)/&
                        price_of_addictive_good_to_use))**&
                        ((1-risk_aversion_consumption)*relative_share_of_addiction_1))/(1-risk_aversion_consumption)
                
                end if
                    
            else
            
                if (addicted_status_1==1) then
                
                    flow_utility_1=(1-utility_improvement)*sqrt_household_size(age_index)*&
                        ((relative_share_of_housing_2*((space_lived_in_internal_1*&
                        (1+ownership_status_index_1*advantage_to_owning))/&
                        sqrt_household_size(age_index))**(power_1)+&
                        relative_share_of_consumption_2*(consumption_choice_1/&
                        sqrt_household_size(age_index))**(power_1)+relative_share_of_addiction*&
                        (((frac_spent_on_addiction_1*total_consumption_choice_1)/price_of_addictive_good_to_use)/&
                        sqrt_household_size(age_index))**(power_3))**(power_2))/(1-risk_aversion_consumption)
                                        
                else
            
                    flow_utility_1=sqrt_household_size(age_index)*&
                        ((relative_share_of_housing*((space_lived_in_internal_1*&
                        (1+ownership_status_index_1*advantage_to_owning))/sqrt_household_size(age_index))**(power_1)+&
                        (1-relative_share_of_housing)*(total_consumption_choice_1/sqrt_household_size(age_index))**&
                        (power_1))**(power_2))/(1-risk_aversion_consumption)
                        
                end if
                    
            end if
            
        end if   
        
        if (frac_spent_on_addiction_1>0) then
        
            flow_utility_1=flow_utility_1+value_of_life
            
        else
        
            flow_utility_1=flow_utility_1+value_of_life
        
        end if
        
    end subroutine
    
    subroutine calculate_bequest_utility(wealth_1,bequest_1,is_homeless_1,is_addicted_1)
    
        use Global_Vars
        
        implicit none
        
        real(8), intent(in) :: wealth_1
        real(8), intent(inout) :: bequest_1
        integer, intent(in) :: is_homeless_1,is_addicted_1
                        
        if (minimum_inheritance>0) then
                
            bequest_1=(1-survival_probability(age_index,is_homeless_1,is_addicted_1))*&
                discount_factor_on_child*((minimum_inheritance+wealth_1)**(1-risk_aversion_consumption))/&
                (1-risk_aversion_consumption)
                
        else
        
            if (wealth_1>0) then
            
                bequest_1=((1-survival_probability(age_index,is_homeless_1,is_addicted_1))*&
                    discount_factor_on_child*(wealth_1)**(1-risk_aversion_consumption))/(1-risk_aversion_consumption)
            
            else
        
                bequest_1=large_negative_num
                
            end if
            
        end if  
        
    end subroutine
    
    subroutine calculate_marginal_non_housing_utility(consumption_1,housing_1,addiction_choice_2,addiction_1,MU_1)
    
        use Global_Vars
        
        implicit none
    
        real(8), intent(in) :: consumption_1,housing_1,addiction_1
        real(8), intent(out) :: MU_1
        real(8) :: first_part,second_part
        integer, intent(in) :: addiction_choice_2
        
        if (use_cobb_douglas==1) then
                    
            first_part=(1-relative_share_of_addiction)*scaled_household_size(age_index)*&
                (((housing_1)**(relative_share_of_housing))*((consumption_1)**(1-relative_share_of_housing)))**&
                (-risk_aversion_consumption)
                
            second_part=(1-relative_share_of_housing)*(consumption_1)**(-relative_share_of_housing)*&
                ((housing_1)**(relative_share_of_housing))
                
        elseif (use_cobb_douglas_2==1) then
        
            first_part=scaled_household_size(age_index)*&
                ((housing_1**relative_share_of_housing)*&
                (consumption_1**relative_share_of_consumption_2)*&
                (addiction_scalar_1+(addiction_1/price_of_addictive_good))**relative_share_of_addiction)**&
                (-risk_aversion_consumption)
                
            second_part=relative_share_of_consumption_2*(consumption_1)**(relative_share_of_consumption_2-1)*&
                ((housing_1**relative_share_of_housing)*&
                (addiction_scalar_1+(addiction_1/price_of_addictive_good))**relative_share_of_addiction)   
                
        elseif (include_probability_of_becoming_addicted==1) then
        
            if (unemployment_index>threshold_addiction_index) then
        
                first_part=scaled_household_size(age_index)*&
                    ((housing_1**relative_share_of_housing_2)*&
                    (consumption_1**relative_share_of_consumption_2)*&
                    ((addiction_scalar_2+(addiction_1/price_of_addictive_good))**relative_share_of_addiction_2))**&
                    (-risk_aversion_consumption)
                    
                second_part=relative_share_of_consumption_2*(consumption_1)**(relative_share_of_consumption_2-1)*&
                    (housing_1**relative_share_of_housing_2)*&
                    ((addiction_scalar_2+(addiction_1/price_of_addictive_good))**relative_share_of_addiction_2)
                    
            else
            
                first_part=scaled_household_size(age_index)*&
                    ((housing_1**relative_share_of_housing_1)*&
                    (consumption_1**relative_share_of_consumption_1)*&
                    ((addiction_scalar_1+(addiction_1/price_of_addictive_good))**relative_share_of_addiction_1))**&
                    (-risk_aversion_consumption)
                    
                second_part=relative_share_of_consumption_1*(consumption_1)**(relative_share_of_consumption_1-1)*&
                    (housing_1**relative_share_of_housing_1)*&
                    ((addiction_scalar_1+(addiction_1/price_of_addictive_good))**relative_share_of_addiction_1)
            
            end if
                                                            
        else
        
            if (addiction_choice_2>0) then
            
                first_part=(1-utility_improvement)*&
                    ((relative_share_of_housing_2*(housing_1/sqrt_household_size(age_index))**(power_1)+&
                    relative_share_of_consumption_2*(consumption_1/sqrt_household_size(age_index))**(power_1)+&
                    relative_share_of_addiction*((addiction_1/price_of_addictive_good)/sqrt_household_size(age_index))**&
                    (power_3))**(power_2-1))
                    
                second_part=relative_share_of_consumption_2*(consumption_1/sqrt_household_size(age_index))**(power_1-1)
                    
            else
            
                first_part=(relative_share_of_housing*(housing_1/sqrt_household_size(age_index))**(power_1)+&
                    (1-relative_share_of_housing)*(consumption_1/sqrt_household_size(age_index))**(power_1))**&
                    (power_2-1)
                    
                second_part=(1-relative_share_of_housing)*(consumption_1/sqrt_household_size(age_index))**(power_1)
                        
            end if 
                                    
        end if
        
        MU_1=first_part*second_part
        
    end subroutine
    
    subroutine which_is_better(time_period,financial_index)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period,financial_index
        integer :: is_owner_better
        
        is_owner_better=0
        
        if (value_function_owner>value_function_renter) then
        
            is_owner_better=1
            
        end if
                                                                                                
        value_function(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*value_function_owner+(1-is_owner_better)*value_function_renter
                                                
        optimal_after_tax_wealth_net_of_expenses=&
            is_owner_better*optimal_after_tax_wealth_net_of_expenses_owner+&
            (1-is_owner_better)*optimal_after_tax_wealth_net_of_expenses_renter
                        
        policy_function_financial_index(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_owner_indeces(1)+(1-is_owner_better)*optimal_renter_indeces(1)
            
        policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_owner_indeces(2)+(1-is_owner_better)*optimal_renter_indeces(2)
                                        
        policy_function_housing_status_index(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_owner_indeces(3)+(1-is_owner_better)*optimal_renter_indeces(3)
                                
        policy_function_consumption(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_consumption_owner+(1-is_owner_better)*optimal_consumption_renter
                    
        policy_function_space_lived_in_index(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_space_lived_in_owner+(1-is_owner_better)*optimal_space_lived_in_renter
                    
        policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*housing_size(optimal_space_lived_in_owner)+&
            (1-is_owner_better)*housing_size(optimal_space_lived_in_renter)
                                    
        policy_function_wage_income_tax_paid(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_wage_income_tax_paid_owner+&
            (1-is_owner_better)*optimal_wage_income_tax_paid_renter
            
        policy_function_mortgage_interest_deductions(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_mortgage_deductions_owner+&
            (1-is_owner_better)*optimal_mortgage_deductions_renter
            
        if ((adjust_labor_supply==0) .AND. (is_counterfactual==1)) then
        
        else
                                     
            policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,&
                unemployment_index,employment_index,housing_status_index,voucher_index)=&
                is_owner_better*optimal_labor_supply_owner+&
                (1-is_owner_better)*optimal_labor_supply_renter
                
        end if

        policy_function_cutoff_taxable_income(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_cutoff_taxable_income_owner+&
            (1-is_owner_better)*optimal_cutoff_taxable_income_renter
            
        policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            (is_owner_better*optimal_frac_spent_on_addiction_owner+&
            (1-is_owner_better)*optimal_frac_spent_on_addiction_renter)
                    
        policy_function_total_consumption(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            is_owner_better*optimal_total_consumption_owner+&
            (1-is_owner_better)*optimal_total_consumption_renter
            
        if (unemployment_index<=threshold_addiction_index) then
        
            if (policy_function_total_consumption(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,&
                unemployment_index,employment_index,housing_status_index,voucher_index)>&
                policy_function_consumption(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,&
                unemployment_index,employment_index,housing_status_index,voucher_index)) then
                            
                policy_function_addiction(years_left_on_mortgage_index)%&
                    vector_transition_integer(time_period,age_index,financial_index,&
                    unemployment_index,employment_index,housing_status_index,voucher_index)=&
                    is_owner_better*optimal_addiction_status_owner+&
                    (1-is_owner_better)*optimal_addiction_status_renter
                    
                if ((unemployment_index>threshold_addiction_index) .AND. &
                    (policy_function_addiction(years_left_on_mortgage_index)%&
                    vector_transition_integer(time_period,age_index,financial_index,&
                    unemployment_index,employment_index,housing_status_index,voucher_index)==0)) then
                    
                    write(*,*) "error"
                    
                end if
                
            else
            
                policy_function_addiction(years_left_on_mortgage_index)%&
                    vector_transition_integer(time_period,age_index,financial_index,&
                    unemployment_index,employment_index,housing_status_index,voucher_index)=0
            
            end if
                
        else
        
            policy_function_addiction(years_left_on_mortgage_index)%&
                vector_transition_integer(time_period,age_index,financial_index,&
                unemployment_index,employment_index,housing_status_index,voucher_index)=1
        
        end if
                                                                                                         
    end subroutine
    
    subroutine secant(time_period,financial_index_1,future_financial_amount_1,space_lived_in_1,&
        future_housing_status_index_1,years_left_on_mortgage_1,after_tax_wealth_net_of_expenses_2,&
        labor_supply_1,gross_wage_income_2,wage_income_tax_paid_2,food_stamps_2,housing_voucher_2,&
        housing_voucher_4,mortgage_deductions_tax_rebates_2,proceed_2,addiction_index_1)
    
        use Global_Vars
    
        implicit none
        
        real(8) :: MU_1,MU_2,x_0,x_1,x_2
        real(8) :: stopping_rule_secant=10.d0**(-8)
        real(8) :: distance_secant
        real(8), intent(inout) :: labor_supply_1,after_tax_wealth_net_of_expenses_2,gross_wage_income_2,&
            wage_income_tax_paid_2,food_stamps_2,housing_voucher_2,mortgage_deductions_tax_rebates_2,housing_voucher_4
        real(8), intent(in) :: future_financial_amount_1,space_lived_in_1
        integer, intent(in) :: financial_index_1,future_housing_status_index_1,addiction_index_1
        integer, intent(inout) :: proceed_2,years_left_on_mortgage_1
        integer, intent(in) :: time_period
        integer :: loop_1,can_consume_1,max_loop_count
        real(8) :: after_tax_wealth_net_of_expenses_1,gross_wage_income_1,wage_income_tax_paid_1,&
            food_stamps_1,housing_voucher_1,housing_voucher_3,mortgage_deductions_tax_rebates_1,taxable_income_1
            
        max_loop_count=1000
                     
        proceed_2=1
        distance_secant=1
        
        x_0=0
        x_2=1
        x_1=(x_0+x_2)/2
                    
        loop_1=1
            
        do while ((distance_secant>stopping_rule_secant) .AND. (loop_1<max_loop_count))
        
            after_tax_wealth_net_of_expenses_1=after_tax_wealth_net_of_expenses_2
            gross_wage_income_1=gross_wage_income_2
            wage_income_tax_paid_1=wage_income_tax_paid_2
            food_stamps_1=food_stamps_2
            housing_voucher_1=housing_voucher_2
            housing_voucher_3=housing_voucher_4
            mortgage_deductions_tax_rebates_1=mortgage_deductions_tax_rebates_2
            
            labor_supply_1=x_1
                        
            call objective(time_period,MU_1,MU_2,x_1,after_tax_wealth_net_of_expenses_1,&
                financial_index_1,future_financial_amount_1,space_lived_in_1,&
                future_housing_status_index_1,can_consume_1,gross_wage_income_1,&
                wage_income_tax_paid_1,food_stamps_1,housing_voucher_1,housing_voucher_3,&
                mortgage_deductions_tax_rebates_1,years_left_on_mortgage_1,addiction_index_1,taxable_income_1)
                
            if (abs(consumption_choice-total_consumption_choice*(1-frac_spent_on_addiction))>10.d0**(-8)) then
        
                write(*,*) "wrong_secant"
                write(*,*) "consumption_choice=", consumption_choice
                write(*,*) "total_consumption_choice=", total_consumption_choice
                write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
            
            end if
                
            if (can_consume_1==1) then
            
                proceed_2=1
                
                ! need more work, make the lower bound higher (update up)
                if (MU_1<MU_2) then
                
                    x_0=x_1
                    x_1=(x_1+x_2)/2
                    
                ! need less lesiure, make the upper bound lower (update down)
                else
                
                    x_2=x_1
                    x_1=(x_1+x_0)/2
                
                end if
                                
                distance_secant=abs(x_0-x_2)
                
!                if (x_1<10.d0**(-8)) then
!                
!                    x_1=0
!                    call objective(time_period,MU_1,MU_2,x_1,after_tax_wealth_net_of_expenses_1,&
!                        financial_index_1,future_financial_amount_1,space_lived_in_1,&
!                        future_housing_status_index_1,can_consume_1,gross_wage_income_1,&
!                        wage_income_tax_paid_1,food_stamps_1,housing_voucher_1,housing_voucher_3,&
!                        mortgage_deductions_tax_rebates_1,years_left_on_mortgage_1,addiction_index_1,taxable_income_1)
!                    
!                end if
                                    
            ! Not enough to consume, must raise lower bound on work
            else
            
                x_0=x_1
                x_1=(x_1+x_2)/2
                
                proceed_2=0
                
                distance_secant=abs(MU_1-MU_2)
                
            end if
                        
            loop_1=loop_1+1
                                            
        end do
        
        if ((labor_supply_1>1) .OR. (labor_supply_1<0)) then
        
            write(*,*) "labor_supply_1=", labor_supply_1
        
        end if
        
        if ((can_consume_1==1) .AND. (abs(MU_1-MU_1)>stopping_rule_secant) .AND. (x_1>0) .AND. (x_1<1)) then
        
            write(*,*) "labor"
            write(*,*) "distance_secant=", distance_secant
            write(*,*) "loop_1=", loop_1
            write(*,*) "MU_1=", MU_1
            write(*,*) "MU_2=", MU_2
            write(*,*) "x_1=", x_1
            write(*,*) "x_0=", x_0 
            write(*,*) "x_2=", x_2
            write(*,*) "addiction_index_1=", addiction_index_1
            write(*,*) "consumption_choice=", consumption_choice
            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
            write(*,*) "taxable_income_1=", taxable_income_1
            
        end if
        
        call objective(time_period,MU_1,MU_2,labor_supply_1,after_tax_wealth_net_of_expenses_2,&
            financial_index_1,future_financial_amount_1,space_lived_in_1,future_housing_status_index_1,&
            can_consume_1,gross_wage_income_2,wage_income_tax_paid_2,food_stamps_2,housing_voucher_2,&
            housing_voucher_4,mortgage_deductions_tax_rebates_2,years_left_on_mortgage_1,addiction_index_1,taxable_income_1)
                                         
    end subroutine

    subroutine objective(time_period,MU_1,MU_2,labor_supply_1,after_tax_wealth_net_of_expenses_1,financial_index_1,&
        future_financial_amount_1,space_lived_in_1,future_housing_status_index_1,can_consume_1,gross_wage_income_1,&
        wage_income_tax_paid_1,food_stamps_1,housing_voucher_1,housing_voucher_2,mortgage_deductions_tax_rebates_1,&
        years_left_on_mortgage_1,addiction_index_1,taxable_income_1)
        
        use Global_Vars

        real(8), intent(out) :: MU_1,MU_2
        real(8), intent(inout) :: labor_supply_1,gross_wage_income_1,wage_income_tax_paid_1,food_stamps_1,&
            housing_voucher_1,after_tax_wealth_net_of_expenses_1,mortgage_deductions_tax_rebates_1,&
            housing_voucher_2
        integer, intent(inout) :: can_consume_1,years_left_on_mortgage_1
        real(8), intent(in) :: future_financial_amount_1,space_lived_in_1
        integer, intent(in) :: financial_index_1,future_housing_status_index_1,addiction_index_1
        real(8) :: consumption_1,income_2
        real(8), intent(out) :: taxable_income_1
        integer, intent(in) :: time_period
        integer :: mortgage_index_2,deduct_MID,is_current_owner,choose_to_rent,low_quality_market
        real(8) :: deductions_claimed_1,max_gross_wage_income_1,&
            tax_liability_with_mortgage_deductions_1,tax_liability_without_mortgage_deductions_1,assets_1,&
            avg_net_wealth_to_use_1,avg_income_to_use_1,homeowner_spending,bequest_1
            
        if (inheritance_function_of_productivity==1) then
                        
            bequest_1=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
         
        else
        
            call calculate_bequest_amount(age_index,bequest_1,employment_index)
            
        end if
            
        if ((future_housing_status_index_1>second_lowest_housing_grid_point) .OR. &
           (have_two_rental_markets==0)) then
        
            low_quality_market=0
        
        else
        
            low_quality_market=1
        
        end if
        
        if (years_left_on_mortgage_index>1) then
                                    
            is_current_owner=1
            homeowner_spending=&
                housing_price(time_period)*housing_size(housing_status_index)*&
                (property_tax(time_period)+housing_depreciation_rate-&
                mortgage_interest_rate(time_period)*min(financial_grid(financial_index_1),0.d0))
                           
        else
        
            is_current_owner=0
            homeowner_spending=0
            
        end if
        
        if (years_left_on_mortgage_1==2) then
            
            choose_to_rent=0
            
        else
        
            choose_to_rent=1
            
        end if
                            
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
            
        avg_net_wealth_to_use_1=is_counterfactual*average_net_wealth_calibrated+&
            (1-is_counterfactual)*model_average_net_wealth(time_period)
          
        can_consume_1=1
          
        max_gross_wage_income_1=employment_grid(age_index,employment_index)*labour_deterministic_efficiency(age_index)
        
        after_tax_wealth_net_of_expenses_1=after_tax_wealth_net_of_expenses_1-&
            (gross_wage_income_1-wage_income_tax_paid_1+food_stamps_1+housing_voucher_1+housing_voucher_2)

        gross_wage_income_1=labor_supply_1*max_gross_wage_income_1
        
        food_stamps_1=0
        assets_1=2*threshold_for_food_stamps_as_perc_of_average_net_wealth*avg_net_wealth_to_use_1

        ! Checking if the household has assets

        ! This one is a homeowner
        if ((years_left_on_mortgage_index>1) .AND. (years_left_on_mortgage_1==1)) then

            assets_1=housing_price(time_period)*housing_size(housing_status_index)*&
                ((1-cost_of_selling-property_tax(time_period)-housing_depreciation_rate)+&
                min(financial_grid(financial_index_1),0.d0)*(1+mortgage_interest_rate(time_period)))+&
                max(financial_grid(financial_index_1),0.d0)
    
        ! This one is a renter
        elseif ((years_left_on_mortgage_index==1) .AND. (years_left_on_mortgage_1==1)) then
        
            assets_1=financial_grid(financial_index_1)

        end if
        
        ! If they have no assets, they get can qualift for food stamps
        if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*avg_net_wealth_to_use_1) then
                                
            food_stamps_1=max((max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                (gross_wage_income_1+risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0))),0.d0)
                                        
        end if
        
        housing_voucher_1=0
        
        if (provide_vouchers==1) then
        
            if ((years_left_on_mortgage_1>=1) .AND. &
                ((space_lived_in_1-housing_size(lowest_housing_grid_point))>10.d0**(-2))) then
                
                call calculate_housing_voucher(housing_voucher_1,gross_wage_income_1+food_stamps_1+&
                    risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)+bequest_1,&
                    rent(time_period,low_quality_market)*space_lived_in_1,homeowner_spending,&
                    is_current_owner,choose_to_rent,time_period)
                                    
            end if
            
        end if
        
        housing_voucher_2=0
                
        if ((is_current_owner==0) .AND. (years_left_on_mortgage_1==1) .AND. (voucher_index==1) .AND. (include_vouchers==1)) then

            income_2=gross_wage_income_1+risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)
        
            if (income_2<threshold_income_vouchers*&
                ((1-is_counterfactual)*median_income(time_period)+is_counterfactual*median_income_calibrated)) then
            
                call calculate_housing_voucher_2(housing_voucher_2,future_addiction_index,income_2,&
                    rent(time_period,low_quality_market)*space_lived_in_1,time_period)

            end if
        
        end if
                                
        mortgage_index_2=min(financial_index_1,negative_financial_grid_size)
                     
        deduct_MID=0
        deductions_claimed_1=0
        tax_liability_with_mortgage_deductions_1=0
        tax_liability_without_mortgage_deductions_1=0
        mortgage_deductions_tax_rebates_1=0
                                    
        if ((years_left_on_mortgage_index>1) .AND. ((mortgage_deductibility>0) .OR. (property_tax_deductibility>0))) then
                            
            deductions_claimed_1=&
                (mortgage_deductibility*min(-min(financial_grid(mortgage_index_2),0.d0)*&
                housing_price(time_period)*housing_size(housing_status_index),&
                max_MID_debt*(is_counterfactual*average_labor_income_calibrated+&
                (1-is_counterfactual)*model_average_labour_income(time_period)))*mortgage_interest_rate(time_period)+&
                (property_tax_deductibility*property_tax(time_period)+include_housing_depreciation_in_housing_costs*&
                housing_depreciation_rate)*housing_price(time_period)*housing_size(housing_status_index))
                
            deductions_claimed_1=max(deductions_claimed_1,0.d0)
                
            if (deductions_claimed_1>standard_deduction) then
                
                deduct_MID=1
                                                                                    
                tax_liability_with_mortgage_deductions_1=&
                    max(max(gross_wage_income_1-personal_exemption-deductions_claimed_1,0.d0)-&
                    (labor_income_tax_rate+increase_in_labour_income_tax)*&
                    max(gross_wage_income_1-personal_exemption-deductions_claimed_1,0.d0)**&
                    curvature_of_labor_income_taxes,0.d0)
                                
                tax_liability_without_mortgage_deductions_1=&
                    max(max(gross_wage_income_1-personal_exemption-standard_deduction,0.d0)-&
                    (labor_income_tax_rate+increase_in_labour_income_tax)*&
                    max(gross_wage_income_1-personal_exemption-standard_deduction,0.d0)**&
                    curvature_of_labor_income_taxes,0.d0)
                    
                mortgage_deductions_tax_rebates_1=max(tax_liability_without_mortgage_deductions_1-&
                    tax_liability_with_mortgage_deductions_1,0.d0)
            
            end if
                     
        end if

        taxable_income_1=max(gross_wage_income_1-personal_exemption-&
            deduct_MID*deductions_claimed_1-(1-deduct_MID)*standard_deduction,0.d0)
                    
        wage_income_tax_paid_1=&
            max(max(taxable_income_1,0.d0)-(labor_income_tax_rate+increase_in_labour_income_tax)*&
            max(taxable_income_1,0.d0)**curvature_of_labor_income_taxes,0.d0)
            
        after_tax_wealth_net_of_expenses_1=after_tax_wealth_net_of_expenses_1+&
            (gross_wage_income_1-wage_income_tax_paid_1+food_stamps_1+housing_voucher_1+housing_voucher_2)
            
        consumption_1=(after_tax_wealth_net_of_expenses_1-future_financial_amount_1)/(1+consumption_tax)
        
        consumption_choice=consumption_1
        total_consumption_choice=consumption_1
        
        frac_spent_on_addiction=0
        
        call calculate_addiction_spending(consumption_1,food_stamps_1,addiction_index_1,space_lived_in_1)
        
        if (abs(consumption_choice-total_consumption_choice*(1-frac_spent_on_addiction))>10.d0**(-8)) then
        
            write(*,*) "wrong_objective"
            write(*,*) "consumption_choice=", consumption_choice
            write(*,*) "total_consumption_choice=", total_consumption_choice
            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
        
        end if
                
        if ((consumption_choice>=(food_stamps_1/(1+consumption_tax))) .AND. &
           (consumption_choice>0)) then 
                  
            MU_1=relative_share_of_leisure*(max_labor_supply-labor_supply_1)**(-Frisch_elasticity)
                
            if (use_cobb_douglas==1) then
        
                if (frac_spent_on_addiction>0) then
                
                    MU_2=(1-relative_share_of_addiction)*scaled_household_size(age_index)*&
                        ((consumption_choice**(1-relative_share_of_housing)*&
                        (space_lived_in_1)**(relative_share_of_housing))**&
                        (-risk_aversion_consumption))*(((1-relative_share_of_housing)*&
                        (consumption_choice)**(-relative_share_of_housing))*((space_lived_in_1)**&
                        (relative_share_of_housing)))
                
                    if (housing_voucher_2==0) then
                    
                        if (taxable_income_1>0) then
                                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*&
                                (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                                (curvature_of_labor_income_taxes-1))/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                            
                    else
                    
                        if (taxable_income_1>0) then
                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*&
                                (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                                (curvature_of_labor_income_taxes-1)-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                    
                    end if
                
                else
                    
                    MU_2=scaled_household_size(age_index)*&
                        ((consumption_choice**(1-relative_share_of_housing)*&
                        (space_lived_in_1)**(relative_share_of_housing))**(-risk_aversion_consumption))*&
                        ((1-relative_share_of_housing)*(consumption_choice)**(-relative_share_of_housing)*&
                        (space_lived_in_1)**(relative_share_of_housing))
                
                    if (housing_voucher_2==0) then
                    
                        if (taxable_income_1>0) then
                                        
                            MU_2=MU_2*(curvature_of_labor_income_taxes*&
                                (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                                (curvature_of_labor_income_taxes-1))/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                            
                    else
                    
                        if (taxable_income_1>0) then
                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*&
                                (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                                (curvature_of_labor_income_taxes-1)-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                    
                    end if
                        
                end if
                
            elseif (use_cobb_douglas_2==1) then 
            
                MU_2=scaled_household_size(age_index)*&
                    (((consumption_choice**relative_share_of_consumption_2)*&
                    (space_lived_in_1**relative_share_of_housing)*&
                    (addiction_scalar_1+(frac_spent_on_addiction*total_consumption_choice)/&
                    price_of_addictive_good)**relative_share_of_addiction)**(-risk_aversion_consumption))*&
                    (relative_share_of_consumption_2*consumption_choice**(relative_share_of_consumption_2-1))*&
                    ((space_lived_in_1**relative_share_of_housing)*&
                    (addiction_scalar_1+((frac_spent_on_addiction*total_consumption_choice)/&
                    price_of_addictive_good))**relative_share_of_addiction)
            
                if (housing_voucher_2==0) then
                
                    if (taxable_income_1>0) then
                                
                        MU_2=MU_2*(curvature_of_labor_income_taxes*&
                            (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                            (curvature_of_labor_income_taxes-1))/(1+consumption_tax)
                            
                    else
                    
                        MU_2=MU_2*(max_gross_wage_income_1)/(1+consumption_tax)
                    
                    end if
                        
                else
                
                    if (taxable_income_1>0) then
                
                        MU_2=MU_2*(curvature_of_labor_income_taxes*&
                            (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                            (curvature_of_labor_income_taxes-1)-&
                            rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                            
                    else
                    
                        MU_2=MU_2*(max_gross_wage_income_1-&
                            rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                    
                    end if
                
                end if
                
            elseif (include_probability_of_becoming_addicted==1) then
            
                if (unemployment_index>threshold_addiction_index) then
            
                    MU_2=scaled_household_size(age_index)*&
                        (((consumption_choice**relative_share_of_consumption_2)*&
                        (space_lived_in_1**relative_share_of_housing_2)*&
                        ((addiction_scalar_2+(frac_spent_on_addiction*total_consumption_choice)/&
                        price_of_addictive_good))**relative_share_of_addiction_2)**(-risk_aversion_consumption))*&
                        (relative_share_of_consumption_2*consumption_choice**(relative_share_of_consumption_2-1))*&
                        ((space_lived_in_1**relative_share_of_housing_2)*&
                        ((addiction_scalar_2+(frac_spent_on_addiction*total_consumption_choice)/&
                        price_of_addictive_good))**relative_share_of_addiction_2)
                        
                else
                
                    MU_2=scaled_household_size(age_index)*&
                        (((consumption_choice**relative_share_of_consumption_1)*&
                        (space_lived_in_1**relative_share_of_housing_1)*&
                        ((addiction_scalar_1+(frac_spent_on_addiction*total_consumption_choice)/&
                        price_of_addictive_good))**relative_share_of_addiction_1)**(-risk_aversion_consumption))*&
                        (relative_share_of_consumption_1*consumption_choice**(relative_share_of_consumption_1-1))*&
                        ((space_lived_in_1**relative_share_of_housing_1)*&
                        ((addiction_scalar_1+(frac_spent_on_addiction*total_consumption_choice)/&
                        price_of_addictive_good))**relative_share_of_addiction_1)
                
                end if
            
                if (housing_voucher_2==0) then
                
                    if (taxable_income_1>0) then
                                
                        MU_2=MU_2*(curvature_of_labor_income_taxes*&
                            (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                            (curvature_of_labor_income_taxes-1))/(1+consumption_tax)
                            
                    else
                    
                        MU_2=MU_2*(max_gross_wage_income_1)/(1+consumption_tax)
                    
                    end if
                        
                else
                
                    if (taxable_income_1>0) then
                
                        MU_2=MU_2*(curvature_of_labor_income_taxes*&
                            (labor_income_tax_rate+increase_in_labour_income_tax)*max_gross_wage_income_1*(taxable_income_1)**&
                            (curvature_of_labor_income_taxes-1)-&
                            rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                            
                    else
                    
                        MU_2=MU_2*(max_gross_wage_income_1-&
                            rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                    
                    end if
                
                end if
                
            else
            
                if (frac_spent_on_addiction>0) then
                
                    MU_2=(1-utility_improvement)*&
                        ((relative_share_of_housing_2*(space_lived_in_1/sqrt_household_size(age_index))**(power_1)+&
                        relative_share_of_consumption_2*(consumption_choice/sqrt_household_size(age_index))**(power_1)+&
                        relative_share_of_addiction*(((frac_spent_on_addiction*total_consumption_choice)/&
                        price_of_addictive_good)/sqrt_household_size(age_index))**&
                        (power_3))**(power_2-1))*(relative_share_of_consumption_2*&
                        (consumption_choice/sqrt_household_size(age_index))**(power_1-1))
                
                    if (housing_voucher_2==0) then
                    
                        if (taxable_income_1>0) then
                                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*(labor_income_tax_rate+increase_in_labour_income_tax)*&
                                max_gross_wage_income_1*(taxable_income_1)**(curvature_of_labor_income_taxes-1))/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                            
                    else
                    
                        if (taxable_income_1>0) then
                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*(labor_income_tax_rate+increase_in_labour_income_tax)*&
                                max_gross_wage_income_1*(taxable_income_1)**(curvature_of_labor_income_taxes-1)-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                    
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                    
                    end if
                                    
                else
                
                    MU_2=((relative_share_of_housing*(space_lived_in_1/sqrt_household_size(age_index))**(power_1)+&
                        (1-relative_share_of_housing)*(consumption_choice/sqrt_household_size(age_index))**&
                        (power_1))**(power_2-1))*((1-relative_share_of_housing)*&
                        (consumption_choice/sqrt_household_size(age_index))**(power_1-1))
                
                    if (housing_voucher_2==0) then
                    
                        if (taxable_income_1>0) then
                                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*(labor_income_tax_rate+increase_in_labour_income_tax)*&
                                max_gross_wage_income_1*(taxable_income_1)**(curvature_of_labor_income_taxes-1))/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                            
                    else
                    
                        if (taxable_income_1>0) then
                    
                            MU_2=MU_2*(curvature_of_labor_income_taxes*(labor_income_tax_rate+increase_in_labour_income_tax)*&
                                max_gross_wage_income_1*(taxable_income_1)**(curvature_of_labor_income_taxes-1)-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                                
                        else
                        
                            MU_2=MU_2*(max_gross_wage_income_1-&
                                rent_to_income_ratio_vouchers*max_gross_wage_income_1)/(1+consumption_tax)
                        
                        end if
                    
                    end if
                        
                end if
            
            end if
                                    
        else
                
            can_consume_1=0                

        end if
        
    end subroutine
    
    subroutine calculate_after_tax_wealth(financial_index_1,future_financial_index_1,years_left_on_mortgage_1,&
        pay_mortgage_insurance_1,housing_status_index_1,future_housing_status_index_1,&
        owner_to_owner_move_1,owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1,&
        time_period,labor_supply_1,cutoff_taxable_income_1,addiction_index_1)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index_1,future_financial_index_1,years_left_on_mortgage_1,&
            housing_status_index_1,future_housing_status_index_1,pay_mortgage_insurance_1,owner_to_owner_move_1,&
            owner_to_renter_1,renter_to_owner_1,owner_to_owner_stay_1,renter_to_renter_1,time_period,&
            mortgage_index_2,deduct_MID,is_current_owner,choose_to_rent,low_quality_market,addiction_index_1
                    
        real(8) :: tax_liability_with_mortgage_deductions_1,tax_liability_without_mortgage_deductions_1,&
            cost_of_mortgage,cost_of_housing,deductions_claimed_1,lump_sum_transfer_given,&
            prepayment_penalty_1,origination_cost_1,fixed_cost_to_moving_1,labor_supply_1,&
            cutoff_taxable_income_1,bequest_1,avg_income_to_use_1,avg_income_to_use_2,assets_1,avg_net_wealth_to_use_1,&
            homeowner_spending,taxable_income_1
            
        if ((future_housing_status_index_1>second_lowest_housing_grid_point) .OR. &
           (have_two_rental_markets==0)) then
        
            low_quality_market=0
        
        else
        
            low_quality_market=1
        
        end if
                    
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
            
        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
            
        avg_net_wealth_to_use_1=is_counterfactual*average_net_wealth_calibrated+&
            (1-is_counterfactual)*model_average_net_wealth(time_period)
                    
        if (years_left_on_mortgage_index>1) then
                                    
            is_current_owner=1
            homeowner_spending=&
                housing_price(time_period)*housing_size(housing_status_index_1)*&
                (property_tax(time_period)+housing_depreciation_rate-&
                mortgage_interest_rate(time_period)*min(financial_grid(financial_index_1),0.d0))                
                           
        else
        
            is_current_owner=0
            homeowner_spending=0
            
        end if
        
        if ((renter_to_renter_1==1) .OR. (owner_to_renter_1==1)) then
            
            choose_to_rent=1
            
        else
        
            choose_to_rent=0
            
        end if
        
        if (inheritance_function_of_productivity==1) then
                        
            bequest_1=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
            
        else
        
            call calculate_bequest_amount(age_index,bequest_1,employment_index)
            
        end if
                                    
        call calculate_income(unemployment_index,employment_index,gross_wage_income,&
            avg_income_to_use_1,avg_income_to_use_2,labor_supply_1,in_retirement)
                                                             
        total_household_working_wealth=max(financial_grid(financial_index_1),0.d0)
                                                           
        investment_income=total_household_working_wealth*risk_free_rate(time_period)
                                                                                                                          
        investment_income_tax_paid=investment_income_tax*max(investment_income,0.d0)
                                                
        mortgage_index_2=min(financial_index_1,negative_financial_grid_size)
                     
        deduct_MID=0
        deductions_claimed_1=0
        tax_liability_with_mortgage_deductions_1=0
        tax_liability_without_mortgage_deductions_1=0
        mortgage_deductions_tax_rebates=0
                                    
        if ((years_left_on_mortgage_1>1) .AND. ((mortgage_deductibility>0) .OR. (property_tax_deductibility>0))) then
                            
            deductions_claimed_1=&
                (mortgage_deductibility*min((-min(financial_grid(mortgage_index_2),0.d0))*&
                housing_price(time_period)*housing_size(housing_status_index_1),&
                max_MID_debt*avg_income_to_use_1)*(pay_mortgage_insurance_1*&
                mortgage_insurance_premium+mortgage_interest_rate(time_period))+&
                (property_tax_deductibility*property_tax(time_period)+include_housing_depreciation_in_housing_costs*&
                housing_depreciation_rate)*housing_price(time_period)*housing_size(housing_status_index_1))
                
            deductions_claimed_1=max(deductions_claimed_1,0.d0)
                
            if (deductions_claimed_1>standard_deduction) then
                
                deduct_MID=1
                                                                                    
                tax_liability_with_mortgage_deductions_1=&
                    max(max(gross_wage_income-personal_exemption-deductions_claimed_1,0.d0)-&
                    (labor_income_tax_rate+increase_in_labour_income_tax)*&
                    max(gross_wage_income-personal_exemption-deductions_claimed_1,0.d0)**&
                    curvature_of_labor_income_taxes,0.d0)
                                
                tax_liability_without_mortgage_deductions_1=&
                    max(max(gross_wage_income-personal_exemption-standard_deduction,0.d0)-&
                    (labor_income_tax_rate+increase_in_labour_income_tax)*&
                    max(gross_wage_income-personal_exemption-standard_deduction,0.d0)**&
                    curvature_of_labor_income_taxes,0.d0)
                    
                mortgage_deductions_tax_rebates=max(tax_liability_without_mortgage_deductions_1-&
                    tax_liability_with_mortgage_deductions_1,0.d0)
            
            end if
                     
        end if

        cutoff_taxable_income_1=personal_exemption+deduct_MID*deductions_claimed_1+(1-deduct_MID)*standard_deduction
                    
        taxable_income_1=max(gross_wage_income-personal_exemption-deduct_MID*deductions_claimed_1-&
            (1-deduct_MID)*standard_deduction,0.d0)
                
        wage_income_tax_paid=max(max(taxable_income_1,0.d0)-&
            (labor_income_tax_rate+increase_in_labour_income_tax)*&
            max(taxable_income_1,0.d0)**curvature_of_labor_income_taxes,0.d0)
                     
        food_stamps_recieved=0
        housing_voucher_recieved=0
        housing_voucher_recieved_2=0
        
        fixed_cost_to_moving_1=0
        lump_sum_transfer_given=0
        property_taxes_paid=0
        housing_depreciation_expenditures=0
        cost_of_mortgage=0  
        origination_cost_1=0
        prepayment_penalty_1=0
        cost_of_housing=0
        rent_spending=0
                              
        if (renter_to_renter_1==1) then
                                
            if (future_housing_status_index_1==lowest_housing_grid_point) then
            
                rent_spending=0
                
            else
                    
                rent_spending=rent(time_period,low_quality_market)*housing_size(future_housing_status_index_1)
                
            end if
                                       
            if (((future_housing_status_index_1 .NE. housing_status_index_1) .OR. &
                (years_left_on_mortgage_index .NE. 1)) .AND. (age_index>1)) then
                        
                fixed_cost_to_moving_1=fixed_cost_to_moving
                            
            end if
                                                           
            if (financial_grid(financial_index_1)<threshold_for_food_stamps_as_perc_of_average_net_wealth*&
                avg_net_wealth_to_use_1) then
                            
                food_stamps_recieved=max(max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                    (gross_wage_income+risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)),0.d0)
                    
            end if
            
            if (provide_vouchers==1) then
            
                if (future_housing_status_index_1>lowest_housing_grid_point) then
            
                    call calculate_housing_voucher(housing_voucher_recieved,gross_wage_income+food_stamps_recieved+&
                        risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)+bequest_1,rent_spending,&
                        homeowner_spending,is_current_owner,choose_to_rent,time_period)
                        
                end if
                                
            end if

            if ((include_vouchers==1) .AND. (voucher_index==1) .AND. &
                (gross_wage_income+investment_income<threshold_income_vouchers*&
                ((1-is_counterfactual)*median_income(time_period)+is_counterfactual*median_income_calibrated))) then

                call calculate_housing_voucher_2(housing_voucher_recieved_2,future_addiction_index,&
                    gross_wage_income+investment_income,rent_spending,time_period)

            end if
            
        elseif (renter_to_owner_1==1) then
                
            if (financial_grid(future_financial_index_1)<0) then
        
                origination_cost_1=mortgage_origination_cost*avg_income_to_use_1
                    
            end if
                                           
            cost_of_housing=(1+cost_of_buying)*housing_price(time_period)*housing_size(future_housing_status_index_1)
                    
            if (provide_vouchers==1) then
            
                call calculate_housing_voucher(housing_voucher_recieved,gross_wage_income+food_stamps_recieved+&
                    risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)+bequest_1,&
                    rent_spending,homeowner_spending,is_current_owner,choose_to_rent,time_period)
                                
            end if
                                                                                                         
        elseif (owner_to_owner_stay_1==1) then
                                        
            if (financial_grid(financial_index_1)<0) then
            
                if (financial_grid(future_financial_index_1)<&
                    (financial_grid(financial_index_1)*(1-prepayment_penalty_starts_from))) then
                    
                    origination_cost_1=mortgage_origination_cost*avg_income_to_use_1
                    
                    prepayment_penalty_1=penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                        (-min(financial_grid(financial_index_1),0.d0))*&
                        housing_price(time_period)*housing_size(housing_status_index_1)*&
                        (1-prepayment_penalty_starts_from)
                                                
                else
                
                    prepayment_penalty_1=penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                        max(min(financial_grid(future_financial_index_1),0.d0)-&
                        min(financial_grid(financial_index_1),0.d0)*(1-prepayment_penalty_starts_from),0.d0)*&
                        housing_price(time_period)*housing_size(housing_status_index_1)
                        
                end if
                
            else
            
                if (financial_grid(future_financial_index_1)<0) then
            
                    origination_cost_1=mortgage_origination_cost*avg_income_to_use_1
                        
                end if
                
            end if
                                            
            cost_of_housing=housing_price(time_period)*housing_size(housing_status_index_1)
                                                           
            property_taxes_paid=property_tax(time_period-solve_transition_dynamics)*&
                housing_price(time_period-solve_transition_dynamics)*housing_size(housing_status_index_1)
                                                                                              
            housing_depreciation_expenditures=&
                housing_depreciation_rate*housing_price(time_period-solve_transition_dynamics)*housing_size(housing_status_index_1)
                                   
            cost_of_mortgage=-min(financial_grid(financial_index_1),0.d0)*&
                housing_price(time_period)*housing_size(housing_status_index_1)*&
                (1+mortgage_interest_rate(time_period)+pay_mortgage_insurance_1*mortgage_insurance_premium)
                
            if (provide_vouchers==1) then
            
                call calculate_housing_voucher(housing_voucher_recieved,gross_wage_income+food_stamps_recieved+&
                    risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)+bequest_1,rent_spending,&
                    homeowner_spending,is_current_owner,choose_to_rent,time_period)
                                
            end if
                                              
        elseif (owner_to_owner_move_1==1) then
                                    
            if (financial_grid(future_financial_index_1)<0) then
                        
                origination_cost_1=mortgage_origination_cost*avg_income_to_use_1
                   
            end if
                
            prepayment_penalty_1=penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                (-min(financial_grid(financial_index_1),0.d0))*&
                housing_price(time_period)*housing_size(housing_status_index_1)*(1-prepayment_penalty_starts_from)
                                                              
            property_taxes_paid=property_tax(time_period-solve_transition_dynamics)*&
                housing_price(time_period-solve_transition_dynamics)*housing_size(housing_status_index_1)
                   
            cost_of_housing=(1+cost_of_buying)*housing_price(time_period)*housing_size(future_housing_status_index_1)+&
                cost_of_selling*housing_price(time_period)*housing_size(housing_status_index_1)
                                                                               
            housing_depreciation_expenditures=&
                housing_depreciation_rate*housing_price(time_period-solve_transition_dynamics)*housing_size(housing_status_index_1)
                                            
            cost_of_mortgage=-min(financial_grid(financial_index_1),0.d0)*&
                housing_price(time_period)*housing_size(housing_status_index_1)*&
                (1+mortgage_interest_rate(time_period)+pay_mortgage_insurance_1*mortgage_insurance_premium)
                
            if (provide_vouchers==1) then
            
                call calculate_housing_voucher(housing_voucher_recieved,gross_wage_income+food_stamps_recieved+&
                    risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)+bequest_1,rent_spending,&
                    homeowner_spending,is_current_owner,choose_to_rent,time_period)
                                
            end if
                                                    
        elseif (owner_to_renter_1==1) then
                
            prepayment_penalty_1=penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                (-min(financial_grid(financial_index_1),0.d0))*housing_price(time_period)*housing_size(housing_status_index_1)*&
                (1-prepayment_penalty_starts_from)
                            
            if (future_housing_status_index_1==lowest_housing_grid_point) then
            
                rent_spending=0
            
            else
            
                rent_spending=rent(time_period,low_quality_market)*housing_size(future_housing_status_index_1)
            
            end if
                                                                                
            property_taxes_paid=property_tax(time_period-solve_transition_dynamics)*&
                housing_price(time_period-solve_transition_dynamics)*housing_size(housing_status_index_1)
                                             
            cost_of_housing=cost_of_selling*housing_price(time_period)*housing_size(housing_status_index_1)
                                    
            housing_depreciation_expenditures=&
                housing_depreciation_rate*housing_price(time_period-solve_transition_dynamics)*housing_size(housing_status_index_1)
                        
            cost_of_mortgage=-min(financial_grid(financial_index_1),0.d0)*&
                housing_price(time_period)*housing_size(housing_status_index_1)*&
                (1+mortgage_interest_rate(time_period)+pay_mortgage_insurance_1*mortgage_insurance_premium)
            
            assets_1=max(housing_price(time_period)*housing_size(housing_status_index_1)*&
                (1-cost_of_selling-property_tax(time_period)-housing_depreciation_rate+&
                min(financial_grid(financial_index_1),0.d0)*(1+mortgage_interest_rate(time_period)))+&
                max(financial_grid(financial_index_1),0.d0),0.d0)
    
            if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*avg_net_wealth_to_use_1) then
                                
                food_stamps_recieved=max((max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                    (gross_wage_income+risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0))),0.d0)
                                            
            end if
            
            if (provide_vouchers==1) then
            
                if (future_housing_status_index_1>lowest_housing_grid_point) then
            
                    call calculate_housing_voucher(housing_voucher_recieved,gross_wage_income+food_stamps_recieved+&
                        risk_free_rate(time_period)*max(financial_grid(financial_index_1),0.d0)+bequest_1,rent_spending,&
                        homeowner_spending,is_current_owner,choose_to_rent,time_period)
                        
                end if
                                        
            end if
                                                                                                
        end if
                                                                                                               
        after_tax_wealth_net_of_expenses=gross_wage_income-wage_income_tax_paid+&
            investment_income-investment_income_tax_paid+total_household_wealth-& 
            property_taxes_paid-housing_depreciation_expenditures-rent_spending-cost_of_mortgage-&
            cost_of_housing+lump_sum_transfer_given-origination_cost_1-prepayment_penalty_1-&
            fixed_cost_to_moving_1+bequest_1+food_stamps_recieved+housing_voucher_recieved+&
            housing_voucher_recieved_2
            
        consumption_choice=(after_tax_wealth_net_of_expenses-&
            max(financial_grid(future_financial_index_1),0.d0)-min(financial_grid(future_financial_index_1),0.d0)*&
            housing_price(time_period)*housing_size(future_housing_status_index_1))/(1+consumption_tax)

        total_consumption_choice=consumption_choice
                        
        frac_spent_on_addiction=0
                    
        call calculate_addiction_spending(consumption_choice,food_stamps_recieved,&
            addiction_index_1,housing_size(future_housing_status_index_1))
                                
    end subroutine
    
    subroutine calculate_addiction_spending(consumption_1,food_stamps_1,addiction_index_1,housing_size_1)
    
        use Global_Vars
        
        implicit none
        
        real(8), intent(in) :: consumption_1,food_stamps_1,housing_size_1
        real(8) :: total_consumption_choice_1,total_consumption_choice_2
        integer, intent(in) :: addiction_index_1
        
        if ((addiction_index_1==1) .AND. (consumption_choice>0) .AND. (relative_share_of_addiction>0)) then
                
            total_consumption_choice_1=consumption_1
            total_consumption_choice_2=total_consumption_choice_1
                    
            call optimize_frac_spent_on_addiciton&
                (total_consumption_choice_2,consumption_choice,frac_spent_on_addiction,&
                price_of_addictive_good,food_stamps_1,housing_size_1)
                          
            if (consumption_choice<food_stamps_1/(1+consumption_tax)) then
                
                consumption_choice=food_stamps_1/(1+consumption_tax)
                total_consumption_choice=total_consumption_choice_1
                frac_spent_on_addiction=min(max(1-consumption_choice/total_consumption_choice,0.d0),1.d0)
                
                if (total_consumption_choice<consumption_choice) then
                    
!                    write(*,*) "mistake"
                    
                    consumption_choice=0
                    total_consumption_choice=0
                    frac_spent_on_addiction=0
                                         
                end if
                
            else
        
                total_consumption_choice=total_consumption_choice_2
                
            end if
            
        else
        
            frac_spent_on_addiction=0
                
        end if
        
        if (abs(consumption_choice-total_consumption_choice*(1-frac_spent_on_addiction))>10.d0**(-8)) then
        
            write(*,*) "wrong"
            write(*,*) "consumption_choice=", consumption_choice
            write(*,*) "total_consumption_choice=", total_consumption_choice
            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction
        
        end if
        
    end subroutine
    
    subroutine optimize_frac_spent_on_addiciton(total_consumption_choice_1,consumption_choice_1,&
        frac_spent_on_addiction_1,price_of_addictive_good_1,food_stamps_1,housing_size_1)
    
        use Global_Vars
        
        real(8), intent(inout) :: consumption_choice_1,frac_spent_on_addiction_1,total_consumption_choice_1
        real(8) :: x_0,x_1,x_2,MU_1,MU_2,distance_1,stopping_rule_1=10.d0**(-5),total_consumption_choice_3,&
            food_stamps_value,consumption_1,addiction_1,test_1
        real(8), intent(in) :: price_of_addictive_good_1,food_stamps_1,housing_size_1
        integer :: loop_count_1,max_loop_count
                
        test_1=total_consumption_choice_1
        total_consumption_choice_3=total_consumption_choice_1

        food_stamps_value=food_stamps_1/(1+consumption_tax)
        
        MU_1=0
        MU_2=0
        
        x_0=0
        x_2=1
        x_1=(x_0+x_2)/2
        
        distance_1=1
        loop_count_1=1
        max_loop_count=1000
        
        if (include_probability_of_becoming_addicted==1) then
        
            if ((change_utility_for_addicts==0) .AND. (size_of_penalty==0)) then
        
                if ((relative_share_of_consumption_2 .NE. relative_share_of_consumption_1) .OR. &
                   (addiction_scalar_2 .NE. addiction_scalar_1) .OR. &
                   (relative_share_of_housing_1 .NE. relative_share_of_housing_2)) then
                
                    write(*,*) "strange"
                    write(*,*) "relative_share_of_consumption_2=", relative_share_of_consumption_2
                    write(*,*) "relative_share_of_consumption_1", relative_share_of_consumption_1
                    write(*,*) "addiction_scalar_2=", addiction_scalar_2
                    write(*,*) "addiction_scalar_1=", addiction_scalar_1
                    
                end if
                
            end if
        
            if (unemployment_index>threshold_addiction_index) then
            
                consumption_choice_1=(relative_share_of_consumption_2*&
                    (price_of_addictive_good_1*addiction_scalar_2+total_consumption_choice_3))/&
                    (relative_share_of_consumption_2+relative_share_of_addiction_2)
                    
            else
            
                consumption_choice_1=(relative_share_of_consumption_1*&
                    (price_of_addictive_good_1*addiction_scalar_1+total_consumption_choice_3))/&
                    (relative_share_of_consumption_1+relative_share_of_addiction_1)
                                
            end if
            
            consumption_choice_1=min(consumption_choice_1,total_consumption_choice_3)
            
            frac_spent_on_addiction_1=1-consumption_choice_1/total_consumption_choice_3
            total_consumption_choice_1=total_consumption_choice_3
        
        else
        
            do while ((distance_1>stopping_rule_1) .AND. (loop_count_1<max_loop_count))
                        
                if (loop_count_1<max_loop_count) then

                    consumption_1=x_1*total_consumption_choice_3
                    addiction_1=(1-x_1)*total_consumption_choice_3
                                    
                    if (use_cobb_douglas==1) then
                    
                        MU_1=(1-relative_share_of_addiction)*(1/price_of_addictive_good_1)*&
                            (((housing_size_1)**(relative_share_of_housing))*&
                            ((consumption_1)**(1-relative_share_of_housing)))**(-risk_aversion_consumption)*&
                            (1-relative_share_of_housing)*(consumption_1)**(-relative_share_of_housing)*&
                            ((housing_size_1)**(relative_share_of_housing))
                            
                        MU_2=relative_share_of_addiction*(addiction_1/price_of_addictive_good_1)**(-risk_aversion_consumption)
                                                
                    elseif (use_cobb_douglas_2==1) then
                    
                        MU_1=(1/price_of_addictive_good_1)*&
                            (relative_share_of_consumption_2*consumption_1**(relative_share_of_consumption_2-1))*&
                            ((addiction_scalar_1+(addiction_1/price_of_addictive_good_1))**relative_share_of_addiction)
                            
                        MU_2=(relative_share_of_addiction*(addiction_scalar_1+(addiction_1/price_of_addictive_good_1))**&
                            (relative_share_of_addiction-1))*(consumption_1**relative_share_of_consumption_2)
                            
                    elseif (include_probability_of_becoming_addicted==1) then
                    
                        if (unemployment_index>threshold_addiction_index) then
                    
                            MU_1=price_of_addictive_good_1*(relative_share_of_consumption_2*consumption_1**(-1))
                                
                            MU_2=(relative_share_of_addiction_2*(addiction_scalar_2+addiction_1/price_of_addictive_good_1)**(-1))
                                
                        else
                        
                            MU_1=price_of_addictive_good_1*(relative_share_of_consumption_1*consumption_1**(-1))
                                
                            MU_2=(relative_share_of_addiction_1*(addiction_scalar_1+addiction_1/price_of_addictive_good_1)**(-1))
                        
                        end if
                                
                    else
                    
                        MU_1=(1/price_of_addictive_good_1)*&
                            (power_1*relative_share_of_consumption_2*(consumption_1/sqrt_household_size(age_index))**(power_1-1))
                            
                        MU_2=(power_3*relative_share_of_addiction*((addiction_1/price_of_addictive_good_1)/&
                            sqrt_household_size(age_index))**(power_3-1))
                            
                    end if
                    
                    if (total_consumption_choice_3>=0) then
                
                        ! need more consumption, make the lower bound higher (update up)
                        if (MU_1>MU_2) then
                        
                            x_0=x_1
                            x_1=(x_1+x_2)/2
                            
                        ! need more addiction, make the upper bound lower (update down)
                        else
                        
                            x_2=x_1
                            x_1=(x_1+x_0)/2
                        
                        end if
                                            
                    end if
                        
                    distance_1=abs(x_0-x_2)
                    
                    loop_count_1=loop_count_1+1
                    
                end if
                        
            end do
            
            frac_spent_on_addiction_1=(1-x_1)
            consumption_choice_1=x_1*total_consumption_choice_3
            total_consumption_choice_1=total_consumption_choice_3
            
            if ((distance_1>stopping_rule_1) .OR. ((abs(MU_1-MU_2)>10.d0**(-1)) .AND. (abs(x_1-1)>0.0001)) .OR. &
                ((abs(MU_1-MU_2)>10.d0**(-1)) .AND. (abs(x_1-0)<0.0001))) then
        
    !            write(*,*) "addiction"
    !            write(*,*) "distance_1=", distance_1
    !            write(*,*) "x_1=", x_1
    !            write(*,*) "MU_1=", MU_1
    !            write(*,*) "MU_2=", MU_2
    !            write(*,*) "total_consumption_choice_1=", total_consumption_choice_1
    !            write(*,*) "consumption_1=", consumption_choice_1
    !            write(*,*) "food_stamps_value=", food_stamps_value
    !            write(*,*) "frac_spent_on_addiction_1=", frac_spent_on_addiction_1
    !            write(*,*) "loop_count_1=", loop_count_1
            
            end if
                
        end if
                                            
        if (abs(consumption_choice_1-total_consumption_choice_1*(1-frac_spent_on_addiction_1))>10.d0**(-8)) then
        
            write(*,*) "wrong_1"
            write(*,*) "consumption_choice=", consumption_choice_1
            write(*,*) "total_consumption_choice=", total_consumption_choice_1
            write(*,*) "frac_spent_on_addiction=", frac_spent_on_addiction_1
        
        end if
             
    end subroutine
        
    subroutine internal_computations&
        (value_function_1,labor_supply_1,gross_wage_income_1,&
        fin_index_1,ownership_status_index_1,space_lived_in_index_1,housing_status_index_1,&
        years_of_amortization_1,wage_income_tax_paid_2,mortgage_interest_deductions_2,&
        financial_index,time_period,after_tax_wealth_net_of_expenses_1,max_future_mortgage_index_2,&
        frac_spent_on_addiction_2,future_addiction_index_1)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,fin_index_1,ownership_status_index_1,can_purchase_new_house,years_of_amortization_1,&
            housing_status_index_1,space_lived_in_index_1,time_period,adjust_budget,can_consume_drugs,&
            become_renter,smallest_house,second_smallest_house,max_future_mortgage_index_2,owner_to_owner_stay_2,&
            owner_to_owner_move_2,renter_to_owner_2,check_GDS_2,proceed_2,track_housing_1,low_quality_market,&
            future_housing_status_index_to_use,is_homeless_1,x_1,is_current_owner_1,future_addiction_index_1,voucher_index_1,&
            current_addiction_index_1,loop_over_addiction_1,check_1,has_opportunity_1,first_voucher_index,second_voucher_index
            
        real(8) :: value_function_1,after_tax_wealth_net_of_expenses_1,spending_on_housing_1,&
            after_tax_wealth_net_of_expenses_1_copy,rent_spent_1,rent_spent_2,space_lived_in_optimal_1,&
            after_tax_wealth_net_of_expenses_1_optimal,max_mortgage_payments_as_fraction_of_income_1,&
            gross_wage_income_1,wage_income_tax_paid_2,wage_income_tax_paid_1,optimal_wage_income_tax_paid_1,&
            labor_supply_1,optimal_labor_supply_1,optimal_mortgage_interest_deductions_1,&
            mortgage_interest_deductions_2,mortgage_interest_deductions_1,investment_income_tax_paid_1_optimal,&
            investment_income_tax_paid_1,assets_1,optimal_gross_wage_income_1,labor_supply_2,wealth_1,&
            avg_income_to_use_1,avg_income_to_use_2,food_stamps_recieved_1,housing_voucher_recieved_1,avg_net_wealth_to_use_1,&
            frac_spent_on_addiction_2,homeowner_spending_1,renter_spending_1,consumption_choice_1,total_consumption_choice_1,&
            LTV_1,optimal_frac_spent_on_addiction,housing_voucher_recieved_3,income_to_use,bequest_1
            
        if (inheritance_function_of_productivity==1) then
                        
            bequest_1=employment_grid(age_index,employment_index)*inheritance_amount(age_index)
            
        else
            
            call calculate_bequest_amount(age_index,bequest_1,employment_index)
            
        end if

        current_addiction_index_1=0
        loop_over_addiction_1=0
            
        if (unemployment_index>threshold_addiction_index) then
        
            future_addiction_index_1=1        
            current_addiction_index_1=1 
            loop_over_addiction_1=1
            
        elseif ((future_addiction_index_1==1) .AND. &
            (include_probability_of_becoming_addicted==1)) then
            
            loop_over_addiction_1=1
        
        end if
        
        if ((housing_status_index_1>second_lowest_housing_grid_point) .OR. &
            (have_two_rental_markets==0)) then
            
            low_quality_market=0
            
        else
        
            low_quality_market=1
        
        end if         
                    
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                                            
        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
            
        avg_net_wealth_to_use_1=is_counterfactual*average_net_wealth_calibrated+&
            (1-is_counterfactual)*model_average_net_wealth(time_period)
                                            
        track_housing_1=1
            
        if (ownership_status_index_1==0) then
        
            if (track_renters_housing==0) then
                    
                track_housing_1=0
            
            end if
            
        end if
        
        if (track_housing_1==0) then
            
            if (housing_status_index_1<=second_lowest_housing_grid_point) then
    
                future_housing_status_index_to_use=housing_status_index_1
                
            else
                
                future_housing_status_index_to_use=0
                
            end if
            
        else
        
            future_housing_status_index_to_use=housing_status_index_1
        
        end if
        
        is_homeless_1=1
        
        if (future_housing_status_index_to_use==lowest_housing_grid_point) then
        
            is_homeless_1=2
            
        end if
        
        call compute_voucher_index_1(is_homeless_1,voucher_index_1)              
         
        proceed_2=1
        
        optimal_gross_wage_income_1=gross_wage_income_1
                                
        owner_to_owner_stay_2=0
            
        if ((ownership_status_index_1==1) .AND. (years_left_on_mortgage_index==2) .AND. &
            (housing_status_index_1==housing_status_index)) then
        
            owner_to_owner_stay_2=1
                    
        end if
        
        owner_to_owner_move_2=0
        
        if ((ownership_status_index_1==1) .AND. (years_left_on_mortgage_index==2) .AND. &
            (housing_status_index_1 .NE. housing_status_index)) then
        
            owner_to_owner_move_2=1
                    
        end if
        
        renter_to_owner_2=0
        
        if ((ownership_status_index_1==1) .AND. (years_left_on_mortgage_index==1)) then
        
            renter_to_owner_2=1
                    
        end if
        
        if (years_left_on_mortgage_index>1) then
        
            is_current_owner_1=1
            
        else
        
            is_current_owner_1=0
            
        end if
                    
        become_renter=0
        
        if (years_of_amortization_1<=1) then
        
            become_renter=1
            
        end if
        
        optimal_frac_spent_on_addiction=frac_spent_on_addiction_2
                    
        consumption_choice_1=&
            (after_tax_wealth_net_of_expenses_1-max(financial_grid(fin_index_1),0.d0)-&
            min(financial_grid(fin_index_1),0.d0)*housing_price(time_period)*housing_size(housing_status_index_1))/&
            (1+consumption_tax)
                                                           
        space_lived_in_optimal_1=housing_size(space_lived_in_index_1)
        
        after_tax_wealth_net_of_expenses_1_optimal=after_tax_wealth_net_of_expenses_1
                                                
        investment_income_tax_paid_1_optimal=&
            investment_income_tax*max(financial_grid(financial_index),0.d0)*risk_free_rate(time_period)
                   
        rent_spent_2=(1-ownership_status_index_1)*&
            rent(time_period,low_quality_market)*housing_size(housing_status_index_1)
        
        if (housing_status_index_1==lowest_housing_grid_point) then
            
            rent_spent_2=0
                
        end if
                                                            
        optimal_labor_supply_1=labor_supply_1
        labor_supply_2=labor_supply_1
                                                    
        optimal_wage_income_tax_paid_1=wage_income_tax_paid_2
                    
        optimal_mortgage_interest_deductions_1=mortgage_interest_deductions_2
        mortgage_interest_deductions_1=mortgage_interest_deductions_2
                                                                                                                   
        frac_mov_optimal_1(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=0
                        
        fin_index_frac_mov_to_optimal(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=fin_index_1
                    
        if (in_retirement==1) then
        
            if (age_index<=life_span) then
        
                if ((owner_to_owner_stay_2==1) .OR. (owner_to_owner_move_2==1) .OR. (renter_to_owner_2==1)) then
                
                    if (fin_index_1<negative_financial_grid_size) then
            
                        dis_prev_index_fin=financial_grid(fin_index_1)-&
                            financial_grid(max(fin_index_1-1,max_future_mortgage_index_2))
                            
                    else
                    
                        dis_prev_index_fin=financial_grid(fin_index_1)-&
                            financial_grid(max(fin_index_1-1,negative_financial_grid_size))
                    
                    end if
                        
                else
                
                    dis_prev_index_fin=financial_grid(fin_index_1)-&
                        financial_grid(max(fin_index_1-1,negative_financial_grid_size))
                
                end if
                
            else
            
                dis_prev_index_fin=financial_grid(fin_index_1)-financial_grid(max(fin_index_1-1,negative_financial_grid_size))
            
            end if
            
        else
        
            if (fin_index_1<negative_financial_grid_size) then
            
                dis_prev_index_fin=financial_grid(fin_index_1)-financial_grid(max(fin_index_1-1,max_future_mortgage_index_2))
            
            else
        
                dis_prev_index_fin=financial_grid(fin_index_1)-financial_grid(max(fin_index_1-1,&
                    can_get_mortgage*(ownership_status_index_1*1+(1-ownership_status_index_1)*negative_financial_grid_size)+&
                    (1-can_get_mortgage)*negative_financial_grid_size))
                    
            end if
        
        end if
        
        if ((owner_to_owner_stay_2==1) .OR. (owner_to_owner_move_2==1) .OR. (renter_to_owner_2==1)) then
        
            if (fin_index_1<negative_financial_grid_size) then
            
                dis_next_index_fin=financial_grid(min(fin_index_1+1,negative_financial_grid_size))-financial_grid(fin_index_1)
            
            else
                                                                         
                dis_next_index_fin=financial_grid(min(fin_index_1+1,financial_grid_size))-financial_grid(fin_index_1)
                
            end if
            
        else
        
            dis_next_index_fin=financial_grid(min(fin_index_1+1,financial_grid_size))-financial_grid(fin_index_1)
        
        end if
                                                        
        slope_of_financial_internal=(dis_prev_index_fin+dis_next_index_fin)/(fin_num_of_internal-1)
                                                    
        after_tax_wealth_net_of_expenses_1_copy=after_tax_wealth_net_of_expenses_1
                                                                
        internal_loop_1: do future_financial_index=1,fin_num_of_internal-2
                        
            if (in_retirement==1) then
    
                if (age_index<=life_span) then
            
                    if ((owner_to_owner_stay_2==1) .OR. (owner_to_owner_move_2==1) .OR. (renter_to_owner_2==1)) then
                    
                        if (fin_index_1<negative_financial_grid_size) then
                        
                            financial_internal=(financial_grid(max(fin_index_1-1,max_future_mortgage_index_2))+&
                                slope_of_financial_internal*future_financial_index)*&
                                housing_price(time_period)*housing_size(housing_status_index_1)
                                
                            LTV_1=financial_grid(max(fin_index_1-1,max_future_mortgage_index_2))+&
                                slope_of_financial_internal*future_financial_index
                        
                        else
                
                            financial_internal=financial_grid(max(fin_index_1-1,negative_financial_grid_size))+&
                                slope_of_financial_internal*future_financial_index
                                
                            LTV_1=financial_internal
                                
                        end if
                            
                    else
                    
                        financial_internal=financial_grid(max(fin_index_1-1,negative_financial_grid_size))+&
                            slope_of_financial_internal*future_financial_index
                            
                        LTV_1=financial_internal
                    
                    end if
                    
                else
                
                    financial_internal=financial_grid(max(fin_index_1-1,negative_financial_grid_size))+&
                        slope_of_financial_internal*future_financial_index
                        
                    LTV_1=financial_internal
                
                end if
            
            else
            
                if (fin_index_1<negative_financial_grid_size) then
                
                    financial_internal=(financial_grid(max(fin_index_1-1,&
                        can_get_mortgage*max_future_mortgage_index_2+(1-can_get_mortgage)*negative_financial_grid_size))+&
                        slope_of_financial_internal*future_financial_index)*&
                        housing_price(time_period)*housing_size(housing_status_index_1)
                        
                    LTV_1=(financial_grid(max(fin_index_1-1,&
                        can_get_mortgage*max_future_mortgage_index_2+(1-can_get_mortgage)*negative_financial_grid_size))+&
                        slope_of_financial_internal*future_financial_index)
                
                else
            
                    financial_internal=financial_grid(max(fin_index_1-1,negative_financial_grid_size))+&
                        slope_of_financial_internal*future_financial_index
                        
                    LTV_1=financial_internal
                                                
                end if
            
            end if        
                                    
            space_lived_in_internal=housing_size(space_lived_in_index_1)
                             
            adjust_budget=0
        
            rent_spent_1=rent_spent_2
            mortgage_interest_deductions_1=mortgage_interest_deductions_2
            wage_income_tax_paid_1=wage_income_tax_paid_2
            investment_income_tax_paid_1=&
                investment_income_tax*max(financial_grid(financial_index),0.d0)*risk_free_rate(time_period)
            optimal_gross_wage_income_1=gross_wage_income_1
            labor_supply_2=labor_supply_1
                     
            food_stamps_recieved_1=0
            
            assets_1=2*threshold_for_food_stamps_as_perc_of_average_net_wealth*avg_net_wealth_to_use_1
    
            ! This one is a homeowner turning to renting
            if ((years_left_on_mortgage_index>1) .AND. (ownership_status_index_1==0)) then

                assets_1=max(housing_price(time_period)*housing_size(housing_status_index)*&
                    (1-cost_of_selling-property_tax(time_period)-housing_depreciation_rate)+&
                    min(financial_grid(financial_index),0.d0)*(1+mortgage_interest_rate(time_period))*&
                    housing_price(time_period)*housing_size(housing_status_index)+&
                    max(financial_grid(financial_index),0.d0),0.d0)
        
            ! This one is a renter staying renting
            elseif ((years_left_on_mortgage_index==1) .AND. (ownership_status_index_1==0)) then
            
                assets_1=max(financial_grid(financial_index),0.d0)

            end if

            if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*avg_net_wealth_to_use_1) then
            
                food_stamps_recieved_1=max((max_food_cost*(1+consumption_tax)*avg_income_to_use_1-&
                    (optimal_gross_wage_income_1+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0))),0.d0)
                                                    
            end if
            
            housing_voucher_recieved_1=0

            if (provide_vouchers==1) then
            
                homeowner_spending_1=0
                renter_spending_1=0
                                
                ! owner to rent not homeless
                if ((ownership_status_index_1==0) .AND. (is_current_owner_1==1) .AND. &
                    (housing_status_index_1 .NE. lowest_housing_grid_point)) then
                
                    homeowner_spending_1=&
                        housing_price(time_period)*housing_size(housing_status_index)*&
                        (property_tax(time_period)+housing_depreciation_rate-&
                        mortgage_interest_rate(time_period)*min(financial_grid(financial_index),0.d0))
                                                
                    renter_spending_1=rent_spent_1
                             
                ! renter to renter not homeless
                elseif ((ownership_status_index_1==0) .AND. (is_current_owner_1==0) .AND. &
                    (housing_status_index_1 .NE. lowest_housing_grid_point)) then
                
                    homeowner_spending_1=0
                    renter_spending_1=rent_spent_1
                               
                ! owner to owner not homless
                elseif ((ownership_status_index_1==1) .AND. (is_current_owner_1==1) .AND. & 
                    (housing_status_index_1 .NE. lowest_housing_grid_point)) then
                
                    homeowner_spending_1=&
                        housing_price(time_period)*housing_size(housing_status_index)*&
                        (property_tax(time_period)+housing_depreciation_rate-&
                        mortgage_interest_rate(time_period)*min(financial_grid(financial_index),0.d0))
                        
                    renter_spending_1=0
                                                        
                end if
                
                if (housing_status_index_1>lowest_housing_grid_point) then
                
                    call calculate_housing_voucher(housing_voucher_recieved_1,&
                        optimal_gross_wage_income_1+food_stamps_recieved_1+&
                        risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)+bequest_1,&
                        renter_spending_1,homeowner_spending_1,is_current_owner_1,&
                        ownership_status_index_1,time_period)
                        
                end if
                                    
            end if

            housing_voucher_recieved_3=0

            income_to_use=optimal_gross_wage_income_1+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)

            if ((income_to_use<threshold_income_vouchers*((1-is_counterfactual)*median_income(time_period)+&
                is_counterfactual*median_income_calibrated)) .AND. (include_vouchers==1)) then

                if ((is_current_owner_1==0) .AND. (ownership_status_index_1==0) .AND. (voucher_index==1)) then

                    call calculate_housing_voucher_2&
                        (housing_voucher_recieved_3,future_addiction_index_1,&
                        income_to_use,rent_spent_1,time_period)
                    
                end if

            end if
            
            after_tax_wealth_net_of_expenses_1=after_tax_wealth_net_of_expenses_1_copy
                             
            after_tax_wealth_net_of_expenses_1=after_tax_wealth_net_of_expenses_1-&
                adjust_budget*(rent_spent_1-rent_spent_2)
                                               
            total_consumption_choice_1=(after_tax_wealth_net_of_expenses_1-financial_internal)/(1+consumption_tax)                
            consumption_choice_1=(1-frac_spent_on_addiction_2)*total_consumption_choice_1
                            
            if ((in_retirement==0) .AND. (fixed_labor_supply_at_benchmark==0) .AND.&
                ((unemployment_index==1) .OR. (unemployment_index==threshold_addiction_index+1))) then
                                            
                x_1=ownership_status_index_1+1
        
                call secant(time_period,financial_index,financial_internal,&
                    space_lived_in_internal,housing_status_index_1,x_1,after_tax_wealth_net_of_expenses_1,&
                    labor_supply_2,optimal_gross_wage_income_1,wage_income_tax_paid_1,&
                    food_stamps_recieved_1,housing_voucher_recieved_1,housing_voucher_recieved_3,&
                    mortgage_interest_deductions_1,proceed_2,future_addiction_index_1)
                    
                consumption_choice_1=consumption_choice
                total_consumption_choice_1=total_consumption_choice
                frac_spent_on_addiction_2=frac_spent_on_addiction

            end if
            
            income_to_use=optimal_gross_wage_income_1+risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)
            
            call calculate_future_voucher_index_and_opportunity&
                (has_opportunity_1,first_voucher_index,second_voucher_index,&
                time_period,is_current_owner_1,ownership_status_index_1,voucher_index_1,income_to_use)
                                                                                
            can_purchase_new_house=1
            
            if ((LTV_1<financial_grid(fin_index_1)) .AND. (ownership_status_index_1==1)) then
                        
                smallest_house=0
                second_smallest_house=0

                if (housing_price(time_period)*housing_size(housing_status_index_1)<=&
                    fraction_of_average_house_price_data*((1-is_counterfactual)*&
                    model_average_owner_occupied_unit_size(time_period)*housing_price(time_period)+is_counterfactual*&
                    average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then
                            
                    smallest_house=1
                    
                elseif (housing_price(time_period)*housing_size(housing_status_index_1)<=&
                    2*fraction_of_average_house_price_data*((1-is_counterfactual)*&
                    model_average_owner_occupied_unit_size(time_period)*housing_price(time_period)+is_counterfactual*&
                    average_owner_occupied_house_size_calibrated*calibrated_stationary_housing_price)) then 
                    
                    second_smallest_house=1
                    
                end if
            
                if (-LTV_1<(1-minimum_downpayment+smallest_house*min_down_of_smallest+second_smallest_house+&
                    min_down_of_second_smallest)) then
                    
                    if (-LTV_1>(1-minimum_downpayment)) then
                                                    
                        pay_mortgage_insurance=1
                        max_mortgage_payments_as_fraction_of_income_1=max_debt_to_income_ratio
                            
                    else
                                    
                        pay_mortgage_insurance=0
                        max_mortgage_payments_as_fraction_of_income_1=max_debt_to_income_ratio_below_80
                                        
                    end if
                    
                    check_GDS_2=1
                    
                    if (owner_to_owner_stay_2==1) then
                    
                        if (LTV_1>financial_grid(financial_index)*(1-fraction_to_repay)) then
                        
                            check_GDS_2=0
                            
                        end if                               
                    
                    end if
                    
                    if (check_GDS_2==1) then
                                
                        spending_on_housing_1=&
                            (-min(financial_internal,0.d0)*(pay_mortgage_insurance*mortgage_insurance_premium+&
                            mortgage_interest_rate(time_period)+average_fraction_of_mortgage_repaid))+&
                            housing_size(housing_status_index)*housing_price(time_period)*&
                            (fraction_of_property_taxes_in_GDS*property_tax(time_period)+&
                            include_housing_depreciation_in_housing_costs*housing_depreciation_rate)
                            
                    else
                    
                        spending_on_housing_1=0
                    
                    end if
                                                                                                
                    if ((spending_on_housing_1/(optimal_gross_wage_income_1+&
                        risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)))<=&
                        max_mortgage_payments_as_fraction_of_income_1) then
                        
                        can_purchase_new_house=1
                        
                    else
                    
                        can_purchase_new_house=0
                    
                    end if
                    
                else
                
                    can_purchase_new_house=0
                    
                end if
            
            end if
            
            can_consume_drugs=1
                        
            if (can_purchase_new_house==1) then
                                                                            
                if ((consumption_choice_1>=(food_stamps_recieved_1/(1+consumption_tax))) .AND. &
                    (consumption_choice_1>0) .AND. (frac_spent_on_addiction_2>=0) .AND. &
                    (total_consumption_choice_1>=consumption_choice_1) .AND. &
                    (can_consume_drugs==1) .AND. (proceed_2==1)) then
                                                                                
                    dis_internal_from_optimal_fin=LTV_1-financial_grid(fin_index_1)
                                                
                    if (dis_internal_from_optimal_fin<0) then
                    
                        if (in_retirement==1) then

                            if (age_index<=life_span) then
                        
                                if ((owner_to_owner_stay_2==1) .OR. (owner_to_owner_move_2==1) .OR. &
                                    (renter_to_owner_2==1)) then
                                                                
                                    fin_index_frac_mov_to=max(fin_index_1-1,max_future_mortgage_index_2)
                                                                                
                                else
                                
                                    fin_index_frac_mov_to=max(fin_index_1-1,negative_financial_grid_size)
                                
                                end if
                                
                            else
                            
                                fin_index_frac_mov_to=max(fin_index_1-1,negative_financial_grid_size)
                            
                            end if
                        
                        else
                        
                            fin_index_frac_mov_to=max(fin_index_1-1,can_get_mortgage*(ownership_status_index_1*1+&
                                (1-ownership_status_index_1)*negative_financial_grid_size)+&
                                (1-can_get_mortgage)*negative_financial_grid_size)
                        
                        end if
                                                                    
                        frac_mov_to_another_cell_1=abs(dis_internal_from_optimal_fin)/dis_prev_index_fin
                                                                                             
                    ! Considering a financial choice above the optimal one found
                    elseif (dis_internal_from_optimal_fin>0) then
                    
                        if ((owner_to_owner_stay_2==1) .OR. (owner_to_owner_move_2==1) .OR. (renter_to_owner_2==1)) then
                        
                            if (fin_index_1<negative_financial_grid_size) then
                            
                                fin_index_frac_mov_to=min(fin_index_1+1,negative_financial_grid_size)
                            
                            else
                    
                                fin_index_frac_mov_to=min(fin_index_1+1,financial_grid_size)
                                
                            end if
                            
                        else
                        
                            fin_index_frac_mov_to=min(fin_index_1+1,financial_grid_size)
                        
                        end if
                                                
                        frac_mov_to_another_cell_1=abs(dis_internal_from_optimal_fin)/dis_next_index_fin
                                                                                                                                                      
                    ! This means we are considering the same financial choice as the optimal choice found
                    else
                                                                        
                        frac_mov_to_another_cell_1=0
                                                            
                        fin_index_frac_mov_to=fin_index_1
                                                                                                            
                    end if
                    
                    financial_index_copy=fin_index_1
                                    
                    financial_index_copy_1=fin_index_frac_mov_to
                                                                    
                    future_leisure_internal=relative_share_of_leisure*&
                        ((max_labor_supply-labor_supply_2)**(1-Frisch_elasticity))/(1-Frisch_elasticity)
                                                   
                    call calculate_flow_utility(1,housing_status_index_1,&
                        space_lived_in_internal,frac_spent_on_addiction_2,total_consumption_choice_1,&
                        consumption_choice_1,ownership_status_index_1,future_addiction_index_1,&
                        flow_utility_internal,0)
                                                
                    flow_utility_internal=flow_utility_internal+future_leisure_internal
                                                                                                                    
                    future_utility_internal=0
                    future_bequest_internal=0
                    
                    if (include_bequest_motive==1) then
                                        
                        if ((age_index==life_span) .OR. (have_probablistic_death==1)) then
                            
                            if (ownership_status_index_1==1) then
                            
                                wealth_1=housing_price(time_period)*&
                                    housing_size(housing_status_index_1)*(1-remove_tax_and_depreciation*&
                                    (property_tax(time_period)+housing_depreciation_rate))+&
                                    financial_internal-mortgage_interest_rate(time_period)*&
                                    (-min(financial_internal,0.d0))
                                                  
                            else
                            
                                wealth_1=financial_internal
                                                            
                            end if
                            
                            call calculate_bequest_utility(wealth_1,future_bequest_internal,&
                                is_homeless_1,current_addiction_index_1)
                                                            
                            future_utility_internal=future_utility_internal+future_bequest_internal
                                                                                                                        
                        end if
                        
                    end if
                    
                    do future_addiction_index_2=&
                        (1-loop_over_addiction_1)*future_addiction_index_1+loop_over_addiction_1*0,&
                        (1-loop_over_addiction_1)*future_addiction_index_1+loop_over_addiction_1*include_addiction
                        
                        check_1=0
                            
                        if (future_addiction_index_2==1) then
                        
                            check_1=1
                            
                        end if
                                                                                        
                        do future_unemployment_index=include_addiction*&
                            ((1-check_1)*1+check_1*(threshold_addiction_index+1))+&
                            (1-include_addiction)*(at_least_one_period_before_retirement*&
                            (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                            (1-at_least_one_period_before_retirement)*1),include_addiction*&
                            ((1-check_1)*threshold_addiction_index+check_1*unemployment_grid_size)+&
                            (1-include_addiction)*(at_least_one_period_before_retirement*&
                            (one_period_before_death*unemployment_grid_size+(1-one_period_before_death)*unemployment_index)+&
                            (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                           
                            do future_employment_index=&
                                at_least_one_period_before_retirement*employment_index+&
                                (1-at_least_one_period_before_retirement)*1,&
                                at_least_one_period_before_retirement*employment_index+&
                                (1-at_least_one_period_before_retirement)*employment_grid_size

                                do future_voucher_index=first_voucher_index,second_voucher_index
                                                                                                                                                                                                                                           
                                    future_utility_internal=future_utility_internal+discount_factor*&
                                        survival_probability(age_index,is_homeless_1,current_addiction_index_1)*&
                                        voucher_probabilities(voucher_index,future_voucher_index,&
                                        has_opportunity_1,voucher_index_1)*&
                                        employment_process(age_index,employment_index,future_employment_index)*&
                                        unemployment_process(age_index,unemployment_index,&
                                        future_unemployment_index,is_homeless_1,future_addiction_index_2,employment_index)*&
                                        addiction_probabilities_percieved(current_addiction_index_1,future_addiction_index_2,&
                                        future_addiction_index_1,is_homeless_1)*&
                                        (frac_mov_to_another_cell_1*value_function(years_of_amortization_1)%&
                                        vector_transition_real(min(time_period+solve_transition_dynamics,transition_length),&
                                        age_index+1,financial_index_copy_1,future_unemployment_index,future_employment_index,&
                                        future_housing_status_index_to_use,future_voucher_index)+(1-frac_mov_to_another_cell_1)*&
                                        value_function(years_of_amortization_1)%vector_transition_real&
                                        (min(time_period+solve_transition_dynamics,transition_length),age_index+1,&
                                        financial_index_copy,future_unemployment_index,future_employment_index,&
                                        future_housing_status_index_to_use,future_voucher_index))
                                
                                end do
                                                                                                                                                                                                                                                        
                            end do
                            
                        end do
                        
                    end do
                                                                            
                    val_fun_internal=flow_utility_internal+future_utility_internal
                                                
                    if ((val_fun_internal>value_function_1) .AND. (frac_mov_to_another_cell_1>=0) .AND. &
                        (frac_mov_to_another_cell_1<=1)) then
            
                        value_function_1=val_fun_internal
                                                                                                    
                        frac_mov_optimal_1(years_left_on_mortgage_index)%&
                            vector_transition_real(time_period,age_index,financial_index,&
                            unemployment_index,employment_index,housing_status_index,voucher_index)=&
                            frac_mov_to_another_cell_1
                                                        
                        fin_index_frac_mov_to_optimal(years_left_on_mortgage_index)%&
                            vector_transition_integer(time_period,age_index,financial_index,&
                            unemployment_index,employment_index,housing_status_index,voucher_index)=&
                            fin_index_frac_mov_to
                    
                        policy_function_consumption(years_left_on_mortgage_index)%&
                            vector_transition_real(time_period,age_index,financial_index,&
                            unemployment_index,employment_index,housing_status_index,voucher_index)=&
                            consumption_choice_1
                            
                        if (consumption_choice_1<=0) then
                            
                            write(*,*) "internal eror"
                            
                        end if
                            
                        policy_function_total_consumption(years_left_on_mortgage_index)%&
                            vector_transition_real(time_period,age_index,financial_index,&
                            unemployment_index,employment_index,housing_status_index,voucher_index)=&
                            total_consumption_choice_1
                            
                        optimal_frac_spent_on_addiction=frac_spent_on_addiction_2
                                                            
                        optimal_labor_supply_1=labor_supply_2
                                                                                                     
                        space_lived_in_optimal_1=space_lived_in_internal
                                              
                        after_tax_wealth_net_of_expenses_1_optimal=&
                            after_tax_wealth_net_of_expenses_1
                                                                                    
                        optimal_wage_income_tax_paid_1=wage_income_tax_paid_1
                            
                        optimal_mortgage_interest_deductions_1=mortgage_interest_deductions_1
                                                                                                                                                        
                    end if
                                                
                end if
                                                                            
            end if
                                    
        end do internal_loop_1
            
        val_fun_internal=value_function_1
        
        policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            space_lived_in_optimal_1
                    
        optimal_after_tax_wealth_net_of_expenses=after_tax_wealth_net_of_expenses_1_optimal
                        
        policy_function_wage_income_tax_paid(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            optimal_wage_income_tax_paid_1
            
        policy_function_mortgage_interest_deductions(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=&
            optimal_mortgage_interest_deductions_1
            
        if ((adjust_labor_supply==0) .AND. (is_counterfactual==1)) then
        
        else
            
            policy_function_labor_supply(years_left_on_mortgage_index)%&
                vector_transition_real(time_period,age_index,financial_index,&
                unemployment_index,employment_index,housing_status_index,voucher_index)=&
                optimal_labor_supply_1
                
        end if
        
        policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)=optimal_frac_spent_on_addiction
                        
    end subroutine
    
    subroutine check_budget_constraint_clears(time_period,after_tax_wealth_net_of_expenses_1,financial_index)
        
        use Global_Vars
        
        implicit none
        
        integer,intent(in) :: financial_index
        integer, intent(in) :: time_period
        integer :: fin_index_frac_used,financial_index_used,amortization_used,housing_status_index_used
        real(8),intent(in) :: after_tax_wealth_net_of_expenses_1
        real(8) :: frac_used,total_consumption_used,consumption_used,&
            food_stamps_1,assets_1,avg_net_wealth_to_use_1,avg_income_to_use_1,labor_supply_used,income_1,&
            avg_income_to_use_2,checking_criterion,frac_spent_on_addiction_used
        
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
            
        avg_net_wealth_to_use_1=is_counterfactual*average_net_wealth_calibrated+&
            (1-is_counterfactual)*model_average_net_wealth(time_period)
                    
        avg_income_to_use_2=is_counterfactual*average_labor_income_by_employment_calibrated(employment_index)+&
            (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                                    
        frac_used=frac_mov_optimal_1(years_left_on_mortgage_index)%vector_transition_real&
            (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)
            
        fin_index_frac_used=fin_index_frac_mov_to_optimal(years_left_on_mortgage_index)%vector_transition_integer&
            (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)

        financial_index_used=policy_function_financial_index(years_left_on_mortgage_index)%vector_transition_integer&
            (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)

        consumption_used=policy_function_consumption(years_left_on_mortgage_index)%vector_transition_real&
            (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)
            
        labor_supply_used=policy_function_labor_supply(years_left_on_mortgage_index)%vector_transition_real&
            (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)
            
        housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,unemployment_index,employment_index,&
            housing_status_index,voucher_index)
            
        total_consumption_used=policy_function_total_consumption(years_left_on_mortgage_index)%vector_transition_real&
            (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)
            
        frac_spent_on_addiction_used=policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%vector_transition_real&
                (time_period,age_index,financial_index,unemployment_index,employment_index,housing_status_index,voucher_index)

        amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
            vector_transition_integer(time_period,age_index,financial_index,unemployment_index,employment_index,&
            housing_status_index,voucher_index) 

        call calculate_income(unemployment_index,employment_index,income_1,&
            avg_income_to_use_1,avg_income_to_use_2,labor_supply_used,in_retirement)        
    
        income_1=income_1+max(financial_grid(financial_index),0.d0)*risk_free_rate(time_period) 
            
        assets_1=2*threshold_for_food_stamps_as_perc_of_average_net_wealth*&
            avg_net_wealth_to_use_1
        
        ! This one is a homeowner who chooses to rent
        if ((years_left_on_mortgage_index>1) .AND. (amortization_used==1)) then

            assets_1=max(housing_price(time_period)*housing_size(housing_status_index)*&
                (1-cost_of_selling-property_tax(time_period)-housing_depreciation_rate)+&
                min(financial_grid(financial_index),0.d0)*(1+mortgage_interest_rate(time_period))*&
                housing_price(time_period)*housing_size(housing_status_index)+&
                max(financial_grid(financial_index),0.d0),0.d0)
    
        ! This one is a renter who stays renting
        elseif ((years_left_on_mortgage_index==1) .AND. (amortization_used==1)) then
        
            assets_1=max(financial_grid(financial_index),0.d0)

        end if
        
        food_stamps_1=0
        
        ! If they have no assets, they get can qualift for food stamps
        if (assets_1<threshold_for_food_stamps_as_perc_of_average_net_wealth*&
            avg_net_wealth_to_use_1) then
                                
            food_stamps_1=max(max_food_cost*(1+consumption_tax)*avg_income_to_use_1-income_1,0.d0)
                                        
        end if
                                                                                                                            
        x=after_tax_wealth_net_of_expenses_1-&
            ((frac_used*min(financial_grid(fin_index_frac_used),0.d0)+&
            (1-frac_used)*min(financial_grid(financial_index_used),0.d0))*&
            max(amortization_used-1,0)*housing_price(time_period)*housing_size(housing_status_index_used)+&
            frac_used*max(financial_grid(fin_index_frac_used),0.d0)+&
            (1-frac_used)*max(financial_grid(financial_index_used),0.d0)+&            
            (1+consumption_tax)*(consumption_used+frac_spent_on_addiction_used*total_consumption_used))
                
        checking_criterion=5*10.d0**(-8)
                        
        if ((abs(x)>checking_criterion) .AND. (after_tax_wealth_net_of_expenses_1>0) .AND. (frac_spent_on_addiction_used>=0) .AND. &
           (consumption_used>0))  then
                         
!            write(*,*) "error budget does not clear"
            write(*,*) "x=", x
            write(*,*) "min(financial_grid(fin_index_frac_used),0.d0)=", min(financial_grid(fin_index_frac_used),0.d0)
            write(*,*) "min(financial_grid(financial_index_used),0.d0)=", min(financial_grid(financial_index_used),0.d0)
            write(*,*) "amortization_used=", amortization_used
            write(*,*) "years_left_on_mortgage_index=", years_left_on_mortgage_index
            write(*,*) "housing_status_index=", housing_status_index
            write(*,*) "housing_status_index_used=", housing_status_index_used
!            write(*,*) "total_consumption_used=",total_consumption_used
            write(*,*) "food_stamps_1=", food_stamps_1
!            write(*,*) "checking_criterion=", checking_criterion  
            write(*,*) "consumption_used=", consumption_used
!            write(*,*) "(1-frac_spent_on_addiction_used)*total_consumption_used=", &
!                (1-frac_spent_on_addiction_used)*total_consumption_used
!            write(*,*) "consumption_used-(1-frac_spent_on_addiction_used)*total_consumption_used=", &
!                consumption_used-(1-frac_spent_on_addiction_used)*total_consumption_used
!            write(*,*) "financial_index_used=", financial_index_used  
!            write(*,*) "fin_index_frac_used=", fin_index_frac_used
!            write(*,*) "age_index=", age_index                
!            write(*,*) "years_left_on_mortgage_index=", years_left_on_mortgage_index                    
!            write(*,*) "amortization_used=", amortization_used
!            write(*,*) "unemployment_index=", unemployment_index                                                
!            write(*,*) "financial_index=", financial_index                
!            write(*,*) "frac_used=", frac_used
!            
!            write(*,*) "consumption+savings=",&
!                frac_used*(financial_grid(fin_index_frac_used)-&
!                can_get_mortgage*abs(min(financial_grid(financial_index_used),0.d0)))+&
!                (1-frac_used)*(financial_grid(financial_index_used)-&
!                can_get_mortgage*abs(min(financial_grid(financial_index_used),0.d0)))+&
!                (1+consumption_tax)*consumption_used
!                
!            write(*,*) "frac_spent_on_addiction_used=", frac_spent_on_addiction_used
!            write(*,*) "after_tax_wealth_net_of_expenses_1=", after_tax_wealth_net_of_expenses_1     
!            write(*,*) "rent=", rent(time_period,:)
                                                    
        end if
            
        if ((value_function(years_left_on_mortgage_index)%&
            vector_transition_real(time_period,age_index,financial_index,&
            unemployment_index,employment_index,housing_status_index,voucher_index)==&
            large_negative_num) .AND. (after_tax_wealth_net_of_expenses_1>0) .AND. &
            (years_left_on_mortgage_index<=1) .AND. (age_index<life_span)) then
                                                                       
            negative_consumption=1
                        
        end if
    
    end subroutine
    
    subroutine initialize_feasible_distribution(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        integer :: has_house,financial_index,years_left_on_mortgage_index_used
        integer, parameter :: only_26_year_olds=1
        character*1 :: string_used
                        
        do i=1,2
                
            distribution_guess(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
                                
        end do
                
        if (include_exogenous_endowment==1) then
        
            value_of_initial_assets=0
            
            if (only_26_year_olds==1) then
            
                if (start_assets_of_newborns_at_zero==0) then
                
                    relative_endowments=0
                    fraction_with_positive_wealth=0
                
                else

                    relative_endowments(9)=1.3853
                    relative_endowments(8)=1.3853
                    relative_endowments(7)=1.3853
                    relative_endowments(6)=0.8520
                    relative_endowments(5)=0.2609
                    relative_endowments(4)=0.1964
                    relative_endowments(3)=0.1338
                    relative_endowments(2)=0.1319
                    relative_endowments(1)=0.1319
                    
                    relative_endowments(:)=&
                        max(relative_endowments(:),relative_endowments(:)*increase_in_newborns_bequests)

                    fraction_with_positive_wealth(9)=0.7690
                    fraction_with_positive_wealth(8)=0.7690
                    fraction_with_positive_wealth(7)=0.7690
                    fraction_with_positive_wealth(6)=0.6654
                    fraction_with_positive_wealth(5)=0.5946
                    fraction_with_positive_wealth(4)=0.6482
                    fraction_with_positive_wealth(3)=0.5171
                    fraction_with_positive_wealth(2)=0.4779
                    fraction_with_positive_wealth(1)=0.4779
                    
                    fraction_with_positive_wealth(:)=&
                        min(max(fraction_with_positive_wealth(:),&
                        fraction_with_positive_wealth(:)*increase_in_newborns_bequests),1.d0)
                        
    !                write(*,*) "fraction_with_positive_wealth=", fraction_with_positive_wealth(:)
    
                end if
                            
            else    
            
                relative_endowments(9)=3.4658762
                relative_endowments(8)=3.3657614
                relative_endowments(7)=0.89245148
                relative_endowments(6)=0.6887341
                relative_endowments(5)=0.25194367
                relative_endowments(4)=0.14127229
                relative_endowments(3)=0.04659514
                relative_endowments(2)=0
                relative_endowments(1)=0
                
            end if
                        
            max_initial_endowment=is_counterfactual*average_labor_income_calibrated+&
                (1-is_counterfactual)*model_average_labour_income(time_period)

            if (is_counterfactual==0) then

                initial_endowment=negative_financial_grid_size

            end if
            
            do employment_index=1,employment_grid_size
            
                do unemployment_index=1,threshold_addiction_index

                    if (is_counterfactual==0) then
                
                        if (fraction_with_positive_wealth(employment_index)>0) then
                    
                            initial_endowment(employment_index)=&
                                min(minloc(financial_grid(:)-relative_endowments(employment_index)*max_initial_endowment,1,&
                                mask=financial_grid(:)-relative_endowments(employment_index)*max_initial_endowment>0),&
                                financial_grid_size)
                                
                            if (initial_endowment(employment_index)==0) then
                            
                                initial_endowment(employment_index)=financial_grid_size
                                
                            end if
                            
                        else
                        
                            initial_endowment(employment_index)=negative_financial_grid_size
                                                            
                        end if

                    end if
                                    
                    distribution_guess(1)%vector_transition_real&
                        (time_period,1,initial_endowment(employment_index),&
                        unemployment_index,employment_index,0,0)=&
                        fraction_with_positive_wealth(employment_index)*&
                        unconditional_employment_probability(employment_index)*&
                        unconditional_unemployment_probability(unemployment_index)
                        
                    distribution_guess(1)%vector_transition_real&
                        (time_period,1,negative_financial_grid_size,&
                        unemployment_index,employment_index,0,0)=&
                        (1-fraction_with_positive_wealth(employment_index))*&
                        unconditional_employment_probability(employment_index)*&
                        unconditional_unemployment_probability(unemployment_index)
                        
                    value_of_initial_assets=value_of_initial_assets+&
                        distribution_guess(1)%vector_transition_real&
                        (time_period,1,initial_endowment(employment_index),&
                        unemployment_index,employment_index,0,0)*&
                        financial_grid(initial_endowment(employment_index))
                        
                end do
                
            end do

!            write(*,*) "initial_endowment=", initial_endowment      
                        
        else

            fraction_with_positive_wealth=0
        
            distribution_guess(1)%vector_transition_real(time_period,1,negative_financial_grid_size,1,1,0,0)=1
        
        end if
                        
        do age_index=2,life_span
        
            do employment_index=1,employment_grid_size
            
                do unemployment_index=1,threshold_addiction_index

                    if (include_exogenous_endowment==1) then
                                                
                        distribution_guess(1)%vector_transition_real&
                            (time_period,age_index,initial_endowment(employment_index),unemployment_index,employment_index,0,0)=&
                            survival_probability(age_index-1,1,0)*distribution_guess(1)%vector_transition_real&
                            (time_period,age_index-1,initial_endowment(employment_index),unemployment_index,employment_index,0,0)

                    end if
                        
                    distribution_guess(1)%vector_transition_real&
                        (time_period,age_index,negative_financial_grid_size,unemployment_index,employment_index,0,0)=&
                        survival_probability(age_index-1,1,0)*distribution_guess(1)%vector_transition_real&
                        (time_period,age_index-1,negative_financial_grid_size,unemployment_index,employment_index,0,0)
                        
                end do
                
            end do
                                                  
        end do
        
        sum_of_distribution=0
        
        do i=1,2
        
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_guess(i)%vector_transition_real(time_period,:,:,:,:,:,:))
                
        end do
        
        write(*,*) "sum(distribution_guess)=", sum_of_distribution
        
        if (use_old_distribution==1)  then
        
            do i=1,2
            
                write(string_used,'(i1)') i
        
                open(unit=12,file="distribution_stationary"//trim(string_used)//trim(old_results)//".dat",action='read')
                    read(12,'(F30.28)') distribution_guess(i)%vector_transition_real(1,:,:,:,:,:,:)
                close(12)
                            
                if (hold_distribution_fixed==1) then
                
                    distribution_stationary(i)%vector_transition_real(1,:,:,:,:,:,:)=&
                        distribution_guess(i)%vector_transition_real(1,:,:,:,:,:,:)
                
                end if
                
            end do
            
        end if
        
        if (solve_transition_dynamics==1) then
                        
            do i=1,2
            
                distribution_guess(i)%vector_transition_real(0,:,:,:,:,:,:)=0
                
            end do
                
            do age_index=1,life_span
                            
                do years_left_on_mortgage_index=1,max_amortization_years
                            
                    if (years_left_on_mortgage_index>1) then
                        
                        has_house=1
                        
                    else
                    
                        has_house=0
                        
                    end if
                                                                                        
                    do unemployment_index=1,unemployment_grid_size
                    
                        do employment_index=1,employment_grid_size
                        
                            do voucher_index=0,(1-has_house)*include_vouchers
                                                                                        
                                do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                                                   
                                    do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                        has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                                                                                
                                        distribution_guess(years_left_on_mortgage_index_used)%vector_transition_real&
                                            (0,age_index,financial_index,unemployment_index,employment_index,&
                                            housing_status_index,voucher_index)=&
                                            distribution_guess(years_left_on_mortgage_index_used)%&
                                            vector_transition_real(0,age_index,financial_index,&
                                            unemployment_index,employment_index,housing_status_index,voucher_index)+&
                                            distribution_to_fetch(years_left_on_mortgage_index)%vector_real&
                                            (age_index,financial_index,unemployment_index,employment_index,&
                                            housing_status_index,voucher_index)
                            
                                    end do
                                    
                                end do
                                    
                            end do
                            
                        end do
                        
                    end do
                    
                end do
            
            end do
            
            sum_of_distribution=0
        
            do i=1,2
            
                sum_of_distribution=sum_of_distribution+sum(distribution_guess(i)%vector_transition_real(0,:,:,:,:,:,:))
                    
                distribution_stationary(i)%vector_transition_real(0,:,:,:,:,:,:)=&
                    distribution_guess(i)%vector_transition_real(0,:,:,:,:,:,:)
                    
            end do
                        
            write(*,*) "sum_of_distribution 1=", sum_of_distribution
                        
        end if
        
    end subroutine
    
    subroutine compute_voucher_index_1(is_homeless_1,voucher_index_1)
    
        use global_vars
        
        implicit none
        
        integer, intent(out) :: voucher_index_1
        integer, intent(in) :: is_homeless_1
        
        voucher_index_1=1
        
        if (is_homeless_1==1) then
        
            voucher_index_1=2
                                    
            if (unemployment_index>threshold_addiction_index) then
            
                voucher_index_1=3
                
            end if
            
        elseif ((is_counterfactual==1) .AND. (unemployment_index>threshold_addiction_index) .AND. &
            (increased_prob_of_voucher_if_homeless_and_addicted==0)) then
            
            voucher_index_1=3
            
        end if 
    
    end subroutine
    
    subroutine calculate_future_voucher_index_and_opportunity&
        (has_opportunity,first_voucher_index,second_voucher_index,&
        time_period,has_house,choose_to_own_1,voucher_index_1,income_to_use_5)
    
        use global_vars
        
        implicit none
        
        integer, intent(in) :: time_period,has_house,voucher_index_1,choose_to_own_1
        real(8) :: income_to_use_5
        integer, intent(inout) :: has_opportunity,first_voucher_index,second_voucher_index
        
        has_opportunity=0
        first_voucher_index=0
        second_voucher_index=0

        if ((income_to_use_5<threshold_income_vouchers*&
            ((1-is_counterfactual)*median_income(time_period)+&
            is_counterfactual*median_income_calibrated)) .AND. &
            (include_vouchers==1)) then
            
            if ((has_house==0) .AND. (choose_to_own_1==0) .AND. (voucher_index==0)) then

                has_opportunity=1
                first_voucher_index=0
                second_voucher_index=include_vouchers

            elseif ((has_house==0) .AND. (choose_to_own_1==0) .AND. (voucher_index==1)) then

                has_opportunity=1
                first_voucher_index=include_vouchers
                second_voucher_index=include_vouchers
                
                ! Those who are addicted in a counterfactual, has the option to move to both not getting a vouchers                
                if ((is_counterfactual==1) .AND. (voucher_index_1==3) .AND. &
                    (increased_prob_of_voucher_if_homeless_and_addicted==0)) then
                    
                    has_opportunity=1
                    first_voucher_index=0
                    second_voucher_index=include_vouchers
                    
                end if             
                
            elseif ((has_house==1) .AND. (choose_to_own_1==0)) then

                has_opportunity=1
                first_voucher_index=0
                second_voucher_index=include_vouchers

            end if

        end if
        
    end subroutine
    
    subroutine converge_to_stationary_equilibrium(time_period)
    
        use Global_Vars
        !$ use omp_lib
               
        implicit none
        
        integer :: financial_index,has_house,time_period,track_housing_1,voucher_index_1
        integer :: number_of_threads_used,loop_only_over_oldest,amortization_used,is_addicted_1
        real(8) :: sum_distribution_implied,sum_distribution_guess,avg_income_to_use_1,avg_income_to_use_2
        character*1 :: string_used
                
        if (partial_equilibrium==1) then
        
            do i=1,2
            
                write(string_used,'(i1)') i
        
                open(unit=12,file="distribution_stationary"//trim(string_used)//trim(benchmark_simulation)//".dat",action='read')
                    read(12,'(F30.28)') distribution_stationary(i)%vector_transition_real(1,:,:,:,:,:,:)
                close(12)
                
                distribution_guess(i)%vector_transition_real(1,:,:,:,:,:,:)=&
                    distribution_stationary(i)%vector_transition_real(1,:,:,:,:,:,:)
                
            end do
        
        end if

        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                            
        if (have_probablistic_death==0) then
            
            loop_only_over_oldest=1
            
        else
        
            loop_only_over_oldest=1
            
        end if
        
        if (solve_transition_dynamics>=0) then
        
!            !$omp parallel
!            !$omp master
!            !$ total_number_of_threads=omp_get_num_threads()
!!            write(*,*) "total_number_of_threads=", total_number_of_threads
!            !$omp end master
!            !$omp end parallel
                    
        end if
        
        if ((is_counterfactual==1) .AND. (solve_transition_dynamics==1)) then
        
            write(*,*) "time_period=", time_period
        
        end if
        
        if (partial_equilibrium==1) then
        
            if (how_many_iterations_to_do_on_distribution==0) then
        
                distance_distribution=0
                
            else
            
                distance_distribution=1
                
            end if
        
        else
        
            distance_distribution=1
            
        end if
                
        loop_count_dist=0
               
        do while (distance_distribution>stopping_rule_stationary_distribution)
        
            do i=1,2
                
                distribution_implied_private(i)%vector_cpu_real(:,:,:,:,:,:,:)=0
                distribution_implied(i)%vector_transition_real(:,:,:,:,:,:,:)=0
                
            end do
            
             if (solve_transition_dynamics>=0) then
             
                number_of_threads_used=max_CPUs

                CALL OMP_SET_NUM_THREADS(number_of_threads_used)
        
                !$omp parallel
                !$omp master
                !$ total_number_of_threads=omp_get_num_threads()
                !$omp end master
                !$omp end parallel
                    
            end if
            
            do m=1,2
                
                do age_index=1,life_span-1

                    if (age_index>(life_span-retirement_span)) then
                    
                        in_retirement=1
                    
                    else
                    
                        in_retirement=0
                    
                    end if
                    
                    if (age_index>=(life_span-retirement_span)) then
                    
                        at_least_one_period_before_retirement=1
                    
                    else
                    
                        at_least_one_period_before_retirement=0
                    
                    end if
                    
                    one_period_before_death=0
                    
                    if (age_index==life_span) then
                    
                        one_period_before_death=1
                        
                    end if
                                                            
                    if (age_index==1) then
                
                        newborn_household=1
                        
                    else
                
                        newborn_household=0
                    
                    end if
                
                    do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years
                                            
                        if (years_left_on_mortgage_index>1) then
                        
                            has_house=1
                            
                        else
                        
                            has_house=0
                            
                        end if
                        
                        track_housing_1=1
                        
                        if (has_house==0) then
                        
                            if (track_renters_housing==0) then
                            
                                track_housing_1=0
                                
                            end if
                            
                        end if
                                
                        do unemployment_index=1,unemployment_grid_size
                        
                            do employment_index=1,employment_grid_size

                                avg_income_to_use_2=is_counterfactual*&
                                    average_labor_income_by_employment_calibrated(employment_index)+&
                                    (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                            
                                do voucher_index=0,(1-has_house)*include_vouchers
                                                                             
                                    !$omp parallel do default(none) &
                                    !$omp& shared(&
                                    !$omp& distribution_implied_private,distribution_guess,&
                                    !$omp& frac_mov_optimal_1,fin_index_frac_mov_to_optimal,policy_function_addiction,&
                                    !$omp& policy_function_financial_index,policy_function_years_of_amortization_index,&
                                    !$omp& policy_function_housing_status_index,unemployment_process,one_period_before_death,&
                                    !$omp& m,time_period,has_mortgage,newborn_household,track_housing_1,voucher_index,&
                                    !$omp& at_least_one_period_before_retirement,survival_probability,employment_process,&
                                    !$omp& age_index,has_house,years_left_on_mortgage_index,unemployment_index,employment_index,&
                                    !$omp& index_of_smallest_house_hhld_can_buy,addiction_probabilities,voucher_probabilities,&
                                    !$omp& avg_income_to_use_1,avg_income_to_use_2,policy_function_labor_supply,in_retirement,&
                                    !$omp& median_income,financial_grid,risk_free_rate,median_income_calibrated,is_addicted_1,&
                                    !$omp& voucher_index_1,survival_probability_for_dist_iteration)
!                                                                        
                                    do financial_index=newborn_household*negative_financial_grid_size+&
                                         (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                         include_exogenous_endowment*financial_grid_size+(1-include_exogenous_endowment)*&
                                         (newborn_household*negative_financial_grid_size+(1-newborn_household)*financial_grid_size)
                                
                                        !thread_num=0
                                        !$ thread_num=omp_get_thread_num()

                                        do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                            has_house*index_of_smallest_house_hhld_can_buy,&
                                            track_housing_1*(1-newborn_household)*(housing_status_grid_size-1)    
                                                                                                            
                                            if (policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)>1) then
                                                
                                                choose_to_own=1
                                                
                                            else
                                            
                                                choose_to_own=0
                                                
                                            end if
                                            
                                            income_to_use_4=2*((1-is_counterfactual)*median_income(time_period)+&
                                                is_counterfactual*median_income_calibrated)

                                            if (choose_to_own==0) then

                                                labor_supply_to_use=&
                                                    policy_function_labor_supply(years_left_on_mortgage_index)%&
                                                    vector_transition_real(time_period,age_index,financial_index,&
                                                    unemployment_index,employment_index,housing_status_index,voucher_index)

                                                call calculate_income(unemployment_index,employment_index,income_to_use_4,&
                                                    avg_income_to_use_1,avg_income_to_use_2,labor_supply_to_use,in_retirement)

                                                income_to_use_4=income_to_use_4+&
                                                    risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)

                                            end if

                                            track_housing_2=1
                                            
                                            if (choose_to_own==0) then
                                            
                                                if (track_renters_housing==0) then
                                                
                                                    track_housing_2=0
                                                    
                                                end if
                                                
                                            end if
                                            
                                            if (m==1) then
                                                    
                                                financial_index_copy=policy_function_financial_index&
                                                    (years_left_on_mortgage_index)%vector_transition_integer&
                                                    (time_period,age_index,financial_index,unemployment_index,&
                                                    employment_index,housing_status_index,voucher_index)
                                                    
                                                fraction_copy=(1-frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                                    vector_transition_real(time_period,age_index,&
                                                    financial_index,unemployment_index,employment_index,&
                                                    housing_status_index,voucher_index))
                                                                                                    
                                            elseif (m==2) then
                                            
                                                financial_index_copy=fin_index_frac_mov_to_optimal&
                                                    (years_left_on_mortgage_index)%vector_transition_integer&
                                                    (time_period,age_index,financial_index,unemployment_index,&
                                                    employment_index,housing_status_index,voucher_index)
                                                    
                                                fraction_copy=frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                                    vector_transition_real(time_period,&
                                                    age_index,financial_index,unemployment_index,employment_index,&
                                                    housing_status_index,voucher_index)
                                                                                                                                                                                                                                                           
                                            end if

                                            amortization_used_dist=policy_function_years_of_amortization_index&
                                                (years_left_on_mortgage_index)%vector_transition_integer&
                                                (min(time_period,transition_length),age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            future_housing_status_index_to_use_2=&
                                                policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            if (track_housing_2==0) then
                                            
                                                if (future_housing_status_index_to_use_2>second_lowest_housing_grid_point) then
                                                
                                                    future_housing_status_index_to_use_2=0
                                                    
                                                end if
                                                
                                            end if
                                            
                                            is_homeless_2=1
                                            
                                            if (future_housing_status_index_to_use_2==lowest_housing_grid_point) then
                                            
                                                is_homeless_2=2
                                            
                                            end if
                                            
                                            call compute_voucher_index_1(is_homeless_2,voucher_index_1)
                                            
                                            call calculate_future_voucher_index_and_opportunity&
                                                (has_opportunity_2,first_voucher_index_1,second_voucher_index_1,&
                                                time_period,has_house,choose_to_own,voucher_index_1,income_to_use_4)
                                                                                        
                                            addiction_choice_1=&
                                                policy_function_addiction(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            is_addicted_1=0                                                
                                            loop_over_addiction_2=0
                                                                                                                                                                                   
                                            if (unemployment_index>threshold_addiction_index) then
                                            
                                                is_addicted_1=1
                                                loop_over_addiction_2=1
                                                
                                            elseif ((addiction_choice_1==1) .AND. &
                                                (unemployment_index<=threshold_addiction_index) .AND. &
                                                (include_probability_of_becoming_addicted==1)) then
                                                
                                                loop_over_addiction_2=1
                                                
                                            end if
                                            
                                            do future_addiction_index_2=&
                                                (1-loop_over_addiction_2)*addiction_choice_1+loop_over_addiction_2*0,&
                                                (1-loop_over_addiction_2)*addiction_choice_1+loop_over_addiction_2*include_addiction
                                                
                                                check_2=0
                                                
                                                if (future_addiction_index_2==1) then
                                                
                                                    check_2=1
                                                    
                                                end if
                                            
                                                do future_unemployment_index=include_addiction*&
                                                    ((1-check_2)*1+check_2*(threshold_addiction_index+1))+&
                                                    (1-include_addiction)*(at_least_one_period_before_retirement*&
                                                    (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                                    (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                                    ((1-check_2)*threshold_addiction_index+check_2*unemployment_grid_size)+&
                                                    (1-include_addiction)*(at_least_one_period_before_retirement*&
                                                    (one_period_before_death*unemployment_grid_size+&
                                                    (1-one_period_before_death)*unemployment_index)+&
                                                    (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                                 
                                                    do future_employment_index=&
                                                        at_least_one_period_before_retirement*employment_index+&
                                                        (1-at_least_one_period_before_retirement)*1,&
                                                        at_least_one_period_before_retirement*employment_index+&
                                                        (1-at_least_one_period_before_retirement)*employment_grid_size

                                                        do future_voucher_index=first_voucher_index_1,second_voucher_index_1
                                                        
                                                            distribution_implied_private(amortization_used_dist)%&
                                                                vector_cpu_real(thread_num+1,age_index+1,financial_index_copy,&
                                                                future_unemployment_index,future_employment_index,&
                                                                future_housing_status_index_to_use_2,future_voucher_index)=&
                                                                fraction_copy*survival_probability_for_dist_iteration&
                                                                (age_index,is_homeless_2,is_addicted_1)*&
                                                                voucher_probabilities(voucher_index,&
                                                                future_voucher_index,has_opportunity_2,voucher_index_1)*&
                                                                employment_process(age_index,employment_index,&
                                                                future_employment_index)*unemployment_process&
                                                                (age_index,unemployment_index,future_unemployment_index,&
                                                                is_homeless_2,future_addiction_index_2,employment_index)*&
                                                                addiction_probabilities(is_addicted_1,&
                                                                future_addiction_index_2,addiction_choice_1,is_homeless_2)*&
                                                                distribution_guess(years_left_on_mortgage_index)%&
                                                                vector_transition_real(time_period-solve_transition_dynamics,&
                                                                age_index,financial_index,unemployment_index,employment_index,&
                                                                housing_status_index,voucher_index)+&
                                                                distribution_implied_private(amortization_used_dist)%&
                                                                vector_cpu_real&
                                                                (thread_num+1,age_index+1,financial_index_copy,&
                                                                future_unemployment_index,future_employment_index,&
                                                                future_housing_status_index_to_use_2,future_voucher_index)

                                                        end do
                                                                                                                                                                                                                
                                                    end do
                                                    
                                                end do
                                                
                                            end do
                                                
                                        end do
                                
                                    end do
                                                                  
                                    !$omp end parallel do
                                    
                                end do
                                
                            end do
                        
                        end do
                
                    end do
                                                
                end do
            
            end do
            
            if (solve_transition_dynamics>=0) then
            
                number_of_threads_used=max_CPUs

                CALL OMP_SET_NUM_THREADS(number_of_threads_used)
        
                !$omp parallel
                !$omp master
                !$ total_number_of_threads=omp_get_num_threads()
                !$omp end master
                !$omp end parallel
                    
            end if
            
            if ((have_probablistic_death==1) .OR. (newborns_inherit_addiction==0)) then
            
                do future_employment_index=1,employment_grid_size
            
                    do future_unemployment_index=1,threshold_addiction_index
                                
                        if (include_exogenous_endowment==1) then
                    
                            distribution_implied_private(1)%vector_cpu_real(1,1,&
                                initial_endowment(future_employment_index),&
                                future_unemployment_index,future_employment_index,0,0)=&
                                fraction_with_positive_wealth(future_employment_index)*&
                                unconditional_employment_probability(future_employment_index)*&
                                unconditional_unemployment_probability(future_unemployment_index)
                                                                                                
                        end if
                        
                        distribution_implied_private(1)%vector_cpu_real(1,1,&
                            negative_financial_grid_size,future_unemployment_index,&
                            future_employment_index,0,0)=&
                            (1-fraction_with_positive_wealth(future_employment_index))*&
                            unconditional_employment_probability(future_employment_index)*&    
                            unconditional_unemployment_probability(future_unemployment_index)
                            
                    end do
                        
                end do
            
            else
            
                do m=1,2
                
                    do age_index=loop_only_over_oldest*life_span+(1-loop_only_over_oldest)*1,life_span
                                                                            
                        if (age_index==1) then
                    
                            newborn_household=1
                                                
                        else
                    
                            newborn_household=0
                        
                        end if
                    
                        do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years
                                                
                            if (years_left_on_mortgage_index>1) then
                            
                                has_house=1
                                
                            else
                            
                                has_house=0
                                
                            end if
                            
                            track_housing_1=1
                            
                            if (has_house==0) then
                            
                                if (track_renters_housing==0) then
                                
                                    track_housing_1=0
                                    
                                end if
                                
                            end if
                                                                    
                            do unemployment_index=1,unemployment_grid_size
                            
                                do employment_index=1,employment_grid_size

                                    do voucher_index=0,(1-has_house)*include_vouchers
                                                                  
                                        !$omp parallel do default(none) &
                                        !$omp& shared(distribution_implied_private,distribution_guess,&
                                        !$omp& frac_mov_optimal_1,fin_index_frac_mov_to_optimal,policy_function_addiction,&
                                        !$omp& policy_function_financial_index,policy_function_years_of_amortization_index,&
                                        !$omp& policy_function_housing_status_index,initial_endowment,&
                                        !$omp& m,time_period,has_mortgage,at_least_one_period_before_retirement,&
                                        !$omp& has_house,survival_probability,unemployment_process,newborn_household,&
                                        !$omp& unconditional_employment_probability,fraction_with_positive_wealth,&
                                        !$omp& age_index,years_left_on_mortgage_index,unemployment_index,employment_index,&
                                        !$omp& index_of_smallest_house_hhld_can_buy,financial_grid,voucher_index,&
                                        !$omp& value_of_initial_assets,track_housing_1,addiction_probabilities,&
                                        !$omp& is_addicted_1,survival_probability_for_dist_iteration)
                                                                                            
                                        do financial_index=newborn_household*negative_financial_grid_size+&
                                            (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                            include_exogenous_endowment*financial_grid_size+&
                                            (1-include_exogenous_endowment)*(newborn_household*negative_financial_grid_size+&
                                            (1-newborn_household)*financial_grid_size)
                                    
                                            !thread_num=0
                                            !$ thread_num=omp_get_thread_num()
                    
                                            do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                                has_house*index_of_smallest_house_hhld_can_buy,&
                                                track_housing_1*(1-newborn_household)*(housing_status_grid_size-1)
                                                                                                                
                                                if (policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                                    vector_transition_integer(time_period,age_index,financial_index,&
                                                    unemployment_index,employment_index,housing_status_index,voucher_index)>1) then
                                                    
                                                    choose_to_own=1
                                                    
                                                else
                                                
                                                    choose_to_own=0
                                                    
                                                end if
                                                
                                                if (m==1) then
                                                            
                                                    financial_index_copy=policy_function_financial_index&
                                                        (years_left_on_mortgage_index)%&
                                                        vector_transition_integer(time_period,age_index,financial_index,&
                                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                        
                                                    fraction_copy=1-frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                                        vector_transition_real(time_period,age_index,&
                                                        financial_index,unemployment_index,employment_index,&
                                                        housing_status_index,voucher_index)
                                                    
                                                elseif (m==2) then
                                                
                                                    financial_index_copy=fin_index_frac_mov_to_optimal&
                                                        (years_left_on_mortgage_index)%&
                                                        vector_transition_integer(time_period,age_index,financial_index,&
                                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                        
                                                    fraction_copy=frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                                        vector_transition_real(time_period,age_index,&
                                                        financial_index,unemployment_index,employment_index,&
                                                        housing_status_index,voucher_index)
                                                
                                                end if
                                                
                                                future_housing_status_index_to_use_2=&
                                                    policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                                    vector_transition_integer(time_period,age_index,financial_index,&
                                                    unemployment_index,employment_index,housing_status_index,voucher_index)
                                                                                                    
                                                is_homeless_2=1
                                                                                                
                                                if (future_housing_status_index_to_use_2==lowest_housing_grid_point) then
                                                
                                                    is_homeless_2=2
                                                
                                                end if
                                                
                                                addiction_choice_1=&
                                                    policy_function_addiction(years_left_on_mortgage_index)%&
                                                    vector_transition_integer(time_period,age_index,financial_index,&
                                                    unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                                is_addicted_1=0
                                                loop_over_addiction_2=0
                                                
                                                if (unemployment_index>threshold_addiction_index) then
                                                
                                                    is_addicted_1=1
                                                    loop_over_addiction_2=1
                                                    
                                                elseif ((addiction_choice_1==1) .AND. &
                                                    (include_probability_of_becoming_addicted==1)) then
                                                
                                                    loop_over_addiction_2=1
                                                    
                                                end if
                                                
                                                do future_addiction_index_2=&
                                                    newborns_inherit_addiction*((1-loop_over_addiction_2)*addiction_choice_1+& 
                                                    loop_over_addiction_2*0)+(1-newborns_inherit_addiction),& 
                                                    newborns_inherit_addiction*((1-loop_over_addiction_2)*addiction_choice_1+& 
                                                    loop_over_addiction_2*include_addiction)+(1-newborns_inherit_addiction)
                                                    
                                                    check_2=0
                                                    
                                                    if (future_addiction_index_2==1) then
                                                    
                                                        check_2=1
                                                        
                                                    end if
                                        
                                                    do future_unemployment_index=&
                                                        newborns_inherit_addiction*include_addiction*&
                                                        ((1-check_2)*1+check_2*(threshold_addiction_index+1))+&
                                                        (1-newborns_inherit_addiction),newborns_inherit_addiction*&
                                                        (include_addiction*((1-check_2)*threshold_addiction_index+&
                                                        check_2*unemployment_grid_size)+(1-include_addiction)*&
                                                        unemployment_grid_size)+&
                                                        (1-newborns_inherit_addiction)*threshold_addiction_index
                                                                                                                                                          
                                                        do future_employment_index=1,employment_grid_size
                                                                                                                                                                                        
                                                            if (include_exogenous_endowment==1) then
                                                                                                                                                                        
                                                                distribution_implied_private(1)%vector_cpu_real(thread_num+1,1,&
                                                                    initial_endowment(future_employment_index),&
                                                                    future_unemployment_index,future_employment_index,0,0)=&
                                                                    fraction_copy*&
                                                                    (1-survival_probability_for_dist_iteration(age_index,1,0))*&
                                                                    fraction_with_positive_wealth(employment_index)*&
                                                                    unconditional_employment_probability(future_employment_index)*&
                                                                    unemployment_process(age_index,unemployment_index,&                                                            
                                                                    future_unemployment_index,is_homeless_2,&
                                                                    future_addiction_index_2,employment_index)*&
                                                                    addiction_probabilities(is_addicted_1,&
                                                                    future_addiction_index_2,addiction_choice_1,is_homeless_2)*& 
                                                                    distribution_guess(years_left_on_mortgage_index)%&
                                                                    vector_transition_real(time_period-solve_transition_dynamics,&
                                                                    age_index,financial_index,unemployment_index,employment_index,&
                                                                    housing_status_index,voucher_index)+&
                                                                    distribution_implied_private(1)%&
                                                                    vector_cpu_real(thread_num+1,1,initial_endowment&
                                                                    (future_employment_index),future_unemployment_index,&
                                                                    future_employment_index,0,0)

                                                            end if
                                                                                                                    
                                                            distribution_implied_private(1)%vector_cpu_real(thread_num+1,1,&
                                                                negative_financial_grid_size,future_unemployment_index,&
                                                                future_employment_index,0,0)=fraction_copy*&
                                                                (1-survival_probability_for_dist_iteration(age_index,1,0))*&
                                                                (1-fraction_with_positive_wealth(employment_index))*&
                                                                unconditional_employment_probability(future_employment_index)*&    
                                                                unemployment_process(age_index,unemployment_index,&
                                                                future_unemployment_index,is_homeless_2,future_addiction_index_2,&
                                                                employment_index)*addiction_probabilities(is_addicted_1,&
                                                                future_addiction_index_2,addiction_choice_1,is_homeless_2)*&
                                                                distribution_guess(years_left_on_mortgage_index)%&
                                                                vector_transition_real&
                                                                (time_period-solve_transition_dynamics,age_index,financial_index,&
                                                                unemployment_index,employment_index,housing_status_index,&
                                                                voucher_index)+distribution_implied_private(1)%vector_cpu_real&
                                                                (thread_num+1,1,negative_financial_grid_size,&
                                                                future_unemployment_index,future_employment_index,0,0)
                                                                                                                                                                                                                                                                                            
                                                        end do
                                                                
                                                    end do
                                                    
                                                end do 
                                                                                                    
                                            end do
                                        
                                        end do
                                                                        
                                        !$omp end parallel do

                                    end do            
                                    
                                end do
                                
                            end do
                    
                        end do
                                    
                    end do
                
                end do
                
            end if
            
            if (solve_transition_dynamics>=0) then
            
                number_of_threads_used=max_CPUs

                CALL OMP_SET_NUM_THREADS(number_of_threads_used)
        
                !$omp parallel
                !$omp master
                !$ total_number_of_threads=omp_get_num_threads()
                !$omp end master
                !$omp end parallel
                    
            end if
                        
            do age_index=1,life_span
            
                if (age_index==1) then
                
                    newborn_household=1
                    
                else
                
                    newborn_household=0
                    
                end if
                                                      
                do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years
                
                    if (years_left_on_mortgage_index>1) then
                    
                        has_house=1
                        
                    else
                    
                        has_house=0
                        
                    end if
                    
                    track_housing_1=1
                        
                    if (has_house==0) then
                    
                        if (track_renters_housing==0) then
                        
                            track_housing_1=0
                            
                        end if
                        
                    end if
                                    
                    do unemployment_index=1,unemployment_grid_size
                    
                        do employment_index=1,employment_grid_size
                        
                            do voucher_index=0,(1-has_house)*include_vouchers
                                            
                                !$omp parallel do default(none) &
                                !$omp& shared(distribution_implied_private,distribution_implied,track_housing_1,&
                                !$omp& total_number_of_threads,time_period,age_index,has_mortgage,has_house,&
                                !$omp& years_left_on_mortgage_index,newborn_household,&
                                !$omp& unemployment_index,employment_index,voucher_index,index_of_smallest_house_hhld_can_buy)
                                                                                    
                                do financial_index=newborn_household*negative_financial_grid_size+&
                                    (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                    include_exogenous_endowment*financial_grid_size+(1-include_exogenous_endowment)*&
                                    (newborn_household*negative_financial_grid_size+(1-newborn_household)*financial_grid_size)
                                
                                    do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                        has_house*index_of_smallest_house_hhld_can_buy,&
                                        track_housing_1*(1-newborn_household)*(housing_status_grid_size-1)
                                                                                                                                                           
                                        do thread_index=1,total_number_of_threads ! 1
                                
                                            distribution_implied(years_left_on_mortgage_index)%vector_transition_real&
                                                (time_period,age_index,financial_index,unemployment_index,&
                                                employment_index,housing_status_index,voucher_index)=&
                                                distribution_implied(years_left_on_mortgage_index)%vector_transition_real&
                                                (time_period,age_index,financial_index,unemployment_index,&
                                                employment_index,housing_status_index,voucher_index)+&
                                                distribution_implied_private(years_left_on_mortgage_index)%vector_cpu_real&
                                                (thread_index,age_index,financial_index,unemployment_index,&
                                                employment_index,housing_status_index,voucher_index)
                                                
                                        end do
                                        
                                    end do
                                    
                                end do
                                                        
                                !$omp end parallel do
                                
                            end do
                            
                        end do
                        
                    end do
                                        
                end do
                                
            end do
            
            value_of_initial_assets=0

            if (include_exogenous_endowment==1) then
            
                do employment_index=1,employment_grid_size
                
                    do unemployment_index=1,unemployment_grid_size
                
                        value_of_initial_assets=value_of_initial_assets+&
                            distribution_implied(1)%vector_transition_real(thread_num+1,1,&
                            initial_endowment(employment_index),unemployment_index,employment_index,0,0)*&
                            financial_grid(initial_endowment(employment_index))
                            
                    end do
                
                end do

            end if

            if (solve_transition_dynamics==0) then
            
                distance_distribution=0
            
                do i=1,2
            
                    if (maxval(abs(distribution_implied(i)%vector_transition_real(time_period,:,:,:,:,:,:)-&
                        distribution_guess(i)%vector_transition_real(time_period,:,:,:,:,:,:)))>distance_distribution) then
                        
                        distance_distribution=&
                            maxval(abs(distribution_implied(i)%vector_transition_real(time_period,:,:,:,:,:,:)-&
                            distribution_guess(i)%vector_transition_real(time_period,:,:,:,:,:,:)))
                            
                    end if
                        
                end do
                    
            else
            
                distance_distribution=0
                    
            end if
                        
            do i=1,2
            
                if (minval(distribution_implied(i)%vector_transition_real(:,:,:,:,:,:,:))<0) then
                
                    write(*,*) "minval distribution_implied=", minval(distribution_implied(i)%vector_transition_real(:,:,:,:,:,:,:))            
                
                end if
                
            end do
            
            sum_distribution_implied=0
            sum_distribution_guess=0
                                    
            do i=1,2
            
                sum_distribution_implied=sum_distribution_implied+&
                    sum(distribution_implied(i)%vector_transition_real(time_period,:,:,:,:,:,:))
            
                sum_distribution_guess=sum_distribution_guess+&
                    sum(distribution_guess(i)%vector_transition_real(time_period-solve_transition_dynamics,:,:,:,:,:,:))
            
            end do
                        
            if ((abs(sum_distribution_guess-sum_distribution_implied)>10.d0**(-10)) .AND. &
                (have_probablistic_death==0)) then
                                
                write(*,*) "sum(distribution_guess(",time_period,")=", sum_distribution_guess
                                                            
                write(*,*) "sum(distribution_implied(",time_period,")=", sum_distribution_implied
                    
            end if
                                    
            if (solve_transition_dynamics==0) then
                
                write(*,*) "distribution distance=", distance_distribution
                
            end if
                
            do i=1,2
                
                distribution_guess(i)%vector_transition_real(time_period,:,:,:,:,:,:)=&
                    distribution_implied(i)%vector_transition_real(time_period,:,:,:,:,:,:)
                    
            end do
                        
            loop_count_dist=loop_count_dist+1
            
            if (partial_equilibrium==1) then
            
                distance_distribution=1
            
                if (loop_count_dist==how_many_iterations_to_do_on_distribution) then
                
                    distance_distribution=0
                
                end if
                
            end if
                       
        end do
        
        if ((partial_equilibrium==0) .OR. (how_many_iterations_to_do_on_distribution>0)) then
        
            do i=1,2
                   
                distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:)=&
                    distribution_implied(i)%vector_transition_real(time_period,:,:,:,:,:,:)

            end do
            
        end if

    end subroutine
    
    subroutine compute_homelessness_duration(time_period)
    
        use global_vars
        
        implicit none
        
        integer, intent(in) :: time_period
        integer :: has_house,track_housing_1,financial_index,is_addicted_1,amortization_used
        integer :: age_index_1,addiction_index_1,addiction_lower_bound,addiction_upper_bound,voucher_index_1
        real(8) :: avg_income_to_use_2,avg_income_to_use_1
        real(8), dimension(0:2) :: total_homeless_count
        
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                
        do addiction_index_1=0,2
    
            total_homeless_count(addiction_index_1)=0
            homelessness_duration_everyone(time_period,addiction_index_1)=0
    
            do age_index_1=1,life_span
                
                addiction_lower_bound=addiction_index_1
                addiction_upper_bound=addiction_index_1
            
                if (addiction_index_1==2) then
                
                    addiction_lower_bound=0
                    addiction_upper_bound=include_addiction
                    
                end if
        
                homelessness_duration(time_period,age_index_1,addiction_index_1)=0
                homelessness_mass_by_age(time_period,:)=0
                                
                do i=1,2
                
                    distribution_forward(i)%vector_transition_real(time_period,:,:,:,:,:,:)=0
                    
                    if (addiction_index_1==1) then
                    
                        do j=threshold_addiction_index+1,unemployment_grid_size
                           
                            distribution_forward(i)%vector_transition_real(time_period,age_index_1,:,j,:,:,:)=&
                                distribution_stationary(i)%vector_transition_real(time_period,age_index_1,:,j,:,:,:)
                                
                        end do
                            
                    elseif (addiction_index_1==0) then
                    
                        do j=1,threshold_addiction_index
                        
                            distribution_forward(i)%vector_transition_real(time_period,age_index_1,:,j,:,:,:)=&
                                distribution_stationary(i)%vector_transition_real(time_period,age_index_1,:,j,:,:,:)
                                
                        end do
                        
                    else
                                            
                        distribution_forward(i)%vector_transition_real(time_period,age_index_1,:,:,:,:,:)=&
                            distribution_stationary(i)%vector_transition_real(time_period,age_index_1,:,:,:,:,:)
                           
                    end if

                end do
                        
                do age_index=age_index_1,life_span
                
                    if (age_index>(life_span-retirement_span)) then
                    
                        in_retirement=1
                    
                    else
                    
                        in_retirement=0
                    
                    end if
                    
                    if (age_index>=(life_span-retirement_span)) then
                    
                        at_least_one_period_before_retirement=1
                    
                    else
                    
                        at_least_one_period_before_retirement=0
                    
                    end if
                    
                    one_period_before_death=0
                    
                    if (age_index==life_span) then
                    
                        one_period_before_death=1
                        
                    end if
                                                            
                    if (age_index==1) then
                
                        newborn_household=1
                        
                    else
                
                        newborn_household=0
                    
                    end if
                
                    do years_left_on_mortgage_index=1,newborn_household*1+(1-newborn_household)*max_amortization_years
                                            
                        if (years_left_on_mortgage_index>1) then
                        
                            has_house=1
                            
                        else
                        
                            has_house=0
                            
                        end if
                        
                        track_housing_1=1
                        
                        if (has_house==0) then
                        
                            if (track_renters_housing==0) then
                            
                                track_housing_1=0
                                
                            end if
                            
                        end if
                                
                        do unemployment_index=1,unemployment_grid_size
                        
                            do employment_index=1,employment_grid_size

                                avg_income_to_use_2=is_counterfactual*&
                                    average_labor_income_by_employment_calibrated(employment_index)+&
                                    (1-is_counterfactual)*model_average_labour_income_by_employment(time_period,employment_index)
                            
                                do voucher_index=0,(1-has_house)*include_vouchers
                                                                             !                                                                        
                                    do financial_index=newborn_household*negative_financial_grid_size+&
                                         (1-newborn_household)*(has_house*1+(1-has_house)*negative_financial_grid_size),&
                                         include_exogenous_endowment*financial_grid_size+(1-include_exogenous_endowment)*&
                                         (newborn_household*negative_financial_grid_size+(1-newborn_household)*financial_grid_size)
                                
                                        do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                            has_house*index_of_smallest_house_hhld_can_buy,&
                                            track_housing_1*(1-newborn_household)*(housing_status_grid_size-1) 
                                            
                                            if (policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)>1) then
                                                
                                                choose_to_own=1
                                                
                                            else
                                            
                                                choose_to_own=0
                                                
                                            end if
                                            
                                            income_to_use_4=2*((1-is_counterfactual)*median_income(time_period)+&
                                                is_counterfactual*median_income_calibrated)

                                            if (choose_to_own==0) then

                                                labor_supply_to_use=&
                                                    policy_function_labor_supply(years_left_on_mortgage_index)%&
                                                    vector_transition_real(time_period,age_index,financial_index,&
                                                    unemployment_index,employment_index,housing_status_index,voucher_index)

                                                call calculate_income(unemployment_index,employment_index,income_to_use_4,&
                                                    avg_income_to_use_1,avg_income_to_use_2,labor_supply_to_use,in_retirement)

                                                income_to_use_4=income_to_use_4+&
                                                    risk_free_rate(time_period)*max(financial_grid(financial_index),0.d0)

                                            end if
                                            
                                            track_housing_2=1
                                            
                                            if (choose_to_own==0) then
                                            
                                                if (track_renters_housing==0) then
                                                
                                                    track_housing_2=0
                                                    
                                                end if
                                                
                                            end if
                                            
                                            if (m==1) then
                                                    
                                                financial_index_copy=policy_function_financial_index&
                                                    (years_left_on_mortgage_index)%vector_transition_integer&
                                                    (time_period,age_index,financial_index,unemployment_index,&
                                                    employment_index,housing_status_index,voucher_index)
                                                    
                                                fraction_copy=(1-frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                                    vector_transition_real(time_period,age_index,&
                                                    financial_index,unemployment_index,employment_index,&
                                                    housing_status_index,voucher_index))
                                                                                                    
                                            elseif (m==2) then
                                            
                                                financial_index_copy=fin_index_frac_mov_to_optimal&
                                                    (years_left_on_mortgage_index)%vector_transition_integer&
                                                    (time_period,age_index,financial_index,unemployment_index,&
                                                    employment_index,housing_status_index,voucher_index)
                                                    
                                                fraction_copy=frac_mov_optimal_1(years_left_on_mortgage_index)%&
                                                    vector_transition_real(time_period,&
                                                    age_index,financial_index,unemployment_index,employment_index,&
                                                    housing_status_index,voucher_index)
                                                                                                                                                                                                                                                           
                                            end if

                                            amortization_used_dist=policy_function_years_of_amortization_index&
                                                (years_left_on_mortgage_index)%vector_transition_integer&
                                                (min(time_period,transition_length),age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            future_housing_status_index_to_use_2=&
                                                policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            if (track_housing_2==0) then
                                            
                                                if (future_housing_status_index_to_use_2>second_lowest_housing_grid_point) then
                                                
                                                    future_housing_status_index_to_use_2=0
                                                    
                                                end if
                                                
                                            end if
                                            
                                            is_homeless_2=1
                                            
                                            if (future_housing_status_index_to_use_2==lowest_housing_grid_point) then
                                            
                                                is_homeless_2=2
                                            
                                            end if
                                            
                                            call compute_voucher_index_1(is_homeless_2,voucher_index_1)
                                            
                                            call calculate_future_voucher_index_and_opportunity&
                                                (has_opportunity_2,first_voucher_index_1,second_voucher_index_1,&
                                                time_period,has_house,choose_to_own,voucher_index_1,income_to_use_4)
                                                
                                            addiction_choice_1=&
                                                policy_function_addiction(years_left_on_mortgage_index)%&
                                                vector_transition_integer(time_period,age_index,financial_index,&
                                                unemployment_index,employment_index,housing_status_index,voucher_index)
                                                
                                            is_addicted_1=0                                                
                                            loop_over_addiction_2=0
                                                                                                                                                                                   
                                            if (unemployment_index>threshold_addiction_index) then
                                            
                                                is_addicted_1=1
                                                loop_over_addiction_2=1
                                                
                                            elseif ((addiction_choice_1==1) .AND. &
                                                (unemployment_index<=threshold_addiction_index) .AND. &
                                                (include_probability_of_becoming_addicted==1)) then
                                                
                                                loop_over_addiction_2=1
                                                
                                            end if
                                                         
                                            ! Either the household is at the age and addiction status of interest and do not start as homeless, 
                                            ! and then chooe to be homeless 
                                            ! or they are older, and are starting as homeless and also choose to be homeless
                                            if (((age_index==age_index_1) .AND. &
                                                (is_homeless_2==2) .AND. (is_addicted_1>=addiction_lower_bound) .AND. &
                                                (is_addicted_1<=addiction_upper_bound) .AND. &
                                                (housing_status_index>lowest_housing_grid_point)) .OR. &
                                                ((age_index>age_index_1) .AND. (is_homeless_2==2) .AND. &
                                                (housing_status_index==lowest_housing_grid_point))) then
                                                                                                                                
                                                do future_addiction_index_2=&
                                                    (1-loop_over_addiction_2)*addiction_choice_1+loop_over_addiction_2*0,&
                                                    (1-loop_over_addiction_2)*addiction_choice_1+&
                                                    loop_over_addiction_2*include_addiction
                                                    
                                                    check_2=0
                                                    
                                                    if (future_addiction_index_2==1) then
                                                    
                                                        check_2=1
                                                        
                                                    end if
                                                
                                                    do future_unemployment_index=include_addiction*&
                                                        ((1-check_2)*1+check_2*(threshold_addiction_index+1))+&
                                                        (1-include_addiction)*(at_least_one_period_before_retirement*&
                                                        (one_period_before_death*1+(1-one_period_before_death)*unemployment_index)+&
                                                        (1-at_least_one_period_before_retirement)*1),include_addiction*&
                                                        ((1-check_2)*threshold_addiction_index+check_2*unemployment_grid_size)+&
                                                        (1-include_addiction)*(at_least_one_period_before_retirement*&
                                                        (one_period_before_death*unemployment_grid_size+&
                                                        (1-one_period_before_death)*unemployment_index)+&
                                                        (1-at_least_one_period_before_retirement)*unemployment_grid_size)
                                                                                     
                                                        do future_employment_index=&
                                                            at_least_one_period_before_retirement*employment_index+&
                                                            (1-at_least_one_period_before_retirement)*1,&
                                                            at_least_one_period_before_retirement*employment_index+&
                                                            (1-at_least_one_period_before_retirement)*employment_grid_size

                                                            do future_voucher_index=first_voucher_index_1,second_voucher_index_1
                                                                                                        
                                                                distribution_forward(amortization_used_dist)%&
                                                                    vector_transition_real(time_period,&
                                                                    age_index+1,financial_index_copy,&
                                                                    future_unemployment_index,future_employment_index,&
                                                                    future_housing_status_index_to_use_2,future_voucher_index)=&
                                                                    fraction_copy*survival_probability&
                                                                    (age_index,is_homeless_2,is_addicted_1)*&
                                                                    voucher_probabilities(voucher_index,&
                                                                    future_voucher_index,has_opportunity_2,voucher_index_1)*&
                                                                    employment_process(age_index,employment_index,&
                                                                    future_employment_index)*unemployment_process&
                                                                    (age_index,unemployment_index,future_unemployment_index,&
                                                                    is_homeless_2,future_addiction_index_2,employment_index)*&
                                                                    addiction_probabilities(is_addicted_1,&
                                                                    future_addiction_index_2,addiction_choice_1,is_homeless_2)*&
                                                                    distribution_forward(years_left_on_mortgage_index)%&
                                                                    vector_transition_real(time_period-solve_transition_dynamics,&
                                                                    age_index,financial_index,unemployment_index,employment_index,&
                                                                    housing_status_index,voucher_index)+&
                                                                    distribution_forward(amortization_used_dist)%&
                                                                    vector_transition_real&
                                                                    (time_period,age_index+1,financial_index_copy,&
                                                                    future_unemployment_index,future_employment_index,&
                                                                    future_housing_status_index_to_use_2,future_voucher_index)
                                                                    
                                                                homelessness_mass_by_age(time_period,age_index)=&
                                                                    homelessness_mass_by_age(time_period,age_index)+&
                                                                    distribution_forward(years_left_on_mortgage_index)%&
                                                                    vector_transition_real(time_period-solve_transition_dynamics,&
                                                                    age_index,financial_index,unemployment_index,employment_index,&
                                                                    housing_status_index,voucher_index)
                                                                                                                                                                            
                                                            end do
                                                        
                                                        end do
                                                        
                                                    end do
                                                                                                
                                                end do
                                                
                                            end if 
                                                                                    
                                        end do
                                        
                                    end do
                                    
                                end do
                                
                            end do
                            
                        end do
                        
                    end do
                    
                end do
                            
                ! computing the mass of homelessness at each future age given the beginning age of age_index_1
                do age_index=life_span,age_index_1+1,-1
                            
                    homelessness_mass_by_age(time_period,age_index-1)=&
                        homelessness_mass_by_age(time_period,age_index-1)-&
                        sum(homelessness_mass_by_age(time_period,age_index:life_span))
                                            
                end do
                
                ! computing the average homelessness duration given they start as not 
                ! homeless and choose to be homelessness at age age_index_1
                do age_index=age_index_1,life_span
                
                    if (sum(homelessness_mass_by_age(time_period,age_index_1:life_span))>0) then
                
                        homelessness_duration(time_period,age_index_1,addiction_index_1)=&
                            homelessness_duration(time_period,age_index_1,addiction_index_1)+&
                            (age_index-(age_index_1-1))*homelessness_mass_by_age(time_period,age_index)/&
                            sum(homelessness_mass_by_age(time_period,age_index_1:life_span))
                        
                    end if
                          
                end do
                                
                ! this computes the average homelessness duration for everyone in a given addiction status of interest
                ! by taking adding the average duration of that age multiplied by the mass of future homeless for that age
                homelessness_duration_everyone(time_period,addiction_index_1)=&
                    homelessness_duration_everyone(time_period,addiction_index_1)+&
                    homelessness_duration(time_period,age_index_1,addiction_index_1)
                    
                ! counting total mass of homeless for all ages for the given addiction stauts of interest
                total_homeless_count(addiction_index_1)=total_homeless_count(addiction_index_1)+&
                    sum(homelessness_mass_by_age(time_period,age_index_1:life_span))
                                   
            end do
            
            if (total_homeless_count(addiction_index_1)>0) then
            
                ! computes the average duration for each addiction case
                homelessness_duration_everyone(time_period,addiction_index_1)=&
                    homelessness_duration_everyone(time_period,addiction_index_1)/&
                    total_homeless_count(addiction_index_1)
                    
            end if
            
        end do
                        
    end subroutine
            
    subroutine function_of_utility_advantage_from_homeowning(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        
        total_constrcution_profits(time_period)=0
        
        if ((is_counterfactual==1) .AND. (solve_transition_dynamics==0)) then
           
            housing_stock(time_period)=(1/housing_depreciation_rate)*(housing_price(time_period)/&
                c_1_calibrated)**(empirical_housing_supplpy_elasticity)
                
            housing_investment(time_period)=(housing_price(time_period)/&
                c_1_calibrated)**(empirical_housing_supplpy_elasticity)
                                                                     
        elseif ((is_counterfactual==1) .AND. (solve_transition_dynamics==1)) then
            
            housing_investment(time_period)=(housing_price(time_period)/&
                c_1_calibrated)**(empirical_housing_supplpy_elasticity)
                                    
        elseif ((is_counterfactual==0)) then
                                    
            c_1=(housing_price(time_period))/(housing_depreciation_rate*&
                total_housing_demand(time_period))**(1/empirical_housing_supplpy_elasticity)
                                                                            
            housing_stock(time_period)=(1/housing_depreciation_rate)*&
                (housing_price(time_period)/c_1)**(empirical_housing_supplpy_elasticity)
                                                
            housing_investment(time_period)=(housing_price(time_period)/c_1)**&
                (empirical_housing_supplpy_elasticity)
            
            housing_investment_value(time_period)=housing_price(time_period)*housing_investment(time_period)
                
            cutoff_housing_investment_bisection(1)=0
            cutoff_housing_investment_bisection(2)=housing_investment(time_period)
            
            distance_cutoff_housing_investment=1
            
            do while (distance_cutoff_housing_investment>stopping_rule_cutoff_housing_investment)
            
                cutoff_housing_investment=&
                    (cutoff_housing_investment_bisection(1)+cutoff_housing_investment_bisection(2))/2
            
                c_min=c_1*(cutoff_housing_investment)**(1/empirical_housing_supplpy_elasticity)
                                
                construction_company_profits(time_period)=0
                construction_company_profits(time_period)=construction_company_profits(time_period)+&
                    (housing_price(time_period)-c_min)*cutoff_housing_investment
                construction_company_profits(time_period)=construction_company_profits(time_period)+&
                    housing_price(time_period)*(housing_investment(time_period)-cutoff_housing_investment)-&
                    ((c_1*(housing_investment(time_period))**((1/empirical_housing_supplpy_elasticity)+1))/&
                    ((1/empirical_housing_supplpy_elasticity)+1)-(c_1*(cutoff_housing_investment)**&
                    ((1/empirical_housing_supplpy_elasticity)+1))/((1/empirical_housing_supplpy_elasticity)+1))
                            
                land_value=construction_company_profits(time_period)
                        
                land_to_housing_stock=land_value/housing_investment_value(time_period)
                
                distance_cutoff_housing_investment=abs(land_to_housing_stock-empirical_land_to_housing_stock)
                
                if (land_to_housing_stock<empirical_land_to_housing_stock) then
        
                    cutoff_housing_investment_bisection(2)=cutoff_housing_investment
        
                else
            
                    cutoff_housing_investment_bisection(1)=cutoff_housing_investment
                
                end if
                
            
            end do
                                        
            total_constrcution_profits(time_period)=total_constrcution_profits(time_period)+&
                construction_company_profits(time_period)
                
            distance_housing_market(time_period)=&
                abs(total_housing_demand(time_period)-housing_stock(time_period))
                                    
        end if
        
        total_constrcution_profits(time_period)=housing_price(time_period)*housing_investment(time_period)-&
            (((1-is_counterfactual)*c_1+is_counterfactual*c_1_calibrated)*&
            (housing_investment(time_period))**((1/empirical_housing_supplpy_elasticity)+1))/&
            ((1/empirical_housing_supplpy_elasticity)+1)
                
        if ((loop_count==0) .AND. (solve_transition_dynamics==0)) then
        
            write(*,*) "total_constrcution_profits(time_period)=", total_constrcution_profits(time_period)
            write(*,*) "c_1=", c_1
            
        end if
        
        if (is_counterfactual==0) then
                                                
            rent(time_period,:)=rent_to_housing_price*housing_price(time_period)
                            
            if (infinite_elasticity_of_rental_supply==1) then
                                                
                rental_management_costs(:)=&
                    rent(time_period,:)+housing_price(time_period)*&
                    ((1-housing_depreciation_rate-property_tax(time_period))/(1+risk_free_rate(time_period))-1)
                                            
            else
            
                rental_management_costs(:)=&
                    (rent(time_period,:)-housing_price(time_period)*&
                    (risk_free_rate(time_period)+housing_depreciation_rate+property_tax(time_period)+&
                    property_tax_on_rental_housing)/&
                    (1+risk_free_rate(time_period)))/((total_rental_demand(time_period,:)**&
                    (convexity_of_rental_company(:)-1))*convexity_of_rental_company(:))
                             
            end if
                        
        elseif (is_counterfactual==1) then
                
            if (infinite_elasticity_of_rental_supply==1) then
                            
                rent(time_period,:)=max(rental_management_costs_calibrated(:)+housing_price(time_period)-&
                    housing_price(time_period-solve_transition_dynamics)*&
                    (1-housing_depreciation_rate-property_tax(time_period-solve_transition_dynamics))/&
                    (1+risk_free_rate(time_period)),0.d0)
                                 
            else
            
                rent(time_period,:)=partial_equilibrium*rent(time_period,:)+&
                    (1-partial_equilibrium)*(weight_on_housing_price*&
                    (convexity_of_rental_company(:)*rental_management_costs_calibrated(:)*&
                    total_rental_demand(time_period,:)**(convexity_of_rental_company(:)-1)+housing_price(time_period)-&
                    (housing_price(time_period-solve_transition_dynamics)*&
                    (1-housing_depreciation_rate-property_tax(time_period-solve_transition_dynamics)-&
                    property_tax_on_rental_housing)/(1+risk_free_rate(time_period))))+(1-weight_on_housing_price)*&
                    rent(time_period,:))
                
            end if
            
        end if
        
        total_rental_company_profits(time_period,:)=0
                           
        if (infinite_elasticity_of_rental_supply==1) then
                                         
        else
                        
            total_rental_company_profits(time_period,:)=total_rental_company_profits(time_period,:)+&
                total_rental_demand(time_period,:)*rent(time_period,:)
                                        
            total_rental_company_profits(time_period,:)=total_rental_company_profits(time_period,:)-&
                (housing_price(time_period)*total_rental_demand(time_period,:)-&
                housing_price(time_period-solve_transition_dynamics)*&
                total_rental_demand(time_period-solve_transition_dynamics,:)*&
                (1-property_tax(time_period-solve_transition_dynamics)-housing_depreciation_rate)+&
                (is_counterfactual*rental_management_costs_calibrated+&
                (1-is_counterfactual)*rental_management_costs)*&
                total_rental_demand(time_period,:)**convexity_of_rental_company(:))
            
        end if
            
!        write(*,*) "total_profits(time_period)=", total_profits(time_period)
!        write(*,*) "total_constrcution_profits(time_period)/(1-alpha_1)=", total_constrcution_profits(time_period)/(1-alpha_1)
!        write(*,*) "total_rental_company_profits(time_period)/(1-alpha_1)=", total_rental_company_profits(time_period)/(1-alpha_1)
!        write(*,*) "risk_free_rate(time_period)=", risk_free_rate(time_period)
                                   
        if (loop_count>=0) then
                        
            housing_size(0)=smallest_house_size
        
            housing_size(housing_status_grid_size-1)=largest_house_size
            
            if (housing_status_grid_size>2) then
                                                   
                do i=1,housing_status_grid_size-1
        
                    housing_status_grid_distance(i)=&
                        i*((housing_size(housing_status_grid_size-1)-housing_size(0))**&
                        (real(1)/housing_status_grid_expander))/(real(housing_status_grid_size)-real(1))
    
                end do
                
                housing_size=housing_size(0)+housing_status_grid_distance**(housing_status_grid_expander)
                
            end if
            
            housing_size(lowest_housing_grid_point)=housing_size(0)*size_homelessness*(1+increase_homeless_size*5)
                        
            open(unit=3,file="housing_status_grid_points"//trim(file_number)//".txt",action="write",status="replace")
                do i=lowest_housing_grid_point,housing_status_grid_size-1
                    write(3,*) housing_size(i)
                end do
            close(3)
        
        end if
        
        if (solve_transition_dynamics==0) then
        
            write(*,*) "size_of_smallest_house_hhld_can_buy=", size_of_smallest_house_hhld_can_buy
            
        end if

        if (calibrate_size_of_smallest_house_hhld_can_buy==1) then 
                    
!            index_of_smallest_house_hhld_can_buy=&
!                minloc((housing_size-size_of_smallest_house_hhld_can_buy),1,&
!                mask=(housing_size-size_of_smallest_house_hhld_can_buy)>0)
!            
!            write(*,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy
!            
!            index_of_smallest_house_hhld_can_buy_minus_one=&
!                max(index_of_smallest_house_hhld_can_buy-1,lowest_housing_grid_point)
!            
!            size_of_smallest_house_hhld_can_buy=&
!                (housing_size(index_of_smallest_house_hhld_can_buy)+&
!                housing_size(index_of_smallest_house_hhld_can_buy_minus_one))/2
                
!            size_of_smallest_house_hhld_can_buy=0.25
                
            index_of_smallest_house_hhld_can_buy=smallest_index_for_purchase
                
        else
        
            index_of_smallest_house_hhld_can_buy=smallest_index_for_purchase
                
        end if
                
        if ((loop_count<1) .AND. (solve_transition_dynamics==0)) then
        
            write(*,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", & 
                housing_size(index_of_smallest_house_hhld_can_buy)
            write(*,*) "size_of_smallest_house_hhld_can_buy=", size_of_smallest_house_hhld_can_buy
            write(*,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy
            write(*,*) "smallest_house_size=", smallest_house_size
            write(*,*) "housing_status_grid_expander=", housing_status_grid_expander
        
        end if
        
        do age_index=1,life_span
            
            do housing_status_index=lowest_housing_grid_point,(housing_status_grid_size-1)
            
                if ((use_cobb_douglas==1) .OR. (use_cobb_douglas_2==1)) then
                                                
                    housing_status_utility_function(housing_status_index,:,0,0)=&
                        (housing_size(housing_status_index))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing)
                        
                    housing_status_utility_function(housing_status_index,:,1,0)=&
                        (housing_size(housing_status_index)*(1+advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing)
                        
                    housing_status_utility_function(housing_status_index,:,0,1)=&
                        (housing_size(housing_status_index))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing)
                        
                    housing_status_utility_function(housing_status_index,:,1,1)=&
                        (housing_size(housing_status_index)*(1+advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing)
                        
                elseif (include_probability_of_becoming_addicted==1) then
                                
                    housing_status_utility_function(housing_status_index,:,0,0)=&
                        (housing_size(housing_status_index))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing_1)
                        
                    housing_status_utility_function(housing_status_index,:,1,0)=&
                        (housing_size(housing_status_index)*(1+advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing_1)
                        
                    housing_status_utility_function(housing_status_index,:,0,1)=&
                        (housing_size(housing_status_index))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing_2)
                        
                    housing_status_utility_function(housing_status_index,:,1,1)=&
                        (housing_size(housing_status_index)*(1+advantage_to_owning))**&
                        ((1-risk_aversion_consumption)*relative_share_of_housing_2)
                                      
                else
                
                    housing_status_utility_function(housing_status_index,:,0,0)=&
                        relative_share_of_housing*(housing_size(housing_status_index)/&
                        sqrt_household_size(age_index))**(power_1)
                        
                    housing_status_utility_function(housing_status_index,:,1,0)=&
                        relative_share_of_housing*((housing_size(housing_status_index)*&
                        (1+advantage_to_owning)/sqrt_household_size(age_index)))**(power_1)
                        
                    housing_status_utility_function(housing_status_index,age_index,0,1)=&
                        relative_share_of_housing_2*(housing_size(housing_status_index)/&
                        sqrt_household_size(age_index))**(power_1)
                        
                    housing_status_utility_function(housing_status_index,age_index,1,1)=&
                        relative_share_of_housing_2*((housing_size(housing_status_index)*&
                        (1+advantage_to_owning))/sqrt_household_size(age_index))**(power_1)
                
                end if
                                                        
                if (loop_count<0) then
            
                    do i=0,1
                                    
                        write(*,*) "utility from housing size", housing_size(housing_status_index), " gives utility of ", &
                            housing_status_utility_function(housing_status_index,1,i,0)
                        write(*,*) "housing_status_index=", housing_status_index
                        write(*,*) "ownership_status_index=", i
                    
                    end do
            
                end if
                                      
            end do
                    
        end do
        
    end subroutine
    
    subroutine initialize_variables_and_grids()
    
        use Global_Vars
        
        implicit none
                                        
        do i=1,life_span
        
            scaled_household_size(i)=(sqrt(actual_household_size(i)))**risk_aversion_consumption
            sqrt_household_size(i)=sqrt(actual_household_size(i))
            
            if (loop_count<1) then
            
                write(*,*) "scaled_household_size(i)=", scaled_household_size(i)
                
            end if
            
            survival_probability(i,:,:)=1
        
            do j=i,min(i,life_span)
        
                survival_probability(i,:,:)=survival_probability(i,:,:)*actual_survival_probability(j)
                
            end do
                
        end do
        
        if (life_span<60) then
        
            survival_probability(life_span,:,:)=0
            
            if (loop_count==0) then
            
!                write(*,*) "survival_probability=", survival_probability
                
            end if
        
        end if  
        
        survival_probability(:,2,0)=max(survival_probability(:,1,0)-&
            increased_risk_of_death_homeless*(1-survival_probability(:,1,0)),0.d0)
                    
!        survival_probability(1:life_span-retirement_span,2,0)=&
!            survival_probability(1:life_span-retirement_span,1,0)
        
        if (include_addiction==1) then
        
            survival_probability(:,1,include_addiction)=max(survival_probability(:,1,0)-&
                increased_risk_of_death_addicted*(1-survival_probability(:,1,0)),0.d0)
                                
!            survival_probability(1:life_span-retirement_span,1,include_addiction)=&
!                survival_probability(1:life_span-retirement_span,1,0)
                
            survival_probability(:,2,include_addiction)=max(survival_probability(:,1,0)-&
                increased_risk_of_death_homeless_addicted*(1-survival_probability(:,1,0)),0.d0)
                
!            survival_probability(1:life_span-retirement_span,2,include_addiction)=&
!                survival_probability(1:life_span-retirement_span,1,0)
            
        end if
        
        survival_probability_for_dist_iteration=survival_probability
        
        if (remove_increased_death==1) then
        
            survival_probability_for_dist_iteration(:,2,0)=survival_probability(:,1,0)
            survival_probability_for_dist_iteration(:,1,include_addiction)=survival_probability(:,1,0)
            survival_probability_for_dist_iteration(:,2,include_addiction)=survival_probability(:,1,0)
        
        end if
        
        expected_age_non_addicted=0
        expected_age_homeless=0
        expected_age_addicted=0
        expected_age_homeless_and_addicted=0
        
        do age_index=1,life_span
        
            mass_2(:)=1
        
            do i=1,age_index
            
                if (i==age_index) then
                
                    mass_2(1)=(1-survival_probability(i,1,0))*mass_2(1)
                    mass_2(2)=(1-survival_probability(i,2,0))*mass_2(2)
        
                else
        
                    mass_2(1)=survival_probability(i,1,0)*mass_2(1)
                    mass_2(2)=survival_probability(i,2,0)*mass_2(2)
                    
                end if
                
            end do
                        
            expected_age_non_addicted=expected_age_non_addicted+mass_2(1)*age_index
            expected_age_homeless=expected_age_homeless+mass_2(2)*age_index
        
            if (include_addiction==1) then
        
                do i=1,age_index
                            
                    if (i==age_index) then
                
                        mass_2(3)=(1-survival_probability(i,1,include_addiction))*mass_2(3)
                        mass_2(4)=(1-survival_probability(i,2,include_addiction))*mass_2(4)
            
                    else
            
                        mass_2(3)=survival_probability(i,1,include_addiction)*mass_2(3)
                        mass_2(4)=survival_probability(i,2,include_addiction)*mass_2(4)
                        
                    end if
                    
                end do
                    
                expected_age_addicted=expected_age_addicted+mass_2(3)*age_index                    
                expected_age_homeless_and_addicted=expected_age_homeless_and_addicted+mass_2(4)*age_index
                    
            end if
            
        end do
                                    
        if (have_probablistic_death==0) then
        
            survival_probability=1
            survival_probability(life_span,:,:)=0
            
            if (loop_count==0) then
            
!                write(*,*) "survival_probability=", survival_probability
                
            end if
            
        end if
                
        if (loop_count<1) then
                                    
            do age_index=1,life_span
                
                if (solve_transition_dynamics==0) then
            
                    write(*,*) "survival_probability(",age_index,")=", survival_probability(age_index,1,0)
                    
                end if
                    
            end do

        end if
                
        cohort_population(1)=1
        
        total_population=cohort_population(1)
            
        do i=2,life_span
        
            cohort_population(i)=cohort_population(i-1)*survival_probability(i-1,1,0)
            
            total_population=total_population+cohort_population(i)
            
        end do
        
        if ((solve_transition_dynamics==0) .AND. &
           (loop_count<1)) then
                
            write(*,*) "total population=", total_population
        
        end if
         
        stopping_rule_wealth_dist(1)=0.01
        stopping_rule_wealth_dist(2)=0.1
        stopping_rule_wealth_dist(3)=0.2
        stopping_rule_wealth_dist(4)=0.5
        stopping_rule_wealth_dist(5)=0.9
        stopping_rule_wealth_dist(6)=0.95
        stopping_rule_wealth_dist(7)=0.99
        stopping_rule_wealth_dist(8)=0.99999
        
        stopping_rule_income_dist(1)=0.01
        stopping_rule_income_dist(2)=0.05
        stopping_rule_income_dist(3)=0.1
        stopping_rule_income_dist(4)=0.1
        stopping_rule_income_dist(5)=0.05
        stopping_rule_income_dist(6)=0.01        
        
        stopping_rule_wealth_dist_of_old(1)=0.25
        stopping_rule_wealth_dist_of_old(2)=0.5
        stopping_rule_wealth_dist_of_old(3)=0.75
        
    end subroutine             
            
    subroutine GKKOC_intergenerational_employment_process(time_period)
    
        use Global_Vars
        
        implicit none

        real(8) :: persistence_fixed_employment_newborn=0.5
        real(8) :: s_deviation_top=3
        real(8) :: s_deviation_bottom=3
        real(8) :: sum_of_dist,sum_of_unconditional_unemployment
        integer, intent(in) :: time_period
         
        if (loop_count<1) then

            call KKK_process(persistence_fixed_employment_newborn,sd_fixed_employment_newborn,persistence_employment_surviving,&
                sd_employment_surviving,s_deviation_top,s_deviation_bottom,employment_grid,&
                unconditional_employment_probability,employment_process)
                
!            employment_grid(:,1)=log(0.035)*(employment_grid(:,1)/employment_grid(1,1))  !employment_grid(:,1) ! 1.12
!            employment_grid(:,2)=log(0.02) ! employment_grid(:,2) ! 1.48
!            employment_grid(:,3)=log(0.03) ! employment_grid(:,3) ! 1.68
!            employment_grid(:,4)=employment_grid(:,4)
                                                                                
            call get_probabilities_KKK_process(persistence_fixed_employment_newborn,sd_fixed_employment_newborn,&
                persistence_employment_surviving,sd_employment_surviving,employment_grid,&
                unconditional_employment_probability,employment_process)
                
            employment_grid=exp(employment_grid)
                    
        end if
                                                                                    
        if (loop_count<1) then
        
            write(*,*) "employment_grid"
        
            do i=1,employment_grid_size
                    
                write(*,*) employment_grid(1,i)     
                
            end do
            
            write(*,*) "unconditional_employment_probability"
            
            do i=1,employment_grid_size
            
                write(*,*) unconditional_employment_probability(i)
                
            end do
                        
        end if
        
        unconditional_unemployment_probability(:)=0
        
        if (loop_count<1) then
        
            unconditional_unemployment_probability(1)=1 !0.95155279776391399
            unconditional_unemployment_probability(2)=0 !3.4048867272342742E-002
            unconditional_unemployment_probability(3)=1-sum(unconditional_unemployment_probability(1:2))
            
        else
        
            sum_of_dist=0
                
            do unemployment_index=1,threshold_addiction_index
            
                do i=1,2
                
                    sum_of_dist=sum_of_dist+&
                        sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,unemployment_index,:,:,:))
            
                    unconditional_unemployment_probability(unemployment_index)=&
                        unconditional_unemployment_probability(unemployment_index)+&
                        sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,unemployment_index,:,:,:))
                    
                end do
                            
            end do
            
            unconditional_unemployment_probability(:)=&
                unconditional_unemployment_probability(:)/sum_of_dist
                
            sum_of_unconditional_unemployment=sum(unconditional_unemployment_probability(:))
            
            unconditional_unemployment_probability(:)=&
                unconditional_unemployment_probability(:)*(1/sum_of_unconditional_unemployment)
                
            unconditional_unemployment_probability(1)=1 !0.95155279776391399
            unconditional_unemployment_probability(2)=0 !3.4048867272342742E-002
            unconditional_unemployment_probability(3)=1-sum(unconditional_unemployment_probability(1:2))
                    
        end if
                                     
        if (loop_count<1) then
            
            do employment_index=1,employment_grid_size
                        
                write(*,*) "employment_process(",1,employment_index,")=", employment_process(1,employment_index,:)
                            
            end do
                            
        end if
                
        do age_index=(life_span-retirement_span),life_span
        
            do employment_index=1,employment_grid_size
            
                do future_employment_index=1,employment_grid_size
                
                    if (future_employment_index==employment_index) then
                    
                        employment_process(age_index,employment_index,future_employment_index)=1
                    
                    else
                    
                        employment_process(age_index,employment_index,future_employment_index)=0
                    
                    end if
                    
                end do
                
            end do
            
        end do
        
        call create_unemployment_process()

        if (is_counterfactual==0) then
                   
            standard_deduction=(model_average_labour_income(1)*standard_deduction_as_percent_of_average_labor_income)
                                        
            personal_exemption=(real(personal_exemption_data)/max(real(standard_deduction_data),1.d0))*standard_deduction
                        
        end if
            
        if (loop_count<1) then

            write(*,*) "personal_exemption=", personal_exemption
            write(*,*) "standard_deduction=", standard_deduction
                
        end if
        
        if (loop_count<1) then
                                                                        
            do age_index=1,(life_span-retirement_span)
            
                if (use_GKKOC_deterministic_process==1) then
                
                    labour_deterministic_efficiency(age_index)=&
                        exp(-((real(age_index)-1.d0)**2.d0)/1800.d0+(real(age_index)-1.d0)/30.d0)
                                                    
                else
            
                    if (age_index<=life_span-retirement_span-10) then
                
                        labour_deterministic_efficiency(age_index)=(1+life_cycle_component_a*(age_index-1))
                            
                    else
                    
                        labour_deterministic_efficiency(age_index)=labour_deterministic_efficiency(life_span-retirement_span-10)-&
                            life_cycle_component_b*(age_index-(life_span-retirement_span-10))
                    
                    end if
                    
                end if
                    
                if (loop_count<1) then
                
                    if (solve_transition_dynamics==0) then
                                
!                        write(*,*) "labour efficiency=", labour_deterministic_efficiency(age_index)
!                        write(*,*) "age_index=", age_index
                        
                    end if
                    
                end if
                
            end do
                
            labour_deterministic_efficiency((life_span-retirement_span)+1:life_span)=0
            
        end if
    
    end subroutine
    
    subroutine create_unemployment_process()
    
        use global_vars
        
        integer :: cutoff_age_1,cutoff_age_2
        real(8), parameter :: increased_prob_if_homeless=0.2,increased_prob_to_be_addicted=0
        
        if (include_vouchers==0) then
        
            voucher_probabilities(0,0,0,:)=1
        
        else
        
            ! from getting a voucher to not when income goes above the threshold
            voucher_probabilities(1,0,0,:)=1
            
            ! from getting a voucher to keeping it if income is below threshold
            voucher_probabilities(1,1,1,:)=1
            
            if (increased_prob_of_voucher_if_homeless_and_addicted==0) then
            
                ! from getting a voucher to not when income is below threshold and is addicted
                voucher_probabilities(1,0,1,3)=1
                
                ! from getting a voucher to getting it when income is below threshold and is addicted
                voucher_probabilities(1,1,1,3)=0
                
                ! from not getting a voucher to getting it when income is below threshold and is addicted 
                voucher_probabilities(0,1,1,3)=0
                
                ! from not getting a voucher to not getting it when income is below threshold and is addicted
                voucher_probabilities(0,0,1,3)=1
                
            end if
            
            ! from not getting a voucher to not getting one when income is above threhsold
            voucher_probabilities(0,0,0,:)=1
            
            ! from not getting a voucher to potentially get one (if income is below the threshold)
            voucher_probabilities(0,1,1,:)=&
                (/real(probability_of_voucher_benchmark_used_1),&
                min(real(probability_of_voucher_benchmark_used_1*increased_prob_of_voucher_if_homeless_1),1.0),&
                min(real(probability_of_voucher_benchmark_used_1*increased_prob_of_voucher_if_homeless_and_addicted),1.0)/)
                
            voucher_probabilities(0,0,1,:)=(1-voucher_probabilities(0,1,1,:))
            
        end if
        
        if (is_counterfactual==1) then
        
            open(unit=23,file="voucher_probabilities_benchmark"//trim(benchmark_simulation)//".dat",action='read')
                read(23,'((F35.13))') voucher_probabilities_benchmark
            close(23)
            
        else
        
            voucher_probabilities_benchmark=voucher_probabilities
            
            ! from getting a voucher to not if addicted when income is below threshold
            voucher_probabilities_benchmark(1,0,1,3)=0
            
            ! from getting a voucher to getting it if addicted when income is below threshold
            voucher_probabilities_benchmark(1,1,1,3)=1
                    
            voucher_probabilities_benchmark(0,1,1,:)=probability_of_voucher_benchmark
            voucher_probabilities_benchmark(0,0,1,:)=(1-voucher_probabilities_benchmark(0,1,1,:))
            
        end if
            
        addiction_probabilities=0
        addiction_probabilities(0,0,:,:)=1
        
        if (include_probability_of_becoming_addicted==1) then
        
            if (include_addiction==1) then
        
                addiction_probabilities(0,include_addiction,1,:)=probability_of_becoming_addicted_if_experiment
                addiction_probabilities(0,0,1,:)=1-probability_of_becoming_addicted_if_experiment
                
            else
            
                addiction_probabilities(0,0,:,:)=1
            
            end if
        
        else
        
            addiction_probabilities(0,include_addiction,:,:)=1
            
        end if
            
        if (include_addiction==1) then
            
            addiction_probabilities(include_addiction,0,:,1)=probability_of_stopping_addiction
            addiction_probabilities(include_addiction,include_addiction,:,1)=1-probability_of_stopping_addiction        
            
            addiction_probabilities(include_addiction,0,:,2)=probability_of_stopping_addiction_if_homeless
            addiction_probabilities(include_addiction,include_addiction,:,2)=1-probability_of_stopping_addiction_if_homeless    
            
        end if
        
        addiction_probabilities_percieved=addiction_probabilities
        
        if (include_addiction==1) then
        
            addiction_probabilities_percieved(0,include_addiction,1,:)=&
                addiction_probabilities_percieved(0,include_addiction,1,:)*&
                difference_in_perceived_of_becoming_addicted_if_experiment
                
            addiction_probabilities_percieved(0,0,1,:)=1-addiction_probabilities_percieved(0,include_addiction,1,:)
            
        end if        

        call adjusting_unemployment_probabilities_based_on_productivity(adjusted_probability)
                        
        unemployment_process=0
        
        if (include_addiction==0) then
        
            cutoff_age_1=life_span-retirement_span-1
        
            unemployment_process(1:cutoff_age_1,1,2,1,0,:)=probability_becoming_unemployed*(1-probability_of_ui)
            unemployment_process(1:cutoff_age_1,1,2,2,0,:)=probability_becoming_unemployed*(1-probability_of_ui)*&
                (1+increased_prob_if_homeless)
            
            unemployment_process(1:cutoff_age_1,1,3,1,0,:)=probability_becoming_unemployed*probability_of_ui
            unemployment_process(1:cutoff_age_1,1,3,2,0,:)=probability_becoming_unemployed*probability_of_ui*&
                (1+increased_prob_if_homeless)
                
            do employment_index=1,employment_grid_size
            
                unemployment_process(1:cutoff_age_1,1,1,1,0,employment_index)=&
                    1-sum(unemployment_process(1,1,2:3,1,0,employment_index))
                    
                unemployment_process(1:cutoff_age_1,1,1,2,0,employment_index)=&
                    1-sum(unemployment_process(1,1,2:3,2,0,employment_index))
                    
            end do
        
            unemployment_process(1:cutoff_age_1,2,1,1,0,:)=probability_becoming_employed
            unemployment_process(1:cutoff_age_1,2,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            unemployment_process(1:cutoff_age_1,2,2,1,0,:)=1-probability_becoming_employed
            unemployment_process(1:cutoff_age_1,2,2,2,0,:)=1-probability_becoming_employed1/(1+increased_prob_if_homeless)
            
            unemployment_process(1:cutoff_age_1,3,1,1,0,:)=probability_becoming_employed
            unemployment_process(1:cutoff_age_1,3,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            unemployment_process(1:cutoff_age_1,3,3,1,0,:)=1-probability_becoming_employed
            unemployment_process(1:cutoff_age_1,3,3,2,0,:)=1-probability_becoming_employed/(1+increased_prob_if_homeless)
                        
            cutoff_age_2=life_span-1
                        
            do age_index=cutoff_age_1+1,cutoff_age_2
            
                do unemployment_index=1,unemployment_grid_size
            
                    unemployment_process(age_index,unemployment_index,unemployment_index,:,0,:)=1
                                        
                end do
                
            end do
                                        
            cutoff_age_2=life_span
            
            unemployment_process(cutoff_age_2,1,2,1,0,:)=probability_becoming_unemployed*(1-probability_of_ui)
            unemployment_process(cutoff_age_2,1,2,2,0,:)=probability_becoming_unemployed*(1-probability_of_ui)*&
                (1+increased_prob_if_homeless)
            
            unemployment_process(cutoff_age_2,1,3,1,0,:)=probability_becoming_unemployed*probability_of_ui
            unemployment_process(cutoff_age_2,1,3,2,0,:)=probability_becoming_unemployed*probability_of_ui*&
                (1+increased_prob_if_homeless)
                
            do employment_index=1,employment_grid_size
            
                unemployment_process(cutoff_age_2,1,1,1,0,employment_index)=&
                    1-sum(unemployment_process(1,1,2:3,1,0,employment_index))
                    
                unemployment_process(cutoff_age_2,1,1,2,0,employment_index)=&
                    1-sum(unemployment_process(1,1,2:3,2,0,employment_index))
                
            end do
            
            unemployment_process(cutoff_age_2,2,1,1,0,:)=probability_becoming_employed
            unemployment_process(cutoff_age_2,2,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            unemployment_process(cutoff_age_2,2,2,1,0,:)=1-probability_becoming_employed
            unemployment_process(cutoff_age_2,2,2,2,0,:)=1-probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(cutoff_age_2,3,1,1,0,:)=probability_becoming_employed
            unemployment_process(cutoff_age_2,3,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            unemployment_process(cutoff_age_2,3,3,1,0,:)=1-probability_becoming_employed
            unemployment_process(cutoff_age_2,3,3,2,0,:)=1-probability_becoming_employed/(1+increased_prob_if_homeless)
                        
        else
            
            do employment_index=1,employment_grid_size
                    
                unemployment_process(:,1,2,1,0,employment_index)=&
                    probability_becoming_unemployed*(1-probability_of_ui)*adjusted_probability(employment_index)
                    
                unemployment_process(:,1,2,2,0,employment_index)=probability_becoming_unemployed*(1-probability_of_ui)*&
                    (1+increased_prob_if_homeless)*adjusted_probability(employment_index)
            
                unemployment_process(:,1,3,1,0,employment_index)=probability_becoming_unemployed*probability_of_ui*&
                    adjusted_probability(employment_index)
                    
                unemployment_process(:,1,3,2,0,employment_index)=probability_becoming_unemployed*probability_of_ui*&
                    (1+increased_prob_if_homeless)*adjusted_probability(employment_index)
                    
                unemployment_process(:,1,1,1,0,employment_index)=1-sum(unemployment_process(1,1,2:3,1,0,employment_index))
                unemployment_process(:,1,1,2,0,employment_index)=1-sum(unemployment_process(1,1,2:3,2,0,employment_index))
                
            end do
                                        
            unemployment_process(:,3,1,1,0,:)=probability_becoming_employed
            unemployment_process(:,3,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(:,3,3,1,0,:)=(1-probability_becoming_employed)
            unemployment_process(:,3,3,2,0,:)=1-probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(:,2,1,1,0,:)=probability_becoming_employed
            unemployment_process(:,2,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(:,2,2,1,0,:)=(1-probability_becoming_employed)
            unemployment_process(:,2,2,2,0,:)=1-probability_becoming_employed/(1+increased_prob_if_homeless)
                
            unemployment_process(:,4,5,1,1,:)=probability_becoming_unemployed_if_addicted*(1-probability_of_ui)
            unemployment_process(:,4,5,2,1,:)=probability_becoming_unemployed_if_addicted*(1-probability_of_ui)*&
                (1+increased_prob_if_homeless)
                
            unemployment_process(:,4,6,1,1,:)=probability_becoming_unemployed_if_addicted*probability_of_ui
            unemployment_process(:,4,6,2,1,:)=probability_becoming_unemployed_if_addicted*probability_of_ui*&
                (1+increased_prob_if_homeless)
                
            do employment_index=1,employment_grid_size

                unemployment_process(:,4,4,1,1,employment_index)=1-sum(unemployment_process(1,4,5:6,1,1,employment_index))
                unemployment_process(:,4,4,2,1,employment_index)=1-sum(unemployment_process(1,4,5:6,2,1,employment_index))
                
            end do
                        
            unemployment_process(:,6,4,1,1,:)=probability_becoming_employed_if_addicted
            unemployment_process(:,6,4,2,1,:)=probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless)
            
            unemployment_process(:,6,6,1,1,:)=(1-probability_becoming_employed_if_addicted)
            unemployment_process(:,6,6,2,1,:)=1-probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless)
            
            unemployment_process(:,5,4,1,1,:)=probability_becoming_employed_if_addicted
            unemployment_process(:,5,4,2,1,:)=probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless)
            
            unemployment_process(:,5,5,1,1,:)=(1-probability_becoming_employed_if_addicted)
            unemployment_process(:,5,5,2,1,:)=1-probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless)
            
            !!! transition between states of addiction
            !!! this one moves from no addiction to addiction
            do employment_index=1,employment_grid_size
                            
                unemployment_process(:,1,5,1,1,employment_index)=&
                    probability_becoming_unemployed_if_addicted*(1-probability_of_ui)*adjusted_probability(employment_index)
                    
                unemployment_process(:,1,5,2,1,employment_index)=&
                    probability_becoming_unemployed_if_addicted*(1-probability_of_ui)*(1+increased_prob_if_homeless)*&
                    adjusted_probability(employment_index)
                    
                unemployment_process(:,1,6,1,1,employment_index)=&
                    probability_becoming_unemployed_if_addicted*probability_of_ui*adjusted_probability(employment_index)
                
                unemployment_process(:,1,6,2,1,employment_index)=&
                    probability_becoming_unemployed_if_addicted*probability_of_ui*&
                    (1+increased_prob_if_homeless)*adjusted_probability(employment_index)
                                        
                unemployment_process(:,1,4,1,1,employment_index)=1-sum(unemployment_process(1,1,5:6,1,1,employment_index))
                unemployment_process(:,1,4,2,1,employment_index)=1-sum(unemployment_process(1,1,5:6,2,1,employment_index))
                    
            end do
                
            unemployment_process(:,2,4,1,1,:)=probability_becoming_employed_if_addicted
            unemployment_process(:,2,4,2,1,:)=probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless)
                
            unemployment_process(:,2,5,1,1,:)=(1-probability_becoming_employed_if_addicted)
            unemployment_process(:,2,5,2,1,:)=(1-probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless))
            
            unemployment_process(:,3,6,1,1,:)=(1-probability_becoming_employed_if_addicted)
            unemployment_process(:,3,6,2,1,:)=(1-probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless))
            
            unemployment_process(:,3,4,1,1,:)=probability_becoming_employed_if_addicted
            unemployment_process(:,3,4,2,1,:)=probability_becoming_employed_if_addicted/(1+increased_prob_if_homeless)
            
            do employment_index=1,employment_grid_size
            
                !! this one moves from addiction to no addiction
                unemployment_process(:,4,2,1,0,employment_index)=&
                    probability_becoming_unemployed*(1-probability_of_ui)*adjusted_probability(employment_index)
                    
                unemployment_process(:,4,2,2,0,employment_index)=probability_becoming_unemployed*(1-probability_of_ui)*&
                    (1+increased_prob_if_homeless)*adjusted_probability(employment_index)
                
                unemployment_process(:,4,3,1,0,employment_index)=&
                    probability_becoming_unemployed*probability_of_ui*adjusted_probability(employment_index)
                
                unemployment_process(:,4,3,2,0,employment_index)=&
                    probability_becoming_unemployed*probability_of_ui*(1+increased_prob_if_homeless)*&
                    adjusted_probability(employment_index)
            
                unemployment_process(:,4,1,1,0,employment_index)=1-sum(unemployment_process(1,4,2:3,1,0,employment_index))
                unemployment_process(:,4,1,2,0,employment_index)=1-sum(unemployment_process(1,4,2:3,2,0,employment_index))
                                
            end do
            
            unemployment_process(:,6,1,1,0,:)=probability_becoming_employed
            unemployment_process(:,6,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(:,6,3,1,0,:)=(1-probability_becoming_employed)
            unemployment_process(:,6,3,2,0,:)=1-probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(:,5,1,1,0,:)=probability_becoming_employed
            unemployment_process(:,5,1,2,0,:)=probability_becoming_employed/(1+increased_prob_if_homeless)
            
            unemployment_process(:,5,2,1,0,:)=(1-probability_becoming_employed)
            unemployment_process(:,5,2,2,0,:)=(1-probability_becoming_employed/(1+increased_prob_if_homeless))
                       
        end if
               
        if (loop_count<1) then
                
!            do unemployment_index=1,unemployment_grid_size
!            
!                do future_unemployment_index=1,unemployment_grid_size
!                
!                    do i=1,2
!                    
!                        do j=0,include_addiction
!                
!                            write(*,*) "unemployment_process", unemployment_index, " to ", future_unemployment_index,"=",&
!                                unemployment_process(1,unemployment_index,future_unemployment_index,i,j)
!                                
!                        end do
!                            
!                    end do
!                
!                end do
!                
!            end do
            
            do unemployment_index=1,threshold_addiction_index
                                        
                do i=1,2
                
                    do j=0,0
                    
                        do employment_index=1,employment_grid_size
                            
!                            write(*,*) "sum(unemployment_process)1", unemployment_index,"=",&
!                                sum(unemployment_process(1,unemployment_index,1:threshold_addiction_index,i,j,employment_index))
                                
                        end do
                        
                    end do
                        
                end do
                        
            end do
            
            do unemployment_index=threshold_addiction_index+1,unemployment_grid_size
                            
                do i=1,2
                
                    do j=0,0
                    
                        do employment_index=1,employment_grid_size
            
!                            write(*,*) "sum(unemployment_process)2", unemployment_index,"=",&
!                                sum(unemployment_process(1,unemployment_index,1:threshold_addiction_index,i,j,employment_index))
                                
                        end do
                            
                    end do
                        
                end do
                        
            end do

            do unemployment_index=threshold_addiction_index+1,unemployment_grid_size
                            
                do i=1,2
                
                    do j=1,include_addiction
                    
                        do employment_index=1,employment_grid_size
            
!                            write(*,*) "sum(unemployment_process)3", unemployment_index,"=",&
!                                sum(unemployment_process&
!                                    (1,unemployment_index,threshold_addiction_index+1:unemployment_grid_size,&
!                                    i,j,employment_index))
                                    
                        end do
                        
                    end do
                        
                end do
                        
            end do
            
            do unemployment_index=1,threshold_addiction_index
                            
                do i=1,2
                
                    do j=include_addiction,include_addiction
                    
                        do employment_index=1,employment_grid_size
            
!                            write(*,*) "sum(unemployment_process)4", unemployment_index,",",employment_index,"=",&
!                                sum(unemployment_process&
!                                    (1,unemployment_index,threshold_addiction_index+1:unemployment_grid_size,&
!                                    i,j,employment_index))
                                    
                        end do
                        
                    end do
                        
                end do
                        
            end do
!            
!            do unemployment_index=1,unemployment_grid_size
!                            
!                do i=1,2
!                
!                    do j=0,include_addiction
!            
!                        write(*,*) "sum(unemployment_process)", unemployment_index,"=",&
!                            sum(unemployment_process(life_span,unemployment_index,:,i,j))
!                            
!                    end do
!                        
!                end do
!                        
!            end do
        
        end if
        
    end subroutine
    
    subroutine adjusting_unemployment_probabilities_based_on_productivity(adjusted_probability_1)
    
        use Global_Vars
        
        implicit none
        
        real(8), dimension(employment_grid_size), intent(out) :: adjusted_probability_1
        
        do i=1,employment_grid_size
        
            adjusted_probability_1(i)=(real(2*employment_grid_size)-real(2*i))/(real(2*employment_grid_size)-real(2*5))
            
        end do
        
        adjusted_probability_1=1
                
    end subroutine
    
    subroutine KKK_process(rho_fixed,sigma_fixed,rho_shock,sigma_shock,s_deviation_top,s_deviation_bottom,&
        z_grid_by_age,unconditional_probability_distribution,transition_prob_by_age)
        
        use Global_Vars
        
        implicit none
        
        real(8), intent(in) :: s_deviation_top,s_deviation_bottom
        real(8), intent(in) :: rho_fixed,rho_shock,sigma_fixed,sigma_shock
        real(8) :: variance_1,variance_eta,variance_fix
        real(8), dimension(life_span-retirement_span) :: variance_by_age
        real(8), dimension(life_span,employment_grid_size), intent(out) :: z_grid_by_age
        real(8), dimension(life_span,employment_grid_size,employment_grid_size), intent(out) :: transition_prob_by_age
        real(8), dimension(life_span-retirement_span,employment_grid_size) :: probability_distribution
        real(8), dimension(employment_grid_size), intent(out) :: unconditional_probability_distribution
        real(8), dimension(life_span-retirement_span) :: width
        real(8) :: temp_upper,temp_lower
                
        variance_1=sigma_fixed**2
        variance_eta=sigma_shock**2
        variance_fix=variance_1/(1-rho_fixed**(2))
        
        variance_by_age(1)=variance_eta+variance_fix
        
        do i=2,life_span-retirement_span
        
            variance_by_age(i)=(rho_shock**2)*variance_by_age(i-1)+variance_eta
            
        end do
                
        do i=1,life_span-retirement_span
        
            z_grid_by_age(i,1)=-s_deviation_bottom*sqrt(variance_by_age(i))
            z_grid_by_age(i,employment_grid_size)=s_deviation_top*sqrt(variance_by_age(i))
            
            width(i)=(z_grid_by_age(i,employment_grid_size)-z_grid_by_age(i,1))/(employment_grid_size-1)
            
            do j=2,employment_grid_size-1
            
                z_grid_by_age(i,j)=z_grid_by_age(i,1)+width(i)*(j-1)
                
            end do
                        
        end do
        
        do i=1,life_span-retirement_span-1
        
            do j=1,employment_grid_size
            
                transition_prob_by_age(i,j,1)=&
                    (1+erf(((z_grid_by_age(i+1,1)+0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/sqrt(variance_eta))/sqrt(2.d0)))/2
                
                do k=2,employment_grid_size-1
               
                    temp_upper=(1+erf(((z_grid_by_age(i+1,k)+0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/&
                        sqrt(variance_eta))/sqrt(2.d0)))/2                    
                    temp_lower=(1+erf(((z_grid_by_age(i+1,k)-0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/&
                        sqrt(variance_eta))/sqrt(2.d0)))/2
                    
                    transition_prob_by_age(i,j,k)=temp_upper-temp_lower
                    
                end do
                
                transition_prob_by_age(i,j,employment_grid_size)=&
                    1-(1+erf(((z_grid_by_age(i+1,employment_grid_size)-0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/&
                    sqrt(variance_eta))/sqrt(2.d0)))/2
                
                transition_prob_by_age(i,j,:)=transition_prob_by_age(i,j,:)/sum(transition_prob_by_age(i,j,:))
                    
            end do
            
        end do
                
        transition_prob_by_age(life_span-retirement_span,:,:)=0
        
        do i=1,employment_grid_size
                
            transition_prob_by_age(life_span-retirement_span,i,i)=1
            
        end do
        
        do j=life_span-retirement_span+1,life_span
        
            transition_prob_by_age(j,:,:)=transition_prob_by_age(life_span-retirement_span,:,:)
            
        end do
                
        probability_distribution(1,1)=(1+erf(((z_grid_by_age(1,1)+0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
        
        do j=2,employment_grid_size-1
        
            temp_upper=(1+erf(((z_grid_by_age(1,j)+0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
            temp_lower=(1+erf(((z_grid_by_age(1,j)-0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
            probability_distribution(1,j)=temp_upper-temp_lower
            
        end do
        
        probability_distribution(1,employment_grid_size)=&
            1-(1+erf(((z_grid_by_age(1,employment_grid_size)-&
            0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
            
        probability_distribution(1,:)=probability_distribution(1,:)/sum(probability_distribution(1,:))
        
        unconditional_employment_probability=probability_distribution(1,:)
                
    end subroutine
    
    subroutine get_probabilities_KKK_process(rho_fixed,sigma_fixed,rho_shock,sigma_shock,&
        z_grid_by_age,unconditional_probability_distribution,transition_prob_by_age)
        
        use Global_Vars
        
        implicit none
        
        real(8), intent(in) :: rho_fixed,rho_shock,sigma_fixed,sigma_shock
        real(8) :: variance_1,variance_eta,variance_fix
        real(8), dimension(life_span-retirement_span) :: variance_by_age
        real(8), dimension(life_span,employment_grid_size), intent(in) :: z_grid_by_age
        real(8), dimension(life_span,employment_grid_size,employment_grid_size), intent(out) :: transition_prob_by_age
        real(8), dimension(life_span-retirement_span,employment_grid_size) :: probability_distribution
        real(8), dimension(employment_grid_size), intent(out) :: unconditional_probability_distribution
        real(8), dimension(life_span-retirement_span) :: width
        real(8) :: temp_upper,temp_lower
                
        variance_1=sigma_fixed**2
        variance_eta=sigma_shock**2
        variance_fix=variance_1/(1-rho_fixed**(2))
        
        variance_by_age(1)=variance_eta+variance_fix
        
        do i=2,life_span-retirement_span
        
            variance_by_age(i)=(rho_shock**2)*variance_by_age(i-1)+variance_eta
            
        end do
                        
        do i=1,life_span-retirement_span-1
        
            do j=1,employment_grid_size
            
                transition_prob_by_age(i,j,1)=&
                    (1+erf(((z_grid_by_age(i+1,1)+0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/sqrt(variance_eta))/sqrt(2.d0)))/2
                
                do k=2,employment_grid_size-1
               
                    temp_upper=(1+erf(((z_grid_by_age(i+1,k)+0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/&
                        sqrt(variance_eta))/sqrt(2.d0)))/2                    
                    temp_lower=(1+erf(((z_grid_by_age(i+1,k)-0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/&
                        sqrt(variance_eta))/sqrt(2.d0)))/2
                    
                    transition_prob_by_age(i,j,k)=temp_upper-temp_lower
                    
                end do
                
                transition_prob_by_age(i,j,employment_grid_size)=&
                    1-(1+erf(((z_grid_by_age(i+1,employment_grid_size)-0.5*width(i+1)-rho_shock*z_grid_by_age(i,j))/&
                    sqrt(variance_eta))/sqrt(2.d0)))/2
                
                transition_prob_by_age(i,j,:)=transition_prob_by_age(i,j,:)/sum(transition_prob_by_age(i,j,:))
                    
            end do
            
        end do
                
        transition_prob_by_age(life_span-retirement_span,:,:)=0
        
        do i=1,employment_grid_size
                
            transition_prob_by_age(life_span-retirement_span,i,i)=1
            
        end do
        
        do j=life_span-retirement_span+1,life_span
        
            transition_prob_by_age(j,:,:)=transition_prob_by_age(life_span-retirement_span,:,:)
            
        end do
                
        probability_distribution(1,1)=(1+erf(((z_grid_by_age(1,1)+0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
        
        do j=2,employment_grid_size-1
        
            temp_upper=(1+erf(((z_grid_by_age(1,j)+0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
            temp_lower=(1+erf(((z_grid_by_age(1,j)-0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
            probability_distribution(1,j)=temp_upper-temp_lower
            
        end do
        
        probability_distribution(1,employment_grid_size)=&
            1-(1+erf(((z_grid_by_age(1,employment_grid_size)-&
            0.5*width(1))/sqrt(variance_by_age(1)))/sqrt(2.d0)))/2
            
        probability_distribution(1,:)=probability_distribution(1,:)/sum(probability_distribution(1,:))
        
        unconditional_employment_probability=probability_distribution(1,:)
                
    end subroutine
    
    subroutine tauchen_method(mu,rho,sigma,s_deviation_top,s_deviation_bottom,number_of_grids,z_grid,probability_matrix)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: number_of_grids
        real(8), intent(in) :: s_deviation_top,s_deviation_bottom
        real(8), dimension(number_of_grids-1) :: mid_points
        real(8), dimension(1,number_of_grids), intent(out) :: z_grid
        real(8), dimension(number_of_grids,number_of_grids),intent(out) :: probability_matrix
        real(8), intent(in) :: mu,rho,sigma
        real(8) :: sigma_1
        
        write(*,*) "s_deviation_bottom=", s_deviation_bottom
                
        sigma_1=sigma/sqrt(1-rho**2)
                
        z_grid(1,1)=mu-s_deviation_bottom*sigma_1
        z_grid(number_of_grids,1)=mu+s_deviation_top*sigma_1
        
        do i=2,number_of_grids-1
        
            z_grid(1,i)=z_grid(1,1)+((z_grid(1,number_of_grids)-z_grid(1,1))/(number_of_grids-1))*(i-1)
            
        end do
                                
        do i=1,number_of_grids-1
        
            mid_points(i)=(z_grid(1,i+1)+z_grid(1,i))/2
                        
        end do
        
        do i=1,number_of_grids
        
            probability_matrix(i,1)=(1+ERF(((mid_points(1)-mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2
            probability_matrix(i,number_of_grids)=1-(1+ERF(((mid_points(number_of_grids-1)-&
                mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2
            
            do j=2,number_of_grids-1
            
                probability_matrix(i,j)=(1+ERF(((mid_points(j)-mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2-&
                    (1+ERF(((mid_points(j-1)-mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2
            
            end do   
            
        end do
    
    end subroutine
    
    subroutine calculate_updated_inheritance_amounts(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        real(8) :: distribution_used,bequests_less_initial_endowments
                
        total_population_group_1(:)=0
        
        do years_left_on_mortgage_index=1,max_amortization_years
        
            do i=1,number_of_inheritance_ages
                                                                                                                    
                distribution_used=&
                    sum(distribution_stationary(years_left_on_mortgage_index)%vector_transition_real&
                    (time_period,inheritance_age_grid(i),:,:,:,:,:))
                    
                total_population_group_1(i)=total_population_group_1(i)+distribution_used
                                                                                                   
            end do
            
        end do
        
!        write(*,*) "inheritance_amount 1=", inheritance_amount
        
        bequests_less_initial_endowments=model_bequests(time_period)-value_of_initial_assets
                    
        do i=1,number_of_inheritance_ages
        
            inheritance_amount(i)=proportion_of_inheritance_per_group(i)*&
                 (bequests_less_initial_endowments/total_population_group_1(i))
                 
        end do
                         
!        write(*,*) "inheritance_amount 2=", inheritance_amount
                               
    end subroutine
    
    subroutine probabilities_given_grid_tauchen(mu,rho,sigma,number_of_grids,z_grid,probability_matrix)
    
        use Global_Vars
        
        implicit none
        
        integer :: number_of_grids
        real(8), dimension(number_of_grids-1) :: mid_points
        real(8), dimension(1,number_of_grids) :: z_grid
        real(8), dimension(number_of_grids,number_of_grids),intent(out) :: probability_matrix
        real(8) :: mu,rho,sigma
        real(8) :: sigma_1
                
        sigma_1=sigma/sqrt(1-rho**2)
                                                
        do i=1,number_of_grids-1
        
            mid_points(i)=(z_grid(1,i+1)+z_grid(1,i))/2
                        
        end do
        
        do i=1,number_of_grids
        
            probability_matrix(i,1)=(1+ERF(((mid_points(1)-mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2
            probability_matrix(i,number_of_grids)=1-(1+ERF(((mid_points(number_of_grids-1)-&
                mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2
            
            do j=2,number_of_grids-1
            
                probability_matrix(i,j)=(1+ERF(((mid_points(j)-mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2-&
                    (1+ERF(((mid_points(j-1)-mu*(1-rho)-rho*z_grid(1,i))/sigma)/sqrt(2.d0)))/2
            
            end do   
            
        end do
    
    end subroutine    
    
    SUBROUTINE rouwenhorst(rho,sigma_eps,mu_eps,n,zgrid,P)

        !rouwenhorst.f90
        !
        ! [zgrid, P] = rouwenhorst(rho, sigma_eps, n)
        !
        ! rho is the 1st order autocorrelation
        ! sigma_eps is the standard deviation of the error term
        ! n is the number of points in the discrete approximation
        !
        ! see "Finite State Markov-chain Approximations to Highly Persistent
        ! Processes"

        IMPLICIT NONE

        INTEGER, INTENT(IN) :: n
        DOUBLE PRECISION, INTENT(IN) :: rho,sigma_eps,mu_eps
        DOUBLE PRECISION, DIMENSION(n,n), INTENT(OUT) :: P
        DOUBLE PRECISION, DIMENSION(n), INTENT(OUT) :: zgrid

        INTEGER :: i, status
        DOUBLE PRECISION :: q, nu
        DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:,:) :: P11, P12, P21, P22
        EXTERNAL :: linspace

        q = (rho+1.d0)/2.d0
        nu = SQRT((DBLE(n)-1.d0)/(1.d0-rho**2.d0)) * sigma_eps
        P = 0.d0

        P(1,1) = q
        P(1,2) = 1 - q
        P(2,1) = 1 - q
        P(2,2) = q

        DO i=2,n-1
!        WRITE(*,*) i
        ALLOCATE(P11(i+1,i+1), P12(i+1,i+1), P21(i+1,i+1), P22(i+1,i+1), STAT=status)
        
        P11 = 0.d0
        P12 = 0.d0
        P21 = 0.d0
        P22 = 0.d0
        
        P11(1:i,1:i) = P(1:i,1:i)
        P12(1:i,2:i+1) = P(1:i,1:i)
        P21(2:i+1,1:i) = P(1:i,1:i)
        P22(2:i+1,2:i+1) = P(1:i,1:i)
        
!        WRITE(*,*) 'Assigned partial matrices'   

        P(1:i+1,1:i+1) = q*P11 + (1-q)*P12 + (1-q)*P21 + q*P22

        P(2:i,:) = P(2:i,:)/2.d0

        DEALLOCATE(P11,P12,P21,P22, STAT = status)
        END DO

!        WRITE(*,*) 'About to call linspace'
        CALL linspace(mu_eps/(1.d0-rho)-nu,mu_eps/(1.d0-rho)+nu,n,zgrid)

    END SUBROUTINE
    
    SUBROUTINE linspace(d1,d2,n,grid)

        IMPLICIT NONE

        INTEGER, INTENT(IN) :: n
        DOUBLE PRECISION, INTENT(IN) :: d1, d2
        DOUBLE PRECISION, DIMENSION(n), INTENT(OUT) :: grid

        INTEGER :: indxi
        
        grid(1) = d1
        DO indxi= 0,n-2
            grid(indxi+1) = d1+(DBLE(indxi)*(d2-d1))/DBLE(n-1)
        END DO
        grid(n) = d2

    END SUBROUTINE
    
    subroutine nakajima_algorithm(mu,rho,sigma,s_deviation_top,s_deviation_bottom,number_of_grids,z_grid,probability_matrix)
    
        use Global_Vars
        
        implicit none
        
        integer :: number_of_grids
        real(8) :: s_deviation_top,s_deviation_bottom
        real(8), dimension(number_of_grids-1) :: mid_points
        real(8), dimension(number_of_grids), intent(out) :: z_grid
        real(8), dimension(number_of_grids), intent(out) :: probability_matrix
        real(8) :: mu,sigma,rho
        real(8) :: sigma_1
                
        sigma_1=sqrt(sigma**2/(1-rho**2))
        
        z_grid(1)=mu-s_deviation_bottom*sigma_1
        z_grid(number_of_grids)=mu+s_deviation_top*sigma_1
        
        do i=2,number_of_grids-1
        
            z_grid(i)=z_grid(1)+((z_grid(number_of_grids)-z_grid(1))/(number_of_grids-1))*(i-1)
            
        end do
                                    
        do i=1,number_of_grids-1
        
            mid_points(i)=(z_grid(i+1)+z_grid(i))/2
                        
        end do
        
        probability_matrix(1)=(1+ERF(((mid_points(1)-mu)/sigma_1)/sqrt(2.d0)))/2
        probability_matrix(number_of_grids)=1-(1+ERF(((mid_points(number_of_grids-1)-mu)/sigma_1)/sqrt(2.d0)))/2
        
        do i=2,number_of_grids-1
        
            probability_matrix(i)=(1+ERF(((mid_points(i)-mu)/sigma_1)/sqrt(2.d0)))/2-&
                (1+ERF(((mid_points(i-1)-mu)/sigma_1)/sqrt(2.d0)))/2
        
        end do       
            
    end subroutine
    
    subroutine probabilities_given_grid_nakajima(mu,rho,sigma,number_of_grids,z_grid,probability_matrix)
    
        use Global_Vars
        
        implicit none
        
        integer :: number_of_grids
        real(8), dimension(number_of_grids-1) :: mid_points
        real(8), dimension(number_of_grids) :: z_grid
        real(8), dimension(number_of_grids),intent(out) :: probability_matrix
        real(8) :: mu,sigma,rho
        real(8) :: sigma_1
                
        sigma_1=sigma/sqrt(1-rho**2)
                                                    
        do i=1,number_of_grids-1
        
            mid_points(i)=(z_grid(i+1)+z_grid(i))/2
                        
        end do
        
        probability_matrix(1)=(1+ERF(((mid_points(1)-mu)/sigma_1)/sqrt(2.d0)))/2
        probability_matrix(number_of_grids)=1-(1+ERF(((mid_points(number_of_grids-1)-mu)/sigma_1)/sqrt(2.d0)))/2
        
        do i=2,number_of_grids-1
        
            probability_matrix(i)=(1+ERF(((mid_points(i)-mu)/sigma_1)/sqrt(2.d0)))/2-&
                (1+ERF(((mid_points(i-1)-mu)/sigma_1)/sqrt(2.d0)))/2
        
        end do       
            
    end subroutine
        
    subroutine set_SS_benefits(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        real(8), dimension(employment_grid_size) :: sum_of_distribution_employment
        
        sum_of_distribution=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period-solve_transition_dynamics,:,:,:,:,:,:))
            
        end do
        
        sum_of_distribution_employment=0
        
        do i=1,2
            
            do employment_index=1,employment_grid_size
            
                sum_of_distribution_employment(employment_index)=&
                    sum_of_distribution_employment(employment_index)+&
                    sum(distribution_stationary(i)%vector_transition_real&
                    (time_period-solve_transition_dynamics,:,:,:,employment_index,:,:))
                
            end do
                            
        end do
                                   
        model_ss_benefits=0
                                    
        do employment_index=1,employment_grid_size
        
            do unemployment_index=1,unemployment_grid_size
                    
                probability_came_from_past_employment_index_1=0

                model_lifetime_income_conditional_on_last_period_shock(employment_index)=0
                
                probability_came_from_past_employment_index_1(unemployment_index,employment_index)=1
        
                do age_index=(life_span-retirement_span),1,-1
            
                    probability_came_from_past_employment_index_2=0
                        
                    do past_employment_index_1=1,employment_grid_size
                    
                        do past_employment_index_2=1,unemployment_grid_size
                                                                                
                            model_lifetime_income_conditional_on_last_period_shock(employment_index)=&
                                model_lifetime_income_conditional_on_last_period_shock(employment_index)+&
                                probability_came_from_past_employment_index_1(past_employment_index_2,past_employment_index_1)*&
                                avg_labor_supply_data*max_labor_supply*employment_grid(age_index,past_employment_index_1)*&
                                labour_deterministic_efficiency(age_index)
                        
                            do past_employment_index_3=1,employment_grid_size
                            
                                do past_employment_index_4=1,unemployment_grid_size
                            
                                    probability_came_from_past_employment_index_2(past_employment_index_4,past_employment_index_3)=&
                                        probability_came_from_past_employment_index_2&
                                        (past_employment_index_4,past_employment_index_3)+&
                                        probability_came_from_past_employment_index_1&
                                        (past_employment_index_2,past_employment_index_1)*&
                                        (employment_process(max(age_index-1,1),past_employment_index_3,past_employment_index_1)/&
                                        sum(employment_process(max(age_index-1,1),:,past_employment_index_1)))*&
                                        (unemployment_process(max(age_index-1,1),past_employment_index_4,&
                                        past_employment_index_2,1,0,past_employment_index_1)/sum(unemployment_process&
                                        (max(age_index-1,1),:,past_employment_index_2,1,0,past_employment_index_1)))
                                        
                                end do
                            
                            end do
                            
                        end do
                                                                                
                    end do
                    
                end do
                                        
                probability_came_from_past_employment_index_1=&
                    probability_came_from_past_employment_index_2
                    
                model_lifetime_income_conditional_on_last_period_shock(employment_index)=&
                    model_lifetime_income_conditional_on_last_period_shock(employment_index)/(life_span-retirement_span)
                                            
            end do
                        
        end do
                          
        ! Computing the average lifetime income conditional on the last period shock
        model_average_lifetime_income_conditional_on_last_period_shock=0
                        
        do employment_index=1,employment_grid_size
                    
            if (loop_count<1) then
            
                model_average_lifetime_income_conditional_on_last_period_shock=&
                    model_average_lifetime_income_conditional_on_last_period_shock+&
                    model_lifetime_income_conditional_on_last_period_shock(employment_index)
                
            else
        
                model_average_lifetime_income_conditional_on_last_period_shock=&
                    model_average_lifetime_income_conditional_on_last_period_shock+&
                    model_lifetime_income_conditional_on_last_period_shock(employment_index)*&
                    (sum_of_distribution_employment(employment_index)/sum_of_distribution)
            
            end if
                                          
        end do
                                        
        ! Looping over all possible last period employment states
        do employment_index=1,employment_grid_size
            
            if ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)<=0.3) then
                
                ! Computes social security benefits
                model_ss_benefits(employment_index)=&
                    0.9*(model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                    model_average_lifetime_income_conditional_on_last_period_shock)
                
            elseif (((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)>0.3) .AND. &
                ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)<=2)) then
                
                ! Computes social security benefits
                model_ss_benefits(employment_index)=&
                    0.27+0.32*(model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                    model_average_lifetime_income_conditional_on_last_period_shock-0.3)
                        
            elseif (((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)>2) .AND. &
                ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)<=4.1)) then
                
                ! Computes social security benefits
                model_ss_benefits(employment_index)=&
                    0.81+0.15*(model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                    model_average_lifetime_income_conditional_on_last_period_shock-2)
                
            elseif ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)>4.1) then
            
                ! Computes social security benefits
                model_ss_benefits(employment_index)=1.13
                    
            end if
            
        end do
        
        if (loop_count<5) then
                                
            do employment_index=1,employment_grid_size
        
!                write(*,*) "model_ss_benefits", employment_index,"=", model_ss_benefits(employment_index)
                                        
            end do
            
        end if
        
        if (loop_count<1) then
        
            if (include_addiction==1) then
                                                                                        
                model_ss_benefits=&
                    (/0.13001534512509200,0.17576061828112619,0.20208866093555292,0.23909514735434345,&
                    0.29111407634379632,0.36423955558341353,0.46704102272962378,0.55949652015928697,&
                    0.65474754651858269/)
                    
            else
            
                model_ss_benefits=&
                    (/0.126749628889,0.171317574599,0.196984311342,0.233061271454,0.283773592667,&
                    0.355062311295,0.455281618466,0.545360175224,0.638218693045/)
            
            end if
        
        end if
            
        if (loop_count<5) then
                                
            do employment_index=1,employment_grid_size
        
!                write(*,*) "model_ss_benefits", employment_index,"=", model_ss_benefits(employment_index)
                                        
            end do
            
        end if
                
        do employment_index=1,employment_grid_size
        
            if (loop_count>=1) then

                model_ss_benefits(employment_index)=&
                    model_ss_benefits(employment_index)*&
                    model_average_labour_income(time_period)
                    
            end if
                    
            if ((loop_count<5) .OR. &
               (re_do_simulation_with_fixed_parameters==1)) then
                                                    
!                    write(*,*) "model_ss_benefits(",employment_index,")=", model_ss_benefits(employment_index)
            
            end if
            
        end do
        
        if (productivity_below_which_to_reduce_ss>0) then
        
            model_ss_benefits(1:productivity_below_which_to_reduce_ss)=&
                model_ss_benefits(1:productivity_below_which_to_reduce_ss)*scaling_of_ss
                
        end if
                            
        if (is_counterfactual==1) then
                        
            if (use_old_results==1) then
            
                open(UNIT=19,file="model_ss_benefits"//trim(old_results)//".dat",action='read')
                    read(19,'(F15.12)') model_ss_benefits
                close(19)
            
            end if
            
            if (reduce_ss_by_half==1) then
            
                model_ss_benefits=model_ss_benefits*scaling_of_ss
                
            end if
                        
            write(*,*) "model_ss_benefits=", model_ss_benefits
            
        end if
        
    end subroutine
    
    
    subroutine set_smallest_house_size()
    
        use Global_Vars
        
        implicit none
        
        real(8) :: net_income_lowest
        real(8) :: rent_upload
                
        net_income_lowest=labor_income_tax_rate*employment_grid(1,1)**(curvature_of_labor_income_taxes)
        
        if (re_do_simulation_with_fixed_parameters==0) then
        
            if (loop_count<1) then
        
                smallest_house_size=smallest_rental_relative_to_lowest_income !net_income_lowest*smallest_rental_relative_to_lowest_income/1.079
                    
                write(*,*) "smallest_house_size=", smallest_house_size
                write(*,*) "smallest_house_size*free_market_rent_to_house_price*&
                    housing_price(1)/net_income_lowest=", &
                    (smallest_house_size*1.079)/net_income_lowest    
                    
            else
            
                if (housing_status_grid_size>8) then
            
                    smallest_house_size=smallest_rental_relative_to_lowest_income
                        
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "smallest_house_size*rent(1)/net_income_lowest=", &
                        (smallest_house_size*rent(1,0))/net_income_lowest    
                        
                else
                
                    smallest_house_size=smallest_rental_relative_to_lowest_income !net_income_lowest*smallest_rental_relative_to_lowest_income/rent(1,0)
                        
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "smallest_house_size*rent(1)/net_income_lowest=", &
                        (smallest_house_size*rent(1,0))/net_income_lowest   
                
                end if
            
            end if
            
        else
        
            if (is_counterfactual==0) then
            
                if (housing_status_grid_size>8) then
        
                    smallest_house_size=smallest_rental_relative_to_lowest_income !net_income_lowest*smallest_rental_relative_to_lowest_income/rent(1,0)
                    
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "smallest_house_size*rent(1,1)/net_income_lowest=", &
                        (smallest_house_size*rent(1,0))/net_income_lowest   
                        
                else
                
                    smallest_house_size=smallest_rental_relative_to_lowest_income !net_income_lowest*smallest_rental_relative_to_lowest_income/rent(1,0)
                    
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "smallest_house_size*rent(1)/net_income_lowest=", &
                        (smallest_house_size*rent(1,0))/net_income_lowest   
                        
                end if
                    
            else
            
                if (housing_status_grid_size>8) then

                    smallest_house_size=smallest_rental_relative_to_lowest_income !net_income_lowest*smallest_rental_relative_to_lowest_income/rent_calibrated(0)
                    
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "smallest_house_size*rent(1,1)/net_income_lowest=", &
                        (smallest_house_size*rent_calibrated(0))/net_income_lowest   
                        
                else
                
                    open(unit=23,file="rent"//trim(old_results)//".dat",action='read')
                        read(23,'(F15.12)') rent_upload
                    close(23)
                                        
                    smallest_house_size=smallest_rental_relative_to_lowest_income !net_income_lowest*smallest_rental_relative_to_lowest_income/rent_upload
                    
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "smallest_house_size*rent_upload(1,1)/net_income_lowest=", &
                        (smallest_house_size*rent_upload)/net_income_lowest
                
                end if
            
            end if
                
        end if
                
    end subroutine
    
    subroutine initialize_financial_grid(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        
        financial_grid(1)=-(1-minimum_downpayment)
            
        financial_grid(negative_financial_grid_size)=0.d0
                
        do i=2,negative_financial_grid_size-1
        
            financial_grid(i)=financial_grid(i-1)+&
                (financial_grid(negative_financial_grid_size)-financial_grid(1))/(negative_financial_grid_size-1)
    
        end do
                                
        financial_grid(financial_grid_size)=max_times_labour_income_saved*employment_grid(1,employment_grid_size)
                           
        do i=negative_financial_grid_size+1,financial_grid_size
        
            financial_grid_distance_positive(i)=(real(i)-real(negative_financial_grid_size))*&
                ((financial_grid(financial_grid_size))**(real(1)/real(financial_grid_expander_positive+1)))/&
                (real(positive_financial_grid_size))
    
        end do
        
        financial_grid(negative_financial_grid_size+1:financial_grid_size)=&
            financial_grid_distance_positive(negative_financial_grid_size+1:financial_grid_size)**&
            (real(financial_grid_expander_positive))
            
        open(unit=3,file="financial_grid_points"//trim(file_number)//".txt",action="write",status="replace")
        do i=1,financial_grid_size
            write(3,*) financial_grid(i)/employment_grid(1,employment_grid_size)
        end do
        close(3)
        open(unit=3,file="financial_grid"//trim(file_number)//".txt",action="write",status="replace")
        do i=1,financial_grid_size
            write(3,*) financial_grid(i)
        end do
        close(3)

    end subroutine
    
    subroutine compute_rental_management_costs(time_period,convexity_of_rental_company_3,&
        rental_management_costs_3,low_quality_market_1)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        real(8), intent(inout) :: rental_management_costs_3
        real(8), intent(in) :: convexity_of_rental_company_3
        integer, intent(in) :: low_quality_market_1
    
        rental_management_costs_3=(rent(1,low_quality_market_1)-housing_price(time_period)*&
            (risk_free_rate(time_period)+housing_depreciation_rate+property_tax(time_period)+property_tax_on_rental_housing)/&
            (1+risk_free_rate(time_period)))/((total_rental_demand(time_period,low_quality_market_1)**&
            (convexity_of_rental_company_3-1))*convexity_of_rental_company_3)
                        
    end subroutine
    
    subroutine compute_rental_housing_supply&
        (convexity_of_rental_company_3,rental_management_costs_3,rental_housing_supply_3,rent_increase_1,low_quality_market_1)
    
        use Global_Vars
        
        implicit none
        
        real(8), intent(in) :: rental_management_costs_3,rent_increase_1
        real(8), intent(in) :: convexity_of_rental_company_3
        real(8), intent(inout) :: rental_housing_supply_3
        integer, intent(in) :: low_quality_market_1
            
        rental_housing_supply_3=max(((rent(1,low_quality_market_1)*rent_increase_1-&
            housing_price(1)+(1/(1+risk_free_rate(1)))*&
            (housing_price(1)*(1-housing_depreciation_rate-property_tax(1)-property_tax_on_rental_housing)))/&
            (rental_management_costs_3*convexity_of_rental_company_3)),0.d0)**(1/(convexity_of_rental_company_3-1))
                                    
    end subroutine
    
    subroutine solve_elasticity_of_rental_housing(time_period,convexity_of_rental_company_solved,low_quality_market_1)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        integer, parameter :: dimensions_of_problem=2
        integer, intent(in) :: low_quality_market_1
        real(8), dimension(dimensions_of_problem+1) :: rental_housing_supply_1
        real(8), dimension(dimensions_of_problem+1) :: convexity_of_rental_company_1,rental_management_costs_1
        real(8), dimension(dimensions_of_problem+1) :: elasticity_1
        real(8), intent(out) :: convexity_of_rental_company_solved
        real(8) :: stopping_rule_elasticity=10.d0**(-4),rent_increase_1,elasticity_of_rental_supply_data=1.6
                        
        convexity_of_rental_company_1(1)=1.1
        convexity_of_rental_company_1(2)=100
                                
        do i=1,dimensions_of_problem
        
            call compute_rental_management_costs(time_period,convexity_of_rental_company_1(i),&
                rental_management_costs_1(i),low_quality_market_1)
            
            rent_increase_1=1.01
            
            call compute_rental_housing_supply(convexity_of_rental_company_1(i),&
                rental_management_costs_1(i),rental_housing_supply_1(i),rent_increase_1,low_quality_market_1)
                
            elasticity_1(i)=rental_housing_supply_1(i)
            
            rent_increase_1=1
                
            call compute_rental_housing_supply(convexity_of_rental_company_1(i),&
                rental_management_costs_1(i),rental_housing_supply_1(i),rent_increase_1,low_quality_market_1)
                
            elasticity_1(i)=100*(elasticity_1(i)/rental_housing_supply_1(i)-1)
                            
        end do
        
        elasticity_1(3)=0
                
        do while (abs(elasticity_1(3)-elasticity_of_rental_supply_data)>stopping_rule_elasticity)
                
            convexity_of_rental_company_1(3)=sum(convexity_of_rental_company_1(1:dimensions_of_problem))/dimensions_of_problem
            
            call compute_rental_management_costs&
                (time_period,convexity_of_rental_company_1(3),rental_management_costs_1(3),low_quality_market_1)
            
            rent_increase_1=1.01
            
            call compute_rental_housing_supply(convexity_of_rental_company_1(3),&
                rental_management_costs_1(3),rental_housing_supply_1(3),rent_increase_1,low_quality_market_1)
                
            elasticity_1(3)=rental_housing_supply_1(3)
            
            rent_increase_1=1
                
            call compute_rental_housing_supply(convexity_of_rental_company_1(3),&
                rental_management_costs_1(3),rental_housing_supply_1(3),rent_increase_1,low_quality_market_1)
                
            elasticity_1(3)=100*(elasticity_1(3)/rental_housing_supply_1(3)-1)
            
            if (elasticity_1(3)>elasticity_of_rental_supply_data) then
            
                convexity_of_rental_company_1(1)=convexity_of_rental_company_1(3)
                
            else
            
                convexity_of_rental_company_1(dimensions_of_problem)=convexity_of_rental_company_1(3)
                
            end if
                        
        end do       
        
        convexity_of_rental_company_solved=convexity_of_rental_company_1(1)
    
    end subroutine
        
    subroutine calculate_aggregate_consumption(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer :: financial_index,has_house,amortization_used,financial_index_used,low_quality_market
        integer, intent(in) :: time_period
        integer :: time_period_used,pay_mortgage_insurance_1,housing_status_index_used,addiction_choice_used
        real(8) :: total_consumption_used,consumption_used,distribution_mass_used,lived_in_size_used,avg_income_to_use_1,&
            frac_spend_on_addiction_used
                    
        avg_income_to_use_1=is_counterfactual*average_labor_income_calibrated+&
            (1-is_counterfactual)*model_average_labour_income(time_period)
                
        time_period_used=time_period-solve_transition_dynamics
        
        aggregate_housing_consumption(time_period)=0
        aggregate_housing_transaction_costs(time_period)=0
        aggregate_consumption(time_period)=0
        aggregate_total_consumption(time_period)=0
        aggregate_spending_on_addiction(time_period)=0
        aggregate_mortgage_consumption(time_period)=0
        aggregate_rent_spending(time_period)=0
        aggregate_origination_costs(time_period)=0
        aggregate_prepayment_costs(time_period)=0
        aggregate_moving_costs(time_period)=0
        model_average_LTV_at_orgination(time_period)=0
        model_average_LTV_at_orgination_2(time_period)=0
        model_mass_origination(time_period)=0
        model_mass_origination_2(time_period)=0
        homeowners_refinancing_own_home(time_period)=0
        refinanced_mortgages(time_period)=0
        homeowners_originating_mortgage(time_period)=0
                
        do age_index=1,life_span
            
            if (age_index==1) then
            
                newborn_household=1
                
            else
            
                newborn_household=0
                
            end if
                                        
            do years_left_on_mortgage_index=1,max_amortization_years
                            
                if (years_left_on_mortgage_index>1) then
                
                    has_house=1
                    
                else
                
                    has_house=0
                
                end if
                
                do unemployment_index=1,unemployment_grid_size
                
                    do employment_index=1,employment_grid_size
                    
                        do voucher_index=0,(1-has_house)*include_vouchers
                                                                                                      
                            do financial_index=has_house*1+(1-has_house)*negative_financial_grid_size,financial_grid_size
                            
                                do housing_status_index=(1-has_house)*lowest_housing_grid_point+&
                                    has_house*index_of_smallest_house_hhld_can_buy,housing_status_grid_size-1
                        
                                    lived_in_size_used=policy_function_space_lived_in_size(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                                      
                                    amortization_used=policy_function_years_of_amortization_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    financial_index_used=policy_function_financial_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)

                                    housing_status_index_used=policy_function_housing_status_index(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)

                                    consumption_used=policy_function_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    frac_spend_on_addiction_used=&
                                        policy_function_frac_spent_on_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    total_consumption_used=policy_function_total_consumption(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    addiction_choice_used=policy_function_addiction(years_left_on_mortgage_index)%&
                                        vector_transition_integer(time_period,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                    
                                    distribution_mass_used=distribution_stationary(years_left_on_mortgage_index)%&
                                        vector_transition_real(time_period_used,age_index,financial_index,&
                                        unemployment_index,employment_index,housing_status_index,voucher_index)
                                        
                                    if ((housing_status_index_used>second_lowest_housing_grid_point) .OR. &
                                        (have_two_rental_markets==0)) then
                                        
                                        low_quality_market=0
                                        
                                    else
                                    
                                        low_quality_market=1
                                    
                                    end if
                                        
                                    aggregate_consumption(time_period)=aggregate_consumption(time_period)+&
                                        consumption_used*distribution_mass_used
                                        
                                    aggregate_total_consumption(time_period)=aggregate_total_consumption(time_period)+&
                                        total_consumption_used*distribution_mass_used
                                        
                                    if (frac_spend_on_addiction_used>0) then
                                                                                                        
                                        aggregate_spending_on_addiction(time_period)=&
                                            aggregate_spending_on_addiction(time_period)+&
                                            frac_spend_on_addiction_used*total_consumption_used*distribution_mass_used
                                            
                                    end if
                                                                                                            
                                    if (years_left_on_mortgage_index<=1) then
                                                                            
                                        if ((financial_grid(financial_index_used)<0) .AND. &
                                            (amortization_used==2)) then
                                            
                                            aggregate_origination_costs(time_period)=&
                                                aggregate_origination_costs(time_period)+mortgage_origination_cost*&
                                                avg_income_to_use_1*distribution_mass_used
                                            
                                            homeowners_originating_mortgage(time_period)=&
                                                homeowners_originating_mortgage(time_period)+distribution_mass_used
                                                
                                            model_average_LTV_at_orgination(time_period)=&
                                                model_average_LTV_at_orgination(time_period)-&
                                                financial_grid(financial_index_used)*distribution_mass_used
                                                
                                            model_mass_origination(time_period)=&
                                                model_mass_origination(time_period)+distribution_mass_used
                                                                                            
                                        end if
                                                                                       
                                    end if
                                    
                                    if ((years_left_on_mortgage_index<=1) .AND. (amortization_used<=1) .AND. (age_index>1)) then
                                    
                                        if ((housing_status_index_used .NE. housing_status_index) .OR. &
                                           (amortization_used .NE. years_left_on_mortgage_index)) then
                                           
                                            aggregate_moving_costs(time_period)=aggregate_moving_costs(time_period)+&
                                                fixed_cost_to_moving*distribution_mass_used
                                        
                                        end if
                                    
                                    end if
                                                                            
                                    if (years_left_on_mortgage_index==2) then
                                                                    
                                        if ((amortization_used==2) .AND. &
                                            (housing_status_index_used .NE. housing_status_index)) then
                                            
                                            if (financial_grid(financial_index_used)<0) then
                                            
                                                aggregate_origination_costs(time_period)=&
                                                    aggregate_origination_costs(time_period)+mortgage_origination_cost*&
                                                    avg_income_to_use_1*distribution_mass_used
                                            
                                                homeowners_originating_mortgage(time_period)=&
                                                    homeowners_originating_mortgage(time_period)+distribution_mass_used
                                                    
                                                model_average_LTV_at_orgination_2(time_period)=&
                                                    model_average_LTV_at_orgination_2(time_period)-&
                                                    financial_grid(financial_index_used)*distribution_mass_used
                                                    
                                                model_mass_origination_2(time_period)=&
                                                    model_mass_origination_2(time_period)+distribution_mass_used
                                                                                                
                                            end if
                                                                                            
                                            aggregate_prepayment_costs(time_period)=aggregate_prepayment_costs(time_period)+&
                                                penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                                                (-min(financial_grid(financial_index),0.d0)*&
                                                housing_price(time_period)*housing_size(housing_status_index)*&
                                                (1-prepayment_penalty_starts_from))*distribution_mass_used
                                                                                                    
                                        end if
                                        
                                        if ((amortization_used==2) .AND. (housing_status_index_used==housing_status_index)) then
                                            
                                            if (financial_grid(financial_index)>0) then
                                            
                                                if (financial_grid(financial_index_used)<0) then
                                                
                                                    aggregate_origination_costs(time_period)=&
                                                        aggregate_origination_costs(time_period)+mortgage_origination_cost*&
                                                        avg_income_to_use_1*distribution_mass_used
                                                        
                                                    homeowners_originating_mortgage(time_period)=&
                                                        homeowners_originating_mortgage(time_period)+distribution_mass_used
                                                        
                                                end if
                                                    
                                            else
                                            
                                                if (financial_grid(financial_index_used)<&
                                                    (financial_grid(financial_index)*(1-prepayment_penalty_starts_from))) then
                                                                                                    
                                                    aggregate_prepayment_costs(time_period)=&
                                                        aggregate_prepayment_costs(time_period)+&
                                                        penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                                                        (-min(financial_grid(financial_index),0.d0))*&
                                                        housing_price(time_period)*housing_size(housing_status_index)*&
                                                        (1-prepayment_penalty_starts_from)*distribution_mass_used
                                                        
                                                    aggregate_origination_costs(time_period)=&
                                                        aggregate_origination_costs(time_period)+mortgage_origination_cost*&
                                                        avg_income_to_use_1*distribution_mass_used
                                                        
                                                    homeowners_refinancing_own_home(time_period)=&
                                                        homeowners_refinancing_own_home(time_period)+distribution_mass_used
                                                        
                                                    homeowners_originating_mortgage(time_period)=&
                                                        homeowners_originating_mortgage(time_period)+distribution_mass_used
                                                        
                                                elseif (financial_grid(financial_index_used)>=&
                                                    (financial_grid(financial_index)*(1-prepayment_penalty_starts_from)))  then
                                                                                                    
                                                    aggregate_prepayment_costs(time_period)=&
                                                        aggregate_prepayment_costs(time_period)+&
                                                        penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                                                        max(min(financial_grid(financial_index_used),0.d0)*&
                                                        housing_price(time_period)*housing_size(housing_status_index)-&
                                                        financial_grid(financial_index)*&
                                                        housing_price(time_period)*housing_size(housing_status_index)*&
                                                        (1-prepayment_penalty_starts_from),0.d0)*distribution_mass_used
                                                        
                                                end if
                                                
                                            end if
                                                                                                          
                                        end if
                                                                                
                                        if (amortization_used<=1) then
                                                                                                                
                                            aggregate_prepayment_costs(time_period)=&
                                                aggregate_prepayment_costs(time_period)+&
                                                penalty_months_of_interest*mortgage_interest_rate(time_period)*&
                                                (-min(financial_grid(financial_index),0.d0)*&
                                                housing_price(time_period)*housing_size(housing_status_index)*&
                                                (1-prepayment_penalty_starts_from))*distribution_mass_used
                                                                                                                                                        
                                        end if
                                                                        
                                        if (-financial_grid(min(financial_index_used,negative_financial_grid_size))>0.8) then
                                        
                                            pay_mortgage_insurance_1=1
                                                                    
                                        else
                                        
                                            pay_mortgage_insurance_1=0
                                        
                                        end if
                                        
                                        aggregate_mortgage_consumption(time_period)=&
                                            aggregate_mortgage_consumption(time_period)+&
                                            (-min(financial_grid(financial_index),0.d0)*&
                                            housing_price(time_period)*housing_size(housing_status_index)*&
                                            (mortgage_interest_rate(time_period)+&
                                            pay_mortgage_insurance_1*mortgage_insurance_premium))*distribution_mass_used
                                                                                                                                                        
                                    else
                                    
                                        pay_mortgage_insurance_1=0
                                        
                                    end if
                                                                      
                                    if (amortization_used>1) then
                                        
                                        aggregate_housing_consumption(time_period)=aggregate_housing_consumption(time_period)+&
                                            housing_depreciation_rate*housing_price(time_period)*&
                                            housing_size(housing_status_index_used)*distribution_mass_used
                                            
                                    end if
                                                                    
                                    if (amortization_used<=1) then
                                    
                                        if (housing_status_index_used>=second_lowest_housing_grid_point) then
                                
                                            aggregate_rent_spending(time_period)=aggregate_rent_spending(time_period)+&
                                                rent(time_period,low_quality_market)*lived_in_size_used*distribution_mass_used
                                                
                                        end if
                                        
                                    end if
                                                                            
                                    if ((years_left_on_mortgage_index<=1) .AND. (amortization_used>=2)) then
                                        
                                        aggregate_housing_transaction_costs(time_period)=&
                                            aggregate_housing_transaction_costs(time_period)+&
                                            cost_of_buying*housing_price(time_period)*housing_size(housing_status_index_used)*&
                                            distribution_mass_used

                                    end if
                                                                                
                                    if ((years_left_on_mortgage_index>=2) .AND. (amortization_used<=1)) then
                                                                                           
                                        aggregate_housing_transaction_costs(time_period)=&
                                            aggregate_housing_transaction_costs(time_period)+&
                                            cost_of_selling*housing_price(time_period)*&
                                            housing_size(housing_status_index)*distribution_mass_used
                                        
                                    end if
                                        
                                    if ((years_left_on_mortgage_index>=2) .AND. (amortization_used>=2) .AND. &
                                        (housing_status_index_used .NE. housing_status_index)) then
                                                                                                       
                                        aggregate_housing_transaction_costs(time_period)=&
                                            aggregate_housing_transaction_costs(time_period)+&
                                            (cost_of_selling*housing_price(time_period)*&
                                            housing_size(housing_status_index)+cost_of_buying*housing_price(time_period)*&
                                            housing_size(housing_status_index_used))*distribution_mass_used
                                                                                     
                                    end if
                                    
                                end do
                                                                
                            end do
                            
                        end do
                        
                    end do
                                                                            
                end do
                                                                    
            end do
                            
        end do
        
        model_average_LTV_at_orgination(time_period)=&
            model_average_LTV_at_orgination(time_period)/model_mass_origination(time_period)
            
        model_average_LTV_at_orgination_2(time_period)=&
            model_average_LTV_at_orgination_2(time_period)/model_mass_origination_2(time_period)
                                                    
        write(*,*) "aggregate_consumption", time_period, "=", aggregate_consumption(time_period)
        write(*,*) "aggregate_housing_consumption=", time_period, "=", aggregate_housing_consumption(time_period)
        write(*,*) "aggregate_mortgage_consumption=", time_period, "=", aggregate_mortgage_consumption(time_period)
        write(*,*) "aggregate_housing_transaction_costs=", aggregate_housing_transaction_costs(time_period)
        write(*,*) "aggregate_origination_costs=", aggregate_origination_costs(time_period)
        write(*,*) "aggregate_prepayment_costs=", aggregate_prepayment_costs(time_period)
        write(*,*) "aggregate_moving_costs=", aggregate_moving_costs(time_period)
        write(*,*) "govt_ss_wasted", govt_ss_wasted(time_period)
        write(*,*) "govt_spending_on_homeless=", govt_spending_on_homeless(time_period)
        write(*,*) "govt_spending_on_addicts=", govt_spending_on_addicts(time_period)
        write(*,*) "sum(total_rental_demand(time_period-solve_transition_dynamics,:))=", &
            sum(total_rental_demand(time_period-solve_transition_dynamics,:))
        
        write(*,*) "total_expendifure=", &
            aggregate_consumption(time_period)+aggregate_spending_on_addiction(time_period)+&
            aggregate_housing_consumption(time_period)+aggregate_mortgage_consumption(time_period)+&
            aggregate_housing_transaction_costs(time_period)+aggregate_origination_costs(time_period)+&
            aggregate_prepayment_costs(time_period)+aggregate_moving_costs(time_period)+&
            govt_revenues_to_use_in_tests(time_period)+&
            govt_ss_wasted(time_period)+&
            (govt_spending_on_homeless(time_period)+govt_spending_on_addicts(time_period))+&
            (1-include_property_taxes_in_govt_constraint)*govt_revenues_from_property_tax(time_period)+&
            aggregate_rent_spending(time_period)-housing_price(time_period)*&
            sum(total_rental_demand(time_period-solve_transition_dynamics,:))*property_tax(time_period-solve_transition_dynamics)
        write(*,*) "model_total_income=", model_output(time_period)+model_total_investment_income(time_period)+&
            include_bequests*value_of_initial_assets
        write(*,*) "model_total_income-model_total_expenditure=", &
            model_output(time_period)+model_total_investment_income(time_period)+include_bequests*value_of_initial_assets-&
            (aggregate_consumption(time_period)+aggregate_spending_on_addiction(time_period)+&
            aggregate_housing_consumption(time_period)+aggregate_mortgage_consumption(time_period)+&
            aggregate_housing_transaction_costs(time_period)+aggregate_origination_costs(time_period)+&
            aggregate_prepayment_costs(time_period)+aggregate_moving_costs(time_period)+&
            govt_revenues_to_use_in_tests(time_period)+&
            govt_ss_wasted(time_period)+&
            (govt_spending_on_homeless(time_period)+govt_spending_on_addicts(time_period))+&
            (1-include_property_taxes_in_govt_constraint)*govt_revenues_from_property_tax(time_period)+&
            aggregate_rent_spending(time_period)-housing_price(time_period)*&
            sum(total_rental_demand(time_period-solve_transition_dynamics,:))*&
            property_tax(time_period-solve_transition_dynamics))
                       
    end subroutine
    
    subroutine save_vars_and_functions(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        
        character*1 :: string_used
        
        write(*,*) "saving vars and functions"
                
        do i=1,2
        
            write(string_used,'(i1)') i
            
            open(unit=1,file="value_function"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(1,'(F35.13)') value_function(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(1)
        
            open(unit=2,file="distribution_stationary"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F30.28)') distribution_stationary(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_space_lived_in_size"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F25.20)') policy_function_space_lived_in_size(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_labor_supply"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F22.20)') policy_function_labor_supply(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_total_consumption"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F26.20)') policy_function_total_consumption(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_consumption"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F26.20)') policy_function_consumption(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_frac_spent_on_addiction"//&
                trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F25.20)') policy_function_frac_spent_on_addiction(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_years_of_amortization_index"//&
                trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(I2)') policy_function_years_of_amortization_index(i)%vector_transition_integer(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_housing_status_index"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(I2)') policy_function_housing_status_index(i)%vector_transition_integer(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_financial_index"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(I3)') policy_function_financial_index(i)%vector_transition_integer(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="fin_index_frac_mov_to_optimal"//&
                trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(I3)') fin_index_frac_mov_to_optimal(i)%vector_transition_integer(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="policy_function_addiction"//&
                trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(I1)') policy_function_addiction(i)%vector_transition_integer(:,:,:,:,:,:,:)
            close(2)
            
            open(unit=2,file="frac_mov_optimal_1"//trim(string_used)//trim(file_number)//".dat",status='replace')
                write(2,'(F22.20)') frac_mov_optimal_1(i)%vector_transition_real(:,:,:,:,:,:,:)
            close(2)
                        
        end do
        
        open(unit=1,file="voucher_probabilities_benchmark"//trim(file_number)//".dat",status='replace')
            write(1,'(F35.13)') voucher_probabilities_benchmark
        close(1)
        
        open(unit=1,file="average_welfare_of_youngest_cohort"//trim(file_number)//".dat",status='replace')
            write(1,'(F35.13)') average_welfare_of_youngest_cohort(time_period)
        close(1)
        
        open(unit=1,file="welfare_by_addiction_youngest"//trim(file_number)//".dat",status='replace')
            write(1,'(F35.13)') welfare_by_addiction_youngest(time_period,:)
        close(1)
                               
        open(unit=18,file="average_labor_income"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_labour_income(time_period)
        close(18)
        
        open(unit=18,file="model_average_income"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_income(time_period)
        close(18)
        
        open(unit=18,file="model_average_income_plus_assets"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_income_plus_assets(time_period)
        close(18)
        
        open(unit=18,file="model_average_income_plus_all_assets"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_income_plus_all_assets(time_period)
        close(18)
            
        open(unit=18,file="median_income"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') median_income(time_period)
        close(18)
        
        open(unit=18,file="average_labor_income_by_employment"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_labour_income_by_employment(time_period,:)
        close(18)
        
        open(unit=18,file="model_average_financial"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_financial(time_period)
        close(18)
        
        open(unit=18,file="model_bequests"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_bequests(time_period)
        close(18)
        
        open(unit=18,file="model_average_net_wealth"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_net_wealth(time_period)
        close(18)
        
        open(unit=19,file="model_ss_benefits"//trim(file_number)//".dat",status='replace')
            do i=1,employment_grid_size
                write(19,'(F15.12)') model_ss_benefits(i)
            end do
        close(19)
        
        open(unit=19,file="income_cutoffs_of_quintiles"//trim(file_number)//".dat",status='replace')
            write(19,'(F15.12)') income_cutoffs_of_quintiles(:)
        close(19)
                
        open(unit=20,file="c_1"//trim(file_number)//".dat",status='replace')
            write(20,'(F20.12)') c_1
        close(20)
        
        open(unit=20,file="c_1_2"//trim(file_number)//".dat",status='replace')
            write(20,'(F20.12)') c_1_2
        close(20)
            
        open(unit=21,file="c_min"//trim(file_number)//".dat",status='replace')
            write(21,'(F20.12)') c_min
        close(21)
        
        open(unit=20,file="model_bequests"//trim(file_number)//".dat",status='replace')
            write(20,'(F15.12)') model_bequests
        close(20)
        
        open(unit=20,file="inheritance_amount"//trim(file_number)//".dat",status='replace')
            write(20,'(F15.14)') inheritance_amount
        close(20)
                        
        open(unit=22,file="housing_price"//trim(file_number)//".dat",status='replace')
            write(22,'(F15.12)') housing_price(time_period)
        close(22)
        
        open(unit=23,file="rent"//trim(file_number)//".dat",status='replace')
            write(23,'(F15.12)') rent(time_period,:)
        close(23)
                
        open(unit=23,file="lump_sum_transfer"//trim(file_number)//".dat",status='replace')
            write(23,'(F15.12)') lump_sum_transfer(time_period)
        close(23)
        
        open(unit=24,file="housing_stock"//trim(file_number)//".dat",status='replace')
            write(24,'(F15.12)') housing_stock(time_period)
        close(24)
        
        open(unit=25,file="total_rental_supply"//trim(file_number)//".dat",status='replace')
            write(25,'(F15.12)') total_rental_supply(time_period,:)
        close(25)
        
        open(unit=18,file="model_average_rental_unit_size"//trim(file_number)//".dat",status='replace')
            write(18,'(F15.12)') model_average_rental_unit_size(time_period)
        close(18)

        open(unit=25,file="smallest_financial_chosen_in_equilibrium"//trim(file_number)//".dat",status='replace')
            write(25,'(I3)') smallest_financial_chosen_in_equilibrium
        close(25)
        
        open(unit=32,file="model_total_hours"//trim(file_number)//".dat",status='replace')
            write(32,'(F15.12)') model_total_hours(time_period)
        close(32)
        
        open(unit=32,file="model_labor_supply"//trim(file_number)//".dat",status='replace')
            write(32,'(F15.12)') model_labor_supply(time_period)
        close(32)
        
        open(unit=26,file="net_govt_revenues"//trim(file_number)//".dat",status='replace')
            write(26,'(F15.12)') net_govt_revenues(time_period)
        close(26)
        
        open(unit=26,file="govt_revenues_to_use_in_tests"//trim(file_number)//".dat",status='replace')
            write(26,'(F15.12)') govt_revenues_to_use_in_tests(time_period)
        close(26)      
            
        open(unit=27,file="rental_management_costs"//trim(file_number)//".dat",status='replace')
            write(27,'(F30.29)') rental_management_costs
        close(27)
        
        open(unit=27,file="increase_in_labour_income_tax"//trim(file_number)//".dat",status='replace')
            write(27,'(F30.28)') increase_in_labour_income_tax
        close(27)
                        
        open(unit=28,file="standard_deduction"//trim(file_number)//".dat",status='replace')
            write(28,'(F15.12)') standard_deduction
        close(28)

        open(unit=28,file="personal_exemption"//trim(file_number)//".dat",status='replace')
            write(28,'(F15.12)') personal_exemption
        close(28)
        
        open(unit=29,file="cutoff_housing_investment"//trim(file_number)//".dat",status='replace')
            write(29,'(F15.12)') cutoff_housing_investment
        close(29)
        
        open(unit=30,file="discount_factor"//trim(file_number)//".dat",status='replace')
            write(30,'(F15.12)') discount_factor
        close(30)
        
        open(unit=30,file="discount_factor_on_child"//trim(file_number)//".dat",status='replace')
            write(30,'(F20.15)') discount_factor_on_child
        close(30)
        
        open(unit=31,file="advantage_to_owning"//trim(file_number)//".dat",status='replace')
            write(31,'(F15.12)') advantage_to_owning
        close(31)
        
        open(unit=32,file="convexity_of_rental_company"//trim(file_number)//".dat",status='replace')
            write(32,'(F15.12)') convexity_of_rental_company
        close(32)
        
        open(unit=33,file="relative_share_of_housing"//trim(file_number)//".dat",status='replace')
            write(33,'(F15.12)') relative_share_of_housing
        close(33)
        
        open(unit=33,file="relative_share_of_housing_2"//trim(file_number)//".dat",status='replace')
            write(33,'(F15.12)') relative_share_of_housing_2
        close(33)
        
        open(unit=33,file="relative_share_of_consumption_2"//trim(file_number)//".dat",status='replace')
            write(33,'(F15.12)') relative_share_of_consumption_2
        close(33)
        
        open(unit=33,file="relative_share_of_leisure"//trim(file_number)//".dat",status='replace')
            write(33,'(F15.12)') relative_share_of_leisure
        close(33)
        
        open(unit=33,file="relative_share_of_addiction"//trim(file_number)//".dat",status='replace')
            write(33,'(F15.12)') relative_share_of_addiction
        close(33)
        
        open(unit=22,file="labor_income_tax_rate"//trim(file_number)//".dat",status='replace')
            write(22,'(F15.12)') labor_income_tax_rate
        close(22)
        
        open(unit=35,file="smallest_house_size"//trim(file_number)//".dat",status='replace')
            write(35,'(F15.12)') smallest_house_size
        close(35)
        
        open(unit=35,file="minimum_inheritance"//trim(file_number)//".dat",status='replace')
            write(35,'(F15.12)') minimum_inheritance
        close(35)
                
        open(unit=35,file="size_homelessness"//trim(file_number)//".dat",status='replace')
            write(35,'(F15.12)') size_homelessness
        close(35)
                
        open(unit=35,file="max_initial_endowment"//trim(file_number)//".dat",status='replace')
            write(35,'(F15.12)') max_initial_endowment
        close(35)

        open(unit=35,file="initial_endowment"//trim(file_number)//".dat",status='replace')
            write(35,'(I3)') initial_endowment
        close(35)
                
        open(unit=36,file="size_of_smallest_house_hhld_can_buy"//trim(file_number)//".dat",status='replace')
            write(36,'(F15.12)') size_of_smallest_house_hhld_can_buy
        close(36)
                
        open(unit=37,file="model_average_owner_occupied_unit_size"//trim(file_number)//".dat",status='replace')
            write(37,'(F15.12)') model_average_owner_occupied_unit_size(time_period)
        close(37)
                
        open(unit=39,file="total_rental_demand"//trim(file_number)//".dat",status='replace')
            write(39,'(F15.12)') total_rental_demand(time_period,:)
        close(39)

        open(unit=39,file="risk_free_rate"//trim(file_number)//".dat",status='replace')
            write(39,'(F15.12)') risk_free_rate(time_period)
        close(39)

        open(unit=39,file="mortgage_interest_rate"//trim(file_number)//".dat",status='replace')
            write(39,'(F15.12)') mortgage_interest_rate(time_period)
        close(39)
        
        open(unit=39,file="smallest_financial_chosen_in_equilibrium"//trim(file_number)//".dat",status='replace')
            write(39,'(I3)') smallest_financial_chosen_in_equilibrium
        close(39)
        
        open(unit=39,file="largest_financial_chosen_in_equilibrium"//trim(file_number)//".dat",status='replace')
            write(39,'(I3)') largest_financial_chosen_in_equilibrium
        close(39)
        
        open(unit=40,file="housing_status_grid_expander"//trim(file_number)//".dat",status='replace')
            write(40,'(F15.12)') housing_status_grid_expander
        close(40)
                
        open(unit=40,file="utility_improvement"//trim(file_number)//".dat",status='replace')
            write(40,'(F15.12)') utility_improvement
        close(40)
        
        open(unit=40,file="value_of_life"//trim(file_number)//".dat",status='replace')
            write(40,'(F15.10)') value_of_life
        close(40)
        
        open(unit=40,file="total_profits"//trim(file_number)//".dat",status='replace')
            write(40,'(F15.12)') total_profits
        close(40)
        
        write(*,*) "finished saving vars and functions"
                
    end subroutine
    
    subroutine upload_vars(time_period)
    
        use Global_Vars
        
        implicit none
        
        integer, intent(in) :: time_period
        real(8), dimension(0:transition_length) :: rent_path_to_upload,house_price_path_to_upload
        
        write(*,*) "upload vars"
            
        open(unit=1,file="average_welfare_of_youngest_cohort"//trim(old_results)//".dat",action='read')
            read(1,'(F35.13)') average_welfare_of_youngest_cohort_calibrated
        close(1)
        
        open(unit=1,file="welfare_by_addiction_youngest"//trim(old_results)//".dat",action='read')
            read(1,'(F35.13)') welfare_by_addiction_youngest_calibrated(:)
        close(1)
        
        open(unit=26,file="model_total_hours"//trim(old_results)//".dat",action='read')
            read(26,'(F15.12)') total_hours_calibrated
        close(26)
        
        open(unit=26,file="model_labor_supply"//trim(old_results)//".dat",action='read')
            read(26,'(F15.12)') labor_supply_calibrated
        close(26)
        
        if (clear_only_vouchers_govt_budget==1) then
        
            open(unit=26,file="net_govt_revenues"//trim(old_results)//".dat",action='read')
                read(26,'(F15.12)') net_govt_revenue_constraint
            close(26)
        
        else

            open(unit=26,file="govt_revenues_to_use_in_tests"//trim(old_results)//".dat",action='read')
                read(26,'(F15.12)') net_govt_revenue_constraint
            close(26)
            
        end if
        
        open(unit=19,file="model_ss_benefits"//trim(old_results)//".dat",action='read')
            read(19,'(F15.12)') model_ss_benefits
        close(19)
        
        open(unit=19,file="income_cutoffs_of_quintiles"//trim(old_results)//".dat",action='read')
            read(19,'(F15.12)') income_cutoffs_of_quintiles
        close(19)
            
        open(unit=19,file="model_bequests"//trim(old_results)//".dat",action='read')
            read(19,'(F15.12)') model_bequests
        close(19)
                    
        open(unit=20,file="c_1"//trim(old_results)//".dat",action='read')
            read(20,'(F20.12)') c_1
        close(20)
                    
        c_1_calibrated=c_1
        
        open(unit=21,file="c_min"//trim(old_results)//".dat",action='read')
            read(21,'(F20.12)') c_min
        close(21)
        
        c_min_calibrated=c_min
                        
        open(unit=22,file="housing_price"//trim(old_results)//".dat",action='read')
            read(22,'(F15.12)') housing_price(time_period)
        close(22)
        
        calibrated_stationary_housing_price=housing_price(time_period)
                
        open(unit=23,file="rent"//trim(old_results)//".dat",action='read')
            read(23,'(F15.12)') rent(time_period,:)
        close(23)
                    
        rent_calibrated=rent(time_period,:)
        model_average_rent(time_period)=rent_calibrated(0)
                     
        open(unit=24,file="housing_stock"//trim(old_results)//".dat",action='read')
            read(24,'(F15.12)') housing_stock(time_period-solve_transition_dynamics)
        close(24)
        
        calibrated_housing_stock=housing_stock(time_period-solve_transition_dynamics)
        
        do i=1-solve_transition_dynamics,transition_length
        
            housing_stock(i)=calibrated_housing_stock
            
        end do
                        
        open(unit=26,file="net_govt_revenues"//trim(old_results)//".dat",action='read')
            read(26,'(F15.12)') net_govt_revenues(time_period)
        close(26)
        
        open(unit=27,file="rental_management_costs"//trim(old_results)//".dat",action='read')
            read(27,'(F30.29)') rental_management_costs
        close(27)
                    
        rental_management_costs_calibrated=rental_management_costs
                
        open(unit=28,file="cutoff_housing_investment"//trim(old_results)//".dat",action='read')
            read(28,'(F15.12)') cutoff_housing_investment
        close(28)
        
        cutoff_housing_investment_calibrated=cutoff_housing_investment
                
        open(unit=27,file="increase_in_labour_income_tax"//trim(old_results)//".dat",action='read')
            read(27,'(F30.28)') increase_in_labour_income_tax
        close(27)
                                            
        open(unit=28,file="standard_deduction"//trim(old_results)//".dat",action='read')
            read(28,'(F15.12)') standard_deduction
        close(28)      

        open(unit=28,file="personal_exemption"//trim(old_results)//".dat",action='read')
            read(28,'(F15.12)') personal_exemption
        close(28)
                    
        open(unit=30,file="discount_factor"//trim(old_results)//".dat",action='read')
            read(30,'(F15.12)') discount_factor
        close(30)
        
        open(unit=30,file="discount_factor_on_child"//trim(old_results)//".dat",action='read')
            read(30,'(F20.15)') discount_factor_on_child
        close(30)
        
        open(unit=30,file="labor_income_tax_rate"//trim(old_results)//".dat",action='read')
            read(30,'(F15.12)') labor_income_tax_rate
        close(30)
        
        open(unit=31,file="advantage_to_owning"//trim(old_results)//".dat",action='read')
            read(31,'(F15.12)') advantage_to_owning
        close(31)
        
        open(unit=32,file="convexity_of_rental_company"//trim(old_results)//".dat",action='read')
            read(32,'(F15.12)') convexity_of_rental_company
        close(32)
        
        open(unit=33,file="relative_share_of_housing"//trim(old_results)//".dat",action='read')
            read(33,'(F15.12)') relative_share_of_housing
        close(33)
        
        if (change_utility_for_addicts==1) then
        
            open(unit=33,file="relative_share_of_housing_2"//trim(old_results)//".dat",action='read')
                read(33,'(F15.12)') relative_share_of_housing_2
            close(33)
            
        end if
        
        if (change_utility_for_addicts==1) then
        
            open(unit=33,file="relative_share_of_consumption_2"//trim(old_results)//".dat",action='read')
                read(33,'(F15.12)') relative_share_of_consumption_2
            close(33)
            
        end if
        
        open(unit=33,file="relative_share_of_leisure"//trim(old_results)//".dat",action='read')
            read(33,'(F15.12)') relative_share_of_leisure
        close(33)
        
        open(unit=33,file="relative_share_of_addiction"//trim(old_results)//".dat",action='read')
            read(33,'(F15.12)') relative_share_of_addiction
        close(33)
        
        open(unit=33,file="inheritance_amount"//trim(old_results)//".dat",action='read')
            read(33,'(F15.12)') inheritance_amount
        close(33)
        
        open(unit=33,file="utility_improvement"//trim(old_results)//".dat",action='read')
            read(33,'(F15.12)') utility_improvement
        close(33)
        
        open(unit=33,file="value_of_life"//trim(old_results)//".dat",action='read')
            read(33,'(F15.10)') value_of_life
        close(33)
        
        open(unit=33,file="smallest_financial_chosen_in_equilibrium"//trim(old_results)//".dat",action='read')
            read(33,'(I3)') smallest_financial_chosen_in_equilibrium
        close(33)
        
        open(unit=37,file="model_average_owner_occupied_unit_size"//trim(old_results)//".dat",action='read')
            read(37,'(F15.12)') model_average_owner_occupied_unit_size(time_period)
        close(37)
        
        average_owner_occupied_house_size_calibrated=model_average_owner_occupied_unit_size(time_period)

        open(unit=37,file="labor_income_tax_rate"//trim(old_results)//".dat",action='read')
            read(37,'(F15.12)') labor_income_tax_rate
        close(37)

        open(unit=35,file="smallest_house_size"//trim(old_results)//".dat",action='read')
            read(35,'(F15.12)') smallest_house_size
        close(35)
        
        open(unit=35,file="minimum_inheritance"//trim(old_results)//".dat",action='read')
            read(35,'(F15.12)') minimum_inheritance
        close(35)
        
        open(unit=35,file="size_homelessness"//trim(old_results)//".dat",action='read')
            read(35,'(F15.12)') size_homelessness
        close(35)
                
        open(unit=35,file="max_initial_endowment"//trim(old_results)//".dat",action='read')
            read(35,'(F15.12)') max_initial_endowment
        close(35)

        open(unit=35,file="initial_endowment"//trim(old_results)//".dat",action='read')
            read(35,'(I3)') initial_endowment
        close(35)
                
        open(unit=36,file="size_of_smallest_house_hhld_can_buy"//trim(old_results)//".dat",action='read')
            read(36,'(F15.12)') size_of_smallest_house_hhld_can_buy
        close(36)
        
        size_of_smallest_house_hhld_can_buy=size_of_smallest_house_hhld_can_buy-0.01
                        
        open(unit=39,file="total_rental_supply"//trim(old_results)//".dat",action='read')
            read(39,'(F15.12)') total_rental_supply(time_period-solve_transition_dynamics,:)
        close(39)
                    
        total_rental_supply_calibrated(:)=total_rental_supply(time_period-solve_transition_dynamics,:)
                 
        open(unit=39,file="total_rental_demand"//trim(old_results)//".dat",action='read')
            read(39,'(F15.12)') total_rental_demand(time_period-solve_transition_dynamics,:)
        close(39)
        
        open(unit=40,file="housing_stock"//trim(old_results)//".dat",action='read')
            read(40,'(F15.12)') total_housing_demand(time_period-solve_transition_dynamics)
        close(40)
            
        open(unit=39,file="risk_free_rate"//trim(old_results)//".dat",action='read')
            read(39,'(F15.12)') risk_free_rate(time_period)
        close(39)
        
        open(unit=39,file="mortgage_interest_rate"//trim(old_results)//".dat",action='read')
            read(39,'(F15.12)') mortgage_interest_rate(time_period)
        close(39)

        open(unit=18,file="average_labor_income"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_labour_income(time_period)
        close(18)
            
        open(unit=18,file="model_average_income"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_income(time_period)
        close(18)
        
        open(unit=18,file="model_average_income_plus_assets"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_income_plus_assets(time_period)
        close(18)
        
        open(unit=18,file="model_average_income_plus_all_assets"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_income_plus_all_assets(time_period)
        close(18)

        open(unit=18,file="median_income"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') median_income(time_period)
        close(18)
        
        median_income_calibrated=median_income(time_period)
        
        open(unit=18,file="model_average_financial"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_financial(time_period)
        close(18)
        
        open(unit=18,file="model_bequests"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_bequests(time_period)
        close(18)
        
        open(unit=18,file="model_average_rental_unit_size"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_rental_unit_size(time_period)
        close(18)
        
        open(unit=18,file="model_average_net_wealth"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_net_wealth(time_period)
        close(18)
        
        open(unit=18,file="average_labor_income_by_employment"//trim(old_results)//".dat",action='read')
            read(18,'(F15.12)') model_average_labour_income_by_employment(time_period,:)
        close(18)
                
        open(unit=19,file="housing_status_grid_expander"//trim(old_results)//".dat",action='read')
            read(19,'(F15.12)') housing_status_grid_expander
        close(19)
                
        average_labor_income_calibrated=model_average_labour_income(time_period)
        average_labor_income_by_employment_calibrated=model_average_labour_income_by_employment(time_period,:)
        average_financial_calibrated=model_average_financial(time_period)
        average_net_wealth_calibrated=model_average_net_wealth(time_period)
                
        if (solve_transition_dynamics==1) then
        
            open(unit=38,file="total_rental_supply"//trim(long_run_simulation)//".dat",action='read')
                read(38,'(F15.12)') total_rental_supply(transition_length,:)
            close(38)
                        
            open(unit=39,file="total_rental_demand"//trim(long_run_simulation)//".dat",action='read')
                read(39,'(F15.12)') total_rental_demand(transition_length,:)
            close(39)
                        
            if (use_old_transition_results==1) then
            
!                open(unit=22,file="total_rental_demand_in_transition"//trim(old_transition_resuls)//".txt",action='read')
!                    read(22,'(F15.8)') total_rental_demand
!                close(22)
                                    
            end if
            
            open(unit=40,file="housing_stock"//trim(long_run_simulation)//".dat",action='read')
                read(40,'(F15.12)') total_housing_demand(transition_length)
            close(40)

            housing_stock(transition_length)=total_housing_demand(transition_length)

            open(unit=39,file="risk_free_rate"//trim(long_run_simulation)//".dat",action='read')
                read(39,'(F15.12)') risk_free_rate(transition_length)
            close(39)
            
            open(unit=22,file="housing_price"//trim(long_run_simulation)//".dat",action='read')
                read(22,'(F15.12)') housing_price(transition_length)
            close(22)
            
            if (use_old_transition_results==1) then
            
!                open(unit=22,file="housing_price_in_transition"//trim(old_transition_resuls)//".txt",action='read')
!                    read(22,'(F15.8)') house_price_path_to_upload
!                close(22)
!                
!                housing_price(1-solve_transition_dynamics:transition_length-1)=&
!                    house_price_path_to_upload(1-solve_transition_dynamics:transition_length-1)
                
                if (transition_length==50) then
                                        
    !                 housing_price(1:transition_length)=&
    !                      (/13.041107,13.114704,13.126625,13.126839,13.127742,13.127653,13.127916,13.127622,13.127761,&
    !                        13.127910,13.127709,13.127834,13.127861,13.127859,13.127664,13.127770,13.127851,13.127974,&
    !                        13.127783,13.127539,13.127744,13.127885,13.127873,13.127689,13.128012,13.127921,13.127932,&
    !                        13.127871,13.127711,13.127718,13.127428,13.127425,13.127548,13.127466,13.128055,13.127601,&
    !                        13.127728,13.127881,13.127757,13.127724,13.127594,13.127795,13.128068,13.127644,13.127847,&
    !                        13.127597,13.127908,13.127263,13.126763,13.126554,13.123998,13.118515,13.116499,13.115342,&
    !                        13.114380,13.113955,13.113886,13.113934,13.114014,13.114203,13.114305,13.114377,13.114285,&
    !                        13.114007,13.113740,13.113662,13.113587,13.113590,13.113571,13.113582,13.113064,13.113107,&
    !                        13.112103,13.108264,13.106005/)
                        
                end if
                
            end if

            long_run_stationary_housing_price=housing_price(transition_length)
                            
            open(unit=23,file="rent"//trim(long_run_simulation)//".dat",action='read')
                read(23,'(F15.12)') rent(transition_length,:)
            close(23)
            
            model_average_rent(time_period)=rent(transition_length,0)
            
            if (use_old_transition_results==1) then
            
!                open(unit=23,file="rent_in_transition"//trim(old_transition_resuls)//".txt",action='read')
!                    read(23,'(F15.8)') rent_path_to_upload(0:transition_length)
!                close(23)
!                
!                rent(1-solve_transition_dynamics:transition_length-1,1)=&
!                    rent_path_to_upload(1-solve_transition_dynamics:transition_length-1)
                            
                if (transition_length==50) then
                
    !                rent(1:transition_length,1)=&
    !                  (/0.726564480,0.736556720,0.738740420,0.739224540,0.740293850,0.740113940,0.740118140,0.739830050,&
    !                  0.739761090,0.739524080,0.738892860,0.739161740,0.739055400,0.738924460,0.739024880,0.739048080,&
    !                  0.739090530,0.739573890,0.739594100,0.739935210,0.740069190,0.740091760,0.740094520,0.740350990,&
    !                  0.740055590,0.740278620,0.740169140,0.740213630,0.740252000,0.740306260,0.740135580,0.739957410,&
    !                  0.739834640,0.739392250,0.739245250,0.738874220,0.738592750,0.738359330,0.738234460,0.738071790,&
    !                  0.737718710,0.737473560,0.737231170,0.736898430,0.736700620,0.736631060,0.736479130,0.736369110,&
    !                  0.736216990,0.736181560,0.736263150,0.736253550,0.736356410,0.736494780,0.736557380,0.736561750,&
    !                  0.736526840,0.736565640,0.736572270,0.736559430,0.736563360,0.736548790,0.736546600,0.736556940,&
    !                  0.736529630,0.736493160,0.736457650,0.736553330,0.736516010,0.736658030,0.736328580,0.736100620,&
    !                  0.736094260,0.737016750,0.736271080/)
                        
                end if
                        
            end if
        
            long_run_rent=rent(transition_length,:)
                            
            open(unit=24,file="housing_stock"//trim(long_run_simulation)//".dat",action='read')
                read(24,'(F15.12)') housing_stock(transition_length)
            close(24)
            
            long_run_housing_stock=housing_stock(transition_length)
                        
            open(unit=23,file="lump_sum_transfer"//trim(long_run_simulation)//".dat",action='read')
                read(23,'(F15.12)') lump_sum_transfer(transition_length)
            close(23)
            
            if (use_old_transition_results==1) then
            
!                open(unit=23,file="lump_sum_transfer_in_transition"//trim(old_transition_resuls)//".txt",action='read')
!                    read(23,'(F15.8)') lump_sum_transfer(1-solve_transition_dynamics:transition_length)
!                close(23)
                
                if (transition_length==50) then
                    
!                    lump_sum_transfer(1:transition_length)=&
!                        (/0.000208590,0.000523710,0.000616230,0.000665130,0.000680170,0.000674900,0.000692730,0.000673240,&
!                        0.000690790,0.000705100,0.000666710,0.000692830,0.000713110,0.000707740,0.000676330,0.000719680,&
!                        0.000718150,0.000740360,0.000703390,0.000680840,0.000731710,0.000727320,0.000753260,0.000731800,&
!                        0.000770550,0.000758910,0.000769430,0.000775350,0.000738170,0.000755190,0.000736920,0.000733410,&
!                        0.000764890,0.000752370,0.000814300,0.000750750,0.000773230,0.000799150,0.000767870,0.000772980,&
!                        0.000756820,0.000813730,0.000839190,0.000758200,0.000810360,0.000790320,0.000822710,0.000818260,&
!                        0.000801750,0.000857220,0.000824620,0.000775520,0.000749900,0.000741570,0.000727480,0.000722300,&
!                        0.000720840,0.000720660,0.000720940,0.000721000,0.000722140,0.000721670,0.000723700,0.000720850,&
!                        0.000722810,0.000729920,0.000744430,0.000733090,0.000739210,0.000737460,0.000740690,0.000739090,&
!                        0.000733970,0.000711430,0.000708480/)
                          
                end if
                
            end if
                    
        end if
        
        write(*,*) "finished uploading vars"
                
    end subroutine
    
    subroutine write_outputs(time_period)
    
        use Global_Vars  
        
        implicit none
        
        integer,intent(in):: time_period
        real(8), dimension(employment_grid_size) :: sum_of_distribution_employment_all,&
            sum_of_distribution_employment,sum_of_youngest_employment,sum_of_retired_employment
        real(8) :: sum_of_retired,sum_of_non_retired,sum_at_top_financial,sum_of_youngest
        character*1 :: string_used
        character*1 :: string_used_1
        character*2 :: string_used_2
        character*3 :: string_used_3
        character*4 :: string_used_4
        character*40 :: string_used_20
        character*10 :: string_used_10
        
        sum_of_distribution=0
        sum_of_retired=0
        sum_of_non_retired=0
        sum_at_top_financial=0
        sum_of_youngest=0
        sum_of_youngest_employment=0
        
        do i=1,2
                
            sum_of_distribution=sum_of_distribution+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,:,:,:))
                
            sum_of_non_retired=sum_of_non_retired+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,1:life_span-retirement_span,:,:,:,:,:)) 
                
            sum_of_retired=sum_of_retired+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,life_span-retirement_span+1:life_span,:,:,:,:,:)) 
                
            sum_at_top_financial=sum_at_top_financial+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,:,financial_grid_size,:,:,:,:)) 
                
            sum_of_youngest=sum_of_youngest+&
                sum(distribution_stationary(i)%vector_transition_real(time_period,1,:,:,:,:,:)) 
            
        end do
        
        sum_of_distribution_employment(:)=0
        sum_of_distribution_employment_all(:)=0
        sum_of_retired_employment(:)=0
        
        do j=1,employment_grid_size
        
            do i=1,2
            
                sum_of_distribution_employment(j)=sum_of_distribution_employment(j)+&
                    sum(distribution_stationary(i)%vector_transition_real&
                    (time_period,1:life_span-retirement_span,:,:,j,:,:))
                    
                sum_of_distribution_employment_all(j)=&
                    sum_of_distribution_employment_all(j)+&
                    sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,j,:,:))
                    
                sum_of_youngest_employment(j)=sum_of_youngest_employment(j)+&
                    sum(distribution_stationary(i)%vector_transition_real(time_period,1,:,:,j,:,:))
                    
                sum_of_retired_employment(j)=sum_of_retired_employment(j)+&
                    sum(distribution_stationary(i)%vector_transition_real&
                    (time_period,life_span-retirement_span+1:life_span,:,:,j,:,:))
                
            end do
            
        end do
        
        open(unit=2,file=trim(file_number)//".txt",action="write",status="replace")        
            write(2,*) "fraction_to_repay_each_period,", fraction_to_repay
            write(2,*) "price_of_addictive_good,", price_of_addictive_good
            write(2,*) "relative_price_change,", relative_price_change
            write(2,*) "price_of_addictive_good_benchmark,", price_of_addictive_good_benchmark
            write(2,*) "use_income_or_income_plus_assets,", use_income_or_income_plus_assets
            write(2,*) "remove_increased_death,", remove_increased_death
            write(2,*) "reduce_ss_by_half,", reduce_ss_by_half
            write(2,*) "adjust_inheritance,", adjust_inheritance
            write(2,*) "raise_b,", raise_b
            write(2,*) "change_utility_of_addicts,", change_utility_for_addicts
            write(2,*) "max_age_to_choose_addiction,", max_age_to_choose_addiction
            write(2,*) "max_age_to_choose_homelessness,", max_age_to_choose_homelessness
            write(2,*) "difference_in_perceived_of_becoming_addicted_if_experiment,", &
                difference_in_perceived_of_becoming_addicted_if_experiment
            write(2,*) "increase_in_newborns_bequests,", increase_in_newborns_bequests
            write(2,*) "perceived_probability_lower,", perceived_probability_lower
            write(2,*) "double_voucher_program,", double_voucher_program
            write(2,*) "clear_only_vouchers_govt_budget,", clear_only_vouchers_govt_budget
            write(2,*) "voucher_conditional_on_clean,", voucher_conditional_on_clean
            write(2,*) "voucher_conditional_on_clean_just_addicts,", voucher_conditional_on_clean_just_addicts
            write(2,*) "is_counterfactual,", is_counterfactual
            write(2,*) "total income-total expenditures,", &
                abs(model_output(time_period)+model_total_investment_income(time_period)-&
                (aggregate_consumption(time_period)+aggregate_spending_on_addiction(time_period)+&
                aggregate_housing_consumption(time_period)+aggregate_mortgage_consumption(time_period)+&
                aggregate_housing_transaction_costs(time_period)+aggregate_origination_costs(time_period)+&
                aggregate_prepayment_costs(time_period)+aggregate_moving_costs(time_period)+&
                govt_revenues_to_use_in_tests(time_period)+&
                govt_ss_wasted(time_period)+govt_spending_on_homeless(time_period)+govt_spending_on_addicts(time_period)+&
                (1-include_property_taxes_in_govt_constraint)*govt_revenues_from_property_tax(time_period)+&
                aggregate_rent_spending(time_period)-housing_price(time_period)*&
                sum(total_rental_demand(time_period-solve_transition_dynamics,:))*&
                property_tax(time_period-solve_transition_dynamics)))
            write(2,*) "sum_of_distribution,", sum_of_distribution
            write(2,*) "sum_of_retirees,", sum_of_retirees
            write(2,*) "sum_of_retirees/sum_of_distribution,", sum_of_retirees/sum_of_distribution
            write(2,*) "model_average_ss_benefits/model_average_labour_income,", &
                model_average_ss_benefits(time_period)/model_average_labour_income(time_period)
            write(2,*) "do_internal_computations,", do_internal_computations
            write(2,*) "prepayment_penalty_starts_from,", prepayment_penalty_starts_from
            write(2,*) "cost_to_originate_mortgage_relative_to_income,", mortgage_origination_cost
            write(2,*) "ss_decrease_addicted,", ss_decrease_addicted
            write(2,*) "scaling_of_ss,", scaling_of_ss
            write(2,*) "productivity_below_which_to_reduce_ss,", productivity_below_which_to_reduce_ss
            write(2,*) "probability_of_voucher,", probability_of_voucher
            write(2,*) "probability_of_voucher_benchmark,", probability_of_voucher_benchmark
            write(2,*) "probability_of_voucher_benchmark_used_1,", probability_of_voucher_benchmark_used_1
            write(2,*) "increased_prob_of_voucher_if_homeless,", increased_prob_of_voucher_if_homeless
            write(2,*) "increased_prob_of_voucher_if_homeless_1,", increased_prob_of_voucher_if_homeless_1
            write(2,*) "increased_prob_of_voucher_if_homeless_and_addicted,", &
                increased_prob_of_voucher_if_homeless_and_addicted
            write(2,*) "probability_of_stopping_addiction", probability_of_stopping_addiction
            write(2,*) "probability_of_stopping_addiction_if_homeless,", &
                probability_of_stopping_addiction_if_homeless
            write(2,*) "years_of_interest_in_penalty,", penalty_months_of_interest
            write(2,*) "max_fraction_of_income_spent_on_housing,", max_fraction_of_income_spent_on_housing
            write(2,*) "max_rent_relative_to_ave,", max_rent_relative_to_ave
            write(2,*) "inheritance_amount,", inheritance_amount
            write(2,*) "number_of_inheritance_ages,", number_of_inheritance_ages
            write(2,*) "inheritance_age_grid,", inheritance_age_grid
            write(2,*) "relative_share_of_housing,", relative_share_of_housing
            write(2,*) "risk_aversion_consumption,", risk_aversion_consumption
            write(2,*) "relative_share_of_leisure,", relative_share_of_leisure
            write(2,*) "relative_share_of_addiction,", relative_share_of_addiction
            write(2,*) "advantage_to_owning,", advantage_to_owning
            write(2,*) "discount factor,", discount_factor
            write(2,*) "discount_factor_on_child,", discount_factor_on_child
            write(2,*) "labor_income_tax_rate,", labor_income_tax_rate
            write(2,*) "curvature_of_labor_income_taxes,", curvature_of_labor_income_taxes
            write(2,*) "personal_exemption,", personal_exemption 
            write(2,*) "standard_deduction,", standard_deduction
            write(2,*) "minimum_inheritance,", minimum_inheritance
            write(2,*) "size_homelessness,", size_homelessness
            write(2,*) "utility_improvement,", utility_improvement
            write(2,*) "addiction_scalar_1,", addiction_scalar_1
            write(2,*) "convexity_of_rental_company,", convexity_of_rental_company
            write(2,*) "max_initial_endowment,", max_initial_endowment
            write(2,*) "rental_management_costs,", rental_management_costs
            write(2,*) "value_of_initial_assets,", value_of_initial_assets
            write(2,*) "model_homeownership_rate,", model_homeownership_rate(time_period)
            write(2,*) "model_fraction_homeless,", model_fraction_homeless(time_period)
            write(2,*) "model_homeless_2_years_or_more,", model_homeless_2_years_or_more(time_period)
            write(2,*) "profile_of_chronic_homeless", profile_of_chronic_homeless(time_period,:)             
            write(2,*) "model_homelessness_old,", model_homelessness_old(time_period)
            write(2,*) "model_profile_of_homeless_old,", model_profile_of_homeless_old(:)
            write(2,*) "model_fraction_homeless_owners,", model_fraction_homeless_owners(time_period)
            write(2,*) "model_fraction_addicted,", model_fraction_addicted(time_period)
            write(2,*) "model_exprimenters,", model_exprimenters(time_period)
            write(2,*) "model_exprimenters+model_fraction_addicted,", &
                model_exprimenters(time_period)+model_fraction_addicted(time_period)
            write(2,*) "model_exprimenters/model_total_drug_users,", model_exprimenters(time_period)/&
                model_total_drug_users(time_period)
            write(2,*) "model_addicted_total_addiction_spending_to_total_income,", &
                model_addicted_total_addiction_spending_to_total_income(time_period) 
            write(2,*) "model_experimenters_total_drug_spending_to_total_income", &
                model_experimenters_total_drug_spending_to_total_income(time_period)
            write(2,*) "model_addicts_consuming_no_drugs,", model_addicts_consuming_no_drugs(time_period)
            write(2,*) "model_drugs_used_by_users_on_average,", model_drugs_used_by_users_on_average(time_period)
            write(2,*) "model_drugs_used_by_experimenters_on_average,", model_drugs_used_by_experimenters_on_average(time_period)
            write(2,*) "model_drugs_consumed_by_users,", model_drugs_consumed_by_users(time_period)
            write(2,*) "model_drugs_used_by_addicts_on_average,", model_drugs_used_by_addicts_on_average(time_period)
            write(2,*) "model_homeowners_experimenting,", model_homeowners_experimenting(time_period)
            write(2,*) "model_average_assets_homeless_by_addiction,", model_average_assets_homeless_by_addiction(time_period,:)
            write(2,*) "model_average_income_homeless_by_addiction,", model_average_income_homeless_by_addiction(time_period,:)
            write(2,*) "model_average_income_addicted,", model_average_income_addicted(time_period)
            write(2,*) "model_average_assets_addicted,", model_average_assets_addicted(time_period)
            write(2,*) "model_age_by_addiction,", model_age_by_addiction(time_period,:)
            write(2,*) "multiple_of_probabilities_of_employment_if_addicted,", &
                multiple_of_probabilities_of_employment_if_addicted
            write(2,*) "model_fraction_addicted_who_are_homeless,", model_fraction_addicted_who_are_homeless(time_period)
            write(2,*) "model_fraction_addicted_and_unemployed,", model_fraction_addicted_and_unemployed(time_period)
            write(2,*) "model_fraction_homeless_and_addicted,", model_fraction_homeless_and_addicted(time_period)
            write(2,*) "model_fraction_unemployed,", model_fraction_unemployed(time_period)
            write(2,*) "model_fraction_unemployed_on_ui,", model_fraction_unemployed_on_ui(time_period)
            write(2,*) "model_fraction_of_homeless_unemployed,", model_fraction_of_homeless_unemployed(time_period)
            write(2,*) "model_fraction_of_homeless_and_addicted_unemployed,", &
                model_fraction_of_homeless_and_addicted_unemployed(time_period)
            write(2,*) "model_avg_homeless_income,", model_avg_homeless_income(time_period)
            write(2,*) "model_avg_homeless_income/model_average_labour_income.", &
                model_avg_homeless_income(time_period)/model_average_labour_income(time_period)
            write(2,*) "model_average_income_addicted/model_average_labour_income.", &
                model_average_income_addicted(time_period)/model_average_labour_income(time_period)
            write(2,*) "model_avg_homeless_after_tax_income,", model_avg_homeless_after_tax_income(time_period)
            write(2,*) "housing_size(0)/model_average_owner_occupied_unit_size,",  &
                housing_size(0)/model_average_owner_occupied_unit_size(time_period)
            write(2,*) "rent of smallest_rental,", rent(time_period,0)*housing_size(0)
            write(2,*) "rent to income of homeless,", rent(time_period,0)*housing_size(0)/&
                model_avg_homeless_after_tax_income(time_period)
            write(2,*) "median_income,", median_income(time_period)
            write(2,*) "percentiles_homeless_income,", percentiles_homeless_income(time_period,:)
            write(2,*) "percentiles_homeless_income/median_income,", &
                percentiles_homeless_income(time_period,:)/median_income(time_period)
            write(2,*) "housing_supplpy_elasticity_data,", empirical_housing_supplpy_elasticity
            write(2,*) "house_price,", housing_price(time_period)
            write(2,*) "rent,", rent(time_period,:)
            write(2,*) " model_average_rent,",  model_average_rent(time_period)
            write(2,*) "rent/house_price,", rent(time_period,0)/housing_price(time_period)
            write(2,*) "HO,", 100*(model_homeownership_rate(time_period))
            write(2,*) "avg_housing_spending_all,", 100*(model_avg_housing_spending_all(time_period))
            write(2,*) "avg_housing_spending_renters,", 100*(model_avg_housing_spending_renters(time_period))
            write(2,*) "MID_to_GDP,", 100*(govt_spending_on_mortgage_interest_deductions(time_period)/&
                model_GDP_incl_imput_rent(time_period))
            write(2,*) "model_youngest_net_wealth_share,", model_youngest_net_wealth_share(time_period)
            write(2,*) "mortgage_debt_to_housing_wealth,", &
                100*(model_mortgages(time_period)/model_gross_housing_wealth(time_period))
            write(2,*) "model_total_net_wealth/model_GDP_incl_imput_rent,", &
                model_total_net_wealth(time_period)/model_GDP_incl_imput_rent(time_period)
            write(2,*) "standard_deduction/avg_labor_income,", 100*(standard_deduction/model_average_labour_income(time_period))
            write(2,*) "avg_owned_house_to_avg_labor_income_ratio,", &
                housing_price(time_period)*model_average_owner_occupied_unit_size(time_period)/&
                (model_average_labour_income(time_period))
            write(2,*) "avg_(owned_house_to_income),", model_average_owner_occupied_unit_size_to_income(time_period)
            write(2,*) "avg_(owned_house_to_income)_working_age,", &  
                model_average_owner_occupied_unit_size_to_income_work_age(time_period)
            write(2,*) "avg_(owned_house_to_avg_owner_income),", &
                (model_average_owner_occupied_unit_size(time_period)*housing_price(time_period))/&
                model_average_owners_income(time_period)
            write(2,*) "avg_rental_value_as_perc_of_owned_house_value,", &
                100*(model_average_rental_unit_size(time_period)/model_average_owner_occupied_unit_size(time_period))
            write(2,*) "smallest_rental_to_owned_house_value,", &
                100*(housing_size(0)/model_average_owner_occupied_unit_size(time_period))
            write(2,*) "housing_price*model_average_owner_occupied_unit_size/model_average_labour_income,", &
                housing_price(time_period)*model_average_owner_occupied_unit_size(time_period)/&
                model_average_labour_income(time_period)
            write(2,*) "average_labour_income_tax,", model_average_labour_income_tax(time_period)
            write(2,*) "median_income,", median_income(time_period)
            write(2,*) "theta_1*S^theta_2-1_/pr,", &
                100*(rental_management_costs*convexity_of_rental_company(:)*&
                total_rental_supply(time_period,:)**(convexity_of_rental_company(:)-1))/rent(time_period,:)
            write(2,*) "homeowners_refinancing_own_home,", 100*(homeowners_refinancing_own_home(time_period)/&
                (model_homeownership_rate(time_period)*sum_of_distribution))
            write(2,*) "refinanced_mortgages_to_total_mortgage,", &
                100*(refinanced_mortgages(time_period)/model_mortgages(time_period))
            write(2,*) "homeowners_refinancing_relative_to_all_originations,", &
                100*(homeowners_refinancing_own_home(time_period)/homeowners_originating_mortgage(time_period))
            write(2,*) "model_average_LTV_at_orgination,", model_average_LTV_at_orgination(time_period)
            write(2,*) "model_average_LTV_at_orgination_home_switchers,", model_average_LTV_at_orgination_2(time_period)
            if (check_tax_incidence==1) then
                write(2,*) "property_tax_incidence,", model_fraction_of_property_tax_paid_by_renters(time_period)
            end if
            if (check_elascitity==1) then
                write(2,*) "property_tax_incidence,", &
                    (total_rental_supply(time_period,:)/total_rental_supply_calibrated(:)-1)/&
                    ((total_rental_supply(time_period,:)/total_rental_supply_calibrated(:)-1)+&
                    abs(total_rental_demand(time_period,:)/total_rental_supply_calibrated(:)-1))
            end if
            do i=0,housing_status_grid_size-1
                write(2,*) "renters_by_rental,", i ,",", renters_by_rental(time_period,i)
            end do
            write(2,*) "total_rental_demand_segmented,", total_rental_demand_segmented(time_period,:)
            write(2,*) "rental_stock,", total_rental_supply(time_period,:)
            write(2,*) "rental_stock_to_housing_stock,", 100*(sum(total_rental_supply(time_period,:))/housing_stock(time_period))
            write(2,*) "net_wealth_to_GDP,", model_total_net_wealth(time_period)/model_GDP(time_period)
            write(2,*) "aggregate_consumption_to_GDP,", aggregate_consumption(time_period)/model_GDP(time_period)
            write(2,*) "aggregate_consumption_to_GDP_with_imputed_rents,", &
                aggregate_consumption(time_period)/model_GDP_incl_imput_rent(time_period)
            write(2,*) "mortgage_deductibility,", mortgage_deductibility
            write(2,*) "check_tax_incidence,", check_tax_incidence+check_elascitity
            write(2,*) "model_fraction_recieving_food_stamps,", &
                model_fraction_recieving_food_stamps(1)/sum_of_distribution
            write(2,*) "model_fraction_homeless_recieving_food_stamps,", &
                model_fraction_homeless_recieving_food_stamps(time_period)
            write(2,*) "model_food_stamps_share_to_homeless,", &
                model_food_stamps_share_to_homeless(time_period)
            write(2,*) "model_fraction_recieving_housing_vouchers,", &
                model_fraction_recieving_housing_vouchers(time_period)/sum_of_distribution
            write(2,*) "model_eligibles_getting_voucher,", model_eligibles_getting_voucher(time_period)
            write(2,*) "model_eligibles_getting_voucher_relative_to_pop,", &
                model_eligibles_getting_voucher_relative_to_pop(time_period)
            write(2,*) "model_addicts_getting_voucher,", model_addicts_getting_voucher(time_period)
            write(2,*) "model_experimenters_getting_voucher,", model_experimenters_getting_voucher(time_period)
            write(2,*) "model_drug_users_getting_voucher,", model_drug_users_getting_voucher(time_period)
            write(2,*) "model_avg_income_experimenters,", model_avg_income_experimenters(time_period)
            write(2,*) "model_avg_income_experimenters/model_average_labour_income,", &
                model_avg_income_experimenters(time_period)/model_average_labour_income(time_period)
            write(2,*) "model_avg_income_drug_users/model_average_labour_income,", &
                model_avg_income_drug_users(time_period)/model_average_labour_income(time_period)
            write(2,*) "model_avg_assets_experimenters,", model_avg_assets_experimenters(time_period)
            write(2,*) "model_avg_assets_experimenters/model_average_net_wealth,", &
                model_avg_assets_experimenters(time_period)/model_average_net_wealth(time_period)
            write(2,*) "model_average_assets_addicted/model_average_net_wealth,", &
                model_average_assets_addicted(time_period)/model_average_net_wealth(time_period)
            write(2,*) "model_average_assets_drug_users/model_average_net_wealth,", &
                model_average_assets_drug_users(time_period)/model_average_net_wealth(time_period)
            write(2,*) "model_net_wealth_owners/model_net_wealth_renters,", &
                model_net_wealth_owners(time_period)/model_net_wealth_renters(time_period)
            write(2,*) "total_govt_revenues,", total_govt_revenues(time_period)
            write(2,*) "net_govt_revenues,", net_govt_revenues(time_period)
            write(2,*) "100*(net_govt_revenues/model_GDP),", 100*(net_govt_revenues(time_period)/model_GDP(time_period))
            write(2,*) "100*(total_govt_revenues/model_GDP),", 100*(total_govt_revenues(time_period)/model_GDP(time_period))
            write(2,*) "govt_revenues_from_labour_income,", govt_revenues_from_labour_income(time_period)
            write(2,*) "govt_revenues_from_consumption,", govt_revenues_from_consumption(time_period)
            write(2,*) "govt_revenues_from_investment_income,", govt_revenues_from_investment_income(time_period)
            write(2,*) "govt_revenues_from_property_tax,", govt_revenues_from_property_tax(time_period)
            write(2,*) "govt_spending_on_housing_vouchers,", govt_spending_on_housing_vouchers(time_period)
            write(2,*) "govt_spending_on_housing_vouchers_2,", govt_spending_on_housing_vouchers_2(time_period)
            write(2,*) "govt_spending_on_homeless,", govt_spending_on_homeless(time_period)
            write(2,*) "govt_spending_on_addicts,", govt_spending_on_addicts(time_period)
            write(2,*) "govt_spending_on_food_stamps,", govt_spending_on_food_stamps(time_period)
            write(2,*) "govt_spending_on_ss,", govt_spending_on_ss(time_period)
            write(2,*) "govt_spending_on_food_stamps/model_output,", &
                govt_spending_on_food_stamps(time_period)/model_output(time_period)
            write(2,*) "model_labor_supply,", model_labor_supply(time_period)
            write(2,*) "model_labor_supply/labor_supply_calibrated,", &
                model_labor_supply(time_period)/labor_supply_calibrated
            write(2,*) "model_total_hours,", model_total_hours(time_period)
            write(2,*) "model_labor_supply/model_total_hours,", model_labor_supply(time_period)/model_total_hours(time_period)
            write(2,*) "model_fraction_choose_zero_work,", model_fraction_choose_zero_work(time_period)
            write(2,*) "model_fraction_choose_little_work,", model_fraction_choose_little_work(time_period)
            write(2,*) "model_fraction_choose_addiction_when_unemployed,", &
                model_fraction_choose_addiction_when_unemployed(time_period)
            write(2,*) "model_choose_addiction_when_income_is_low", model_choose_addiction_when_income_is_low(time_period)
            write(2,*) "model_fraction_choose_addiction_when_homeless,", &
                model_fraction_choose_addiction_when_homeless(time_period)
            write(2,*) "model_choose_addiction_when_retired,", model_choose_addiction_when_retired(time_period)
            write(2,*) "model_fraction_choose_addiction,", model_fraction_choose_addiction(time_period)
            write(2,*) "model_fraction_spent_on_addiction,", model_fraction_spent_on_addiction(time_period)
            write(2,*) "model_fraction_spent_on_addiction_experimenters,", model_fraction_spent_on_addiction_experimenters
            write(2,*) "model_fraction_addicted_and_unemployed,", model_fraction_addicted_and_unemployed(time_period)
            write(2,*) "lump_sum_transfer,", lump_sum_transfer
            write(2,*) "percetange_captured_by_landlords,", &
                100*(rent(time_period,:)*total_rental_supply(time_period,:)-&
                rent_calibrated(:)*total_rental_supply_calibrated(:))
            write(2,*) "average_welfare_youngest,", average_welfare_of_youngest_cohort(time_period)
            write(2,*) "average_welfare_of_all_cohorts,", average_welfare_of_all_cohorts(time_period)
            do i=1,1+include_addiction+include_addiction
                write(2,*) "welfare_of_gains_by_addiction,", welfare_of_gains_by_addiction(i)
            end do
            do i=1,2
                write(2,*) "welfare_by_addiction,", welfare_by_addiction(time_period,i)
            end do
            do i=1,2
                write(2,*) "welfare_by_addiction_youngest,", welfare_by_addiction_youngest(time_period,i)
            end do
            write(2,*) "frac_in_support_youngest,", 100*frac_in_support_youngest(time_period)
            write(2,*) "frac_in_support,", 100*frac_in_support(time_period)
            write(2,*) "frac_in_support_addicted_youngest,", frac_in_support_addicted_youngest(time_period)
            write(2,*) "frac_in_support_addicted,", frac_in_support_addicted(time_period)       
            write(2,*) "avg_rental_size,", model_average_rental_unit_size(time_period)
            write(2,*) "avg_owned_house_size,", model_average_owner_occupied_unit_size(time_period)
            write(2,*) "model_homeownership_by_age_old,", model_homeownership_by_age_group(1,5)
            write(2,*) "model_homeownership_by_age_young,", model_homeownership_by_age_group(1,1)
            write(2,*) "probability_of_voucher_benchmark,", probability_of_voucher_benchmark
            write(2,*) "probability_of_voucher,", probability_of_voucher
            write(2,*) "HO_with_mortgage_over_20_perc,", &
                100*(model_fraction_of_homeowners_with_mortgage_over_20_perc(time_period))
            write(2,*) "HO_with_mortgage_over_80_perc,", &
                100*(model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period))
            write(2,*) "HO_with_mortgage_over_90_perc,", &
                100*(model_fraction_of_homeowners_with_mortgage_over_90_perc(time_period))
            write(2,*) "HO_with_morgage,", 100*(model_fraction_of_homeowners_with_mortgage(time_period))
            write(2,*) "households_itemizing_MID,", 100*(fraction_using_MID(time_period))
            do i=1,number_of_quintiles-1
                write(2,*) "income_cutoffs_of_quintiles(i)", income_cutoffs_of_quintiles(i)
            end do
            do i=1,number_of_quintiles
                write(2,*) "quintile", i ,",", mass_of_quintile(i)/(include_retirees_in_income_cdf*sum_of_distribution+&
                    (1-include_retirees_in_income_cdf)*sum_of_non_retired)
                write(2,*) "mass_of_quintile", i ,",", mass_of_quintile(i)
            end do
            do i=1,number_of_quintiles
                write(2,*) "rent_burden_by_income_quintile,", rent_burden_by_income_quintile(time_period,i)
            end do
            do i=1,number_of_quintiles
                write(string_used,'(i1)') i
                write(2,*) "MID_share_by_income_quintile_"//trim(string_used)//",", &
                    MID_share_by_income_quintile(time_period,i)
            end do
            do i=1,number_of_quintiles
                write(string_used,'(i1)') i
                write(2,*) "MID_itemizers_by_income_quintile_"//trim(string_used)//",", &
                    100*(MID_itemizers_by_income_quintile(time_period,i))
            end do
            do i=1,number_of_quintiles
                if (i<=9) then
                    write(string_used_1,'(i1)') i
                    write(2,*) "average_welfare_of_youngest_by_quintile_"//trim(string_used_1)//",", &
                        average_welfare_of_youngest_by_quintile(time_period,i)
                elseif (i<=99) then
                    write(string_used_2,'(i2)') i
                    write(2,*) "average_welfare_of_youngest_by_quintile_"//trim(string_used_2)//",", &
                        average_welfare_of_youngest_by_quintile(time_period,i)
                end if
            end do
            do i=1,number_of_thresholds
                write(2,*) "percentage of renters spending more than ", &
                    frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing,",&
                    mass_of_renters_at_housing_spending(time_period,i)
                write(2,*) "percentage of homeowners with a mortgage spending more than ", &
                    frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing,",&
                    mass_of_homeowners_at_housing_spending(time_period,i)
            end do
            write(2,*) "model_fraction_homeless_by_choice,", model_fraction_homeless_by_choice(time_period)
            write(2,*) "model_addicted_and_homeless_by_choice,", model_addicted_and_homeless_by_choice(time_period)            
            write(2,*) "model_average_income_of_homeless_addicted,", model_average_income_of_homeless_addicted(time_period)
            write(2,*) "model_avg_homeless_income,", model_avg_homeless_income(time_period)
            write(2,*) "model_avg_homeless_after_tax_income,", model_avg_homeless_after_tax_income(time_period)
            write(2,*) "model_avg_homeless_tax_to_income,", model_avg_homeless_tax_to_income(time_period)
            write(2,*) "model_average_net_wealth,", model_average_net_wealth(time_period)
            write(2,*) "model_avg_homeless_assets,", model_avg_homeless_assets(time_period)
            write(2,*) "model_avg_homeless_assets/model_average_net_wealth,", &
                model_avg_homeless_assets(time_period)/model_average_net_wealth(time_period)
            write(2,*) "model_average_assets_addicted_and_homeless,", model_average_assets_addicted_and_homeless(time_period)            
            do i=0,2
                write(2,*) "homelessness_duration_everyone,", homelessness_duration_everyone(time_period,i)
            end do
            do i=1,number_of_quintiles
                write(2,*) "model_drug_use_by_income_quintile", i, ",", model_drug_use_by_income_quintile(time_period,i)
            end do
            do i=1,number_of_wide_grids_income_to_avg_income_cdf
                if (i<=9) then
                    write(string_used_1,'(i1)') i
                    write(2,*) "income_to_avg_income_pdf_"//trim(string_used_1)//",", income_to_avg_income_wide_pdf_1(time_period,i)
                elseif (i<=99) then
                    write(string_used_2,'(i2)') i
                    write(2,*) "income_to_avg_income_pdf_"//trim(string_used_2)//",", income_to_avg_income_wide_pdf_1(time_period,i)
                end if
            end do
            do i=1,number_of_wide_grids_income_to_avg_income_cdf
                if (i<=9) then
                    write(string_used_1,'(i1)') i
                    write(2,*) "%mass_at_profile_income_to_avg_income_wide_1"//trim(string_used_1)//",", &
                        100*(mass_at_profile_income_to_avg_income_wide_1(time_period,2,i)/sum_of_distribution)
                elseif (i<=99) then
                    write(string_used_2,'(i2)') i
                    write(2,*) "%mass_at_profile_income_to_avg_income_wide_1"//trim(string_used_2)//",", &
                        100*(mass_at_profile_income_to_avg_income_wide_1(time_period,2,i)/sum_of_distribution)
                end if
            end do   
            do i=1,wealth_brackets
                write(2,*) "model_wealth_of_top_x_perc(",i,")/model_net_wealth,",&
                    model_wealth_of_top_x_perc(i)/model_total_net_wealth_1(time_period)
                write(2,*) "stopping_rule_wealth_dist(",i,"),", stopping_rule_wealth_dist(i)
            end do
            do i=1,5
                write(string_used,'(i1)') (i)
                write(2,*) "homelessness_by_age_group"//trim(string_used)//",", &
                    homelessness_by_age_group(time_period,i)
            end do
            do i=1,9
                write(string_used,'(i1)') (i)
                write(2,*) "model_drug_use_percent_by_age_group"//trim(string_used)//",", &
                    model_drug_use_percent_by_age_group(time_period,i)
            end do
            do i=1,9
                write(string_used,'(i1)') (i)
                write(2,*) "model_drug_use_by_age_group"//trim(string_used)//",", &
                    model_drug_use_by_age_group(time_period,i)
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "model_addiction_rate_by_age"//trim(string_used_2)//",", &
                    model_addiction_rate_by_age(time_period,i)
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "model_experimentation_choice_by_age"//trim(string_used_2)//",", &
                    model_experimentation_choice_by_age(time_period,i)
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "homeless_and_addiction_rate_by_age_"//trim(string_used_2)//",", &
                    100*(homeless_and_addiction_rate_by_age(time_period,i))                
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "addiction_rate_by_age_"//trim(string_used_2)//",", 100*(addiction_rate_by_age(time_period,i))                
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "homelessness_age_"//trim(string_used_2)//",", 100*(homelessness_by_age(time_period,i))
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "HO_age_"//trim(string_used_2)//",", 100*(homeownership_by_age(time_period,i))
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "LTV_age_"//trim(string_used_2)//",", &
                    100*(mortgage_to_house_value_ratio_of_owners_by_age(time_period,i))
            end do
            do i=1,life_span
                write(string_used_2,'(i2)') (i+25)
                write(2,*) "cost_burdened_renters_age_"//trim(string_used_2)//",",&
                    model_rent_burden_by_age(time_period,i,2)            
            end do
            do i=1,number_of_quintiles
                write(string_used,'(i1)') i
                write(2,*) "renters_income_quintile_"//trim(string_used)//",", &
                    100*(tenure_by_income_quintile(time_period,i,1)/sum(tenure_by_income_quintile(time_period,i,:)))
            end do
            do i=1,number_of_quintiles
                write(string_used,'(i1)') i
                write(2,*) "owners_with_mortgage_income_quintile_"//trim(string_used)//",", &
                    100*(tenure_by_income_quintile(time_period,i,2)/sum(tenure_by_income_quintile(time_period,i,:)))
            end do
            do i=1,number_of_quintiles
                write(string_used,'(i1)') i
                write(2,*) "owners_without_mortgage_income_quintile_"//trim(string_used)//",", &
                    100*(tenure_by_income_quintile(time_period,i,3)/sum(tenure_by_income_quintile(time_period,i,:)))
            end do  
            do i=1,number_of_grids_rent_to_income_cdf
                if (i<=10) then
                    write(string_used_1,'(i1)') (i-1)
                    write(2,*) "rent_to_income_cdf_"//trim(string_used_1)//",", rent_to_income_cdf(time_period,i)
                elseif (i<=100) then
                    write(string_used_2,'(i2)') (i-1)
                    write(2,*) "rent_to_income_cdf_"//trim(string_used_2)//",", rent_to_income_cdf(time_period,i)
                elseif (i<=1000) then
                    write(string_used_3,'(i3)') (i-1)
                    write(2,*) "rent_to_income_cdf_"//trim(string_used_3)//",", rent_to_income_cdf(time_period,i)
                else
                    write(string_used_4,'(i4)') (i-1)
                    write(2,*) "rent_to_income_cdf_"//trim(string_used_4)//",", rent_to_income_cdf(time_period,i)
                end if
            end do 
            do i=1,number_of_thresholds
                if (i<=10) then
                    write(string_used_1,'(i1)') (i-1)
                    write(2,*) "rent_to_income_homeless_cdf_"//trim(string_used_1)//",", rent_to_income_homeless_cdf(time_period,i)
                elseif (i<=100) then
                    write(string_used_2,'(i2)') (i-1)
                    write(2,*) "rent_to_income_homeless_cdf_"//trim(string_used_2)//",", rent_to_income_homeless_cdf(time_period,i)
                elseif (i<=1000) then
                    write(string_used_3,'(i3)') (i-1)
                    write(2,*) "rent_to_income_homeless_cdf_"//trim(string_used_3)//",", rent_to_income_homeless_cdf(time_period,i)
                else
                    write(string_used_4,'(i4)') (i-1)
                    write(2,*) "rent_to_income_homeless_cdf_"//trim(string_used_4)//",", rent_to_income_homeless_cdf(time_period,i)
                end if
            end do 
            do i=1,101
                if (i<=10) then
                    write(string_used_1,'(i1)') (i-1)
                    write(2,*) "LTV_cdf_"//trim(string_used_1)//",", LTV_cdf(time_period,i)
                elseif (i<=100) then
                    write(string_used_2,'(i2)') (i-1)
                    write(2,*) "LTV_cdf_"//trim(string_used_2)//",", LTV_cdf(time_period,i)
                else
                    write(string_used_3,'(i3)') (i-1)
                    write(2,*) "LTV_cdf_"//trim(string_used_3)//",", LTV_cdf(time_period,i)
                end if
            end do 
            do age_index=1,life_span
                if (i<10) then
                    write(string_used_1,'(i1)') i
                    write(2,*) "value_of_bequests_age_"//trim(string_used_1)//",", value_of_bequests_by_age(age_index)
                else
                    write(string_used_2,'(i2)') i
                    write(2,*) "value_of_bequests_age_"//trim(string_used_2)//",", value_of_bequests_by_age(age_index)
                end if
            end do
        close(2)
        
        open(unit=2,file="welfare_code_output"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            write(2,*) "period=", j
            write(2,*) "hours to finish simulaion=", (simulation_stop_time-simulation_start_time)/3600
            write(2,*) "is it counter factual?", is_counterfactual
            write(2,*) "mortgage_deductibility=", mortgage_deductibility
            write(2,*) "raise_min_down=", raise_min_down
            write(2,*) "include_retirees_in_income_cdf=", include_retirees_in_income_cdf
            write(2,*) "have_probablistic_death=", have_probablistic_death
            write(2,*) "include_exogenous_endowment=", include_exogenous_endowment
            write(2,*) "include_bequests_in_govt_constraint=", include_bequests_in_govt_constraint
            write(2,*) "include_property_taxes_in_govt_constraint=", include_property_taxes_in_govt_constraint
            write(2,*) "partial_equilibrium=",partial_equilibrium
            write(2,*) "adjust_prices=", adjust_house_prices
            write(2,*) "adjust_rents=", adjust_rents
            write(2,*) "adjust_taxes=", adjust_taxes
            write(2,*) "standard_deduction_as_percent_of_average_labor_income=", &
                standard_deduction_as_percent_of_average_labor_income
            write(2,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
            write(2,*) "max_debt_to_income_ratio_below_80=", max_debt_to_income_ratio_below_80
            write(2,*) "tax_system_type=", tax_system_type
            write(2,*) "fraction_of_property_taxes_in_GDS=", fraction_of_property_taxes_in_GDS
            write(2,*) "include_housing_depreciation_in_housing_costs=", include_housing_depreciation_in_housing_costs
            write(2,*) "have_probablistic_death=", have_probablistic_death
            write(2,*) "infinite_elasticity_of_rental_supply=", infinite_elasticity_of_rental_supply
            write(2,*) "other_rental_supply_elasticity", other_rental_supply_elasticity
            write(2,*) "max_times_labour_income_saved=", max_times_labour_income_saved
            write(2,*) "housing_status_grid_size=", housing_status_grid_size
            write(2,*) "financial_grid_size=", financial_grid_size
            write(2,*) "housing_status_grid_size=", housing_status_grid_size
            write(2,*) "smallest_rental_relative_to_lowest_income=", smallest_rental_relative_to_lowest_income
            write(2,*) "inheritance_amount=", inheritance_amount
            write(2,*) "inheritance_age_grid=", inheritance_age_grid
            write(2,*) "target_30_perc=", target_30_perc
            write(2,*) "check_tax_incidence=", check_tax_incidence
            write(2,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
            write(2,*) "calibrate_only_rental_management_costs=", calibrate_only_rental_management_costs
            write(2,*) "financial_grid_expander_positive=", financial_grid_expander_positive
            write(2,*) "housing_status_grid_expander=", housing_status_grid_expander
            write(2,*) "do_internal_computations=", do_internal_computations
            write(2,*) "file number=", file_number
            write(2,*) "benchmark_simulation=", benchmark_simulation
            write(2,*) "long_run_simulation=", long_run_simulation
            write(2,*) "loop_count=", loop_count
            write(2,*) "risk_free_rate=", risk_free_rate(j)
            write(2,*) "prepayment_penalty_starts_from=", prepayment_penalty_starts_from
            write(2,*) "average_fraction_of_mortgage_repaid=", average_fraction_of_mortgage_repaid
            write(2,*) "fraction_to_repay=", fraction_to_repay
            write(2,*) "mortgage_origination_cost=", mortgage_origination_cost
            write(2,*) "penalty_months_of_interest=", penalty_months_of_interest
            write(2,*) "FRED_housing_services_to_GDP=", FRED_housing_services_to_GDP
            write(2,*) "target_renters_rent_to_income=", target_renters_rent_to_income
            write(2,*) "avg_labor_supply_data=", avg_labor_supply_data
            write(2,*) "SCF_homeownership_rate=", SCF_homeownership_rate
            write(2,*) "SW_renters_spend_over_X_on_hous=", SW_renters_spend_over_X_on_hous
            write(2,*) "SCF_mortgage_to_gross_housing_wealth=", SCF_mortgage_to_gross_housing_wealth
            write(2,*) "aftr_how_mny_lps_start_update=", aftr_how_mny_lps_start_update
            write(2,*) "negative_consumption=", negative_consumption
            write(2,*) "weight_on_housing_price=", weight_on_housing_price
            write(2,*) "average_welfare_of_youngest_cohort=", average_welfare_of_youngest_cohort(j)
            write(2,*) "frac_in_support_youngest=", frac_in_support_youngest(j)
            write(2,*) "average_welfare_of_all_cohorts=", average_welfare_of_all_cohorts(j)
            write(2,*) "frac_in_support=", frac_in_support(j)
            write(2,*) "frac_in_support_addicted_youngest=", frac_in_support_addicted_youngest(j)
            write(2,*) "frac_in_support_addicted=", frac_in_support_addicted(j) 
            do i=1,2
                write(2,*) "welfare_by_addiction_youngest=", welfare_by_addiction_youngest(j,i)
            end do
            do i=1,1+include_addiction+include_addiction
                write(2,*) "welfare_of_gains_by_addiction=", welfare_of_gains_by_addiction(i)
            end do
            write(2,*) "housing_price=", housing_price(j)
            write(2,*) "housing_price/calibrated_stationary_housing_price=", &
                housing_price(j)/calibrated_stationary_housing_price
            write(2,*) "calibrated_stationary_housing_price=", calibrated_stationary_housing_price
            write(2,*) "long_run_stationary_housing_price=", long_run_stationary_housing_price
            write(2,*) "model_homeownership_rate=", model_homeownership_rate(j)
            write(2,*) "total_rental_demand=", total_rental_demand(j,:)
            write(2,*) "total_rental_supply=", total_rental_supply(j,:)
            write(2,*) "median_income,", median_income(j)
            write(2,*) "probability_of_voucher=", probability_of_voucher
            write(2,*) "model_avg_rent_to_income_ratio=", model_avg_rent_to_income_ratio(j)
            write(2,*) "rent_to_housing_price=", rent_to_housing_price
            write(2,*) "rent=", rent(j,:)
            write(2,*) " model_average_rent=",  model_average_rent(j)
            write(2,*) "rent_calibrated=", rent_calibrated(:)
            write(2,*) "rent/rent_calibrated=", rent(j,:)/rent_calibrated(:)
            write(2,*) "model_fraction_of_property_tax_paid_by_renters=", model_fraction_of_property_tax_paid_by_renters(j)
            write(2,*) "c_1=", c_1
            write(2,*) "c_1_calibrated=", c_1_calibrated
            write(2,*) "c_min=", c_min
            write(2,*) "c_min_calibrated=", c_min_calibrated
            write(2,*) "rental_management_costs=", rental_management_costs
            write(2,*) "rental_management_costs_calibrated=", rental_management_costs_calibrated
            write(2,*) "rental_rental_management_costs*convexity_of_rental_company*total_rental_supply(j)**&
                (convexity_of_rental_company-1)/rent(j)=", &
                (rental_management_costs(:)*convexity_of_rental_company(:)*&
                total_rental_supply(j,:)**(convexity_of_rental_company(:)-1))/rent(j,:)
            write(2,*) "cutoff_housing_investment=", cutoff_housing_investment
            write(2,*) "housing_investment=", housing_investment(j)
            write(2,*) "cutoff_housing_investment_calibrated=", cutoff_housing_investment_calibrated
            write(2,*) "housing_stock=", housing_stock(j)
            write(2,*) "calibrated_housing_stock=", calibrated_housing_stock 
            write(2,*) "total_rental_demand_segmented,", total_rental_demand_segmented(j,:)
            write(2,*) "long_run_housing_stock=", long_run_housing_stock
            write(2,*) "total_housing_demand=", total_housing_demand(j)
            write(2,*) "housing grid size=", housing_status_grid_size
            write(2,*) "smallest_house_size=", smallest_house_size
            write(2,*) "largest_house_size=", largest_house_size
            write(2,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy
            write(2,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", &
                housing_size(index_of_smallest_house_hhld_can_buy)
            write(2,*) "largest_house_size_hhld_can_rent=", largest_house_size_hhld_can_rent
            write(2,*) "total_housing_demand=", total_housing_demand(j)
            write(2,*) "empirical housing_stock_elasticity=", empirical_housing_supplpy_elasticity
            write(2,*) "total_constrcution_profits=", total_constrcution_profits(j)
            write(2,*) "total_rental_company_profits=", total_rental_company_profits(j,:)
            write(2,*) "model_homeownership rate youngest cohort=", model_homeownership_rate_young(j)
            do i=1,life_span
                write(2,*) "labour_deterministic_efficiency(",i,")=", labour_deterministic_efficiency(i)
            end do
            write(2,*) "model_total_income=", &
                model_output(j)+model_total_investment_income(j)
            write(2,*) "model_total_expenditures=", &
                (aggregate_consumption(j)+aggregate_spending_on_addiction(j)+aggregate_housing_consumption(j)+&
                aggregate_mortgage_consumption(j)+aggregate_housing_transaction_costs(j)+&
                aggregate_origination_costs(j)+aggregate_prepayment_costs(j)+aggregate_moving_costs(j)+&
                govt_revenues_to_use_in_tests(j)+&
                govt_ss_wasted(j)+&
                (govt_spending_on_homeless(j)+govt_spending_on_addicts(j))+&
                (1-include_property_taxes_in_govt_constraint)*&
                govt_revenues_from_property_tax(j)+aggregate_rent_spending(j)-housing_price(j)*&
                sum(total_rental_demand(j-solve_transition_dynamics,:))*property_tax(j-solve_transition_dynamics))
            write(2,*) "total income-total expenditures=", &
                abs(model_output(j)+model_total_investment_income(j)-&
                (aggregate_consumption(j)+aggregate_spending_on_addiction(j)+aggregate_housing_consumption(j)+&
                aggregate_mortgage_consumption(j)+aggregate_housing_transaction_costs(j)+&
                aggregate_origination_costs(j)+aggregate_prepayment_costs(j)+aggregate_moving_costs(j)+&
                govt_revenues_to_use_in_tests(j)+&
                govt_ss_wasted(j)+&
                (govt_spending_on_homeless(j)+govt_spending_on_addicts(j))+&
                (1-include_property_taxes_in_govt_constraint)*govt_revenues_from_property_tax(j)+&
                aggregate_rent_spending(j)-housing_price(j)*&
                sum(total_rental_demand(j-solve_transition_dynamics,:))*property_tax(j-solve_transition_dynamics)))
            write(2,*) "aggregate_consumption=", aggregate_consumption(j)
            write(2,*) "aggregate_housing_consumption=", aggregate_housing_consumption(j)
            write(2,*) "(total_housing_demand(j)-total_rental_demand(j))*housing_depreciation_rate*housing_price(j)=", &
                (total_housing_demand(j)-sum(total_rental_demand(j,:)))*housing_depreciation_rate*housing_price(j)
            write(2,*) "aggregate_mortgage_consumption=", aggregate_mortgage_consumption(j)
            write(2,*) "mortgage_interest_rate*model_mortgages=", mortgage_interest_rate(j)*model_mortgages(j)
            write(2,*) "aggregate_housing_transaction_costs=", aggregate_housing_transaction_costs(j)
            write(2,*) "aggregate_origination_costs=", aggregate_origination_costs(j)
            write(2,*) "aggregate_prepayment_costs=", aggregate_prepayment_costs(j)
            write(2,*) "(aggregate_origination_costs(j)+aggregate_prepayment_costs(j))/model_GDP_incl_imput_rent(j)=", &
                (aggregate_origination_costs(j)+aggregate_prepayment_costs(j))/model_GDP_incl_imput_rent(j)
            write(2,*) "net_govt_revenues=", net_govt_revenues(j)
            write(2,*) "housing_price(j)*sum(total_rental_demand(j,:))*property_tax(j)=", &
                housing_price(j-solve_transition_dynamics)*total_rental_demand(j-solve_transition_dynamics,:)*&
                property_tax(j-solve_transition_dynamics)
            write(2,*) "aggregate_rent_spending=", aggregate_rent_spending(j)
            write(2,*) "model_fraction_of_homeless_unemployed=", model_fraction_of_homeless_unemployed(j)
            write(2,*) "model_fraction_of_homeless_and_addicted_unemployed=", &
                model_fraction_of_homeless_and_addicted_unemployed(j)
            write(2,*) "output=", model_output(j)
            write(2,*) "GDP=", model_GDP(j)
            write(2,*) "model_mortgages=", model_mortgages(j)
            write(2,*) "model_total_investment_income=", model_total_investment_income(j)
            write(2,*) "model total_wages=", model_total_efficiency_units(j)
            write(2,*) "wage to output=", model_total_efficiency_units(j)/model_output(j)
            write(2,*) "model_GDP_incl_imput_rent=", model_GDP_incl_imput_rent(j)
            write(2,*) "total_rent_paid/total_renters_income=", (total_rent_paid(j)/total_renters_income(j))
            do i=1,employment_grid_size
                write(2,*) "distribution_stationary(",j,":,:,",i,")=", &
                    sum_of_distribution_employment(i)/sum_of_non_retired
            end do  
            do i=1,employment_grid_size
                write(2,*) "distribution_stationary_all(",j,":,:,",i,")=", &
                    sum_of_distribution_employment_all(i)/sum_of_distribution
            end do  
            do i=1,employment_grid_size
                write(2,*) "distribution_stationary_youngest(",j,"1,:,",i,")=", &
                    sum_of_youngest_employment(i)/sum_of_youngest
            end do  
            do i=1,employment_grid_size
                write(2,*) "distribution_stationary_retired(",j,"1,:,",i,")=", &
                    sum_of_retired_employment(i)/sum_of_retired
            end do  
            do i=1,num_percentiles
                write(2,*) "model_median_assets_to_income=", model_median_assets_to_income(i)
            end do
            write(2,*) "model_fraction_leaving_bequests=", model_fraction_leaving_bequests(j)
            write(2,*) "model_housing_value_per_capita=", model_housing_value_per_capita(j)
            write(2,*) "model_average_net_wealth=", model_average_net_wealth(j)
            write(2,*) "model_avg_mortgage_spending=", model_avg_mortgage_spending(j)
            write(2,*) "model_avg_housing_spending_owners=", model_avg_housing_spending_owners(j)
            write(2,*) "model_avg_housing_spending_all=", model_avg_housing_spending_all(j)
            write(2,*) "model_avg_housing_spending_renters=", model_avg_housing_spending_renters(j)
            write(2,*) "model_fraction_homeless=", model_fraction_homeless(j)
            write(2,*) "model_homeless_2_years_or_more=", model_homeless_2_years_or_more(j)
            write(2,*) "model_fraction_homeless_owners=", model_fraction_homeless_owners(j)
            write(2,*) "model_fraction_addicted=", model_fraction_addicted(j)
            write(2,*) "model_fraction_addicted_and_unemployed=", model_fraction_addicted_and_unemployed(j)
            write(2,*) "model_fraction_addicted_who_are_homeless,", model_fraction_addicted_who_are_homeless(j)
            write(2,*) "model_fraction_homeless_and_addicted,", model_fraction_homeless_and_addicted(j)
            write(2,*) "model_fraction_unemployed=", model_fraction_unemployed(j)
            write(2,*) "total financial wealth=", model_financial(j)
            write(2,*) "total net housing wealth=", model_net_housing_wealth(j)
            write(2,*) "total mortgage debt=", model_mortgages(j)
            write(2,*) "total net wealth=", model_total_net_wealth(j)
            write(2,*) "model_youngest_net_wealth_share=", model_youngest_net_wealth_share(j)
            write(2,*) "model_total_workers=", model_total_workers(j)
            write(2,*) "model_average_labour_income_tax=", model_average_labour_income_tax(j)
            write(2,*) "fraction of hhlds who make it to the highest net wealth=", sum_at_top_financial/sum_of_distribution
            write(2,*) "consumption tax=", consumption_tax
            write(2,*) "investment_income_tax=", investment_income_tax
            write(2,*) "property_tax=", property_tax(j)
            write(2,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
            write(2,*) "net housing wealth to total wealth=", model_net_housing_wealth(j)/model_total_net_wealth(j)
            write(2,*) "NPV of gross govt revenues=", total_govt_revenues(j)
            write(2,*) "NPV of net govt revenues=", net_govt_revenues(j)
            write(2,*) "% of GDP raised in net govt revenues=", 100*(net_govt_revenues(j)/model_GDP(j))
            write(2,*) "% of GDP raised in gross govt revenues=", 100*(total_govt_revenues(j)/model_GDP(j))
            write(2,*) "% of gross govt revenues from labour income tax=", &
                100*(govt_revenues_from_labour_income(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from consumption tax=", &
                100*(govt_revenues_from_consumption(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from investment income tax=", &
                100*(govt_revenues_from_investment_income(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt lump sum transfers=", 100*(govt_lump_sum_transfers(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues spent on social security=", &
                100*(govt_spending_on_ss(j)/total_govt_revenues(j))
            if ((mortgage_deductibility>0) .AND. (property_tax_deductibility>0)) then                
                write(2,*) "% govt spending on mortgage interest deductions/model_GDP_incl_imput_rent=", &
                    100*(govt_spending_on_mortgage_interest_deductions(j)/model_GDP_incl_imput_rent(j))
                write(2,*) "govt_spending_on_mortgage_interest_deductions=", &
                    govt_spending_on_mortgage_interest_deductions(j)
            end if            
            write(2,*) "govt_revenues_from_labour_income=", govt_revenues_from_labour_income(j)
            write(2,*) "govt_revenues_from_consumption=", govt_revenues_from_consumption(j)
            write(2,*) "govt_revenues_from_investment_income=", govt_revenues_from_investment_income(j)
            write(2,*) "govt_revenues_from_property_tax=", govt_revenues_from_property_tax(j)
            write(2,*) "govt_spending_on_homeless=", govt_spending_on_homeless(j)
            write(2,*) "govt_spending_on_addicts=", govt_spending_on_addicts(j)
            write(2,*) "govt_spending_on_food_stamps=", govt_spending_on_food_stamps(j)
            write(2,*) "govt_spending_on_food_stamps/model_output=", govt_spending_on_food_stamps(j)/model_output(j)
            write(2,*) "model_fraction_spent_on_addiction=", model_fraction_spent_on_addiction(j)
            write(2,*) "model_fraction_spent_on_addiction_experimenters=", model_fraction_spent_on_addiction_experimenters(j)
            write(2,*) "govt_spending_on_housing_vouchers=", govt_spending_on_housing_vouchers(j)
            write(2,*) "property_tax(j)*(total_housing_demand(j)-total_rental_demand(j))*housing_price(j)=", & 
                property_tax(j-solve_transition_dynamics)*&
                (total_housing_demand(j-solve_transition_dynamics)-&
                sum(total_rental_demand(j-solve_transition_dynamics,:)))*&
                housing_price(j-solve_transition_dynamics)
            write(2,*) "property_tax(j)*total_rental_demand(j)*housing_price(j)=", & 
                property_tax(j-solve_transition_dynamics)*&
                total_rental_demand(j-solve_transition_dynamics,:)*housing_price(j-solve_transition_dynamics)
            write(2,*) "model_fraction_homeless_by_choice=", model_fraction_homeless_by_choice(j)
            write(2,*) "model_addicted_and_homeless_by_choice=", model_addicted_and_homeless_by_choice(j)              
            write(2,*) "model_average_income_of_homeless_addicted=", model_average_income_of_homeless_addicted(j)
            write(2,*) "model_avg_homeless_income=", model_avg_homeless_income(j)
            write(2,*) "model_avg_homeless_income/model_average_labour_income=", &
                model_avg_homeless_income(j)/model_average_labour_income(j)
            write(2,*) "model_avg_homeless_after_tax_income,", model_avg_homeless_after_tax_income(j)
            write(2,*) "rent of smallest_rental=", rent(j,:)*housing_size(0)
            write(2,*) "rent to income of homeless=", rent(j,:)*housing_size(0)/model_avg_homeless_after_tax_income(j)
            write(2,*) "govt_lump_sum_transfers=", govt_lump_sum_transfers(j)
            write(2,*) "fraction_using_MID(j)=", fraction_using_MID(j)
            write(2,*) "standard_deduction=", standard_deduction
            write(2,*) "standard_deduction_as_percent_of_average_labor_income=", &
                standard_deduction_as_percent_of_average_labor_income
            write(2,*) "personal_exemption=", personal_exemption
            write(2,*) "model_bequests=", model_bequests(j)
            write(2,*) "model_financial_bequests", model_financial_bequests(j)
            write(2,*) "model_bequests/model_net_wealth=", model_bequests(j)/model_total_net_wealth(j)
            write(2,*) "model_fraction_leaving_bequests(j)=", model_fraction_leaving_bequests(j)
            write(2,*) "model_fraction_leaving_housing_bequests=", model_fraction_leaving_housing_bequests(j)
            write(2,*) "model_fraction_homeless=", model_fraction_homeless(j)
            write(2,*) "model_fraction_unemployed=", model_fraction_unemployed(j)
            write(2,*) "model_fraction_unemployed_on_ui=", model_fraction_unemployed_on_ui(j)
            write(2,*) "risk_free_rate=", risk_free_rate(j)
            write(2,*) "model average labour income=", model_average_labour_income(j)
            write(2,*) "median_income=", median_income(j)
            do i=1,employment_grid_size
                write(2,*) "model_ss_benefits=", model_ss_benefits(i)
            end do
            do i=1,employment_grid_size
                write(2,*) "employment_grid(",i,")=", employment_grid(1,i)
            end do
            write(2,*) "lump_sum_transfer=", lump_sum_transfer
            write(2,*) "property_tax_on_rental_housing=", property_tax_on_rental_housing
            write(2,*) "lump_sum_transfer/average_income=", lump_sum_transfer/model_average_labour_income(j)
            write(2,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
            do i=0,1
                write(2,*) "mass_by_ownership_status=", sum(mass_by_ownership_status(j,i,:))/sum_of_youngest
            end do
            write(2,*) "fraction_to_repay=", fraction_to_repay         
            write(2,*) "prepayment_penalty_starts_from=", prepayment_penalty_starts_from
            write(2,*) "advantage_to_owning=", advantage_to_owning
            write(2,*) "discount factor=", discount_factor
            write(2,*) "discount_factor_on_child=", discount_factor_on_child
            write(2,*) "labor_income_tax_rate=", labor_income_tax_rate
            write(2,*) "curvature_of_labor_income_taxes=", curvature_of_labor_income_taxes
            write(2,*) "personal_exemption=", personal_exemption 
            write(2,*) "minimum_inheritance=", minimum_inheritance
            write(2,*) "size_homelessness=", size_homelessness
            write(2,*) "convexity_of_rental_company=", convexity_of_rental_company
            write(2,*) "relative_share_of_housing=", relative_share_of_housing
            write(2,*) "relative_share_of_leisure=", relative_share_of_leisure
            write(2,*) "relative_share_of_addiction=", relative_share_of_addiction
            write(2,*) "max_initial_endowment=", max_initial_endowment
            write(2,*) "rental_management_costs=", rental_management_costs
            write(2,*) "himmelberg_etal_rent_to_price=", himmelberg_etal_rent_to_price
            write(2,*) "perc_higher_rent_in_free_market=",perc_higher_rent_in_free_market
            write(2,*) "free_market_rent_to_house_price=", free_market_rent_to_house_price
            write(2,*) "value_of_initial_assets=", value_of_initial_assets
            write(2,*) "empirical_housing_supplpy_elasticity=", empirical_housing_supplpy_elasticity
            write(2,*) "model_average_rental_unit_size(j)=",model_average_rental_unit_size(j)
            write(2,*) "model_average_owner_occupied_unit_size(j)=",model_average_owner_occupied_unit_size(j)
            write(2,*) "model_average_rental_unit_size(j)/model_average_owner_occupied_unit_size(j)=", &
                model_average_rental_unit_size(j)/model_average_owner_occupied_unit_size(j)
            write(2,*) "housing_price(j)*model_average_owner_occupied_unit_size(j)&
                /(model_GDP_incl_imput_rent(j)/total_population)=", &
                housing_price(j)*model_average_owner_occupied_unit_size(j)/(model_GDP_incl_imput_rent(j)/total_population)
            write(2,*) "housing_price(j)*model_average_owner_occupied_unit_size(j)/model_average_labour_income(j)=", &
                housing_price(j)*model_average_owner_occupied_unit_size(j)/model_average_labour_income(j)
            write(2,*) "largest_housing_size_consumed_in_equilibrium=", largest_housing_size_consumed_in_equilibrium
            write(2,*) "largest_financial_chosen_in_equilibrium=", largest_financial_chosen_in_equilibrium
            write(2,*) "smallest_financial_chosen_in_equilibrium=", smallest_financial_chosen_in_equilibrium
            write(2,*) "fraction_with_largest_housing_size_consumed_in_eqilibrium=", &
                fraction_with_largest_housing_size_consumed_in_eqilibrium
            write(2,*) "fraction_with_smallest_financial_in_eqilibrium=", fraction_with_smallest_financial_in_eqilibrium
            write(2,*) "largest income grid=", max_times_labour_income_saved
            write(2,*) "financial grid points=", financial_grid_size
            write(2,*) "financial grid points internal=", fin_num_of_internal
            write(2,*) "space_lived_in_num_of_internal=", space_lived_in_num_of_internal
            write(2,*) "multiples of income=", max_times_labour_income_saved
            write(2,*) "housing depreciation rate=", housing_depreciation_rate
            write(2,*) "model_wealth_of_owners=", model_wealth_of_owners(j)
            write(2,*) "model_wealth_of_renters=", model_wealth_of_renters(j)
            write(2,*) "housing depreciation expenditures=", housing_price(j)*housing_depreciation_rate
            write(2,*) "model_fraction_of_homeowners_with_mortgage=", model_fraction_of_homeowners_with_mortgage(j)
            write(2,*) "model fraction of households with mortgage=", &
                model_fraction_of_homeowners_with_mortgage(j)*model_homeownership_rate(j)
            write(2,*) "model_fraction_of_homeowners_with_mortgage_over_20_perc=", &
                model_fraction_of_homeowners_with_mortgage_over_20_perc(j)
            write(2,*) "model_fraction_of_homeowners_with_mortgage_over_80_perc=", &
                model_fraction_of_homeowners_with_mortgage_over_80_perc(j)
            write(2,*) "model_fraction_of_homeowners_with_mortgage_over_90_perc=", &
                model_fraction_of_homeowners_with_mortgage_over_90_perc(j)
            write(2,*) "fraction of households with mortgage ober 80 perc=", &
                model_fraction_of_homeowners_with_mortgage_over_80_perc(j)*&
                model_fraction_of_homeowners_with_mortgage(j)*model_homeownership_rate(j)
            write(2,*) "total population=", total_population
            write(2,*) "fraction of retired households in popualtoin=", sum_of_retired/sum_of_distribution
            write(2,*) "mortgage_interest_rate=", mortgage_interest_rate(j)
            write(2,*) "mortgage_insurance_premium=", mortgage_insurance_premium
            write(2,*) "total efficiency units=", model_total_efficiency_units(j)
            write(2,*) "model_labor_supply=", model_labor_supply(j)
            write(2,*) "model_total_hours=", model_total_hours(j)
            write(2,*) "model_labor_supply/model_total_hours=", model_labor_supply(j)/model_total_hours(j)
            write(2,*) "model financial wealth to output=", model_financial(j)/model_output(j)
            write(2,*) "model net housing wealth to output=", model_net_housing_wealth(j)/model_output(j)
            write(2,*) "model total net wealth to output=", model_total_net_wealth(j)/model_output(j)
            write(2,*) "model_net_housing_wealth/model_total_net_wealth=", &
                model_net_housing_wealth(j)/model_total_net_wealth(j)
            write(2,*) "model mortgage debt to gross housing wealth=", model_mortgages(j)/model_gross_housing_wealth(j)
            write(2,*) "model_gross_housing_wealth=", model_gross_housing_wealth(j)
            write(2,*) "life span=", life_span
            write(2,*) "retirement_span=", retirement_span
            write(2,*) "wealth to GDP=", model_total_net_wealth(j)/model_GDP(j)
            write(2,*) "mortgage_interest_rate(j)*model_mortgages(j)=", mortgage_interest_rate(j)*model_mortgages(j)
            write(2,*) "financial wealth to GDP=", model_financial(j)/model_GDP(j)
            write(2,*) "net housing wealth to GDP=", model_net_housing_wealth(j)/model_GDP(j)
            write(2,*) "mass_by_employment=", mass_by_employment
            write(2,*) "model_total_net_wealth/model_GDP_incl_imput_rent=", &
                model_total_net_wealth(j)/model_GDP_incl_imput_rent(j)
            write(2,*) "model total net wealth to output=", model_total_net_wealth(j)/model_output(j)
            write(2,*) "gross housing wealth to GDP=", model_gross_housing_wealth(j)/model_GDP(j)
            write(2,*) "minimum_downpayment=", minimum_downpayment
            write(2,*) "risk_aversion_consumption=", risk_aversion_consumption
            write(2,*) "risk_aversion_housing=", risk_aversion_housing
            write(2,*) "permanent labour_deterministic_efficiency slope=", life_cycle_component_a
            write(2,*) "stopping_rule_stationary_distribution=", stopping_rule_stationary_distribution
            write(2,*) "stopping_rule_cutoff_housing_investment=", stopping_rule_cutoff_housing_investment
            write(2,*) "stopping_rule_value_function=", stopping_rule_value_function
            write(2,*) "stopping_rule_housing_market=", stopping_rule_housing_market
            write(2,*) "stopping_rule_rental_market=", stopping_rule_rental_market
            write(2,*) "distance_value_function=", distance_value_function
            write(2,*) "distance_housing_market=", distance_housing_market(j)
            write(2,*) "distance_rental_market=", distance_rental_market(j) 
            do i=1,number_of_quintiles-1
                write(2,*) "income_cutoffs_of_quintiles(i)=", income_cutoffs_of_quintiles(i)
            end do
            do i=1,number_of_quintiles
                write(2,*) "quintile", i ,"=", mass_of_quintile(i)/(include_retirees_in_income_cdf*sum_of_distribution+&
                    (1-include_retirees_in_income_cdf)*sum_of_non_retired)
                write(2,*) "mass_of_quintile", i ,"=", mass_of_quintile(i)
                write(2,*) "tenure_by_income_quintile=", sum(tenure_by_income_quintile(j,i,:))
            end do
            do i=1,number_of_quintiles
                write(2,*) "MID_share_by_income_quintile=", MID_share_by_income_quintile(j,i)
            end do
            do i=1,number_of_quintiles
                write(2,*) "MID_itemizers_by_income_quintile=", MID_itemizers_by_income_quintile(j,i)
            end do
            do i=1,employment_grid_size
                write(2,*) "employment_process(",1,i,")=", employment_process(1,i,:)
            end do
            do i=1,employment_grid_size
                write(2,*) "sum(employment_process(",1,i,":)=", sum(employment_process(1,i,:))
            end do            
            do i=1,employment_grid_size
                write(2,*) "unconditional_employment_probability(",i,")=", unconditional_employment_probability(i)
            end do
            do i=1,wealth_brackets
                write(2,*) "model_wealth_of_top_x_perc(",i,")/model_net_wealth=",&
                    model_wealth_of_top_x_perc(i)/model_total_net_wealth_1(j)
                write(2,*) "stopping_rule_wealth_dist(",i,")=", stopping_rule_wealth_dist(i)
            end do
            do i=1,income_brackets
                write(2,*) "model_income_of_top_x_perc(",i,")/model_total_income=",&
                    model_income_of_top_x_perc(i)/model_total_income(j)
                write(2,*) "stopping_rule_income_dist(",i,")=", stopping_rule_income_dist(i)
            end do
            write(2,*) "gini_coefficient=", gini_coefficient(j)
            write(2,*) "model_average_financial=", model_average_financial(j)
            write(2,*) "model_average_net_wealth=", model_average_net_wealth(j)
            write(2,*) "model_mass_with_positive_financial=", model_mass_with_positive_financial(j)
            write(2,*) "total_profits=", total_profits(j)
        end do
        
        close(2)
       
        open(unit=2,file="rent_to_income_cdf"//trim(file_number)//".txt",action="write",status="replace")
                    
        do j=1,time_period
        
            do i=1,number_of_grids_rent_to_income_cdf
                    
                write(2,*) rent_to_income_cdf(j,i)
                
            end do
            
        end do
        
        close(2)
        
        open(unit=2,file="rent_to_income_homeless_cdf"//trim(file_number)//".txt",action="write",status="replace")
                    
        do j=1,time_period
        
            do i=1,number_of_grids_rent_to_income_cdf
                    
                write(2,*) rent_to_income_homeless_cdf(j,i)
                
            end do
            
        end do
        
        close(2)
        
        open(unit=2,file="homelessness_age_"//trim(file_number)//".txt",action="write",status="replace")
                    
        do j=1,time_period
        
            do i=1,life_span
                    
                write(2,*) 100*(homelessness_by_age(j,i))
                
            end do
            
        end do
        
        close(2)
        
        open(unit=2,file="LTV_cdf"//trim(file_number)//".txt",action="write",status="replace")
                    
        do j=1,time_period
        
            do i=1,101
                    
                write(2,*) LTV_cdf(j,i)
                
            end do
            
        end do
        
        close(2)
        
        open(unit=2,file="average_age_of_homeowner_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do employment_index=1,employment_grid_size
                                   
                write(2,*) average_age_of_homeowner_by_employment(j,employment_index)

            end do
            
        end do
        
        close(2)
                
        open(unit=3,file="mortgage_to_house_value_ratio_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) mortgage_to_house_value_ratio_of_owners_by_age(j,age_index)
                        
            end do
            
        end do
        
        close(3)
                                
        open(unit=3,file="model_LTV_by_age_group"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do i=1,5 
        
                write(3,*) model_LTV_by_age_group(j,i)
        
            end do
            
        end do
        
        close(3)
                        
        open(unit=3,file="model_homeownership_by_age_group"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do i=1,5 
        
                write(3,*) model_homeownership_by_age_group(j,i)
        
            end do
            
        end do
        
        close(3)
        
        open(unit=3,file="average_welfare_of_youngest_by_quintile"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do i=1,number_of_quintiles
        
                write(3,*) average_welfare_of_youngest_by_quintile(j,i)
        
            end do
            
        end do
        
        close(3)
                    
        open(unit=3,file="percent_with_mortgage_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) mass_mortgage_to_house_value_ratio_of_owners_by_age&
                    (j,age_index)
                        
            end do
            
        end do
        
        close(3)
            
        open(unit=3,file="average_wealth_by_age_renter"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) wealth_by_age_renter(j,age_index)
                        
            end do
            
        end do
        
        close(3)
        
        open(unit=3,file="income_by_age_renter"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) income_by_age_renter(j,age_index)
                        
            end do
            
        end do
        
        close(3)
        
        open(unit=3,file="consumption_by_age_renter"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) consumption_by_age_renter(j,age_index)
                        
            end do
            
        end do
        
        close(3)
        
        open(unit=3,file="consumption_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) consumption_by_age(j,age_index)
                        
            end do
            
        end do
        
        close(3)
        
        open(unit=3,file="housing_consumption_by_age_renter"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do j=1,time_period
                    
            do age_index=1,life_span
                            
                write(3,*) housing_consumption_by_age_renter(j,age_index)
                        
            end do
            
        end do
        
        close(3)
                
        open(unit=3,file="average_rent_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
                    
        do age_index=1,life_span
                            
            write(3,*) average_rent_by_age(age_index)
                        
        end do
        
        close(3)
                                
        open(unit=3,file="welfare_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
            
            do age_index=1,life_span
                            
                write(3,*) welfare_by_age(j,age_index)
                        
            end do
                
        end do
            
        close(3)
        
        open(unit=3,file="welfare_by_employment_and_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=1,employment_grid_size
            
                do age_index=1,life_span
                                
                    write(3,*) welfare_by_employment_and_age(j,i,age_index)
                       
                end do
                
            end do
                
        end do
            
        close(3)

        do k=0,1

            if (k==0) then

                string_used_10='_no_drugs'

            else

                string_used_10='_use_drugs'

            end if

            do i=1,number_of_profiles_for_income

                if (i==1) then

                    string_used_20='_age'

                elseif (i==2) then

                    string_used_20='_consumption'
                
                elseif (i==3) then

                    string_used_20='_labor_supply'

                elseif (i==4) then

                    string_used_20='_income'

                elseif (i==5) then

                    string_used_20='_homeownership'
                
                elseif (i==6) then

                    string_used_20='_net_wealth'
                    
                elseif (i==7) then
                
                    string_used_20='_housing_size'
                    
                elseif (i==8) then
                
                    string_used_20='_homeownership_decision'

                end if
                
                open(unit=3,file="profile"//trim(string_used_10)//&
                    "_by_income_to_avg_income"//trim(string_used_20)//&
                    trim(file_number)//".txt",&
                    action="write",status="replace")
                    
                    do j=1,number_of_wide_grids_income_to_avg_income_cdf

                        write(3,*) profile_by_income_to_avg_income_wide_1(time_period,k,j,i)
                        
                    end do

                close(3)

            end do

        end do
        
        string_used_10='_both'
        
        do i=1,number_of_profiles_for_income
        
            if (i==1) then

                string_used_20='_age'

            elseif (i==2) then

                string_used_20='_consumption'
            
            elseif (i==3) then

                string_used_20='_labor_supply'

            elseif (i==4) then

                string_used_20='_income'

            elseif (i==5) then

                string_used_20='_homeownership'
            
            elseif (i==6) then

                string_used_20='_net_wealth'
                
            elseif (i==7) then
            
                string_used_20='_housing_size'
                
            elseif (i==8) then
                
                string_used_20='_homeownership_decision'

            end if
                
            open(unit=3,file="profile"//trim(string_used_10)//&
                "_by_income_to_avg_income"//trim(string_used_20)//"_"&
                //trim(file_number)//".txt",&
                action="write",status="replace")
                
                do j=1,number_of_wide_grids_income_to_avg_income_cdf

                    write(3,*) profile_by_income_to_avg_income_wide_1(time_period,2,j,i)
                    
                end do

            close(3)

        end do

        do k=0,1

            if (k==0) then

                string_used_10='_no_drugs'

            else

                string_used_10='_use_drugs'

            end if

            do i=1,number_of_profiles_for_income

                if (i==1) then

                    string_used_20='_age'

                elseif (i==2) then

                    string_used_20='_consumption'
                
                elseif (i==3) then

                    string_used_20='_labor_supply'

                elseif (i==4) then

                    string_used_20='_income'

                elseif (i==5) then

                    string_used_20='_homeownership'
                
                elseif (i==6) then

                    string_used_20='_net_wealth'
                    
                elseif (i==7) then
                
                    string_used_20='_housing_size'
                    
                elseif (i==8) then
                
                    string_used_20='_homeownership_decision'
                    
                elseif (i==9) then
                
                    string_used_20='_labor_productivity'
                    
                elseif (i==10) then
                
                    string_used_20='_savings'
                    
                elseif (i==11) then
                
                    string_used_20='_addiction_consumption'

                elseif (i==12) then
                
                    string_used_20='_mortgage'
                    
                elseif (i==13) then
                
                    string_used_20='_financial_assets'
                    
                elseif (i==14) then
                
                    string_used_20='_housing_spending'
                    
                elseif (i==15) then
                
                    string_used_20='_taxes_paid'
                    
                elseif (i==16) then
                
                    string_used_20='_work_income'

                end if

                open(unit=3,file="profile"//trim(string_used_10)//&
                    "_by_income_quintile"//trim(string_used_20)//&
                    trim(file_number)//".txt",&
                    action="write",status="replace")
                    
                    do j=1,number_of_quintiles

                        write(3,*) profile_by_income_quintile(time_period,k,j,i)
                        
                    end do

                close(3)

            end do

        end do

        open(unit=4,file="welfare_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) welfare_by_employment(j,i)
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="welfare_by_unemployment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,unemployment_grid_size
                        
                write(4,*) welfare_by_unemployment(j,i)
                   
            end do
                
        end do
        
        close(4)
                
        open(unit=4,file="welfare_by_employment_youngest"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) welfare_by_employment_youngest(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="welfare_by_employment_youngest_old_dist"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) welfare_by_employment_youngest_old_dist(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="MID_share_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) MID_share_by_employment(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="wealth_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) wealth_by_employment(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="fraction_with_mortgage"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) 100*fraction_with_mortgage(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="fraction_renters"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) 100*fraction_renters_by_employment(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        do i=1,number_of_thresholds
        
            write(string_used,'(i1)') i
        
            open(unit=4,file="model_rent_burden_by_age"//trim(string_used)//trim(file_number)//".txt",&
                action="write",status="replace")
            
            do j=time_period,time_period
                        
                do age_index=1,life_span
                            
                    write(4,*) 100*model_rent_burden_by_age(j,age_index,i)
                       
                end do
                    
            end do
                
            close(4)
            
        end do
                
        open(unit=4,file="average_age_of_homeowner"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) average_age_of_homeowner(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="average_income"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) average_income(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="average_house_inheritance"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) average_house_inheritance(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="average_house_non_inheritance"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) average_house_non_inheritance(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="fraction_with_inheritance"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) mass_inheritance(j,i)/(mass_inheritance(j,i)+mass_non_inheritance(j,i))
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="average_housing_costs"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) average_housing_costs(j,i)
                   
            end do
                
        end do
            
        close(4)
        
        open(unit=4,file="average_consumption"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                        
                write(4,*) average_consumption(j,i)
                   
            end do
                
        end do
            
        close(4)
                
        open(unit=4,file="welfare_by_employment_and_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do k=1,employment_grid_size
            
                do i=1,3
                        
                    write(4,*) welfare_by_employment_and_tenure(j,k,i)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="wealth_by_employment_and_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=1,3
                    
                do k=1,employment_grid_size
                                    
                    write(4,*) wealth_by_employment_and_tenure(j,k,i)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="consumption_by_employment_and_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do k=1,employment_grid_size
            
                do i=1,3
                        
                    write(4,*) consumption_by_employment_and_tenure(j,k,i)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="housing_size_by_employment_and_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
            
            do i=1,3
                    
                do k=1,employment_grid_size
                                    
                    write(4,*) housing_size_by_employment_and_tenure(j,k,i)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="mortgag_by_employment_and_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do k=1,employment_grid_size
            
                do i=1,3
                        
                    write(4,*) mortgage_by_employment_and_tenure(j,k,i)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="mortgag_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                                    
                write(4,*) mortgage_by_employment(j,i)
                                           
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="mass_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do i=1,employment_grid_size
                                    
                write(4,*) mass_by_employment(j,i)
                                           
            end do
                
        end do
        
        close(4)
                    
        open(unit=4,file="support_by_employment_and_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=1,3
                    
                do k=1,employment_grid_size
                                    
                    write(4,*) 100*frac_in_support_by_tenure_and_employment(j,k,i)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="welfare_by_employment_and_age_renter"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                            
            do i=1,employment_grid_size
            
                do age_index=1,int(real(life_span)/real(10))
                                        
                    write(4,*) welfare_by_employment_tenure_and_age(j,i,1,age_index)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="welfare_by_employment_and_age_owner_w_m"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                            
            do i=1,employment_grid_size
            
                do age_index=1,int(real(life_span)/real(10))
                                        
                    write(4,*) welfare_by_employment_tenure_and_age(j,i,2,age_index)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
        
        open(unit=4,file="welfare_by_employment_and_age_owner_wo_m"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                            
            do i=1,employment_grid_size
            
                do age_index=1,int(real(life_span)/real(10))
                                        
                    write(4,*) welfare_by_employment_tenure_and_age(j,i,3,age_index)
                        
                end do
                   
            end do
                
        end do
        
        close(4)
            
        open(unit=4,file="percentage_by_tenure"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                    
            do k=1,employment_grid_size
            
                do i=1,3
                        
                    write(4,*) 100*(mass_by_employment_and_tenure(j,k,i)/mass_by_employment(j,k))
                        
                end do
                   
            end do
                
        end do    
            
        close(4)
        
        open(unit=5,file="welfare_by_ownership_status"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
            
            do i=0,1
                                    
                do k=1,employment_grid_size
                                                            
                    write(5,*) welfare_by_ownership_status(j,i,k)
                                
                end do
        
            end do
                
        end do
            
        close(5)
                
        open(unit=7,file="mass_by_ownership_status"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=0,1
                
                do k=1,employment_grid_size
                                                    
                    write(7,*) mass_by_ownership_status(j,i,k)
                        
                end do
        
            end do
                
        end do
            
        close(7)
        
        open(unit=8,file="homeownership_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                
            do i=1,employment_grid_size
                            
                write(8,*) homeownership_by_employment(j,i)
                        
            end do
                
        end do
            
        close(8)
        
        sum_of_distribution_employment(:)=0
        
        do k=1,employment_grid_size
        
            do i=1,2
                            
                sum_of_distribution_employment(k)=sum_of_distribution_employment(k)+&
                    sum(distribution_stationary(i)%vector_transition_real(time_period,:,:,:,k,:,:))
                                
            end do
            
        end do
        
        open(unit=8,file="tenure_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=1,3
                
                do k=1,employment_grid_size
                            
                    write(8,*) 100*tenure_by_employment(j,k,i)/sum_of_distribution_employment(k)
                
                end do
                
            end do
                
        end do
            
        close(8)
        
        open(unit=8,file="tenure_by_income_quintile"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=1,3
                
                do k=1,number_of_quintiles
                            
                    write(8,*) 100*(tenure_by_income_quintile(j,k,i)/mass_of_quintile(k))
                
                end do
                
            end do
                
        end do
            
        close(8)
        
        open(unit=9,file="housing_size_by_employment"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                                
            do i=1,employment_grid_size
                
                write(9,*) housing_size_by_employment(j,i)
                                    
            end do
                
        end do
                
        close(9)
        
        open(unit=9,file="housing_size_by_employment_and_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                                
            do i=1,employment_grid_size
            
                do age_index=1,life_span
                
                    write(9,*) housing_size_by_employment_and_age(j,i,age_index)
                        
                end do
                                    
            end do
                
        end do
            
        close(9)
        
        open(unit=9,file="consumption_by_employment_and_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                                
            do i=1,employment_grid_size
            
                do age_index=1,life_span
                
                    write(9,*) consumption_by_employment_and_age(j,i,age_index)
                        
                end do
                                    
            end do
                
        end do
            
        close(9)
        
        open(unit=9,file="wealth_by_employment_and_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                                
            do i=1,employment_grid_size
            
                do age_index=1,life_span
                
                    write(9,*) wealth_by_employment_and_age(j,i,age_index)
                        
                end do
                                    
            end do
                
        end do
            
        close(9)
        
        open(unit=10,file="homeownership_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                        
            do age_index=1,life_span
                                            
                write(10,*) homeownership_by_age(j,age_index)
                    
            end do
                
        end do
            
        close(10)
        
        open(unit=10,file="model_assets_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                        
            do age_index=1,life_span
                                            
                write(10,*) model_assets_by_age(j,age_index)/model_average_income(j)
                    
            end do
                
        end do
            
        close(10)
                
        open(unit=11,file="housing_size_by_age"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                        
            do age_index=1,life_span
                            
                write(11,*) housing_size_by_age(j,age_index)
                                        
            end do
                
        end do
            
        close(11)
                                                    
    end subroutine
    
    subroutine allocate_matrix()
    
        use Global_Vars
        
        implicit none
        
        integer :: is_owner
        
        index_of_smallest_house_hhld_can_buy=smallest_index_for_purchase
                
        do i=1,2
        
            if (i==2) then
            
                is_owner=1
                
            else
            
                is_owner=0
                
            end if
            
            allocate(income_matrix(i)%&
                vector_real_income(life_span+1,1:financial_grid_size,unemployment_grid_size,employment_grid_size,&
                lowest_housing_grid_point:housing_status_grid_size-1,0:include_vouchers))
                
            allocate(income_matrix_saved(i)%&
                vector_real_income(life_span+1,1:financial_grid_size,unemployment_grid_size,employment_grid_size,&
                lowest_housing_grid_point:housing_status_grid_size-1,0:include_vouchers))
        
            allocate(value_function(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                    
            allocate(policy_function_wage_income_tax_paid(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            allocate(policy_function_mortgage_interest_deductions(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            allocate(policy_function_consumption(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                        
            allocate(policy_function_space_lived_in_size(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                                                
            allocate(policy_function_labor_supply(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_cutoff_taxable_income(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_frac_spent_on_addiction(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_total_consumption(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_addiction(i)%&
                vector_transition_integer(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                        
            allocate(frac_mov_optimal_1(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                       
            allocate(distribution_guess(i)%&
                vector_transition_real((1-solve_transition_dynamics):transition_length,&
                life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            allocate(distribution_implied(i)%&
                vector_transition_real(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            allocate(distribution_stationary(i)%&
                vector_transition_real((1-solve_transition_dynamics):transition_length,life_span+1,&
                is_owner*1+(1-is_owner)*negative_financial_grid_size:financial_grid_size,&
                unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(distribution_forward(i)%&
                vector_transition_real((1-solve_transition_dynamics):transition_length,life_span+1,&
                is_owner*1+(1-is_owner)*negative_financial_grid_size:financial_grid_size,&
                unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
            
            allocate(policy_function_financial_index(i)%&
                vector_transition_integer(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                       
            allocate(policy_function_housing_status_index(i)%&
                vector_transition_integer(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                        
            allocate(policy_function_space_lived_in_index(i)%&
                vector_transition_integer(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            allocate(policy_function_years_of_amortization_index(i)%&
                vector_transition_integer(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                                
            allocate(fin_index_frac_mov_to_optimal(i)%&
                vector_transition_integer(transition_length,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                       
            allocate(distribution_implied_private(i)%&
                vector_cpu_real(max_CPUs,life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                                    
            allocate(value_function_guess(i)%&
                vector_youngest_real(is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
            
        end do
        
        do i=1,2
        
            if (i==2) then
            
                is_owner=1
                
            else
            
                is_owner=0
                
            end if            
        
            allocate(value_function_benchmark(i)%vector_real(life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(value_function_comparison(i)%vector_real(life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            allocate(distribution_stationary_benchmark(i)%&
                vector_real(life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
            
            allocate(policy_function_labor_supply_benchmark(i)%vector_real&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_total_consumption_benchmark(i)%vector_real&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_consumption_benchmark(i)%vector_real&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_addiction_benchmark(i)%vector_integer&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(frac_mov_optimal_1_benchmark(i)%vector_real&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_frac_spent_on_addiction_benchmark(i)%vector_real&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_housing_status_index_benchmark(i)%vector_integer&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_years_of_amortization_index_benchmark(i)%vector_integer&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(policy_function_financial_index_benchmark(i)%vector_integer&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                
            allocate(fin_index_frac_mov_to_optimal_benchmark(i)%vector_integer&
                (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                financial_grid_size,unemployment_grid_size,employment_grid_size,(1-is_owner)*lowest_housing_grid_point+&
                is_owner*index_of_smallest_house_hhld_can_buy:housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))    
                                            
        end do
        
        if (solve_transition_dynamics==1) then
        
            do i=1,2
            
                if (i==2) then
            
                    is_owner=1
                    
                else
                
                    is_owner=0
                    
                end if
            
                allocate(distribution_to_fetch(i)%vector_real&
                    (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                    financial_grid_size,unemployment_grid_size,employment_grid_size,&
                    (1-is_owner)*lowest_housing_grid_point+is_owner*index_of_smallest_house_hhld_can_buy:&
                    housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                    
                allocate(policy_function_space_lived_in_size_to_fetch(i)%vector_real&
                    (life_span+1,is_owner*1+(1-is_owner)*negative_financial_grid_size:&
                    financial_grid_size,unemployment_grid_size,employment_grid_size,&
                    (1-is_owner)*lowest_housing_grid_point+is_owner*index_of_smallest_house_hhld_can_buy:&
                    housing_status_grid_size-1,0:(1-is_owner)*include_vouchers))
                        
            end do
            
        end if
        
        allocate(unemployment_process(life_span,unemployment_grid_size,unemployment_grid_size,2,&
            0:include_addiction,employment_grid_size))
                    
    end subroutine
    
    subroutine cleanup_matrix()
        
        use Global_Vars
        
        implicit none
                
        do i=1,2
        
            if (allocated(income_matrix(i)%vector_real_income)) then
            
                deallocate(income_matrix(i)%vector_real_income)
                
            end if
            
            if (allocated(income_matrix_saved(i)%vector_real_income)) then
            
                deallocate(income_matrix_saved(i)%vector_real_income)
                
            end if
                    
            if (allocated(value_function(i)%vector_transition_real)) then
            
                deallocate(value_function(i)%vector_transition_real)
                
            end if
                        
            if (allocated(policy_function_wage_income_tax_paid(i)%vector_transition_real)) then
            
                deallocate(policy_function_wage_income_tax_paid(i)%vector_transition_real)
                
            end if
        
            if (allocated(policy_function_mortgage_interest_deductions(i)%vector_transition_real)) then
            
                deallocate(policy_function_mortgage_interest_deductions(i)%vector_transition_real)
                
            end if
                   
            if (allocated(policy_function_consumption(i)%vector_transition_real)) then
            
                deallocate(policy_function_consumption(i)%vector_transition_real)
                
            end if
                                  
            if (allocated(policy_function_space_lived_in_size(i)%vector_transition_real)) then
            
                deallocate(policy_function_space_lived_in_size(i)%vector_transition_real)
                
            end if
            
            if (allocated(policy_function_frac_spent_on_addiction(i)%vector_transition_real)) then
            
                deallocate(policy_function_frac_spent_on_addiction(i)%vector_transition_real)
                
            end if

            if (allocated(policy_function_total_consumption(i)%vector_transition_real)) then
            
                deallocate(policy_function_total_consumption(i)%vector_transition_real)
                
            end if
            
            if (allocated(policy_function_addiction(i)%vector_transition_integer)) then
            
                deallocate(policy_function_addiction(i)%vector_transition_integer)
                
            end if
            
            if (allocated(policy_function_cutoff_taxable_income(i)%vector_transition_real)) then
            
                deallocate(policy_function_cutoff_taxable_income(i)%vector_transition_real)
                
            end if
            
            if (allocated(policy_function_labor_supply(i)%vector_transition_real)) then
            
                deallocate(policy_function_labor_supply(i)%vector_transition_real)
                
            end if
                        
            if (allocated(frac_mov_optimal_1(i)%vector_transition_real)) then
            
                deallocate(frac_mov_optimal_1(i)%vector_transition_real)
                
            end if
            
            if (allocated(distribution_guess(i)%vector_transition_real)) then
            
                deallocate(distribution_guess(i)%vector_transition_real)
                
            end if
            
            if (allocated(distribution_implied(i)%vector_transition_real)) then
            
                deallocate(distribution_implied(i)%vector_transition_real)
                
            end if
            
            if (allocated(distribution_stationary(i)%vector_transition_real)) then
            
                deallocate(distribution_stationary(i)%vector_transition_real)
                
            end if
            
            if (allocated(distribution_forward(i)%vector_transition_real)) then
            
                deallocate(distribution_forward(i)%vector_transition_real)
                
            end if
            
            if (allocated(policy_function_financial_index(i)%vector_transition_integer)) then
            
                deallocate(policy_function_financial_index(i)%vector_transition_integer)
                
            end if
            
            if (allocated(policy_function_housing_status_index(i)%vector_transition_integer)) then
            
                deallocate(policy_function_housing_status_index(i)%vector_transition_integer)
                
            end if
                        
            if (allocated(policy_function_space_lived_in_index(i)%vector_transition_integer)) then
            
                deallocate(policy_function_space_lived_in_index(i)%vector_transition_integer)
                
            end if
            
            if (allocated(policy_function_years_of_amortization_index(i)%vector_transition_integer)) then
            
                deallocate(policy_function_years_of_amortization_index(i)%vector_transition_integer)
                
            end if
                                              
            if (allocated(fin_index_frac_mov_to_optimal(i)%vector_transition_integer)) then
            
                deallocate(fin_index_frac_mov_to_optimal(i)%vector_transition_integer)
                
            end if
            
            if (allocated(distribution_implied_private(i)%vector_cpu_real)) then
            
                deallocate(distribution_implied_private(i)%vector_cpu_real)
                
            end if
                        
            if (allocated(value_function_guess(i)%vector_youngest_real)) then
            
                deallocate(value_function_guess(i)%vector_youngest_real)
                
            end if
                                                   
        end do
        
        do i=1,2
        
            if (allocated(value_function_benchmark(i)%vector_real)) then
                
                deallocate(value_function_benchmark(i)%vector_real)
                
            end if
            
            if (allocated(value_function_comparison(i)%vector_real)) then
                
                deallocate(value_function_comparison(i)%vector_real)
                
            end if
            
            if (allocated(distribution_stationary_benchmark(i)%vector_real)) then
            
                deallocate(distribution_stationary_benchmark(i)%vector_real)
                
            end if            
            
            if (allocated(policy_function_labor_supply_benchmark(i)%vector_real)) then
            
                deallocate(policy_function_labor_supply_benchmark(i)%vector_real)
                
            end if
            
            if (allocated(policy_function_total_consumption_benchmark(i)%vector_real)) then
            
                deallocate(policy_function_total_consumption_benchmark(i)%vector_real)
                
            end if
            
            if (allocated(policy_function_consumption_benchmark(i)%vector_real)) then
            
                deallocate(policy_function_consumption_benchmark(i)%vector_real)
                
            end if
            
            if (allocated(frac_mov_optimal_1_benchmark(i)%vector_real)) then
            
                deallocate(frac_mov_optimal_1_benchmark(i)%vector_real)
                
            end if
            
            if (allocated(policy_function_housing_status_index_benchmark(i)%vector_integer)) then
            
                deallocate(policy_function_housing_status_index_benchmark(i)%vector_integer)
                
            end if
            
            if (allocated(policy_function_addiction_benchmark(i)%vector_integer)) then
            
                deallocate(policy_function_addiction_benchmark(i)%vector_integer)
                
            end if
            
            if (allocated(policy_function_years_of_amortization_index_benchmark(i)%vector_integer)) then
            
                deallocate(policy_function_years_of_amortization_index_benchmark(i)%vector_integer)
                
            end if
            
            if (allocated(policy_function_financial_index_benchmark(i)%vector_integer)) then
            
                deallocate(policy_function_financial_index_benchmark(i)%vector_integer)
                
            end if
            
            if (allocated(fin_index_frac_mov_to_optimal_benchmark(i)%vector_integer)) then
            
                deallocate(fin_index_frac_mov_to_optimal_benchmark(i)%vector_integer)
                
            end if
            
            if (allocated(policy_function_frac_spent_on_addiction_benchmark(i)%vector_real)) then
            
                deallocate(policy_function_frac_spent_on_addiction_benchmark(i)%vector_real)
                
            end if
            
        end do
        
        if (solve_transition_dynamics==1) then
        
            do i=1,2
            
                if (allocated(distribution_to_fetch(i)%vector_real)) then
                
                    deallocate(distribution_to_fetch(i)%vector_real)
                    
                end if
                
                if (allocated(policy_function_space_lived_in_size_to_fetch(i)%vector_real)) then
                
                    deallocate(policy_function_space_lived_in_size_to_fetch(i)%vector_real)
                    
                end if
            
            end do
            
        end if
        
        deallocate(unemployment_process)

    end subroutine
    
    subroutine calibrating_model()
    
        use Global_Vars
        
        implicit none
        
        logical :: file_exists
        
        real(8) :: mass_at_top_financial,a,b,c,d
        character*1 :: string_used
        integer :: last_period_of_life,addiction_index
                                
        simulation_ended=0
                                        
        call cpu_time(simulation_start_time)
        
        lump_sum_transfer(1)=0
        
        model_average_owner_occupied_unit_size(1)=calibrated_stationary_housing_price*&
            average_owner_occupied_house_size_calibrated
            
        model_average_rental_unit_size(1)=0.116

        loop_count=0  
        
        model_bequests(1)=2.5238247842094039

        model_average_income(1)=average_labor_income_calibrated
        model_average_income_plus_assets(1)=average_labor_income_calibrated
        model_average_income_plus_all_assets(1)=average_labor_income_calibrated
        model_average_labour_income(1)=average_labor_income_calibrated
        model_average_labour_income_by_employment(1,:)=average_labor_income_by_employment_calibrated
        median_income(1)=median_income_calibrated
        model_average_financial(1)=average_financial_calibrated
        model_average_net_wealth(1)=average_net_wealth_calibrated
        
        call allocate_matrix()
        
        call initialize_variables_and_grids()
        call GKKOC_intergenerational_employment_process(1)
        call initialize_financial_grid(1)
                
        call initialize_feasible_distribution(1)
            
        if (use_old_results==1) then
        
            call upload_vars(1)
            
        else
        
            housing_price(1)=calibrated_stationary_housing_price
                    
            rent(1,:)=rent_to_housing_price*housing_price(1)*1.05
                                          
            risk_free_rate(1)=calibrated_risk_free_rate
            mortgage_interest_rate(1)=risk_free_rate(1)+mortgage_interest_gap
            
            model_average_labour_income(1)=average_labor_income_calibrated
            total_housing_demand(1)=calibrated_housing_stock
            
            total_rental_demand(1,:)=total_rental_supply_calibrated
            total_rental_supply(1,:)=total_rental_supply_calibrated
            
        end if
                
        call function_of_utility_advantage_from_homeowning(1)
                                               
        call set_SS_benefits(1)
        
        call function_of_utility_advantage_from_homeowning(1)
        call initialize_financial_grid(1)
                
        distance_value_function=1
        distance_discount_factor=1
        distance_discount_factor_on_child=1
        distance_minimum_inheritance=1
        distance_advantage_to_owning=1
        distance_relative_share_of_housing=1
        distance_relative_share_of_leisure=1
        distance_standard_deduction=1
        distance_housing_status_grid_expander=1
        distance_rent_to_price=1
        distance_smallest_house_size=1
        distance_rental_market=1
        distance_fixed_cost_to_moving=1
        distance_average_labor_income=1
        distance_inheritance_amount=1
        distance_size_homelessness=1
        
        do i=1,2
        
            value_function_guess(i)%vector_youngest_real(:,:,:,:,:)=0
            value_function(i)%vector_transition_real(1,:,:,:,:,:,:)=0
            
        end do
                                                          
        write(*,*) "mortgage_deductibility=", mortgage_deductibility
        write(*,*) "mortgage_interest_rate=", mortgage_interest_rate(1)
        write(*,*) "risk_free_rate=", risk_free_rate(1)
        write(*,*) "property_tax(1)=", property_tax(1)
        write(*,*) "infinite_elasticity_of_rental_supply=", infinite_elasticity_of_rental_supply
        write(*,*) "life_span=", life_span
        write(*,*) "retirement_span=", retirement_span    
        write(*,*) "discount_factor=", discount_factor
        write(*,*) "discount_factor_on_child=", discount_factor_on_child
        write(*,*) "minimum_inheritance=", minimum_inheritance
        write(*,*) "size_homelessness=", size_homelessness
        write(*,*) "labor_income_tax_rate=", labor_income_tax_rate
        write(*,*) "curvature_of_labor_income_taxes=", curvature_of_labor_income_taxes
        write(*,*) "rent_to_housing_price=", rent_to_housing_price
        write(*,*) "personal_deduction=", personal_exemption
        write(*,*) "standard_deduction=", standard_deduction      
        write(*,*) "rent=",rent(1,:)
        write(*,*) "lump_sum_transfer=", lump_sum_transfer(1)
        write(*,*) "minimum_downpayment=", minimum_downpayment
        write(*,*) "max_amortization_years=", max_amortization_years
        write(*,*) "model_average_owner_occupied_unit_size(1)=", model_average_owner_occupied_unit_size(1)
        write(*,*) "smallest_house_size=", smallest_house_size
        write(*,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", housing_size(index_of_smallest_house_hhld_can_buy)
        write(*,*) "c_1=", c_1
        write(*,*) "c_min=", c_min
        write(*,*) "cutoff_housing_investment=", cutoff_housing_investment
        write(*,*) "infinite_elasticity_of_rental_supply=", infinite_elasticity_of_rental_supply
        write(*,*) "calibration"
        write(*,*) "advantage_to_owning=", advantage_to_owning
        write(*,*) "unconditional_employment_probability=", unconditional_employment_probability
                
        if (use_old_results==0) then
                    
            rent(1,:)=housing_price(1)*himmelberg_etal_rent_to_price
            
        end if
        
        model_average_rent(1)=1.079
        
        call set_smallest_house_size()
        
        call function_of_utility_advantage_from_homeowning(1)
                 
        write(*,*) "rent=", rent(1,:)
                  
        write(*,*) "property_tax=", property_tax
        write(*,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
        write(*,*) "max_debt_to_income_ratio_below_80=", max_debt_to_income_ratio_below_80
        write(*,*) "smallest_house_size=", smallest_house_size
        write(*,*) "housing_size(smallest_house_to_buy)=", housing_size(index_of_smallest_house_hhld_can_buy)
        write(*,*) "lowest_housing_grid_point=", lowest_housing_grid_point
        write(*,*) "employment_grid=", employment_grid(1,:)
        write(*,*) "value_of_initial_assets=", value_of_initial_assets
        write(*,*) "initial_endowment=", initial_endowment      
        write(*,*) "standard_deduction=", standard_deduction
        write(*,*) "personal_exemption=", personal_exemption
        write(*,*) "model_average_labour_income=", model_average_labour_income(1)
        write(*,*) "average_labor_income_calibrated=", average_labor_income_calibrated
        write(*,*) "weight_on_labor_income=", weight_on_labor_income
        write(*,*) "inheritance_amount=", inheritance_amount
        write(*,*) "relative_share_of_leisure=", relative_share_of_leisure
        
        INQUIRE(FILE="total_rental_demand"//trim(long_run_simulation)//".dat", EXIST=file_exists)
                
!        if ((re_calibrate_management_costs==1) .AND. (zero_elasticity==0) .AND. &
!            (infinite_elasticity_of_rental_supply==0) .AND. (file_exists)) then
!        
!            open(unit=39,file="total_rental_demand"//trim(long_run_simulation)//".dat",action='read')
!                read(39,'(F15.12)') total_rental_demand(1,:)
!            close(39)
!            
!            do j=0,have_two_rental_markets
!                        
!                call solve_elasticity_of_rental_housing(1,convexity_of_rental_company(j),j)
!                        
!                rental_management_costs=&
!                    (rent(1,j)-housing_price(1)*&
!                    (risk_free_rate(1)+housing_depreciation_rate+property_tax(1)+&
!                    property_tax_on_rental_housing)/(1+risk_free_rate(1)))/&
!                    ((total_rental_demand_segmented(1,j)**&
!                    (convexity_of_rental_company(j)-1))*convexity_of_rental_company(j))
!                    
!            end do
!        
!            open(unit=27,file="rental_management_costs"//trim(file_number)//".dat",status='replace')
!                write(27,'(F30.29)') rental_management_costs
!            close(27)
!            
!            open(unit=27,file="convexity_of_rental_company"//trim(file_number)//".dat",status='replace')
!                write(27,'(F15.12)') convexity_of_rental_company
!            close(27)
!                                    
!        end if
        
        write(*,*) "rental_management_costs=", rental_management_costs
        write(*,*) "file_number=", file_number
        write(*,*) "fraction_to_repay=", fraction_to_repay         
        write(*,*) "prepayment_penalty_starts_from=", prepayment_penalty_starts_from
        write(*,*) "file_number=", file_number
        write(*,*) "empirical_housing_supplpy_elasticity=", empirical_housing_supplpy_elasticity
        write(*,*) "replacement_rate_ui=", replacement_rate_ui
        write(*,*) "size_homelessness=", size_homelessness
        write(*,*) "model_average_financial=", model_average_financial(1)
        write(*,*) "model_average_net_wealth=", model_average_net_wealth(1)
        write(*,*) "relative_share_of_addiction=", relative_share_of_addiction_2
        write(*,*) "relative_share_of_consumption_2=", relative_share_of_consumption_2
        write(*,*) "relative_share_of_housing_2=", relative_share_of_housing_2
        write(*,*) "relative_share_of_addiction_2=", relative_share_of_addiction_1
        write(*,*) "relative_share_of_consumption_1=", relative_share_of_consumption_1
        write(*,*) "relative_share_of_housing_1=", relative_share_of_housing_1
        write(*,*) "relative_share_of_addiction_1=", relative_share_of_addiction_1
        write(*,*) "sum 2=", relative_share_of_consumption_2+relative_share_of_housing_2+relative_share_of_addiction_2
        write(*,*) "sum 1=", relative_share_of_consumption_1+relative_share_of_housing_1+relative_share_of_addiction_1
        write(*,*) "model_ss_benefits=", model_ss_benefits
        write(*,*) "price_of_addictive_good=", price_of_addictive_good
        write(*,*) "hello1"
        write(*,*) "expected_age_non_addicted=", expected_age_non_addicted+25
        write(*,*) "expected_age_homeless=", expected_age_homeless+25
        write(*,*) "expected_age_addicted=", expected_age_addicted+25
        write(*,*) "expected_age_homeless_and_addicted=", expected_age_homeless_and_addicted+25
                
        previous_average_labor_income=model_average_labour_income(1)
        previous_median_income=median_income(1)
        previous_average_net_wealth=model_average_net_wealth(1)
        previous_inheritance_amount=inheritance_amount
        
        write(*,*) "adjusted_probability=", adjusted_probability(:)
        write(*,*) "probability_of_voucher=", probability_of_voucher
        write(*,*) "addiction_scalar_1=", addiction_scalar_1
        
        do i=1,employment_grid_size
            write(*,*) "employment_grid(",i,")=", employment_grid(1,i)
        end do
        
        do i=1,employment_grid_size
            write(*,*) "employment_grid(",i,")=", employment_grid(30,i)
        end do
        
        write(*,*) "increased_risk_of_death_addicted=", increased_risk_of_death_addicted
        write(*,*) "multiple_of_probabilities_of_employment_if_addicted=", multiple_of_probabilities_of_employment_if_addicted
        write(*,*) "relative_share_of_addiction_2=", relative_share_of_addiction_2
        write(*,*) "relative_share_of_addiction_1=", relative_share_of_addiction_1
        write(*,*) "size_of_penalty=", size_of_penalty
        write(*,*) "voucher_probabilities=", voucher_probabilities(0,1,1,:)
        write(*,*) "voucher_probabilities=", voucher_probabilities(1,1,1,:)
        write(*,*) "voucher_probabilities_benchmark=", voucher_probabilities_benchmark(0,1,1,:)
        write(*,*) "voucher_probabilities_benchmark=", voucher_probabilities_benchmark(1,1,1,:)
        
        write(*,*) "increased_risk_of_death_addicted*(1-sum(actual_survival_probability)/life_span)=", &
            increased_risk_of_death_addicted*(1-sum(actual_survival_probability)/life_span)
                        
        do while((distance_rental_market(1)>stopping_rule_rental_market) .OR. &
            (distance_discount_factor>stopping_rule_discount_factor) .OR. &
            (distance_discount_factor_on_child>stopping_rule_discount_factor_on_child) .OR. &
            (distance_minimum_inheritance>stopping_rule_minimum_inheritance) .OR. &
            (distance_advantage_to_owning>stopping_rule_advantage_to_owning) .OR. &
            (distance_relative_share_of_housing>stopping_rule_relative_share_of_housing) .OR. &
            (distance_relative_share_of_leisure>stopping_rule_relative_share_of_leisure) .OR. &
            (distance_convexity_of_rental_company>stopping_rule_convexity_of_rental_company) .OR. &
            (distance_housing_status_grid_expander>stopping_rule_housing_status_grid_expander) .OR. &
            (distance_rent_to_price>stopping_rule_rent_to_price) .OR. &
            (distance_smallest_house_size>stopping_rule_smallest_house_size) .OR. &
            (distance_fixed_cost_to_moving>stopping_rule_fixed_cost_to_moving) .OR. &
            (distance_standard_deduction>stopping_rule_standard_deduction) .OR. &
            (distance_inheritance_amount>stopping_rule_inheritance_amount) .OR. &
            (distance_size_homelessness>stopping_rule_size_homelessness) .OR. &
            (distance_average_labor_income>stopping_rule_average_labor_income) .OR. &
            (distance_median_income>stopping_rule_median_income) .OR. &
            (distance_average_net_wealth>stopping_rule_average_net_wealth) .OR. (loop_count<1))
                        
            call solve_value_function_and_policy_functions(1)
                            
            if ((loop_count<3) .OR. (re_do_simulation_with_fixed_parameters==1)) then
            
                call initialize_feasible_distribution(1)
                
            end if
            
            if (loop_count<=1) then
            
                stopping_rule_stationary_distribution=10.d0**(-8)
                
            else
            
                stopping_rule_stationary_distribution=10.d0**(-8)
            
            end if
            
            if (include_addiction==1) then
            
                stopping_rule_stationary_distribution=2*10.d0**(-4)
            
            end if
            
            if (load_test_distribution==0) then
            
                call converge_to_stationary_equilibrium(1)
                
            else
            
                do i=1,2
    
                    write(string_used,'(i1)') i
                                   
                    open(unit=10,file="distribution_stationary"//trim(string_used)//trim(old_results)//".dat",action='read')
                        read(10,'(F30.28)') distribution_stationary(i)%vector_transition_real(1,:,:,:,:,:,:)
                    close(10)
                    
                end do
                
            end if
            
            previous_average_labor_income=model_average_labour_income(1)
            previous_median_income=median_income(1)
            previous_average_net_wealth=model_average_net_wealth(1)
            
            previous_inheritance_amount=inheritance_amount
            
            call stationary_equilibrium_statistics(1)
            call stationary_equilibirum_homeownership_rate(1)
            call govt_revenues_calc(1)
            call calculate_aggregate_consumption(1)
            call calculate_welfare(1)
            call calculate_household_housing_spending(1)
            call calculate_welfare_by_characteristics(1)
                        
            call calculate_homeownership_by_characteristics(1)            
            call stationary_equilibrium_wealth_distribution_of_old(1)
            
            if (loop_count>0) then
            
                if (include_bequests==1) then
            
                    if (inheritance_function_of_productivity==0) then
            
                        if (include_bequests_in_govt_constraint==0) then
                        
                            call calculate_updated_inheritance_amounts(1)
                                        
                        end if
                        
                        distance_inheritance_amount=maxval((1-include_bequests_in_govt_constraint)*&
                            abs(previous_inheritance_amount-inheritance_amount))
                        
                        inheritance_amount=inheritance_amount_weight*inheritance_amount+&
                            (1-inheritance_amount_weight)*previous_inheritance_amount
                            
                    else
                    
                        distance_inheritance_amount=&
                            abs(model_bequests(1)-value_of_initial_assets-model_total_inheritance(1))
                        
                        inheritance_amount=inheritance_amount+&
                             inheritance_amount_adjuster*&
                             (model_bequests(1)-value_of_initial_assets-model_total_inheritance(1))
                    
                    end if
                        
                else
                    
                    distance_inheritance_amount=0
                    
                end if
                    
            else
            
                distance_inheritance_amount=1
            
            end if
                             
            if (re_do_simulation_with_fixed_parameters==1) then
            
                distance_discount_factor=0
                distance_discount_factor_on_child=0
                distance_minimum_inheritance=0
                distance_housing_status_grid_expander=0
                distance_rent_to_price=0
                distance_smallest_house_size=0
                distance_advantage_to_owning=0
                distance_relative_share_of_housing=0
                distance_relative_share_of_leisure=0
                distance_standard_deduction=0
                distance_convexity_of_rental_company=0
                distance_fixed_cost_to_moving=0
                distance_size_homelessness=0
                        
            else
            
                if (loop_count>aftr_how_mny_lps_start_update) then
            
                    write(*,*) "discount_factor=", discount_factor
                                            
                    discount_factor=min(max(discount_factor+discount_factor_adjuster*&
                        ((model_mortgages(1)/model_gross_housing_wealth(1))-&
                        SCF_mortgage_to_gross_housing_wealth),0.d0),1.3)  ! Standard
                
                    distance_discount_factor=abs(((model_mortgages(1)/model_gross_housing_wealth(1))-&
                        SCF_mortgage_to_gross_housing_wealth))
                                         
                    write(*,*) "discount_factor=", discount_factor
                    write(*,*) "distance_discount_factor=", distance_discount_factor
                    write(*,*) "model_total_net_wealth(1)/model_GDP_incl_imput_rent(1)=", &
                        model_total_net_wealth(1)/model_GDP_incl_imput_rent(1)
                    write(*,*) "model_fraction_of_homeowners_with_mortgage(1)=", &
                        model_fraction_of_homeowners_with_mortgage(1)
                    write(*,*) "(model_mortgages(1)/model_gross_housing_wealth(1))=", &
                        (model_mortgages(1)/model_gross_housing_wealth(1))
                                            
                    write(*,*) "discount_factor_on_child=", discount_factor_on_child
                    
                    if (target_HO_of_old==1) then
                
                        discount_factor_on_child=min(max(discount_factor_on_child-&
                            discount_factor_on_child_adjuster*(model_homeownership_by_age_group(1,5)-&
                            homeownership_rate_of_old_data),0.005),10000.d0) 
                            
                        distance_discount_factor_on_child=&
                            abs(model_homeownership_by_age_group(1,5)-homeownership_rate_of_old_data)
                            
                        write(*,*) "model_homeownership_by_age_group=", model_homeownership_by_age_group(1,5)
                        
                    else
                    
                        discount_factor_on_child=min(max(discount_factor_on_child-&
                            discount_factor_on_child_adjuster*&
                            ((model_median_assets_to_income(1)/model_median_assets_to_income(3))-&
                            median_nw_to_income_old_to_mid_age_data),0.005),10000.d0) 
                            
                        distance_discount_factor_on_child=&
                            abs((model_median_assets_to_income(1)/model_median_assets_to_income(3))-&
                            median_nw_to_income_old_to_mid_age_data)
                    
                    end if
                            
                    write(*,*) "discount_factor_on_child=", discount_factor_on_child

                    write(*,*) "minimum_inheritance=", minimum_inheritance
                
                    minimum_inheritance=min(max(minimum_inheritance+minimum_inheritance_adjuster*&
                        (model_fraction_leaving_bequests(1)-fraction_leaving_bequests_data),0.d0),150.d0) 
                        
                    distance_minimum_inheritance=&
                        abs(model_fraction_leaving_bequests(1)-fraction_leaving_bequests_data)
                        
                    write(*,*) "minimum_inheritance=", minimum_inheritance
                    write(*,*) "model_fraction_leaving_bequests=", model_fraction_leaving_bequests(1)
                                                                 
                    if (advantage_to_owning_adjuster>0) then
                    
                        write(*,*) "advantage_to_owning=", advantage_to_owning
                    
                        advantage_to_owning=min(max(advantage_to_owning-advantage_to_owning_adjuster*&
                            (model_homeownership_rate(1)-SCF_homeownership_rate),0.d0),10000.d0) 
                                                                    
                        distance_advantage_to_owning=abs(model_homeownership_rate(1)-SCF_homeownership_rate)
                        
                        write(*,*) "advantage_to_owning=", advantage_to_owning
                        write(*,*) "distance_advantage_to_owning=", distance_advantage_to_owning
                        write(*,*) "model_homeownership_rate(1)=", model_homeownership_rate(1)
                        
                        distance_rent_to_price=0
                        
                    else
                        
                        distance_advantage_to_owning=0
                        distance_rent_to_price=0
                            
                    end if
                        
                    write(*,*) "relative_share_of_housing=", relative_share_of_housing 
                    
                    if (target_renters_rent_to_income==1) then
                                        
                        relative_share_of_housing=&
                            min(max(relative_share_of_housing-relative_share_of_housing_adjuster*&
                            (model_avg_housing_spending_renters(1)-FRED_housing_services_to_GDP),0.01),0.9) 
                                                                     
                        distance_relative_share_of_housing=&
                            abs(model_avg_housing_spending_renters(1)-FRED_housing_services_to_GDP)
                                    
                        write(*,*) "model_avg_housing_spending_all=", model_avg_housing_spending_renters(1)
                            
                    else
                    
                        relative_share_of_housing=&
                            min(max(relative_share_of_housing-relative_share_of_housing_adjuster*&
                            (mass_of_renters_at_housing_spending(1,1)-SW_renters_spend_over_X_on_hous_2),0.01),0.9) 
                                                                     
                        distance_relative_share_of_housing=&
                            abs(mass_of_renters_at_housing_spending(1,1)-SW_renters_spend_over_X_on_hous_2)
                                    
                        write(*,*) "mass_of_renters_at_housing_spending(1,1)=", mass_of_renters_at_housing_spending(1,1)
                    
                    end if
                                                 
                    write(*,*) "relative_share_of_housing=", relative_share_of_housing 
                    write(*,*) "distance_relative_share_of_housing=", distance_relative_share_of_housing
                                        
                    write(*,*) "relative_share_of_housing=", relative_share_of_housing 
                                    
                    relative_share_of_leisure=&
                        min(max(relative_share_of_leisure+relative_share_of_leisure_adjuster*&
                        (model_labor_supply(1)/model_total_hours(1)-avg_labor_supply_data),0.01),1000.d0) 
                                                                 
                    distance_relative_share_of_leisure=&
                        abs(model_labor_supply(1)/model_total_hours(1)-avg_labor_supply_data)
                                
                    write(*,*) "model_labor_supply(1)/model_total_hours(1)=", &
                        model_labor_supply(1)/model_total_hours(1)
                                                 
                    write(*,*) "relative_share_of_housing=", relative_share_of_leisure
                    write(*,*) "distance_relative_share_of_housing=", distance_relative_share_of_housing
                                             
                    write(*,*) "housing_status_grid_expander=", housing_status_grid_expander
                        
                    if (calibrate_size_of_smallest_house_hhld_can_buy==1) then
                    
                        housing_status_grid_expander=&
                            min(max(housing_status_grid_expander-housing_status_grid_expander_adjuster*&
                            (model_homeownership_rate(1)-SCF_homeownership_rate),0.0),5.d0) 
                                                                     
                        distance_housing_status_grid_expander=&
                            abs(model_homeownership_rate(1)-SCF_homeownership_rate)
                            
                        distance_rent_to_price=0
                                                
                    else
                    
                        distance_housing_status_grid_expander=0
                        distance_rent_to_price=0
                        
                    end if
                    
                    if ((calibrate_size_of_smallest_house_hhld_can_buy==0) .AND. &
                        (advantage_to_owning_adjuster==0)) then
                        
                        write(*,*) "rent(1)/housing_price=", rent(1,:)/housing_price(1)
                        
                        distance_rent_to_price=abs(model_homeownership_rate(1)-SCF_homeownership_rate)
                            
                        rent(1,:)=rent(1,:)-rent_to_price_adjuster*&
                            (model_homeownership_rate(1)-SCF_homeownership_rate)
                        
                        write(*,*) "rent(1)/housing_price=", rent(1,:)/housing_price(1)
                        write(*,*) "distance_rent_to_price=", distance_advantage_to_owning
                        write(*,*) "model_homeownership_rate(1)=", model_homeownership_rate(1)
                        
                    else
                    
                        write(*,*) "rent(1)=", rent(1,:)
                    
                        rent(1,:)=rent(1,:)-rent_to_price_adjuster*&
                            (rent(1,:)/housing_price(1)-rent_to_housing_price)
                            
                        write(*,*) "rent(1)=", rent(1,:)
                            
                    end if
                    
                    write(*,*) "size_of_smallest_house_hhld_can_buy=", size_of_smallest_house_hhld_can_buy
                    write(*,*) "housing_status_grid_expander=", housing_status_grid_expander
                    write(*,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", &
                        housing_size(index_of_smallest_house_hhld_can_buy)
                    write(*,*) "model_fraction_of_homeowners_with_mortgage(1)=", model_fraction_of_homeowners_with_mortgage(1)
                    
                    if ((mortgage_deductibility>0) .OR. (property_tax_deductibility>0)) then
                    
                        write(*,*) "govt_spending_on_mortgage_interest_deductions(1)/model_GDP_incl_imput_rent(1)=", &
                            100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP_incl_imput_rent(1))
                            
                    end if
                    
                    write(*,*) "smallest_rental_relative_to_lowest_income=", smallest_rental_relative_to_lowest_income                    
                    
                    if (calibrate_smallest_house_size==1) then
                                        
                        smallest_rental_relative_to_lowest_income=&
                            min(max(smallest_rental_relative_to_lowest_income-smallest_house_size_adjuster*&
                            (mass_of_renters_at_housing_spending(1,target_30_perc*1+(1-target_30_perc)*2)-&
                            SW_renters_spend_over_X_on_hous),0.d0),10.d0) 
                                                                     
                        distance_smallest_house_size=abs(mass_of_renters_at_housing_spending&
                            (1,target_30_perc*1+(1-target_30_perc)*2)-SW_renters_spend_over_X_on_hous)
                                                         
                    else
                    
                        distance_smallest_house_size=0
                    
                    end if
                    
                    write(*,*) "smallest_rental_relative_to_lowest_income=", smallest_rental_relative_to_lowest_income
                    write(*,*) "mass_of_renters_at_housing_spending=", &
                        mass_of_renters_at_housing_spending(1,target_30_perc*1+(1-target_30_perc)*2)
                        
                    write(*,*) "labor_income_tax_rate=", labor_income_tax_rate
                                            
                    labor_income_tax_rate=max(min(labor_income_tax_rate+labor_income_tax_rate_adjuster*&
                        (model_average_labour_income_tax(1)-average_labor_income_tax_data),2.d0),0.d0)
                        
                    write(*,*) "labor_income_tax_rate=", labor_income_tax_rate
                                                            
                    if (mortgage_deductibility==1) then
                    
                        write(*,*) "fraction_using_MID(1)=", fraction_using_MID(1)
                        write(*,*) "standard_deduction_as_percent_of_average_labor_income=", &
                            standard_deduction_as_percent_of_average_labor_income
                    
                        standard_deduction_as_percent_of_average_labor_income=&
                            max(min(standard_deduction_as_percent_of_average_labor_income+&
                            standard_deduction_adjuster*&
                            (100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP_incl_imput_rent(1))-&
                            MID_to_GDP_data),1.d0),0.d0)
                            
                        distance_standard_deduction=&
                            abs(100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP_incl_imput_rent(1)))
                            
                        write(*,*) "standard_deduction_as_percent_of_average_labor_income=", &
                            standard_deduction_as_percent_of_average_labor_income
                        write(*,*) "distance_standard_deduction=", distance_standard_deduction
                    
                    else
                        
                        distance_standard_deduction=0
                        standard_deduction_as_percent_of_average_labor_income=0 !0.08
                    
                    end if
                                        
                    if (fixed_cost_to_moving_adjuster>0)  then
                    
                        write(*,*) "fixed_cost_to_moving=", fixed_cost_to_moving
                                
!                        fixed_cost_to_moving=max(min(fixed_cost_to_moving-fixed_cost_to_moving_adjuster*&
!                            (model_years_in_same_rental(1,2)-average_years_in_same_rental_data),1.d0),0.d0)
!                            
!                        distance_fixed_cost_to_moving=abs(model_years_in_same_rental(1,2)-average_years_in_same_rental_data)
                            
                        write(*,*) "fixed_cost_to_moving=", fixed_cost_to_moving
                        write(*,*) "distance_fixed_cost_to_moving=", distance_fixed_cost_to_moving
                    
                    else
                    
                        distance_fixed_cost_to_moving=0
                    
                    end if
                                        
                    write(*,*) "model_fraction_homeless(1)=", model_fraction_homeless(1)
                    write(*,*) "size_homelessness=", size_homelessness
                
                    size_homelessness=max(min(size_homelessness-size_homelessness_adjuster*&
                        (model_fraction_homeless(1)-fraction_homeless_data),1.d0),0.d0)
                        
                    distance_size_homelessness=&
                        abs(model_fraction_homeless(1)-fraction_homeless_data)
                        
                    write(*,*) "size_homelessness=", size_homelessness
                                 
                end if
                                        
            end if
                                                                                     
            distance_rental_market(1)=maxval(abs(total_rental_demand(1,:)-total_rental_supply(1,:)))
                    
            write(*,*) "rent(1)=", rent(1,:)
            write(*,*) "rental_supply(1)=", total_rental_supply(1,:)
            write(*,*) "rental_demand(1)=", total_rental_demand(1,:)
            write(*,*) "distance_rental_market(1)=", distance_rental_market(1)
                                                                   
            write(*,*) "one market"

            rental_market_adjuster=1
            
            if (re_do_simulation_with_fixed_parameters==5) then
        
                distance_rental_market(1)=maxval((abs(himmelberg_etal_rent_to_price-(rent(1,:)/housing_price(1)))))
                    
                rent(1,:)=rent(1,:)+rental_market_adjuster*(himmelberg_etal_rent_to_price-&
                    (rent(1,:)/housing_price(1)))
                    
            else
            
                rental_market_adjuster=10.d0**(-3)
                            
                distance_rental_market(1)=maxval(abs(total_rental_demand(1,:)-total_rental_supply(1,:)))
                                      
            end if
                                               
            write(*,*) "rent(1)=", rent(1,:)
            write(*,*) "rental_market_adjuster=", rental_market_adjuster
            write(*,*) "model_mortgages(1)/model_gross_housing_wealth(1)=", model_mortgages(1)/model_gross_housing_wealth(1)
            write(*,*) "model_average_rental_unit_size(1)=", model_average_rental_unit_size(1)
            write(*,*) "model_average_owner_occupied_unit_size(1)=", model_average_owner_occupied_unit_size(1)
            write(*,*) "model_average_rental_unit_size(1)/model_average_owner_occupied_unit_size(1)=", &
                model_average_rental_unit_size(1)/model_average_owner_occupied_unit_size(1)
!            write(*,*) "model_fraction_of_homeowners_with_mortgage(1)=", model_fraction_of_homeowners_with_mortgage(1)
                
            if (mortgage_deductibility>0) then
            
                write(*,*) "% govt spending on mortgage interest deductions(1)/model_GDP_incl_imput_rent(1)=", &
                    100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP_incl_imput_rent(1))
                
            end if
                
            write(*,*) "model_homeownership_rate(1)=", model_homeownership_rate(1)
                                                        
            call cpu_time(simulation_stop_time)
            
            write(*,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
            write(*,*) "relative_share_of_housing=", relative_share_of_housing
            write(*,*) "relative_share_of_leisure=", relative_share_of_leisure
            
            if (calibrate_size_of_smallest_house_hhld_can_buy==0) then
            
                write(*,*) "advantage_to_owning=", advantage_to_owning
                
            end if
            
            write(*,*) "discount_factor=", discount_factor
            write(*,*) "discount_factor_on_child=", discount_factor_on_child
                        
            write(*,*) "convexity_of_rental_company=", convexity_of_rental_company(:)
                                    
            write(*,*) "housing_status_grid_expander=", housing_status_grid_expander
                                    
            mass_at_top_financial=0
            
            do i=1,2
                                    
                mass_at_top_financial=mass_at_top_financial+&
                    sum(distribution_stationary(i)%vector_transition_real(1,:,financial_grid_size,:,:,:,:)) 
                    
            end do
                        
            write(*,*) "labor_income_tax_rate=", labor_income_tax_rate
            write(*,*) "utility_improvement,", utility_improvement
            write(*,*) "rental_management_costs=", rental_management_costs(:)
            write(*,*) "smallest_house_size=", smallest_house_size
            write(*,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy
            write(*,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", &
                housing_size(index_of_smallest_house_hhld_can_buy)
            write(*,*) "size_homelessness=", size_homelessness
            write(*,*) "largest_financial_chosen_in_equilibrium=", largest_financial_chosen_in_equilibrium
            write(*,*) "largest_housing_size_consumed_in_equilibrium=", largest_housing_size_consumed_in_equilibrium
            write(*,*) "smallest_financial_chosen_in_equilibrium=", smallest_financial_chosen_in_equilibrium
            write(*,*) "financial_grid(smallest_financial_chosen_in_equilibrium)=", &
                financial_grid(smallest_financial_chosen_in_equilibrium)
            write(*,*) "fraction of hhlds who make it to the highest net wealth=", mass_at_top_financial/sum_of_distribution
            write(*,*) "fraction_with_largest_housing_size_consumed_in_eqilibrium=", &
                fraction_with_largest_housing_size_consumed_in_eqilibrium
            write(*,*) "fraction_with_smallest_financial_in_eqilibrium=", &
                fraction_with_smallest_financial_in_eqilibrium
            write(*,*) "smallest_rental_relative_to_lowest_income=", smallest_rental_relative_to_lowest_income
                                      
            call initialize_variables_and_grids()                
            call GKKOC_intergenerational_employment_process(1)
            call initialize_financial_grid(1)

            if (re_do_simulation_with_fixed_parameters==0) then

                call set_smallest_house_size()

            end if
            
            distance_average_labor_income=&
                abs(previous_average_labor_income-model_average_labour_income(1))
                
            if (include_vouchers==1) then
                
                distance_median_income=&
                    abs(previous_median_income-median_income(1))
                    
            else
            
                distance_median_income=0
            
            end if
                
            if (threshold_for_food_stamps_as_perc_of_average_net_wealth>100) then
            
                distance_average_net_wealth=0
                
            else
                
                distance_average_net_wealth=&
                    abs(previous_average_net_wealth-model_average_net_wealth(1))
                    
            end if
                        
            model_average_labour_income(1)=&
                weight_on_labor_income*model_average_labour_income(1)+&
                (1-weight_on_labor_income)*previous_average_labor_income
                                
            median_income(1)=weight_on_median_income*median_income(1)+(1-weight_on_median_income)*previous_median_income
                                
            model_average_net_wealth(1)=&
                weight_on_labor_income*model_average_net_wealth(1)+&
                (1-weight_on_labor_income)*previous_average_net_wealth
                                                    
            call function_of_utility_advantage_from_homeowning(1)
            call govt_revenues_calc(1)
            call set_SS_benefits(1)
            
            if ((zero_elasticity==0) .AND. (infinite_elasticity_of_rental_supply==0)) then
                
                do j=0,have_two_rental_markets
!                        
                    call solve_elasticity_of_rental_housing(1,convexity_of_rental_company(j),j)
                    write(*,*) "convexity_of_rental_company=", convexity_of_rental_company(j)
                    write(*,*) "rental_management_costs=", rental_management_costs(j)
                    
                end do
                
            end if
                                                                                                         
            write(*,*) "loop_count=", loop_count
            
            write(*,*) "model average labour income=", model_average_labour_income(1)
            write(*,*) "model_average_labour_income_tax=", model_average_labour_income_tax(1)
            write(*,*) "model_average_net_wealth=", model_average_net_wealth(1)
            write(*,*) "do_internal_computations=", do_internal_computations
            
            write(*,*) "model_labor_supply/model_total_hours=", model_labor_supply(1)/model_total_hours(1)
            write(*,*) "distance_average_labor_income=", distance_average_labor_income    
            write(*,*) "distance_average_net_wealth=", distance_average_net_wealth  
                        
            write(*,*) "model_homeownership_by_age_group(1,5)=", model_homeownership_by_age_group(1,5)
            write(*,*) "value_of_initial_assets=", value_of_initial_assets
                                    
!            write(*,*) "model_avg_mortgage_spending=", model_avg_mortgage_spending(1)
            write(*,*) "model_avg_housing_spending_owners=", model_avg_housing_spending_owners(1)
            write(*,*) "model_avg_housing_spending_all=", model_avg_housing_spending_all(1)
            write(*,*) "model_avg_housing_spending_renters=", model_avg_housing_spending_renters(1)
            write(*,*) "total_rent_paid/total_renters_income=", 100*(total_rent_paid(1)/total_renters_income(1))
!            write(*,*) "inheritance_amount=", inheritance_amount
            write(*,*) "distance_inheritance_amount=", distance_inheritance_amount
            write(*,*) "average_welfare_of_youngest_cohort=", average_welfare_of_youngest_cohort(1)
            write(*,*) "mass_of_renters_at_housing_spending(1,1)=", mass_of_renters_at_housing_spending(1,1)
            write(*,*) "mass_of_renters_at_housing_spending(1,2)=", mass_of_renters_at_housing_spending(1,2)
            write(*,*) "model_fraction_homeless=", model_fraction_homeless(1)
!            write(*,*) "model_fraction_homeless_owners,", model_fraction_homeless_owners(1)
            write(*,*) "model_fraction_addicted=", model_fraction_addicted(1)
            write(*,*) "model_exprimenters=", model_exprimenters(1)
            write(*,*) "model_fraction_addicted+model_exprimenters=", model_fraction_addicted(1)+model_exprimenters(1)
            write(*,*) "model_exprimenters/model_total_drug_users=", model_exprimenters(1)/model_total_drug_users(1)
            write(*,*) "model_fraction_addicted_who_are_homeless,", model_fraction_addicted_who_are_homeless(1)
            write(*,*) "model_addicted_total_addiction_spending_to_total_income=", &
                model_addicted_total_addiction_spending_to_total_income(1)      
            write(*,*) "model_experimenters_total_drug_spending_to_total_income=", &
                model_experimenters_total_drug_spending_to_total_income(1)
            write(*,*) "model_drugs_used_by_users_on_average,", model_drugs_used_by_users_on_average(1)
            write(*,*) "model_drugs_consumed_by_users=", model_drugs_consumed_by_users(1)
            write(*,*) "model_drugs_used_by_experimenters_on_average,", model_drugs_used_by_experimenters_on_average(1)
            write(*,*) "model_drugs_used_by_addicts_on_average=", model_drugs_used_by_addicts_on_average(1)
            write(*,*) "model_fraction_homeless_and_addicted,", model_fraction_homeless_and_addicted(1)
            write(*,*) "model_fraction_unemployed=", model_fraction_unemployed(1)
            write(*,*) "model_fraction_of_homeless_unemployed=", model_fraction_of_homeless_unemployed(1)
!            write(*,*) "govt_spending_on_homeless=", govt_spending_on_homeless(1)
            write(*,*) "govt_spending_on_addicts=", govt_spending_on_addicts(1)
!            write(*,*) "govt_spending_on_food_stamps=", govt_spending_on_food_stamps(1)
            write(*,*) "govt_spending_on_food_stamps/model_output=", govt_spending_on_food_stamps(1)/model_output(1)
            write(*,*) "model_fraction_spent_on_addiction,", model_fraction_spent_on_addiction(1)
            write(*,*) "model_fraction_spent_on_addiction_experimenters=", model_fraction_spent_on_addiction_experimenters(1)
            write(*,*) "model_fraction_homeless_recieving_food_stamps=", model_fraction_homeless_recieving_food_stamps(1)
!            write(*,*) "model_food_stamps_share_to_homeless=", model_food_stamps_share_to_homeless(1)
!            write(*,*) "model_fraction_recieving_housing_vouchers=", &
!                model_fraction_recieving_housing_vouchers(1)/sum_of_distribution
            write(*,*) "model_fraction_homeless_by_choice=", model_fraction_homeless_by_choice(1)
            write(*,*) "model_addicted_and_homeless_by_choice=", model_addicted_and_homeless_by_choice(1)
            write(*,*) "model_avg_homeless_income=", model_avg_homeless_income(1)              
            write(*,*) "model_average_income_of_homeless_addicted=", model_average_income_of_homeless_addicted(1)
            write(*,*) "model_avg_homeless_after_tax_income,", model_avg_homeless_after_tax_income(1)
            write(*,*) "rent to income of homeless=", &
                (model_average_rent(1)*model_average_rental_unit_size(1))/model_avg_homeless_after_tax_income(1)
            write(*,*) "model_avg_homeless_assets=", model_avg_homeless_assets(1)
            write(*,*) "model_average_assets_addicted_and_homeless=", model_average_assets_addicted_and_homeless(1)
            write(*,*) "relative_share_of_addiction=", relative_share_of_addiction    
!            write(*,*) "addiction_share_of_income_by_employment=", addiction_share_of_income_by_employment(1,:)
            write(*,*) "model_average_spent_on_addiction_by_addicted=", model_average_spent_on_addiction_by_addicted(1)
            write(*,*) "model_fraction_of_homeless_and_addicted_unemployed=", &
                model_fraction_of_homeless_and_addicted_unemployed(1)
            write(*,*) "model_total_net_wealth/model_GDP_incl_imput_rent=", &
                model_total_net_wealth(1)/model_GDP_incl_imput_rent(1)
            write(*,*) "model_fraction_of_homeowners_with_mortgage=", model_fraction_of_homeowners_with_mortgage(1)
!            write(*,*) "model_addiction_by_employment=", model_addiction_by_employment(:)
!            write(*,*) "percent_addicted_by_employment=", percent_addicted_by_employment(1,:)
                        
            do i=1,include_addiction+1
                write(*,*) "welfare_by_addiction,", welfare_by_addiction(1,i)
            end do
            do i=1,include_addiction+1
                write(*,*) "welfare_by_addiction_youngest,", welfare_by_addiction_youngest(1,i)
            end do
            
            write(*,*) "median_income=", median_income(1)
            write(*,*) "distance_median_income=", distance_median_income
!            write(*,*) "percentiles_homeless_income=", percentiles_homeless_income(1,:)
            write(*,*) "percentiles_homeless_income/median_income=", &
                percentiles_homeless_income(1,:)/median_income(1)
            write(*,*) "model_fraction_choose_zero_work=", model_fraction_choose_zero_work(1)
            write(*,*) "model_fraction_choose_little_work=", model_fraction_choose_little_work(1)
            write(*,*) "model_fraction_choose_addiction_when_unemployed=", model_fraction_choose_addiction_when_unemployed(1)
            write(*,*) "model_choose_addiction_when_income_is_low=", model_choose_addiction_when_income_is_low(1)
            write(*,*) "model_fraction_choose_addiction_when_homeless=", model_fraction_choose_addiction_when_homeless(1)
            write(*,*) "model_choose_addiction_when_retired=", model_choose_addiction_when_retired(1)
            write(*,*) "model_fraction_choose_addiction,", model_fraction_choose_addiction(1)
!            write(*,*) "ss_decrease_addicted=", ss_decrease_addicted
!            write(*,*) "unconditional_unemployment_probability(:)=", unconditional_unemployment_probability(:)
!            write(*,*) "model_value_of_life=", model_value_of_life(1)
            write(*,*) "model_value_of_life/model_average_labour_income=", model_value_of_life(1)/model_average_labour_income(1)
            write(*,*) "model_fraction_with_negative_value_of_life=", model_fraction_with_negative_value_of_life(1)
!            write(*,*) "model_fraction_homeless_with_negative_value_of_life=",&
!                model_fraction_homeless_with_negative_value_of_life(1)
!            write(*,*) "model_fraction_addicted_with_negative_value_of_life=", &
!                model_fraction_addicted_with_negative_value_of_life(1)
            write(*,*) "model_largest_negative_value_of_life", model_largest_negative_value_of_life(1)
            write(*,*) "model_eligibles_getting_voucher=", model_eligibles_getting_voucher(1)
            write(*,*) "model_eligibles_getting_voucher_relative_to_pop,", &
                model_eligibles_getting_voucher_relative_to_pop(1)
            write(*,*) "model_addicts_getting_voucher=", model_addicts_getting_voucher(1)
            write(*,*) "model_experimenters_getting_voucher=", model_experimenters_getting_voucher(1)
            write(*,*) "model_drug_users_getting_voucher=", model_drug_users_getting_voucher(1)
            write(*,*) "model_avg_income_experimenters=", model_avg_income_experimenters(1)
            write(*,*) "model_avg_assets_experimenters=", model_avg_assets_experimenters(1)
            write(*,*) "model_age_by_addiction=", model_age_by_addiction(1,:)
                
!            write(*,*) "model_average_assets_homeless_by_addiction(:)=", model_average_assets_homeless_by_addiction(1,:)
!            write(*,*) "model_average_income_homeless_by_addiction(:)=", model_average_income_homeless_by_addiction(1,:)
!            write(*,*) "model_average_income_addicted=", model_average_income_addicted(1)
!            write(*,*) "model_average_assets_addicted=", model_average_assets_addicted(1)
!            write(*,*) "model_age_by_addiction=", model_age_by_addiction(1,:)
!            write(*,*) "welfare_by_homelessness=", welfare_by_homelessness(1,:)
            
!            write(*,*) "welfare_by_age_and_addiction=", welfare_by_age_and_addiction(1,:,0)
!            write(*,*) "welfare_by_age_and_addiction=", welfare_by_age_and_addiction(1,:,include_addiction)
            
            write(*,*) "sum_of_distribution=", sum_of_distribution
            write(*,*) "probability_of_voucher=", probability_of_voucher
            write(*,*) "price_of_addictive_good=", price_of_addictive_good
            write(*,*) "total_rental_demand_segmented=", total_rental_demand_segmented(1,:)
            write(*,*) "model_total_net_wealth/model_output=", model_total_net_wealth(1)/model_output(1)
            write(*,*) "model_net_wealth_owners/model_net_wealth_renters,", &
                model_net_wealth_owners(1)/model_net_wealth_renters(1)
            write(*,*) "model_average_ss_benefits/model_average_labour_income=", &
                model_average_ss_benefits(1)/model_average_labour_income(1)
            write(*,*) "model_homeownership_rate=", model_homeownership_rate(1)
            write(*,*) "model_homeless_2_years_or_more=", model_homeless_2_years_or_more(1)
            write(*,*) "model_homelessness_old=", model_homelessness_old(1)
            write(*,*) "model_profile_of_homeless_old=", model_profile_of_homeless_old(:)
            write(*,*) "increase_in_newborns_bequests=", increase_in_newborns_bequests
            do i=1,5
                write(*,*) "homelessness_by_age_group=", homelessness_by_age_group(1,i)
            end do
            do i=1,9
                write(*,*) "model_drug_use_by_age_group=", model_drug_use_by_age_group(1,i)
            end do
            write(*,*) "model_fraction_homeless=", model_fraction_homeless(1)
            write(*,*) "model_fraction_addicted=", model_fraction_addicted(1)
            write(*,*) "model_exprimenters=", model_exprimenters(1)
            write(*,*) "model_fraction_addicted+model_exprimenters=", model_fraction_addicted(1)+model_exprimenters(1)
            write(*,*) "model_exprimenters/model_total_drug_users=", model_exprimenters(1)/model_total_drug_users(1)
            write(*,*) "model_fraction_addicted_who_are_homeless,", model_fraction_addicted_who_are_homeless(1)
            write(*,*) "model_youngest_net_wealth_share=", model_youngest_net_wealth_share(1)
            write(*,*) "inheritance_amount=", inheritance_amount(1)
            write(*,*) "inheritance_amount=", inheritance_amount(2)
!            write(*,*) "inheritance_amount(1)*total_population_group_1(1))=", &
!                inheritance_amount(1)*total_population_group_1(1)
!            write(*,*) "inheritance_amount(2)*total_population_group_1(2))=", &
!                inheritance_amount(2)*total_population_group_1(2)
                
!            write(*,*) "inheritance_amount(1)*total_population_group_1(1))/&
!                (inheritance_amount(1)*total_population_group_1(1)+inheritance_amount(2)*total_population_group_1(2)))=", &
!                (inheritance_amount(1)*total_population_group_1(1))/&
!                (inheritance_amount(1)*total_population_group_1(1)+inheritance_amount(2)*total_population_group_1(2))
!            write(*,*) "model_bequests-value_of_initial_assets=", model_bequests(1)-value_of_initial_assets
            write(*,*) "model_homeownership_young=", model_homeownership_by_age_group(1,1)
            write(*,*) "model_labor_supply/model_total_hours=", model_labor_supply(1)/model_total_hours(1)
            write(*,*) "mass_of_renters_at_housing_spending=", mass_of_renters_at_housing_spending(1,2)
            write(*,*) "model_fraction_homeless_and_addicted=", model_fraction_homeless_and_addicted(1)
            write(*,*) "model_fraction_unemployed=", model_fraction_unemployed(1)
            write(*,*) "model_addicted_total_addiction_spending_to_total_income=", &
                model_addicted_total_addiction_spending_to_total_income(1)      
            write(*,*) "model_experimenters_total_drug_spending_to_total_income=", &
                model_experimenters_total_drug_spending_to_total_income(1)
            write(*,*) "govt_spending_on_food_stamps/model_output=", govt_spending_on_food_stamps(1)/model_output(1)
            write(*,*) "model_value_of_life/model_average_labour_income=", model_value_of_life(1)/model_average_labour_income(1)
            write(*,*) "model_total_net_wealth/model_output=", model_total_net_wealth(1)/model_output(1)
            write(*,*) "model_eligibles_getting_voucher=", model_eligibles_getting_voucher(1)
            write(*,*) "model_ss_benefits=", model_ss_benefits
            write(*,*) "model_average_labour_income_tax=", model_average_labour_income_tax(1)
            write(*,*) "probability_of_voucher=", probability_of_voucher            
            write(*,*) "model_fraction_addicted_and_unemployed=", model_fraction_addicted_and_unemployed(1)
            
            do i=1,10
!                write(*,*) income_to_avg_income_wide_pdf_1(1,i)
            end do
        
            write(*,*) "model_bequests=", model_bequests(1)
            write(*,*) "model_total_inheritance=", model_total_inheritance(1)
            write(*,*) "model_total_income-model_total_expenditure=", &
                model_output(1)+model_total_investment_income(1)+include_bequests*value_of_initial_assets-&
                (aggregate_consumption(1)+aggregate_spending_on_addiction(1)+&
                aggregate_housing_consumption(1)+aggregate_mortgage_consumption(1)+&
                aggregate_housing_transaction_costs(1)+aggregate_origination_costs(1)+&
                aggregate_prepayment_costs(1)+aggregate_moving_costs(1)+&
                govt_revenues_to_use_in_tests(1)+&
                govt_ss_wasted(1)+(govt_spending_on_homeless(1)+govt_spending_on_addicts(1))+&
                (1-include_property_taxes_in_govt_constraint)*govt_revenues_from_property_tax(1)+&
                aggregate_rent_spending(1)-housing_price(1)*&
                sum(total_rental_demand(1-solve_transition_dynamics,:))*&
                property_tax(1-solve_transition_dynamics))
            write(*,*) "model_homeowners_experimenting=", model_homeowners_experimenting(1)
            write(*,*) "profile_of_chronic_homeless=", profile_of_chronic_homeless(1,:)  
            write(*,*) "model_avg_homeless_income/model_average_labour_income.", &
                model_avg_homeless_income(1)/model_average_labour_income(1)
            write(*,*) "model_avg_income_experimenters/model_average_labour_income.", &
                model_avg_income_experimenters(1)/model_average_labour_income(1)
            write(*,*) "model_average_income_addicted/model_average_labour_income.", &
                model_average_income_addicted(1)/model_average_labour_income(1)
            write(*,*) "model_avg_income_drug_users/model_average_labour_income,", &
                model_avg_income_drug_users(1)/model_average_labour_income(1)
            write(*,*) "model_avg_homeless_assets/model_average_net_wealth.", &
                model_avg_homeless_assets(1)/model_average_net_wealth(1)
            write(*,*) "model_avg_assets_experimenters/model_average_net_wealth.", &
                model_avg_assets_experimenters(1)/model_average_net_wealth(1)
            write(*,*) "model_average_assets_addicted/model_average_net_wealth.", &
                model_average_assets_addicted(1)/model_average_net_wealth(1)
            write(*,*) "model_average_assets_drug_users/model_average_net_wealth,", &
                model_average_assets_drug_users(1)/model_average_net_wealth(1)
        
!            write(*,*) "model_bequests/model_net_wealth=", model_bequests(1)/model_total_net_wealth(1)
!            write(*,*) "model_bequests=", model_bequests(1) 

!            call stationary_equilibrium_wealth_distribution(1)

!            call stationary_equilibrium_income_bottom_distribution(1)

!            call compute_homelessness_duration(1)
            
!            do i=0,2
!                write(*,*) "homelessness_duration_everyone(1,",i,")=", &
!                    homelessness_duration_everyone(1,i)
!            end do
            
            write(*,*) "file_number=", file_number
                                    
        end do
    
        simulation_ended=0
        
        call calculate_homeownership_by_characteristics(1)
        
        write(*,*) "calculating inequality"
        
        if (use_old_results>=0) then
        
            call stationary_equilibrium_wealth_distribution(1)
            call calculate_gini_coefficient(1)
!            call stationary_equilibrium_income_bottom_distribution(1)
            
        end if
                    
        call save_vars_and_functions(1)
        
        write(*,*) "simulation ended"
        write(*,*) "rental_management_costs=", rental_management_costs
        write(*,*) "model_drug_use_by_income_quintile", model_drug_use_by_income_quintile(1,:)
                                        
    end subroutine
    
    subroutine long_run_counter_factual()
    
        use Global_Vars
                    
        implicit none
        
        real(8) :: previous_distance
        integer :: end_loop
        character*1 :: string_used
        
        if (voucher_conditional_on_clean==1) then
        
            probability_of_voucher=1
            
        elseif (use_revenues_to_increase_voucher_probability==1) then
            
            if (increased_prob_of_voucher_if_homeless_and_addicted==0) then
            
                increased_prob_of_voucher_if_homeless_1=1 !5.81
                                                
                tax_system_type=3
                                
            else
                            
                tax_system_type=1
                
            end if
            
        elseif (double_voucher_program==1) then
        
            probability_of_voucher=probability_of_voucher_benchmark*2
            
            tax_system_type=1
            
        else
        
            tax_system_type=1
            
        end if
                
        simulation_ended=0
                                    
        call cpu_time(simulation_start_time)
            
        property_tax=property_tax
        
        increase_in_labour_income_tax=0
        
        if (use_old_results==1) then

            call upload_vars(transition_length)
                        
        end if

        if (use_old_results==0) then
        
            model_average_owner_occupied_unit_size(transition_length)=calibrated_stationary_housing_price*0.315

        end if
                
        loop_count=0

        if (use_old_results==0) then
        
            c_1=c_1_calibrated
            c_min=c_min_calibrated
            
            housing_price(transition_length)=calibrated_stationary_housing_price
            
            rent(transition_length,:)=rent_calibrated(:) 
                            
            total_rental_supply(transition_length,:)=total_rental_supply_calibrated(:)
            total_rental_demand(transition_length,:)=total_rental_supply_calibrated(:)
         
            risk_free_rate(transition_length)=calibrated_risk_free_rate
            mortgage_interest_rate(transition_length)=risk_free_rate(transition_length)+mortgage_interest_gap
                        
            model_average_income(transition_length)=average_labor_income_calibrated
            model_average_income_plus_assets(transition_length)=average_labor_income_calibrated
            model_average_income_plus_all_assets(transition_length)=average_labor_income_calibrated
            model_average_labour_income(transition_length)=average_labor_income_calibrated
            model_average_labour_income_by_employment(transition_length,:)=average_labor_income_calibrated
            median_income(transition_length)=median_income_calibrated
            model_average_financial(1)=average_financial_calibrated
            model_average_net_wealth(1)=average_net_wealth_calibrated

        end if
        
        call function_of_utility_advantage_from_homeowning(transition_length)
        
        call allocate_matrix()
                        
        call initialize_variables_and_grids()
        call GKKOC_intergenerational_employment_process(transition_length)
        call initialize_financial_grid(transition_length)
        call set_SS_benefits(transition_length)        
        call initialize_feasible_distribution(transition_length)

        if (use_old_results==0) then
        
            total_housing_demand(transition_length)=calibrated_housing_stock

        end if
        
        call function_of_utility_advantage_from_homeowning(transition_length)
                               
        distance_rental_market(transition_length)=1
        distance_value_function=1
        distance_housing_market(transition_length)=1
          
        do i=1,2
          
            value_function_guess(i)%vector_youngest_real(:,:,:,:,:)=0
            value_function(i)%vector_transition_real(transition_length,:,:,:,:,:,:)=0
            
        end do
                                                           
        if (partial_equilibrium==0) then
                                    
            if (increased_prob_of_voucher_if_homeless_and_addicted==0) then
                
                if (probability_of_voucher_benchmark_used==1) then
                
                    inheritance_amount=1.2690695275861320E-002
                    rent(transition_length,:)=rent_calibrated(:)*1.0228061206543528
                    housing_price(transition_length)=calibrated_stationary_housing_price*1.0122654959046571
                    increase_in_labour_income_tax=1.6462547635010609E-004
                    
                else
                
                    inheritance_amount=1.3297417759844228E-002
                    rent(transition_length,:)=rent_calibrated(:)*1.0051228061206543528
                    housing_price(transition_length)=calibrated_stationary_housing_price*1.002
                    increase_in_labour_income_tax=1.4488423360367944E-003
                
                end if
                    
            else
                                        
                inheritance_amount=1.3072551538156174E-002
                rent(transition_length,:)=rent_calibrated(:)*1.0198110300635519
                housing_price(transition_length)=calibrated_stationary_housing_price*0.97805442695638745
                increase_in_labour_income_tax=-9.9935794204448567E-003
                        
            end if
                                     
        else
            
            lump_sum_transfer(transition_length)=0
            
            rent(transition_length,:)=rent_calibrated(:)*1
            housing_price(transition_length)=calibrated_stationary_housing_price*1
                    
        end if
                      
!        if (adjust_labor_supply==0) then
!        
!            do i=1,2
!        
!                write(string_used,'(i1)') i
!        
!                open(unit=2,file="policy_function_labor_supply"//trim(string_used)//trim(old_results)//".dat",action='read')
!                    read(2,'(F22.20)') policy_function_labor_supply(i)%vector_transition_real(:,:,:,:,:,:,:)
!                close(2)
!                
!            end do
!        
!        end if
        
        write(*,*) "calibrated_stationary_housing_price=", calibrated_stationary_housing_price
        write(*,*) "rent_calibrated=", rent_calibrated
        write(*,*) "total_rental_supply_calibrated=", total_rental_supply_calibrated
        write(*,*) "calibrated_housing_stock=", calibrated_housing_stock
        write(*,*) "c_1_calibrated=", c_1_calibrated
        write(*,*) "c_min_calibrated=", c_min_calibrated
        write(*,*) "cutoff_housing_investment_calibrated=",cutoff_housing_investment_calibrated
        write(*,*) "calibrated_risk_free_rate=", calibrated_risk_free_rate
        write(*,*) "discount_factor=", discount_factor
        write(*,*) "discount_factor_on_child=", discount_factor_on_child
        write(*,*) "minimum_inheritance=", minimum_inheritance
        write(*,*) "size_homelessness=", size_homelessness
        write(*,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
        write(*,*) "property_tax(transition_length)=", property_tax(transition_length)
        write(*,*) "rental_management_costs=", rental_management_costs
        write(*,*) "mortgage_interest_rate=", mortgage_interest_rate(transition_length)
        write(*,*) "infinite_elasticity_of_rental_supply=", infinite_elasticity_of_rental_supply
        write(*,*) "lump_sum_transfer=", lump_sum_transfer(1)
        write(*,*) "rent/rent_calibrated=", rent(transition_length,:)/rent_calibrated(:)
        write(*,*) "check_tax_incidence=", check_tax_incidence
        write(*,*) "mortgage_deductibility=", mortgage_deductibility
        write(*,*) "minimum_downpayment=", minimum_downpayment
        write(*,*) "stopping_rule_govt_budget=", stopping_rule_govt_budget
        write(*,*) "stopping_rule_housing_market=", stopping_rule_housing_market
        write(*,*) "stopping_rule_rental_market=", stopping_rule_rental_market
        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
        write(*,*) "housing_price/calibrated_stationary_housing_price=", &
            housing_price(transition_length)/calibrated_stationary_housing_price
        write(*,*) "average_owner_occupied_house_size_calibrated=", average_owner_occupied_house_size_calibrated
        write(*,*) "model_ss_benefits=", model_ss_benefits
        write(*,*) "relative_share_of_housing=", relative_share_of_housing
        write(*,*) "relative_share_of_leisure=", relative_share_of_leisure
        write(*,*) "rental_management_costs_calibrated=", rental_management_costs_calibrated
        write(*,*) "convexity_of_rental_company=", convexity_of_rental_company
        write(*,*) "minimum_downpayment_calibrated=", minimum_downpayment_calibrated
        write(*,*) "c_1=", c_1
        write(*,*) "labor_income_tax_rate=", labor_income_tax_rate
        write(*,*) "average_labor_income_calibrated=", average_labor_income_calibrated
        write(*,*) "median_income_calibrated=", median_income_calibrated
        write(*,*) "calibrated_stationary_housing_price=", calibrated_stationary_housing_price
        write(*,*) "rent=", rent(1,:)
        write(*,*) "counter_factual"
        write(*,*) "rent_calibrated(1)=", rent_calibrated(:)
        
        write(*,*) "new_supply/old_supply=", &
            (max(((rent_calibrated*(1.01)-housing_price(1)+(1/(1+risk_free_rate(1)))*&
            (housing_price(1)*(1-housing_depreciation_rate-property_tax(1))))/&
            (rental_management_costs_calibrated*convexity_of_rental_company)),0.d0)**&
            (1/(convexity_of_rental_company-1)))/(max(((rent_calibrated-housing_price(1)+(1/(1+risk_free_rate(1)))*&
            (housing_price(1)*(1-housing_depreciation_rate-property_tax(1))))/&
            (rental_management_costs_calibrated*convexity_of_rental_company)),0.d0)**(1/(convexity_of_rental_company-1)))

        write(*,*) "check.....=", (max(((rent(1,:)-housing_price(transition_length)+(1/(1+risk_free_rate(1)))*&
            (housing_price(transition_length)*(1-housing_depreciation_rate-property_tax(1)-property_tax_on_rental_housing)))/&
            (rental_management_costs_calibrated(:)*convexity_of_rental_company(:))),0.d0)**&
            (1/(convexity_of_rental_company(:)-1)))
            
        write(*,*) "rent_calibrated(1)=", rent_calibrated
        write(*,*) "rental_management_costs_calibrated=", rental_management_costs_calibrated
        write(*,*) "convexity_of_rental_company=", convexity_of_rental_company
        write(*,*) "housing_price(1)=", housing_price(1)
        write(*,*) "risk_free_rate(1)=", risk_free_rate(1)
        write(*,*) "property_tax(1)=", property_tax(1)
        write(*,*) "housing_depreciation_rate=", housing_depreciation_rate
                
        write(*,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
        write(*,*) "max_debt_to_income_ratio_below_80=", max_debt_to_income_ratio_below_80        
        write(*,*) "do_internal_computations=", do_internal_computations
        write(*,*) "convexity_of_rental_company=", convexity_of_rental_company
        write(*,*) "property_tax_on_rental_housing=", property_tax_on_rental_housing
        write(*,*) "standard_deduction=", standard_deduction
        write(*,*) "personal_exemption=", personal_exemption
        write(*,*) "housing_price=", housing_price(1)
        write(*,*) "rent=", rent(1,:)
        write(*,*) "empirical_housing_supplpy_elasticity=", empirical_housing_supplpy_elasticity
        write(*,*) "convexity_of_rental_company=", convexity_of_rental_company
        write(*,*) "rental_management_costs=", rental_management_costs
        write(*,*) "value_of_initial_assets=", value_of_initial_assets
        write(*,*) "model_ss_benefits=", model_ss_benefits
        write(*,*) "initial_endowment=", initial_endowment
        write(*,*) "model_bequests=", model_bequests(transition_length)
        write(*,*) "lump_sum_transfer=", lump_sum_transfer(transition_length)
        
        write(*,*) "housing_stock=", housing_stock(1)
        
        if (zero_elasticity==0) then
        
            total_rental_supply(1,:)=max(((rent(1,:)-housing_price(1)+(1/(1+risk_free_rate(1)))*&
                (housing_price(1-solve_transition_dynamics)*&
                (1-housing_depreciation_rate-property_tax(1-solve_transition_dynamics)-&
                property_tax_on_rental_housing)))/(rental_management_costs_calibrated(:)*&
                convexity_of_rental_company(:))),0.d0)**(1/(convexity_of_rental_company(:)-1))
                
        else
        
            total_rental_supply(1,:)=total_rental_supply_calibrated(:)
            
        end if
            
        write(*,*) "convexity_of_rental_company(:)=", convexity_of_rental_company(:)
        write(*,*) "rental_management_costs_calibrated(:)=", rental_management_costs_calibrated(:)
        write(*,*) "rent(1,:)=", rent(1,:)
        write(*,*) "total_rental_supply=", total_rental_supply(1,:)
        write(*,*) "total_rental_supply_calibrated=", total_rental_supply_calibrated(:)
        write(*,*) "file_number=", file_number
        write(*,*) "old_results=", old_results
        write(*,*) "average_net_wealth_calibrated=", average_net_wealth_calibrated
        write(*,*) "average_labor_income_by_employment_calibrated=", average_labor_income_by_employment_calibrated
        write(*,*) "model_average_rental_unit_size=", model_average_rental_unit_size(1)
        write(*,*) "max_fraction_of_income_spent_on_housing=", max_fraction_of_income_spent_on_housing
        write(*,*) "max_rent_relative_to_ave=", max_rent_relative_to_ave
        write(*,*) "inheritance_amount=", inheritance_amount
        write(*,*) "total_hours_calibrated=", total_hours_calibrated
        write(*,*) "labor_supply_calibrated=", labor_supply_calibrated
        write(*,*) "model_average_rent=", model_average_rent(1)
        write(*,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
        write(*,*) "price_of_addictive_good=", price_of_addictive_good
        write(*,*) "addiction_scalar_1=", addiction_scalar_1
        write(*,*) "probability_of_voucher=", probability_of_voucher
        write(*,*) "voucher_probabilities=", voucher_probabilities(0,1,1,:)
        write(*,*) "voucher_probabilities=", voucher_probabilities(1,1,1,:)
        write(*,*) "voucher_probabilities_benchmark=", voucher_probabilities_benchmark(0,1,1,:)
        write(*,*) "voucher_probabilities_benchmark=", voucher_probabilities_benchmark(1,1,1,:)
        write(*,*) "probability_becoming_unemployed_if_addicted=", probability_becoming_unemployed_if_addicted
        write(*,*) "probability_becoming_employed_if_addicted=", probability_becoming_employed_if_addicted
        
        write(*,*) "housing_price/calibrated_stationary_housing_price=", &
            housing_price(transition_length)/calibrated_stationary_housing_price
        write(*,*) "rent/rent_calibrated(1)=", rent(1,:)/rent_calibrated(:)
        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
         write(*,*) "inheritance_amount=", inheritance_amount
        
        previous_inheritance_amount=inheritance_amount
        
        previous_distance=0
        end_loop=0
        
!        housing_size(lowest_housing_grid_point)=housing_size(lowest_housing_grid_point)*4
                
        write(*,*) "housing_size=", housing_size(:)
        write(*,*) "model_average_income=", model_average_income(1)
!        write(*,*) "income_cutoffs_of_quintiles=", income_cutoffs_of_quintiles
        write(*,*) "large_negative_num=", large_negative_num
                                      
        write(*,*) "increased_risk_of_death_addicted=", increased_risk_of_death_addicted
        write(*,*) "multiple_of_probabilities_of_employment_if_addicted=", multiple_of_probabilities_of_employment_if_addicted
        write(*,*) "relative_share_of_addiction_2=", relative_share_of_addiction_2
        write(*,*) "relative_share_of_addiction_1=", relative_share_of_addiction_1
        write(*,*) "size_of_penalty=", size_of_penalty
                                      
        do while ((distance_rental_market(transition_length)>stopping_rule_rental_market) .OR. &
            (distance_housing_market(transition_length)>stopping_rule_housing_market) .OR. &
            (distance_govt_budget>stopping_rule_govt_budget) .OR. &
            (distance_inheritance_amount>stopping_rule_inheritance_amount) .OR. &
            (loop_count<aftr_how_mny_lps_start_update))
                                
            call solve_value_function_and_policy_functions(transition_length)
            
            if (loop_count<=1) then
            
                stopping_rule_stationary_distribution=10.d0**(-8)
            
            else
            
                stopping_rule_stationary_distribution=10.d0**(-8)
            
            end if
            
            if (include_addiction==1) then
            
                stopping_rule_stationary_distribution=2*10.d0**(-4)
            
            end if
            
            if ((relative_price_change>1000) .AND. (partial_equilibrium==0)) then
            
                stopping_rule_stationary_distribution=3*10.d0**(-3)
            
            end if
                        
            if ((hold_distribution_fixed==0) .AND. (fixed_to_benchmark_dis==0)) then
        
                call converge_to_stationary_equilibrium(transition_length)
                
            else
            
                do i=1,2
            
                    write(string_used,'(i1)') i
            
                    open(unit=12,file="distribution_stationary"//trim(string_used)//trim(old_results)//".dat",action='read')
                        read(12,'(F30.28)') distribution_stationary(i)%vector_transition_real(1,:,:,:,:,:,:)
                    close(12)
                                    
                end do
                
            end if
            
            call stationary_equilibrium_statistics(transition_length)            
            call stationary_equilibirum_homeownership_rate(transition_length)
            call govt_revenues_calc(transition_length)
            call calculate_welfare_by_characteristics(transition_length)
            call calculate_homeownership_by_characteristics(transition_length)
            call calculate_aggregate_consumption(transition_length)
            
            if ((include_bequests_in_govt_constraint==0) .AND. &
                (partial_equilibrium==0) .AND. (adjust_inheritance==1)) then
            
                previous_inheritance_amount=inheritance_amount
            
                call calculate_updated_inheritance_amounts(1)
                
                distance_inheritance_amount=maxval((1-include_bequests_in_govt_constraint)*&
                    abs(previous_inheritance_amount-inheritance_amount))
                    
                inheritance_amount=inheritance_amount_weight*inheritance_amount+&
                    (1-inheritance_amount_weight)*previous_inheritance_amount
                  
            else
            
                distance_inheritance_amount=0
                
            end if
                             
            write(*,*) "rent(transition_length)=", rent(transition_length,:)
                    
            if (loop_count>aftr_how_mny_lps_start_update) then
                        
                rental_market_adjuster=0.01
                                    
                if (zero_elasticity==1) then
                
                    total_rental_supply(transition_length,:)=total_rental_supply_calibrated(:)
                    
                end if
                
                distance_rental_market(transition_length)=&
                    (1-partial_equilibrium)*maxval(abs(total_rental_demand(transition_length,:)-&
                    total_rental_supply(transition_length,:)))
                
                rent(transition_length,:)=(rent(transition_length,:)+&
                    (1-partial_equilibrium)*rental_market_adjuster*&
                    (total_rental_demand(transition_length,:)-&
                    total_rental_supply(transition_length,:)))
                    
            end if
                                 
            write(*,*) "rent(transition_length)=", rent(transition_length,:)
            write(*,*) "rental_market_adjuster=", rental_market_adjuster
            write(*,*) "distance_rental_market(transition_length)=", distance_rental_market(transition_length)
            write(*,*) "total_rental_supply(:)=", total_rental_supply(transition_length,:)
            write(*,*) "total_rental_demand(:)=", total_rental_demand(transition_length,:)
            write(*,*) "rent/rent_calibrated=", rent(transition_length,:)/rent_calibrated(:)               
            write(*,*) "loop_count=", loop_count
            write(*,*) "adjust_rents=", adjust_rents
            write(*,*) "adjust_house_prices=", adjust_house_prices
            write(*,*) "housing_price(transition_length)=", housing_price(transition_length)
            
            distance_housing_market(transition_length)=adjust_house_prices*(1-check_tax_incidence)*&
                (1-partial_equilibrium)*abs(housing_price(transition_length)-&
                (c_1_calibrated)*(housing_depreciation_rate*total_housing_demand(transition_length))**&
                (1/empirical_housing_supplpy_elasticity))
                
            weight_on_housing_price=(1-check_tax_incidence)*0.02
            
            if (loop_count>=1) then
            
                if (adjust_house_prices==1) then
                
                    housing_price(transition_length)=&
                        (1-partial_equilibrium)*((1-weight_on_housing_price)*housing_price(transition_length)+&
                        weight_on_housing_price*(c_1_calibrated)*(housing_depreciation_rate*&
                        total_housing_demand(transition_length))**(1/empirical_housing_supplpy_elasticity))+&
                        partial_equilibrium*housing_price(transition_length)
                        
                end if
                    
            end if
                
            write(*,*) "housing_price(transition_length)=", housing_price(transition_length)
            write(*,*) "housing_price/calibrated_stationary_housing_price=", &
                housing_price(transition_length)/calibrated_stationary_housing_price
            write(*,*) "housing_stock=", housing_stock(transition_length)
            write(*,*) "total_housing_demand=", total_housing_demand(transition_length)
            write(*,*) "distance_housing_market=", distance_housing_market(transition_length)
                    
            call govt_revenues_calc(transition_length)
            call calculate_welfare(transition_length)
            call calculate_household_housing_spending(transition_length)
            call frac_of_households_in_support_of_policy(transition_length)
                                    
            distance_govt_budget=adjust_taxes*(1-partial_equilibrium)*&
                abs(net_govt_revenues(transition_length)-net_govt_revenue_constraint)
                                           
            if ((partial_equilibrium==0) .AND. (adjust_taxes==1)) then

                if (loop_count>0) then
                
                    if (use_revenues_to_increase_voucher_probability==1) then
                                        
                        tax_system_type=3
                                                    
                    else
                    
                        tax_system_type=1
                    
                    end if
                
                    if (tax_system_type==1) then
                    
                        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax

                        increase_in_labour_income_tax=increase_in_labour_income_tax+&
                            0.005*(net_govt_revenues(transition_length)-net_govt_revenue_constraint)

                        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
                                            
                    elseif (tax_system_type==2) then
                    
                        write(*,*) "lump_sum_transfer to renters=", lump_sum_transfer(transition_length)

                        lump_sum_transfer(transition_length)=lump_sum_transfer(transition_length)+&
                            0.005*(net_govt_revenues(transition_length)-net_govt_revenue_constraint)

                        write(*,*) "lump_sum_transfer to renters=", lump_sum_transfer(transition_length)
                        
                    elseif (tax_system_type==3) then
        
                        if (increase_vouchers_for_homeless_only==1) then
                        
                            write(*,*) "increased_prob_of_voucher_if_homeless_1=", increased_prob_of_voucher_if_homeless_1

                            increased_prob_of_voucher_if_homeless_1=max(min(increased_prob_of_voucher_if_homeless_1+&
                                10*(net_govt_revenues(transition_length)-net_govt_revenue_constraint),10.d0),0.d0)

                            write(*,*) "increased_prob_of_voucher_if_homeless_1=", increased_prob_of_voucher_if_homeless_1
                        
                        else
                    
                            write(*,*) "probability_of_voucher_benchmark_used_1=", probability_of_voucher_benchmark_used_1

                            probability_of_voucher_benchmark_used_1=max(min(probability_of_voucher_benchmark_used_1+&
                                0.3*(net_govt_revenues(transition_length)-net_govt_revenue_constraint),1.d0),0.d0)

                            write(*,*) "probability_of_voucher_benchmark_used=", probability_of_voucher_benchmark_used_1
                                                    
                        end if
                        
                        call create_unemployment_process()
                            
                        write(*,*) "voucher_probabilities=", voucher_probabilities(0,1,1,:)
                        write(*,*) "voucher_probabilities=", voucher_probabilities(1,1,1,:)
                        
                    end if

                end if
                                                    
            end if
                               
            write(*,*) "distance_govt_budget=", distance_govt_budget   
            write(*,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
            write(*,*) "net_govt_revenues=", net_govt_revenues(transition_length)
            write(*,*) "sum(distribution_stationary(transition_length,:,:,:,:,:))=", sum_of_distribution
                        
            call cpu_time(simulation_stop_time)
            
!            write(*,*) "running for", (simulation_stop_time-simulation_start_time)/3600
            write(*,*) "model_homeownership_rate(transition_length)=", model_homeownership_rate(transition_length)
            write(*,*) "largest_house_size_hhld_can_rent=", largest_house_size_hhld_can_rent
            write(*,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy 
            write(*,*) "do_internal_computations=", do_internal_computations
!            write(*,*) "eta_1=", eta_1
!            write(*,*) "relative_share_of_addiction_1=", relative_share_of_addiction_1
!            write(*,*) "relative_share_of_housing=", relative_share_of_housing_1            
!            write(*,*) "relative_share_of_housing=", relative_share_of_housing_2
!            write(*,*) "relative_share_of_leisure=", relative_share_of_leisure
            write(*,*) "discount_factor=", discount_factor
!            write(*,*) "discount_factor_on_child=", discount_factor_on_child
!            write(*,*) "minimum_inheritance=", minimum_inheritance
            write(*,*) "convexity_of_rental_company=", convexity_of_rental_company
!            write(*,*) "advantage_to_owning=", advantage_to_owning
!            write(*,*) "standard_deduction=", standard_deduction
!            write(*,*) "personal_exemption=", personal_exemption
            write(*,*) "is_counterfactual=", is_counterfactual
            write(*,*) "tax_system_type=", tax_system_type
                        
            if (check_tax_incidence==0) then
                                    
                call function_of_utility_advantage_from_homeowning(transition_length)
                
            end if
                                                            
            if (property_tax_on_rental_housing>0) then
            
                write(*,*) "property_tax_on_rental_housing=", property_tax_on_rental_housing
            
            end if
                     
            write(*,*) "lump_sum_transfer=", lump_sum_transfer(transition_length)
            write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
            
            if (mortgage_deductibility>0) then
            
                write(*,*) "mortgage_deductibility=", mortgage_deductibility
                write(*,*) "% govt spending on mortgage interest deductions/model_GDP_incl_imput_rent=", &
                    100*(govt_spending_on_mortgage_interest_deductions(transition_length)/&
                    model_GDP_incl_imput_rent(transition_length))
                
            end if
            
            write(*,*) "total_rental_supply(transition_length)/total_rental_supply_calibrated=", &
                total_rental_supply(transition_length,:)/total_rental_supply_calibrated(:)
            
            write(*,*) "model_labor_supply=", model_labor_supply(transition_length)
            write(*,*) "model_total_hours=", model_total_hours(transition_length)
            write(*,*) "model_labor_supply/model_total_hours=", &
                model_labor_supply(transition_length)/model_total_hours(transition_length)
            write(*,*) "model_labor_supply/labor_supply_calibrated=", model_labor_supply(transition_length)/labor_supply_calibrated
            write(*,*) "inheritance_amount(1)=", inheritance_amount(1)
            write(*,*) "distance_inheritance_amount=", distance_inheritance_amount
            write(*,*) "file_number=", file_number
            write(*,*) "old_results=", old_results
            write(*,*) "benchmark_simulation=", benchmark_simulation
            write(*,*) "model_fraction_homeless=", model_fraction_homeless(transition_length)
            write(*,*) "govt_spending_on_housing_vouchers=", govt_spending_on_housing_vouchers(transition_length)
            write(*,*) "govt_spending_on_food_stamps=", govt_spending_on_food_stamps(transition_length)
            write(*,*) "model_fraction_addicted_homeless_no_vouchers=", &
                model_fraction_addicted_homeless_no_vouchers(transition_length)
            write(*,*) "model_fraction_recieving_food_stamps=", &
                model_fraction_recieving_food_stamps(transition_length)/sum_of_distribution
            write(*,*) "model_fraction_recieving_housing_vouchers=", &
                model_fraction_recieving_housing_vouchers(transition_length)/sum_of_distribution
            write(*,*) "model_average_labour_income_tax=", model_average_labour_income_tax(transition_length)
            write(*,*) "model_fraction_homeless_and_addicted=", model_fraction_homeless_and_addicted(transition_length)
!            write(*,*) "model_avg_homeless_income=", model_avg_homeless_income(transition_length)
!            write(*,*) "max_rent_relative_to_ave=", max_rent_relative_to_ave
!            write(*,*) "max_fraction_of_income_spent_on_housing=", max_fraction_of_income_spent_on_housing
            write(*,*) "addiction_share_of_income_by_employment=", addiction_share_of_income_by_employment(transition_length,:)
!            write(*,*) "total_govt_revenues=", total_govt_revenues(transition_length)
            write(*,*) "model_fraction_spent_on_addiction,", model_fraction_spent_on_addiction(1)
            write(*,*) "model_fraction_addicted=", model_fraction_addicted(1)
            write(*,*) "model_exprimenters=", model_exprimenters(1)
            write(*,*) "model_fraction_addicted+model_exprimenters=", model_fraction_addicted(1)+model_exprimenters(1)
            write(*,*) "model_drugs_used_by_users_on_average,", model_drugs_used_by_users_on_average(1)
            write(*,*) "model_drugs_consumed_by_users=", model_drugs_consumed_by_users(1)
            write(*,*) "model_drugs_used_by_experimenters_on_average,", model_drugs_used_by_experimenters_on_average(1)
            write(*,*) "model_drugs_used_by_addicts_on_average=", model_drugs_used_by_addicts_on_average(1)
            write(*,*) "model_fraction_unemployed=", model_fraction_unemployed(1)
            write(*,*) "model_eligibles_getting_voucher=", model_eligibles_getting_voucher(1)
                            
            write(*,*) "average_welfare_of_all_cohorts=", average_welfare_of_all_cohorts(1)
            write(*,*) "average_welfare_of_youngest_cohort=", average_welfare_of_youngest_cohort(1)
                               
            do i=1,1+include_addiction
        
                write(*,*) "welfare_by_addiction=", welfare_by_addiction(transition_length,i)
                write(*,*) "welfare_by_addiction_youngest=", welfare_by_addiction_youngest(transition_length,i)
                
            end do
                        
!            write(*,*) "frac_in_support_addicted_youngest,", frac_in_support_addicted_youngest(transition_length)
!            write(*,*) "frac_in_support_addicted,", frac_in_support_addicted(transition_length)
            write(*,*) "price_of_addictive_good=", price_of_addictive_good
            write(*,*) "model_fraction_with_negative_value_of_life=", model_fraction_with_negative_value_of_life(1)
            write(*,*) "model_largest_negative_value_of_life", model_largest_negative_value_of_life(1)
            
!            write(*,*) "model_avg_housing_spending_renters=", model_avg_housing_spending_renters(1)
            write(*,*) "probability_of_voucher=", probability_of_voucher
!            write(*,*) "model_fraction_addicted_who_are_homeless,", model_fraction_addicted_who_are_homeless(1)
            write(*,*) "sum_of_distribution=", sum_of_distribution
!            write(*,*) "model_addicted_and_homeless_by_choice=", model_addicted_and_homeless_by_choice(1)
!            write(*,*) "model_fraction_homeless_by_choice=", model_fraction_homeless_by_choice(1)
!            write(*,*) "model_homeless_2_years_or_more=", model_homeless_2_years_or_more(1)
            write(*,*) "model_addicts_getting_voucher,", model_addicts_getting_voucher(1)
!            write(*,*) "model_homelessness_old=", model_homelessness_old(1)
            write(*,*) "adjust_inheritance=", adjust_inheritance
            write(*,*) "average_labour_income_tax=", model_average_labour_income_tax(1)
!            write(*,*) "use_income_or_income_plus_assets,", use_income_or_income_plus_assets
!            write(*,*) "model_addicts_consuming_no_drugs,", model_addicts_consuming_no_drugs(1)
            write(*,*) "model_age_by_addiction,", model_age_by_addiction(1,:)
            write(*,*) "model_fraction_choose_addiction_when_unemployed=", model_fraction_choose_addiction_when_unemployed(1)
            write(*,*) "model_choose_addiction_when_income_is_low=", model_choose_addiction_when_income_is_low(1)
            write(*,*) "model_fraction_choose_addiction_when_homeless=", model_fraction_choose_addiction_when_homeless(1)
            write(*,*) "model_choose_addiction_when_retired=", model_choose_addiction_when_retired(1)
            
            do i=1,10
!                write(*,*) income_to_avg_income_wide_pdf_1(1,i)
            end do
            
            do i=1,11
            
!                write(*,*) "lowest_welfare_of_addicted", i, "=", lowest_welfare_of_addicted(1,i)
                
            end do
            
            if (compute_welfare_every_loop==1) then
            
                do j=1,1!+include_addiction+include_addiction
                            
                    if (j==1) then
                
                        call calculate_welfare_gains(transition_length,average_welfare_of_youngest_cohort(1),j,&
                            welfare_of_gains_by_addiction(j))
                            
                    elseif (j>1) then
                    
                        call calculate_welfare_gains(transition_length,welfare_by_addiction_youngest(1,j-1),j,&
                            welfare_of_gains_by_addiction(j))
                            
                    end if
                    
                end do
                
                do i=1,1 !2+include_addiction
                
                    write(*,*) "welfare_of_gains_by_addiction=", welfare_of_gains_by_addiction(i)
                    
                end do
                
            end if
                                     
        end do
        
        simulation_ended=1
                
        call calculate_homeownership_by_characteristics(transition_length)
        call stationary_equilibrium_statistics(transition_length)            
!        call stationary_equilibirum_homeownership_rate(transition_length)
!        call govt_revenues_calc(transition_length)
!        call calculate_welfare_by_characteristics(transition_length)
!        call calculate_aggregate_consumption(transition_length)
!        call calculate_welfare(1)
        call stationary_equilibrium_wealth_distribution(transition_length)
        call calculate_gini_coefficient(transition_length)
        call save_vars_and_functions(transition_length)
        
        write(*,*) "model_drug_use_by_income_quintile", model_drug_use_by_income_quintile(transition_length,:)
        
        do j=1,1!+include_addiction+include_addiction
                        
            if (j==1) then
        
                call calculate_welfare_gains(transition_length,average_welfare_of_youngest_cohort(1),j,&
                    welfare_of_gains_by_addiction(j))
                    
            elseif (j>1) then
            
                call calculate_welfare_gains(transition_length,welfare_by_addiction_youngest(1,j-1),j,&
                    welfare_of_gains_by_addiction(j))
                    
            end if
            
        end do
        
        do i=1,1 !2+include_addiction
        
            write(*,*) "welfare_of_gains_by_addiction=", welfare_of_gains_by_addiction(i)
            
        end do
        
        write(*,*) "simulation_ended"
                    
    end subroutine
    
    subroutine upload_functions()
    
        use Global_Vars
        
        implicit none
        
        character*1 :: string_used
        
        do i=1,2
            
            write(string_used,'(i1)') i
                                
            open(unit=12,file="distribution_stationary"//trim(string_used)//trim(benchmark_simulation)//".dat",action='read')
                read(12,'(F30.28)') distribution_to_fetch(i)%vector_real(:,:,:,:,:,:)
            close(12)
                           
            open(unit=12,file="policy_function_space_lived_in_size"&
                //trim(string_used)//trim(benchmark_simulation)//".dat",action='read')
                read(12,'(F25.20)') policy_function_space_lived_in_size_to_fetch(i)%vector_real(:,:,:,:,:,:)
            close(12)
                    
        end do
        
        do i=1,2
                        
            write(string_used,'(i1)') i
                           
            open(unit=1,file="value_function"//trim(string_used)//trim(long_run_simulation)//".dat",action='read')
                read(1,'(F35.13)') value_function(i)%vector_transition_real(transition_length,:,:,:,:,:,:)
            close(1)
                            
            value_function_guess(i)%vector_youngest_real(:,:,:,:,:)=&
                value_function(i)%vector_transition_real(transition_length,1,:,:,:,:,:)

        end do
    
    end subroutine    
    
    subroutine transition_simulation()
    
        use Global_Vars
        
        implicit none
        
        integer :: start_updating_at_loop_number=0
        real(8) :: largest_distance_govt_budget
        real(8) :: house_price_upon_implementation=0.99,slope_of_log_house_price=0.5
        real(8) :: rent_upon_implementation=0.92
        real(8), dimension(0:have_two_rental_markets) :: slope_of_log_rent=-0.1
        real(8) :: slope_of_lump_sum_transfer=0.2,alpha_1         
                
        loop_count=0
        
        lump_sum_transfer=0
        
        call initialize_variables_and_grids()
        call GKKOC_intergenerational_employment_process(1)
                                
        if (use_old_results==1) then
        
            call upload_vars(1)
            call function_of_utility_advantage_from_homeowning(1)     
            
            call allocate_matrix() 
            call upload_functions()
            call initialize_feasible_distribution(transition_length)
                    
        else
        
            model_average_labour_income(:)=average_labor_income_calibrated
            median_income(:)=median_income_calibrated
            model_average_labour_income_by_employment(:,:)=average_labor_income_calibrated
            
            net_govt_revenues(1)=net_govt_revenue_constraint
                
            housing_stock(1-solve_transition_dynamics)=calibrated_housing_stock
            housing_stock(transition_length)=long_run_housing_stock
                                                
            housing_price(transition_length)=long_run_stationary_housing_price
                
        end if
        
        housing_price(1-solve_transition_dynamics)=calibrated_stationary_housing_price
                
        if (use_old_results==1) then
                            
            housing_price(1)=calibrated_stationary_housing_price*house_price_upon_implementation
            
            slope_of_log_house_price=(housing_price(transition_length)-housing_price(1))/(real(transition_length)/real(2))
                                                  
            do time_index=min(2,transition_length),max(transition_length-1,1)
            
                housing_price(time_index)=min(housing_price(1)+&
                    slope_of_log_house_price*(real(time_index)-real(1)),housing_price(transition_length))
                  
            end do
            
        end if
        
        if (use_old_results==0) then
                            
            risk_free_rate(:)=calibrated_risk_free_rate
            mortgage_interest_rate(:)=risk_free_rate+mortgage_interest_gap
            
        end if
                                                            
        call initialize_variables_and_grids()
        call GKKOC_intergenerational_employment_process(1)
        
        if (use_old_results==0) then
                        
            call set_SS_benefits(1)
                         
        end if
                
        if (use_old_results==1) then
         
            total_housing_demand(1-solve_transition_dynamics)=calibrated_housing_stock
            total_housing_demand(transition_length)=long_run_housing_stock
            total_rental_supply(1-solve_transition_dynamics,:)=total_rental_supply_calibrated(:)
            total_rental_demand(1-solve_transition_dynamics,:)=total_rental_supply_calibrated(:)
        
            rent(transition_length,:)=long_run_rent(:)
            
        end if
        
        open(unit=39,file="total_rental_supply"//trim(long_run_simulation)//".dat",action='read')
            read(39,'(F15.12)') total_rental_supply(transition_length,:)
        close(39)
        
        open(unit=40,file="total_profits"//trim(long_run_simulation)//".dat",action='read')
            read(40,'(F15.12)') total_profits(transition_length)
        close(40)
        
        total_rental_demand(transition_length,:)=total_rental_supply(transition_length,:)
        
        rent(1-solve_transition_dynamics,:)=rent_calibrated(:)
        
        model_average_rent(1:transition_length)=rent_calibrated(0)
           
        if (use_old_results==1) then
       
            rent(1,:)=rent_calibrated(:)*rent_upon_implementation
            
            slope_of_log_rent(:)=(rent(transition_length,:)-rent(1,:))/(real(transition_length)/real(2))
                                    
            do time_index=min(2,transition_length),max(transition_length-1,1)
                                                
                rent(time_index,:)=max(rent(1,:)+&
                    slope_of_log_rent(:)*(real(time_index)-real(1)),rent(transition_length,:))
                                                               
                call function_of_utility_advantage_from_homeowning(time_index)
                                    
            end do 
            
        end if
        
        lump_sum_transfer(1-solve_transition_dynamics)=0
        
        if (use_old_results==1) then
    
            lump_sum_transfer(1)=0.0002
            
            slope_of_lump_sum_transfer=(lump_sum_transfer(transition_length)-lump_sum_transfer(1))/(transition_length)
                        
            do time_index=min(2,transition_length),max(transition_length-1,1)
                                                
                lump_sum_transfer(time_index)=min(lump_sum_transfer(1)+&
                    slope_of_lump_sum_transfer*(real(time_index)-real(1)),lump_sum_transfer(transition_length))
                    
            end do
            
        end if
        
        call initialize_financial_grid(1)

        if (use_old_transition_results==1) then
                                
            open(unit=1,file="housing_price_in_transition"//trim(old_transition_resuls)//".txt",action='read')
                read(1,'(F15.12)') housing_price(0:transition_length-25)
            close(1)
            
            open(unit=1,file="housing_price"//trim(long_run_simulation)//".dat",action='read')
                read(1,'(F15.12)') housing_price(transition_length)
            close(1)
            
            housing_price(transition_length-25:transition_length-1)=housing_price(transition_length)
            
            open(unit=1,file="rent_in_transition"//trim(old_transition_resuls)//".txt",action='read')
                read(1,'(F15.12)') rent(0:transition_length-25,:)
            close(1)
                        
            open(unit=1,file="rent"//trim(long_run_simulation)//".dat",action='read')
                read(1,'(F15.12)') rent(transition_length,:)
            close(1)
            
!            rent(transition_length-solve_transition_dynamics*25:&
!                transition_length-solve_transition_dynamics*1,:)=rent(transition_length,:)
                        
            open(unit=1,file="lump_sum_transfer_in_transition"//trim(old_transition_resuls)//".txt",action='read')
                read(1,'(F15.12)') lump_sum_transfer(0:transition_length-25)
            close(1)
            
            open(unit=1,file="lump_sum_transfer"//trim(long_run_simulation)//".dat",action='read')
                read(1,'(F15.12)') lump_sum_transfer(transition_length)
            close(1)
            
            lump_sum_transfer(transition_length-25:transition_Length-1)=lump_sum_transfer(transition_length)
                            
            do time_index=1,transition_length
            
                call function_of_utility_advantage_from_homeowning(time_index)
                        
            end do
                                                                    
        end if
               
        write(*,*) "tax_system_type=", tax_system_type
        write(*,*) "computing tranition"
        
        write(*,*) "total_rental_demand"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
!            write(*,*) sum(total_rental_demand(time_index,:))
            
            total_rental_supply(time_index,:)=total_rental_demand(time_index,:)
        
        end do
                
        write(*,*) "total_rental_supply"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
!            write(*,*) sum(total_rental_supply(time_index,:))
        
        end do
        
        write(*,*) "total_housing_demand"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
!            write(*,*) total_housing_demand(time_index)
        
        end do
        
        write(*,*) "housing_stock"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
!            write(*,*) housing_stock(time_index)
        
        end do
        
        write(*,*) "rent"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
            write(*,*) rent(time_index,:)
        
        end do
        
        write(*,*) "house price"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
            write(*,*) housing_price(time_index)
        
        end do
        
        write(*,*) "lump_sum_transfer"
        
        do time_index=1-solve_transition_dynamics,transition_length
        
            write(*,*) lump_sum_transfer(time_index)
        
        end do
                
        largest_housing_market_distance=1
        largest_rental_market_distance=1
        largest_distance_govt_budget=1
        
        simulation_ended=0
        
        write(*,*) "average_owner_occupied_house_size_calibrated=", average_owner_occupied_house_size_calibrated
        write(*,*) "calibrated_stationary_housing_price=", calibrated_stationary_housing_price
        write(*,*) "long_run_stationary_housing_price=", long_run_stationary_housing_price
        write(*,*) "rent_calibrated=", rent_calibrated
        write(*,*) "long_run_rent=", long_run_rent
        write(*,*) "model_ss_benefits=", model_ss_benefits
        write(*,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
        
        write(*,*) "housing_price(1-solve_transition_dynamics)=", housing_price(1-solve_transition_dynamics)
        write(*,*) "housing_price(transition_length)=", housing_price(transition_length)
        write(*,*) "rent(1-solve_transition_dynamics)=", rent(1-solve_transition_dynamics,:)
        write(*,*) "rent(transition_length)=", rent(transition_length,:)
        write(*,*) "total_rental_demand(1-solve_transition_dynamics)=", &
            total_rental_demand(1-solve_transition_dynamics,:) 
        write(*,*) "total_rental_demand(transition_length)=", &
            total_rental_demand(transition_length,:) 
                                                             
        do while ((largest_housing_market_distance>stopping_rule_housing_market) .OR. &
            (largest_rental_market_distance>stopping_rule_rental_market) .OR. &
            (largest_distance_govt_budget>stopping_rule_govt_budget) .OR. (loop_count<1))
            
            write(*,*) "solving value functions"
                        
            do time_index=max(transition_length-1,1),1,-1
            
                call solve_value_function_and_policy_functions(time_index)
                
                do i=1,2
                
                    value_function_guess(i)%vector_youngest_real(:,:,:,:,:)=&
                        value_function(i)%vector_transition_real(time_index+1,1,:,:,:,:,:)
                        
                end do
                            
            end do
            
            write(*,*) "computing distributions"
            
            do time_index=1,max(transition_length-1,1)
            
                call converge_to_stationary_equilibrium(time_index)
                                                            
            end do
            
            write(*,*) "computing statistics, government revenues, and solving the lump sum transfer"
            
            net_govt_revenues(1)=net_govt_revenue_constraint
            net_govt_revenues(transition_length)=net_govt_revenue_constraint
            
            largest_distance_govt_budget=0
            
            do time_index=1,max(transition_length-1,1)
                                        
                call stationary_equilibrium_statistics(time_index)
                call stationary_equilibirum_homeownership_rate(time_index)
                call calculate_homeownership_by_characteristics(time_index)
                call govt_revenues_calc(time_index)
                            
!                write(*,*) "time_index=", time_index
!                write(*,*) "homeownership_rate=", model_homeownership_rate(time_index)
!                write(*,*) "net_govt_revenues=", net_govt_revenues(time_index)
!                write(*,*) "govt_revenues_from_consumption=", govt_revenues_from_consumption(time_index)
!                write(*,*) "govt_revenues_from_property_tax=", govt_revenues_from_property_tax(time_index)
!                write(*,*) "govt_revenues_from_labour_income=", govt_revenues_from_labour_income(time_index)
!                write(*,*) "govt_spending_on_ss=", govt_spending_on_ss(time_index)
                
                if (loop_count>start_updating_at_loop_number) then
                                                                
                    distance_govt_budget=adjust_taxes*abs(net_govt_revenues(time_index)-net_govt_revenue_constraint)
                        
                    if (distance_govt_budget>largest_distance_govt_budget) then
                    
                        largest_distance_govt_budget=distance_govt_budget
                        
                    end if
                    
                end if
                                
            end do
            
            largest_housing_market_distance=0
                        
            do time_index=1,max(transition_length-1,1)
                        
                housing_stock(time_index)=(1-housing_depreciation_rate)*housing_stock(time_index-solve_transition_dynamics)+&
                    (housing_price(time_index)/c_1_calibrated)**(empirical_housing_supplpy_elasticity)
                                            
                distance_housing_market(time_index)=abs(housing_stock(time_index)-total_housing_demand(time_index))
                                        
                if (distance_housing_market(time_index)>&
                    largest_housing_market_distance) then
                
                    largest_housing_market_distance=distance_housing_market(time_index)
                
                end if
                                                                    
            end do
            
            largest_housing_market_distance=0
            distance_housing_market=0
            
            do time_index=1,max(transition_length-1,1)
                                                                            
                distance_housing_market(time_index)=abs(housing_price(time_index)-&
                    (c_1_calibrated)*(max(total_housing_demand(time_index)-&
                    (1-housing_depreciation_rate)*housing_stock(time_index-solve_transition_dynamics),0.d0))**&
                    (1/empirical_housing_supplpy_elasticity))
                                                
                weight_on_housing_price=0.0001
                                         
                if (distance_housing_market(time_index)>largest_housing_market_distance) then
                
                    largest_housing_market_distance=distance_housing_market(time_index)
                
                end if
                
                if (loop_count>start_updating_at_loop_number) then
                                    
                    housing_price(time_index)=(1-weight_on_housing_price)*&
                        housing_price(time_index)+weight_on_housing_price*&
                        (c_1_calibrated)*(max(total_housing_demand(time_index)-&
                        (1-housing_depreciation_rate)*housing_stock(time_index-solve_transition_dynamics),0.d0))**&
                        (1/empirical_housing_supplpy_elasticity)
                                                    
                end if
                                
            end do
            
            largest_rental_market_distance=0
            distance_rental_market=0
            
            do time_index=1,max(transition_length-1,1)
            
                rental_market_adjuster=0.005
                                            
                distance_rental_market(time_index)=maxval(abs(total_rental_demand(time_index,:)-&
                    total_rental_supply(time_index,:)))
                    
                if (distance_rental_market(time_index)>largest_rental_market_distance) then
            
                    largest_rental_market_distance=distance_rental_market(time_index)
            
                end if
                                
                if (loop_count>start_updating_at_loop_number) then
                                                  
                    rent(time_index,:)=rent(time_index,:)+&
                        rental_market_adjuster*(total_rental_demand(time_index,:)-total_rental_supply(time_index,:))
                                                                         
                end if                                                         
                                                     
                call function_of_utility_advantage_from_homeowning(time_index)
                                                  
            end do
            
            alpha_1=1/(1+risk_free_rate(1))
            
            total_profits(1:transition_length-1)=0
            
            write(*,*) "largest_housing_market_distance=", largest_housing_market_distance
            write(*,*) "largest_rental_market_distance=", largest_rental_market_distance
            write(*,*) "largest_distance_govt_budget=", largest_distance_govt_budget
                                            
            open(unit=1,file="housing_price_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                do i=0,transition_length
                    write(1,'(F15.12)') housing_price(i)
                end do
            close(1)
                            
            open(unit=1,file="rent_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                do i=0,transition_length
                    write(1,'(F15.12)') rent(i,:)
                end do
            close(1)
                
            open(unit=1,file="housing_supply_minus_housing_demand_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                do i=0,transition_length
                    write(1,'(F15.12)') housing_stock(i)-total_housing_demand(i)
                end do
            close(1)
            
            open(unit=1,file="housing_supply_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.12)') housing_stock(1-solve_transition_dynamics:transition_length)
            close(1)
            
            open(unit=1,file="rental_supply_minus_rental_demand_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                do i=0,transition_length
                    if (i==0) then
                        write(1,'(F15.12)') 0.d0
                    elseif ((i>0) .AND. (i<transition_length)) then
                        write(1,'(F15.12)') total_rental_supply(i,:)-total_rental_demand(i,:)
                    else
                        write(1,'(F15.12)') 0.d0
                    end if
                end do
            close(1)
            
            open(unit=3,file="net_govt_rev_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F15.12)') net_govt_revenues(1:transition_length-1)
            close(3)
                                            
            open(unit=2,file="lump_sum_transfer_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                do i=0,transition_length 
                    write(2,'(F15.12)') lump_sum_transfer(i)
                end do                    
            close(2)
            
            open(unit=2,file="homeownership_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') model_homeownership_rate(1:transition_length-1)
            close(2)
            
            open(unit=2,file="homeownership_1st_period_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') homeownership_by_age(1,:)
            close(2)
            
            open(unit=2,file="homeownership_2nd_period_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') homeownership_by_age(2,:)
            close(2)            
            
            open(unit=2,file="model_average_rental_unit_size_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') model_average_rental_unit_size(1:transition_length-1)
            close(2)
            
            open(unit=2,file="model_average_owner_occupied_unit_size_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') model_average_owner_occupied_unit_size(1:transition_length-1)
            close(2)
            
            open(unit=2,file="total_constrcution_profits_in_transition"//trim(file_number)//&
                ".text",action="write",status="replace")
                write(2,'(F20.15)') total_constrcution_profits
            close(2)
            
            open(unit=2,file="total_rental_company_profits_in_transition"//trim(file_number)//&
                ".text",action="write",status="replace")
                write(2,'(F20.15)') total_rental_company_profits
            close(2)
            
            open(unit=2,file="total_rental_supply_in_transition"//trim(file_number)//".text",action="write",status="replace")
                write(2,'(F20.15)') total_rental_supply
            close(2)
            
            open(unit=2,file="total_rental_demand_in_transition"//trim(file_number)//".text",action="write",status="replace")
                write(2,'(F20.15)') total_rental_demand
            close(2)
            
            open(unit=2,file="total_profits_in_transition"//trim(file_number)//".text",action="write",status="replace")
                write(2,'(F20.15)') total_profits
            close(2)
                                                                          
            open(unit=3,file="distance"//trim(file_number)//".txt",action="write",status="replace")
            
                write(3,*) "loop_count=", loop_count
                write(3,*) "largest_housing_market_distance=",largest_housing_market_distance
                write(3,*) "largest_rental_market_distance=", largest_rental_market_distance
                write(3,*) "largest_distance_govt_budget=", largest_distance_govt_budget
                write(3,*) "tax_system_type=", tax_system_type
                                
            close(3)
                            
            loop_count=loop_count+1
            
            write(*,*) "loop_count=", loop_count

            do time_index=1,max(transition_length-1,1)
        
                call calculate_welfare(time_index)
                call frac_of_households_in_support_of_policy(time_index)
            
            end do
            
            open(unit=1,file="welfare_in_transition_youngest"//trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F19.12)') average_welfare_of_youngest_cohort(1:transition_length-1)
            close(1)
            
            open(unit=1,file="welfare_in_transition_everyone"//trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F19.12)') average_welfare_of_all_cohorts(1:transition_length-1)
            close(1)
            
            open(unit=2,file="support_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F14.12)') frac_in_support(1:transition_length-1)
            close(2)
                        
        end do
        
        simulation_ended=2
        
    end subroutine